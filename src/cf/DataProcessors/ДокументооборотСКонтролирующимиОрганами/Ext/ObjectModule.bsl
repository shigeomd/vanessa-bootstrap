#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

Перем ПутьКОбъекту Экспорт;

Перем СоответствиеТипаСообщенияКраткомуПредставлению;

Перем ПолученныеПисьма Экспорт;
Перем ЗапросыПоКоторымПолученыОтветы Экспорт;

Перем КомпонентаЗагружена Экспорт;

Функция ЭлектронныйДокументооборотИспользуется(УчетнаяЗапись = Неопределено) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	КОЛИЧЕСТВО(Организации.Ссылка) КАК Ссылка
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |ГДЕ
	                      |	Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами
	                      |" +
	                      ?(УчетнаяЗапись = Неопределено, 
	                      "	И Организации.УчетнаяЗаписьОбмена <> &ПустаяУчетнаяЗаписьОбмена",
	                      "	И Организации.УчетнаяЗаписьОбмена = &УчетнаяЗаписьОбмена") +
	                      "
	                      |	И НЕ Организации.ПометкаУдаления
	                      |	И НЕ Организации.УчетнаяЗаписьОбмена.ПометкаУдаления");
	Запрос.УстановитьПараметр("ВидОбменаСКонтролирующимиОрганами", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	Если УчетнаяЗапись = Неопределено Тогда 
		Запрос.УстановитьПараметр("ПустаяУчетнаяЗаписьОбмена", Справочники.УчетныеЗаписиДокументооборота.ПустаяСсылка());
	Иначе
		Запрос.УстановитьПараметр("УчетнаяЗаписьОбмена", УчетнаяЗапись);
	КонецЕсли;
	
	Попытка
		Выборка = Запрос.Выполнить().Выбрать();
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
	Если Выборка.Следующий() Тогда
		Возврат ЗначениеЗаполнено(Выборка.Получить(0));
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Процедура ОбработкаПолученияФормы(ВидОбъекта, ИмяОбъекта, ВидФормы, Параметры, ВыбраннаяФорма, ДополнительнаяИнформация, СтандартнаяОбработка) Экспорт
	
	Если ВидФормы = "ФормаОбъекта" Тогда
		Если ВидОбъекта = "Справочник" Тогда
			ИмяВидаФормы = "ФормаЭлемента";
		ИначеЕсли ВидОбъекта = "Документ" Тогда
			ИмяВидаФормы = "ФормаДокумента";
		КонецЕсли;
	ИначеЕсли ВидФормы = "ФормаВыбора" Тогда
		ИмяВидаФормы = "ФормаСписка";
	Иначе
		ИмяВидаФормы = ВидФормы;
	КонецЕсли;
	
	Если ВидОбъекта = "Документ" И ИмяОбъекта = "ЗаявлениеАбонентаСпецоператораСвязи" Тогда
		ИмяПодменяющейФормы = ВидОбъекта + "_" + ИмяОбъекта + "_" + ИмяВидаФормы;
		СтандартнаяОбработка = Ложь;
		ВыбраннаяФорма = "Обработка.ДокументооборотСКонтролирующимиОрганами.Форма." + ИмяПодменяющейФормы;
		Возврат;
	КонецЕсли;
	
	ИмяПодменяющейФормы = ВидОбъекта + "_" + ИмяОбъекта + "_" + ИмяВидаФормы;
	ПодменяющаяФорма = Метаданные().Формы.Найти(ИмяПодменяющейФормы);
	Если ПодменяющаяФорма <> Неопределено Тогда
		СтандартнаяОбработка = Ложь;
		ВыбраннаяФорма = ПодменяющаяФорма;
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьСообщенияВведенныеНаОсновании(Сообщение, Тип = Неопределено) Экспорт
	
	Результат = Новый Массив;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ТранспортноеСообщение.Ссылка
						  |ИЗ
						  |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
						  |ГДЕ
						  |	ТранспортноеСообщение.Основание = &Основание
						  |	И ТранспортноеСообщение.ПометкаУдаления = &ПометкаУдаления");
	Запрос.УстановитьПараметр("Основание", Сообщение);
	Запрос.УстановитьПараметр("ПометкаУдаления", Ложь);
	
	Если Тип <> Неопределено Тогда
		Запрос.Текст = Запрос.Текст + "
						  |	И ТранспортноеСообщение.Тип = &Тип";
		Запрос.УстановитьПараметр("Тип", Тип);
	КонецЕсли;
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Результат.Добавить(Выборка.Ссылка);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ПредставлениеТранспортногоСообщения(Сообщение) Экспорт
	
	Если ЗначениеЗаполнено(Сообщение.ЦиклОбмена) Тогда
		Возврат "" + Сообщение.Тип + ", связанное с циклом обмена " + Сообщение.ЦиклОбмена;
	Иначе
		Возврат Сообщение;
	КонецЕсли;
	
КонецФункции

Функция ПредставлениеСообщения(Сообщение) Экспорт
	
	Тема = ?(ПустаяСтрока(Сообщение.Тема), "<тема не указана>", """" + Сообщение.Тема + """");
	Если ЗначениеЗаполнено(Сообщение.Дата) Тогда
		Возврат Тема + " от " + Сообщение.Дата;
	Иначе
		Возврат Тема;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена, ТипыСообщений = Неопределено, ПомеченныеНаУдаление = Ложь, ТолькоЗавершенные = Ложь) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ТранспортноеСообщение.Ссылка,
						  |	ТранспортноеСообщение.Статус,
						  |	ТранспортноеСообщение.Тип,
						  |	ТранспортноеСообщение.ПометкаУдаления,
						  |	ТранспортноеСообщение.Дата,
						  |	ТранспортноеСообщение.ИдентификаторСообщения,
						  |	ТранспортноеСообщение.ДатаТранспорта,
						  |	ТранспортноеСообщение.Основание,
						  |	ТранспортноеСообщение.ПротоколСОшибкой,
						  |	ТранспортноеСообщение.Тема
						  |ИЗ
						  |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
						  |ГДЕ
						  |	ТранспортноеСообщение.ЦиклОбмена = &ЦиклОбмена");
	Запрос.УстановитьПараметр("ЦиклОбмена", ЦиклОбмена);
	
	Если НЕ ПомеченныеНаУдаление Тогда
		Запрос.Текст = Запрос.Текст + "
							  |	И ТранспортноеСообщение.ПометкаУдаления = &ПометкаУдаления";
		Запрос.УстановитьПараметр("ПометкаУдаления", Ложь);
	КонецЕсли;
	
	Если ТипыСообщений <> Неопределено Тогда
		Запрос.Текст = Запрос.Текст + "
							  |	И ТранспортноеСообщение.Тип В (&ТипыСообщений)";
		Запрос.УстановитьПараметр("ТипыСообщений", ТипыСообщений);
	КонецЕсли;
	
	Если ТолькоЗавершенные Тогда
		Запрос.Текст = Запрос.Текст + "
							  |	И ТранспортноеСообщение.Статус <> Значение(Перечисление.СтатусыПисем.Исходящее)";
		Запрос.УстановитьПараметр("ТипыСообщений", ТипыСообщений);
	КонецЕсли;	
	
	Запрос.Текст = Запрос.Текст + "
						|УПОРЯДОЧИТЬ ПО
						|	ТранспортноеСообщение.ДатаТранспорта УБЫВ";
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Процедура ЗаписатьСтатусОтправкиОбъекта(докСсылка, Статус) Экспорт
	
	Если ТипЗнч(докСсылка) = Тип("Массив") Тогда
		
		Для Каждого ЭлДокСсылка Из докСсылка Цикл
			МенЗап = РегистрыСведений.СтатусыОтправки.СоздатьМенеджерЗаписи();
			МенЗап.Объект = ЭлДокСсылка;
			МенЗап.Статус = Статус;
			МенЗап.Записать(Истина);
		КонецЦикла;
		
		Для Каждого ЭлДокСсылка Из докСсылка Цикл
			ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ПриИзмененииСтатусаОтправкиДокумента(ЭлДокСсылка, Статус);
		КонецЦикла;
		
	Иначе
		
		МенЗап = РегистрыСведений.СтатусыОтправки.СоздатьМенеджерЗаписи();
		МенЗап.Объект = докСсылка;
		МенЗап.Статус = Статус;
		МенЗап.Записать(Истина);
		
		ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ПриИзмененииСтатусаОтправкиДокумента(докСсылка, Статус);
		
	КонецЕсли;
	
	// Закоментировал, поскольку данного регистра в конфигурации пока нет
	//Если Статус = Перечисления.СтатусыОтправки.Сдан И Метаданные.РегистрыСведений.СтатусыРегламентированныхОтчетов.Измерения.Отчет.Тип.СодержитТип(ТипЗнч(ДокСсылка)) Тогда
	//	РегламентированнаяОтчетность.ЗаписатьСтатусОтчета(ДокСсылка, Перечисления.СтатусыРегламентированныхОтчетов.Сдан);
	//КонецЕсли;
	
	////Если ПолучитьСтатусРегламентированногоОтчета(докСсылка) <> Статус Тогда
	//	Оповестить("Изменение статуса отправки регламентированного отчета", Статус, докСсылка);
	////КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьСтатусОтправкиОбъекта(Док) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						|	СтатусыОтправки.Статус
						|ИЗ
						|	РегистрСведений.СтатусыОтправки КАК СтатусыОтправки
						|ГДЕ
						|	СтатусыОтправки.Объект = &Объект");
	Запрос.УстановитьПараметр("Объект", Док);
	Выборка = Запрос.Выполнить().Выбрать();
	Возврат ?(Выборка.Следующий(), Выборка.Получить(0), Перечисления.СтатусыОтправки.ПустаяСсылка());
	
КонецФункции

Функция ПолучитьСтатусыОтправкиОбъектов(Объекты) Экспорт
	
	Результат = Новый Соответствие;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						|	СтатусыОтправки.Объект,
						|	СтатусыОтправки.Статус
						|ИЗ
						|	РегистрСведений.СтатусыОтправки КАК СтатусыОтправки
						|ГДЕ
						|	СтатусыОтправки.Объект В (&Объект)");
	Запрос.УстановитьПараметр("Объект", Объекты);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Результат.Вставить(Выборка.Объект, Выборка.Статус);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ПолучитьПоследнийЦиклОбмена(Объект) Экспорт
	
	Если Объект <> Неопределено Тогда
		Ссылка = Объект.Ссылка;
		Если Не ЗначениеЗаполнено(Ссылка) Тогда
			Возврат Неопределено;
		КонецЕсли;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	Если НЕ ПравоДоступа("Чтение", Метаданные.Документы.ТранспортноеСообщение) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	                      |	ТранспортноеСообщение.ЦиклОбмена,
	                      |	ТранспортноеСообщение.ЦиклОбмена.ДатаСоздания КАК ЦиклОбменаДатаСоздания
	                      |ИЗ
	                      |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
	                      |ГДЕ
	                      |	(ТранспортноеСообщение.ЦиклОбмена.Предмет = &Объект
	                      |			ИЛИ &Объект В (ТранспортноеСообщение.ЦиклОбмена.ДополнительныеПредметы.Предмет))
	                      |	И ТранспортноеСообщение.ЦиклОбмена.Тип В(&Тип)
	                      |	И ТранспортноеСообщение.ЦиклОбмена.ПометкаУдаления = &ПометкаУдаления
	                      |	И (ТранспортноеСообщение.Статус = &СтатусПолученное
	                      |			ИЛИ ТранспортноеСообщение.Статус = &СтатусОтправленное
	                      |			ИЛИ ТранспортноеСообщение.Тип В (&ТипПервичноеСодержащееОтчетность)
	                      |				И ТранспортноеСообщение.Статус = &СтатусИсходящее)
	                      |
	                      |УПОРЯДОЧИТЬ ПО
	                      |	ЦиклОбменаДатаСоздания УБЫВ");
	Запрос.УстановитьПараметр("Объект", Объект);
	
	ТипМассив = Новый Массив;
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.ОтчетностьПФР);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРИсходящие);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРВходящие);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.Форма2НДФЛ);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.ОбращениеНП);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.Представление);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.ИОН);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.Документ);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.Заявление);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.ОтчетностьФСГС);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.ПисьменноеОбращениеВФСГС);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.ИОС);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.ЗапросНаВыпискуИзЕГРЮЛ_ЕГРИП);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.ПисьмоНО);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.Рассылка);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.РассылкаГрупповая);
	ТипМассив.Добавить(Перечисления.ТипыЦикловОбмена.ИндивидуальноеИнформированиеФСГС);
	Запрос.УстановитьПараметр("Тип", ТипМассив);
	
	ТипМассивПервичное = Новый Массив;
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ДекларацияНП);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ОбращениеНП);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ЗапросНП);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ДокументНО);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ЗапросНаВыпискуЕРГЮЛ_ЕГРИП);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоНО);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.РассылкаНО);
	ТипМассивПервичное.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС);
	
	Запрос.УстановитьПараметр("ТипПервичноеСодержащееОтчетность", ТипМассивПервичное);
	
	Запрос.УстановитьПараметр("СтатусПолученное", Перечисления.СтатусыПисем.Полученное);
	Запрос.УстановитьПараметр("СтатусОтправленное", Перечисления.СтатусыПисем.Отправленное);
	Запрос.УстановитьПараметр("СтатусИсходящее", Перечисления.СтатусыПисем.Исходящее);
	Запрос.УстановитьПараметр("ПометкаУдаления", Ложь);
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		Если ТипЗнч(Выборка.ЦиклОбмена) = Тип("СправочникСсылка.ЦиклыОбмена") Тогда
			Возврат Выборка.ЦиклОбмена;
		КонецЕсли;
	КонецЦикла;
	Возврат Справочники.ЦиклыОбмена.ПустаяСсылка();
	
КонецФункции

Функция ПолучитьПустуюДатуЗавершенияЦиклаОбмена() Экспорт
	
	Возврат '39991231235959';
	//Возврат '29991231235959';
	
КонецФункции

Функция СформироватьСтрокуСостоянияТранспортногоСообщения(Сообщение) Экспорт
	
	Если Сообщение = Неопределено ИЛИ Сообщение = Документы.ТранспортноеСообщение.ПустаяСсылка() ИЛИ НЕ ЗначениеЗаполнено(Сообщение.Статус) Тогда
		Возврат "<Подтверждение отсутствует, нажмите для создания>";
	КонецЕсли;
	
	СоответствиеТипаСообщенияПредставлению = Новый Соответствие;
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ДекларацияНП,																		"Первичное сообщение, содержащее отчетность");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО,																"Извещение о получении отчета");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО,															"Результат приема декларации");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП,															"Извещение о получении результата приема");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО,														"Результат обработки декларации");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП,														"Извещение о получении результата обработки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО,															"Подтверждение даты отправки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП,															"Извещение о получении подтверждения даты отправки");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП,																		"Первичное сообщение, содержащее сведения формы 2-НДФЛ");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО,															"Подтверждение даты отправки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО,																"Извещение о получении формы 2-НДФЛ");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО,															"Результат приема формы 2-НДФЛ");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ОбращениеНП,																			"Обращение налогоплательщика");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО,																"Извещение о получении обращения");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО,															"Подтверждение даты отправки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО,															"Результат приема обращения");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП,																		"Представление документов");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО,															"Извещение о получении представленных документов");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО,														"Подтверждение даты отправки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО,														"Результат приема представленных документов");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоНО,																			"Письмо налогового органа");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП,																	"Извещение о получении письма налогового органа");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РассылкаНО,																			"Рассылка налогового органа");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП,																	"Извещение о получении рассылки налогового органа");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ЗапросНП,																			"Первичное сообщение, содержащее запрос");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗапросНО,																	"Извещение о получении запроса");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО,																"Результат приема запроса");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП,															"Извещение о получении результата приема");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО,															"Ответ на запрос");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО,																"Подтверждение даты отправки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП,															"Извещение о получении подтверждения даты отправки");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР,											"Первичное сообщение, содержащее отчетность");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР,													"Квитанция о доставке отчетности");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколПФР,																			"Протокол контроля отчетности");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР,																"Квитанция о доставке протокола контроля");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР,												"Первичное сообщение, содержащее запрос");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР,													"Квитанция о доставке запроса");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР,																	"Ответ на запрос");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР,															"Квитанция о доставке ответа на запрос");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР,																	"Первичное сообщение, содержащее письмо в ПФР");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР,															"Квитанция о доставке письма");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР,																	"Первичное сообщение, содержащее письмо от ПФР");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР,															"Квитанция о доставке письма");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка,																	"Сообщение о критической ошибке");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР,																"Уведомление об ошибке");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС,																"Уведомление об ошибке");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС,											"Первичное сообщение, содержащее отчетность");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС,														"Подтверждение даты отправки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС,												"Извещение о получении подтверждения даты отправки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС,													"Извещение о получении отчетности");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС,												"Протокол входного контроля отчетности");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС,										"Извещение о получении протокола входного контроля");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС,																	"Первичное сообщение, содержащее письмо в Росстат");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС,														"Извещение о получении письма его получателем");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС,																	"Первичное сообщение, содержащее письмо из Росстата");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС,															"Извещение о получении письма его получателем");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС,																"Уведомление об ошибке");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.Прочее,																				"Прочее сообщение");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПустаяСсылка(),																		"Сообщение неизвестного типа");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП,																			"Первичное сообщение, содержащее отчетность");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗаявлениеНО,																"Извещение о получении отчета");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО,															"Результат приема заявления");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП,															"Извещение о получении результата приема");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО,														"Результат обработки заявления в РФ");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП,														"Извещение о получении результата обработки заявления в РФ");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО,															"Подтверждение даты отправки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП,															"Извещение о получении подтверждения даты отправки");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО,														"Сообщение об отзыве заявления в РФ");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП,														"Извещение о получении сообщения об отзыве заявления в РФ");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО,														"Результат обработки заявления в ТС");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП,														"Извещение о получении результата обработки заявления в ТС");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО,														"Результат обработки заявления");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ДокументНО,																			"Документ налогового органа");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП,																	"Извещение о получении документа налогового органа");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП,															"Результат приема документа налогового органа");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНО,															"Извещение о получении результата приема документа налогового органа");
	
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ЗапросНаВыпискуЕРГЮЛ_ЕГРИП,															"Первичное сообщение, содержащее запрос");
	СоответствиеТипаСообщенияПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросаНаВыпискуЕРГЮЛ_ЕГРИП,										"Ответ на запрос");
	
	СоответствиеТипаСообщенияОкончанию = Новый Соответствие;
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ДекларацияНП,																		"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО,																"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО,															"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП,															"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО,														"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП,														"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО,															"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП,															"о");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП,																		"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО,															"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО,																"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО,															"");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ОбращениеНП,																			"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО,																"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО,															"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО,															"");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП,																		"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО,															"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО,														"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО,														"");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоНО,																			"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП,																	"о");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РассылкаНО,																			"а");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП,																	"о");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР,											"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР,													"а");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколПФР,																			"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР,																"а");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР,												"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР,													"а");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР,																	"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР,															"а");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР,																	"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР,															"а");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР,																	"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР,															"а");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ЗапросНП,																			"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗапросНО,																	"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО,																"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП,															"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО,															"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП,														"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО,																"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП,															"о");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС,											"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС,														"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС,												"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС,													"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС,												"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС,										"о");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС,																	"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС,														"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС,																	"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС,															"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС,																"о");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка,																	"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР,																"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС,																"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.Прочее,																				"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ПустаяСсылка(),																		"о");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП,																			"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО,															"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО,														"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО,														"");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО,														"");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ДокументНО,																			"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП,																	"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП,															"");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНО,															"о");
	
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.ЗапросНаВыпискуЕРГЮЛ_ЕГРИП,															"о");
	СоответствиеТипаСообщенияОкончанию.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросаНаВыпискуЕРГЮЛ_ЕГРИП,										"о");
	
	ПредставлениеТипа = СоответствиеТипаСообщенияПредставлению[Сообщение.Тип];
	Если ПредставлениеТипа = Неопределено Тогда
		ПредставлениеТипа = "Сообщение неизвестного типа";
	КонецЕсли;
	
	ТипСообщения = Сообщение.Тип;
	
	Статус = Сообщение.Статус;
	Окончание = СоответствиеТипаСообщенияОкончанию[ТипСообщения];
	Если Окончание = Неопределено Тогда
		Окончание = "о";
	КонецЕсли;
	
	ЭтоОшибкаИлиПрочееСообщение = (ТипСообщения = Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка
									ИЛИ ТипСообщения = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР
									ИЛИ ТипСообщения = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС
									ИЛИ ТипСообщения = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС
									ИЛИ ТипСообщения = Перечисления.ТипыТранспортныхСообщений.Прочее);
	
	Если Статус = Перечисления.СтатусыПисем.Сохраненное Тогда
		ТекстДопИнформация = ПредставлениеТипа + ". Создан" + Окончание + ?(НЕ ЭтоОшибкаИлиПрочееСообщение И СообщениеЗашифровано(Сообщение.Ссылка), ", зашифрован" + Окончание, "") + ", но не отправлен" + Окончание + ".";
	ИначеЕсли Статус = Перечисления.СтатусыПисем.Исходящее Тогда
		ТекстДопИнформация = ПредставлениеТипа + ". Создан" + Окончание + ?(НЕ ЭтоОшибкаИлиПрочееСообщение И СообщениеЗашифровано(Сообщение.Ссылка), ", зашифрован" + Окончание, "") + ", но не отправлен" + Окончание + ".";
	ИначеЕсли Статус = Перечисления.СтатусыПисем.Отправленное Тогда
		ТекстДопИнформация = ПредставлениеТипа + ". Отправлен" + Окончание + " " + Формат(Сообщение.ДатаТранспорта, "ДФ='дд.ММ.гггг ЧЧ:мм:сс'") + ".";
	ИначеЕсли Статус = Перечисления.СтатусыПисем.Полученное Тогда
		ТекстДопИнформация = ПредставлениеТипа + ". Получен" + Окончание + " " + Формат(Сообщение.ДатаТранспорта, "ДФ='дд.ММ.гггг ЧЧ:мм:сс'") + "." + ?(ЭтоОшибкаИлиПрочееСообщение ИЛИ СообщениеРасшифровано(Сообщение.Ссылка), "", " Не расшифрован" + Окончание + ".");
	КонецЕсли;
	
	Возврат ТекстДопИнформация;
	
КонецФункции

Функция СписокДопустимыхОрганизацийВОбъектахОбмена() Экспорт
	
	//Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	//					  |	Организации.Ссылка КАК Ссылка,
	//					  |	Организации.Наименование
	//					  |ИЗ
	//					  |	РегистрСведений.ПользователиУчетныхЗаписейДокументооборота КАК ПользователиУчетныхЗаписейДокументооборота
	//					  |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ РАЗЛИЧНЫЕ
	//					  |			Организации.Ссылка КАК Ссылка,
	//					  |			Организации.Наименование КАК Наименование,
	//					  |			Организации.УчетнаяЗаписьОбмена КАК УчетнаяЗаписьОбмена
	//					  |		ИЗ
	//					  |			Справочник.Организации КАК Организации
	//					  |		ГДЕ
	//					  |			Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами
	//					  |			И 
	//					  |			Организации.УчетнаяЗаписьОбмена <> &ПустаяУчетнаяЗапись) КАК Организации
	//					  |		ПО ПользователиУчетныхЗаписейДокументооборота.УчетнаяЗапись = Организации.УчетнаяЗаписьОбмена
	//					  |ГДЕ
	//					  |	ПользователиУчетныхЗаписейДокументооборота.УчетнаяЗапись.ПометкаУдаления = &ПометкаУдаления
	//					  |	И ПользователиУчетныхЗаписейДокументооборота.Пользователь = &Пользователь
	//					  |	И (НЕ Организации.Ссылка ЕСТЬ NULL)
	//					  |
	//					  |УПОРЯДОЧИТЬ ПО
	//					  |	Организации.Наименование");
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	                      |	Организации.Ссылка КАК Ссылка,
	                      |	Организации.Наименование КАК Наименование,
	                      |	Организации.УчетнаяЗаписьОбмена КАК УчетнаяЗаписьОбмена
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |ГДЕ
	                      |	Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами
	                      |
	                      |УПОРЯДОЧИТЬ ПО
	                      |	Организации.Наименование");
	
	
	Запрос.УстановитьПараметр("ВидОбменаСКонтролирующимиОрганами", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	Запрос.УстановитьПараметр("ПустаяУчетнаяЗапись", Справочники.УчетныеЗаписиДокументооборота.ПустаяСсылка());
	Запрос.УстановитьПараметр("ПометкаУдаления", Ложь);
	//Запрос.УстановитьПараметр("Пользователь", Пользователи.ТекущийПользователь());

	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции

Функция ПоказатьСообщение(ЦиклОбмена, ТипСообщения) Экспорт
	
	// выбираем все сообщения цикла обмена
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ТранспортноеСообщение.Ссылка,
						  |	ТранспортноеСообщение.ДатаТранспорта,
						  |	ТранспортноеСообщение.Тип,
						  |	ТранспортноеСообщение.УчетнаяЗапись,
						  |	ТранспортноеСообщение.Статус
						  |ИЗ
						  |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
						  |ГДЕ
						  |	ТранспортноеСообщение.ЦиклОбмена = &ЦиклОбмена
						  |
						  |УПОРЯДОЧИТЬ ПО
						  |	ТранспортноеСообщение.Дата УБЫВ");
	Запрос.УстановитьПараметр("ЦиклОбмена", ЦиклОбмена);
	СообщенияЦиклаОбмена = Запрос.Выполнить().Выгрузить();
	
	// из них выбираем те, которые соответствуют маске по типам
	// если возможных типов несколько то пробуем найти сообщения каждого типа поочередно
	Если ТипЗнч(ТипСообщения) = Тип("Массив") Тогда
		СообщенияИскомогоТипа = Новый Массив;
		Для Каждого ЭлТипСообщения Из ТипСообщения Цикл
			СообщенияИскомогоТипа = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", ЭлТипСообщения));
			Если СообщенияИскомогоТипа.Количество() > 0 Тогда
				Прервать;
			КонецЕсли;
		КонецЦикла;
	Иначе
		СообщенияИскомогоТипа = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", ТипСообщения));
	КонецЕсли;
	
	// если нашли, то показываем форму
	ЧислоНайденныхСообщений = СообщенияИскомогоТипа.Количество();
	Если ЧислоНайденныхСообщений = 1 Тогда
		//ОткрытьЗначение(СообщенияИскомогоТипа[0].Ссылка);
		Если ТипЗнч(СообщенияИскомогоТипа[0].Ссылка) = Тип("ДокументСсылка.ТранспортноеСообщение") Тогда 
			//ОткрытьФорму("Документ.ТранспортноеСообщение.ФормаОбъекта", Новый Структура("Ключ", СообщенияИскомогоТипа[0].Ссылка));
			Возврат СообщенияИскомогоТипа[0].Ссылка;
		КонецЕсли;
		Возврат Неопределено;
	ИначеЕсли ЧислоНайденныхСообщений > 1 Тогда
		
		СписокСообщений = Новый СписокЗначений;
		Для Каждого СообщениеИскомогоТипа Из СообщенияИскомогоТипа Цикл
			СписокСообщений.Добавить(СообщениеИскомогоТипа.Ссылка, ПредставлениеСообщения(СообщениеИскомогоТипа.Ссылка));
		КонецЦикла;
		
		Если СписокСообщений.Количество() > 0 Тогда
			Возврат СписокСообщений;
		Иначе
			Возврат Неопределено;
		КонецЕсли;
		
	КонецЕсли;
	
	// если сообщение не найдено, то показываем либо диалог со справочной информацией, либо предупреждение
	
	// ПФР
	Если ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее файл отчетности ПФР, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР Тогда
		Возврат СокрЛП("Подтверждение получения отчетности ПФР отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР Тогда
		Возврат СокрЛП("Протокол ПФР отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР Тогда
		Возврат СокрЛП("Квитанция на протокол ПФР отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее письмо, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР Тогда
		Возврат СокрЛП("Квитанция на письмо отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее письмо, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР Тогда
		Возврат СокрЛП("Квитанция на письмо отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее запрос в ПФР, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР Тогда
		Возврат СокрЛП("Подтверждение получения запроса в ПФР отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР Тогда
		Возврат СокрЛП("Ответ на запрос в ПФР отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР Тогда
		Возврат СокрЛП("Квитанция на ответ на запрос в ПФР отсутствует.");
		
	// ФНС 534
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ДекларацияНП Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее файл отчетности, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО Тогда
		Возврат СокрЛП("Подтверждение даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
		Возврат СокрЛП("Извещение о получении подтверждения даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО Тогда
		Возврат СокрЛП("Извещение о получении отчета отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО Тогда
		Возврат СокрЛП("Сообщение, содержащее результат приема отчета, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП Тогда
		Возврат СокрЛП("Извещение о получении результата приема отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО Тогда
		Возврат СокрЛП("Сообщение, содержащее результат обработки отчета, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП Тогда
		Возврат СокрЛП("Извещение о получении результата обработки отсутствует.");
		
	//ФНС 534 Документ	
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ДокументНО Тогда
		Возврат СокрЛП("Сообщение, содержащее документ налогового органа, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП Тогда
		Возврат СокрЛП("Извещение о получении документа налогового органа отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП Тогда
		Возврат СокрЛП("Сообщение, содержащее результат приема документа, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНО Тогда
		Возврат СокрЛП("Извещение о получении результата приема отсутствует.");
		
	// Заявление
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее заявление, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО Тогда
		Возврат СокрЛП("Подтверждение даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗаявлениеНО Тогда
		Возврат СокрЛП("Извещение о получении заявления отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО Тогда
		Возврат СокрЛП("Результат приема заявления отсутствует.");
		
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО Тогда
		Возврат СокрЛП("Результат обработки заявления отсутствует.");	
			
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО Тогда
		Возврат СокрЛП("Результат обработки заявления отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП Тогда
		Возврат СокрЛП("Извещение о получении результата обработки заявления отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО Тогда
		Возврат СокрЛП("Сообщение об отзыве заявления в РФ отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП Тогда
		Возврат СокрЛП("Извещение о получении сообщения об отзыве заявления в РФ отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО Тогда
		Возврат СокрЛП("Результат обработки заявления в ТС отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП Тогда
		Возврат СокрЛП("Извещение о получении результата обработки заявления в ТС отсутствует.");
		
	// ФНС 534 2-НДФЛ
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее сведения формы 2-НДФЛ, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО Тогда
		Возврат СокрЛП("Подтверждение даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО Тогда
		Возврат СокрЛП("Извещение о получении отчета отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО Тогда
		Возврат СокрЛП("Сообщение, содержащее результат приема отчета, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ОбращениеНП Тогда
		Возврат СокрЛП("Сообщение, содержащее обращение налогоплательщика, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО Тогда
		Возврат СокрЛП("Подтверждение даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
		Возврат СокрЛП("Извещение о получении подтверждения даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО Тогда
		Возврат СокрЛП("Извещение о получении обращения отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО Тогда
		Возврат СокрЛП("Сообщение, содержащее результат приема обращения, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП Тогда
		Возврат СокрЛП("Извещение о получении результата приема отсутствует.");
		
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП Тогда
		Возврат СокрЛП("Сообщение, содержащее представление документов, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО Тогда
		Возврат СокрЛП("Подтверждение даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО Тогда
		Возврат СокрЛП("Извещение о получении представленных документов отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО Тогда
		Возврат СокрЛП("Сообщение, содержащее результат приема представленных документов, отсутствует.");
		
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПисьмоНО Тогда
		Возврат СокрЛП("Сообщение, содержащее письмо налогового органа, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП Тогда
		Возврат СокрЛП("Извещение о получении письмо налогового органа отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РассылкаНО Тогда
		Возврат СокрЛП("Сообщение, содержащее рассылку налогового органа, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП Тогда
		Возврат СокрЛП("Извещение о получении рассылки налогового органа отсутствует.");
	
	// ФНС 534 ИОН
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ЗапросНП Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее запрос, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО Тогда
		Возврат СокрЛП("Подтверждение даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
		Возврат СокрЛП("Извещение о получении подтверждения даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗапросНО Тогда
		Возврат СокрЛП("Извещение о получении запроса отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО Тогда
		Возврат СокрЛП("Сообщение, содержащее результат приема запроса, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП Тогда
		Возврат СокрЛП("Извещение о получении результата приема отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО Тогда
		Возврат СокрЛП("Сообщение, содержащее ответ на запрос, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП Тогда
		Возврат СокрЛП("Извещение о получении ответа на запрос отсутствует.");
		
	// Росстат
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее файл отчетности для Росстата, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС Тогда
		Возврат СокрЛП("Подтверждение даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС Тогда
		Возврат СокрЛП("Извещение о получении подтверждения даты отправки отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС Тогда
		Возврат СокрЛП("Извещение о получения отчетности отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС Тогда
		Возврат СокрЛП("Протокол входного контроля отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС Тогда
		Возврат СокрЛП("Извещение о получении протокола входного контроля отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее письмо, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС Тогда
		Возврат СокрЛП("Извещение о получении письма отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС Тогда
		Возврат СокрЛП("Первичное сообщение, содержащее письмо, отсутствует.");
	ИначеЕсли ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС Тогда
		Возврат СокрЛП("Извещение о получении письма отсутствует.");
	КонецЕсли;
	
КонецФункции

Функция ПолучитьСообщениеЦиклаОбмена(ЦиклОбмена, ТипСообщения, Основание = Неопределено) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ТранспортноеСообщение.Ссылка
						  |ИЗ
						  |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
						  |ГДЕ
						  |	ТранспортноеСообщение.ЦиклОбмена = &ЦиклОбмена
						  |	И ТранспортноеСообщение.Тип = &Тип");
	Запрос.УстановитьПараметр("ЦиклОбмена", ЦиклОбмена);
	Запрос.УстановитьПараметр("Тип", ТипСообщения);
	
	Если Основание <> Неопределено Тогда
		Запрос.Текст = Запрос.Текст + "
						  |	И ТранспортноеСообщение.Основание = &Основание";
		Запрос.УстановитьПараметр("Основание", Основание);
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + "
						  |
						  |УПОРЯДОЧИТЬ ПО
						  |	ТранспортноеСообщение.Дата УБЫВ";
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Документы.ТранспортноеСообщение.ПустаяСсылка();
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	Иначе
		Возврат Документы.ТранспортноеСообщение.ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

Функция ЗапросНаВводПодтверждения(ЦиклОбмена, Основание = Неопределено) Экспорт

	Если ТипЗнч(Основание) = Тип("ПеречислениеСсылка.ТипыТранспортныхСообщений") Тогда
		СообщениеОснование = ПолучитьСообщениеЦиклаОбмена(ЦиклОбмена, Основание);
		ТипСообщенияОснования = Основание;
	Иначе
		СообщениеОснование = Основание;
		ТипСообщенияОснования = Основание.Тип;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(СообщениеОснование) Тогда
		//Предупреждение("Невозможно ввести подтверждение: отсутствует сообщение-основание!");
		//Возврат Неопределено;
		ТекстПредупреждения = "Невозможно ввести подтверждение: отсутствует сообщение-основание!";
		Возврат Новый Структура("ТекстПредупреждения", ТекстПредупреждения);
	КонецЕсли;
	
	// ПФР
	Если ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПротоколПФР Тогда
		ТекстВопроса = "Создать подтверждение на протокол?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР Тогда
		ТекстВопроса = "Создать подтверждение на письмо?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР Тогда
		ТекстВопроса = "Создать подтверждение на ответ на запрос?" + Символы.ПС + "При этом, сообщение будет записано.";
	
	// ФНС 534
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО
	ИЛИ ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО Тогда
		ТекстВопроса = "Создать извещение о получении подтверждения даты отправки?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО
	ИЛИ ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО Тогда
		ТекстВопроса = "Создать извещение о получении результата приема?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО Тогда
		ТекстВопроса = "Создать извещение о получении результата обработки?" + Символы.ПС + "При этом, сообщение будет записано.";
	
	// ФНС 534 НФД
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО Тогда
		ТекстВопроса = "Создать извещение о получении подтверждения даты отправки?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО Тогда
		ТекстВопроса = "Создать извещение о получении результата приема?" + Символы.ПС + "При этом, сообщение будет записано.";
		
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО Тогда
		ТекстВопроса = "Создать извещение о получении подтверждения даты отправки?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО Тогда
		ТекстВопроса = "Создать извещение о получении результата приема?" + Символы.ПС + "При этом, сообщение будет записано.";
		
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПисьмоНО Тогда
		ТекстВопроса = "Создать извещение о получении письма налогового органа?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РассылкаНО Тогда
		ТекстВопроса = "Создать извещение о получении рассылки налогового органа?" + Символы.ПС + "При этом, сообщение будет записано.";
		
	// ФНС 534 ДРП (Документы реализации полномочий НО)
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ДокументНО Тогда
		ТекстВопроса = "Создать извещение о получении документа налогового органа?" + Символы.ПС + "При этом, сообщение будет записано.";
		
	// Заявление
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО Тогда
		ТекстВопроса = "Создать извещение о получении подтверждения даты отправки?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО Тогда
		ТекстВопроса = "Создать извещение о получении результата приема?" + Символы.ПС + "При этом, сообщение будет записано.";
		
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО Тогда
		ТекстВопроса = "Создать извещение о получении результата обработки заявления?" + Символы.ПС + "При этом, сообщение будет записано.";
		
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО Тогда
		ТекстВопроса = "Создать извещение о получении результата обработки заявления в РФ?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО Тогда
		ТекстВопроса = "Создать извещение о получении сообщения об отзыве заявления?" + Символы.ПС + "При этом, сообщение будет записано.";
    ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО Тогда
		ТекстВопроса = "Создать извещение о получении результата обработки заявления в ТС?" + Символы.ПС + "При этом, сообщение будет записано.";
		
	// ФНС 534 ИОН
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО Тогда
		ТекстВопроса = "Создать извещение о получении подтверждения даты отправки?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО Тогда
		ТекстВопроса = "Создать извещение о получении результата приема?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО Тогда
		ТекстВопроса = "Создать извещение о получении результата обработки?" + Символы.ПС + "При этом, сообщение будет записано.";
		
	// Росстат
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС Тогда
		ТекстВопроса = "Создать извещение о получении протокола входного контроля отчетности?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС Тогда
		ТекстВопроса = "Создать извещение о получении письма?" + Символы.ПС + "При этом, сообщение будет записано.";
	ИначеЕсли ТипСообщенияОснования = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС Тогда
		ТекстВопроса = "Создать извещение о получении подтверждения даты отправки?" + Символы.ПС + "При этом, сообщение будет записано.";
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат Новый Структура("ТекстВопроса", ТекстВопроса);
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// РАБОТА С ВНЕШНИМИ ЭЛЕКТРОННЫМИ ПРЕДСТАВЛЕНИЯМИ
// Перенесена на форму

Процедура ДобавитьЭлектронноеПредставлениеВХранилище(Владелец, ИмяФайла, Данные, ТипФайлаОтчетности = Неопределено) Экспорт
	МенеджерЗаписи = РегистрыСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.ЭлектронноеПредставление = Владелец;
	МенеджерЗаписи.ИмяФайла = ИмяФайла;
	Если ТипЗнч(Данные) = Тип("ХранилищеЗначения") Тогда 
		МенеджерЗаписи.Данные = Данные;
	ИначеЕсли ТипЗнч(Данные) = Тип("ДвоичныеДанные") Тогда 
		МенеджерЗаписи.Данные = Новый ХранилищеЗначения(Данные, Новый СжатиеДанных(9));
	КонецЕсли;
	МенеджерЗаписи.Размер = ОпределитьРазмер(Данные);
	МенеджерЗаписи.ТипФайлаОтчетности = ТипФайлаОтчетности;
	МенеджерЗаписи.Записать(Истина);
КонецПроцедуры

Процедура ОчиститьЭлектронныеПредставленияВХранилище(Владелец) Экспорт
	
	НаборЗаписей = РегистрыСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.ЭлектронноеПредставление.Установить(Владелец);
	НаборЗаписей.Записать(Истина);
	
КонецПроцедуры

Процедура ИзвлечьЭлектронноеПредставлениеИзХранилища(Владелец, ИмяФайла, Данные) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ИмяФайла,
						  |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.Данные
						  |ИЗ
						  |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
						  |ГДЕ
						  |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Если Выборка.Следующий() Тогда
			ИмяФайла = СокрЛП(Выборка.ИмяФайла);
			Данные = Выборка.Данные;
			Возврат;
		КонецЕсли;
	КонецЕсли;
	ИмяФайла = "";
	Данные = Неопределено;
	
КонецПроцедуры

Функция ИзвлечьЭлектронныеПредставленияИзХранилища(Владелец) Экспорт
	
	ТаблицаРезультат = Новый ТаблицаЗначений;
	ТаблицаРезультат.Колонки.Добавить("ИмяФайла");
	ТаблицаРезультат.Колонки.Добавить("Данные");
	ТаблицаРезультат.Колонки.Добавить("ТипФайлаОтчетности");
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ИмяФайла,
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ТипФайлаОтчетности
	                      |ИЗ
	                      |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
	                      |ГДЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Количество() = 0 Тогда
		Возврат Неопределено;
	Иначе
		
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = ТаблицаРезультат.Добавить();
			НоваяСтрока.ИмяФайла 			= Выборка.ИмяФайла;
			НоваяСтрока.ТипФайлаОтчетности 	= Выборка.ТипФайлаОтчетности;
			НоваяСтрока.Данные 				= ДанныеОдногоФайлаЭлектронногоПредставления(Владелец, Выборка.ИмяФайла);
		КонецЦикла;
		
		Возврат ТаблицаРезультат;
		
	КонецЕсли;
	
КонецФункции


Функция ИзвлечьЭлектронныеПредставленияВХранилище(Владелец, УникальныйИдентификатор) Экспорт
	
	ТаблицаРезультат = Новый ТаблицаЗначений;
	ТаблицаРезультат.Колонки.Добавить("ИмяФайла");
	ТаблицаРезультат.Колонки.Добавить("Данные");
	ТаблицаРезультат.Колонки.Добавить("ТипФайлаОтчетности");
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ИмяФайла,
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ТипФайлаОтчетности
	                      |ИЗ
	                      |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
	                      |ГДЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Количество() = 0 Тогда
		Возврат Неопределено;
	Иначе
		
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = ТаблицаРезультат.Добавить();
			НоваяСтрока.ИмяФайла 			= Выборка.ИмяФайла;
			НоваяСтрока.ТипФайлаОтчетности 	= Выборка.ТипФайлаОтчетности;
			НоваяСтрока.Данные 				= АдресХранилищаФайлаЭлектронногоПредставления(Владелец, Выборка.ИмяФайла, УникальныйИдентификатор);
		КонецЦикла;
		
		Возврат ТаблицаРезультат;
		
	КонецЕсли;
	
КонецФункции

Функция ПолучитьИменаФайловЭлектронныхПредставленийВХранилище(Владелец) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ИмяФайла
	                      |ИЗ
	                      |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
	                      |ГДЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	Выборка = Запрос.Выполнить().Выгрузить();
	Возврат Выборка.ВыгрузитьКолонку("ИмяФайла");
	
КонецФункции

Функция АдресХранилищаФайлаЭлектронногоПредставления(Владелец, ИмяФайла, УникальныйИдентификатор) Экспорт
	
	Данные = Неопределено;
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.Данные КАК ДанныеХранилище
	                      |ИЗ
	                      |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
	                      |ГДЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление
	                      |	И ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ИмяФайла = &ИмяФайла");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	Запрос.УстановитьПараметр("ИмяФайла", ИмяФайла);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Данные = ПоместитьВоВременноеХранилище(Выборка.ДанныеХранилище.Получить(), УникальныйИдентификатор);
		Прервать;
	КонецЦикла;
		
	Возврат Данные;
	
КонецФункции

Функция ДанныеОдногоФайлаЭлектронногоПредставления(Владелец, ИмяФайла) Экспорт
	
	Данные = Неопределено;
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.Данные КАК ДанныеХранилище
	                      |ИЗ
	                      |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
	                      |ГДЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление
	                      |	И ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ИмяФайла = &ИмяФайла");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	Запрос.УстановитьПараметр("ИмяФайла", ИмяФайла);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Данные = Выборка.ДанныеХранилище.Получить();
		Прервать;
	КонецЦикла;
		
	Возврат Данные;
	
КонецФункции

Функция ИзвлечьИменаФайловИзХранилища(Владелец) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ИмяФайла,
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ТипФайлаОтчетности
	                      |ИЗ
	                      |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
	                      |ГДЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	ТаблицаРезультат = Запрос.Выполнить().Выгрузить();
	ТаблицаРезультат.Колонки.Добавить("Данные");
	Возврат ТаблицаРезультат;
	
КонецФункции

Функция КоличествоФайловВКомплекте(Владелец) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	КОЛИЧЕСТВО(ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ИмяФайла) КАК КоличествоФайлов
	                      |ИЗ
	                      |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
	                      |ГДЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	ТаблицаРезультат = Запрос.Выполнить().Выгрузить();
	Возврат ТаблицаРезультат[0].КоличествоФайлов;
	
КонецФункции

Функция РазмерФайловВКомплекте(Владелец) Экспорт
	
	Размер = 0;
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	СУММА(ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.Размер) КАК Размер
	                      |ИЗ
	                      |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
	                      |ГДЕ
	                      |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	ТаблицаРезультат = Запрос.Выполнить().Выбрать();
	
	Если ТаблицаРезультат.Количество() = 0 Тогда
		Возврат Размер;
	Иначе
		
		Пока ТаблицаРезультат.Следующий() Цикл
			Если ЗначениеЗаполнено(ТаблицаРезультат.Размер) Тогда
				Размер = Размер + ТаблицаРезультат.Размер;
			КонецЕсли;
		КонецЦикла;
		
		Возврат Размер;
		
	КонецЕсли;
	
КонецФункции

Функция ПечатьИзЭлектронногоПредставленияНеПоддерживается(ВидОтчета) Экспорт
	
	Если ПолучитьСписокОтчетовПоддерживающихПечатьИзЭлектронногоПредставления().Найти(ВидОтчета) = Неопределено Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьСписокОтчетовПоддерживающихПечатьИзЭлектронногоПредставления() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВидыОтправляемыхДокументов.Ссылка
	|ИЗ
	|	Справочник.ВидыОтправляемыхДокументов КАК ВидыОтправляемыхДокументов
	|ГДЕ
	|	НЕ ВидыОтправляемыхДокументов.ПометкаУдаления
	|	И ВидыОтправляемыхДокументов.Предопределенный
	|	И ВидыОтправляемыхДокументов.ТипДокумента В (ЗНАЧЕНИЕ(Перечисление.ТипыОтправляемыхДокументов.БухгалтерскаяОтчетность), ЗНАЧЕНИЕ(Перечисление.ТипыОтправляемыхДокументов.ПрочаяОтчетностьФНС))
	|	И НЕ ВидыОтправляемыхДокументов.Родитель В ИЕРАРХИИ (ЗНАЧЕНИЕ(Справочник.ВидыОтправляемыхДокументов.ОтчетностьГосУчреждений))
	|	И НЕ ВидыОтправляемыхДокументов.Родитель В ИЕРАРХИИ (ЗНАЧЕНИЕ(Справочник.ВидыОтправляемыхДокументов.УдалитьОтчетностьПоАлкоголю))
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВидыОтправляемыхДокументов.Наименование";
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");

КонецФункции


//////////////////////////////////////////////////////////////////////////////////
//// РАБОТА С НЕФОРМАЛИЗОВАННЫМИ ДОКУМЕНТАМИ
////

Функция ПолучитьВложениеНеформализованногоДокумента(НеформализованныйДокумент, ИмяФайла, ХранилищеФайла, Тип = Неопределено, Размер = Неопределено) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	ВложенияНеформализованныхДокументов.ИмяФайла,
						  |	ВложенияНеформализованныхДокументов.Данные,
						  |	ВложенияНеформализованныхДокументов.Тип,
						  |	ВложенияНеформализованныхДокументов.Размер
						  |ИЗ
						  |	РегистрСведений.ВложенияНеформализованныхДокументов КАК ВложенияНеформализованныхДокументов
						  |ГДЕ
						  |	ВложенияНеформализованныхДокументов.НеформализованныйДокумент = &НеформализованныйДокумент");
	Запрос.УстановитьПараметр("НеформализованныйДокумент", НеформализованныйДокумент);
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Если Выборка.Следующий() Тогда
			ИмяФайла = Выборка.ИмяФайла;
			ХранилищеФайла = Выборка.Данные;
			Тип = Выборка.Тип;
			Размер = Выборка.Размер;
			Возврат Истина;
		КонецЕсли;
	КонецЕсли;
	ИмяФайла = "";
	ХранилищеФайла = Неопределено;
	Размер = Неопределено;
	Возврат Ложь;
	
КонецФункции

Функция ДобавитьВложенияПисьма(Письмо, ИмяФайла, Данные, Тип, Размер = Неопределено) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Письмо) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если Размер = Неопределено Тогда
		Размер = ОпределитьРазмер(Данные);
	КонецЕсли;
	
	МенеджерЗаписи = РегистрыСведений.ВложенияНеформализованныхДокументов.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.НеформализованныйДокумент = Письмо;
	МенеджерЗаписи.ИмяФайла = ИмяФайла;
	МенеджерЗаписи.Тип = Тип;
	МенеджерЗаписи.Размер = Размер;
	
	ТипДанных = ТипЗнч(Данные);
	Если ТипДанных = Тип("ХранилищеЗначения") Тогда
		МенеджерЗаписи.Данные = Данные;
	ИначеЕсли ТипДанных = Тип("Строка") Тогда
		МенеджерЗаписи.Данные = Новый ХранилищеЗначения(Новый ДвоичныеДанные(Данные), Новый СжатиеДанных(9));
	Иначе
		МенеджерЗаписи.Данные = Новый ХранилищеЗначения(Данные, Новый СжатиеДанных(9));
	КонецЕсли;
	Попытка
		МенеджерЗаписи.Записать(Истина);
		Возврат Истина;
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Не удалось сохранить в информационной базе вложение %1 письма %2!%3'"),
																					Символ(34) + ИмяФайла + Символ(34),
																					Символ(34) + Письмо + Символ(34),
																					Символы.ПС + ОписаниеОшибки());
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

Функция ИзвлечьИменаФайловНФДИзОписания(ФайлОписания) Экспорт
	
	// выгружаем файл на диск, при необходимости
	ТипЗнчФайлОписания = ТипЗнч(ФайлОписания);
	Если ТипЗнчФайлОписания = Тип("ДвоичныеДанные") Тогда
		ВремФайл = ПолучитьИмяВременногоФайла();
		ФайлОписания.Записать(ВремФайл);
		НеобходимоУдалитьФайлОписания = Истина;
	ИначеЕсли ТипЗнчФайлОписания = Тип("ХранилищеЗначения") Тогда
		ВремФайл = ПолучитьИмяВременногоФайла();
		ФайлОписания.Получить().Записать(ВремФайл);
		НеобходимоУдалитьФайлОписания = Истина;
	Иначе
		ВремФайл = ФайлОписания;
		НеобходимоУдалитьФайлОписания = Ложь;
	КонецЕсли;
		
	// читаем содержимое
	Текст = Новый ЧтениеТекста(ВремФайл);
	СодержимоеФайлаОписания = Текст.Прочитать();
	Текст.Закрыть();
	
	// удаляем файл, при необходимости
	Если НеобходимоУдалитьФайлОписания Тогда
		УдалитьФайлы(ВремФайл);
	КонецЕсли;
	
	// анализируем файл
	Результат = Новый Соответствие;
	Для Инд = 1 По СтрЧислоСтрок(СодержимоеФайлаОписания) Цикл
		ТекСтр = СтрПолучитьСтроку(СодержимоеФайлаОписания, Инд);
		ВхождениеДвоеточия = Найти(ТекСтр, ":");
		Если ВхождениеДвоеточия <> 0 Тогда
			Ключ = Лев(ТекСтр, ВхождениеДвоеточия - 1);
			Значение = Сред(ТекСтр, ВхождениеДвоеточия + 1);
			Если НЕ ПустаяСтрока(Ключ) И НЕ ПустаяСтрока(Значение) Тогда
				Результат.Вставить(СокрЛП(Ключ), СокрЛП(Значение));
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// продублирована в контейнере
Функция ПолучитьВложенияНеформализованногоДокумента(ДокНФД, ИмяФайла = Неопределено, СДанными = Ложь) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ
						  |	ВложенияНеформализованныхДокументов.ИмяФайла,
						  |	ВложенияНеформализованныхДокументов.Размер,
						  |	ВложенияНеформализованныхДокументов.Тип");
	Если СДанными Тогда
		Запрос.Текст = Запрос.Текст + ",
						  |	ВложенияНеформализованныхДокументов.Данные";
	КонецЕсли;
	Запрос.Текст = Запрос.Текст + "
						  |ИЗ
						  |	РегистрСведений.ВложенияНеформализованныхДокументов КАК ВложенияНеформализованныхДокументов
						  |ГДЕ
						  |	ВложенияНеформализованныхДокументов.НеформализованныйДокумент = &НеформализованныйДокумент";
	Если ИмяФайла <> Неопределено Тогда
		Запрос.Текст = Запрос.Текст + "
						  |	И ВложенияНеформализованныхДокументов.ИмяФайла " + ?(ТипЗнч(ИмяФайла) = Тип("Строка"), "=", "В") + " (&ИмяФайла)";
		Запрос.УстановитьПараметр("ИмяФайла", ИмяФайла);
	КонецЕсли;
	Запрос.УстановитьПараметр("НеформализованныйДокумент", ДокНФД);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ДобавитьСодержимоеТранспортногоКонтейнера(ТранспортноеСообщение,
													Тип,
													Данные,
													ИмяФайла,
													Размер = Неопределено,
													ЭЦПИмяПодписанногоФайла = Неопределено,
													ЭЦПСертификат = Неопределено,
													ЭЦПСтатусПроверки = Неопределено,
													ЭЦПЭтоПодписьАбонента = Неопределено,
													ТипФайлаОтчетностиПФР = Неопределено,
													Идентификатор = Неопределено,
													ТипСодержимогоФайла = Неопределено) Экспорт
	
	Если Размер = Неопределено Тогда
		Размер = ОпределитьРазмер(Данные);
	КонецЕсли;
	
	МенеджерЗаписи = РегистрыСведений.СодержимоеТранспортныхКонтейнеров.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.ТранспортноеСообщение = ТранспортноеСообщение;
	МенеджерЗаписи.ИмяФайла = ИмяФайла;
	МенеджерЗаписи.Тип = Тип;
	МенеджерЗаписи.Размер = Размер;
	МенеджерЗаписи.Идентификатор = Идентификатор;
	
	Если ЭЦПСертификат <> Неопределено Тогда
		МенеджерЗаписи.ЭЦПСертификат = ЭЦПСертификат;
	КонецЕсли;
	
	Если ЭЦПСтатусПроверки <> Неопределено Тогда
		МенеджерЗаписи.ЭЦПСтатусПроверки = ЭЦПСтатусПроверки;
	КонецЕсли;
	
	Если ЭЦПИмяПодписанногоФайла <> Неопределено Тогда
		МенеджерЗаписи.ЭЦПИмяПодписанногоФайла = ЭЦПИмяПодписанногоФайла;
	КонецЕсли;
	
	Если ЭЦПЭтоПодписьАбонента <> Неопределено Тогда
		МенеджерЗаписи.ЭЦПЭтоПодписьАбонента = ЭЦПЭтоПодписьАбонента;
	КонецЕсли;
	
	Если ТипФайлаОтчетностиПФР <> Неопределено Тогда
		МенеджерЗаписи.ТипФайлаОтчетностиПФР = ТипФайлаОтчетностиПФР;
	КонецЕсли;
	
	Если ТипСодержимогоФайла <> Неопределено Тогда
		Если ТипЗнч(ТипСодержимогоФайла) = Тип("Строка") Тогда
			МенеджерЗаписи.ТипСодержимогоФайла = ТипСодержимогоПоСтроке(ТипСодержимогоФайла);
		Иначе
			МенеджерЗаписи.ТипСодержимогоФайла = ТипСодержимогоФайла;
		КонецЕсли;  
	КонецЕсли;
	
	ТипДанных = ТипЗнч(Данные);
	Если ТипДанных = Тип("ХранилищеЗначения") Тогда // если хранилище значения
		МенеджерЗаписи.Данные = Данные;
	ИначеЕсли ТипДанных = Тип("Строка") Тогда // если полное имя файла
		Если ЭтоАдресВременногоХранилища(Данные) Тогда
			ДвДанные = ПолучитьИзВременногоХранилища(Данные);
			МенеджерЗаписи.Данные = Новый ХранилищеЗначения(ДвДанные, Новый СжатиеДанных(9));
		Иначе
			ДвДанные = Новый ДвоичныеДанные(Данные);
			МенеджерЗаписи.Данные = Новый ХранилищеЗначения(ДвДанные, Новый СжатиеДанных(9));
		КонецЕсли;
		
		Если Размер = Неопределено Тогда
			Размер = ДвДанные.Размер();
		КонецЕсли;
	ИначеЕсли ТипДанных = Тип("Структура") Тогда
		
		ДвДанные = ДвоичныеДанныеИзСтроки64НаСервере(Данные.Строка64);
		МенеджерЗаписи.Данные = Новый ХранилищеЗначения(ДвДанные);
		
		Если Размер = Неопределено Тогда
			Размер = ДвДанные.Размер();
		КонецЕсли;
	Иначе // если двоичные данные
		МенеджерЗаписи.Данные = Новый ХранилищеЗначения(Данные, Новый СжатиеДанных(9));
	КонецЕсли;
	
	Попытка
		МенеджерЗаписи.Записать(Истина);
		Возврат Истина;
	Исключение

		ИнформацияОбОшибке = ИнформацияОбОшибке().Описание;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Не удалось сохранить в информационной базе содержимое транспортного контейнера сообщения %1!%2'"),
			Символ(34) + ТранспортноеСообщение.Ссылка + Символ(34),
			Символы.ПС + ИнформацияОбОшибке);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

Функция ОпределитьРазмер(Данные) Экспорт
	
	Размер = 0;
	
	ТипДанных = ТипЗнч(Данные);
	Если ТипДанных = Тип("Строка") Тогда
		Если ЭтоАдресВременногоХранилища(Данные) Тогда // если это адрес во временном хранилище
			ДвоичныеДанные = ПолучитьИзВременногоХранилища(Данные);
			Размер = ДвоичныеДанные.Размер();
		Иначе // если это файл на сервере
			ОбъектФайл = Новый Файл(Данные);
			Размер = ОбъектФайл.Размер();
		КонецЕсли;
	ИначеЕсли ТипДанных = Тип("ХранилищеЗначения") Тогда
		ДвоичныеДанные = Данные.Получить();
		Если ТипЗнч(ДвоичныеДанные) <> Тип("ДвоичныеДанные") Тогда
			Возврат 0;
		КонецЕсли;
		Размер = ДвоичныеДанные.Размер();
	ИначеЕсли ТипДанных = Тип("ДвоичныеДанные") Тогда
		Размер = Данные.Размер();
	КонецЕсли;
	
	Возврат Размер;
	
КонецФункции

Функция ПолучитьВложенияТранспортногоСообщения(ТранспортноеСообщение, СДанными = Ложь, ФильтрПоТипу = Неопределено, ИмяФайла = Неопределено, САдресом = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
					  |	СодержимоеТранспортныхКонтейнеров.ИмяФайла,
					  |	СодержимоеТранспортныхКонтейнеров.Размер,
					  |	СодержимоеТранспортныхКонтейнеров.Тип,
					  |	СодержимоеТранспортныхКонтейнеров.ЭЦПСертификат,
					  |	СодержимоеТранспортныхКонтейнеров.ЭЦПСтатусПроверки,
					  |	СодержимоеТранспортныхКонтейнеров.ЭЦПИмяПодписанногоФайла,
					  |	СодержимоеТранспортныхКонтейнеров.ЭЦПЭтоПодписьАбонента,
					  |	СодержимоеТранспортныхКонтейнеров.ТипФайлаОтчетностиПФР,
					  |	СодержимоеТранспортныхКонтейнеров.Идентификатор,
					  |	СодержимоеТранспортныхКонтейнеров.ТипСодержимогоФайла,
					  |	СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение";
	Если СДанными Тогда
		Запрос.Текст = Запрос.Текст + ",
					  |	СодержимоеТранспортныхКонтейнеров.Данные";
	КонецЕсли;
	Запрос.Текст = Запрос.Текст + "
					  |ИЗ
					  |	РегистрСведений.СодержимоеТранспортныхКонтейнеров КАК СодержимоеТранспортныхКонтейнеров
					  |ГДЕ
					  |	СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение В (&ТранспортноеСообщение)";
	
	Если ИмяФайла <> Неопределено Тогда
		Если ТипЗнч(ИмяФайла) = Тип("СписокЗначений") ИЛИ ТипЗнч(ИмяФайла) = Тип("Массив") Тогда
			Запрос.Текст = Запрос.Текст + "
					  	  |	И СодержимоеТранспортныхКонтейнеров.ИмяФайла В (&парамИмяФайла)";
			Запрос.УстановитьПараметр("парамИмяФайла", ИмяФайла);
		//Иначе
		ИначеЕсли ТипЗнч(ИмяФайла) = Тип("Строка") И ЗначениеЗаполнено(ИмяФайла) Тогда
			Запрос.Текст = Запрос.Текст + "
					  	  |	И СодержимоеТранспортныхКонтейнеров.ИмяФайла = &парамИмяФайла";
			Запрос.УстановитьПараметр("парамИмяФайла", ИмяФайла);
		КонецЕсли;
	КонецЕсли;
	
	Если ФильтрПоТипу <> Неопределено Тогда
		Если ТипЗнч(ФильтрПоТипу) = Тип("СписокЗначений") ИЛИ ТипЗнч(ФильтрПоТипу) = Тип("Массив") Тогда
			Запрос.Текст = Запрос.Текст + "
					  |	И СодержимоеТранспортныхКонтейнеров.Тип В(&ТипыТранспортныхСообщений)";
			Запрос.УстановитьПараметр("ТипыТранспортныхСообщений", ФильтрПоТипу);
		Иначе
			Запрос.Текст = Запрос.Текст + "
					  |	И СодержимоеТранспортныхКонтейнеров.Тип = &ТипТранспортногоСообщения";
			Запрос.УстановитьПараметр("ТипТранспортногоСообщения", ФильтрПоТипу);
		КонецЕсли;
	КонецЕсли;
	
	ТипСообщения = ТипЗнч(ТранспортноеСообщение);
	Если ТипСообщения = Тип("ДокументСсылка.ТранспортноеСообщение") ИЛИ ТипСообщения = Тип("Массив") Тогда
		Запрос.УстановитьПараметр("ТранспортноеСообщение", ТранспортноеСообщение);
	Иначе
		Запрос.УстановитьПараметр("ТранспортноеСообщение", ТранспортноеСообщение.Ссылка);
	КонецЕсли;
	
	ТаблицаВложений = Запрос.Выполнить().Выгрузить();
	Если САдресом Тогда
		ТаблицаВложений.Колонки.Добавить("Адрес", Новый ОписаниеТипов("Строка"));
		Для каждого Вложение Из ТаблицаВложений Цикл
			Вложение.Адрес = ПоместитьВоВременноеХранилище(Вложение.Данные.Получить(), Новый УникальныйИдентификатор);
		КонецЦикла; 
	КонецЕсли;
	
	Возврат ТаблицаВложений;
	
КонецФункции

Функция ПолучитьТранспортныйКонтейнер(ТранспортноеСообщение, СДанными = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
					  |	ТранспортныеКонтейнеры.ИмяФайла";
	Если СДанными = Истина Тогда
		Запрос.Текст = Запрос.Текст + ",
					  |	ТранспортныеКонтейнеры.Данные";
	КонецЕсли;
	Запрос.Текст = Запрос.Текст + "
					  |ИЗ
					  |	РегистрСведений.ТранспортныеКонтейнеры КАК ТранспортныеКонтейнеры
					  |ГДЕ
					  |	ТранспортныеКонтейнеры.ТранспортноеСообщение = &ТранспортноеСообщение";
	Запрос.УстановитьПараметр("ТранспортноеСообщение", ТранспортноеСообщение);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ТранспортныйКонтейнерПрисутствует(Сообщение) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	ИСТИНА КАК ЕстьКонтейнер
						  |ИЗ
						  |	РегистрСведений.ТранспортныеКонтейнеры КАК ТранспортныеКонтейнеры
						  |ГДЕ
						  |	ТранспортныеКонтейнеры.ТранспортноеСообщение = &ТранспортноеСообщение");
	Запрос.УстановитьПараметр("ТранспортноеСообщение", Сообщение);
	Возврат НЕ Запрос.Выполнить().Пустой();
	
КонецФункции

Процедура УдалитьТранспортныйКонтейнер(Сообщение) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Сообщение) Тогда
		Возврат;
	КонецЕсли;
	
	НаборЗаписей = РегистрыСведений.ТранспортныеКонтейнеры.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.ТранспортноеСообщение.Установить(Сообщение);
	НаборЗаписей.Записать();
	
	////#Если Клиент Тогда
	//Оповестить("Изменение сообщения", Новый Структура("Сообщение, ЦиклОбмена, Предмет", Сообщение, Сообщение.ЦиклОбмена, ПолучитьПредметыЦиклаОбмена(Сообщение.ЦиклОбмена)));
	////#КонецЕсли
	
КонецПроцедуры

//////////////////////////////////////////////////////////////////////////////////
//// ШИФРОВАНИЕ И РАСШИФРОВКА
////

Функция СообщениеЗашифровано(Сообщение) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	ИСТИНА КАК Поле1
						  |ИЗ
						  |	РегистрСведений.ТранспортныеКонтейнеры КАК ТранспортныеКонтейнеры
						  |ГДЕ
						  |	ТранспортныеКонтейнеры.ТранспортноеСообщение = &ТранспортноеСообщение");
	Запрос.УстановитьПараметр("ТранспортноеСообщение", Сообщение);
	Возврат НЕ Запрос.Выполнить().Пустой();
	
КонецФункции

Функция СообщениеРасшифровано(Сообщение) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	ИСТИНА КАК Поле1
						  |ИЗ
						  |	РегистрСведений.СодержимоеТранспортныхКонтейнеров КАК СодержимоеТранспортныхКонтейнеров
						  |ГДЕ
						  |	СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение = &ТранспортноеСообщение");
	Запрос.УстановитьПараметр("ТранспортноеСообщение", Сообщение);
	Возврат НЕ Запрос.Выполнить().Пустой();
	
КонецФункции

Процедура ПолучитьИРасшифроватьСообщенияПоУчетнойЗаписи(Знач УчетнаяЗапись, Почта = Неопределено, ТихийРежим = Ложь, РасшифровыватьПринудительно = Ложь, ТребуетсяПроверкаУчетнойЗаписи = Истина, ТребуетсяАвтонастройка = Истина) Экспорт
	
	// получаем сообщения с сервера
	ВходящиеСообщения = Новый Массив;
	
КонецПроцедуры

Функция УчетныеЗаписиПоОрганизациям(Организации) Экспорт
	
	СоответствиеУчетныхЗаписейОрганизациям = Новый Соответствие;
	УчетныеЗаписи = Новый Массив;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	Организации.Ссылка КАК Организация,
						  |	ВЫБОР
						  |		КОГДА Организации.ВидОбменаСКонтролирующимиОрганами = &ОбменВУниверсальномВФормате
						  |			ТОГДА Организации.УчетнаяЗаписьОбмена
						  |		ИНАЧЕ НЕОПРЕДЕЛЕНО
						  |	КОНЕЦ КАК УчетнаяЗапись
						  |ИЗ
						  |	Справочник.Организации КАК Организации
						  |ГДЕ
						  |	Организации.Ссылка В(&Ссылка)");
	Запрос.УстановитьПараметр("ОбменВУниверсальномВФормате", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	Запрос.УстановитьПараметр("Ссылка", Организации);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		СоответствиеУчетныхЗаписейОрганизациям.Вставить(Выборка.Организация, Выборка.УчетнаяЗапись);
	КонецЦикла;
	
	Для Инд = 1 По Организации.Количество() Цикл
		
		ТекОрганизация = Организации.Получить(Инд - 1);
		ТекУчетнаяЗапись = СоответствиеУчетныхЗаписейОрганизациям[ТекОрганизация];
		
		Если ЗначениеЗаполнено(ТекУчетнаяЗапись) И УчетныеЗаписи.Найти(ТекУчетнаяЗапись) = Неопределено Тогда
			УчетныеЗаписи.Добавить(ТекУчетнаяЗапись);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат УчетныеЗаписи;
	
КонецФункции

Процедура ЗашифроватьСообщенияПоУчетнойЗаписи(Знач УчетнаяЗапись, ТихийРежим = Ложь) Экспорт
	
	Если УчетнаяЗапись = Неопределено Тогда
		ТекстСообщения = НСтр("ru = 'Не задана учетная запись для подготовки сообщений!'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

Функция ВсеСообщенияЦиклаОбменаОтправленыПриняты(ЦиклОбмена)
	
	Сообщения = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена);
	
	// удаляем из таблицы те сообщения, которые не были отправлены/приняты
	ЧислоСообщений = Сообщения.Количество();
	Для Инд = 1 По ЧислоСообщений Цикл
		
		ОбратныйИнд = ЧислоСообщений - Инд;
		ТекСтр = Сообщения[ОбратныйИнд];
		Если ТекСтр.Статус <> Перечисления.СтатусыПисем.Отправленное И ТекСтр.Статус <> Перечисления.СтатусыПисем.Полученное Тогда
			Сообщения.Удалить(ТекСтр);
		КонецЕсли;
		
	КонецЦикла;
	
	ВозможныеТипы = Новый Массив;
	Если ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность Тогда
		
		Если ЦиклОбмена.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534 Тогда
			
			ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ДекларацияНП);
			ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО);
			ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
			ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО);
			ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО);
			ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
			
		КонецЕсли;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьПФР Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИОС Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРИсходящие Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРВходящие Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОбращениеНП Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ОбращениеНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Представление Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ПисьмоНО Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Рассылка Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.РассылкаНО);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.РассылкаГрупповая Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.РассылкаНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИОН Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ЗапросНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Документ Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ДокументНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНО);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Заявление Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗаявлениеНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьФСГС Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ПисьменноеОбращениеВФСГС Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС);
		//ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС);
		//ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИндивидуальноеИнформированиеФСГС Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС);
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ЗапросНаВыпискуИзЕГРЮЛ_ЕГРИП Тогда
		
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.ЗапросНаВыпискуЕРГЮЛ_ЕГРИП);
		ВозможныеТипы.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросаНаВыпискуЕРГЮЛ_ЕГРИП);
		
	КонецЕсли;
	
	Для Каждого ВозможныйТип Из ВозможныеТипы Цикл
		Если Сообщения.Найти(ВозможныйТип, "Тип") = Неопределено Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	// ФНС 534
	Если ЦиклОбмена.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534 Тогда
		Если ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность Тогда
			Если НЕ АктуальныйПротоколВходногоКонтроляЯвляетсяОтрицательным(ЦиклОбмена) Тогда
				Если Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО, "Тип") = Неопределено
				ИЛИ Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП, "Тип") = Неопределено Тогда
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИОН Тогда
			Если НЕ АктуальныйПротоколВходногоКонтроляЯвляетсяОтрицательным(ЦиклОбмена) Тогда
				Если Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО, "Тип") = Неопределено
				ИЛИ Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП, "Тип") = Неопределено Тогда
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Заявление Тогда
			Если НЕ АктуальныйПротоколВходногоКонтроляЯвляетсяОтрицательным(ЦиклОбмена) Тогда
				ОтсутствуетРезультатОбработки = (Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО, "Тип") = Неопределено
				И Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО, "Тип") = Неопределено);
				
				ОтсутствуетПодтвеждениеРезультатаОбработки = (Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП, "Тип") = Неопределено
				И Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП, "Тип") = Неопределено);
				
				Если ОтсутствуетРезультатОбработки ИЛИ ОтсутствуетПодтвеждениеРезультатаОбработки Тогда
					Возврат Ложь;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	// ПФР
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьПФР Тогда
		Если НЕ АктуальноеПодтверждениеПолученияОтчетностиПФРЯвляетсяОтрицательным(ЦиклОбмена) Тогда
			Если Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.ПротоколПФР, "Тип") = Неопределено
			ИЛИ Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР, "Тип") = Неопределено Тогда
				Возврат Ложь;
			КонецЕсли;
		КонецЕсли;
		
	// ФСГС
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьФСГС Тогда
		Если НЕ АктуальноеПодтверждениеПолученияОтчетностиФСГСЯвляетсяОтрицательным(ЦиклОбмена) Тогда
			Если Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС, "Тип") = Неопределено
			 ИЛИ Сообщения.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС, "Тип") = Неопределено Тогда
				Возврат Ложь;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	// проверяем, все ли подтверждения отправлены
	Если ЦиклОбмена.ДатаСоздания > '20090416' Тогда
		
		// определяем соответствие между типами сообщений-оснований и сообщений-подтверждений на них
		ТипыОснованийИПодтверждений = Новый Соответствие;
		
		// ФНС 534
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО , Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП);
		
		// ФНС 534 2-НДФЛ
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
		// ФНС 534 НФД
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
		// ФНС 534 Представление
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
		// ФНС 534 ИОН
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП);
		
		// ПФР
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколПФР, Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР, Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР, Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР);
		
		// Росстат
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС);
		
		// ФНС 534 НФД НО
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП);
		
		// ФНС 534 ДРП НО
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ДокументНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП);
		
		// ФНС 534 Заявление
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП);
		
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП);
		
		Если ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.РассылкаГрупповая Тогда
			ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РассылкаНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП);
		КонецЕсли;
		
		// перебираем соответствие подтверждений основаниям
		Для Каждого ТипОснованияИПодтверждения Из ТипыОснованийИПодтверждений Цикл
			
			ТипОснования = ТипОснованияИПодтверждения.Ключ;
			ТипПодтверждения = ТипОснованияИПодтверждения.Значение;
			
			// для каждого основания...
			СообщенияОснования = Сообщения.НайтиСтроки(Новый Структура("Тип", ТипОснования));
			Для Каждого СообщениеОснование Из СообщенияОснования Цикл
				
				// ... ищем подтверждение, и если не находим, то возвращаем Ложь
				Если Сообщения.Найти(СообщениеОснование.Ссылка, "Основание") = Неопределено Тогда
					Возврат Ложь;
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

Функция ПолучитьВложения(СсылкаПисьмо, ИменаВложений = Неопределено) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ВложенияНеформализованныхДокументов.ИмяФайла,
						  |	ВложенияНеформализованныхДокументов.Данные
						  |ИЗ
						  |	РегистрСведений.ВложенияНеформализованныхДокументов КАК ВложенияНеформализованныхДокументов
						  |ГДЕ
						  |	ВложенияНеформализованныхДокументов.НеформализованныйДокумент = &НеформализованныйДокумент");
	Запрос.УстановитьПараметр("НеформализованныйДокумент", СсылкаПисьмо);
	Если ИменаВложений <> Неопределено Тогда
		Запрос.Текст = Запрос.Текст + "
						  |	И ВложенияНеформализованныхДокументов.ИмяФайла В(&ИмяФайла)";
		Запрос.УстановитьПараметр("ИмяФайла", ИменаВложений);
	КонецЕсли;
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ВыгрузитьТекстВФайл(Текст, ИмяФайла = Неопределено, КодировкаТекста = "windows-1251")
	
	Если ЗначениеЗаполнено(ИмяФайла) Тогда
		ИмяФайлаСохранения = ИмяФайла;
	Иначе
		ИмяФайлаСохранения = ПолучитьИмяВременногоФайла();
	КонецЕсли;
	
	ОбъектЗапись = Новый ЗаписьТекста(ИмяФайлаСохранения, КодировкаТекста);
	ОбъектЗапись.Записать(Текст);
	Попытка
		ОбъектЗапись.Закрыть();
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат ИмяФайлаСохранения;
	
КонецФункции

Функция СформироватьИОП(ТранспортноеСообщение, ТекстВыгрузки = Неопределено, ИмяФайла = Неопределено) Экспорт
	
	ОрганизацияОтправитель = ТранспортноеСообщение.Отправитель;
	
	// в случае обмена через СОС налоговым органом-получателем считается конечный налоговый орган (указанный в титульном листе отчета),
	// а в случае обмена напрямую, НО-получателем считается налоговый орган, указанный в учетной записи
	НОПолучатель = ?(НЕ ТранспортноеСообщение.УчетнаяЗапись.ОбменНапрямую
					И (НЕ ТранспортноеСообщение.Отправитель.КрупнейшийНалогоплательщик ИЛИ НЕ ЗначениеЗаполнено(ТранспортноеСообщение.Отправитель.КодНалоговогоОрганаПолучателя)),
					ТранспортноеСообщение.ЦиклОбмена.ВнешняяОрганизация,
					ТранспортноеСообщение.УчетнаяЗапись.НалоговыйОрган);
	
	ИНН = СокрЛП(ОрганизацияОтправитель.ИНН);
	Если ПустаяСтрока(ИНН) Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Не задан ИНН для отправителя - организации %1!'"),
																					Символ(34) + ОрганизацияОтправитель + Символ(34));
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	Текст = Новый ТекстовыйДокумент;
	Текст.ДобавитьСтроку("ИдОтпр:" + СокрЛП(ИНН));
	
	Текст.ДобавитьСтроку("ВерсПрог:" + РегламентированнаяОтчетность.НазваниеИВерсияПрограммы());
	
	ИмяВремФайла = ПолучитьИмяВременногоФайла();
	Текст.Записать(ИмяВремФайла, "windows-1251");
	
	Возврат ИмяВремФайла;
	
КонецФункции

Функция ИзвлечьПоказатель(ТекстВыгрузки, КодПоказателя) Экспорт
	
	Если Лев(СокрЛ(ТекстВыгрузки), 1) = "<" Тогда // это XML
		ОбъектЧтениеXML = Новый ЧтениеXML;
		ОбъектЧтениеXML.УстановитьСтроку(ТекстВыгрузки);
		ОбъектЧтениеXML.ИгнорироватьПробелы = Ложь;
		Пока ОбъектЧтениеXML.Прочитать() Цикл
			Если ОбъектЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
				Пока ОбъектЧтениеXML.ПрочитатьАтрибут() Цикл
					Если ОбъектЧтениеXML.Имя = КодПоказателя Тогда
						Возврат ОбъектЧтениеXML.Значение;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;	
	Иначе
		Для Инд = 1 По СтрЧислоСтрок(ТекстВыгрузки) Цикл
			ТекСтр = СтрПолучитьСтроку(ТекстВыгрузки, Инд);
			Если ВРЕГ(Лев(ТекСтр, СтрДлина(КодПоказателя) + 1)) = ВРЕГ(КодПоказателя + ":") Тогда
				Возврат Сред(ТекСтр, СтрДлина(КодПоказателя) + 2);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	Возврат Неопределено;
	
КонецФункции

Функция ВыборВТабличномПолеЦикловОбмена(Элемент = Неопределено, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка) Экспорт
	
	СоответствиеИменКолонок = Новый Соответствие();
	// ТаблицаЦиклыОбменаОтчетностьФНС 
	СоответствиеИменКолонок.Вставить("ПервичноеСообщение", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ПодтверждениеОтправки", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ОтветНаПодтверждениеОтправки", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ПодтверждениеДоставки", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ПротоколПроверки", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ПодтверждениеНаПротоколПроверки", "ПодтверждениеНаПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ОтветНаЗапрос", "ОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ОтветНаОтветНаЗапрос", "ОтветНаОтветНаЗапрос");
	// ТаблицаЦиклыОбменаИсходящиеФНС 
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеФНСКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеФНСКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеФНСКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеФНСКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеФНСКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеФНСКолонка6", "ПодтверждениеНаПротоколПроверки");
	
	// ТаблицаЦиклыОбменаПредставления 
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаПредставленияКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаПредставленияКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаПредставленияКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаПредставленияКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаПредставленияКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаПредставленияКолонка6", "ПодтверждениеНаПротоколПроверки");
	
	//ЦиклыОбменаФНС
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПредставленияКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПредставленияКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПредставленияКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПредставленияКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПредставленияКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПредставленияКолонка6", "ПодтверждениеНаПротоколПроверки");

	// ТаблицаЦиклыОбменаУведомления
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаУведомленияКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаУведомленияКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаУведомленияКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаУведомленияКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаУведомленияКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаУведомленияКолонка6", "ПодтверждениеНаПротоколПроверки");
	
	//ТаблицаЦиклыОбменаВходящиеФНС
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаВходящиеФНСКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаВходящиеФНСКолонка4", "ПодтверждениеДоставки");
	// ТаблицаЦиклыОбменаОтчетностьПФР
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьПФРКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьПФРКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьПФРКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьПФРКолонка6", "ПодтверждениеНаПротоколПроверки");
	// ТаблицаЦиклыОбменаЗапросыПФР
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыПФРКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыПФРКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыПФРКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыПФРКолонка6", "ПодтверждениеНаПротоколПроверки");
	//ТаблицаЦиклыОбменаИсходящиеПФР
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеПФРКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеПФРКолонка4", "ПодтверждениеДоставки");
	//ТаблицаЦиклыОбменаВходящиеПФР
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаВходящиеПФРКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаВходящиеПФРКолонка4", "ПодтверждениеДоставки");
	// ТаблицаЦиклыОбменаЗапросыИОН 
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОНКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОНКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОНКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОНКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОНКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОНКолонка6", "ПодтверждениеНаПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОНКолонка7", "ОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОНКолонка8", "ОтветНаОтветНаЗапрос");
	//ЦиклыОбменаФНС
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФНСКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФНСКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФНСКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФНСКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФНСКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФНСКолонка6", "ПодтверждениеНаПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФНСКолонка7", "ОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФНСКолонка8", "ОтветНаОтветНаЗапрос");
	
	//ТаблицаЦиклыОбменаЗаявление
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка6", "ПодтверждениеНаПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка7", "ОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка8", "ОтветНаОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка9", "Возврат");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗаявлениеКолонка10", "ПодтверждениеВозврата");
	
	//ЦиклыОбменаЗаявление
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка6", "ПодтверждениеНаПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка7", "ОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка8", "ОтветНаОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка9", "Возврат");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗаявлениеКолонка10", "ПодтверждениеВозврата");

	//ЦиклыОбменаТребования
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаТребованияКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаТребованияКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаТребованияКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаТребованияКолонка6", "ПодтверждениеНаПротоколПроверки");

	//ЦиклыОбменаПФР
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПФРКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПФРКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПФРКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаПФРКолонка6", "ПодтверждениеНаПротоколПроверки");
	
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОСКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОСКолонка2", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОСКолонка3", "ОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаЗапросыИОСКолонка4", "ОтветНаОтветНаЗапрос");
	
	//ЦиклыОбменаФСГС
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФСГСКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФСГСКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФСГСКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФСГСКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФСГСКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФСГСКолонка6", "ПодтверждениеНаПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФСГСКолонка7", "ОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаФСГСКолонка8", "ОтветНаОтветНаЗапрос");
	
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьФСГСКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьФСГСКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьФСГСКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьФСГСКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьФСГСКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьФСГСКолонка6", "ПодтверждениеНаПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьФСГСКолонка7", "ОтветНаЗапрос");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаОтчетностьФСГСКолонка8", "ОтветНаОтветНаЗапрос");
	
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеФСГСКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаИсходящиеФСГСКолонка4", "ПодтверждениеДоставки");
	
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаВходящиеФСГСКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаВходящиеФСГСКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаВходящиеФСГСКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ТаблицаЦиклыОбменаВходящиеФСГСКолонка4", "ПодтверждениеДоставки");
	
	// Запросы на выписку ЕГРЮЛ/ЕГРИП
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗапросыЕГРКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаЗапросыЕГРКолонка2", "ОтветНаЗапрос");
	
	//ЦиклыОбменаУведомление
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаУведомлениеКолонка1", "ПервичноеСообщение");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаУведомлениеКолонка2", "ПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаУведомлениеКолонка3", "ОтветНаПодтверждениеОтправки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаУведомлениеКолонка4", "ПодтверждениеДоставки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаУведомлениеКолонка5", "ПротоколПроверки");
	СоответствиеИменКолонок.Вставить("ЦиклыОбменаУведомлениеКолонка6", "ПодтверждениеНаПротоколПроверки");
	
	//ИмяКолонки = Колонка.Имя;
	ИмяКолонки = СоответствиеИменКолонок[Колонка];

	Если ИмяКолонки = "ПервичноеСообщение" ИЛИ ИмяКолонки = "ПодтверждениеОтправки" ИЛИ ИмяКолонки = "ОтветНаПодтверждениеОтправки"
	ИЛИ ИмяКолонки = "ПодтверждениеДоставки" ИЛИ ИмяКолонки = "ПротоколПроверки" ИЛИ ИмяКолонки = "ПодтверждениеНаПротоколПроверки"
	ИЛИ ИмяКолонки = "ОтветНаЗапрос" ИЛИ ИмяКолонки = "ОтветНаОтветНаЗапрос" 
	ИЛИ ИмяКолонки = "Возврат" ИЛИ ИмяКолонки = "ПодтверждениеВозврата" Тогда
	
		СтандартнаяОбработка = Ложь;
		
		ТипСообщенияДляПоказа = Неопределено;
		Если ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность Тогда
			Если ВыбраннаяСтрока.Ссылка.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534 Тогда
				Если ИмяКолонки = "ПервичноеСообщение" Тогда
					ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ДекларацияНП;
				ИначеЕсли ИмяКолонки = "ПодтверждениеОтправки" Тогда
					ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО;
				ИначеЕсли ИмяКолонки = "ОтветНаПодтверждениеОтправки" Тогда
					ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
				ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
					ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО;
				ИначеЕсли ИмяКолонки = "ПротоколПроверки" Тогда
					ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО;
				ИначеЕсли ИмяКолонки = "ПодтверждениеНаПротоколПроверки" Тогда
					ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
				ИначеЕсли ИмяКолонки = "ОтветНаЗапрос" Тогда
					ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО;
				ИначеЕсли ИмяКолонки = "ОтветНаОтветНаЗапрос" Тогда
					ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП;
				КонецЕсли;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.Документ Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ДокументНО;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП;
			ИначеЕсли ИмяКолонки = "ПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеНаПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНО;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.Заявление Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО;
			ИначеЕсли ИмяКолонки = "ОтветНаПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗаявлениеНО;
			ИначеЕсли ИмяКолонки = "ПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО;
			ИначеЕсли ИмяКолонки = "ПодтверждениеНаПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
			ИначеЕсли ИмяКолонки = "ОтветНаЗапрос" Тогда
				ТипСообщенияДляПоказа = Новый Массив;
				ТипСообщенияДляПоказа.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО);
				ТипСообщенияДляПоказа.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО);
			ИначеЕсли ИмяКолонки = "ОтветНаОтветНаЗапрос" Тогда
				ТипСообщенияДляПоказа = Новый Массив;
				ТипСообщенияДляПоказа.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП);
				ТипСообщенияДляПоказа.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП);
			ИначеЕсли ИмяКолонки = "Возврат" Тогда
				ТипСообщенияДляПоказа = Новый Массив;
				ТипСообщенияДляПоказа.Добавить(Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО);
				ТипСообщенияДляПоказа.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО);
			ИначеЕсли ИмяКолонки = "ПодтверждениеВозврата" Тогда
				ТипСообщенияДляПоказа = Новый Массив;
				ТипСообщенияДляПоказа.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП);
				ТипСообщенияДляПоказа.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП);
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО;
			ИначеЕсли ИмяКолонки = "ОтветНаПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО;
			ИначеЕсли ИмяКолонки = "ПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО;
			ИначеЕсли ИмяКолонки = "ПодтверждениеНаПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьПФР Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР;
			ИначеЕсли ИмяКолонки = "ПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПротоколПФР;
			ИначеЕсли ИмяКолонки = "ПодтверждениеНаПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРИсходящие Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРВходящие Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.ИОС Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР;
			ИначеЕсли ИмяКолонки = "ОтветНаЗапрос" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР;
			ИначеЕсли ИмяКолонки = "ОтветНаОтветНаЗапрос" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.ПисьмоНО Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПисьмоНО;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.Рассылка Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РассылкаНО;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.РассылкаГрупповая Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РассылкаНО;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.ОбращениеНП Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ОбращениеНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО;
			ИначеЕсли ИмяКолонки = "ОтветНаПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО;
			ИначеЕсли ИмяКолонки = "ПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО;
			ИначеЕсли ИмяКолонки = "ПодтверждениеНаПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.Представление Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО;
			ИначеЕсли ИмяКолонки = "ОтветНаПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО;
			ИначеЕсли ИмяКолонки = "ПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО;
			ИначеЕсли ИмяКолонки = "ПодтверждениеНаПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.ИОН Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ЗапросНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО;
			ИначеЕсли ИмяКолонки = "ОтветНаПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗапросНО;
			ИначеЕсли ИмяКолонки = "ПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО;
			ИначеЕсли ИмяКолонки = "ПодтверждениеНаПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
			ИначеЕсли ИмяКолонки = "ОтветНаЗапрос" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО;
			ИначеЕсли ИмяКолонки = "ОтветНаОтветНаЗапрос" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьФСГС Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС;
			ИначеЕсли ИмяКолонки = "ПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС;
			ИначеЕсли ИмяКолонки = "ОтветНаПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС;
			ИначеЕсли ИмяКолонки = "ПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС;
			ИначеЕсли ИмяКолонки = "ПодтверждениеНаПротоколПроверки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.ПисьменноеОбращениеВФСГС Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС;
			ИначеЕсли ИмяКолонки = "ПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС;
			ИначеЕсли ИмяКолонки = "ОтветНаПодтверждениеОтправки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС;
			КонецЕсли;
		ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.ИндивидуальноеИнформированиеФСГС Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС;
			ИначеЕсли ИмяКолонки = "ПодтверждениеДоставки" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС;
			КонецЕсли;
			ИначеЕсли ВыбраннаяСтрока.Ссылка.Тип = Перечисления.ТипыЦикловОбмена.ЗапросНаВыпискуИзЕГРЮЛ_ЕГРИП Тогда
			Если ИмяКолонки = "ПервичноеСообщение" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.ЗапросНаВыпискуЕРГЮЛ_ЕГРИП;
			ИначеЕсли ИмяКолонки = "ОтветНаЗапрос" Тогда
				ТипСообщенияДляПоказа = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросаНаВыпискуЕРГЮЛ_ЕГРИП;
			КонецЕсли;
		КонецЕсли;
		
		Если ТипСообщенияДляПоказа <> Неопределено Тогда
			
			Возврат ПоказатьСообщение(ВыбраннаяСтрока.Ссылка, ТипСообщенияДляПоказа);
			
		Иначе 
		КонецЕсли;
	
	КонецЕсли;

КонецФункции

Функция ТекущийПользовательЯвляетсяАдминистраторомУчетныхЗаписейДокументооборота() Экспорт
	
	Возврат Пользователи.ЭтоПолноправныйПользователь();
	
КонецФункции

Функция РасширениеФайла(ИмяФайла) Экспорт
	
	ДлинаИмени = СтрДлина(ИмяФайла);
	Для Инд = 1 По ДлинаИмени Цикл
		ТекИнд = ДлинаИмени - Инд + 1;
		Если Сред(ИмяФайла, ТекИнд, 1) = "." Тогда
			Возврат Сред(ИмяФайла, ТекИнд + 1);
		КонецЕсли;
	КонецЦикла;
	Возврат Неопределено;
	
КонецФункции

Функция ДатаПоСтроке(Знач Стр) ЭКспорт
	
	Попытка
		Если Найти(Стр, "-") <> 0 Тогда
			Если СтрДлина(Стр) > 10 Тогда
				Возврат Дата(Число(СокрЛП(Сред(Стр, 1, 4))),
							Число(СокрЛП(Сред(Стр, 6, 2))),
							Число(СокрЛП(Сред(Стр, 9, 2))),
							Число(СокрЛП(Сред(Стр, 12, 2))),
							Число(СокрЛП(Сред(Стр, 15, 2))),
							Число(СокрЛП(Сред(Стр, 18, 2))));
			Иначе
				Возврат Дата(Число(СокрЛП(Сред(Стр, 1, 4))),
							Число(СокрЛП(Сред(Стр, 6, 2))),
							Число(СокрЛП(Сред(Стр, 9, 2))));
			КонецЕсли;
		Иначе
			Если Найти(Стр, ":") <> 0 Тогда
				Стр = СтрЗаменить(Стр, " ", ",");
				Стр = СтрЗаменить(Стр, ":", ",");
				Стр = СтрЗаменить(Стр, ".", ",");
				Стр = СтрЗаменить(Стр, ",,", ",");
				МассивЭлементов = Новый Массив;
				ВхождениеРазделителя = Найти(Стр, ",");
				Пока ВхождениеРазделителя <> 0 Цикл
					МассивЭлементов.Добавить(СокрЛП(Лев(Стр, ВхождениеРазделителя - 1)));
					Стр = СокрЛП(Сред(Стр, ВхождениеРазделителя + 1));
					ВхождениеРазделителя = Найти(Стр, ",");
				КонецЦикла;
				Возврат Дата(ПолучитьЭлементДаты(МассивЭлементов, 2),
							ПолучитьЭлементДаты(МассивЭлементов, 1),
							ПолучитьЭлементДаты(МассивЭлементов, 0),
							ПолучитьЭлементДаты(МассивЭлементов, 3),
							ПолучитьЭлементДаты(МассивЭлементов, 4),
							ПолучитьЭлементДаты(МассивЭлементов, 5));
			Иначе
				Возврат Дата(Число(СокрЛП(Сред(Стр, 7, 4))),
							Число(СокрЛП(Сред(Стр, 4, 2))),
							Число(СокрЛП(Сред(Стр, 1, 2))));
			КонецЕсли;
		КонецЕсли;
	Исключение
		Возврат '00010101';
	КонецПопытки;
	
КонецФункции

//////////////////////////////////////////////////////////////////////////////////
//// ФУНКЦИИ РАБОТЫ С XML
////

Функция ЗагрузитьСтрокуXMLВДеревоЗначений(СтрокаXML, ОписаниеОшибки = Неопределено, ЧтениеXML = Неопределено, Знач ТекУзел = Неопределено) Экспорт
	
	ПерваяИтерация = (ТекУзел = Неопределено);
	Если ПерваяИтерация Тогда
		ТекУзел = СоздатьДеревоСтруктурыXML();
		Попытка
			ЧтениеXML = Новый ЧтениеXML;
			ЧтениеXML.УстановитьСтроку(СтрокаXML);
		Исключение
			ОписаниеОшибки = "Ошибка разбора XML: " + ИнформацияОбОшибке().Описание + ".";
			Возврат Неопределено;
		КонецПопытки;
	КонецЕсли;
	
	Попытка
		Пока ЧтениеXML.Прочитать() Цикл
			ТипУзла = ЧтениеXML.ТипУзла;
			Если ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
				НовУзел = ТекУзел.Строки.Добавить();
				НовУзел.Имя = ЧтениеXML.Имя;
				НовУзел.Тип = "Э";
				НовУзел.Значение = ЧтениеXML.Значение;
				Пока ЧтениеXML.ПрочитатьАтрибут() Цикл
					НовАтрибут = НовУзел.Строки.Добавить();
					НовАтрибут.Имя = ЧтениеXML.Имя;
					НовАтрибут.Тип = "А";
					НовАтрибут.Значение = ЧтениеXML.Значение;
				КонецЦикла;
				ЗагрузитьСтрокуXMLВДеревоЗначений(СтрокаXML, ОписаниеОшибки, ЧтениеXML, НовУзел);
				Если ЗначениеЗаполнено(ОписаниеОшибки) Тогда
					Возврат Неопределено;
				КонецЕсли;
			ИначеЕсли ТипУзла = ТипУзлаXML.КонецЭлемента Тогда
				Прервать;
			ИначеЕсли ТипУзла = ТипУзлаXML.Текст И ТипЗнч(ТекУзел) = Тип("СтрокаДереваЗначений") И ТекУзел.Тип = "Э" Тогда
				ТекУзел.Значение = ЧтениеXML.Значение;
			КонецЕсли;
		КонецЦикла;
	Исключение
		ОписаниеОшибки = "Ошибка разбора XML: " + ИнформацияОбОшибке().Описание + ".";
		Возврат Неопределено;
	КонецПопытки;
	
	Если ПерваяИтерация Тогда
		Возврат ТекУзел;
	КонецЕсли;
	
КонецФункции

Функция СоздатьДеревоСтруктурыXML() Экспорт
	
	ДеревоСтруктуры = Новый ДеревоЗначений;
	ДеревоСтруктуры.Колонки.Добавить("Имя");
	ДеревоСтруктуры.Колонки.Добавить("Тип");
	ДеревоСтруктуры.Колонки.Добавить("Значение");
	Возврат ДеревоСтруктуры;
	
КонецФункции

////
//// ФУНКЦИИ РАБОТЫ С XML
//////////////////////////////////////////////////////////////////////////////////

Функция ПредставлениеЦиклаОбмена(ЦиклОбмена) Экспорт
	
	Если ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность Тогда
		ПредставлениеЦиклаОбмена = "" + ЦиклОбмена.ВидОтчета + " за " + ПредставлениеПериода(ЦиклОбмена.ДатаНачалаПериода, КонецДня(ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина") + " (" + РегламентированнаяОтчетность.ПредставлениеВидаДокумента(ЦиклОбмена.ВидДокумента) + ") от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Заявление Тогда
		ПредставлениеЦиклаОбмена = "" + ЦиклОбмена.ВидОтчета + " за " + ПредставлениеПериода(ЦиклОбмена.ДатаНачалаПериода, КонецДня(ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина") + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Документ Тогда
		ПредставлениеЦиклаОбмена = "Опись вход. документов от НО " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ Тогда
		ПредставлениеЦиклаОбмена = "2-НДФЛ за " + ПредставлениеПериода(ЦиклОбмена.ДатаНачалаПериода, КонецДня(ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина") + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованныеДокументыНалогоплательщика Тогда
		ПредставлениеЦиклаОбмена = "Исх. док. для НО " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованныеДокументыНалоговогоОргана Тогда
		ПредставлениеЦиклаОбмена = "Вход. док. от НО " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ПисьмоНО Тогда
		ПредставлениеЦиклаОбмена = "Вход. письмо от НО " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Рассылка Тогда
		ПредставлениеЦиклаОбмена = "Вход. рассылка от НО " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.РассылкаГрупповая Тогда
		ПредставлениеЦиклаОбмена = "Вход. групповая рассылка от НО " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ЗапросыНаИнформационноеОбслуживание Тогда
		ПредставлениеЦиклаОбмена = "Запрос """ + ЦиклОбмена.ВидУслуги + """ (" + ЦиклОбмена.ФорматОтвета + ") от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьПФР Тогда
		
		Если ТипЗнч(ЦиклОбмена.ВидОтчета) = Тип("СправочникСсылка.РегламентированныеОтчеты") Тогда
			Источник = ЦиклОбмена.ВидОтчета.ИсточникОтчета;
		Иначе
			Источник = ЦиклОбмена.ВидОтчета.Источник;
		КонецЕсли;
		
		Если НачалоДня(ЦиклОбмена.ДатаНачалаПериода) = НачалоДня(ЦиклОбмена.ДатаОкончанияПериода) Тогда
			ПредставлениеЦиклаОбмена = "" + ЦиклОбмена.Предмет + ". Отправка от " + ЦиклОбмена.ДатаСоздания;
		ИначеЕсли Источник = "ПередачаСЗВ4вПФР" Тогда
			ПредставлениеЦиклаОбмена = "" + ЦиклОбмена.ВидОтчета + " и РСВ за " + ПредставлениеПериода(ЦиклОбмена.ДатаНачалаПериода, КонецДня(ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина") + " от " + ЦиклОбмена.ДатаСоздания;
		Иначе
			ПредставлениеЦиклаОбмена = "" + ЦиклОбмена.ВидОтчета + " за " + ПредставлениеПериода(ЦиклОбмена.ДатаНачалаПериода, КонецДня(ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина") + " от " + ЦиклОбмена.ДатаСоздания;
		КонецЕсли;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРИсходящие Тогда
		ПредставлениеЦиклаОбмена = "Письмо для органа ПФР " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРВходящие Тогда
		ПредставлениеЦиклаОбмена = "Письмо от органа ПФР " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИОС Тогда
		ПредставлениеЦиклаОбмена = "Запрос """ + ЦиклОбмена.ВидУслуги + """ от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИОН Тогда
		ПредставлениеЦиклаОбмена = "Запрос """ + ЦиклОбмена.ВидУслуги + """ (" + ЦиклОбмена.ФорматОтвета + ") от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьФСГС Тогда
		Если НачалоДня(ЦиклОбмена.ДатаНачалаПериода) = НачалоДня(ЦиклОбмена.ДатаОкончанияПериода) Тогда
			ПредставлениеЦиклаОбмена = "" + ЦиклОбмена.Предмет + ". Отправка от " + ЦиклОбмена.ДатаСоздания;
		Иначе
			ПредставлениеЦиклаОбмена = "" + ЦиклОбмена.ВидОтчета + " за " + ПредставлениеПериода(ЦиклОбмена.ДатаНачалаПериода, КонецДня(ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина") + " от " + ЦиклОбмена.ДатаСоздания;
		КонецЕсли;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ПисьменноеОбращениеВФСГС Тогда
		ПредставлениеЦиклаОбмена = "Письмо для Росстата " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИндивидуальноеИнформированиеФСГС Тогда
		ПредставлениеЦиклаОбмена = "Письмо от Росстата " + ЦиклОбмена.ВнешняяОрганизация + " от " + ЦиклОбмена.ДатаСоздания;
	Иначе
		ПредставлениеЦиклаОбмена = ЦиклОбмена.Ссылка;
	КонецЕсли;
	
	Возврат ПредставлениеЦиклаОбмена;
	
КонецФункции

////
//// ФУНКЦИИ ВЫГРУЗКИ АРХИВА ДОКУМЕНТООБОРОТА
//////////////////////////////////////////////////////////////////////////////////

Процедура УдалитьВременныйФайл(ИмяФайла) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ИмяФайла) Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		УдалитьФайлы(ИмяФайла);
	Исключение
	КонецПопытки;
	
КонецПроцедуры

Функция XMLЗначениеВнутр(Тип, Значение)
	
	Попытка
		Возврат XMLЗначение(Тип, Значение)
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

//////////////////////////////////////////////////////////////////////////////////

Функция ФИОИндивидуальногоПредпринимателя(Организация)
	
	ЗапросФИО = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	                         |	ФИОФизЛицСрезПоследних.Фамилия,
	                         |	ФИОФизЛицСрезПоследних.Имя,
	                         |	ФИОФизЛицСрезПоследних.Отчество
	                         |ИЗ
	                         |	РегистрСведений.ФИОФизическихЛиц.СрезПоследних(&ТекДата, ФизическоеЛицо = &ФизЛицо) КАК ФИОФизЛицСрезПоследних");
	ЗапросФИО.УстановитьПараметр("ТекДата", ТекущаяДатаСеанса());
	ЗапросФИО.УстановитьПараметр("ФизЛицо", Организация.ИндивидуальныйПредприниматель);
	Выборка = ЗапросФИО.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Новый Структура("Фамилия, Имя, Отчество", Выборка.Фамилия, Выборка.Имя, Выборка.Отчество);
	Иначе
		Возврат Новый Структура("Фамилия, Имя, Отчество", "", "", "");
	КонецЕсли;
	
КонецФункции

//////////////////////////////////////////////////////////////////////////////////
//// ОБРАБОТЧИКИ СОБЫТИЙ ОБЪЕКТОВ

Процедура ОбработкаЗаполненияОбъекта(Объект, Основание) Экспорт
	
	ИмяМетаданныхОбъекта = Объект.Метаданные().Имя;
	Если ИмяМетаданныхОбъекта = "НеформализованныйДокументНалогоплательщика" Тогда
		//ОбработкаЗаполненияНеформализованногоДокументаНалогоплательщика(Объект, Основание);
	ИначеЕсли ИмяМетаданныхОбъекта = "ТранспортноеСообщение" Тогда
		ОбработкаЗаполненияТранспортногоСообщения(Объект, Основание);
	ИначеЕсли ИмяМетаданныхОбъекта = "ПерепискаСКонтролирующимиОрганами" Тогда
		//ОбработкаЗаполненияПисьма(Объект, Основание);
	ИначеЕсли ИмяМетаданныхОбъекта = "УчетныеЗаписиДокументооборота" Тогда
		ОбработкаЗаполненияУчетнойЗаписиДокументооборота(Объект, Основание);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОписиИсходящихДокументовВНалоговыеОрганы" Тогда
		ОбработкаЗаполненияОписиИсходящихДокументов(Объект, Основание);
	ИначеЕсли ИмяМетаданныхОбъекта = "СканированныеДокументыДляПередачиВЭлектронномВиде" Тогда
		ОбработкаЗаполненияСканированногоДокумента(Объект, Основание);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаЗаполненияСканированногоДокумента(Объект, ДанныеЗаполнения)
	
	Если ДанныеЗаполнения = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(Объект, ДанныеЗаполнения);
	
КонецПроцедуры

Процедура ОбработкаЗаполненияУчетнойЗаписиДокументооборота(Объект, Основание)
	
	Если НЕ ЗначениеЗаполнено(Объект.ПортPOP3) Тогда
		Объект.ПортPOP3 = 110;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ПортSMTP) Тогда
		Объект.ПортSMTP = 25;
	КонецЕсли;
		
	Если НЕ ЗначениеЗаполнено(Объект.РежимАвтонастройки) Тогда
		Объект.РежимАвтонастройки = Перечисления.РежимыАвтонастройкиУчетнойЗаписиНалогоплательщика.Включена;
		Объект.ИспользоватьСервисОнлайнПроверкиОтчетов = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПередЗаписьюОбъекта(Объект, Отказ, РежимЗаписи = Неопределено, РежимПроведения = Неопределено, Замещение = Неопределено) Экспорт
	
	ИмяМетаданныхОбъекта = Объект.Метаданные().Имя;
	Если ИмяМетаданныхОбъекта = "ЦиклыОбмена" Тогда
		ПередЗаписьюЦиклаОбмена(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "УчетныеЗаписиДокументооборота" Тогда
		ПередЗаписьюУчетнойЗаписиНалогоплательщика(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "СерверыДокументооборота" Тогда
		ПередЗаписьюПочтовогоСервера(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ТранспортноеСообщение" Тогда
		ПередЗаписьюТранспортногоСообщения(Объект, Отказ, РежимЗаписи, РежимПроведения);
	ИначеЕсли ИмяМетаданныхОбъекта = "ПерепискаСКонтролирующимиОрганами" Тогда
		ПередЗаписьюПерепискиСКонтролирующимиОрганами(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "СканированныеДокументыДляПередачиВЭлектронномВиде" Тогда
		ПередЗаписьюСканированныеДокументыДляПередачиВЭлектронномВиде(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОписиВходящихДокументовИзНалоговыхОрганов" Тогда
		ПередЗаписьюОписиВходящихДокументов(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОписиИсходящихДокументовВНалоговыеОрганы" Тогда
		ПередЗаписьюОписиИсходящихДокументов(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ЗапросНаИнформационноеОбслуживаниеСтрахователя" Тогда
		ПередЗаписьюЗапросаНаИнформационноеОбслуживаниеСтрахователя(Объект, Отказ, РежимЗаписи, РежимПроведения);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОтправкиФСС" Тогда
		ПередЗаписьюОтправкиФСС(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОтправкиФСРАР" Тогда
		ПередЗаписьюОтправкиФСРАР(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОтправкиРПН" Тогда
		ПередЗаписьюОтправкиРПН(Объект, Отказ);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписиЦиклаОбмена(Объект, Отказ)
	
	Если Объект.ИзмененаПометкаУдаления Тогда
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(Объект.Ссылка);
		Для Каждого СообщениеЦиклаОбмена Из СообщенияЦиклаОбмена Цикл
			ОбъектСообщениеЦиклаОбмена = СообщениеЦиклаОбмена.Ссылка.ПолучитьОбъект();
			ОбъектСообщениеЦиклаОбмена.УстановитьПометкуУдаления(Объект.ПометкаУдаления);
		КонецЦикла;
		ОбновитьСтатусыСвязанногоОбъектаПриНеобходимости(Объект.Ссылка);
	КонецЕсли;
	
	Если Объект.Тип = Перечисления.ТипыЦикловОбмена.Документ Тогда 
		ОбновитьСтатусыСвязанногоОбъектаПриНеобходимости(Объект.Ссылка);
	КонецЕсли;
	
	Предмет = Объект.Предмет;
	Если ЗначениеЗаполнено(Предмет) Тогда
		ЭлектронныйДокументооборотСКонтролирующимиОрганами.ЗаписьОбъектовРегламентированнойОтчетности(Предмет, Отказ);
	КонецЕсли;	
	
КонецПроцедуры

Функция РассчитатьСтатусЦиклаОбмена(ЦиклОбмена) Экспорт
	
	ТекСтатус = Перечисления.СтатусыОтправки.ПустаяСсылка();
	Если ТипЗнч(ЦиклОбмена) = Тип("СправочникОбъект.ЦиклыОбмена") И 
		(ЦиклОбмена.ЭтоНовый() ИЛИ (ЦиклОбмена.Тип <> Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность И ЦиклОбмена.Тип <> Перечисления.ТипыЦикловОбмена.Заявление)) Тогда
		Возврат ТекСтатус;
	КонецЕсли;
	
	Если ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность Тогда
		
		Если ЦиклОбмена.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534 Тогда
			
			// получаем сообщения цикла обмена
			СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
			
			// анализируем, отправлено ли первичное
			ПервичноеСообщениеСодержащееОтчетность = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ДекларацияНП, "Тип");
			Если ПервичноеСообщениеСодержащееОтчетность <> Неопределено Тогда
				Если ПервичноеСообщениеСодержащееОтчетность.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
					ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
				Иначе
					Возврат ТекСтатус;
				КонецЕсли;
			Иначе
				Возврат ТекСтатус;
			КонецЕсли;
			
			// анализируем, получено ли подтверждение отправки
			ПодтверждениеОтправки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО, "Тип");
			Если ПодтверждениеОтправки = Неопределено Тогда
				Возврат ТекСтатус;
			КонецЕсли;
			
			// анализируем, получено ли извещение о получении декларации
			ПодтверждениеДоставки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО, "Тип");
			Если ПодтверждениеДоставки = Неопределено Тогда
				Возврат ТекСтатус;
			Иначе
				ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
			КонецЕсли;
			
			// анализируем протоколы приема
			// если их несколько, то интересует последний
			ПротоколыПриема = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО));
			ЧислоПротоколов = ПротоколыПриема.Количество();
			Если ЧислоПротоколов = 0 Тогда
				Возврат ТекСтатус;
			ИначеЕсли ЧислоПротоколов = 1 Тогда
				ПротоколПриема = ПротоколыПриема[0];
				Если ПротоколПриема.Ссылка.ПротоколСОшибкой Тогда
					Возврат Перечисления.СтатусыОтправки.НеПринят;
				КонецЕсли;
			Иначе
				
				// если протоколов несколько, то ориентируемся на наиболее свежий из них
				НаиболееПозднийПротокол = Неопределено;
				ДатаНаиболееПозднегоПротокола = '00010101';
				Для Каждого ПротоколПриема Из ПротоколыПриема Цикл
					ДатаПротоколаПриема = ПротоколПриема.Дата;
					Если ДатаПротоколаПриема = Неопределено Тогда
						ДатаПротоколаПриема = '00010101';
					КонецЕсли;
					Если ДатаПротоколаПриема >= ДатаНаиболееПозднегоПротокола Тогда
						ДатаНаиболееПозднегоПротокола = ДатаПротоколаПриема;
						НаиболееПозднийПротокол = ПротоколПриема;
					КонецЕсли;
				КонецЦикла;
				
				Если НаиболееПозднийПротокол.Ссылка.ПротоколСОшибкой Тогда
					Возврат Перечисления.СтатусыОтправки.НеПринят;
				КонецЕсли;
				
			КонецЕсли;
			
			// анализируем протоколы обработки
			// если их несколько, то анализируем последний
			ПротоколыОбработки = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО));
			ЧислоПротоколов = ПротоколыОбработки.Количество();
			Если ЧислоПротоколов = 0 Тогда
				Возврат ТекСтатус;
			ИначеЕсли ЧислоПротоколов = 1 Тогда
				ПротоколОбработки = ПротоколыОбработки[0];
				Если ПротоколОбработки.Ссылка.ПротоколСОшибкой Тогда
					Возврат Перечисления.СтатусыОтправки.НеПринят;
				КонецЕсли;
			Иначе
				
				// если протоколов несколько, то ориентируемся на наиболее свежий из них
				НаиболееПозднийПротокол = Неопределено;
				ДатаНаиболееПозднегоПротокола = '00010101';
				Для Каждого ПротоколОбработки Из ПротоколыОбработки Цикл
					ДатаПротоколаОбработки = ПротоколОбработки.Дата;
					Если ДатаПротоколаОбработки = Неопределено Тогда
						ДатаПротоколаОбработки = '00010101';
					КонецЕсли;
					Если ДатаПротоколаОбработки >= ДатаНаиболееПозднегоПротокола Тогда
						ДатаНаиболееПозднегоПротокола = ДатаПротоколаОбработки;
						НаиболееПозднийПротокол = ПротоколОбработки;
					КонецЕсли;
				КонецЦикла;
				
				Если НаиболееПозднийПротокол.Ссылка.ПротоколСОшибкой Тогда
					Возврат Перечисления.СтатусыОтправки.НеПринят;
				КонецЕсли;
				
			КонецЕсли;
			
			// если все предусмотренные регламентом сообщения отправлены/приняты
			// и они без ошибок, то отчет считается сданным
			Возврат Перечисления.СтатусыОтправки.Сдан;
			
		КонецЕсли;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Заявление Тогда
		
		
		// получаем сообщения цикла обмена
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		// анализируем, отправлено ли первичное
		ПервичноеСообщениеСодержащееОтчетность = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП, "Тип");
		Если ПервичноеСообщениеСодержащееОтчетность <> Неопределено Тогда
			Если ПервичноеСообщениеСодержащееОтчетность.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
			Иначе
				Возврат ТекСтатус;
			КонецЕсли;
		Иначе
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли подтверждение отправки
		ПодтверждениеОтправки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО, "Тип");
		Если ПодтверждениеОтправки = Неопределено Тогда
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли извещение о получении декларации
		ПодтверждениеДоставки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗаявлениеНО, "Тип");
		Если ПодтверждениеДоставки = Неопределено Тогда
			Возврат ТекСтатус;
		Иначе
			ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
		КонецЕсли;
		
		// анализируем протоколы приема
		// если их несколько, то интересует последний
		ПротоколыПриема = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО));
		ЧислоПротоколов = ПротоколыПриема.Количество();
		Если ЧислоПротоколов = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоПротоколов = 1 Тогда
			ПротоколПриема = ПротоколыПриема[0];
			Если ПротоколПриема.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийПротокол = Неопределено;
			ДатаНаиболееПозднегоПротокола = '00010101';
			Для Каждого ПротоколПриема Из ПротоколыПриема Цикл
				ДатаПротоколаПриема = ПротоколПриема.Дата;
				Если ДатаПротоколаПриема = Неопределено Тогда
					ДатаПротоколаПриема = '00010101';
				КонецЕсли;
				Если ДатаПротоколаПриема >= ДатаНаиболееПозднегоПротокола Тогда
					ДатаНаиболееПозднегоПротокола = ДатаПротоколаПриема;
					НаиболееПозднийПротокол = ПротоколПриема;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПозднийПротокол.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
			
		КонецЕсли;
		
		// анализируем протоколы обработки образца 2013
		// если их несколько, то анализируем последний
		ПротоколыОбработки = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО));
		ЧислоПротоколов = ПротоколыОбработки.Количество();
		Если ЧислоПротоколов = 0 Тогда
			//пропускаем анализ протокола обработки образца 2013, статус не возвращаем, так как возможно наличие протокола обработки старого образца
			//Возврат ТекСтатус;
		ИначеЕсли ЧислоПротоколов = 1 Тогда
			ПротоколОбработки = ПротоколыОбработки[0];
			Если ПротоколОбработки.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				Возврат Перечисления.СтатусыОтправки.Сдан;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийПротокол = Неопределено;
			ДатаНаиболееПозднегоПротокола = '00010101';
			Для Каждого ПротоколОбработки Из ПротоколыОбработки Цикл
				ДатаПротоколаОбработки = ПротоколОбработки.Дата;
				Если ДатаПротоколаОбработки = Неопределено Тогда
					ДатаПротоколаОбработки = '00010101';
				КонецЕсли;
				Если ДатаПротоколаОбработки >= ДатаНаиболееПозднегоПротокола Тогда
					ДатаНаиболееПозднегоПротокола = ДатаПротоколаОбработки;
					НаиболееПозднийПротокол = ПротоколОбработки;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПозднийПротокол.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				Возврат Перечисления.СтатусыОтправки.Сдан;
			КонецЕсли;
			
		КонецЕсли;
		
		// анализируем протоколы обработки
		// если их несколько, то анализируем последний
		ПротоколыОбработки = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО));
		ЧислоПротоколов = ПротоколыОбработки.Количество();
		Если ЧислоПротоколов = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоПротоколов = 1 Тогда
			ПротоколОбработки = ПротоколыОбработки[0];
			Если ПротоколОбработки.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				ТекСтатус = Перечисления.СтатусыОтправки.Сдан;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийПротокол = Неопределено;
			ДатаНаиболееПозднегоПротокола = '00010101';
			Для Каждого ПротоколОбработки Из ПротоколыОбработки Цикл
				ДатаПротоколаОбработки = ПротоколОбработки.Дата;
				Если ДатаПротоколаОбработки = Неопределено Тогда
					ДатаПротоколаОбработки = '00010101';
				КонецЕсли;
				Если ДатаПротоколаОбработки >= ДатаНаиболееПозднегоПротокола Тогда
					ДатаНаиболееПозднегоПротокола = ДатаПротоколаОбработки;
					НаиболееПозднийПротокол = ПротоколОбработки;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПозднийПротокол.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				ТекСтатус = Перечисления.СтатусыОтправки.Сдан;
			КонецЕсли;
			
		КонецЕсли;
		
		// анализируем наличие сообщений об отзыве и несоответствиях
		СообщениеОбОтзыве = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО, "Тип");
		РезультатОбработкиЗаявлениеТСНО = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО, "Тип");
		
		Если СообщениеОбОтзыве = Неопределено И РезультатОбработкиЗаявлениеТСНО = Неопределено Тогда
			Возврат ТекСтатус;
		Иначе
			Возврат Перечисления.СтатусыОтправки.НеПринят;
		КонецЕсли;
		
		// если все предусмотренные регламентом сообщения отправлены/приняты
		// и они без ошибок, то отчет считается сданным
		Возврат Перечисления.СтатусыОтправки.Сдан;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Документ Тогда
		
		ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
		
		// получаем сообщения цикла обмена
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		// анализируем результаты приема
		// если их несколько, то интересует последний
		РезультатыПриема = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП));
		ЧислоСообщений = РезультатыПриема.Количество();
		Если ЧислоСообщений = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоСообщений = 1 Тогда
			РезультатПриема = РезультатыПриема[0];
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийРезультат = Неопределено;
			ДатаНаиболееПозднегоРезультата = '00010101';
			Для Каждого РезультатПриема Из РезультатыПриема Цикл
				ДатаРезультатаПриема = РезультатПриема.Дата;
				Если ДатаРезультатаПриема = Неопределено Тогда
					ДатаРезультатаПриема = '00010101';
				КонецЕсли;
				Если ДатаРезультатаПриема >= ДатаНаиболееПозднегоРезультата Тогда
					ДатаНаиболееПозднегоРезультата = ДатаРезультатаПриема;
					НаиболееПозднийРезультат = РезультатПриема;
				КонецЕсли;
			КонецЦикла;
			
			РезультатПриема = НаиболееПозднийРезультат;
			
		КонецЕсли;
		
		Если РезультатПриема.Ссылка.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
			Если РезультатПриема.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе 
				Возврат Перечисления.СтатусыОтправки.Сдан;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ Тогда
		
		// получаем сообщения цикла обмена
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		// анализируем, отправлено ли первичное
		ПервичноеСообщениеСодержащееОтчетность = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП, "Тип");
		Если ПервичноеСообщениеСодержащееОтчетность <> Неопределено Тогда
			Если ПервичноеСообщениеСодержащееОтчетность.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
			Иначе
				Возврат ТекСтатус;
			КонецЕсли;
		Иначе
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли подтверждение отправки
		ПодтверждениеОтправки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО, "Тип");
		Если ПодтверждениеОтправки = Неопределено Тогда
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли извещение о получении декларации
		ПодтверждениеДоставки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО, "Тип");
		Если ПодтверждениеДоставки = Неопределено Тогда
			Возврат ТекСтатус;
		Иначе
			ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
		КонецЕсли;
		
		// анализируем протоколы приема
		// если их несколько, то интересует последний
		ПротоколыПриема = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО));
		ЧислоПротоколов = ПротоколыПриема.Количество();
		Если ЧислоПротоколов = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоПротоколов = 1 Тогда
			ПротоколПриема = ПротоколыПриема[0];
			Если ПротоколПриема.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийПротокол = Неопределено;
			ДатаНаиболееПозднегоПротокола = '00010101';
			Для Каждого ПротоколПриема Из ПротоколыПриема Цикл
				ДатаПротоколаПриема = ПротоколПриема.Дата;
				Если ДатаПротоколаПриема = Неопределено Тогда
					ДатаПротоколаПриема = '00010101';
				КонецЕсли;
				Если ДатаПротоколаПриема >= ДатаНаиболееПозднегоПротокола Тогда
					ДатаНаиболееПозднегоПротокола = ДатаПротоколаПриема;
					НаиболееПозднийПротокол = ПротоколПриема;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПозднийПротокол.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
			
		КонецЕсли;
		
		// если все предусмотренные регламентом сообщения отправлены/приняты
		// и они без ошибок, то отчет считается сданным
		Возврат Перечисления.СтатусыОтправки.Сдан;
			
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьПФР Тогда
		
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		ПервичноеСообщениеСодержащееОтчетность = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР, "Тип");
		Если ПервичноеСообщениеСодержащееОтчетность <> Неопределено Тогда
			Если ПервичноеСообщениеСодержащееОтчетность.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
			Иначе
				Возврат ТекСтатус;
			КонецЕсли;
		Иначе
			Возврат ТекСтатус;
		КонецЕсли;
		
		ПодтвержденияДоставки = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР));
		ЧислоПодтвержденийДоставки = ПодтвержденияДоставки.Количество();
		Если ЧислоПодтвержденийДоставки = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоПодтвержденийДоставки = 1 Тогда
			ПодтверждениеДоставки = ПодтвержденияДоставки[0];
			Если ПодтверждениеДоставки.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПоздниееПодтверждение = Неопределено;
			ДатаНаиболееПозднегоПодтверждения = '00010101';
			Для Каждого ПодтверждениеДоставки Из ПодтвержденияДоставки Цикл
				ДатаПодтверждения = ПодтверждениеДоставки.Дата;
				Если ДатаПодтверждения = Неопределено Тогда
					ДатаПодтверждения = '00010101';
				КонецЕсли;
				Если ДатаПодтверждения >= ДатаНаиболееПозднегоПодтверждения Тогда
					ДатаНаиболееПозднегоПодтверждения = ДатаПодтверждения;
					НаиболееПоздниееПодтверждение = ПодтверждениеДоставки;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПоздниееПодтверждение.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
			КонецЕсли;
			
		КонецЕсли;
		
		ПротоколыПроверки = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПротоколПФР));
		ЧислоПротоколов = ПротоколыПроверки.Количество();
		Если ЧислоПротоколов = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоПротоколов = 1 Тогда
			ПротоколПроверки = ПротоколыПроверки[0];
			Если ПротоколПроверки.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийПротокол = Неопределено;
			ДатаНаиболееПозднегоПротокола = '00010101';
			Для Каждого ПротоколПроверки Из ПротоколыПроверки Цикл
				ДатаПротоколаПроверки = ПротоколПроверки.Дата;
				Если ДатаПротоколаПроверки = Неопределено Тогда
					ДатаПротоколаПроверки = '00010101';
				КонецЕсли;
				Если ДатаПротоколаПроверки >= ДатаНаиболееПозднегоПротокола Тогда
					ДатаНаиболееПозднегоПротокола = ДатаПротоколаПроверки;
					НаиболееПозднийПротокол = ПротоколПроверки;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПозднийПротокол.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
			
		КонецЕсли;
		
		Возврат Перечисления.СтатусыОтправки.Сдан;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИОС Тогда
		
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		ПервичноеСообщениеСодержащееЗапрос = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР, "Тип");
		Если ПервичноеСообщениеСодержащееЗапрос <> Неопределено Тогда
			Если ПервичноеСообщениеСодержащееЗапрос.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
			Иначе
				Возврат ТекСтатус;
			КонецЕсли;
		Иначе
			Возврат ТекСтатус;
		КонецЕсли;
		
		ПодтвержденияДоставки = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР));
		ЧислоПодтвержденийДоставки = ПодтвержденияДоставки.Количество();
		Если ЧислоПодтвержденийДоставки = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоПодтвержденийДоставки = 1 Тогда
			ПодтверждениеДоставки = ПодтвержденияДоставки[0];
			Если ПодтверждениеДоставки.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПоздниееПодтверждение = Неопределено;
			ДатаНаиболееПозднегоПодтверждения = '00010101';
			Для Каждого ПодтверждениеДоставки Из ПодтвержденияДоставки Цикл
				ДатаПодтверждения = ПодтверждениеДоставки.Дата;
				Если ДатаПодтверждения = Неопределено Тогда
					ДатаПодтверждения = '00010101';
				КонецЕсли;
				Если ДатаПодтверждения >= ДатаНаиболееПозднегоПодтверждения Тогда
					ДатаНаиболееПозднегоПодтверждения = ДатаПодтверждения;
					НаиболееПоздниееПодтверждение = ПодтверждениеДоставки;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПоздниееПодтверждение.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
			КонецЕсли;
			
		КонецЕсли;
		
		ОтветыНаЗапрос = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР));
		ЧислоОтветов = ОтветыНаЗапрос.Количество();
		Если ЧислоОтветов = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоОтветов = 1 Тогда
			ОтветНаЗапрос = ОтветыНаЗапрос[0];
			Если ОтветНаЗапрос.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
		Иначе
			
			// если ответов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийОтвет = Неопределено;
			ДатаНаиболееПозднегоПротокола = '00010101';
			Для Каждого ОтветНаЗапрос Из ОтветыНаЗапрос Цикл
				ДатаПротоколаПроверки = ОтветНаЗапрос.Дата;
				Если ДатаПротоколаПроверки = Неопределено Тогда
					ДатаПротоколаПроверки = '00010101';
				КонецЕсли;
				Если ДатаПротоколаПроверки >= ДатаНаиболееПозднегоПротокола Тогда
					ДатаНаиболееПозднегоПротокола = ДатаПротоколаПроверки;
					НаиболееПозднийОтвет = ОтветНаЗапрос;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПозднийОтвет.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
			
		КонецЕсли;
		
		Возврат Перечисления.СтатусыОтправки.Сдан;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРИсходящие Тогда
		
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		ПервичноеСообщениеСодержащееПисьмо = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР, "Тип");
		Если ПервичноеСообщениеСодержащееПисьмо <> Неопределено Тогда
			Если ПервичноеСообщениеСодержащееПисьмо.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
			Иначе
				Возврат Перечисления.СтатусыОтправки.ВКонверте;
			КонецЕсли;
		Иначе
			Возврат ТекСтатус;
		КонецЕсли;
		
		ПодтверждениеДоставки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР, "Тип");
		Если ПодтверждениеДоставки = Неопределено Тогда
			Возврат ТекСтатус;
		Иначе
			ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
		КонецЕсли;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОбращениеНП Тогда
		
		// получаем сообщения цикла обмена
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		// анализируем, отправлено ли первичное
		ОбращениеНП = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ОбращениеНП, "Тип");
		Если ОбращениеНП <> Неопределено Тогда
			Если ОбращениеНП.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
			Иначе
				Возврат ТекСтатус;
			КонецЕсли;
		Иначе
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли подтверждение отправки
		ПодтверждениеОбращениеНО = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО, "Тип");
		Если ПодтверждениеОбращениеНО = Неопределено Тогда
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли извещение о получении декларации
		ИзвещениеОбращениеНО = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО, "Тип");
		Если ИзвещениеОбращениеНО = Неопределено Тогда
			Возврат ТекСтатус;
		Иначе
			ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
		КонецЕсли;
		
		// анализируем результаты приема
		// если их несколько, то интересует последний
		РезультатыПриема = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО));
		ЧислоСообщений = РезультатыПриема.Количество();
		Если ЧислоСообщений = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоСообщений = 1 Тогда
			РезультатПриема = РезультатыПриема[0];
			Если РезультатПриема.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийРезультат = Неопределено;
			ДатаНаиболееПозднегоРезультата = '00010101';
			Для Каждого РезультатПриема Из РезультатыПриема Цикл
				ДатаРезультатаПриема = РезультатПриема.Дата;
				Если ДатаРезультатаПриема = Неопределено Тогда
					ДатаРезультатаПриема = '00010101';
				КонецЕсли;
				Если ДатаРезультатаПриема >= ДатаНаиболееПозднегоРезультата Тогда
					ДатаНаиболееПозднегоРезультата = ДатаРезультатаПриема;
					НаиболееПозднийРезультат = РезультатПриема;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПозднийРезультат.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
			
		КонецЕсли;
		
		// если все предусмотренные регламентом сообщения отправлены/приняты
		// и они без ошибок, то обращение считается успешным
		Возврат Перечисления.СтатусыОтправки.Доставлен;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Представление Тогда
		
		// получаем сообщения цикла обмена
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		// анализируем, отправлено ли первичное
		ПредставлениеНП = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП, "Тип");
		Если ПредставлениеНП <> Неопределено Тогда
			Если ПредставлениеНП.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
			Иначе
				Возврат ТекСтатус;
			КонецЕсли;
		Иначе
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли подтверждение отправки
		ПодтверждениеПредставлениеНО = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО, "Тип");
		Если ПодтверждениеПредставлениеНО = Неопределено Тогда
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли извещение о получении 
		ИзвещениеПредставлениеНО = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО, "Тип");
		Если ИзвещениеПредставлениеНО = Неопределено Тогда
			Возврат ТекСтатус;
		Иначе
			ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
		КонецЕсли;
		
		// анализируем результаты приема
		// если их несколько, то интересует последний
		РезультатыПриема = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО));
		ЧислоСообщений = РезультатыПриема.Количество();
		Если ЧислоСообщений = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоСообщений = 1 Тогда
			РезультатПриема = РезультатыПриема[0];
			Если РезультатПриема.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийРезультат = Неопределено;
			ДатаНаиболееПозднегоРезультата = '00010101';
			Для Каждого РезультатПриема Из РезультатыПриема Цикл
				ДатаРезультатаПриема = РезультатПриема.Дата;
				Если ДатаРезультатаПриема = Неопределено Тогда
					ДатаРезультатаПриема = '00010101';
				КонецЕсли;
				Если ДатаРезультатаПриема >= ДатаНаиболееПозднегоРезультата Тогда
					ДатаНаиболееПозднегоРезультата = ДатаРезультатаПриема;
					НаиболееПозднийРезультат = РезультатПриема;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПозднийРезультат.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
			
		КонецЕсли;
		
		// если все предусмотренные регламентом сообщения отправлены/приняты
		// и они без ошибок, то представление считается успешным
		Возврат Перечисления.СтатусыОтправки.Сдан;

	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИОН Тогда
		
		// получаем сообщения цикла обмена
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		// анализируем, отправлено ли первичное
		ПервичноеСообщениеСодержащееЗапрос = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ЗапросНП, "Тип");
		Если ПервичноеСообщениеСодержащееЗапрос <> Неопределено Тогда
			Если ПервичноеСообщениеСодержащееЗапрос.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен; // если первичное отправлено, то статус - отправлено
			Иначе
				Возврат ТекСтатус; // если первичное не отпарвлено, то дальше не анализируем
			КонецЕсли;
		Иначе // если первичное отсутствует, то дальше не анализируем
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли подтверждение отправки
		ПодтверждениеОтправки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО, "Тип");
		Если ПодтверждениеОтправки = Неопределено Тогда
			Возврат ТекСтатус;
		КонецЕсли;
		
		// анализируем, получено ли извещение о получении запроса
		ПодтверждениеДоставки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗапросНО, "Тип");
		Если ПодтверждениеДоставки <> Неопределено Тогда
			ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
		КонецЕсли;
		
		// анализируем протоколы приема
		// если их несколько, то интересует последний
		ПротоколыПриема = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО));
		ЧислоПротоколов = ПротоколыПриема.Количество();
		Если ЧислоПротоколов = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоПротоколов = 1 Тогда
			ПротоколПриема = ПротоколыПриема[0];
			Если ПротоколПриема.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
		Иначе
			
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийПротокол = Неопределено;
			ДатаНаиболееПозднегоПротокола = '00010101';
			Для Каждого ПротоколПриема Из ПротоколыПриема Цикл
				ДатаПротоколаПриема = ПротоколПриема.Дата;
				Если ДатаПротоколаПриема = Неопределено Тогда
					ДатаПротоколаПриема = '00010101';
				КонецЕсли;
				Если ДатаПротоколаПриема >= ДатаНаиболееПозднегоПротокола Тогда
					ДатаНаиболееПозднегоПротокола = ДатаПротоколаПриема;
					НаиболееПозднийПротокол = ПротоколПриема;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПозднийПротокол.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
			
		КонецЕсли;
		
		// анализируем протоколы обработки
		// если их несколько, то анализируем последний
		ПротоколыОбработки = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО));
		ЧислоПротоколов = ПротоколыОбработки.Количество();
		Если ЧислоПротоколов = 0 Тогда
			Возврат ТекСтатус;
		Иначе
			Возврат Перечисления.СтатусыОтправки.Сдан;
		КонецЕсли;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьФСГС Тогда
		
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		ПервичноеСообщениеСодержащееОтчетность = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС, "Тип");
		Если ПервичноеСообщениеСодержащееОтчетность <> Неопределено Тогда
			Если ПервичноеСообщениеСодержащееОтчетность.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
			Иначе
				Возврат ТекСтатус;
			КонецЕсли;
		Иначе
			Возврат ТекСтатус;
		КонецЕсли;
		
		ПодтвержденияДоставки = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС));
		ЧислоПодтвержденийДоставки = ПодтвержденияДоставки.Количество();
		Если ЧислоПодтвержденийДоставки = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоПодтвержденийДоставки = 1 Тогда
			ПодтверждениеДоставки = ПодтвержденияДоставки[0];
			Если ПодтверждениеДоставки.Ссылка.ПротоколСОшибкой Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
			КонецЕсли;
		Иначе
			// если извещений несколько, то ориентируемся на наиболее свежее из них
			НаиболееПоздниееПодтверждение = Неопределено;
			ДатаНаиболееПозднегоПодтверждения = '00010101';
			Для Каждого ПодтверждениеДоставки Из ПодтвержденияДоставки Цикл
				ДатаПодтверждения = ПодтверждениеДоставки.Дата;
				Если ДатаПодтверждения = Неопределено Тогда
					ДатаПодтверждения = '00010101';
				КонецЕсли;
				Если ДатаПодтверждения >= ДатаНаиболееПозднегоПодтверждения Тогда
					ДатаНаиболееПозднегоПодтверждения = ДатаПодтверждения;
					НаиболееПоздниееПодтверждение = ПодтверждениеДоставки;
				КонецЕсли;
			КонецЦикла;
			
			Если НаиболееПоздниееПодтверждение.Ссылка.ПротоколСОшибкой Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
			КонецЕсли;
			
		КонецЕсли;
		
		ПротоколыПроверки = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС));
		ЧислоПротоколов = ПротоколыПроверки.Количество();
		Если ЧислоПротоколов = 0 Тогда
			Возврат ТекСтатус;
		ИначеЕсли ЧислоПротоколов = 1 Тогда
			ПротоколПроверки = ПротоколыПроверки[0];
			Если Не СообщениеРасшифровано(ПротоколПроверки.Ссылка) Тогда
				Возврат ТекСтатус;
			КонецЕсли;
			Если ПротоколПроверки.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				Возврат Перечисления.СтатусыОтправки.Сдан;
			КонецЕсли;
		Иначе
			// если протоколов несколько, то ориентируемся на наиболее свежий из них
			НаиболееПозднийПротокол = Неопределено;
			ДатаНаиболееПозднегоПротокола = '00010101';
			Для Каждого ПротоколПроверки Из ПротоколыПроверки Цикл
				ДатаПротоколаПроверки = ПротоколПроверки.Дата;
				Если ДатаПротоколаПроверки = Неопределено Тогда
					ДатаПротоколаПроверки = '00010101';
				КонецЕсли;
				Если ДатаПротоколаПроверки >= ДатаНаиболееПозднегоПротокола Тогда
					ДатаНаиболееПозднегоПротокола = ДатаПротоколаПроверки;
					НаиболееПозднийПротокол = ПротоколПроверки;
				КонецЕсли;
			КонецЦикла;
			
			Если Не СообщениеРасшифровано(НаиболееПозднийПротокол.Ссылка) Тогда
				Возврат ТекСтатус;
			КонецЕсли;
			Если НаиболееПозднийПротокол.Ссылка.ПротоколСОшибкой Тогда
				Возврат Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				Возврат Перечисления.СтатусыОтправки.Сдан;
			КонецЕсли;
			
		КонецЕсли;
		
		Возврат ТекСтатус;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ПисьменноеОбращениеВФСГС Тогда
		
		СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена.Ссылка);
		
		ПервичноеСообщениеСодержащееПисьмо = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС, "Тип");
		Если ПервичноеСообщениеСодержащееПисьмо <> Неопределено Тогда
			Если ПервичноеСообщениеСодержащееПисьмо.Статус = Перечисления.СтатусыПисем.Отправленное Тогда
				ТекСтатус = Перечисления.СтатусыОтправки.Отправлен;
			Иначе
				Возврат Перечисления.СтатусыОтправки.ВКонверте;
			КонецЕсли;
		Иначе
			Возврат ТекСтатус;
		КонецЕсли;
		
		ПодтверждениеДоставки = СообщенияЦиклаОбмена.Найти(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС, "Тип");
		Если ПодтверждениеДоставки = Неопределено Тогда
			Возврат ТекСтатус;
		Иначе
			ТекСтатус = Перечисления.СтатусыОтправки.Доставлен;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ТекСтатус;
	
КонецФункции

Функция РассчитатьСтатусОтправкиОбъекта(Объект, Знач ЦиклОбмена = Неопределено) Экспорт
	
	Если ЦиклОбмена = Неопределено Тогда
		ЦиклОбмена = ПолучитьПоследнийЦиклОбмена(Объект);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЦиклОбмена) Тогда
		Возврат РассчитатьСтатусЦиклаОбмена(ЦиклОбмена);
	Иначе
		Возврат Перечисления.СтатусыОтправки.ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

Процедура ОбновитьСтатусыСвязанногоОбъектаПриНеобходимости(Объект, СтрогоПоДанномуЦиклуОбмена = Ложь) Экспорт
	
	// определяем цикл обмена для расчета статуса отчета
	ТипОбъекта = ТипЗнч(Объект);
	Если ТипОбъекта = Тип("ДокументСсылка.ТранспортноеСообщение") ИЛИ ТипОбъекта = Тип("ДокументОбъект.ТранспортноеСообщение") Тогда
		ЦиклОбменаОснование = Объект.ЦиклОбмена;
	ИначеЕсли ТипОбъекта = Тип("СправочникСсылка.ЦиклыОбмена") Тогда
		ЦиклОбменаОснование = Объект;
	Иначе
		Возврат;
	КонецЕсли;
	
	ПредметыПереписки = ПолучитьПредметыЦиклаОбмена(ЦиклОбменаОснование);
	Для Каждого Предмет Из ПредметыПереписки Цикл
		Если ЗначениеЗаполнено(Предмет) И Метаданные.РегистрыСведений.СтатусыОтправки.Измерения.Объект.Тип.СодержитТип(ТипЗнч(Предмет)) Тогда
			СтатусОтчета = РассчитатьСтатусОтправкиОбъекта(Предмет, ?(СтрогоПоДанномуЦиклуОбмена, ЦиклОбменаОснование, Неопределено));
			Если СтатусОтчета <> Перечисления.СтатусыОтправки.ПустаяСсылка() Тогда
				ЗаписатьСтатусОтправкиОбъекта(Предмет, СтатусОтчета);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПриЗаписиОбъекта(Объект, Отказ, Замещение = Неопределено) Экспорт
	
	ИмяМетаданныхОбъекта = Объект.Метаданные().Имя;
	Если ИмяМетаданныхОбъекта = "ЭлектронныеПредставленияРегламентированныхОтчетов" Тогда
		ПриЗаписиЭлектронногоПредставленияРегламентированногоОтчета(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "УчетныеЗаписиДокументооборота" Тогда
		ПриЗаписиУчетнойЗаписиНалогоплательщика(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ЦиклыОбмена" Тогда
		ПриЗаписиЦиклаОбмена(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ТранспортноеСообщение" Тогда
		ПриЗаписиТранспортногоСообщения(Объект, Отказ);
	//ИначеЕсли ИмяМетаданныхОбъекта = "ПользователиУчетныхЗаписейДокументооборота" Тогда
	//	ПриЗаписиПользователяУчетнойЗаписиНалогоплательщика(Объект, Отказ, Замещение);
	//ИначеЕсли ИмяМетаданныхОбъекта = "НастройкиПользователейУчетныхЗаписейДокументооборота" Тогда
	//	ПриЗаписиНастройкиПользователяУчетнойЗаписиНалогоплательщика(Объект, Отказ, Замещение);
	ИначеЕсли ИмяМетаданныхОбъекта = "Организации" Тогда
		ПриЗаписиОрганизации(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОтправкиФСС" Тогда
		ПриЗаписиОтправкиФСС(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОтправкиФСРАР" Тогда
		ПриЗаписиОтправкиФСРАР(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОтправкиРПН" Тогда
		ПриЗаписиОтправкиРПН(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "ОписиИсходящихДокументовВНалоговыеОрганы" Тогда
		ПриЗаписиОписиИсходящихДокументовВНалоговыеОрганы(Объект, Отказ);
	ИначеЕсли ИмяМетаданныхОбъекта = "СканированныеДокументыДляПередачиВЭлектронномВиде" Тогда
		ЭлектронныйДокументооборотСКонтролирующимиОрганами.ЗаписатьСканированныйДокументВРегистрДокументыПоТребованиюФНС(Объект);
	КонецЕсли;
	
КонецПроцедуры

Функция АктуальноеПодтверждениеПолученияОтчетностиПФРЯвляетсяОтрицательным(ЦиклОбмена)
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	ТранспортноеСообщение.Ссылка,
						  |	ТранспортноеСообщение.Дата КАК Дата,
						  |	ТранспортноеСообщение.ДатаТранспорта,
						  |	ТранспортноеСообщение.ПротоколСОшибкой
						  |ИЗ
						  |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
						  |ГДЕ
						  |	ТранспортноеСообщение.ПометкаУдаления = &ПометкаУдаления
						  |	И ТранспортноеСообщение.ЦиклОбмена = &ЦиклОбмена
						  |	И ТранспортноеСообщение.Тип = &Тип
						  |
						  |УПОРЯДОЧИТЬ ПО
						  |	Дата УБЫВ");
	Запрос.УстановитьПараметр("ПометкаУдаления", Ложь);
	Запрос.УстановитьПараметр("ЦиклОбмена", ЦиклОбмена);
	Запрос.УстановитьПараметр("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ПротоколСОшибкой;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция АктуальноеПодтверждениеПолученияОтчетностиФСГСЯвляетсяОтрицательным(ЦиклОбмена)
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	ТранспортноеСообщение.Ссылка,
						  |	ТранспортноеСообщение.Дата КАК Дата,
						  |	ТранспортноеСообщение.ДатаТранспорта,
						  |	ТранспортноеСообщение.ПротоколСОшибкой
						  |ИЗ
						  |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
						  |ГДЕ
						  |	ТранспортноеСообщение.ПометкаУдаления = &ПометкаУдаления
						  |	И ТранспортноеСообщение.ЦиклОбмена = &ЦиклОбмена
						  |	И ТранспортноеСообщение.Тип = &Тип
						  |
						  |УПОРЯДОЧИТЬ ПО
						  |	Дата УБЫВ");
	Запрос.УстановитьПараметр("ПометкаУдаления", Ложь);
	Запрос.УстановитьПараметр("ЦиклОбмена", ЦиклОбмена);
	Запрос.УстановитьПараметр("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ПротоколСОшибкой;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция АктуальныйПротоколВходногоКонтроляЯвляетсяОтрицательным(ЦиклОбмена)
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	ТранспортноеСообщение.Ссылка,
						  |	ТранспортноеСообщение.Дата КАК Дата,
						  |	ТранспортноеСообщение.ДатаТранспорта,
						  |	ТранспортноеСообщение.ПротоколСОшибкой
						  |ИЗ
						  |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
						  |ГДЕ
						  |	ТранспортноеСообщение.ПометкаУдаления = &ПометкаУдаления
						  |	И ТранспортноеСообщение.ЦиклОбмена = &ЦиклОбмена
						  |	И ТранспортноеСообщение.Тип В (&Тип)
						  |
						  |УПОРЯДОЧИТЬ ПО
						  |	Дата УБЫВ");
	Запрос.УстановитьПараметр("ПометкаУдаления", Ложь);
	Запрос.УстановитьПараметр("ЦиклОбмена", ЦиклОбмена);
	
	ТипыПротоколов = Новый Массив;
	ТипыПротоколов.Добавить(Перечисления.ТипыТранспортныхСообщений.ПротоколПФР);
	ТипыПротоколов.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО);
	ТипыПротоколов.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО);
	ТипыПротоколов.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО);
	ТипыПротоколов.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО);
	ТипыПротоколов.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО);
	ТипыПротоколов.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО);
	Запрос.УстановитьПараметр("Тип", ТипыПротоколов);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ПротоколСОшибкой;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция ОбновитьСвойстваЦиклаОбмена(ЦиклОбмена, Предмет = Неопределено) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ЦиклОбмена) Тогда
		Возврат Истина;
	КонецЕсли;
	
	// получаем сообщения и отсортировываем их по дате
	СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена);
	Если СообщенияЦиклаОбмена.Количество() = 0 Тогда
		Возврат Истина;
	КонецЕсли;
	СообщенияЦиклаОбмена.Сортировать("ДатаТранспорта УБЫВ");
	
	// инициализируем объект цикла для записи
	ОбъектЦиклОбмена = ЦиклОбмена.ПолучитьОбъект();
	Если ОбъектЦиклОбмена = Неопределено Тогда // значит, цикл обмена еще не записан
		Возврат Истина;
	КонецЕсли;
	
	// устанавливаем дату транспорта последнего сообщения
	ПоследнееСообщение = СообщенияЦиклаОбмена[0];
	ДатаТранспортаПоследнегоСообщения = ПоследнееСообщение.ДатаТранспорта;
	Если ОбъектЦиклОбмена.ДатаПоследнегоСообщения <> ПоследнееСообщение.ДатаТранспорта Тогда
		ОбъектЦиклОбмена.ДатаПоследнегоСообщения = ДатаТранспортаПоследнегоСообщения;
	КонецЕсли;
	
	// устанавливаем дату закрытия цикла обмена
	Если ВсеСообщенияЦиклаОбменаОтправленыПриняты(ЦиклОбмена) Тогда
		ОбъектЦиклОбмена.ДатаЗакрытия = ДатаТранспортаПоследнегоСообщения;
	Иначе
		ОбъектЦиклОбмена.ДатаЗакрытия = ПолучитьПустуюДатуЗавершенияЦиклаОбмена();
	КонецЕсли;
	
	// устанавливаем циклу обмена идентификатор первичного сообщения при необходимости
	// только для формата документооборота, предшествующего 534
	Если ЦиклОбмена.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФНС
	И ЦиклОбмена.ФорматДокументооборота <> Перечисления.ФорматыДокументооборотаСФНС.Приказ534 Тогда
		ТипПервичного = ПолучитьТипПервичногоСообщенияПоЦиклуОбмена(ЦиклОбмена);
		Если ТипПервичного <> Неопределено Тогда
			ПервичныеСообщения = СообщенияЦиклаОбмена.НайтиСтроки(Новый Структура("Тип", ТипПервичного));
			Если ПервичныеСообщения.Количество() > 0 Тогда
				ПервичноеСообщение = ПервичныеСообщения[0];
				Если ОбъектЦиклОбмена.Идентификатор <> ПервичноеСообщение.ИдентификаторСообщения Тогда
					ОбъектЦиклОбмена.Идентификатор = ПервичноеСообщение.ИдентификаторСообщения;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// устанавливаем предмет
	Если ЗначениеЗаполнено(Предмет) Тогда
		ОбъектЦиклОбмена.Предмет = Предмет;
	КонецЕсли;
	
	// записываем, если объект изменялся
	Если ОбъектЦиклОбмена.Модифицированность() Тогда
		Попытка
			ОбъектЦиклОбмена.Записать();
		Исключение
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Не удалось обновить свойства родительского цикла обмена %1%2'"),
																						Символ(34) + ЦиклОбмена + Символ(34),
																						Символы.ПС + ИнформацияОбОшибке().Описание);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Возврат Ложь;
		КонецПопытки;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

Функция ПолучитьЭлементДаты(МассивЭлементов, ИндексЭлемента)
	
	Если МассивЭлементов.Количество() <= ИндексЭлемента Тогда
		Возврат 0;
	Иначе
		ЭлементДаты = МассивЭлементов[ИндексЭлемента];
		Если ПустаяСтрока(ЭлементДаты) ИЛИ НЕ СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(ЭлементДаты) Тогда
			Возврат 0;
		Иначе
			Возврат Число(ЭлементДаты);
		КонецЕсли;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьАтрибутыУзла(Узел) Экспорт
	
	УзлыАтрибуты = Узел.Строки.НайтиСтроки(Новый Структура("Тип", "А"));
	
	АтрибутыУзла = Новый Структура;
	Для Каждого УзелАтрибут Из УзлыАтрибуты Цикл
		АтрибутыУзла.Вставить(УзелАтрибут.Имя, УзелАтрибут.Значение);
	КонецЦикла;
	
	Возврат АтрибутыУзла;
	
КонецФункции

Функция СформироватьНаименованиеЭлектронногоПредставленияРегламентированногоОтчета(ЭлПредставление) Экспорт
	
	Если ЭлПредставление.мИмяФайла = "" ИЛИ ЭлПредставление.мИмяФайла = Неопределено Тогда
		Возврат "Для НО " + ЭлПредставление.НалоговыйОрган + " от " + ЭлПредставление.Организация;
	Иначе
		Возврат СокрЛП(ЭлПредставление.мИмяФайла) + " для НО " + ЭлПредставление.НалоговыйОрган + " от " + ЭлПредставление.Организация;
	КонецЕсли;
	
КонецФункции

//////////////////////////////////////////////////////////////////////////////////
//// ОБРАБОТЧИКИ СОБЫТИЙ ЦИКЛА ОБМЕНА

Процедура ПередЗаписьюЦиклаОбмена(Объект, Отказ)
	
	Объект.ИзмененаПометкаУдаления = (Объект.Ссылка.ПометкаУдаления <> Объект.ПометкаУдаления);
	Если Объект.ИзмененаПометкаУдаления Тогда
		Возврат;
	КонецЕсли;
	
	ШапкаОшибки = "Не удалось записать цикл обмена " + ПредставлениеЦиклаОбмена(Объект) + ":";
	
	Если НЕ ЗначениеЗаполнено(Объект.Организация) Тогда
		РегламентированнаяОтчетностьКлиентСервер.СообщитьОбОшибке("Не указана организация!", Отказ, ШапкаОшибки);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ВнешняяОрганизация) Тогда
		Если Объект.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФНС Тогда
			РегламентированнаяОтчетностьКлиентСервер.СообщитьОбОшибке("Не указан налоговый орган!", Отказ, ШапкаОшибки);
		ИначеЕсли Объект.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСПФР Тогда
			РегламентированнаяОтчетностьКлиентСервер.СообщитьОбОшибке("Не указан орган ПФР!", Отказ, ШапкаОшибки);
		ИначеЕсли Объект.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФСГС Тогда
			РегламентированнаяОтчетностьКлиентСервер.СообщитьОбОшибке("Не указан орган ФСГС!", Отказ, ШапкаОшибки);
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ Отказ Тогда
		
		Если НЕ ЗначениеЗаполнено(Объект.ДатаСоздания) Тогда
			Объект.ДатаСоздания = ТекущаяДатаСеанса();
		КонецЕсли;
		
		Если ПустаяСтрока(Объект.Наименование) Тогда
			СгенерироватьНаименованиеЦиклаОбмена(Объект);
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(Объект.ДатаЗакрытия) Тогда
			Объект.ДатаЗакрытия = ПолучитьПустуюДатуЗавершенияЦиклаОбмена();
		КонецЕсли;
		
		Если Объект.Тип = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность
		ИЛИ Объект.Тип = Перечисления.ТипыЦикловОбмена.Заявление
		ИЛИ Объект.Тип = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ Тогда
			Объект.Период = СокрЛП(Формат(Объект.ДатаОкончанияПериода, "ДФ=yyyyMMdd") + Формат('39991231' - Объект.ДатаНачалаПериода, "ДФ=yyyyMMdd"));
			Объект.ПредставлениеПериода = ПредставлениеПериода(Объект.ДатаНачалаПериода, КонецДня(Объект.ДатаОкончанияПериода), "ФП=Истина");
		ИначеЕсли Объект.Тип = Перечисления.ТипыЦикловОбмена.ЗапросыНаИнформационноеОбслуживание
		ИЛИ Объект.Тип = Перечисления.ТипыЦикловОбмена.ИОН
		ИЛИ Объект.Тип = Перечисления.ТипыЦикловОбмена.ИОС Тогда
			Объект.Период = СокрЛП(Формат(Объект.ДатаНачалаПериода, "ДФ=yyyyMMdd") + Формат(Объект.ДатаОкончанияПериода, "ДФ=yyyyMMdd"));
		ИначеЕсли Объект.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьПФР Тогда 
			Объект.Период = СокрЛП(Формат(Объект.ДатаОкончанияПериода, "ДФ=yyyyMMdd") + Формат('39991231' - Объект.ДатаНачалаПериода, "ДФ=yyyyMMdd"));
			Объект.ПредставлениеПериода = ПредставлениеПериода(Объект.ДатаНачалаПериода, КонецДня(Объект.ДатаОкончанияПериода), "ФП=Истина");
		ИначеЕсли Объект.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьФСГС Тогда 
			Объект.Период = СокрЛП(Формат(Объект.ДатаОкончанияПериода, "ДФ=yyyyMMdd") + Формат('39991231' - Объект.ДатаНачалаПериода, "ДФ=yyyyMMdd"));
			Объект.ПредставлениеПериода = ПредставлениеПериода(Объект.ДатаНачалаПериода, КонецДня(Объект.ДатаОкончанияПериода), "ФП=Истина");
		КонецЕсли;
		
		// Для закладки ФНС - Отчетность формы Управление обменом
		Если Объект.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФНС
			И Объект.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534
			И (Объект.Тип = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность
			ИЛИ Объект.Тип = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ) Тогда 
				Объект.ПредставлениеВидаДокумента = РегламентированнаяОтчетность.ПредставлениеВидаДокумента(Объект.ВидДокумента);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура СгенерироватьНаименованиеЦиклаОбмена(ЦиклОбмена)
	
	Если ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность
	ИЛИ ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Заявление
	ИЛИ ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ Тогда
		ЦиклОбмена.Наименование = ПолучитьИмяФайлаДИВЦиклаОбмена(ЦиклОбмена);
		Если ЗначениеЗаполнено(ЦиклОбмена.ВнешняяОрганизация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " для НО " + ЦиклОбмена.ВнешняяОрганизация;
		КонецЕсли;
		Если ЗначениеЗаполнено(ЦиклОбмена.Организация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " от " + ЦиклОбмена.Организация;
		КонецЕсли;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованныеДокументыНалогоплательщика Тогда
		ЦиклОбмена.Наименование = ПолучитьИмяФайлаДИВЦиклаОбмена(ЦиклОбмена);
		Если ЗначениеЗаполнено(ЦиклОбмена.ВнешняяОрганизация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " для НО " + ЦиклОбмена.ВнешняяОрганизация;
		КонецЕсли;
		Если ЗначениеЗаполнено(ЦиклОбмена.Организация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " от " + ЦиклОбмена.Организация;
		КонецЕсли;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ЗапросыНаИнформационноеОбслуживание Тогда
		ЦиклОбмена.Наименование = ПолучитьИмяФайлаДИВЦиклаОбмена(ЦиклОбмена);
		Если ЗначениеЗаполнено(ЦиклОбмена.ВнешняяОрганизация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " для НО " + ЦиклОбмена.ВнешняяОрганизация;
		КонецЕсли;
		Если ЗначениеЗаполнено(ЦиклОбмена.Организация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " от " + ЦиклОбмена.Организация;
		КонецЕсли;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованныеДокументыНалоговогоОргана Тогда
		ЦиклОбмена.Наименование = "От НО " + ЦиклОбмена.ВнешняяОрганизация;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ПисьмоНО Тогда
		ЦиклОбмена.Наименование = ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена);
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Рассылка Тогда
		ЦиклОбмена.Наименование = ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена);
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Документ Тогда
		ЦиклОбмена.Наименование = "От НО " + ЦиклОбмена.ВнешняяОрганизация;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.РассылкаГрупповая Тогда
		ЦиклОбмена.Наименование = ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена);
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьПФР Тогда
		
		Если ТипЗнч(ЦиклОбмена.ВидОтчета) = Тип("СправочникСсылка.РегламентированныеОтчеты") Тогда
			Источник = ЦиклОбмена.ВидОтчета.ИсточникОтчета;
		Иначе
			Источник = ЦиклОбмена.ВидОтчета.Источник;
		КонецЕсли;
		
		Если НачалоДня(ЦиклОбмена.ДатаНачалаПериода) = НачалоДня(ЦиклОбмена.ДатаОкончанияПериода) Тогда
			ЦиклОбмена.Наименование = "" + ЦиклОбмена.Предмет + ". Отправка от " + ЦиклОбмена.ДатаСоздания;
		ИначеЕсли Источник = "ПередачаСЗВ4вПФР" Тогда
			ЦиклОбмена.Наименование = "" + ЦиклОбмена.ВидОтчета + " и РСВ за " + ПредставлениеПериода(ЦиклОбмена.ДатаНачалаПериода, КонецДня(ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина") + " от " + ЦиклОбмена.ДатаСоздания;
		Иначе
			ЦиклОбмена.Наименование = "" + ЦиклОбмена.ВидОтчета + " за " + ПредставлениеПериода(ЦиклОбмена.ДатаНачалаПериода, КонецДня(ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина") + " от " + ЦиклОбмена.ДатаСоздания;
		КонецЕсли;
		
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИОС Тогда
		ЦиклОбмена.Наименование = СокрЛП(ЦиклОбмена.Предмет) + " для " + СокрЛП(ЦиклОбмена.ВнешняяОрганизация) + " от " + СокрЛП(ЦиклОбмена.Организация);
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРВходящие Тогда
		ЦиклОбмена.Наименование = ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена);
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРИсходящие Тогда
		ЦиклОбмена.Наименование = ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена);
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОбращениеНП Тогда
		ЦиклОбмена.Наименование = ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена);
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Представление Тогда
		ЦиклОбмена.Наименование = "Представление документов";
		Если ЗначениеЗаполнено(ЦиклОбмена.ВнешняяОрганизация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " для НО " + ЦиклОбмена.ВнешняяОрганизация;
		КонецЕсли;
		Если ЗначениеЗаполнено(ЦиклОбмена.Организация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " от " + ЦиклОбмена.Организация;
		КонецЕсли;	
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИОН Тогда
		ЦиклОбмена.Наименование = ПолучитьИмяФайлаДИВЦиклаОбмена(ЦиклОбмена);
		Если ЗначениеЗаполнено(ЦиклОбмена.ВнешняяОрганизация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " для НО " + ЦиклОбмена.ВнешняяОрганизация;
		КонецЕсли;
		Если ЗначениеЗаполнено(ЦиклОбмена.Организация) Тогда
			ЦиклОбмена.Наименование = ЦиклОбмена.Наименование + " от " + ЦиклОбмена.Организация;
		КонецЕсли;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОтчетностьФСГС Тогда
		Если ТипЗнч(ЦиклОбмена.Предмет) = Тип("ДокументСсылка.РегламентированныйОтчет") Тогда
			ЦиклОбмена.Наименование = РегламентированнаяОтчетностьКлиентСервер.ПредставлениеДокументаРеглОтч(ЦиклОбмена.Предмет) + " для " + СокрЛП(ЦиклОбмена.ВнешняяОрганизация);
		Иначе
			ЦиклОбмена.Наименование = СокрЛП(ЦиклОбмена.Предмет) + " для " + СокрЛП(ЦиклОбмена.ВнешняяОрганизация) + " от " + СокрЛП(ЦиклОбмена.Организация);
		КонецЕсли;
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ИндивидуальноеИнформированиеФСГС Тогда
		ЦиклОбмена.Наименование = ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена);
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ПисьменноеОбращениеВФСГС Тогда
		ЦиклОбмена.Наименование = ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена);
	ИначеЕсли ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.РассылкаФСГС Тогда
		ЦиклОбмена.Наименование = ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена);
	КонецЕсли;
	
КонецПроцедуры

Функция ТемаПисьмаПоЦиклуОбмена(ЦиклОбмена)
	
	Если ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРИсходящие
	ИЛИ ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ОбращениеНП
	ИЛИ ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.ПисьменноеОбращениеВФСГС Тогда
		Возврат """" + СокрЛП(ЦиклОбмена.Предмет.Наименование) + """ для " + ЦиклОбмена.ВнешняяОрганизация;
	КонецЕсли;
	
	// получаем исходное сообщение
	Если ТипЗнч(ЦиклОбмена) = Тип("СправочникСсылка.ЦиклыОбмена") Тогда
		СсылкаНаЦиклОбмена = ЦиклОбмена;
	Иначе
		СсылкаНаЦиклОбмена = ?(ЦиклОбмена.ЭтоНовый(), ЦиклОбмена.ПолучитьСсылкуНового(), ЦиклОбмена.Ссылка);
	КонецЕсли;
	ТипПервичногоСообщения = ПолучитьТипПервичногоСообщенияПоЦиклуОбмена(ЦиклОбмена);
	
	ПисьмоВходящее = ПолучитьСообщениеЦиклаОбмена(СсылкаНаЦиклОбмена, ТипПервичногоСообщения);
	Если НЕ ЗначениеЗаполнено(ПисьмоВходящее) Тогда
		Возврат "";
	КонецЕсли;
	
	// извлекаем вложения расшифрованного входящего сообщения
	Если ТипПервичногоСообщения = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР Тогда
		ТипСодержимогоОписаниеПисьма = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ОписаниеПисьма;
	ИначеЕсли ТипПервичногоСообщения = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС
		  ИЛИ ТипПервичногоСообщения = Перечисления.ТипыТранспортныхСообщений.РассылкаФСГС Тогда
		ТипСодержимогоОписаниеПисьма = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ОписаниеПисьмаФСГС;
	Иначе
		ТипСодержимогоОписаниеПисьма = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ОписаниеСведенийОбращениеПисьмоРассылка;
	КонецЕсли;
	
	ВложенияОписанияКПисьму = ПолучитьВложенияТранспортногоСообщения(ПисьмоВходящее, Истина, ТипСодержимогоОписаниеПисьма);
	Если ВложенияОписанияКПисьму.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	ВложенияОписаниеКПисьму = ВложенияОписанияКПисьму[0];
	
	// загружаем описание к письму
	ВремФайлОписаниеКПисьму = ПолучитьИмяВременногоФайла();
	ВложенияОписаниеКПисьму.Данные.Получить().Записать(ВремФайлОписаниеКПисьму);
	ДеревоОписанияКПисьму = ЗагрузитьXMLВДеревоЗначений(ВремФайлОписаниеКПисьму);
	УдалитьВременныйФайл(ВремФайлОписаниеКПисьму);
	Если ДеревоОписанияКПисьму = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	УзелТема = ДеревоОписанияКПисьму.Строки.Найти("тема", "Имя", Истина);
	Если УзелТема = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	Тема = XMLЗначениеВнутр(Тип("Строка"), УзелТема.Значение);
	
	Возврат """" + Тема + """ от " + ЦиклОбмена.ВнешняяОрганизация;
	
КонецФункции

//////////////////////////////////////////////////////////////////////////////////
//// ОБРАБОТЧИКИ СОБЫТИЙ ТРАНСПОРТНОГО СООБЩЕНИЯ

Процедура ПриЗаписиТранспортногоСообщения(Объект, Отказ)
	
	Если НЕ ОбновитьСвойстваЦиклаОбмена(Объект.ЦиклОбмена) Тогда
		Отказ = Истина;
	КонецЕсли;
	
	УстановитьИндексУчетнойЗаписи(Объект);
	
	// Обновляем статус в регистре ЖурналОтправокВКонтролирующиеОрганы
	ЦиклОбмена = Объект.ЦиклОбмена;
	Если НЕ ЗначениеЗаполнено(ЦиклОбмена) Тогда
		Возврат;
	КонецЕсли;

	Предмет = ЦиклОбмена.Предмет;
	Если НЕ ЗначениеЗаполнено(Предмет) Тогда 
		Возврат;
	КонецЕсли;
	
	ЭлектронныйДокументооборотСКонтролирующимиОрганами.ЗаписьОбъектовРегламентированнойОтчетности(Предмет, Отказ);
	
КонецПроцедуры

Процедура ПередЗаписьюТранспортногоСообщения(Объект, Отказ, РежимЗаписи, РежимПроведения)
	
	Если НЕ ЗначениеЗаполнено(Объект.Дата) Тогда
		Объект.Дата = ТекущаяДатаСеанса();
	КонецЕсли;
	
	Если Объект.Статус = Перечисления.СтатусыПисем.ПустаяСсылка() Тогда
		Объект.Статус = Перечисления.СтатусыПисем.Сохраненное;
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаЗаполненияТранспортногоСообщения(Объект, СообщениеОснование) Экспорт
	Перем ИмяФайлаЭЦП;
	Перем ДанныеЭЦП;
	Перем ИмяФайлаСертификата;
	Перем ДанныеСертификата;
	Перем РазмерФайлаСертификата;
	Перем РазмерФайлаЭЦП;
	Перем ЭЦПИмяПодписанногоФайла;
	Перем ЭЦПСертификат;
	Перем ЭЦПСтатусПроверки;
	
	Если ТипЗнч(СообщениеОснование) <> Тип("ДокументСсылка.ТранспортноеСообщение") Тогда
		Объект.ОшибкаЗаполнения = Истина;
		Возврат;
	КонецЕсли;
		
	Если НЕ СообщениеРасшифровано(СообщениеОснование) Тогда
		Объект.ОшибкаЗаполнения = Истина;
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(СообщениеОснование.ЦиклОбмена) Тогда
		Объект.ОшибкаЗаполнения = Истина;
		Возврат;
	КонецЕсли;
	
	Если СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколПФР Тогда
		//формируем подтверждение на протокол ПФР
		
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.ЦиклОбмена.ВнешняяОрганизация;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ReSign: Pension-Protocol";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР Тогда
		//формируем подтверждение на протокол ПФР
		
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.ЦиклОбмена.ВнешняяОрганизация;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ReSign: Pension-Reply";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР Тогда
		// формируем подтверждение на входящее неформализованное от ПФР
		
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.ЦиклОбмена.ВнешняяОрганизация;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ReSign: Pension-Unformal";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО 
	ИЛИ СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО Тогда
		// формируем подтверждение на подтверждение даты отправки
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.УчетнаяЗапись.СерверДокументооборота;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеПодтверждениеНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																							Символ(34) + Объект.Тип + Символ(34),
																							Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО Тогда
		// формируем подтверждение на подтверждение даты отправки
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.УчетнаяЗапись.СерверДокументооборота;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеПодтверждениеНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО Тогда
		// формируем подтверждение на подтверждение даты отправки
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.УчетнаяЗапись.СерверДокументооборота;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеПодтверждениеНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО Тогда
		// формируем подтверждение на подтверждение даты отправки
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.УчетнаяЗапись.СерверДокументооборота;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеПодтверждениеНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО Тогда
		// формируем подтверждение на подтверждение даты отправки
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.УчетнаяЗапись.СерверДокументооборота;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеПодтверждениеНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО 
	ИЛИ СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО Тогда
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатПриемаНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО Тогда
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатПриемаНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО Тогда
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатПриемаНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																							Символ(34) + Объект.Тип + Символ(34),
																							Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО Тогда
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатПриемаНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																							Символ(34) + Объект.Тип + Символ(34),
																							Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();

	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО Тогда
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
			Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатПриемаНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
			Символ(34) + Объект.Тип + Символ(34),
			Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО Тогда
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
			Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатОбработкиНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
			Символ(34) + Объект.Тип + Символ(34),
			Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО Тогда
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
			Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатОбработкиНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
			Символ(34) + Объект.Тип + Символ(34),
			Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО Тогда
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
			Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатОбработкиРФНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
			Символ(34) + Объект.Тип + Символ(34),
			Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО Тогда
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
			Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеОбОтзывеЗаявлениеРФНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
			Символ(34) + Объект.Тип + Символ(34),
			Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО Тогда
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
			Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатОбработкиТСНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
			Символ(34) + Объект.Тип + Символ(34),
			Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО Тогда
		// формируем подтверждение на подтверждение даты отправки
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
			Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатОбработкиНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
			Символ(34) + Объект.Тип + Символ(34),
			Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоНО Тогда
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
			Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеПисьмоНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
			Символ(34) + Объект.Тип + Символ(34),
			Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.РассылкаНО Тогда
		
		Если Объект.ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Рассылка Тогда // формируем ответ только на групповую рассылку
			Возврат;
		КонецЕсли;
		
		// если существуют непомеченные на удаление подтверждения
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
			Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРассылкаНП";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
			Символ(34) + Объект.Тип + Символ(34),
			Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ДокументНО Тогда
		
		Если Объект.Тема = "ФНС:1.0-квитанцияОПриеме-РезультатПриемаДокументНП" 
		 ИЛИ Объект.Тема = "ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаДокументНП" Тогда
		    ПоложительныйРезультатПриема = (Объект.Тема = "ФНС:1.0-квитанцияОПриеме-РезультатПриемаДокументНП");
			// заполнение результата приема
			Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП).Количество() > 0 Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Результат приема транспортного сообщения %1 уже существует.'"),
				Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				Объект.ОшибкаЗаполнения = Истина;
				Возврат;
			КонецЕсли;
			
			Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП;
			Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
			Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
			Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
			Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
			Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
			Объект.Основание = СообщениеОснование;
			Если НЕ ПоложительныйРезультатПриема Тогда
				Объект.ПротоколСОшибкой = Истина;
			КонецЕсли;
			
			НачатьТранзакцию();
			
			// пишем текущее сообщение, чтобы было к чему добавлять вложения
			Попытка
				Объект.Записать();
			Исключение
				ОтменитьТранзакцию();
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
				Символ(34) + Объект.Тип + Символ(34),
				Символ(34) + Объект.ЦиклОбмена + Символ(34));
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				Объект.ОшибкаЗаполнения = Истина;
				Возврат;
			КонецПопытки;
			
			Объект.ОшибкаЗаполнения = Ложь;
			ЗафиксироватьТранзакцию();
			
		Иначе
			
			Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП).Количество() > 0 Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
				Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				Объект.ОшибкаЗаполнения = Истина;
				Возврат;
			КонецЕсли;
			
			Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП;
			Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
			Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
			Объект.Получатель = ?(НЕ СообщениеОснование.УчетнаяЗапись.ОбменНапрямую, СообщениеОснование.УчетнаяЗапись.СерверДокументооборота, СообщениеОснование.УчетнаяЗапись.НалоговыйОрган);
			Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
			Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
			Объект.Основание = СообщениеОснование;
			Объект.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеДокументНП";
			
			НачатьТранзакцию();
			
			// пишем текущее сообщение, чтобы было к чему добавлять вложения
			Попытка
				Объект.Записать();
			Исключение
				ОтменитьТранзакцию();
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
				Символ(34) + Объект.Тип + Символ(34),
				Символ(34) + Объект.ЦиклОбмена + Символ(34));
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				Объект.ОшибкаЗаполнения = Истина;
				Возврат;
			КонецПопытки;
			
			Объект.ОшибкаЗаполнения = Ложь;
			ЗафиксироватьТранзакцию();
			
		КонецЕсли;
		
	// Росстат
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС Тогда
		//формируем квитанцию на подтверждение даты отправки ФСГС
		
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.ЦиклОбмена.ВнешняяОрганизация;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ReSign: Stat-Confirmation";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();

	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС Тогда
		//формируем подтверждение на протокол ФСГС
		
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.ЦиклОбмена.ВнешняяОрганизация;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ReSign: Stat-Protocol";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	ИначеЕсли СообщениеОснование.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС Тогда
		// формируем подтверждение на входящее неформализованное от ФСГС
		
		Если ПолучитьСообщенияВведенныеНаОсновании(СообщениеОснование, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС).Количество() > 0 Тогда
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Подтверждение на транспортное сообщение %1 уже существует.'"),
																						Символ(34) + ПредставлениеТранспортногоСообщения(СообщениеОснование) + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецЕсли;
		
		Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС;
		Объект.ЦиклОбмена = СообщениеОснование.ЦиклОбмена;
		Объект.Отправитель = СообщениеОснование.ЦиклОбмена.Организация;
		Объект.Получатель = СообщениеОснование.ЦиклОбмена.ВнешняяОрганизация;
		Объект.УчетнаяЗапись = СообщениеОснование.УчетнаяЗапись;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Основание = СообщениеОснование;
		Объект.Тема = "ReSign: Stat-Unformal";
		
		НачатьТранзакцию();
		
		// пишем текущее сообщение, чтобы было к чему добавлять вложения
		Попытка
			Объект.Записать();
		Исключение
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Ошибка записи сообщения %1 цикла обмена %2!'"),
																						Символ(34) + Объект.Тип + Символ(34),
																						Символ(34) + Объект.ЦиклОбмена + Символ(34));
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Объект.ОшибкаЗаполнения = Истина;
			Возврат;
		КонецПопытки;
		
		Объект.ОшибкаЗаполнения = Ложь;
		ЗафиксироватьТранзакцию();
		
	КонецЕсли;
	
КонецПроцедуры

// перенесена в контейнер
Функция ОбработатьСодержаниеОснования(Содержание)
	
	Результат = "";
	Для Инд = 1 По СтрЧислоСтрок(Содержание) Цикл
		Результат = Результат + "> " + СтрПолучитьСтроку(Содержание, Инд);
	КонецЦикла;
	Возврат Результат;
	
КонецФункции

//////////////////////////////////////////////////////////////////////////////////
//// ОБРАБОТЧИКИ СОБЫТИЙ СПРАВОЧНИКА ПЕРЕПИСКАСКОНТРОЛИРУЮЩИМИОРГАНАМИ


Процедура ПередЗаписьюПерепискиСКонтролирующимиОрганами(Объект, Отказ)

	Если Объект.ЭтоНовый() Тогда // именно без проверки заполнения Идентификатора, т.к. возможна запись скопированного
		Если Объект.Статус <> Перечисления.СтатусыПисем.Полученное ИЛИ НЕ ЗначениеЗаполнено(Объект.Идентификатор) Тогда
 			Объект.Идентификатор = СгенерироватьUUID();
		КонецЕсли;
	КонецЕсли;
	
	ТипОрганизации = Тип("СправочникСсылка.Организации");
	Если ТипЗнч(Объект.Отправитель) = ТипОрганизации Тогда
		Объект.Организация = Объект.Отправитель;
	ИначеЕсли ТипЗнч(Объект.Получатель) = ТипОрганизации Тогда
		Объект.Организация = Объект.Получатель;
	Иначе
		Объект.Организация = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

Функция  ОбработкаЗаполненияПисьма(Объект, Основание, НастройкиОтвета)
	
	ЭтоРетроконверсия = (НастройкиОтвета <> Неопределено);
	// если это ретроконверсия, то обработка особая
	Если ЭтоРетроконверсия Тогда
		
		ВариантПодтверждения = НастройкиОтвета.ВариантПодтверждения;
		ПодтвержденныеФайлыСведений = НастройкиОтвета.ФайлыСведений;
		
		// заполняем свойства (кроме вложений)
		Объект.Наименование = "Re:" + СокрЛП(Основание.Наименование); // требование приемного ПО Калуга-Астрал
		Объект.Тип = Основание.Тип;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Отправитель = Основание.Получатель;
		Объект.Получатель = Основание.Отправитель;
		Объект.ДатаСообщения = ТекущаяДатаСеанса();
		Объект.ИдентификаторОснования = Основание.Идентификатор;
		Объект.Ретроконверсия = Основание.Ретроконверсия;
		
		ОбработанноеСодержимоеОснования = ОбработатьСодержаниеОснования(Основание.Содержание);
		Если ВариантПодтверждения = 2 Тогда // отклонение сведений
			Объект.Содержание = "Сведения содержат ошибки." + Символы.ПС + Символы.ПС + ОбработанноеСодержимоеОснования;
		Иначе
			
			Если ВариантПодтверждения = 3 Тогда // частичное подтверждение
				Объект.Содержание = "Сведения подтверждены лишь частично." + Символы.ПС + Символы.ПС + ОбработанноеСодержимоеОснования;
			Иначе
				Объект.Содержание = "Сведения верны." + Символы.ПС + Символы.ПС + ОбработанноеСодержимоеОснования;
			КонецЕсли;
			
			Вложения = ПолучитьВложенияНеформализованногоДокумента(Основание, , Истина);
			
			НачатьТранзакцию();
			
			Попытка
				Объект.Записать();
			Исключение
				ОтменитьТранзакцию();
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Не удалось создать ответ:%1'"),
																							Символы.ПС + ИнформацияОбОшибке().Описание);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				Возврат Неопределено;
			КонецПопытки;
			
			// копируем вложения
			Для Каждого Вложение Из Вложения Цикл
				Если ПодтвержденныеФайлыСведений.Найти(Вложение.ИмяФайла) <> Неопределено Тогда
					Если НЕ ДобавитьВложенияПисьма(Объект.Ссылка, Вложение.ИмяФайла, Вложение.Данные, Вложение.Тип, Вложение.Размер) Тогда
						ОтменитьТранзакцию();
						Возврат Неопределено;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			
			ЗафиксироватьТранзакцию();
			
		КонецЕсли;
		
		Возврат Объект;
		
	Иначе
	
		// получаем вложения и, при необходимости, задаем уточняющий вопрос
		Вложения = ПолучитьВложенияНеформализованногоДокумента(Основание.Ссылка, , Истина);
		
		// заполняем свойства (кроме вложений)
		Объект.Наименование = "Ответ на: " + СокрЛП(Основание.Наименование);
		Объект.Тип = Основание.Тип;
		Объект.Статус = Перечисления.СтатусыПисем.Исходящее;
		Объект.Отправитель = Основание.Получатель;
		Объект.Получатель = Основание.Отправитель;
		Объект.Содержание = Символы.ПС + Символы.ПС + ОбработатьСодержаниеОснования(Основание.Содержание);
		Объект.ДатаСообщения = ТекущаяДатаСеанса();
		Объект.ИдентификаторОснования = Основание.Идентификатор;
		Объект.Ретроконверсия = Основание.Ретроконверсия;
		
		// записываем, если необходимо скопировать вложения
		Если Вложения.Количество() > 0 Тогда
			
			// открываем транзакцию
			НачатьТранзакцию();
			
			Попытка
				Объект.Записать();
			Исключение
				ОтменитьТранзакцию();
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Не удалось создать ответ:%1'"),
																							Символы.ПС + ИнформацияОбОшибке().Описание);
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
				Возврат Неопределено;
			КонецПопытки;
			
			// копируем вложения
			Для Каждого Вложение Из Вложения Цикл
				Если НЕ ДобавитьВложенияПисьма(Объект.Ссылка, Вложение.ИмяФайла, Вложение.Данные, Вложение.Тип, Вложение.Размер) Тогда
					ОтменитьТранзакцию();
					Возврат Неопределено;
				КонецЕсли;
			КонецЦикла;
			
			ЗафиксироватьТранзакцию();
			
		КонецЕсли;
		
		Возврат Объект;
		
	КонецЕсли;
	
КонецФункции

//////////////////////////////////////////////////////////////////////////////////

Функция ПолучитьСвойстваМодуляДокументооборота() Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	                      |	Константы.ДокументооборотСКонтролирующимиОрганами_ИспользоватьВнешнийМодуль,
	                      |	Константы.ДокументооборотСКонтролирующимиОрганами_ВнешнийМодуль
	                      |ИЗ
	                      |	Константы КАК Константы");
	
	Попытка
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		Возврат Новый Структура("ИспользоватьВнешнийМодуль, ВнешнийМодуль", Выборка.ДокументооборотСКонтролирующимиОрганами_ИспользоватьВнешнийМодуль, Выборка.ДокументооборотСКонтролирующимиОрганами_ВнешнийМодуль);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

Функция ИзменениеСвойствМодуляДокументооборотаВозможно() Экспорт
	
	Возврат		ПравоДоступа("Изменение", Метаданные.Константы.ДокументооборотСКонтролирующимиОрганами_ИспользоватьВнешнийМодуль)
			И	ПравоДоступа("Изменение", Метаданные.Константы.ДокументооборотСКонтролирующимиОрганами_ВнешнийМодуль);
	
КонецФункции

Функция ПолучитьВерсиюИзФайлаВнешнегоМодуля(ФайлВнешнегоМодуля)
	
	Попытка
		ОбъектОтчет = ВнешниеОбработки.Создать(ФайлВнешнегоМодуля);
		Возврат ОбъектОтчет.мВерсияМодуля;
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

Функция ПрименитьСвойстваМодуляДокументооборота(ИспользоватьВнешнийМодуль = Неопределено, ВнешнийМодуль = Неопределено, ОписаниеОшибки = Неопределено) Экспорт
	
	// определяем, какие константы будут меняться
	МодифицируемыеКонстанты = Новый Массив;
	
	// подготавливаем двоичные данные внешнего модуля
	Если ВнешнийМодуль <> Неопределено Тогда
		
		МодифицируемыеКонстанты.Добавить("ДокументооборотСКонтролирующимиОрганами_ВерсияВнешнегоМодуля");
		МодифицируемыеКонстанты.Добавить("ДокументооборотСКонтролирующимиОрганами_ВнешнийМодуль");
		
		ТипЗнчВнешнийМодуль = ТипЗнч(ВнешнийМодуль);
		Если ТипЗнчВнешнийМодуль = Тип("Строка") Тогда
			ОбъектВнешнийМодуль = Новый ХранилищеЗначения(Новый ДвоичныеДанные(ВнешнийМодуль));
			ФайлВнешнегоМодуля = ВнешнийМодуль;
		Иначе
			ФайлВнешнегоМодуля = ПолучитьИмяВременногоФайла();
			Если ТипЗнчВнешнийМодуль = Тип("ДвоичныеДанные") Тогда
				ОбъектВнешнийМодуль = Новый ХранилищеЗначения(ВнешнийМодуль);
			ИначеЕсли ТипЗнчВнешнийМодуль = Тип("ХранилищеЗначения") Тогда
				ОбъектВнешнийМодуль = ВнешнийМодуль;
			КонецЕсли;
			ОбъектВнешнийМодуль.Получить().Записать(ФайлВнешнегоМодуля);
		КонецЕсли;
		
		ВерсияВнешнегоМодуля = ПолучитьВерсиюИзФайлаВнешнегоМодуля(ФайлВнешнегоМодуля);
		Если НЕ ЗначениеЗаполнено(ВерсияВнешнегоМодуля) Тогда
			ОписаниеОшибки = "Некорректный формат внешнего модуля: не удалось извлечь версию.";
			Возврат Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	Если ИспользоватьВнешнийМодуль <> Неопределено Тогда
		МодифицируемыеКонстанты.Добавить("ДокументооборотСКонтролирующимиОрганами_ИспользоватьВнешнийМодуль");
	КонецЕсли;
	
	КоличествоМодифицируемыхКонстант = МодифицируемыеКонстанты.Количество();
	Если КоличествоМодифицируемыхКонстант = 0 Тогда
		Возврат Истина;
	ИначеЕсли КоличествоМодифицируемыхКонстант = 1 Тогда
		СтрМодифицируемыеКонстанты = МодифицируемыеКонстанты[0];
	ИначеЕсли КоличествоМодифицируемыхКонстант > 1 Тогда
		СтрМодифицируемыеКонстанты = МодифицируемыеКонстанты[0] + ", " + МодифицируемыеКонстанты[1] + ", " + МодифицируемыеКонстанты[2];
	КонецЕсли;
	
	// инициализируем значения констант
	Попытка
		КонстантыНабор = Константы.СоздатьНабор(СтрМодифицируемыеКонстанты);
		Если ИспользоватьВнешнийМодуль <> Неопределено Тогда
			КонстантыНабор.ДокументооборотСКонтролирующимиОрганами_ИспользоватьВнешнийМодуль = ИспользоватьВнешнийМодуль;
		КонецЕсли;
		Если ВнешнийМодуль <> Неопределено Тогда
			КонстантыНабор.ДокументооборотСКонтролирующимиОрганами_ВнешнийМодуль = ОбъектВнешнийМодуль;
			КонстантыНабор.ДокументооборотСКонтролирующимиОрганами_ВерсияВнешнегоМодуля = ВерсияВнешнегоМодуля;
		КонецЕсли;
		КонстантыНабор.Записать();
		Возврат Истина;
	Исключение
		ОписаниеОшибки = ИнформацияОбОшибке().Описание;
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

Функция ЗагрузитьXMLВДеревоЗначений(ИмяФайлаXML = Неопределено, ТекстXML = Неопределено, ОписаниеОшибки = Неопределено) Экспорт
	
	// считываем текст из файла
	Если НЕ ЗначениеЗаполнено(ТекстXML) Тогда
		ТекстXML = ПрочитатьТекстИзФайла(ИмяФайлаXML, , Истина);
		Если НЕ ЗначениеЗаполнено(ТекстXML) Тогда
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	
	// восстанавливаем дерево
	Возврат ЗагрузитьСтрокуXMLВДеревоЗначений(ТекстXML, ОписаниеОшибки);
	
КонецФункции

Функция ПрочитатьBase64ИзФайла(ИмяФайла)
	
	СтрокаРезультат = Base64Строка(Новый ДвоичныеДанные(ИмяФайла));
	СтрокаЗамены = Символ(13) + Символ(10);
	СтрокаРезультат = СтрЗаменить(СтрокаРезультат, СтрокаЗамены, "");
	Возврат СтрокаРезультат;
	
КонецФункции

Функция СгенерироватьUUID() Экспорт
	
	Возврат нрег(СтрЗаменить(Строка(Новый("УникальныйИдентификатор")), "-", ""));
	
КонецФункции

Функция СоздатьВременныйКаталог() Экспорт
	
	ИмяКаталога = КаталогВременныхФайлов();
	РазделительПутиОС = ПолучитьРазделительПути();
	Если Прав(ИмяКаталога, 1) <> РазделительПутиОС Тогда
		ИмяКаталога = ИмяКаталога + РазделительПутиОС;
	КонецЕсли;
	
	ИмяКаталога = ИмяКаталога + Строка(Новый УникальныйИдентификатор) + РазделительПутиОС;
	СоздатьКаталог(ИмяКаталога);
	
	Возврат ИмяКаталога;
	
КонецФункции

Функция СоздатьДеревоXML() Экспорт
	
	ДеревоXML = Новый ДеревоЗначений;
	ДеревоXML.Колонки.Добавить("Код");
	ДеревоXML.Колонки.Добавить("Тип");
	ДеревоXML.Колонки.Добавить("Значение");
	ДеревоXML.Колонки.Добавить("ЭтоCDATA");
	Возврат ДеревоXML;
	
КонецФункции

Функция ДобавитьУзелXML(Родитель = Неопределено, Код, ЭтоАтрибут = Ложь, Значение = Неопределено, Необязательный = Ложь, ЭтоCDATA = Ложь) Экспорт
	
	Если Необязательный И НЕ ЗначениеЗаполнено(Значение) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	НовСтр = Родитель.Строки.Добавить();
	
	НовСтр.Код = Код;
	НовСтр.Значение = Значение;
	Если ТипЗнч(ЭтоАтрибут) = Тип("Булево") Тогда
		НовСтр.Тип = ?(ЭтоАтрибут, "А", "Э");
	Иначе
		НовСтр.Тип = ЭтоАтрибут;
	КонецЕсли;
	
	ТипЗнчРодитель = ТипЗнч(Родитель);
	Если (ТипЗнчРодитель = Тип("ДеревоЗначений") И Родитель.Колонки.Найти("ЭтоCDATA") <> Неопределено)
	ИЛИ (ТипЗнчРодитель = Тип("СтрокаДереваЗначений") И Родитель.Владелец().Колонки.Найти("ЭтоCDATA") <> Неопределено) Тогда
		НовСтр.ЭтоCDATA = ЭтоCDATA;
	КонецЕсли;
	
	Возврат НовСтр;
	
КонецФункции

Функция ВыгрузитьДеревоВXML_ПФР(ДеревоВыгрузки, ИмяКорневогоЭлемента = Неопределено)
	
	ПотокXML = СоздатьНовыйПотокXML_ПФР();
	ЗаписатьУзелДереваВXML_ПФР(ДеревоВыгрузки, ПотокXML, ИмяКорневогоЭлемента);
	ТекстДляЗаписи = ПотокXML.Закрыть();
	ТекстДляЗаписи = "<?xml version=""1.0"" encoding=""windows-1251""?>" + Сред(ТекстДляЗаписи, Найти(ТекстДляЗаписи, Символы.ПС));
	Возврат ТекстДляЗаписи;
	
КонецФункции

Функция СоздатьНовыйПотокXML_ПФР()
	
	ПотокXML = Новый ЗаписьXML();
	ПотокXML.УстановитьСтроку("UTF-8");
	ПотокXML.ЗаписатьОбъявлениеXML();
	ПотокXML.Отступ = Истина;
	Возврат ПотокXML;
	
КонецФункции

Функция ЗаписатьУзелДереваВXML_ПФР(СтрокаДерева, ПотокXML, ИмяКорневогоЭлемента)
	
	Если ТипЗнч(СтрокаДерева) = Тип("ДеревоЗначений") Тогда
		Если ЗначениеЗаполнено(ИмяКорневогоЭлемента) Тогда
			ПотокXML.ЗаписатьНачалоЭлемента(ИмяКорневогоЭлемента);
		КонецЕсли;
		Для каждого Стр Из СтрокаДерева.Строки Цикл
			ЗаписатьУзелДереваВXML_ПФР(Стр, ПотокXML, ИмяКорневогоЭлемента);
		КонецЦикла;
		Если ЗначениеЗаполнено(ИмяКорневогоЭлемента) Тогда
			ПотокXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
	Иначе
		Если СтрокаДерева.Тип = "А" ИЛИ СтрокаДерева.Тип = "A" Тогда 
			ПотокXML.ЗаписатьАтрибут(СтрокаДерева.Код, Строка(СтрокаДерева.Значение));
		Иначе
			ПотокXML.ЗаписатьНачалоЭлемента(СтрокаДерева.Код);
			Для каждого Лист из СтрокаДерева.Строки Цикл
				ЗаписатьУзелДереваВXML_ПФР(Лист, ПотокXML, ИмяКорневогоЭлемента);
			КонецЦикла;
			ПотокXML.ЗаписатьТекст(Строка(СтрокаДерева.Значение));
			ПотокXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
	КонецЕсли;

КонецФункции

Функция СоздатьОтветНаПисьмо(ОснованиеСсылка, НастройкиОтвета = Неопределено) Экспорт
	
	НовоеПисьмо = Справочники.ПерепискаСКонтролирующимиОрганами.СоздатьЭлемент();
	Попытка
		НовоеПисьмо = ОбработкаЗаполненияПисьма(НовоеПисьмо, ОснованиеСсылка, НастройкиОтвета);
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Не удалось создать ответ:%1'"),
																					Символы.ПС + ИнформацияОбОшибке().Описание);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецПопытки;
	Если НовоеПисьмо <> Неопределено Тогда
		Возврат НовоеПисьмо;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьИмяФайлаДИВЦиклаОбмена(Объект)
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	СодержимоеТранспортныхКонтейнеров.ИмяФайла
						  |ИЗ
						  |	РегистрСведений.СодержимоеТранспортныхКонтейнеров КАК СодержимоеТранспортныхКонтейнеров
						  |ГДЕ
						  |	СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.ЦиклОбмена = &ЦиклОбмена
						  |	И СодержимоеТранспортныхКонтейнеров.Тип В(&Тип)
						  |
						  |ОБЪЕДИНИТЬ ВСЕ
						  |
						  |ВЫБРАТЬ ПЕРВЫЕ 1
						  |	ТранспортныеКонтейнеры.ИмяФайла
						  |ИЗ
						  |	РегистрСведений.ТранспортныеКонтейнеры КАК ТранспортныеКонтейнеры
						  |ГДЕ
						  |	ТранспортныеКонтейнеры.ТранспортноеСообщение.ЦиклОбмена = &ЦиклОбмена");
	Запрос.УстановитьПараметр("ЦиклОбмена", ?(Объект.ЭтоНовый(), Объект.ПолучитьСсылкуНового(), Объект.Ссылка));
	ТипыВложений = Новый Массив;
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ФайлОтчетности);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Заявление);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Форма2НДФЛ);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.НеформализованныйДокумент);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ЗапросИОН);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ЗапросИОС);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Обращение);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Представление);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Запрос);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Рассылка);
	ТипыВложений.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Письмо);
	Запрос.УстановитьПараметр("Тип", ТипыВложений);
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Если Выборка.Следующий() Тогда
			Возврат СокрЛП(Выборка.ИмяФайла);
		КонецЕсли;
	КонецЕсли;
	Возврат "";
	
КонецФункции

Функция УстановитьСоединениеССерверомИнтернета(URLСервера, ПараметрыСоединения = Неопределено, ОписаниеОшибки = Неопределено) Экспорт
	
	Если ПараметрыСоединения = Неопределено Тогда
		НастройкиПрокси = ПолучениеФайловИзИнтернета.НастройкиПроксиНаСервере();
	Иначе
		НастройкиПрокси = ПараметрыСоединения;
	КонецЕсли;
	
	Если ТипЗнч(НастройкиПрокси) = Тип("Соответствие") Тогда
		Попытка
			Прокси = Новый ИнтернетПрокси;
			Прокси.Пользователь	= НастройкиПрокси["Пользователь"];
			Прокси.Пароль		= НастройкиПрокси["Пароль"];
		Исключение
			ОписаниеОшибки = ИнформацияОбОшибке().Описание;
			Возврат Неопределено;
		КонецПопытки;
	Иначе
		Прокси = Неопределено;
	КонецЕсли;
	
	Попытка
		Соединение = Новый HTTPСоединение(URLСервера, , , , Прокси);
	Исключение
		ОписаниеОшибки = ИнформацияОбОшибке().Описание;
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат Соединение;
	
КонецФункции

Функция ПолучитьТипПервичногоСообщенияПоЦиклуОбмена(ЦиклОбмена)
	
	ТипЦиклаОбмена = ЦиклОбмена.Тип;
	Если ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность Тогда
		Если ЦиклОбмена.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534 Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ДекларацияНП;
		КонецЕсли;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.Заявление Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП;	
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.Документ Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ДокументНО;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.ОтчетностьПФР Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.ИОС Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.ОбращениеНП Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ОбращениеНП;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.Представление Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.ПисьмоНО Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоНО;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.Рассылка Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РассылкаНО;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.РассылкаГрупповая Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РассылкаНО;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.ИОН Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ЗапросНП;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.ОтчетностьФСГС Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.ПисьменноеОбращениеВФСГС Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС;
	ИначеЕсли ТипЦиклаОбмена = Перечисления.ТипыЦикловОбмена.ИндивидуальноеИнформированиеФСГС Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС;
	Иначе
		Возврат Перечисления.ТипыТранспортныхСообщений.ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

Функция СформироватьИзвещениеОПолучении(ТранспортноеСообщение) Экспорт
	
	// проверяем, не сформировано ли уже извещение
	ИмеющиесяИзвещения = ПолучитьВложенияТранспортногоСообщения(ТранспортноеСообщение, Ложь, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ИзвещениеОПолучении);
	Если ИмеющиесяИзвещения.Количество() > 0 Тогда
		Возврат Истина;
	КонецЕсли;
	
	// определяем возможные типы документа, извещение о получении которого формируется
	Если ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
		ТипыДИВ = Новый Массив;
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыОтправки);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыОтправкиПредставление);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыПолучения);
	ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП Тогда
		ТипыДИВ = Новый Массив;
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриеме);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриемеДокумент);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриемеЗаявления);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбОтказе);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбОтказеДокумент);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Протокол2НДФЛ);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Реестр2НДФЛ);
	ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП Тогда
		ТипыДИВ = Новый Массив;
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ИзвещениеОВводе);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбУточнении);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Ответ);
		
		//Заявление
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОПростОтметки);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбОтказеОтметки);
	ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП Тогда
		ТипыДИВ = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОПроверке;
	ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП Тогда
		ТипыДИВ = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОбОтзывеЗаявления;
	ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП Тогда
		ТипыДИВ = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОНесоответствиях;
	ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП Тогда
		ТипыДИВ = Новый Массив;
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Документ);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Приложение);
		ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыОтправки);
	ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП Тогда
		ТипыДИВ = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Письмо;
	ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП Тогда
		ТипыДИВ = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Рассылка;
	КонецЕсли;
	
	// ищем ДИВ исходного сообщения
	ДИВы = ПолучитьВложенияТранспортногоСообщения(ТранспортноеСообщение.Основание, Ложь, ТипыДИВ);
	Если ДИВы.Количество() = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Не удалось создать извещение о получении документа: отсутствует исходный документ в сообщении-основании.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Ложь;
	КонецЕсли;
	ДИВы.Колонки.Добавить("ПодписьBase64");
	
	Для Каждого СтрДИВ Из ДИВы Цикл
		
		ИмяФайлаДИВ = СтрДИВ.ИмяФайла;
		
		// ищем подпись под ДИВ
		ПодписиСообщения = ПолучитьВложенияТранспортногоСообщения(ТранспортноеСообщение.Основание, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ЭлектронноЦифроваяПодпись);
		ПодписьПодДИВ = ПодписиСообщения.Найти(ИмяФайлаДИВ, "ЭЦПИмяПодписанногоФайла");
		Если ПодписьПодДИВ = Неопределено Тогда
			ТекстСообщения = НСтр("ru = 'Не удалось создать извещение о получении документа: отсутствует подпись под исходным документом.'");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Возврат Ложь;
		КонецЕсли;
		
		// пишем подпись во временный файл
		ВремФайл = ПолучитьИмяВременногоФайла();
		Попытка
			ПодписьПодДИВ.Данные.Получить().Записать(ВремФайл);
		Исключение
		КонецПопытки;
		
		// формируем Base64-представление подписи
		СтрДИВ.ПодписьBase64 = ПрочитатьBase64ИзФайла(ВремФайл);
		Если НЕ ЗначениеЗаполнено(СтрДИВ.ПодписьBase64) Тогда
			ТекстСообщения = НСтр("ru = 'Не удалось создать извещение о получении документа: не удалось прочитать данные из файла подписи абонента под исходным документом.'");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
			Возврат Ложь;
		КонецЕсли;
		УдалитьВременныйФайл(ВремФайл);
		
	КонецЦикла;
	
	// формируем имя файла извещения
	UUIDИзвещения = СгенерироватьUUID();
	ИмяФайлаИзвещения = СформироватьИмяФайлаИзвещения(ТранспортноеСообщение, ДИВы, UUIDИзвещения);
	Если НЕ ЗначениеЗаполнено(ИмяФайлаИзвещения) Тогда
		ТекстСообщения = НСтр("ru = 'Не удалось создать извещение о получении документа: не удалось сформировать имя файла извещения.'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Ложь;
	КонецЕсли;
	
	// формируем XML извещения о получении электронного документа
	ТекстИзвещения = СформироватьXMLИзвещенияОПолученииЭлектронногоДокумента(ТранспортноеСообщение, ДИВы, ИмяФайлаИзвещения);
	Если НЕ ЗначениеЗаполнено(ТекстИзвещения) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// пишем XML во временный файл в кодировке windows-1251
	ФайлИзвещения = ВыгрузитьТекстВФайл(ТекстИзвещения);
	Если НЕ ЗначениеЗаполнено(ФайлИзвещения) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// загружаем файл извещения в ИБ
	ТипСодержимогоТранспортногоКонтейнера = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ИзвещениеОПолучении;
	ДобавитьСодержимоеТранспортногоКонтейнера(ТранспортноеСообщение, ТипСодержимогоТранспортногоКонтейнера, ФайлИзвещения, ИмяФайлаИзвещения, , , , , , , UUIDИзвещения, Перечисления.ТипыСодержимогоФайлов.xml);
	
	// удаляем временный файл с извещением
	УдалитьВременныйФайл(ФайлИзвещения);
	
	Возврат Истина;
	
КонецФункции

Функция СформироватьИмяФайлаИзвещения(ТранспортноеСообщение, ДИВы, UUID)
	
	Префикс = "IZ";
	
	// выделяем префикс из имени основного ДИВ основания
	Если ДИВы.Количество() = 1 Тогда
		ОсновнойДИВ = ДИВы[0];
	Иначе
		ОсновнойДИВ = ДИВы.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Протокол2НДФЛ, "Тип");
		Если ОсновнойДИВ = Неопределено Тогда
			ОсновнойДИВ = ДИВы[0];
		КонецЕсли;
	КонецЕсли;
	ИмяФайлаДИВ = ОсновнойДИВ.ИмяФайла;
	
	ПрефиксОснования = ВыделитьПрефиксИзИмениФайлаОснования(ИмяФайлаДИВ);
	Если НЕ ЗначениеЗаполнено(ПрефиксОснования) Тогда
		// если префикс выделить не удалось, то пишем хоть какой-нибудь (это лучше, чем не отправлять извещение вообще)
		ПрефиксОснования = "NO_PREF";
	КонецЕсли;
	
	// формируем идентификатор получателя
	ИдентификаторПолучателя = СформироватьИдентификаторПолучателя(ТранспортноеСообщение);
	
	// формируем идентификатор отправителя
	ИдентификаторОтправителя = СформироватьИдентификаторОтправителя(ТранспортноеСообщение);
	
	// формируем строку с текущей датой
	GGGGMMDD = Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMdd");
	
	// 
	ИдентификаторФайла = UUID;
	
	//
	РасширениеФайла = "xml";
	
	// собираем имя файла извещения из составляющих
	ИмяФайлаИзвещения = Префикс + "_" + ПрефиксОснования + "_" + ИдентификаторПолучателя + "_" + ИдентификаторПолучателя + "_" + ИдентификаторОтправителя + "_" + GGGGMMDD + "_" + ИдентификаторФайла + "." + РасширениеФайла;
	Возврат ИмяФайлаИзвещения;
	
КонецФункции

Функция СформироватьИдентификаторПолучателя(ТранспортноеСообщение)
	
	// если тип сообщения - ИзвещениеПодтверждениеНП, то идентификатор получателя
	// берется из имени контейнера сообщения-основания
	Если ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
		Возврат ПолучитьИдентификаторОтправителяПодтвержденияДатыОтправки(ТранспортноеСообщение.Основание);
	ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП
	ИЛИ ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП 
	ИЛИ ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП
	ИЛИ ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП
	ИЛИ ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП
	ИЛИ ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП
	ИЛИ ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП
	ИЛИ ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП
	ИЛИ ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП Тогда
		Возврат СокрЛП(ТранспортноеСообщение.ЦиклОбмена.ВнешняяОрганизация.Код);
	Иначе
		Получатель = ТранспортноеСообщение.Получатель;
		ТипПолучателя = ТипЗнч(Получатель);
		Если ТипПолучателя = Тип("СправочникСсылка.СерверыДокументооборота") Тогда
			Возврат СокрЛП(ТранспортноеСообщение.УчетнаяЗапись.ИдентификаторСпецоператора);
		ИначеЕсли ТипПолучателя = Тип("СправочникСсылка.НалоговыеОрганы") Тогда
			Возврат СокрЛП(Получатель.Код);
		КонецЕсли;
	КонецЕсли;
	
КонецФункции

Функция СформироватьИдентификаторОтправителя(ТранспортноеСообщение) Экспорт
	
	Если ТранспортноеСообщение.УчетнаяЗапись.ЯвляетсяУчетнойЗаписьюУполномоченногоПредставителя Тогда
		
		Возврат СокрЛП(ТранспортноеСообщение.УчетнаяЗапись.ИННУполномоченногоПредставителя) + СокрЛП(ТранспортноеСообщение.УчетнаяЗапись.КППУполномоченногоПредставителя);
		
	Иначе
		
		ИдентификаторОтправителя = "";
		
		Отправитель = ТранспортноеСообщение.Отправитель;
		ИНН = СокрЛП(Отправитель.ИНН);
		Если НЕ РегламентированнаяОтчетностьВызовСервера.ЭтоЮридическоеЛицо(Отправитель) Тогда
			ИдентификаторОтправителя = ИНН;
		Иначе
			СведенияОбОрганизации = РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(Отправитель, , "КППЮЛ");
			ИдентификаторОтправителя = ИНН + СокрЛП(СведенияОбОрганизации.КППЮЛ);
		КонецЕсли;
		
		Возврат ИдентификаторОтправителя;
		
	КонецЕсли;
	
КонецФункции

Функция ВыделитьПрефиксИзИмениФайлаОснования(ИмяФайлаДИВ)
	
	РасширениеФайлаДИВ = нрег(РасширениеФайла(ИмяФайлаДИВ));
	Если РасширениеФайлаДИВ = "txt" Тогда // если это текстовый файл, то префикс - это то, что до первой цифры, кроме случая протокола 2-НДФЛ
		
		ПрефиксПротокол2НДФЛ1 = "ПРОТ_ДОХОД_2НДФЛ"; // префикс протокола 2-НДФЛ
		ПрефиксПротокол2НДФЛ2 = "PROT_NO_NDFL2"; // префикс протокола 2-НДФЛ
		ПрефиксРассылки = "IU_RASS"; // префикс файла рассылки
		Если нрег(Лев(ИмяФайлаДИВ, СтрДлина(ПрефиксПротокол2НДФЛ1))) = нрег(ПрефиксПротокол2НДФЛ1) Тогда
			Возврат СтрЗаменить(Лев(ИмяФайлаДИВ, СтрДлина(ПрефиксПротокол2НДФЛ1)), "_", "");
		ИначеЕсли нрег(Лев(ИмяФайлаДИВ, СтрДлина(ПрефиксПротокол2НДФЛ2))) = нрег(ПрефиксПротокол2НДФЛ2) Тогда
			Возврат СтрЗаменить(Лев(ИмяФайлаДИВ, СтрДлина(ПрефиксПротокол2НДФЛ2)), "_", "");
			//Возврат Лев(ИмяФайлаДИВ, СтрДлина(ПрефиксПротокол2НДФЛ2));
		ИначеЕсли нрег(Лев(ИмяФайлаДИВ, СтрДлина(ПрефиксРассылки))) = нрег(ПрефиксРассылки) Тогда
			Возврат СтрЗаменить(Лев(ИмяФайлаДИВ, СтрДлина(ПрефиксРассылки)), "_", "");
		Иначе
			СтрЦифры = "0123456789";
			Для Инд = 1 По СтрДлина(ИмяФайлаДИВ) Цикл
				ТекСимв = Сред(ИмяФайлаДИВ, Инд, 1);
				Если Найти(СтрЦифры, ТекСимв) <> 0 Тогда
					Возврат СтрЗаменить(Лев(ИмяФайлаДИВ, Инд - 1), "_", "");
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
	Иначе
		
		Разделитель = "_";
		ИндексВхожденияРазделителя = 0;
		Для Инд = 1 По СтрДлина(ИмяФайлаДИВ) Цикл
			ТекСимв = Сред(ИмяФайлаДИВ, Инд, 1);
			Если ТекСимв = Разделитель Тогда
				ИндексВхожденияРазделителя = ИндексВхожденияРазделителя + 1;
				Если ИндексВхожденияРазделителя = 2 Тогда
					Возврат СтрЗаменить(Лев(ИмяФайлаДИВ, Инд - 1), "_", "");
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция СформироватьСведенияОПолучателеИзвещения(ТранспортноеСообщение)
	
	Если ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
		УчастникДокументооборота = ТранспортноеСообщение.Получатель; // сервер документооборота СОС или ФНС
	//ИначеЕсли ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП
	//ИЛИ ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП Тогда
	//	УчастникДокументооборота = ТранспортноеСообщение.Получатель; // НО-посредник (при пересылке для крупнейших)
	Иначе
		УчастникДокументооборота = ТранспортноеСообщение.ЦиклОбмена.ВнешняяОрганизация;
	КонецЕсли;
	
	Возврат СформироватьСведенияОбУчастникеДокументооборота(УчастникДокументооборота, ТранспортноеСообщение);
	
КонецФункции

Функция СформироватьСведенияОбОтправителеИзвещения(ТранспортноеСообщение)
	
	Возврат СформироватьСведенияОбУчастникеДокументооборота(ТранспортноеСообщение.Отправитель, ТранспортноеСообщение);
	
КонецФункции

Функция СформироватьСведенияОбУчастникеДокументооборота(Участник, ТранспортноеСообщение)
	
	Сведения = Новый Структура;
	
	УчетнаяЗапись = ТранспортноеСообщение.УчетнаяЗапись;
	
	ТипУчастника = ТипЗнч(Участник);
	Если ТипУчастника = Тип("СправочникСсылка.Организации") Тогда
		
		Сведения.Вставить("ТипУчастника", "Организация");
		Сведения.Вставить("Email", ?(ПустаяСтрока(УчетнаяЗапись.ИдентификаторАбонента), СокрЛП(УчетнаяЗапись.АдресЭлектроннойПочты), СокрЛП(УчетнаяЗапись.ИдентификаторАбонента)));
		
		Если УчетнаяЗапись.ЯвляетсяУчетнойЗаписьюУполномоченногоПредставителя Тогда
			
			ЭтоФизЛицо = (СтрДлина(СокрЛП(УчетнаяЗапись.ИННУполномоченногоПредставителя)) = 12);
			Сведения.Вставить("ЭтоФизЛицо", ЭтоФизЛицо);
			Если ЭтоФизЛицо Тогда
				
				Сведения.Вставить("ИНН", СокрЛП(УчетнаяЗапись.ИННУполномоченногоПредставителя));
				
				ФИО = РегламентированнаяОтчетностьКлиентСервер.РазложитьФИО(СокрЛП(УчетнаяЗапись.ПолноеНаименованиеУполномоченногоПредставителя));
				Сведения.Вставить("Фамилия", СокрЛП(ФИО.Фамилия));
				Сведения.Вставить("Имя", СокрЛП(ФИО.Имя));
				Сведения.Вставить("Отчество", СокрЛП(ФИО.Отчество));
				
			Иначе
				СведенияОбОрганизации = РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(Участник, , "НаимЮЛПол, ИННЮЛ, КППЮЛ");
				Сведения.Вставить("Наименование", СокрЛП(УчетнаяЗапись.ПолноеНаименованиеУполномоченногоПредставителя));
				Сведения.Вставить("ИНН", СокрЛП(УчетнаяЗапись.ИННУполномоченногоПредставителя));
				Сведения.Вставить("КПП", СокрЛП(УчетнаяЗапись.КППУполномоченногоПредставителя));
			КонецЕсли;
			
		Иначе
			
			ЭтоФизЛицо = НЕ РегламентированнаяОтчетностьВызовСервера.ЭтоЮридическоеЛицо(Участник);
			Сведения.Вставить("ЭтоФизЛицо", ЭтоФизЛицо);
			Если ЭтоФизЛицо Тогда
				
				Сведения.Вставить("ИНН", СокрЛП(Участник.ИНН));
				
				ФИО = ФИОИндивидуальногоПредпринимателя(Участник);
				Сведения.Вставить("Фамилия", СокрЛП(ФИО.Фамилия));
				Сведения.Вставить("Имя", СокрЛП(ФИО.Имя));
				Сведения.Вставить("Отчество", СокрЛП(ФИО.Отчество));
				
			Иначе
				СведенияОбОрганизации = РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(Участник, , "НаимЮЛПол, ИННЮЛ, КППЮЛ");
				Сведения.Вставить("Наименование", СокрЛП(СведенияОбОрганизации.НаимЮЛПол));
				Сведения.Вставить("ИНН", СокрЛП(СведенияОбОрганизации.ИННЮЛ));
				Сведения.Вставить("КПП", СокрЛП(СведенияОбОрганизации.КППЮЛ));
			КонецЕсли;
			
		КонецЕсли;
		
	ИначеЕсли ТипУчастника = Тип("СправочникСсылка.НалоговыеОрганы") Тогда
		
		Сведения.Вставить("ТипУчастника", "НалоговыйОрган");
		Если УчетнаяЗапись.ОбменНапрямую Тогда
			Сведения.Вставить("Email", Участник.АдресЭлектроннойПочтыДляЦелейДокументооборотаСНалогоплательщиками);
		Иначе
			Сведения.Вставить("Email", ПолучитьEmailОтправителяИзПодтвержденияОПолучении(ТранспортноеСообщение.ЦиклОбмена));
		КонецЕсли;
		
		Сведения.Вставить("Код", СокрЛП(Участник.Код));
		
	ИначеЕсли ТипУчастника = Тип("СправочникСсылка.СерверыДокументооборота") Тогда
		
		// особая обработка, если описывается получатель ИзвещениеПодтверждениеНП при обмене напрямую
		Если УчетнаяЗапись.ОбменНапрямую И ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
			
			Сведения.Вставить("ТипУчастника", "НалоговыйОрган");
			Сведения.Вставить("Код", ПолучитьИдентификаторОтправителяПодтвержденияДатыОтправки(ТранспортноеСообщение.Основание));
			Сведения.Вставить("Email", Участник.АдресЭлектроннойПочтыФНС);
			
		Иначе
			
			Сведения.Вставить("ТипУчастника", "СерверДокументооборота");
			Сведения.Вставить("Email", Участник.АдресЭлектроннойПочтыФНС);
			
			Сведения.Вставить("Идентификатор", СокрЛП(УчетнаяЗапись.ИдентификаторСпецоператора));
			Сведения.Вставить("Наименование", СокрЛП(УчетнаяЗапись.ИдентификаторСпецоператора));
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Сведения;
	
КонецФункции

Функция ПолучитьEmailОтправителяИзПодтвержденияОПолучении(ЦиклОбмена)
	
	// получаем извещение о получении декларации или 2-НДФЛ
	ИзвещениеДекларацияНО = ПолучитьСообщениеЦиклаОбмена(ЦиклОбмена, Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО);
	Если НЕ ЗначениеЗаполнено(ИзвещениеДекларацияНО) Тогда
		ИзвещениеДекларацияНО = ПолучитьСообщениеЦиклаОбмена(ЦиклОбмена, Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО);
		Если НЕ ЗначениеЗаполнено(ИзвещениеДекларацияНО) Тогда
			ИзвещениеДекларацияНО = ПолучитьСообщениеЦиклаОбмена(ЦиклОбмена, Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО);
			Если НЕ ЗначениеЗаполнено(ИзвещениеДекларацияНО) Тогда
				ИзвещениеДекларацияНО = ПолучитьСообщениеЦиклаОбмена(ЦиклОбмена, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО);
				Если НЕ ЗначениеЗаполнено(ИзвещениеДекларацияНО) Тогда
					Возврат Неопределено;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// получаем данные извещения
	ИзвещенияОПолучении = ПолучитьВложенияТранспортногоСообщения(ИзвещениеДекларацияНО, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ИзвещениеОПолучении);
	Если ИзвещенияОПолучении.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	ДанныеИзвещенияОПолучении = ИзвещенияОПолучении[0].Данные;
	
	// выгружаем данные извещения во временный файл
	Попытка
		ФайлИзвещения = ПолучитьИмяВременногоФайла();
		ДанныеИзвещенияОПолучении.Получить().Записать(ФайлИзвещения);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
	// создаем дерево из файла
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ФайлИзвещения);
	УдалитьВременныйФайл(ФайлИзвещения);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// находим узел ПодтвДок
	УзелПодтвДок = ДеревоXML.Строки.Найти("ПодтвДок", "Имя", Истина);
	Если УзелПодтвДок = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// находим атрибут E-mail
	УзелEmail = УзелПодтвДок.Строки.Найти("E-mail", "Имя");
	Если УзелEmail = Неопределено ИЛИ НЕ ЗначениеЗаполнено(УзелEmail.Значение) Тогда
		Возврат Неопределено;
	Иначе
		Возврат СокрЛП(УзелEmail.Значение);
	КонецЕсли;
	
КонецФункции

Функция ПолучитьИдентификаторОтправителяПодтвержденияДатыОтправки(ПодтверждениеДатыОтправки)
	
	КонтейнерыОснования = ПолучитьТранспортныйКонтейнер(ПодтверждениеДатыОтправки);
	Если КонтейнерыОснования.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	ИмяФайлаКонтейнера = КонтейнерыОснования[0].ИмяФайла;
	
	КомпонентыИмени = РазложитьСтрокуВМассивПодстрок(ИмяФайлаКонтейнера, "_");
	Если КомпонентыИмени.Количество() < 2 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат СокрЛП(КомпонентыИмени[1]);
	
КонецФункции

Функция ИмяФайлаБезРасширения(ИмяФайлаСРасширением)
	
	ДлинаИмениФайла = СтрДлина(ИмяФайлаСРасширением);
	Для Инд = 1 По ДлинаИмениФайла Цикл
		Если Сред(ИмяФайлаСРасширением, ДлинаИмениФайла - Инд + 1, 1) = "." Тогда
			Возврат Лев(ИмяФайлаСРасширением, ДлинаИмениФайла - Инд);
		КонецЕсли;
	КонецЦикла;
	Возврат ИмяФайлаСРасширением;
	
КонецФункции

// есть в Контейнере
Функция СформироватьXMLИзвещенияОПолученииЭлектронногоДокумента(ТранспортноеСообщение, ДИВы, ИмяФайлаИзвещения)
	
	// выделяем имя файла без расширения из короткого имени файла извещения
	РасширениеФайлаИзвещения = РасширениеФайла(ИмяФайлаИзвещения);
	ДлинаРасширенияИмениФайлаИзвещения = СтрДлина(РасширениеФайлаИзвещения);
	ИмяФайлаИзвещенияБезРасширения = Лев(ИмяФайлаИзвещения, СтрДлина(ИмяФайлаИзвещения) - ДлинаРасширенияИмениФайлаИзвещения - 1);
	
	// определяем дату получения основания
	ДатаПолученияОснования = ТранспортноеСообщение.Основание.ДатаТранспорта;
	
	// получаем сведения о получателе
	СведенияОПолучателе = СформироватьСведенияОПолучателеИзвещения(ТранспортноеСообщение);
	Если НЕ ЗначениеЗаполнено(СведенияОПолучателе) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// получаем сведения об отправителе
	СведенияОбОтправителе = СформироватьСведенияОбОтправителеИзвещения(ТранспортноеСообщение);
	Если НЕ ЗначениеЗаполнено(СведенияОбОтправителе) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// создаем XML-дерево извещения
	ДеревоXML = СоздатьДеревоXML();
	
	// иниицализируем атрибуты корневого элемента
	ДобавитьУзелXML(ДеревоXML, "ИдФайл", Истина, ИмяФайлаИзвещенияБезРасширения);
	ДобавитьУзелXML(ДеревоXML, "ВерсПрог", Истина, Лев(РегламентированнаяОтчетность.НазваниеИВерсияПрограммы(), 40));
		ДобавитьУзелXML(ДеревоXML, "ВерсФорм", Истина, "5.01");
	
	// создаем узел Документ
	УзелДокумент = ДобавитьУзелXML(ДеревоXML, "Документ");
		ДобавитьУзелXML(УзелДокумент, "КНД", Истина, "1167004");
	
	// добавляем сведения об организации
	УзелПодтвДок = ДобавитьУзелXML(УзелДокумент, "ПодтвДок");
	ЗаполнитьУзелСведениямиОбУчастникеЭДО(УзелПодтвДок, СведенияОбОтправителе);
	
	// создаем узел СвИзвещП
	УзелСвИзвещП = ДобавитьУзелXML(УзелДокумент, "СвИзвещП");
	ДобавитьУзелXML(УзелСвИзвещП, "ДатаПол", Истина, Формат(ДатаПолученияОснования, "ДФ=dd.MM.yyyy"));
	ДобавитьУзелXML(УзелСвИзвещП, "ВремяПол", Истина, Формат(ДатаПолученияОснования, "ДФ=HH.mm.ss"));
	
	Для Каждого СтрДИВ Из ДИВы Цикл
		
		// создаем узел СведПолФайл
		УзелСведПолФайл = ДобавитьУзелXML(УзелСвИзвещП, "СведПолФайл");
		ДобавитьУзелXML(УзелСведПолФайл, "ИмяПостФайла", Истина, ИмяФайлаБезРасширения(СтрДИВ.ИмяФайла));
		
		// добавляем подпись под ДИВ
		ДобавитьУзелXML(УзелСведПолФайл, "ЭЦППолФайл", , СтрДИВ.ПодписьBase64);
		
	КонецЦикла;
	
	// добавляем сведения об отправителе исходного документа
	УзелОтпрДок = ДобавитьУзелXML(УзелДокумент, "ОтпрДок");
	ЗаполнитьУзелСведениямиОбУчастникеЭДО(УзелОтпрДок, СведенияОПолучателе);
	
	// добавляем сведения о получателе исходного документа
	УзелПолДок = ДобавитьУзелXML(УзелДокумент, "ПолДок");
	ЗаполнитьУзелСведениямиОбУчастникеЭДО(УзелПолДок, СведенияОбОтправителе);
	
	// формируем XML-строку на основе дерева
	ТекстXML = ВыгрузитьДеревоВXML_ПФР(ДеревоXML, "Файл");
	
	Возврат ТекстXML;
	
КонецФункции

Процедура ЗаполнитьУзелСведениямиОбУчастникеЭДО(Узел, Сведения)
	
	ТипУчастникаЭДО = Сведения.ТипУчастника;
	Если ТипУчастникаЭДО = "Организация" Тогда
		
		Если ЗначениеЗаполнено(Сведения.Email) Тогда
			ДобавитьУзелXML(Узел, "E-mail", Истина, Сведения.Email);
		КонецЕсли;
		
		Если Сведения.ЭтоФизЛицо Тогда
			
			УзелФЛ = ДобавитьУзелXML(Узел, "ФЛ");
			ДобавитьУзелXML(УзелФЛ, "ИННФЛ", Истина, Сведения.ИНН);
			
			УзелФИО = ДобавитьУзелXML(УзелФЛ, "ФИО");
			ДобавитьУзелXML(УзелФИО, "Фамилия", Истина, Сведения.Фамилия);
			ДобавитьУзелXML(УзелФИО, "Имя", Истина, Сведения.Имя);
			Если ЗначениеЗаполнено(Сведения.Отчество) Тогда
				ДобавитьУзелXML(УзелФИО, "Отчество", Истина, Сведения.Отчество);
			КонецЕсли;
			
		Иначе
			
			УзелЮЛ = ДобавитьУзелXML(Узел, "ЮЛ");
			ДобавитьУзелXML(УзелЮЛ, "НаимОрг", Истина, Сведения.Наименование);
			ДобавитьУзелXML(УзелЮЛ, "ИННЮЛ", Истина, Сведения.ИНН);
			ДобавитьУзелXML(УзелЮЛ, "КПП", Истина, Сведения.КПП);
			
		КонецЕсли;
		
	ИначеЕсли ТипУчастникаЭДО = "НалоговыйОрган" Тогда
		
		Если ЗначениеЗаполнено(Сведения.Email) Тогда
			ДобавитьУзелXML(Узел, "E-mail", Истина, Сведения.Email);
		Иначе
			ДобавитьУзелXML(Узел, "E-mail", Истина, "-");
		КонецЕсли;
		ДобавитьУзелXML(Узел, "КодНО", , Сведения.Код);
		
	ИначеЕсли ТипУчастникаЭДО = "СерверДокументооборота" Тогда
		
		Если ЗначениеЗаполнено(Сведения.Email) Тогда
			ДобавитьУзелXML(Узел, "E-mail", Истина, Сведения.Email);
		КонецЕсли;
		
		УзелСпецоперат = ДобавитьУзелXML(Узел, "СпецОперат");
		ДобавитьУзелXML(УзелСпецоперат, "НаимОрг", Истина, Сведения.Наименование);
		ДобавитьУзелXML(УзелСпецоперат, "ИденСОС", Истина, Сведения.Идентификатор);
		
	КонецЕсли;
	
КонецПроцедуры

// Функция "расщепляет" строку на подстроки, используя заданный 
//		разделитель. Разделитель может иметь любую длину. 
//		Если в качестве разделителя задан пробел, рядом стоящие пробелы 
//		считаются одним разделителем, а ведущие и хвостовые пробелы параметра Стр
//		игнорируются.
//		Например, 
//		РазложитьСтрокуВМассивПодстрок(",ку,,,му", ",") возвратит массив значений из пяти элементов, 
//		три из которых - пустые строки, а 
//		РазложитьСтрокуВМассивПодстрок(" ку   му", " ") возвратит массив значений из двух элементов
//
//	Параметры: 
//		Стр - 			строка, которую необходимо разложить на подстроки. 
//						Параметр передается по значению.
//		Разделитель - 	строка-разделитель, по умолчанию - запятая.
//
//
//	Возвращаемое значение:
//		массив значений, элементы которого - подстроки
//
Функция РазложитьСтрокуВМассивПодстрок(Знач Стр, Разделитель = ",")
	
	МассивСтрок = Новый Массив();
	Если Разделитель = " " Тогда
		Стр = СокрЛП(Стр);
		Пока 1=1 Цикл
			Поз = Найти(Стр,Разделитель);
			Если Поз=0 Тогда
				МассивСтрок.Добавить(Стр);
				Возврат МассивСтрок;
			КонецЕсли;
			МассивСтрок.Добавить(Лев(Стр,Поз-1));
			Стр = СокрЛ(Сред(Стр,Поз));
		КонецЦикла;
	Иначе
		ДлинаРазделителя = СтрДлина(Разделитель);
		Пока 1=1 Цикл
			Поз = Найти(Стр,Разделитель);
			Если Поз=0 Тогда
				МассивСтрок.Добавить(Стр);
				Возврат МассивСтрок;
			КонецЕсли;
			МассивСтрок.Добавить(Лев(Стр,Поз-1));
			Стр = Сред(Стр,Поз+ДлинаРазделителя);
		КонецЦикла;
	КонецЕсли;
	
КонецФункции // глРазложить

Функция ПолучитьПредметыЦиклаОбмена(ЦиклОбмена) Экспорт
	
	Предметы = ЦиклОбмена.ДополнительныеПредметы.ВыгрузитьКолонку("Предмет");
	Предметы.Вставить(0, ЦиклОбмена.Предмет);
	Возврат Предметы;
	
КонецФункции

Функция ПолучитьОтветыНаЗапросИОН(парамЗапрос, СДанными = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = Запрос.Текст + "ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ОтветыНаЗапросыИОН.ИмяФайла,
						  |	ОтветыНаЗапросыИОН.Размер,
						  |	ОтветыНаЗапросыИОН.ТипСодержимого";
	Если СДанными Тогда
		Запрос.Текст = Запрос.Текст + ",
						  |	ОтветыНаЗапросыИОН.Данные";
	КонецЕсли;
	Запрос.Текст = Запрос.Текст + "
						  |ИЗ
						  |	РегистрСведений.ОтветыНаЗапросыИОН КАК ОтветыНаЗапросыИОН
						  |ГДЕ
						  |	ОтветыНаЗапросыИОН.Запрос = &Запрос";
	Запрос.УстановитьПараметр("Запрос", парамЗапрос);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ДобавитьОтветНаЗапросИОН(Запрос, ИмяФайла, Данные, Размер = Неопределено, ТипСодержимогоФайла = Неопределено) Экспорт
	
	Если Размер = Неопределено Тогда
		Размер = ОпределитьРазмер(Данные);
	КонецЕсли;
	
	МенеджерЗаписи = РегистрыСведений.ОтветыНаЗапросыИОН.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.Запрос = Запрос;
	МенеджерЗаписи.ИмяФайла = ИмяФайла;
	МенеджерЗаписи.Размер = Размер;
	
	Если ТипСодержимогоФайла <> Неопределено Тогда
		МенеджерЗаписи.ТипСодержимого = ТипСодержимогоФайла;
	КонецЕсли;
	
	ТипДанных = ТипЗнч(Данные);
	Если ТипДанных = Тип("ХранилищеЗначения") Тогда // если хранилище значения
		МенеджерЗаписи.Данные = Данные;
	ИначеЕсли ТипДанных = Тип("Строка") Тогда // если полное имя файла
		МенеджерЗаписи.Данные = Новый ХранилищеЗначения(Новый ДвоичныеДанные(Данные), Новый СжатиеДанных(9));
	Иначе // если двоичные данные
		МенеджерЗаписи.Данные = Новый ХранилищеЗначения(Данные, Новый СжатиеДанных(9));
	КонецЕсли;
	
	Попытка
		МенеджерЗаписи.Записать(Истина);
		Отказ = Ложь;
		ЭлектронныйДокументооборотСКонтролирующимиОрганами.ЗаписьОбъектовРегламентированнойОтчетности(Запрос, Отказ);
		Возврат Истина;
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Не удалось сохранить в информационной базе файл ответа на запрос ИОН %1!%2'"),
																					Запрос,
																					Символы.ПС + ИнформацияОбОшибке().Описание);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

Функция ЗаписатьУзелДереваВXML(СтрокаДерева, ПотокXML)
	
	Если ТипЗнч(СтрокаДерева) = Тип("ДеревоЗначений") Тогда
		ПотокXML.ЗаписатьНачалоЭлемента("К_2_180_06_001_001");
		ПотокXML.ЗаписатьАтрибут("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");
		ПотокXML.ЗаписатьАтрибут("xsi:noNamespaceSchemaLocation", "NP_NO_2_180_06_001_001.xsd");
		Для каждого Стр Из СтрокаДерева.Строки Цикл
			ЗаписатьУзелДереваВXML(Стр, ПотокXML);
		КонецЦикла;
		ПотокXML.ЗаписатьКонецЭлемента();
	Иначе
		Если СтрокаДерева.Тип = "А" ИЛИ СтрокаДерева.Тип = "A" Тогда 
			ПотокXML.ЗаписатьАтрибут(СтрокаДерева.Код, Строка(СтрокаДерева.Значение));
		Иначе
			ПотокXML.ЗаписатьНачалоЭлемента(СтрокаДерева.Код);
			Если СтрокаДерева.Владелец().Колонки.Найти("ЭтоCDATA") <> Неопределено И СтрокаДерева.ЭтоCDATA Тогда
				ПотокXML.ЗаписатьСекциюCDATA(СтрокаДерева.Значение);
			Иначе
				Для каждого Лист из СтрокаДерева.Строки Цикл
					ЗаписатьУзелДереваВXML(Лист, ПотокXML);
				КонецЦикла;
				ПотокXML.ЗаписатьТекст(Строка(СтрокаДерева.Значение));
			КонецЕсли;
			ПотокXML.ЗаписатьКонецЭлемента();
		КонецЕсли;
	КонецЕсли;

КонецФункции

Функция СтрокаОС() Экспорт
	
	СисИнфо = Новый СистемнаяИнформация;
	Если СисИнфо.ТипПлатформы = ТипПлатформы.Linux_x86 Тогда
		Возврат "Linux32";
	ИначеЕсли СисИнфо.ТипПлатформы = ТипПлатформы.Linux_x86_64 Тогда
		Возврат "Linux64";
	ИначеЕсли СисИнфо.ТипПлатформы = ТипПлатформы.Windows_x86 Тогда
		Возврат "Windows32";
	Иначе
		Возврат "Windows64";
	КонецЕсли;
	
КонецФункции

//////////////////////////////////////////////////////////////////////////////////
//// ОБРАБОТЧИКИ СОБЫТИЙ УЧЕТНОЙ ЗАПИСИ НАЛОГОПЛАТЕЛЬЩИКА

Процедура ПередЗаписьюУчетнойЗаписиНалогоплательщика(Объект, Отказ)

	ШапкаОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Не удалось записать учетную запись налогоплательщика %1:'"),
																			?(ПустаяСтрока(Объект.Наименование), "<наименование не задано>", СокрЛП(Объект.Наименование)));
	
	Если НЕ ЗначениеЗаполнено(Объект.АдресЭлектроннойПочты) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не указан адрес электронной почты!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.СерверДокументооборота) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не выбран сервер документооборота!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	// проверка параметров SMTP
	Если НЕ ЗначениеЗаполнено(Объект.СерверSMTP) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не задан адрес SMTP-сервера налоговых органов!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ПортSMTP) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не указан порт SMTP для доступа к серверу налоговых органов!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Если Объект.ТребуетсяSMTPАутентификация Тогда
		Если НЕ ЗначениеЗаполнено(Объект.ИмяПользователяSMTP) Тогда
			Отказ = Истина;
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не задано имя пользователя SMTP для доступа к серверу налоговых органов!'"), ШапкаОшибки + Символы.ПС);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Объект.ПарольSMTP) Тогда
			Отказ = Истина;
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не задан пароль SMTP для доступа к серверу налоговых органов!'"), ШапкаОшибки + Символы.ПС);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		КонецЕсли;
	КонецЕсли;
	
	// проверка параметров POP3
	Если НЕ ЗначениеЗаполнено(Объект.СерверPOP3) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не указан адрес POP3-сервера налоговых органов!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ПортPOP3) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не указан порт POP3 для доступа к серверу налоговых органов!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ИмяПользователяPOP3) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не задано имя пользователя POP3 для доступа к серверу налоговых органов!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ПарольPOP3) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не задан пароль POP3 для доступа к серверу налоговых органов!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Если Объект.ПредназначенаДляДокументооборотаСФНС Тогда
		Если НЕ ЗначениеЗаполнено(Объект.НалоговыйОрган) Тогда
			Отказ = Истина;
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не указан налоговый орган!'"), ШапкаОшибки + Символы.ПС);
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.СертификатРуководителя) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не выбран сертификат руководителя!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.СертификатДляШифрования) Тогда
		Отказ = Истина;
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='%1Не выбран сертификат для целей шифрования!'"), ШапкаОшибки + Символы.ПС);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
	Если НЕ Отказ Тогда
		
		Объект.Наименование = Объект.АдресЭлектроннойПочты;
		
		Если Объект.ОбменНапрямую Тогда
			Объект.РежимАвтонастройки = Перечисления.РежимыАвтонастройкиУчетнойЗаписиНалогоплательщика.Отключена;
			Объект.ИспользоватьСервисОнлайнПроверкиОтчетов = Ложь;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(Объект.ИдентификаторСпецоператора) И СтрДлина(СокрЛП(Объект.ИдентификаторАбонента)) > 3 Тогда
			Объект.ИдентификаторСпецоператора = Лев(СокрЛП(Объект.ИдентификаторАбонента), 3);
		КонецЕсли;
		
		//Если НЕ Объект.ОбменНапрямую
		//И Метаданные.Перечисления.Найти("СпецоператорыСвязи") <> Неопределено
		//И НЕ ЗначениеЗаполнено(Объект.СпецоператорСвязи) Тогда
		//	Если Найти(НРег(Объект.АдресЭлектроннойПочты), "taxcom.ru") > 0 Тогда
		//		Объект.СпецоператорСвязи = Перечисления.СпецоператорыСвязи.Такском;
		//	Иначе
		//		Объект.СпецоператорСвязи = Перечисления.СпецоператорыСвязи.Прочие;
		//	КонецЕсли;
		//КонецЕсли;
		
	КонецЕсли;
	
	Объект.ЭтоЗаписьНового = Объект.ЭтоНовый();
	
КонецПроцедуры

Процедура ПриЗаписиУчетнойЗаписиНалогоплательщика(Объект, Отказ)
	
	// если пишется новый элемент и ему не сопоставлены пользователи,
	// то сопоставим ему текущего пользователя - автора
	//Если Объект.ЭтоЗаписьНового И Объект.ЗаписатьПользователяПоУмолчанию Тогда
	Если (Объект.ЭтоЗаписьНового = Неопределено ИЛИ Объект.ЭтоЗаписьНового) И Объект.ЗаписатьПользователяПоУмолчанию Тогда
		ТекущийПользователь = Пользователи.ТекущийПользователь();
		Если ЗначениеЗаполнено(ТекущийПользователь) Тогда
			Запрос = Новый Запрос("ВЫБРАТЬ
			                      |	КОЛИЧЕСТВО(ПользователиУчетныхЗаписейДокументооборота.Пользователь) КАК Пользователь
			                      |ИЗ
			                      |	РегистрСведений.ПользователиУчетныхЗаписейДокументооборота КАК ПользователиУчетныхЗаписейДокументооборота
			                      |ГДЕ
			                      |	ПользователиУчетныхЗаписейДокументооборота.УчетнаяЗапись = &УчетнаяЗапись");
			Запрос.УстановитьПараметр("УчетнаяЗапись", Объект.Ссылка);
			Выборка = Запрос.Выполнить().Выбрать();
			Если НЕ Выборка.Следующий() ИЛИ НЕ ЗначениеЗаполнено(Выборка.Пользователь) Тогда
				МенеджерЗаписи = РегистрыСведений.ПользователиУчетныхЗаписейДокументооборота.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.УчетнаяЗапись = Объект.Ссылка;
				МенеджерЗаписи.Пользователь = ТекущийПользователь;
				МенеджерЗаписи.Записать(Истина);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	УстановитьИндексУчетнойЗаписи(Объект);
	
	//#Если ТолстыйКлиентОбычноеПриложение Тогда
	//Оповестить("Изменение учетной записи налогоплательщика", Объект.Ссылка);
	//#КонецЕсли
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ОРГАНИЗАЦИИ

Процедура ПриЗаписиОрганизации(Объект, Отказ)
	
	// при изменении данных по организации возможно изменение параметров автообмена (ДОсКО)
	УстановитьИндексУчетнойЗаписи(Объект);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ АВТОМАТИЧЕСКОГО ОБМЕНА С КОНТРОЛИРУЮЩИМИ ОРГАНАМИ

//Не полный аналог ПолучитьСообщенияДляОтправки из ДокументооборотСКО
//
Функция ЕстьСообщенияДляОтправки(УчетнаяЗапись)
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	                      |	КОЛИЧЕСТВО(ДокументТранспортноеСообщение.Ссылка) КАК Ссылка
	                      |ИЗ
	                      |	Документ.ТранспортноеСообщение КАК ДокументТранспортноеСообщение
	                      |ГДЕ
	                      |	ДокументТранспортноеСообщение.Статус = &Статус
	                      |	И НЕ ДокументТранспортноеСообщение.ПометкаУдаления
	                      |	И ДокументТранспортноеСообщение.УчетнаяЗапись = &УчетнаяЗапись
	                      |	И ДокументТранспортноеСообщение.Тип В(&ТипыАвтоотправляемыхСообщений)
	                      |	И ДокументТранспортноеСообщение.ЦиклОбмена.ДатаЗакрытия = &ДатаЗакрытия
	                      |	И НЕ ДокументТранспортноеСообщение.ЦиклОбмена.ПометкаУдаления");
	
	Запрос.УстановитьПараметр("Статус", Перечисления.СтатусыПисем.Исходящее);
	Запрос.УстановитьПараметр("УчетнаяЗапись", УчетнаяЗапись);
	Запрос.УстановитьПараметр("ДатаЗакрытия", ПолучитьПустуюДатуЗавершенияЦиклаОбмена());
	
	ТипыАвтоотправляемыхСообщений = Новый Массив;
	
	// ПФР
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР);
	
	// ФНС 534
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП);
	
	// Росстат
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС);

	Запрос.УстановитьПараметр("ТипыАвтоотправляемыхСообщений", ТипыАвтоотправляемыхСообщений);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Возврат НЕ РезультатЗапроса.Пустой();
	
КонецФункции

Процедура УстановитьИндексУчетнойЗаписи(Объект)
	
	КодОбластиДанных = ОбщегоНазначения.ЗначениеРазделителяСеанса();
	Если КодОбластиДанных = 0 Тогда 
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	Если ТипЗнч(Объект) = Тип("ДокументОбъект.ТранспортноеСообщение") Тогда 
		
		ЦиклОбмена = Объект.ЦиклОбмена;
		
		УникальныйИдентификаторУчетнойЗаписи = Строка(Объект.УчетнаяЗапись.УникальныйИдентификатор());
		
		НаборЗаписей = РегистрыСведений.ИндексУчетныхЗаписейДокументооборота.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ОбластьДанныхВспомогательныеДанные.Установить(КодОбластиДанных);
		НаборЗаписей.Отбор.УникальныйИдентификаторУчетнойЗаписи.Установить(УникальныйИдентификаторУчетнойЗаписи);
		
		НаборЗаписей.Прочитать();
		
		Для Каждого Запись Из НаборЗаписей Цикл
			// Изменение данных полей записи.
			Запись.ТребуетсяОтправка = ЕстьСообщенияДляОтправки(Объект.УчетнаяЗапись);
		КонецЦикла;
		
		НаборЗаписей.Записать();
		
		УстановитьПривилегированныйРежим(Ложь);
		// для ТС 
		Возврат;
		
	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникОбъект.УчетныеЗаписиДокументооборота") Тогда 
		
		УчетнаяЗаписьСсылка = Объект.Ссылка;
		
	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникОбъект.Организации") Тогда 
		
		УчетнаяЗаписьСсылка = Объект.УчетнаяЗаписьОбмена;
		
	КонецЕсли;
	
	Если УчетнаяЗаписьСсылка = Неопределено Тогда 
		Возврат;
	КонецЕсли;
	
	УчетнаяЗаписьВключена = ЭлектронныйДокументооборотИспользуется(УчетнаяЗаписьСсылка);
	ОтключитьАвтообмен = УчетнаяЗаписьСсылка.ОтключитьАвтообмен;
	УникальныйИдентификаторУчетнойЗаписи = Строка(УчетнаяЗаписьСсылка.УникальныйИдентификатор());
	
	НаборЗаписей = РегистрыСведений.ИндексУчетныхЗаписейДокументооборота.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.УникальныйИдентификаторУчетнойЗаписи.Установить(УникальныйИдентификаторУчетнойЗаписи);
	НаборЗаписей.Отбор.ОбластьДанныхВспомогательныеДанные.Установить(КодОбластиДанных);
	
	Если НЕ ОтключитьАвтообмен И УчетнаяЗаписьВключена Тогда 
		
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.ОбластьДанныхВспомогательныеДанные	 = КодОбластиДанных;
		НоваяЗапись.УникальныйИдентификаторУчетнойЗаписи = УникальныйИдентификаторУчетнойЗаписи;
		НоваяЗапись.НаименованиеУчетнойЗаписи			 = УчетнаяЗаписьСсылка.Наименование;
		НоваяЗапись.СерверSMTP							 = УчетнаяЗаписьСсылка.СерверSMTP;
		НоваяЗапись.ПортSMTP							 = УчетнаяЗаписьСсылка.ПортSMTP;
		НоваяЗапись.ТребуетсяSMTPАутентификация			 = УчетнаяЗаписьСсылка.ТребуетсяSMTPАутентификация;
		НоваяЗапись.ИмяПользователяSMTP					 = УчетнаяЗаписьСсылка.ИмяПользователяSMTP;
		НоваяЗапись.ПарольSMTP							 = УчетнаяЗаписьСсылка.ПарольSMTP;
		НоваяЗапись.СерверPOP3							 = УчетнаяЗаписьСсылка.СерверPOP3;
		НоваяЗапись.ПортPOP3							 = УчетнаяЗаписьСсылка.ПортPOP3;
		НоваяЗапись.ИмяПользователяPOP3					 = УчетнаяЗаписьСсылка.ИмяПользователяPOP3;
		НоваяЗапись.ПарольPOP3							 = УчетнаяЗаписьСсылка.ПарольPOP3;
		НоваяЗапись.ТребуетсяОтправка					 = ЕстьСообщенияДляОтправки(УчетнаяЗаписьСсылка);
		
	КонецЕсли;
	
	НаборЗаписей.Записать();
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ПОЧТОВОГО СЕРВЕРА

Процедура ПередЗаписьюПочтовогоСервера(Объект, Отказ)
	
	Если ПустаяСтрока(Объект.АдресЭлектроннойПочтыФНС) И ПустаяСтрока(Объект.АдресЭлектроннойПочтыПФР) И ПустаяСтрока(Объект.АдресЭлектроннойПочтыФСГС)Тогда
		//ОбщегоНазначения.СообщитьОбОшибке("Не задан ни один из адресов электронной почты сервера документооборота.", Отказ, ШапкаОшибки);
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Не удалось записать элемент справочника ""Серверы документооборота"" %1:%2'"),
			?(ПустаяСтрока(Объект.Наименование), "<наименование не задано>", СокрЛП(Объект.Наименование)),
			Символы.ПС + НСтр("ru = 'Не задан ни один из адресов электронной почты сервера документооборота.'"));
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Отказ = Истина;
	КонецЕсли;
	
	Если НЕ Отказ Тогда
		Объект.АдресЭлектроннойПочтыФНС = нрег(Объект.АдресЭлектроннойПочтыФНС);
		Объект.АдресЭлектроннойПочтыПФР = нрег(Объект.АдресЭлектроннойПочтыПФР);
		Объект.АдресЭлектроннойПочтыФСГС = нрег(Объект.АдресЭлектроннойПочтыФСГС);
		Если НЕ ЗначениеЗаполнено(Объект.ДлительностьОжиданияСервера) Тогда
			Объект.ДлительностьОжиданияСервера = 60;
		КонецЕсли;
		СгенерироватьНаименованиеПочтовогоСервера(Объект);
	КонецЕсли;
	
КонецПроцедуры

Процедура СгенерироватьНаименованиеПочтовогоСервера(Объект, Обязательно = Ложь) Экспорт
	
	Если ПустаяСтрока(Объект.Наименование) Тогда
		
		СтрАдрес = Объект.АдресЭлектроннойПочтыФНС;
		ВхождениеА = Найти(СтрАдрес, "@");
		Если ВхождениеА = 0 Тогда
			СтрАдрес = Объект.АдресЭлектроннойПочтыПФР;
			ВхождениеА = Найти(СтрАдрес, "@");
		КонецЕсли;
		
		Если ВхождениеА <> 0 Тогда
			ДоменСервера = СокрЛП(Сред(СтрАдрес, ВхождениеА + 1));
			Если НЕ ПустаяСтрока(ДоменСервера) Тогда
				Объект.Наименование = "Сервер документооборота " + ДоменСервера;
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Если Обязательно Тогда
		Объект.Наименование = ?(ПустаяСтрока(Объект.АдресЭлектроннойПочтыФНС), СокрЛП(Объект.АдресЭлектроннойПочтыПФР), СокрЛП(Объект.АдресЭлектроннойПочтыФНС));
	КонецЕсли;
	
КонецПроцедуры

Функция ПрочитатьТекстИзФайла(ИмяФайла, _КодировкаТекста = Неопределено, АвтоопределениеКодировкиXML = Ложь) Экспорт
	
	Если ЭтоАдресВременногоХранилища(ИмяФайла) Тогда
		ИмяФайлаНаДиске = ПолучитьИмяВременногоФайла();
		ПолучитьИзВременногоХранилища(ИмяФайла).Записать(ИмяФайлаНаДиске);
	Иначе
		ИмяФайлаНаДиске = ИмяФайла;
	КонецЕсли;
	
	ОбъектЧтение = Новый ЧтениеТекста(ИмяФайлаНаДиске, _КодировкаТекста);
	ТекстИзФайла = ОбъектЧтение.Прочитать();
	ОбъектЧтение.Закрыть();
	
	Если АвтоопределениеКодировкиXML И ЗначениеЗаполнено(ТекстИзФайла) Тогда
		ПерваяСтрокаФайла = ВРЕГ(Лев(СтрПолучитьСтроку(ТекстИзФайла, 1), 100));
		Если Найти(ПерваяСтрокаФайла, ВРЕГ("encoding=""UTF-8""")) <> 0 Тогда
			ТекстИзФайла = ПрочитатьТекстИзФайла(ИмяФайла, КодировкаТекста.UTF8);
		ИначеЕсли Найти(ПерваяСтрокаФайла, ВРЕГ("encoding=""UTF-16""")) <> 0 Тогда
			ТекстИзФайла = ПрочитатьТекстИзФайла(ИмяФайла, КодировкаТекста.UTF16);
		КонецЕсли;
	КонецЕсли;
	
	Возврат ТекстИзФайла;
	
КонецФункции

////////////////////////////////////////////////////
//
// АВТОМАТИЧЕСКИЙ ОБМЕН С КОНТРОЛИРУЮЩИМИ ОРГАНАМИ
//

Процедура АвтообменСКО(КодОбластиДанных,
					   УникальныйИдентификаторУчетнойЗаписи,
					   НаименованиеУчетнойЗаписи,
					   СерверSMTP,
					   ПортSMTP,
					   ТребуетсяSMTPАутентификация,
					   ИмяПользователяSMTP,
					   ПарольSMTP,
					   СерверPOP3,
					   ПортPOP3,
					   ИмяПользователяPOP3,
					   ПарольPOP3) Экспорт
					   
	Если КодОбластиДанных <> 0 Тогда 
	    ВойтиВОбластьДанных(КодОбластиДанных);
	КонецЕсли;
	
	ДокументооборотСКО.НачатьСеансДокументооборотаСКО(Перечисления.ИнициаторыСеансовСвязиСКонтролирующимиОрганами.Автообмен, УникальныйИдентификаторУчетнойЗаписи);
	
	// Создаем почтовый профиль
	ПочтовыйПрофиль = Новый ИнтернетПочтовыйПрофиль;
	ПочтовыйПрофиль.POP3ПередSMTP = Истина;
	
	ПочтовыйПрофиль.АутентификацияPOP3 = СпособPOP3Аутентификации.Обычная;
	ПочтовыйПрофиль.АдресСервераPOP3 = СерверPOP3;
	ПочтовыйПрофиль.Пароль = ПарольPOP3;
	ПочтовыйПрофиль.Пользователь = ИмяПользователяPOP3;
	Если ПортPOP3 <> 0 Тогда // по умолчанию - 110
		ПочтовыйПрофиль.ПортPOP3 = ПортPOP3;
	КонецЕсли;
	
	ПочтовыйПрофиль.АдресСервераSMTP = СерверSMTP;
	Если ТребуетсяSMTPАутентификация Тогда
		ПочтовыйПрофиль.АутентификацияSMTP = СпособSMTPАутентификации.Login;
		ПочтовыйПрофиль.ПарольSMTP = ПарольSMTP;
		ПочтовыйПрофиль.ПользовательSMTP = ИмяПользователяSMTP;
	Иначе
		ПочтовыйПрофиль.АутентификацияSMTP = СпособSMTPАутентификации.БезАутентификации;
	КонецЕсли;
	Если ПортSMTP <> 0 Тогда // по умолчанию - 25
		ПочтовыйПрофиль.ПортSMTP = ПортSMTP;
	КонецЕсли;
	
	//
	// подключаемся к серверу
	ИнтернетПочта = ПодключитьсяКПочтовомуСерверу(ПочтовыйПрофиль);
	Если ИнтернетПочта = Неопределено Тогда
		
		ТекстСообщенияОбОшибке =
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = '%1%2. Не удалось подключиться к почтовому серверу!
					 |SMTP: %3/POP3: %4'"),
					?(КодОбластиДанных <> 0, "Область данных: " + Строка(КодОбластиДанных) + ". ", ""),
					"Учетная запись: " + НаименованиеУчетнойЗаписи,
					СерверSMTP,
					СерверPOP3);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщенияОбОшибке);
		
		ДокументооборотСКО.ЗакончитьСеансДокументооборотаСКО(УникальныйИдентификаторУчетнойЗаписи, Ложь);
		Возврат;
	КонецЕсли;
	
	// выбираем сообщения с сервера
	Попытка
		ИнтернетПочтовыеСообщения = ИнтернетПочта.Выбрать(Истина);
	Исключение
		ТекстСообщенияОбОшибке =
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = '%1%2. Не удалось получить сообщения под учетной записью %3!
				 |%4'"),
				?(КодОбластиДанных <> 0, "Область данных: " + Строка(КодОбластиДанных) + ". ", ""),
				"Учетная запись: " + НаименованиеУчетнойЗаписи,
				 Символ(34) + НаименованиеУчетнойЗаписи + Символ(34),
				 ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщенияОбОшибке);
		ОтключитьсяОтПочтовогоСервера(ИнтернетПочта);
		ДокументооборотСКО.ЗакончитьСеансДокументооборотаСКО(УникальныйИдентификаторУчетнойЗаписи, Ложь);
		Возврат;
	КонецПопытки;
	
	// обрабатываем входящие сообщения
	КоличествоСообщений = ИнтернетПочтовыеСообщения.Количество();
	
	Если КоличествоСообщений > 0 Тогда
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = '%1%2. Сообщений на сервере: %3.'"),
			?(КодОбластиДанных <> 0, "Область данных: " + Строка(КодОбластиДанных) + ". ", ""),
			"Учетная запись: " + НаименованиеУчетнойЗаписи,
			Формат(КоличествоСообщений, "ЧГ="));
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Информация, ТекстСообщения);
				
		// инициализируем массив результата
		СообщенияРезультат = Новый Массив;
		
		// получаем с сервера и сохраняем без распознания
		Для ИндексСообщения = 1 По КоличествоСообщений Цикл
			
			// выбираем сообщение
			ИнтернетПочтовоеСообщение = ИнтернетПочтовыеСообщения[ИндексСообщения - 1];
			
			// ищем сообщение по уникальному идентификатору
			ИдентификаторСообщения = ИнтернетПочтовоеСообщение.ИдентификаторСообщения;
			СуществующееСообщение = Документы.ТранспортноеСообщение.НайтиПоРеквизиту("ИдентификаторСообщения", ИдентификаторСообщения);
			Если СуществующееСообщение <> Документы.ТранспортноеСообщение.ПустаяСсылка() Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = '%1%2. В почтовом ящике обнаружено уже принимавшееся сообщение: %3.
								|Сообщение проигнорировано.'"),
								?(КодОбластиДанных <> 0, "Область данных: " + Строка(КодОбластиДанных) + ". ", ""),
								"Учетная запись: " + НаименованиеУчетнойЗаписи,
								Символ(34) + СуществующееСообщение.Тема + Символ(34));
				ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Информация, ТекстСообщения);
				Продолжить;
			КонецЕсли;
			
			// создаем документ в информационной базе
			Сообщение = Документы.ТранспортноеСообщение.СоздатьДокумент();
			
			// инициализируем учетную запись
			УчетнаяЗапись = Справочники.УчетныеЗаписиДокументооборота.ПолучитьСсылку(Новый УникальныйИдентификатор(УникальныйИдентификаторУчетнойЗаписи));
			Сообщение.УчетнаяЗапись = УчетнаяЗапись;
			
			// устанавливаем статус
			Сообщение.Статус = Перечисления.СтатусыПисем.Полученное;
			
			// устанавливаем тему
			Сообщение.Тема = СокрЛП(ИнтернетПочтовоеСообщение.Тема);
			
			// устанавливаем идентификатор сообщения
			Сообщение.ИдентификаторСообщения = ИнтернетПочтовоеСообщение.ИдентификаторСообщения;
			
			// инициализируем дату отправления сообщения
			Сообщение.ДатаТранспорта = ИнтернетПочтовоеСообщение.ДатаПолучения;
			
			// инициализируем дату получения 
			Сообщение.Дата = ИнтернетПочтовоеСообщение.ДатаОтправления;
			
			// устанавливаем кодировку
			Сообщение.Кодировка = ИнтернетПочтовоеСообщение.Кодировка;
			
			// устанавливаем атрибуты отправителя
			Сообщение.ОтКогоАдрес = ИнтернетПочтовоеСообщение.Отправитель.Адрес;
			Сообщение.ОтКогоПредставление = ИнтернетПочтовоеСообщение.Отправитель.ОтображаемоеИмя;
			
			// инициализируем получателей
			Для ИндАдреса = 0 По ИнтернетПочтовоеСообщение.Получатели.Количество() - 1 Цикл
				АдресFrom = ИнтернетПочтовоеСообщение.Получатели.Получить(ИндАдреса);
				НовыйПолучатель = Сообщение.Кому.Добавить();
				НовыйПолучатель.АдресЭлектроннойПочты = АдресFrom.Адрес;
				НовыйПолучатель.Представление = АдресFrom.ОтображаемоеИмя;
			КонецЦикла;
			
			// инициализируем копии
			Для ИндАдреса = 0 По ИнтернетПочтовоеСообщение.Копии.Количество() - 1 Цикл
				АдресCC = ИнтернетПочтовоеСообщение.Копии.Получить(ИндАдреса);
				НовыйПолучатель = Сообщение.Копии.Добавить();
				НовыйПолучатель.АдресЭлектроннойПочты = АдресCC.Адрес;
				НовыйПолучатель.Представление = АдресCC.ОтображаемоеИмя;
			КонецЦикла;
			
			// устанавливаем текст сообщения
			ТекстПисьмаPlain = "";
			ТекстПисьмаRichText = "";
			ТекстПисьмаHTML = "";
			Для ИндТекста = 0 По ИнтернетПочтовоеСообщение.Тексты.Количество() - 1 Цикл
				
				ТекстПочтовогоСообщения = ИнтернетПочтовоеСообщение.Тексты.Получить(ИндТекста);
				ТекстСообщения = ТекстПочтовогоСообщения.Текст;
				ТипТекстаСообщения = ТекстПочтовогоСообщения.ТипТекста;
				
				Если ТипТекстаСообщения = ТипТекстаПочтовогоСообщения.HTML Тогда
					ТекстПисьмаHTML = ТекстСообщения;
					Прервать;
				КонецЕсли;
				Если ТипТекстаСообщения = ТипТекстаПочтовогоСообщения.ПростойТекст Тогда
					ТекстПисьмаPlain = ТекстСообщения;
					Прервать;
				КонецЕсли;
				Если ТипТекстаСообщения = ТипТекстаПочтовогоСообщения.РазмеченныйТекст Тогда
					ТекстПисьмаRichText = ТекстСообщения;
					Прервать;
				КонецЕсли;
				
			КонецЦикла;
			
			Если ТекстПисьмаPlain = "" Тогда
				Если ТекстПисьмаRichText = "" Тогда
					Если ТекстПисьмаHTML <> "" Тогда
						Сообщение.ТекстПисьма = ТекстПисьмаHTML;
					Иначе
						Сообщение.ТекстПисьма = "";
					КонецЕсли;
				Иначе
					Сообщение.ТекстПисьма = ТекстПисьмаRichText;
				КонецЕсли;
			Иначе
				Сообщение.ТекстПисьма = ТекстПисьмаPlain;
			КонецЕсли;
			
			// заполняем дополнительные реквизиты заголовка
			// - имя передающей системы
			ИмяПередающейСистемы = ИнтернетПочтовоеСообщение.ПолучитьПолеЗаголовка("X-Tax-System", "");
			Если ЗначениеЗаполнено(ИмяПередающейСистемы) Тогда
				НовРеквизит = Сообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
				НовРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИмяПередающейСистемы;
				НовРеквизит.Значение = ИмяПередающейСистемы;
			КонецЕсли;
			
			// - тип передаваемой информации
			ТипПередаваемогоКонтейнера = ИнтернетПочтовоеСообщение.ПолучитьПолеЗаголовка("X-Tax-Type", "");
			Если ЗначениеЗаполнено(ТипПередаваемогоКонтейнера) Тогда
				НовРеквизит = Сообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
				НовРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ТипПередаваемойИнформации;
				НовРеквизит.Значение = ТипПередаваемогоКонтейнера;
			КонецЕсли;
			
			// - идентификатор получателя
			ИдентификаторПолучателя = ИнтернетПочтовоеСообщение.ПолучитьПолеЗаголовка("X-Tax-Reciever", "");
			Если ЗначениеЗаполнено(ИдентификаторПолучателя) Тогда
				НовРеквизит = Сообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
				НовРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторПолучателя;
				НовРеквизит.Значение = ИдентификаторПолучателя;
			КонецЕсли;
			
			// - идентификатор отправителя
			ИдентификаторОтправителя = ИнтернетПочтовоеСообщение.ПолучитьПолеЗаголовка("X-Tax-Sender", "");
			Если ЗначениеЗаполнено(ИдентификаторОтправителя) Тогда
				НовРеквизит = Сообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
				НовРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторОтправителя;
				НовРеквизит.Значение = ИдентификаторОтправителя;
			КонецЕсли;
			
			// - первичный идентификатор сообщения
			ПервичныйИдентификаторСообщения = ИнтернетПочтовоеСообщение.ПолучитьПолеЗаголовка("X-Message-ID:", "");
			Если ЗначениеЗаполнено(ПервичныйИдентификаторСообщения) Тогда
				НовРеквизит = Сообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
				НовРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторПервичногоСообщения;
				НовРеквизит.Значение = УдалитьЛидирующееДвоеточие(ПервичныйИдентификаторСообщения);
			КонецЕсли;
			
			// пытаемся записать
			Попытка
				Сообщение.Записать();
			Исключение
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось сохранить входящее сообщение %1 в информационной базе!%2'"),
					ПредставлениеСообщения(Сообщение), Символы.ПС + ИнформацияОбОшибке().Описание);
				ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
				Продолжить;
			КонецПопытки;
			
			// разбираем вложения
			КоличествоВложений = ИнтернетПочтовоеСообщение.Вложения.Количество();
			Для Инд = 0 По КоличествоВложений - 1 Цикл
				
				Попытка
					ПочтовоеВложение = ИнтернетПочтовоеСообщение.Вложения.Получить(Инд);
				Исключение
					ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
						НСтр("ru = '%1%2. Не удалось получить вложение %3 для сообщения %4!'"),
						?(КодОбластиДанных <> 0, "Область данных: " + Строка(КодОбластиДанных) + ". ", ""),
						"Учетная запись: " + НаименованиеУчетнойЗаписи,
						Инд,
						ПредставлениеСообщения(Сообщение));
					ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
					Продолжить;
				КонецПопытки;
				
				ДобавитьТранспортныйКонтейнер(Сообщение.Ссылка, ПочтовоеВложение.Данные, ПочтовоеВложение.ИмяФайла);
				
			КонецЦикла; // конец цикла разбора вложений
			
			СообщенияРезультат.Добавить(Сообщение.Ссылка);
			
		КонецЦикла;
		
		// распознаем полученные сообщения
		Для Каждого ПринятоеСообщение Из СообщенияРезультат Цикл
			ОбъектСообщение = ПринятоеСообщение.ПолучитьОбъект();
			РаспознатьТранспортноеСообщение(ОбъектСообщение);
			ОбновитьСтатусыСвязанногоОбъектаПриНеобходимости(ПринятоеСообщение, Истина);
		КонецЦикла;
		
		// фиксируем Свойства транспортных сообщений
		ЗаполнитьСвойстваТранспортныхСообщений(СообщенияРезультат);
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = '%1%2. Получено сообщений: %3.'"),
			?(КодОбластиДанных <> 0, "Область данных: " + Строка(КодОбластиДанных) + ". ", ""),
			"Учетная запись: " + НаименованиеУчетнойЗаписи,
			Формат(КоличествоСообщений, "ЧГ="));
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Информация, ТекстСообщения);
			
	КонецЕсли;
	
	Если КодОбластиДанных <> 0 Тогда 
		// вход в ОД мог быть не выполнен, если не было входящих
		ОсуществленВходВОбластьДанных = ОсуществленВходВОбластьДанных();
		//ЗначениеРазделителяСеанса = ОбщегоНазначения.ЗначениеРазделителяСеанса();
		
		//Если ОсуществленВходВОбластьДанных И ЗначениеРазделителяСеанса = КодОбластиДанных Тогда 
		Если НЕ ОсуществленВходВОбластьДанных Тогда 
			ВойтиВОбластьДанных(КодОбластиДанных);
		КонецЕсли;
	КонецЕсли;
	
	// если требуется отправка, выполняем
	СообщенияДляОтправки = ПолучитьСообщенияДляОтправки(КодОбластиДанных, УникальныйИдентификаторУчетнойЗаписи);
	Если СообщенияДляОтправки <> Неопределено Тогда 
		КоличествоКОтправке = СообщенияДляОтправки.Количество();
		КоличествоОтправленных = 0;
		КоличествоНеОтправленных = 0;
		Пока СообщенияДляОтправки.Следующий() Цикл
			
			Если ОтправитьТранспортноеСообщение(СообщенияДляОтправки.Ссылка, ИнтернетПочта) Тогда
				КоличествоОтправленных = КоличествоОтправленных + 1;
			Иначе
				КоличествоНеОтправленных = КоличествоНеОтправленных + 1;
			КонецЕсли;
			
		КонецЦикла;
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Отправлено сообщений: %1 из %2.'"),
			КоличествоОтправленных, КоличествоОтправленных + КоличествоНеОтправленных);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Информация, ТекстСообщения);
		
		Если (КоличествоКОтправке = КоличествоНеОтправленных) И (КодОбластиДанных <> 0) Тогда 
			ПодтвердитьОтправку(КодОбластиДанных, УникальныйИдентификаторУчетнойЗаписи);
		КонецЕсли;
		
	КонецЕсли;
	
	ОтключитьсяОтПочтовогоСервера(ИнтернетПочта);
	
	Если КодОбластиДанных <> 0 Тогда 
		ВыйтиИзОбластиДанных();
	КонецЕсли;
	
	ДокументооборотСКО.ЗакончитьСеансДокументооборотаСКО(УникальныйИдентификаторУчетнойЗаписи, Ложь);
	
КонецПроцедуры

Процедура ВыполнитьОбменСКОПоРегламентномуЗаданию() Экспорт 
		
	РежимРазделения = ОбщегоНазначенияПовтИсп.РазделениеВключено();
	
	Если РежимРазделения Тогда 
		// Обращаемся к регистру сведений
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		               |	ИндексУчетныхЗаписейДокументооборота.ОбластьДанныхВспомогательныеДанные КАК КодОбластиДанных,
		               |	ИндексУчетныхЗаписейДокументооборота.УникальныйИдентификаторУчетнойЗаписи,
		               |	ИндексУчетныхЗаписейДокументооборота.НаименованиеУчетнойЗаписи,
		               |	ИндексУчетныхЗаписейДокументооборота.СерверSMTP,
		               |	ИндексУчетныхЗаписейДокументооборота.ПортSMTP,
		               |	ИндексУчетныхЗаписейДокументооборота.ТребуетсяSMTPАутентификация,
		               |	ИндексУчетныхЗаписейДокументооборота.ИмяПользователяSMTP,
		               |	ИндексУчетныхЗаписейДокументооборота.ПарольSMTP,
		               |	ИндексУчетныхЗаписейДокументооборота.СерверPOP3,
		               |	ИндексУчетныхЗаписейДокументооборота.ПортPOP3,
		               |	ИндексУчетныхЗаписейДокументооборота.ИмяПользователяPOP3,
		               |	ИндексУчетныхЗаписейДокументооборота.ПарольPOP3,
		               |	ИндексУчетныхЗаписейДокументооборота.ТребуетсяОтправка
		               |ИЗ
		               |	РегистрСведений.ИндексУчетныхЗаписейДокументооборота КАК ИндексУчетныхЗаписейДокументооборота";
		
		УстановитьПривилегированныйРежим(Истина);
		Результат = Запрос.Выполнить().Выгрузить();
		УстановитьПривилегированныйРежим(Ложь);
		
	Иначе
		// Данные берутся из справочника
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		               |	0 КАК КодОбластиДанных,
		               |	УчетныеЗаписиДокументооборота.Ссылка КАК УчетнаяЗапись,
		               |	ВЫРАЗИТЬ("""" КАК СТРОКА(36)) КАК УникальныйИдентификаторУчетнойЗаписи,
		               |	УчетныеЗаписиДокументооборота.Наименование КАК НаименованиеУчетнойЗаписи,
		               |	УчетныеЗаписиДокументооборота.СерверSMTP,
		               |	УчетныеЗаписиДокументооборота.ПортSMTP,
		               |	УчетныеЗаписиДокументооборота.ТребуетсяSMTPАутентификация,
		               |	УчетныеЗаписиДокументооборота.ИмяПользователяSMTP,
		               |	УчетныеЗаписиДокументооборота.ПарольSMTP,
		               |	УчетныеЗаписиДокументооборота.СерверPOP3,
		               |	УчетныеЗаписиДокументооборота.ПортPOP3,
		               |	УчетныеЗаписиДокументооборота.ИмяПользователяPOP3,
		               |	УчетныеЗаписиДокументооборота.ПарольPOP3
		               |ИЗ
		               |	Справочник.УчетныеЗаписиДокументооборота КАК УчетныеЗаписиДокументооборота
		               |ГДЕ
		               |	НЕ УчетныеЗаписиДокументооборота.ОтключитьАвтообмен";
		
		Результат = Запрос.Выполнить().Выгрузить();
		
		Для Каждого СтрокаРезультата ИЗ Результат Цикл
			СсылкаНаОбъект = СтрокаРезультата.УчетнаяЗапись;
			СтрокаРезультата.УникальныйИдентификаторУчетнойЗаписи = Строка(СсылкаНаОбъект.УникальныйИдентификатор());
		КонецЦикла;
		
	КонецЕсли;
	
	Если РежимРазделения Тогда
		ТекущаяОбласть = Неопределено;
	КонецЕсли;
	
	ТаблицаЗаданий = ПолучитьТаблицуЗаданий(Результат);
	
	МаксЧислоЗаданий = 50;
	
	// Проверяем количество уже запущенных заданий
	СтруктураОтбора = Новый Структура("ИмяМетода, Состояние", "ДокументооборотСКОВызовСервера.АвтообменСКО", СостояниеФоновогоЗадания.Активно);
	ЗапущенныеЗадания = ФоновыеЗадания.ПолучитьФоновыеЗадания(СтруктураОтбора);
	
	Пока Истина Цикл
		
		УдалитьВыполненныеЗадания(ЗапущенныеЗадания);
		
		Для Счетчик = 1 По МаксЧислоЗаданий - ЗапущенныеЗадания.Количество() Цикл
			Для Каждого СтрокаЗаданий Из ТаблицаЗаданий Цикл
				Если СтрокаЗаданий.Процесс = Неопределено Тогда
					ПараметрыЗадания = ПолучитьПараметрыЗадания(СтрокаЗаданий);
					ЗапущенноеЗадание = ФоновыеЗадания.Выполнить("ДокументооборотСКОВызовСервера.АвтообменСКО", ПараметрыЗадания);
					СтрокаЗаданий.Процесс = ЗапущенноеЗадание;
					ЗапущенныеЗадания.Добавить(ЗапущенноеЗадание);
					Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЦикла;
		
		ВсеЗапущены = Истина;
		Для Каждого СтрокаЗаданий Из ТаблицаЗаданий Цикл
			Если СтрокаЗаданий.Процесс = Неопределено Тогда
				ВсеЗапущены = Ложь;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если ВсеЗапущены Тогда 
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

//
Функция ОтправитьТранспортноеСообщение(Сообщение, Почта = Неопределено, ТихийРежим = Ложь) Экспорт
	
	///////////////////////////////////////////////////////////////////////////////
	// Инициализация переменных
	
	// инициализируем флаг ошибки
	ПризнакОшибки = Ложь;
	
	// инициализируем объект-сообщение и ссылку на сообщение, используемые в ниже по тексту
	Если ТипЗнч(Сообщение) = Тип("ДокументСсылка.ТранспортноеСообщение") Тогда
		ОбъектСообщение = Сообщение.ПолучитьОбъект();
	Иначе
		ОбъектСообщение = Сообщение;
	КонецЕсли;
	СообщениеСсылка = ОбъектСообщение.Ссылка;
	
	// Инициализация переменных
	///////////////////////////////////////////////////////////////////////////////
	
	// полученные сообщения не отправляются
	Если ОбъектСообщение.Статус = Перечисления.СтатусыПисем.Полученное Тогда
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Предупреждение, НСтр("ru = 'Отправка полученных сообщений запрещена!'"));
		Возврат Ложь;
	КонецЕсли;
	
	///////////////////////////////////////////////////////////////////////////////
	// Подготавливаем пакет в отправке, при необходимости
	
	// если пакет не сформирован, то пытаемся сформировать
	СообщениеЗашифровано = СообщениеЗашифровано(СообщениеСсылка);
	Если НЕ СообщениеЗашифровано Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Подготавливаем пакет в отправке, при необходимости
	///////////////////////////////////////////////////////////////////////////////
	
	// определяем получателя сообщения (to)
	СсылкаПолучатель = ОпределитьПолучателяТранспортногоСообщения(ОбъектСообщение);
	
	///////////////////////////////////////////////////////////////////////////////
	// Разнообразные проверки перед отправкой
	
	// различные проверки
	Если НЕ ЗначениеЗаполнено(ОбъектСообщение.Тип) Тогда
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Предупреждение, 
			НСтр("ru = 'Ошибка отправки транспортного сообщения: тип транспортного сообщения не определен!'"));
		ПризнакОшибки = Истина;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ОбъектСообщение.Отправитель) Тогда
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Предупреждение,
			НСтр("ru = 'Ошибка отправки транспортного сообщения: не задан отправитель!'"));
		ПризнакОшибки = Истина;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(СсылкаПолучатель) Тогда
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка,
			НСтр("ru = 'Ошибка отправки транспортного сообщения: не задан получатель!'"));
		ПризнакОшибки = Истина;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ОбъектСообщение.УчетнаяЗапись) Тогда
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка,
			НСтр("ru = 'Ошибка отправки транспортного сообщения: не задана учетная запись!'"));
		ПризнакОшибки = Истина;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ОбъектСообщение.ЦиклОбмена) Тогда
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка,
			НСтр("ru = 'Ошибка отправки транспортного сообщения: цикл обмена не задан!'"));
		ПризнакОшибки = Истина;
	КонецЕсли;
	
	// если ошибка, то прервемся
	Если ПризнакОшибки Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// сопоставление с аналогичными уже имеющимися отправками и,
	// при необходимости, запрос подтверждения на текущую отправку
	Если НЕ СопоставитьССозданнымиЦикламиОбменаПередОтправкой(СообщениеСсылка) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Разнообразные проверки перед отправкой
	///////////////////////////////////////////////////////////////////////////////
	
	
	///////////////////////////////////////////////////////////////////////////////
	// Инициализация свойств транспортного сообщения,
	// относящихся к заголовку почтового сообщения
	
	// формируем поля от кого
	Если ПустаяСтрока(ОбъектСообщение.ОтКогоАдрес) Тогда
		ОбъектСообщение.ОтКогоАдрес = ОбъектСообщение.УчетнаяЗапись.АдресЭлектроннойПочты;
	КонецЕсли;
	
	Если ПустаяСтрока(ОбъектСообщение.ОтКогоПредставление) Тогда
		// в представление отправителя записываем полное наименование организации-отправителя
		ОбъектСообщение.ОтКогоПредставление = Строка(ОбъектСообщение.Отправитель.НаименованиеПолное);
	КонецЕсли;
	
	// формируем кодировку
	ОбъектСообщение.Кодировка = "Windows-1251";
	
	// формируем поля кому
	Если ОбъектСообщение.Кому.Количество() = 0 Тогда
		
		АдресИПредставлениеПолучателя = ОпределитьАдресИПредставлениеПолучателяТранспортногоСообщения(ОбъектСообщение, СсылкаПолучатель);
		Если ПустаяСтрока(АдресИПредставлениеПолучателя.Адрес) Тогда
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не удалось определить адрес электронной почты получателя %1!'"), СсылкаПолучатель);
			ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстОшибки);
			Возврат Ложь;
		КонецЕсли;
		
		НовыйАдресат = ОбъектСообщение.Кому.Добавить();
		НовыйАдресат.АдресЭлектроннойПочты = АдресИПредставлениеПолучателя.Адрес;
		НовыйАдресат.Представление = АдресИПредставлениеПолучателя.Представление;
		
	КонецЕсли;
	
	// проверка наличия вложений
	Вложения = ПолучитьВложенияТранспортногоСообщения(СообщениеСсылка, Истина);
	
	НеобходимоИнициализироватьXMessageIDИзMessageID = Ложь;
	
	// формируем дополнительные реквизиты заголовка и тему
	Если ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ДекларацияНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-декларация-ДекларацияНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "01";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеДокументНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "04";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП Тогда
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "05";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-заявление-ЗаявлениеНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "01";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеПодтверждениеНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		Если ОбъектСообщение.ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Заявление Тогда
			НовыйДопРеквизит.Значение = "17";
		ИначеЕсли ОбъектСообщение.ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Представление Тогда
			НовыйДопРеквизит.Значение = "08";
		Иначе
			НовыйДопРеквизит.Значение = "11";
		КонецЕсли;
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатПриемаНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "06";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатОбработкиНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "09";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатОбработкиРФНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "09";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеОбОтзывеЗаявлениеРФНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "12";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";

	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатОбработкиТСНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "15";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-форма2НДФЛ-Форма2НДФЛНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "01";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР Тогда
		
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "Pension";
		КонецЕсли;
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР Тогда
		
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "Pension-Unformal";
		КонецЕсли;
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР Тогда
		
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "ReSign: Pension-Unformal";
		КонецЕсли;
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР Тогда
		
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "Pension-Request";
		КонецЕсли;
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР Тогда
		
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "ReSign: Pension-Reply";
		КонецЕсли;
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ОбращениеНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-обращение-ОбращениеНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "01";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-представление-ПредставлениеНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "01";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеПисьмоНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "03";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-извещениеОПолучении-ИзвещениеРассылкаНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "03";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ЗапросНП Тогда
		
		ОбъектСообщение.Тема = "ФНС:1.0-запрос-ЗапросНП";
		
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор);
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Code";
		НовыйДопРеквизит.Значение = "01";
		
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Tax-Version";
		НовыйДопРеквизит.Значение = "ФНС:1.0";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС Тогда
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "Stat";
		КонецЕсли;
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Stat-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор) + "@STAT";
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Msg-Type";
		НовыйДопРеквизит.Значение = "STAT";
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-File-Name";
		НовыйДопРеквизит.Значение = ИзвлечьИмяФайлаОтчетаИзПакета(ОбъектСообщение);
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-File-Type";
		НовыйДопРеквизит.Значение = "Форма";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС Тогда
		
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "ReSign: Stat-Confirmation";
		КонецЕсли;
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Stat-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор) + "@STAT";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС Тогда
		
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "ReSign: Stat-Protocol";
		КонецЕсли;
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Stat-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор) + "@STAT";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС Тогда
		
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "Stat-Unformal";
		КонецЕсли;
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Stat-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор) + "@STAT";
		
	ИначеЕсли ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС Тогда
		
		// формируем тему
		Если ПустаяСтрока(ОбъектСообщение.Тема) Тогда
			ОбъектСообщение.Тема = "ReSign: Stat-Unformal";
		КонецЕсли;
		ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Очистить();
		НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
		НовыйДопРеквизит.Тип = "X-Stat-Message-ID";
		НовыйДопРеквизит.Значение = СокрЛП(ОбъектСообщение.ЦиклОбмена.Идентификатор) + "@STAT";
	
	КонецЕсли;
	
	// Инициализация свойств транспортного сообщения,
	// относящихся к заголовку почтового сообщения
	///////////////////////////////////////////////////////////////////////////////
	
	
	///////////////////////////////////////////////////////////////////////////////
	// Формирование почтового сообщения на основе транспортного сообщения
	// Работа с объектом Почта
	
	// получаем зашифрованный транспортный контейнер
	ОписаниеТранспортныхКонтейнеров = ПолучитьТранспортныйКонтейнер(СообщениеСсылка, Истина);
	Если ОписаниеТранспортныхКонтейнеров.Количество() = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Не удалось отправить транспортное сообщение по причине отсутствия сформированного пакета.'");
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
		Возврат Ложь;
	КонецЕсли;
	ОписаниеТранспортногоКонтейнера = ОписаниеТранспортныхКонтейнеров[0];
	
	// выгружаем на диск зашифрованный транспортный контейнер
	ИмяЗашифрованногоВложения = ОписаниеТранспортногоКонтейнера.ИмяФайла;
	ДанныеЗашифрованногоВложения = ОписаниеТранспортногоКонтейнера.Данные;
	
	// инициализация свойств объекта Письмо
	Письмо = Новый ИнтернетПочтовоеСообщение;
	
	Если ОбъектСообщение.ЦиклОбмена.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФНС Тогда
	
		Если ОбъектСообщение.ЦиклОбмена.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534 Тогда
			
			Письмо.Кодировка = ОбъектСообщение.Кодировка;
			Письмо.Тема = ОбъектСообщение.Тема;
			
			// инициализируем адреса
			СтрКому = ОбъектСообщение.Кому.Получить(0);
			АдресПолучателя = Письмо.Получатели.Добавить(СокрЛП(СтрКому.АдресЭлектроннойПочты));
			АдресПолучателя.ОтображаемоеИмя = СокрЛП(СтрКому.Представление);
			
			ОбратныйАдрес = Письмо.ОбратныйАдрес.Добавить(СокрЛП(ОбъектСообщение.ОтКогоАдрес));
			ОбратныйАдрес.ОтображаемоеИмя = СокрЛП(ОбъектСообщение.ОтКогоПредставление);
			
			Письмо.Отправитель.Адрес = СокрЛП(ОбъектСообщение.ОтКогоАдрес);
			Письмо.Отправитель.ОтображаемоеИмя = СокрЛП(ОбъектСообщение.ОтКогоПредставление);
			
			// сохраняем идентификатор сообщения
			ОбъектСообщение.ИдентификаторСообщения = Письмо.ИдентификаторСообщения;
			
			// дополнительные реквизиты
			Для Каждого ДополнительныйРеквизит Из ОбъектСообщение.ДополнительныеРеквизитыЗаголовка Цикл
				
				Письмо.УстановитьПолеЗаголовка(ДополнительныйРеквизит.Тип,
					ДополнительныйРеквизит.Значение,
					?(СтрокаСодержитРусскиеСимволы(ДополнительныйРеквизит.Значение), 
						СпособКодированияНеASCIIСимволовИнтернетПочтовогоСообщения.MIME, 
						СпособКодированияНеASCIIСимволовИнтернетПочтовогоСообщения.БезКодирования));
				
			КонецЦикла;
			
			// добавляем вложение
			Письмо.Вложения.Добавить(ДанныеЗашифрованногоВложения.Получить(), ИмяЗашифрованногоВложения);
			
		Иначе
			
			Письмо.Кодировка = ОбъектСообщение.Кодировка;
			Письмо.Тема = ОбъектСообщение.Тема;
			
			АдресКому = СокрЛП(ОбъектСообщение.Кому.Получить(0).АдресЭлектроннойПочты);
			Если СтрДлина(АдресКому) > 40 Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Адрес получателя (%1) превышает максимальную допустимую длину в 40 символов.'"), АдресКому);
				ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
				Возврат Ложь;
			КонецЕсли;
			//Почта.ДобавитьАдрес("to", АдресКому, СокрЛП(Лев(ОбъектСообщение.Кому.Получить(0).Представление, 80)));
			АдресПолучателя = Письмо.Получатели.Добавить(АдресКому);
			АдресПолучателя.ОтображаемоеИмя = СокрЛП(Лев(ОбъектСообщение.Кому.Получить(0).Представление, 80));
			
			АдресОтКого = СокрЛП(ОбъектСообщение.ОтКогоАдрес);
			Если СтрДлина(АдресОтКого) > 40 Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Адрес отправителя (%1) превышает максимальную допустимую длину в 40 символов.'"), АдресОтКого);
				ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
				Возврат Ложь;
			КонецЕсли;
			//Почта.ДобавитьАдрес("reply-to", АдресОтКого, СокрЛП(Лев(ОбъектСообщение.ОтКогоПредставление, 80)));
			ОбратныйАдрес = Письмо.ОбратныйАдрес.Добавить(АдресОтКого);
			ОбратныйАдрес.ОтображаемоеИмя = СокрЛП(Лев(ОбъектСообщение.ОтКогоПредставление, 80));
			
			//Почта.ДобавитьАдрес("from", АдресОтКого, СокрЛП(Лев(ОбъектСообщение.ОтКогоПредставление, 80)));
			Письмо.Отправитель.Адрес = АдресОтКого;
			Письмо.Отправитель.ОтображаемоеИмя = СокрЛП(Лев(ОбъектСообщение.ОтКогоПредставление, 80));
			
			// инициализируем X-Message-ID из Message-ID
			Если НеобходимоИнициализироватьXMessageIDИзMessageID Тогда
				НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
				НовыйДопРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторПервичногоСообщения;
				НовыйДопРеквизит.Значение = Письмо.ИдентификаторСообщения;
			КонецЕсли;
			
			// сохраняем идентификатор сообщения
			ОбъектСообщение.ИдентификаторСообщения = Письмо.ИдентификаторСообщения;
			
			// дополнительные реквизиты
			Для Каждого ДополнительныйРеквизит Из ОбъектСообщение.ДополнительныеРеквизитыЗаголовка Цикл
				Если ДополнительныйРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторОтправителя Тогда
					Письмо.УстановитьПолеЗаголовка("X-Tax-Sender", ДополнительныйРеквизит.Значение, 0);
					//Почта.ИдентификаторОтправителя = ДополнительныйРеквизит.Значение;
				ИначеЕсли ДополнительныйРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторПолучателя Тогда
					Письмо.УстановитьПолеЗаголовка("X-Tax-Receiver", ДополнительныйРеквизит.Значение, 0);
					//Почта.ИдентификаторПолучателя = ДополнительныйРеквизит.Значение;
				ИначеЕсли ДополнительныйРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ТипПередаваемойИнформации Тогда
					Письмо.ТипПередаваемогоКонтейнера = ДополнительныйРеквизит.Значение;
				ИначеЕсли ДополнительныйРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИмяПередающейСистемы Тогда
					Письмо.ИмяПередающейСистемы = ДополнительныйРеквизит.Значение;
				ИначеЕсли ДополнительныйРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторПервичногоСообщения Тогда
					Письмо.ПервичныйИдентификаторСообщения = ДополнительныйРеквизит.Значение;
				КонецЕсли;
			КонецЦикла;
			
			//// если сообщение первичное, то проинициализируем реквизит X-Message-ID
			//Если ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ЗапросИОН Тогда
			//	НовыйДопРеквизит = ОбъектСообщение.ДополнительныеРеквизитыЗаголовка.Добавить();
			//	НовыйДопРеквизит.Тип = Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторПервичногоСообщения;
			//	НовыйДопРеквизит.Значение = ОбъектСообщение.ИдентификаторСообщения;
			//КонецЕсли;
			
			// добавляем вложение
			ИмяФайлаВложенияСодержитРусскиеСимволы = СтрокаСодержитРусскиеСимволы(ИмяЗашифрованногоВложения);
			Письмо.Вложения.Добавить(ДанныеЗашифрованногоВложения.Получить(), ИмяЗашифрованногоВложения);
			
			// инициализируем длину транспортного контейнера
			ВремФайлЗашифрованноеВложение = ПолучитьИмяВременногоФайла();
			Попытка
				ДанныеЗашифрованногоВложения.Получить().Записать(ВремФайлЗашифрованноеВложение);
			Исключение
				ТекстСообщения = НСтр("ru = 'Не удалось сохранить во временный файл на диске готовый к отправке, зашифрованный транспортный контейнер!'");
				ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
				Возврат Ложь;
			КонецПопытки;
			ОбъектВремФайл = Новый Файл(ВремФайлЗашифрованноеВложение);
			РазмерЗашифрованногоВложения = ОбъектВремФайл.Размер();
			УдалитьВременныйФайл(ВремФайлЗашифрованноеВложение);
			Письмо.РазмерТранспортногоКонтейнера = РазмерЗашифрованногоВложения;
			
			// проверяем, не превышает ли размер транспортного сообщения 512 МБ
			// вычисления весьма приблизительные и только для вложения
			Если Окр(РазмерЗашифрованногоВложения * 4 / 3) > 512 * 1024 * 1024 Тогда
				ТекстСообщения = НСтр("ru = 'Невозможна отправка транспортного сообщения, размер которого превышает 512 МБ!'");
				ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
				Возврат Ложь;
			КонецЕсли;
			
		КонецЕсли;
		
	ИначеЕсли ОбъектСообщение.ЦиклОбмена.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСПФР Тогда
		
		Письмо.Кодировка = ОбъектСообщение.Кодировка;
		Письмо.Тема = ОбъектСообщение.Тема;
		
		СтрКому = ОбъектСообщение.Кому.Получить(0);
		//Почта.ДобавитьАдрес("to", СокрЛП(СтрКому.АдресЭлектроннойПочты), СокрЛП(СтрКому.Представление));
		АдресПолучателя = Письмо.Получатели.Добавить(СокрЛП(СтрКому.АдресЭлектроннойПочты));
		АдресПолучателя.ОтображаемоеИмя = СокрЛП(Лев(СтрКому.Представление, 80));
		
		//Почта.ДобавитьАдрес("reply-to", СокрЛП(ОбъектСообщение.ОтКогоАдрес), СокрЛП(ОбъектСообщение.ОтКогоПредставление));
		ОбратныйАдрес = Письмо.ОбратныйАдрес.Добавить(СокрЛП(ОбъектСообщение.ОтКогоАдрес));
		ОбратныйАдрес.ОтображаемоеИмя = СокрЛП(ОбъектСообщение.ОтКогоПредставление);
		
		//Почта.ДобавитьАдрес("from", СокрЛП(ОбъектСообщение.ОтКогоАдрес), СокрЛП(ОбъектСообщение.ОтКогоПредставление));
		Письмо.Отправитель.Адрес = СокрЛП(ОбъектСообщение.ОтКогоАдрес);
		Письмо.Отправитель.ОтображаемоеИмя = СокрЛП(ОбъектСообщение.ОтКогоПредставление);
		
		// сохраняем идентификатор сообщения
		ОбъектСообщение.ИдентификаторСообщения = Письмо.ИдентификаторСообщения;
		
		//Письмо.ДобавитьВложение(ДанныеЗашифрованногоВложения.Получить(), ИмяЗашифрованногоВложения, ИмяЗашифрованногоВложения);
		Письмо.Вложения.Добавить(ДанныеЗашифрованногоВложения.Получить(), ИмяЗашифрованногоВложения);
		
	ИначеЕсли ОбъектСообщение.ЦиклОбмена.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФСГС Тогда
		
		Письмо.Кодировка = ОбъектСообщение.Кодировка;
		Письмо.Тема = ОбъектСообщение.Тема;
		
		СтрКому = ОбъектСообщение.Кому.Получить(0);
		//Письмо.ДобавитьАдрес("to", СокрЛП(СтрКому.АдресЭлектроннойПочты), СокрЛП(СтрКому.Представление));
		АдресПолучателя = Письмо.Получатели.Добавить(СокрЛП(СтрКому.АдресЭлектроннойПочты));
		АдресПолучателя.ОтображаемоеИмя = СокрЛП(Лев(СтрКому.Представление, 80));
		
		ОбратныйАдрес = Письмо.ОбратныйАдрес.Добавить(СокрЛП(ОбъектСообщение.ОтКогоАдрес));
		ОбратныйАдрес.ОтображаемоеИмя = СокрЛП(ОбъектСообщение.ОтКогоПредставление);
		
		Письмо.Отправитель.Адрес = СокрЛП(ОбъектСообщение.ОтКогоАдрес);
		Письмо.Отправитель.ОтображаемоеИмя = СокрЛП(ОбъектСообщение.ОтКогоПредставление);
		
		// дополнительные реквизиты
		Для Каждого ДополнительныйРеквизит Из ОбъектСообщение.ДополнительныеРеквизитыЗаголовка Цикл
			Если ДополнительныйРеквизит.Тип = "X-Stat-Message-ID" 
			 ИЛИ ДополнительныйРеквизит.Тип = "X-Msg-Type"
			 ИЛИ ДополнительныйРеквизит.Тип = "X-File-Name"
			 ИЛИ ДополнительныйРеквизит.Тип = "X-File-Type" Тогда
				Письмо.УстановитьПолеЗаголовка(СокрЛП(ДополнительныйРеквизит.Тип), ДополнительныйРеквизит.Значение, 0);
			КонецЕсли;
		КонецЦикла;
		
		// сохраняем идентификатор сообщения
		ОбъектСообщение.ИдентификаторСообщения = Письмо.ИдентификаторСообщения;
		//Письмо.ДобавитьВложение(ДанныеЗашифрованногоВложения.Получить(), ИмяЗашифрованногоВложения, ИмяЗашифрованногоВложения);
		Письмо.Вложения.Добавить(ДанныеЗашифрованногоВложения.Получить(), ИмяЗашифрованногоВложения);
		
		// инициализируем длину транспортного контейнера
		ВремФайлЗашифрованноеВложение = ПолучитьИмяВременногоФайла();
		Попытка
			ДанныеЗашифрованногоВложения.Получить().Записать(ВремФайлЗашифрованноеВложение);
		Исключение
			ТекстСообщения = НСтр("ru = 'Не удалось сохранить во временный файл на диске готовый к отправке, зашифрованный транспортный контейнер!'");
			ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
			Возврат Ложь;
		КонецПопытки;
		ОбъектВремФайл = Новый Файл(ВремФайлЗашифрованноеВложение);
		РазмерЗашифрованногоВложения = ОбъектВремФайл.Размер();
		УдалитьВременныйФайл(ВремФайлЗашифрованноеВложение);
		Письмо.РазмерТранспортногоКонтейнера = РазмерЗашифрованногоВложения;
		// проверяем, не превышает ли размер транспортного сообщения 512 МБ
		// вычисления весьма приблизительные и только для вложения
		Если Окр(РазмерЗашифрованногоВложения * 4 / 3) > 512 * 1024 * 1024 Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Невозможна отправка транспортного сообщения, размер которого превышает 512 МБ!'"));
			Возврат Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	// Формирование почтового сообщения на основе транспортного сообщения
	// Работа с объектом Почта
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Отправка сообщения
	
	Попытка
		Почта.Послать(Письмо);
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
	// Отправка сообщения
	///////////////////////////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////////////////////////
	// Отражение отправки в ИБ
	
	// изменяем статус сообщения
	ОбъектСообщение.Статус = Перечисления.СтатусыПисем.Отправленное;
	
	// определяем дату транспорта
	ОбъектСообщение.ДатаТранспорта = ТекущаяДатаСеанса();
	
	// сохраняем сообщение
	Попытка
		ОбъектСообщение.Записать();
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось записать сообщение %1!%2'"), 
			ПредставлениеСообщения(СообщениеСсылка), 
			Символы.ПС + ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
		Возврат Ложь;
	КонецПопытки;
	
	// Отражение отправки в ИБ
	////////////////////////////////////////////////////////////////////////////4уккккккккккк///
	
	Возврат Истина;
	
КонецФункции

Функция ИзвлечьИмяФайлаОтчетаИзПакета(ОбъектСообщение)
	
	// выгружаем контейнер во временный файл
	ИмяФайлаКонтейнера = ПолучитьИмяВременногоФайла();
	Контейнер = ПолучитьТранспортныйКонтейнер(ОбъектСообщение.Ссылка, Истина);
	Если НЕ ЗначениеЗаполнено(Контейнер) ИЛИ Контейнер.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	Контейнер[0].Данные.Получить().Записать(ИмяФайлаКонтейнера);
	
	// распаковываем файл описания сведений архива
	ИмяФайлаОписанияСведений = "packageDescription.xml";
	ЧтениеЗИП = Новый ЧтениеZipФайла(ИмяФайлаКонтейнера);
	ЭлементОписаниеСведений = ЧтениеЗИП.Элементы.Найти(ИмяФайлаОписанияСведений);
	Если ЭлементОписаниеСведений = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	КаталогРаспаковки = СоздатьВременныйКаталог();
	ЧтениеЗИП.Извлечь(ЭлементОписаниеСведений, КаталогРаспаковки, РежимВосстановленияПутейФайловZIP.НеВосстанавливать);
	
	// читаем XML
	ТекстXML = ПрочитатьТекстИзФайла(КаталогРаспаковки + ИмяФайлаОписанияСведений, , Истина);
	Если НЕ ЗначениеЗаполнено(ТекстXML) Тогда
		ЧтениеЗИП.Закрыть();
		УдалитьВременныйФайл(ИмяФайлаКонтейнера);
		УдалитьВременныйФайл(КаталогРаспаковки);
		Возврат Неопределено;
	КонецЕсли;
	
	// загружаем XML в дерево
	ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(ТекстXML);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		ЧтениеЗИП.Закрыть();
		УдалитьВременныйФайл(ИмяФайлаКонтейнера);
		УдалитьВременныйФайл(КаталогРаспаковки);
		Возврат Неопределено;
	КонецЕсли;
	
	// в случае уведомления об ошибке, источником для получения имени файла отчета должен служить
	// документ описаниеОшибочногоПакета, на который ссылается описание пакета
	Если ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР
	ИЛИ ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС
	ИЛИ ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС
	ИЛИ ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка Тогда
		
		// находим элемент описаниеОшибочногоПакета
		Узлы_ТипДокументаОписаниеОшибочногоПакета = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип, Значение", "типДокумента", "А", "описаниеОшибочногоПакета"), Истина);
		Если Узлы_ТипДокументаОписаниеОшибочногоПакета.Количество() > 0 Тогда
			
			Узел_ОписаниеОшибочногоПакета = Узлы_ТипДокументаОписаниеОшибочногоПакета[0].Родитель;
			
			// ищем в подчинении элемент Содержимое
			УзлыСодержимое = Узел_ОписаниеОшибочногоПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "содержимое", "Э"));
			Если УзлыСодержимое.Количество() > 0 Тогда
				
				// ищем в подчинении атрибут имяФайла
				УзелСодержимое = УзлыСодержимое[0];
				УзлыИмяФайла = УзелСодержимое.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "имяФайла", "А"));
				Если УзлыИмяФайла.Количество() > 0 Тогда
					
					УзелИмяФайла = УзлыИмяФайла[0];
					ИмяФайлаОписанияОшибочногоПакета = СокрЛП(УзелИмяФайла.Значение);
					
					ЭлементОписаниеСведений = ЧтениеЗИП.Элементы.Найти(ИмяФайлаОписанияОшибочногоПакета);
					Если ЭлементОписаниеСведений <> Неопределено Тогда
						
						ЧтениеЗИП.Извлечь(ЭлементОписаниеСведений, КаталогРаспаковки, РежимВосстановленияПутейФайловZIP.НеВосстанавливать);
						
						// распаковываем
						ПолноеИмяФайлаДокумента = РазархивироватьФайл(КаталогРаспаковки + ИмяФайлаОписанияОшибочногоПакета);
						Если ПолноеИмяФайлаДокумента <> Неопределено Тогда
						
							// читаем XML
							ТекстXML = ПрочитатьТекстИзФайла(ПолноеИмяФайлаДокумента, , Истина);
							Если ЗначениеЗаполнено(ТекстXML) Тогда
								
								// загружаем XML в дерево
								_ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(ТекстXML);
								
								// подменяем дерево описания сведений
								Если _ДеревоXML <> Неопределено Тогда
									ДеревоXML = _ДеревоXML;
								КонецЕсли;
								
							КонецЕсли;
							
							УдалитьВременныйФайл(ПолноеИмяФайлаДокумента);
							
						КонецЕсли;
						
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// закрываем архив и удаляем временный файл контейнера
	ЧтениеЗИП.Закрыть();
	УдалитьВременныйФайл(ИмяФайлаКонтейнера);
	УдалитьВременныйФайл(КаталогРаспаковки);
	
	// ищем атрибут "исходноеИмяФайла"
	Узлы_исходноеИмяФайла = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "исходноеИмяФайла", "А"), Истина);
	Если Узлы_исходноеИмяФайла.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// возвращаем первое найденное значение атрибута
	Возврат СокрЛП(Узлы_исходноеИмяФайла[0].Значение);
	
КонецФункции

Функция ПолучитьСообщенияДляОтправки(КодОбластиДанных, УникальныйИдентификаторУчетнойЗаписи)
	
	// в режиме разделения сначала обращаемся к регистру 
	Если КодОбластиДанных <> 0 И ОтправкаНеТребуется(КодОбластиДанных, УникальныйИдентификаторУчетнойЗаписи) Тогда 
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	                      |	ДокументТранспортноеСообщение.Ссылка
	                      |ИЗ
	                      |	Документ.ТранспортноеСообщение КАК ДокументТранспортноеСообщение
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ТранспортныеКонтейнеры КАК ТранспортныеКонтейнеры
	                      |		ПО (ТранспортныеКонтейнеры.ТранспортноеСообщение = ДокументТранспортноеСообщение.Ссылка)
	                      |ГДЕ
	                      |	ДокументТранспортноеСообщение.Статус = &Статус
	                      |	И НЕ ДокументТранспортноеСообщение.ПометкаУдаления
	                      |	И ДокументТранспортноеСообщение.УчетнаяЗапись = &УчетнаяЗапись
	                      |	И ДокументТранспортноеСообщение.Тип В(&ТипыАвтоотправляемыхСообщений)
	                      |	И ДокументТранспортноеСообщение.ЦиклОбмена.ДатаЗакрытия = &ДатаЗакрытия
	                      |	И НЕ ДокументТранспортноеСообщение.ЦиклОбмена.ПометкаУдаления
	                      |
	                      |УПОРЯДОЧИТЬ ПО
	                      |	ДокументТранспортноеСообщение.ЦиклОбмена.ДатаСоздания,
	                      |	ДокументТранспортноеСообщение.Тип.Порядок");
	
	Запрос.УстановитьПараметр("Статус", Перечисления.СтатусыПисем.Исходящее);
	Запрос.УстановитьПараметр("УчетнаяЗапись", 
		Справочники.УчетныеЗаписиДокументооборота.ПолучитьСсылку(Новый УникальныйИдентификатор(УникальныйИдентификаторУчетнойЗаписи)));
	Запрос.УстановитьПараметр("ДатаЗакрытия", ПолучитьПустуюДатуЗавершенияЦиклаОбмена());
	
	ТипыАвтоотправляемыхСообщений = Новый Массив;
	
	// ПФР
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР);
	
	// ФНС 534
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП);
	
	// Росстат
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС);
	ТипыАвтоотправляемыхСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС);

	Запрос.УстановитьПараметр("ТипыАвтоотправляемыхСообщений", ТипыАвтоотправляемыхСообщений);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Информация, НСтр("ru = 'Сообщения для отправки не обнаружены.'"));
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат РезультатЗапроса.Выбрать();
	
КонецФункции

Функция СопоставитьССозданнымиЦикламиОбменаПередОтправкой(Сообщение)
	
	Если Сообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ДекларацияНП Тогда
		
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		                      |	ЦиклыОбмена.Ссылка,
		                      |	ЦиклыОбмена.ДатаЗакрытия КАК ДатаЗакрытияЦиклаОбмена,
		                      |	ЦиклыОбмена.ВидДокумента,
		                      |	ВложенныйЗапрос.Ссылка КАК ПервичноеСообщениеСодержащееОтчетность,
		                      |	ВложенныйЗапрос.Статус КАК СтатусПервичногоСообщения
		                      |ИЗ
		                      |	Справочник.ЦиклыОбмена КАК ЦиклыОбмена
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		                      |			ТранспортноеСообщение.Ссылка КАК Ссылка,
		                      |			ТранспортноеСообщение.Статус КАК Статус,
		                      |			ТранспортноеСообщение.ЦиклОбмена КАК ЦиклОбмена
		                      |		ИЗ
		                      |			Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
		                      |		ГДЕ
		                      |			ТранспортноеСообщение.Тип = &ТипПервичноеСообщениеСодержащееОтчетность) КАК ВложенныйЗапрос
		                      |		ПО ЦиклыОбмена.Ссылка = ВложенныйЗапрос.ЦиклОбмена
		                      |ГДЕ
		                      |	ЦиклыОбмена.Организация = &Организация
		                      |	И ЦиклыОбмена.ВнешняяОрганизация = &НалоговыйОрган
		                      |	И ЦиклыОбмена.Тип = &Тип
		                      |	И ЦиклыОбмена.ВидОтчета = &ВидОтчета
		                      |	И ЦиклыОбмена.ДатаНачалаПериода = &ДатаНачалаПериода
		                      |	И ЦиклыОбмена.ДатаОкончанияПериода = &ДатаОкончанияПериода
		                      |	И ЦиклыОбмена.Ссылка <> &Ссылка
		                      |	И ЦиклыОбмена.ПометкаУдаления = &ПометкаУдаления");
							  
		Запрос.УстановитьПараметр("Организация",									Сообщение.Отправитель);
		Запрос.УстановитьПараметр("НалоговыйОрган",									Сообщение.ЦиклОбмена.ВнешняяОрганизация);
		Запрос.УстановитьПараметр("ДатаНачалаПериода",								Сообщение.ЦиклОбмена.ДатаНачалаПериода);
		Запрос.УстановитьПараметр("ДатаОкончанияПериода",							Сообщение.ЦиклОбмена.ДатаОкончанияПериода);
		Запрос.УстановитьПараметр("ВидОтчета",										Сообщение.ЦиклОбмена.ВидОтчета);
		Запрос.УстановитьПараметр("Тип",											Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность);
		Запрос.УстановитьПараметр("Ссылка",											Сообщение.ЦиклОбмена);
		Запрос.УстановитьПараметр("ТипПервичноеСообщениеСодержащееОтчетность",		Перечисления.ТипыТранспортныхСообщений.ДекларацияНП);
		Запрос.УстановитьПараметр("ВидДокумента",									Сообщение.ЦиклОбмена.ВидДокумента);
		Запрос.УстановитьПараметр("ПометкаУдаления",								Ложь);
		
		ЦиклыОбмена = Запрос.Выполнить().Выгрузить();
		
		ТекущаяВерсия = Сообщение.ЦиклОбмена.ВидДокумента;
		ПредставлениеТекущегоОтчета = ?(ТекущаяВерсия = 0, "первичный", "корректирующий")
										+ ?(ТекущаяВерсия > 0, " (с номером корректировки " + ТекущаяВерсия + ")", "")
										+ " отчет вида """ + Сообщение.ЦиклОбмена.ВидОтчета + """"
										+ " за период " + ПредставлениеПериода(НачалоДня(Сообщение.ЦиклОбмена.ДатаНачалаПериода), КонецДня(Сообщение.ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина")
										+ " по организации """ + Сообщение.Отправитель + """"
										+ " в налоговый орган " + Сообщение.ЦиклОбмена.ВнешняяОрганизация;
										
		
		// проверка на существование незакрытых циклов обмена (кроме текущего)
		НезакрытыеЦиклыОбмена =  ЦиклыОбмена.НайтиСтроки(Новый Структура("ДатаЗакрытияЦиклаОбмена, ВидДокумента", ПолучитьПустуюДатуЗавершенияЦиклаОбмена(), ТекущаяВерсия));
		СуществуютОтправленныеПервичные = (ЦиклыОбмена.НайтиСтроки(Новый Структура("СтатусПервичногоСообщения, ВидДокумента", Перечисления.СтатусыПисем.Отправленное, ТекущаяВерсия)).Количество() <> 0);
		СуществуютНеотправленныеПервичные = (ЦиклыОбмена.НайтиСтроки(Новый Структура("СтатусПервичногоСообщения, ВидДокумента", Перечисления.СтатусыПисем.Исходящее, ТекущаяВерсия)).Количество() <> 0);
		КоличествоНезакрытых = НезакрытыеЦиклыОбмена.Количество();
		
		Если СуществуютОтправленныеПервичные + СуществуютНеотправленныеПервичные > 0 Тогда
			Если СуществуютОтправленныеПервичные Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Уже отправлялся аналогичный текущему %1.%2'"),
					ПредставлениеТекущегоОтчета,
					?(СуществуютНеотправленныеПервичные,"
								|
								|Также существуют аналогичные подготовленные к отправке и неотправленные сообщения.", ""));
			ИначеЕсли СуществуютНеотправленныеПервичные Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Уже подготавливался к отправке (но не отправлен) аналогичный текущему.'",
					ПредставлениеТекущегоОтчета));
			КонецЕсли;
			ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Предупреждение, ТекстСообщения);
			Возврат Ложь;
		КонецЕсли;
		
		// проверка на существование/отсутствие цикла обмена по аналогичному отчету с версией (<текущая> - 1)
		Если ТекущаяВерсия <> 0 Тогда
			ПредыдущаяВерсия = ТекущаяВерсия - 1;
			ЦиклыОбменаПредыдущейВерсии = ЦиклыОбмена.НайтиСтроки(
				Новый Структура("ВидДокумента, СтатусПервичногоСообщения", ПредыдущаяВерсия, Перечисления.СтатусыПисем.Отправленное));
			Если ЦиклыОбменаПредыдущейВерсии = 0 Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Аналогичный отчет предыдущей версии (%1) не был представлен.'"),
					РегламентированнаяОтчетность.ПредставлениеВидаДокумента(Сообщение.ЦиклОбмена.ВидДокумента));
				ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Предупреждение, ТекстСообщения);
				Возврат Ложь;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли Сообщение.Тип = Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП Тогда
	
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		                      |	ЦиклыОбмена.Ссылка КАК ЦиклОбмена,
							  |	ЦиклыОбмена.ДатаЗакрытия КАК ДатаЗакрытияЦиклаОбмена,
		                      |	Сообщения.Статус КАК СтатусПервичногоСообщения
		                      |ИЗ
		                      |	Справочник.ЦиклыОбмена КАК ЦиклыОбмена
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		                      |			ТранспортноеСообщение.Статус КАК Статус,
		                      |			ТранспортноеСообщение.ЦиклОбмена КАК ЦиклОбмена
		                      |		ИЗ
		                      |			Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
		                      |		ГДЕ
		                      |			ТранспортноеСообщение.Тип = &ТипФорма2НДФЛНП) КАК Сообщения
		                      |		ПО ЦиклыОбмена.Ссылка = Сообщения.ЦиклОбмена
		                      |ГДЕ
		                      |	ЦиклыОбмена.Предмет = &Предмет
		                      |	И ЦиклыОбмена.ПометкаУдаления = &ПометкаУдаления
		                      |	И ЦиклыОбмена.Ссылка <> &Ссылка");
		
		ЦиклОбмена = Сообщение.ЦиклОбмена;
		Запрос.УстановитьПараметр("Ссылка",						ЦиклОбмена);
		Запрос.УстановитьПараметр("ТипФорма2НДФЛНП",			Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП);
		Запрос.УстановитьПараметр("Предмет",					ЦиклОбмена.Предмет);
		Запрос.УстановитьПараметр("ПометкаУдаления",			Ложь);
		
		ЦиклыОбмена = Запрос.Выполнить().Выгрузить();
		
		НезакрытыеЦиклыОбмена =  ЦиклыОбмена.НайтиСтроки(Новый Структура("ДатаЗакрытияЦиклаОбмена", ПолучитьПустуюДатуЗавершенияЦиклаОбмена()));
		СуществуютОтправленные = (ЦиклыОбмена.НайтиСтроки(Новый Структура("СтатусПервичногоСообщения", Перечисления.СтатусыПисем.Отправленное, ТекущаяВерсия)).Количество() <> 0);
		СуществуютНеотправленные = (ЦиклыОбмена.НайтиСтроки(Новый Структура("СтатусПервичногоСообщения", Перечисления.СтатусыПисем.Исходящее, ТекущаяВерсия)).Количество() <> 0);
		КоличествоНезакрытых = НезакрытыеЦиклыОбмена.Количество();
		
		Если СуществуютОтправленные + СуществуютНеотправленные > 0 Тогда
			Если СуществуютОтправленные Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Вы уже отправляли сообщения, содержащие текущий документ.1%'"),
					?(СуществуютНеотправленные,"
								|
								|Также существуют подготовленные к отправке и неотправленные сообщения с тем же документом.", ""));
			ИначеЕсли СуществуютНеотправленные Тогда
				ТекстСообщения = НСтр("ru = 'Вы уже подготавливали к отправке другие сообщения, содержащие текущий документ.'");
			КонецЕсли;
			ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Предупреждение, ТекстСообщения);
			Возврат Ложь;
		КонецЕсли;
		
	ИначеЕсли Сообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР Тогда
		
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		                      |	ЦиклыОбмена.Ссылка,
		                      |	ЦиклыОбмена.ДатаЗакрытия КАК ДатаЗакрытияЦиклаОбмена,
		                      |	ЦиклыОбмена.ВидДокумента,
		                      |	ВложенныйЗапрос.Ссылка КАК ПервичноеСообщениеСодержащееОтчетность,
		                      |	ВложенныйЗапрос.Статус КАК СтатусПервичногоСообщения
		                      |ИЗ
		                      |	Справочник.ЦиклыОбмена КАК ЦиклыОбмена
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		                      |			ТранспортноеСообщение.Ссылка КАК Ссылка,
		                      |			ТранспортноеСообщение.Статус КАК Статус,
		                      |			ТранспортноеСообщение.ЦиклОбмена КАК ЦиклОбмена
		                      |		ИЗ
		                      |			Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
		                      |		ГДЕ
		                      |			ТранспортноеСообщение.Тип = &ТипПервичноеСообщениеСодержащееОтчетность) КАК ВложенныйЗапрос
		                      |		ПО ЦиклыОбмена.Ссылка = ВложенныйЗапрос.ЦиклОбмена
		                      |ГДЕ
		                      |	ЦиклыОбмена.Организация = &Организация
		                      |	И ЦиклыОбмена.ВнешняяОрганизация = &НалоговыйОрган
		                      |	И ЦиклыОбмена.Тип = &Тип
		                      |	И ЦиклыОбмена.ВидОтчета = &ВидОтчета
		                      |	И ЦиклыОбмена.ДатаНачалаПериода = &ДатаНачалаПериода
		                      |	И ЦиклыОбмена.ДатаОкончанияПериода = &ДатаОкончанияПериода
		                      |	И ЦиклыОбмена.Ссылка <> &Ссылка
		                      |	И ЦиклыОбмена.ПометкаУдаления = &ПометкаУдаления");
							  
		Запрос.УстановитьПараметр("Организация",				Сообщение.Отправитель);
		Запрос.УстановитьПараметр("НалоговыйОрган",				Сообщение.ЦиклОбмена.ВнешняяОрганизация);
		Запрос.УстановитьПараметр("ДатаНачалаПериода",			Сообщение.ЦиклОбмена.ДатаНачалаПериода);
		Запрос.УстановитьПараметр("ДатаОкончанияПериода",		Сообщение.ЦиклОбмена.ДатаОкончанияПериода);
		Запрос.УстановитьПараметр("ВидОтчета",					Сообщение.ЦиклОбмена.ВидОтчета);
		Запрос.УстановитьПараметр("Тип",						Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность);
		Запрос.УстановитьПараметр("Ссылка",						Сообщение.ЦиклОбмена);
		Запрос.УстановитьПараметр("ТипПервичноеСообщениеСодержащееОтчетность",		Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР);
		Запрос.УстановитьПараметр("ВидДокумента",				Сообщение.ЦиклОбмена.ВидДокумента);
		Запрос.УстановитьПараметр("ПометкаУдаления",			Ложь);
		
		ЦиклыОбмена = Запрос.Выполнить().Выгрузить();
		
		ТекущаяВерсия = Сообщение.ЦиклОбмена.ВидДокумента;
		ПредставлениеТекущегоОтчета = ?(ТекущаяВерсия = 0, "первичный", "корректирующий")
										+ ?(ТекущаяВерсия > 0, " (с номером корректировки " + ТекущаяВерсия + ")", "")
										+ " отчет вида """ + Сообщение.ЦиклОбмена.ВидОтчета + """"
										+ " за период " + ПредставлениеПериода(НачалоДня(Сообщение.ЦиклОбмена.ДатаНачалаПериода), КонецДня(Сообщение.ЦиклОбмена.ДатаОкончанияПериода), "ФП=Истина")
										+ " по организации """ + Сообщение.Отправитель + """"
										+ " в налоговый орган " + Сообщение.ЦиклОбмена.ВнешняяОрганизация;
										
		
		// проверка на существование незакрытых циклов обмена (кроме текущего)
		НезакрытыеЦиклыОбмена =  ЦиклыОбмена.НайтиСтроки(Новый Структура("ДатаЗакрытияЦиклаОбмена, ВидДокумента", ПолучитьПустуюДатуЗавершенияЦиклаОбмена(), ТекущаяВерсия));
		СуществуютОтправленныеПервичные = (ЦиклыОбмена.НайтиСтроки(Новый Структура("СтатусПервичногоСообщения, ВидДокумента", Перечисления.СтатусыПисем.Отправленное, ТекущаяВерсия)).Количество() <> 0);
		СуществуютНеотправленныеПервичные = (ЦиклыОбмена.НайтиСтроки(Новый Структура("СтатусПервичногоСообщения, ВидДокумента", Перечисления.СтатусыПисем.Исходящее, ТекущаяВерсия)).Количество() <> 0);
		КоличествоНезакрытых = НезакрытыеЦиклыОбмена.Количество();
		
		Если СуществуютОтправленныеПервичные + СуществуютНеотправленныеПервичные > 0 Тогда
			Если СуществуютОтправленныеПервичные Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Вы уже отправляли аналогичный текущему %1.%2'"),
					ПредставлениеТекущегоОтчета,
					?(СуществуютНеотправленныеПервичные,"
								|
								|Также существуют аналогичные подготовленные к отправке и неотправленные сообщения.", ""));
			ИначеЕсли СуществуютНеотправленныеПервичные Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Вы уже подготавливали к отправке (но не отправляли) аналогичный текущему %1.",
					ПредставлениеТекущегоОтчета));
			КонецЕсли;
			ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Предупреждение, ТекстСообщения);
			Возврат Ложь;
		КонецЕсли;
		
		// проверка на существование/отсутствие цикла обмена по аналогичному отчету с версией (<текущая> - 1)
		Если ТекущаяВерсия <> 0 Тогда
			ПредыдущаяВерсия = ТекущаяВерсия - 1;
			ЦиклыОбменаПредыдущейВерсии = ЦиклыОбмена.НайтиСтроки(Новый Структура("ВидДокумента, СтатусПервичногоСообщения", ПредыдущаяВерсия, Перечисления.СтатусыПисем.Отправленное));
			Если ЦиклыОбменаПредыдущейВерсии = 0 Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Аналогичный отчет предыдущей версии (%1) не был представлен.'"),
					РегламентированнаяОтчетность.ПредставлениеВидаДокумента(Сообщение.ЦиклОбмена.ВидДокумента));
				ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Предупреждение, ТекстСообщения);
				Возврат Ложь;
			КонецЕсли;
		КонецЕсли;
	
	ИначеЕсли Сообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР Тогда
		
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		                      |	ЦиклыОбмена.Ссылка КАК ЦиклОбмена,
							  |	ЦиклыОбмена.ДатаЗакрытия КАК ДатаЗакрытияЦиклаОбмена,
		                      |	Сообщения.Статус КАК СтатусПервичногоСообщения
		                      |ИЗ
		                      |	Справочник.ЦиклыОбмена КАК ЦиклыОбмена
		                      |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		                      |			ТранспортноеСообщение.Статус КАК Статус,
		                      |			ТранспортноеСообщение.ЦиклОбмена КАК ЦиклОбмена
		                      |		ИЗ
		                      |			Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
		                      |		ГДЕ
		                      |			ТранспортноеСообщение.Тип = &ТипПервичноеСообщениеСодержащееОтчетность) КАК Сообщения
		                      |		ПО ЦиклыОбмена.Ссылка = Сообщения.ЦиклОбмена
		                      |ГДЕ
		                      |	ЦиклыОбмена.Предмет = &Предмет
		                      |	И ЦиклыОбмена.ПометкаУдаления = &ПометкаУдаления
		                      |	И ЦиклыОбмена.Ссылка <> &Ссылка");
							  
		ЦиклОбмена = Сообщение.ЦиклОбмена;
		Запрос.УстановитьПараметр("Ссылка",										ЦиклОбмена);
		Запрос.УстановитьПараметр("ТипПервичноеСообщениеСодержащееОтчетность",	Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР);
		Запрос.УстановитьПараметр("Предмет",									ЦиклОбмена.Предмет);
		Запрос.УстановитьПараметр("ПометкаУдаления",							Ложь);
		
		ЦиклыОбмена = Запрос.Выполнить().Выгрузить();
		
		НезакрытыеЦиклыОбмена =  ЦиклыОбмена.НайтиСтроки(Новый Структура("ДатаЗакрытияЦиклаОбмена", ПолучитьПустуюДатуЗавершенияЦиклаОбмена()));
		СуществуютОтправленные = (ЦиклыОбмена.НайтиСтроки(Новый Структура("СтатусПервичногоСообщения", Перечисления.СтатусыПисем.Отправленное, ТекущаяВерсия)).Количество() <> 0);
		СуществуютНеотправленные = (ЦиклыОбмена.НайтиСтроки(Новый Структура("СтатусПервичногоСообщения", Перечисления.СтатусыПисем.Исходящее, ТекущаяВерсия)).Количество() <> 0);
		КоличествоНезакрытых = НезакрытыеЦиклыОбмена.Количество();
		
		Если СуществуютОтправленные + СуществуютНеотправленные > 0 Тогда
			Если СуществуютОтправленные Тогда
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Вы уже отправляли сообщения, содержащие текущий отчет.%1'"),
						?(СуществуютНеотправленные,"
							|
							|Также существуют подготовленные к отправке и неотправленные сообщения с тем же отчетом.", ""));
			ИначеЕсли СуществуютНеотправленные Тогда
				ТекстСообщения = НСтр("ru = 'Вы уже подготавливали к отправке другие сообщения, содержащие текущий отчет.'");
			КонецЕсли;
			ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Предупреждение, ТекстСообщения);
			Возврат Ложь;
		КонецЕсли;
		
	Иначе
		
		Возврат Истина;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

// Процедура заполнения регистра сведений "Свойства транспортных сообщений"
//
// Параметры:
//	СообщенияРезультат
//		Тип: Массив
//
Процедура ЗаполнитьСвойстваТранспортныхСообщений(СообщенияРезультат)
	
	ДатаПолучения = ТекущаяДатаСеанса();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ТранспортноеСообщение.Ссылка КАК Сообщение,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ТребуетВнимания.Сообщение, 0) = 0
	               |			ТОГДА ЛОЖЬ
	               |		ИНАЧЕ ИСТИНА
	               |	КОНЕЦ КАК ТребуетВнимания,
	               |	ВЫБОР
	               |		КОГДА ЕСТЬNULL(ТребуетРасшифровки.Сообщение, 0) = 0
	               |			ТОГДА ЛОЖЬ
	               |		ИНАЧЕ ИСТИНА
	               |	КОНЕЦ КАК ТребуетРасшифровки
	               |ИЗ
	               |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
	               |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |			ТранспортноеСообщение.Ссылка КАК Сообщение
	               |		ИЗ
	               |			Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
	               |		ГДЕ
	               |			ТранспортноеСообщение.Ссылка В(&Сообщения)
	               |			И (ТранспортноеСообщение.Тип В (&ТипКритическиеОшибки)
	               |					ИЛИ ТранспортноеСообщение.Тип В (&ТипВходящиеДокументы)
	               |					ИЛИ ТранспортноеСообщение.Тип В (&ТипПротоколы)
	               |						И ТранспортноеСообщение.ПротоколСОшибкой)) КАК ТребуетВнимания
	               |		ПО ТранспортноеСообщение.Ссылка = ТребуетВнимания.Сообщение
	               |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ РАЗЛИЧНЫЕ
	               |			ТранспортныеКонтейнеры.ТранспортноеСообщение КАК Сообщение
	               |		ИЗ
	               |			РегистрСведений.ТранспортныеКонтейнеры КАК ТранспортныеКонтейнеры
	               |		ГДЕ
	               |			НЕ ТранспортныеКонтейнеры.ТранспортноеСообщение В
	               |						(ВЫБРАТЬ
	               |							СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение
	               |						ИЗ
	               |							РегистрСведений.СодержимоеТранспортныхКонтейнеров КАК СодержимоеТранспортныхКонтейнеров
	               |						ГДЕ
	               |							СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение В (&Сообщения)
	               |							И НЕ СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.ПометкаУдаления
	               |							И НЕ СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.ЦиклОбмена.ПометкаУдаления)) КАК ТребуетРасшифровки
	               |		ПО ТранспортноеСообщение.Ссылка = ТребуетРасшифровки.Сообщение
	               |ГДЕ
	               |	ТранспортноеСообщение.Ссылка В(&Сообщения)";
	
	ТипВходящиеДокументы = Новый Массив;
	ТипВходящиеДокументы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР);
	ТипВходящиеДокументы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС);
	Запрос.УстановитьПараметр("ТипВходящиеДокументы", ТипВходящиеДокументы);
	
	ТипПротоколы = Новый Массив;
	ТипПротоколы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПротоколПФР);
	ТипПротоколы.Добавить(Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС);
	ТипПротоколы.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО);
	ТипПротоколы.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО);
	Запрос.УстановитьПараметр("ТипПротоколы", ТипПротоколы);
	
	ТипКритическиеОшибки = Новый Массив;
	ТипКритическиеОшибки.Добавить(Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка);
	ТипКритическиеОшибки.Добавить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР);
	ТипКритическиеОшибки.Добавить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС);
	ТипКритическиеОшибки.Добавить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС);
	Запрос.УстановитьПараметр("ТипКритическиеОшибки", ТипКритическиеОшибки);
	
	Запрос.УстановитьПараметр("Сообщения", СообщенияРезультат);
	Запрос.УстановитьПараметр("ТипКритическиеОшибки", ТипКритическиеОшибки);
	Запрос.УстановитьПараметр("ТипВходящиеДокументы", ТипВходящиеДокументы);
	Запрос.УстановитьПараметр("ТипПротоколы", ТипПротоколы);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		НаборЗаписей = РегистрыСведений.СвойстваТранспортныхСообщений.СоздатьНаборЗаписей(); 
		
		НаборЗаписей.Отбор.УчетнаяЗапись.Установить(Выборка.Сообщение.УчетнаяЗапись);
		НаборЗаписей.Отбор.ТранспортноеСообщение.Установить(Выборка.Сообщение);
		
		НоваяЗапись = НаборЗаписей.Добавить();
		НоваяЗапись.УчетнаяЗапись 			= Выборка.Сообщение.УчетнаяЗапись;
		НоваяЗапись.ТранспортноеСообщение 	= Выборка.Сообщение;
		НоваяЗапись.ДатаПолучения			= ДатаПолучения;
		НоваяЗапись.ТребуетВнимания			= Выборка.ТребуетВнимания;
		НоваяЗапись.ТребуетРасшифровки		= Выборка.ТребуетРасшифровки;
		
		НаборЗаписей.Записать();
		
	КонецЦикла;
	
	
КонецПроцедуры

// не полный аналог ф-ции в Контейнере
Функция ПодключитьсяКПочтовомуСерверу(ПочтовыйПрофиль) Экспорт
	
	Попытка
		Почта = Новый ИнтернетПочта;
		Почта.Подключиться(ПочтовыйПрофиль);
		Возврат Почта;
	Исключение
		ТекстСообщенияОбОшибке =
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось подключиться к почтовому серверу!
				 |%1'"), ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщенияОбОшибке);
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

// не полный аналог ф-ции в Контейнере
Функция ОтключитьсяОтПочтовогоСервера(Почта) Экспорт
	
	Попытка
		Почта.Отключиться();
		Возврат Истина;
	Исключение
		ТекстСообщенияОбОшибке =
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось отключиться от сервера документооборота!
				 |%1'"), ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщенияОбОшибке);
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

//

Функция ОтправкаНеТребуется(КодОбластиДанных, УникальныйИдентификаторУчетнойЗаписи)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ИндексУчетныхЗаписейДокументооборота.ТребуетсяОтправка
	               |ИЗ
	               |	РегистрСведений.ИндексУчетныхЗаписейДокументооборота КАК ИндексУчетныхЗаписейДокументооборота
	               |ГДЕ
	               |	ИндексУчетныхЗаписейДокументооборота.ОбластьДанныхВспомогательныеДанные = &ОбластьДанныхВспомогательныеДанные
	               |	И ИндексУчетныхЗаписейДокументооборота.УникальныйИдентификаторУчетнойЗаписи = &УникальныйИдентификаторУчетнойЗаписи";
	Запрос.УстановитьПараметр("ОбластьДанныхВспомогательныеДанные", КодОбластиДанных);
	Запрос.УстановитьПараметр("УникальныйИдентификаторУчетнойЗаписи", УникальныйИдентификаторУчетнойЗаписи);
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = НЕ Выборка.ТребуетсяОтправка;
	Иначе 
		Результат = Истина;
	КонецЕсли;
	УстановитьПривилегированныйРежим(Ложь);
	Возврат Результат;
	
КонецФункции

Функция ПодтвердитьОтправку(КодОбластиДанных, УникальныйИдентификаторУчетнойЗаписи)
	
	УстановитьПривилегированныйРежим(Истина);
	НаборЗаписей = РегистрыСведений.ИндексУчетныхЗаписейДокументооборота.СоздатьНаборЗаписей(); 
	НаборЗаписей.Отбор.ОбластьДанныхВспомогательныеДанные.Установить(КодОбластиДанных);
	НаборЗаписей.Отбор.УникальныйИдентификаторУчетнойЗаписи.Установить(УникальныйИдентификаторУчетнойЗаписи);
	
	НаборЗаписей.Прочитать(); 
	
	Для Каждого Запись Из НаборЗаписей Цикл 
		
		// Изменение данных полей записи. 
		Запись.ТребуетсяОтправка = Ложь; 
		
	КонецЦикла; 
	
	НаборЗаписей.Записать();
	УстановитьПривилегированныйРежим(Ложь);
	
КонецФункции

Функция ПолучитьПараметрыЗадания(СтрокаЗаданий)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("КодОбластиДанных", СтрокаЗаданий["КодОбластиДанных"]);
	СтруктураПараметров.Вставить("УникальныйИдентификаторУчетнойЗаписи", СтрокаЗаданий["УникальныйИдентификаторУчетнойЗаписи"]);
	СтруктураПараметров.Вставить("НаименованиеУчетнойЗаписи", СтрокаЗаданий["НаименованиеУчетнойЗаписи"]);
	СтруктураПараметров.Вставить("СерверSMTP", СтрокаЗаданий["СерверSMTP"]);
	СтруктураПараметров.Вставить("ПортSMTP", СтрокаЗаданий["ПортSMTP"]);
	СтруктураПараметров.Вставить("ТребуетсяSMTPАутентификация", СтрокаЗаданий["ТребуетсяSMTPАутентификация"]);
	СтруктураПараметров.Вставить("ИмяПользователяSMTP", СтрокаЗаданий["ИмяПользователяSMTP"]);
	СтруктураПараметров.Вставить("ПарольSMTP", СтрокаЗаданий["ПарольSMTP"]);
	СтруктураПараметров.Вставить("СерверPOP3", СтрокаЗаданий["СерверPOP3"]);
	СтруктураПараметров.Вставить("ПортPOP3", СтрокаЗаданий["ПортPOP3"]);
	СтруктураПараметров.Вставить("ИмяПользователяPOP3", СтрокаЗаданий["ИмяПользователяPOP3"]);
	СтруктураПараметров.Вставить("ПарольPOP3", СтрокаЗаданий["ПарольPOP3"]);
	
	ПараметрыЗадания = Новый Массив;
	Для Каждого ЭлементСтруктуры Из СтруктураПараметров Цикл
		ПараметрыЗадания.Добавить(ЭлементСтруктуры.Значение);
	КонецЦикла;
	
	Возврат ПараметрыЗадания;
	
КонецФункции

Процедура УдалитьВыполненныеЗадания(Знач ЗапущенныеЗадания) 
	
	Индекс = ЗапущенныеЗадания.ВГраница();
	Пока Индекс >= 0 Цикл
		
		СостояниеЗадания = ФоновыеЗадания.НайтиПоУникальномуИдентификатору(ЗапущенныеЗадания[Индекс].УникальныйИдентификатор).Состояние;
		Если СостояниеЗадания <> СостояниеФоновогоЗадания.Активно Тогда
			ЗапущенныеЗадания.Удалить(Индекс);
		КонецЕсли;
		
		Индекс = Индекс - 1;
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьТаблицуЗаданий(Результат)
	
	ТаблицаЗаданий = Результат.Скопировать();
	ТаблицаЗаданий.Колонки.Добавить("Процесс");
	Возврат ТаблицаЗаданий;
	
КонецФункции

//

Процедура ВойтиВОбластьДанных(Знач ЗначениеРазделителя)
	
	Попытка
		
		ОбщегоНазначения.УстановитьРазделениеСеанса(Истина, ЗначениеРазделителя);
		
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Вход в область №%1 НЕ осуществлен!%2'"), 
				Строка(ЗначениеРазделителя),
				Символы.ПС + ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
	КонецПопытки;
	
КонецПроцедуры

Процедура ВыйтиИзОбластиДанных()
	
	ОбщегоНазначения.УстановитьРазделениеСеанса(Ложь);
	
КонецПроцедуры

Функция ОсуществленВходВОбластьДанных()
	
	УстановитьПривилегированныйРежим(Истина);
	Возврат ОбщегоНазначения.ИспользованиеРазделителяСеанса();
	
КонецФункции
//

//
Функция СобытиеЖурналаРегистрации()
	
	Возврат НСтр("ru = 'Автоматический обмен с контролирующими органами'");
	
КонецФункции

Процедура ЗаписатьСобытиеВЖурнал(Уровень, ТекстСобытия)
	
	РежимВключен = (ПолучитьИспользованиеЖурналаРегистрации().Найти(Уровень) <> Неопределено);
	Если НЕ РежимВключен Тогда
		Возврат;
	КонецЕсли;
	
	ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(), Уровень, , , ТекстСобытия);
	
КонецПроцедуры

// есть в Контейнере
Функция ОпределитьОрганФСГСОрганизации(Организация) Экспорт
	
	КодОрганаФСГС = СокрЛП(РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(Организация, , "КодОрганаФСГС").КодОрганаФСГС);
	Если НЕ ЗначениеЗаполнено(КодОрганаФСГС) Тогда
		Возврат Неопределено;
	Иначе
		Возврат Справочники.ОрганыФСГС.НайтиПоКоду(КодОрганаФСГС);
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция СтрокаСодержитРусскиеСимволы(Стр)
	
	// Исключение из стандарта 456.
	РусскиеСимволы = "АБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ";
	Для Инд = 1 По СтрДлина(Стр) Цикл
		Если Найти(РусскиеСимволы, ВРЕГ(Сред(Стр, Инд, 1))) <> 0 Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	Возврат Ложь;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьАдресИПредставлениеПолучателяТранспортногоСообщения(ОбъектСообщение, СсылкаПолучатель)
	
	// если это сообщение, предназначенное для СОС, то отправляем ровно на тот адрес,
	// с которого пришло сообщение-основание
	Если ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
		ОтКогоАдрес = ОбъектСообщение.Основание.ОтКогоАдрес;
		ОтКогоПредставление = ОбъектСообщение.Основание.ОтКогоПредставление;
		Если ЗначениеЗаполнено(ОтКогоАдрес) Тогда
			Возврат Новый Структура("Адрес, Представление", ОтКогоАдрес, ОтКогоПредставление);
		КонецЕсли;
	КонецЕсли;
	
	// иначе определяем результат по свойствам получателя
	Если ТипЗнч(СсылкаПолучатель) = Тип("СправочникСсылка.НалоговыеОрганы") Тогда
		АдресПолучателя = СсылкаПолучатель.АдресЭлектроннойПочтыДляЦелейДокументооборотаСНалогоплательщиками;
	Иначе
		Если ОбъектСообщение.ЦиклОбмена.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФНС Тогда
			АдресПолучателя = СсылкаПолучатель.АдресЭлектроннойПочтыФНС;
		ИначеЕсли ОбъектСообщение.ЦиклОбмена.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФСГС Тогда
			АдресПолучателя = СсылкаПолучатель.АдресЭлектроннойПочтыФСГС;
		Иначе
			АдресПолучателя = СсылкаПолучатель.АдресЭлектроннойПочтыПФР;
		КонецЕсли;
	КонецЕсли;
	Возврат Новый Структура("Адрес, Представление", АдресПолучателя, СокрЛП(СсылкаПолучатель.Наименование));
	
КонецФункции

// есть в Контейнере
Функция ОпределитьПолучателяТранспортногоСообщения(Сообщение)
	
	Если НЕ Сообщение.УчетнаяЗапись.ОбменНапрямую Тогда
		Возврат Сообщение.УчетнаяЗапись.СерверДокументооборота;
	Иначе
		ТипСообщения = Сообщение.Тип;
		Если ТипСообщения = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП Тогда
			Возврат Сообщение.УчетнаяЗапись.СерверДокументооборота;
		Иначе
			Возврат Сообщение.УчетнаяЗапись.НалоговыйОрган;
		КонецЕсли;
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ПолучитьИдентификаторПервичногоСообщения(Объект)
	
	СтрИДПервичного = Объект.ДополнительныеРеквизитыЗаголовка.Найти(Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторПервичногоСообщения, "Тип");
	Если СтрИДПервичного = Неопределено Тогда
		СтрИДПервичного = Объект.ДополнительныеРеквизитыЗаголовка.Найти("X-Message-ID", "Тип");
	КонецЕсли;
	
	Если СтрИДПервичного = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат СокрЛП(СтрИДПервичного.Значение);
	
КонецФункции

// есть в Контейнере
Процедура РаспознатьТранспортноеСообщение(парамОбъект, Записывать = Истина) Экспорт
	
	Если парамОбъект.Статус <> Перечисления.СтатусыПисем.Полученное Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(парамОбъект) = Тип("ДокументСсылка.ТранспортноеСообщение") Тогда
		Объект = парамОбъект.ПолучитьОбъект();
	Иначе
		Объект = парамОбъект;
	КонецЕсли;
	
	ШапкаОшибки = "Не удалось записать транспортное сообщение """ + ПредставлениеТранспортногоСообщения(Объект) + """:";
	
	// распознаем тип
	Объект.Тип = ОпределитьТипСообщения(Объект);
	
	// распознаем, с ошибкой ли протокол (если это протокол)
	Объект.ПротоколСОшибкой = ЯвляетсяОтрицательнымПротоколом(Объект);
	
	// распознаем отправителя
	Объект.Отправитель = ОпределитьОтправителяВходящегоТранспортногоСообщения(Объект);
	
	// распознаем получателя
	Объект.Получатель = ОпределитьПолучателяВходящегоТранспортногоСообщения(Объект);
	
	// распознаем цикл обмена
	Если НЕ ЗначениеЗаполнено(Объект.ЦиклОбмена) Тогда
		
		// если это документ от налогового органа, то создаем цикл обмена - основание
		Если Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР Тогда
			
			Если ЗначениеЗаполнено(Объект.Получатель) И ЗначениеЗаполнено(Объект.Отправитель) Тогда// если получатель или отправитель не заполнены - цикл обмена не запишется
			
				ЦиклОбменаОбъект = Справочники.ЦиклыОбмена.СоздатьЭлемент();
				ЦиклОбменаОбъект.Идентификатор = ИзвлечьИдентификаторДокументооборотаИзПакета(Объект.Ссылка);
				ЦиклОбменаОбъект.Организация = Объект.Получатель;
				ЦиклОбменаОбъект.УчетнаяЗапись = Объект.УчетнаяЗапись;
				ЦиклОбменаОбъект.ВнешняяОрганизация = Объект.Отправитель;
				ЦиклОбменаОбъект.ДатаПоследнегоСообщения = Объект.ДатаТранспорта;
				ЦиклОбменаОбъект.Тип = Перечисления.ТипыЦикловОбмена.НеформализованнаяПерепискаПФРВходящие;
				ЦиклОбменаОбъект.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСПФР;
				ЦиклОбменаОбъект.Записать();
				
				Объект.ЦиклОбмена = ЦиклОбменаОбъект.Ссылка;
				
			КонецЕсли;
			
		// если это письмо от Росстата, то создаем цикл обмена - основание
		ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС Тогда
			
			Если ЗначениеЗаполнено(Объект.Получатель) И ЗначениеЗаполнено(Объект.Отправитель) Тогда// если получатель или отправитель не заполнены - цикл обмена не запишется
			
				ЦиклОбменаОбъект = Справочники.ЦиклыОбмена.СоздатьЭлемент();
				ЦиклОбменаОбъект.Идентификатор = ИзвлечьИдентификаторДокументооборотаИзПакета(Объект.Ссылка);
				ЦиклОбменаОбъект.Организация = Объект.Получатель;
				ЦиклОбменаОбъект.УчетнаяЗапись = Объект.УчетнаяЗапись;
				ЦиклОбменаОбъект.ВнешняяОрганизация = Объект.Отправитель;
				ЦиклОбменаОбъект.ДатаПоследнегоСообщения = Объект.ДатаТранспорта;
				ЦиклОбменаОбъект.Тип = Перечисления.ТипыЦикловОбмена.ИндивидуальноеИнформированиеФСГС;
				ЦиклОбменаОбъект.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФСГС;
				ЦиклОбменаОбъект.Записать();
				
				Объект.ЦиклОбмена = ЦиклОбменаОбъект.Ссылка;
				
			КонецЕсли;
			
		// если это письмо от ФНС, то создаем цикл обмена - основание
		ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоНО Тогда
			
			Если ЗначениеЗаполнено(Объект.Получатель) И ЗначениеЗаполнено(Объект.Отправитель) Тогда// если получатель или отправитель не заполнены - цикл обмена не запишется
			
				ЦиклОбменаОбъект = Справочники.ЦиклыОбмена.СоздатьЭлемент();
				ЦиклОбменаОбъект.Идентификатор = ПолучитьИдентификаторПервичногоСообщения(Объект);
				ЦиклОбменаОбъект.Организация = Объект.Получатель;
				ЦиклОбменаОбъект.УчетнаяЗапись = Объект.УчетнаяЗапись;
				ЦиклОбменаОбъект.ВнешняяОрганизация = Объект.Отправитель;
				ЦиклОбменаОбъект.ДатаПоследнегоСообщения = Объект.ДатаТранспорта;
				ЦиклОбменаОбъект.Тип = Перечисления.ТипыЦикловОбмена.ПисьмоНО;
				ЦиклОбменаОбъект.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФНС;
				ЦиклОбменаОбъект.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534;
				ЦиклОбменаОбъект.Записать();
				
				Объект.ЦиклОбмена = ЦиклОбменаОбъект.Ссылка;
				
			КонецЕсли;
			
		// если это рассылка от ФНС, то создаем цикл обмена - основание
		ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РассылкаНО Тогда
			
			Если ЗначениеЗаполнено(Объект.Получатель) И ЗначениеЗаполнено(Объект.Отправитель) Тогда// если получатель или отправитель не заполнены - цикл обмена не запишется
			
				ЦиклОбменаОбъект = Справочники.ЦиклыОбмена.СоздатьЭлемент();
				ЦиклОбменаОбъект.Идентификатор = ПолучитьИдентификаторПервичногоСообщения(Объект);
				ЦиклОбменаОбъект.Организация = Объект.Получатель;
				ЦиклОбменаОбъект.УчетнаяЗапись = Объект.УчетнаяЗапись;
				ЦиклОбменаОбъект.ВнешняяОрганизация = Объект.Отправитель;
				ЦиклОбменаОбъект.ДатаПоследнегоСообщения = Объект.ДатаТранспорта;
				ЦиклОбменаОбъект.Тип = ОпределитьТипЦиклаОбменаПоСообщениюРассылки(Объект.Ссылка);
				ЦиклОбменаОбъект.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФНС;
				ЦиклОбменаОбъект.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534;
				ЦиклОбменаОбъект.Записать();
				
				Объект.ЦиклОбмена = ЦиклОбменаОбъект.Ссылка;
				
			КонецЕсли;
			
		// если это документ реализации полномочий от ФНС, то создаем цикл обмена - основание
		ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ДокументНО Тогда
			
			// если получатель или отправитель не заполнены - цикл обмена не запишется
			Если ЗначениеЗаполнено(Объект.Получатель) И ЗначениеЗаполнено(Объект.Отправитель) И ТипЗнч(Объект.Отправитель) = Тип("СправочникСсылка.НалоговыеОрганы") Тогда 
				
				ЦиклОбменаОбъект = Справочники.ЦиклыОбмена.СоздатьЭлемент();
				ЦиклОбменаОбъект.Идентификатор = ПолучитьИдентификаторПервичногоСообщения(Объект);
				ЦиклОбменаОбъект.Организация = Объект.Получатель;
				ЦиклОбменаОбъект.УчетнаяЗапись = Объект.УчетнаяЗапись;
				ЦиклОбменаОбъект.ВнешняяОрганизация = Объект.Отправитель;
				ЦиклОбменаОбъект.ДатаПоследнегоСообщения = Объект.ДатаТранспорта;
				ЦиклОбменаОбъект.Тип = Перечисления.ТипыЦикловОбмена.Документ;
				ЦиклОбменаОбъект.Вид = Перечисления.ВидыЦикловОбмена.ЦиклОбменаСФНС;
				ЦиклОбменаОбъект.ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534;
				ЦиклОбменаОбъект.Записать();
				
				Объект.ЦиклОбмена = ЦиклОбменаОбъект.Ссылка;
				
			КонецЕсли;	
			
		// если это прочее сообщение от ПФР, то находим цикл обмена по
		// идентификатору документооборота из описания пакета
		ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколПФР
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР Тогда
			
			ИдентификаторДокументооборота = ИзвлечьИдентификаторДокументооборотаИзПакета(Объект);
			Если ЗначениеЗаполнено(ИдентификаторДокументооборота) Тогда
				_ЦиклОбмена = НайтиЦиклОбменаПоИдентификатору(ИдентификаторДокументооборота);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(_ЦиклОбмена) Тогда
				Объект.ЦиклОбмена = _ЦиклОбмена;
			КонецЕсли;
			
		// если это другое сообщение от Росстата, то находим цикл обмена по
		// идентификатору документооборота из описания пакета
		ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС
			  ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС
			  ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС
			  ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС
			  ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС
			  ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС
			  ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС
			  ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС Тогда
			
			ИдентификаторДокументооборота = ИзвлечьИдентификаторДокументооборотаИзПакета(Объект);
			Если ЗначениеЗаполнено(ИдентификаторДокументооборота) Тогда
				_ЦиклОбмена = НайтиЦиклОбменаПоИдентификатору(ИдентификаторДокументооборота);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(_ЦиклОбмена) Тогда
				Объект.ЦиклОбмена = _ЦиклОбмена;
			КонецЕсли;
			
		// если это прочее сообщение от ФНС, то находим цикл обмена по
		// идентификатору первичного сообщения цикла из дополнительных реквизитов
		// заголовка почтового сообщения
		Иначе
			
			// пробуем найти цикл обмена по идентификатору первичного
			_ЦиклОбмена = Неопределено;
			стрИдентификаторПервичногоСообщения = ПолучитьИдентификаторПервичногоСообщения(Объект);
			
			Если стрИдентификаторПервичногоСообщения <> Неопределено  Тогда
				_ЦиклОбмена = НайтиЦиклОбменаПоИдентификатору(стрИдентификаторПервичногоСообщения);
			КонецЕсли;
			
			// если ничего не помогло...
			Если НЕ ЗначениеЗаполнено(_ЦиклОбмена) Тогда
				
				// обход особенностей различных версий реализации серверного ПО ФНС
				Если Объект.Тип = Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка Тогда
					
					ВхождениеДвоеточия = Найти(Объект.Тема, ":");
					Если ВхождениеДвоеточия <> 0 Тогда
						
						ИсходнаяТема = СокрЛ(Сред(Объект.Тема, ВхождениеДвоеточия + 1));
						
						Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
											  |	ТранспортноеСообщение.ЦиклОбмена
											  |ИЗ
											  |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
											  |ГДЕ
											  |	ТранспортноеСообщение.Тема ПОДОБНО &Тема
											  |	И ТранспортноеСообщение.Статус = &Статус
											  |	И ТранспортноеСообщение.УчетнаяЗапись = &УчетнаяЗапись
											  |
											  |УПОРЯДОЧИТЬ ПО
											  |	ТранспортноеСообщение.ДатаТранспорта УБЫВ");
						Запрос.УстановитьПараметр("Тема", ИсходнаяТема);
						Запрос.УстановитьПараметр("Статус", Перечисления.СтатусыПисем.Отправленное);
						Запрос.УстановитьПараметр("УчетнаяЗапись", Объект.УчетнаяЗапись);
						РезультатЗапроса = Запрос.Выполнить();
						Если НЕ РезультатЗапроса.Пустой() Тогда
							Выборка = РезультатЗапроса.Выбрать();
							Если Выборка.Следующий() Тогда
								_ЦиклОбмена = Выборка.ЦиклОбмена;
							КонецЕсли;
						КонецЕсли;
						
						Если НЕ ЗначениеЗаполнено(Объект.ЦиклОбмена) Тогда
							Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
												  |	СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.ЦиклОбмена КАК ЦиклОбмена
												  |ИЗ
												  |	РегистрСведений.СодержимоеТранспортныхКонтейнеров КАК СодержимоеТранспортныхКонтейнеров
												  |ГДЕ
												  |	СодержимоеТранспортныхКонтейнеров.ИмяФайла = &ИмяФайла
												  |	И СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.Статус = &Статус
												  |	И СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.УчетнаяЗапись = &УчетнаяЗапись
												  |
												  |УПОРЯДОЧИТЬ ПО
												  |	СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.ДатаТранспорта УБЫВ");
							Запрос.УстановитьПараметр("ИмяФайла", СокрЛП(ИсходнаяТема));
							Запрос.УстановитьПараметр("Статус", Перечисления.СтатусыПисем.Отправленное);
							Запрос.УстановитьПараметр("УчетнаяЗапись", Объект.УчетнаяЗапись);
							РезультатЗапроса = Запрос.Выполнить();
							Если НЕ РезультатЗапроса.Пустой() Тогда
								Выборка = РезультатЗапроса.Выбрать();
								Если Выборка.Следующий() Тогда
									_ЦиклОбмена = Выборка.ЦиклОбмена;
								КонецЕсли;
							КонецЕсли;
						КонецЕсли;
							
					КонецЕсли;
					
				КонецЕсли;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(_ЦиклОбмена) Тогда
				Объект.ЦиклОбмена = _ЦиклОбмена;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// если распознали цикл обмена, то пробуем еще раз распознать нераспознанных отправителя и получателя
	Если ЗначениеЗаполнено(Объект.ЦиклОбмена) Тогда
		Если НЕ ЗначениеЗаполнено(Объект.Получатель) 
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО
		ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО Тогда
			Объект.Получатель = ОпределитьПолучателяВходящегоТранспортногоСообщения(Объект);
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Объект.Отправитель) Тогда
			Объект.Отправитель = ОпределитьОтправителяВходящегоТранспортногоСообщения(Объект);
		КонецЕсли;
	КонецЕсли;
	
	// фиксируем изменения
	Если Записывать И Объект.Модифицированность() Тогда
		Объект.Записать();
	КонецЕсли;
	
КонецПроцедуры

// есть в Контейнере
Функция НайтиЦиклОбменаПоИдентификатору(ИдентификаторДокументооборота)
	
	Результат = Неопределено;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ЦиклыОбмена.Ссылка КАК Ссылка,
						  |	ВЫБОР
						  |		КОГДА ИсходящееТранспортноеСообщение.Ссылка ЕСТЬ NULL
						  |			ТОГДА ВЫБОР
						  |				КОГДА НЕ ОтправленноеТранспортноеСообщение.Ссылка ЕСТЬ NULL
						  |					ТОГДА 3
						  |				ИНАЧЕ 2
						  |			КОНЕЦ
						  |		ИНАЧЕ 1
						  |	КОНЕЦ КАК НаличиеОтправокОтсутствиеОшибок
						  |ИЗ
						  |	Справочник.ЦиклыОбмена КАК ЦиклыОбмена
						  |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
						  |			ТранспортноеСообщение.Ссылка КАК Ссылка,
						  |			ТранспортноеСообщение.ЦиклОбмена КАК ЦиклОбмена
						  |		ИЗ
						  |			Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
						  |		ГДЕ
						  |			ТранспортноеСообщение.ЦиклОбмена.Идентификатор = &ИдентификаторДокументооборота
						  |			И ТранспортноеСообщение.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыПисем.Исходящее)) КАК ИсходящееТранспортноеСообщение
						  |		ПО ЦиклыОбмена.Ссылка = ИсходящееТранспортноеСообщение.ЦиклОбмена
						  |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
						  |			ТранспортноеСообщение.Ссылка КАК Ссылка,
						  |			ТранспортноеСообщение.ЦиклОбмена КАК ЦиклОбмена
						  |		ИЗ
						  |			Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
						  |		ГДЕ
						  |			ТранспортноеСообщение.ЦиклОбмена.Идентификатор = &ИдентификаторДокументооборота
						  |			И ТранспортноеСообщение.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыПисем.Отправленное)) КАК ОтправленноеТранспортноеСообщение
						  |		ПО ЦиклыОбмена.Ссылка = ОтправленноеТранспортноеСообщение.ЦиклОбмена
						  |	ГДЕ
						  |		ЦиклыОбмена.Идентификатор = &ИдентификаторДокументооборота
						  |	УПОРЯДОЧИТЬ ПО
						  |		НаличиеОтправокОтсутствиеОшибок УБЫВ,
						  |		ЦиклыОбмена.ДатаСоздания УБЫВ");
	
	Запрос.УстановитьПараметр("ИдентификаторДокументооборота", ИдентификаторДокументооборота);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьТипЦиклаОбменаПоСообщениюРассылки(Сообщение)
	
	Контейнеры = ПолучитьТранспортныйКонтейнер(Сообщение);
	Если Контейнеры.Количество() = 0 Тогда
		Возврат Перечисления.ТипыЦикловОбмена.ПустаяСсылка();
	КонецЕсли;
	ИмяКонтейнера = нрег(Контейнеры[0].ИмяФайла);
	
	СуффиксКонтейнераРассылкаГрупповая = "05_01_01.zip";
	Если Прав(ИмяКонтейнера, СтрДлина(СуффиксКонтейнераРассылкаГрупповая)) = СуффиксКонтейнераРассылкаГрупповая Тогда
		Возврат Перечисления.ТипыЦикловОбмена.РассылкаГрупповая;
	Иначе
		Возврат Перечисления.ТипыЦикловОбмена.Рассылка;
	КонецЕсли;
	
КонецФункции

// есть в Контейнере и в Общем модуле РегламентированнаяОтчетность
Функция ИзвлечьИдентификаторДокументооборотаИзПакета(ОбъектСообщение)
	
	// выгружаем контейнер во временный файл
	ИмяФайлаКонтейнера = ПолучитьИмяВременногоФайла();
	Контейнер = ПолучитьТранспортныйКонтейнер(ОбъектСообщение.Ссылка, Истина);
	Если НЕ ЗначениеЗаполнено(Контейнер) ИЛИ Контейнер.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	Контейнер[0].Данные.Получить().Записать(ИмяФайлаКонтейнера);
	
	// распаковываем файл описания сведений архива
	ИмяФайлаОписанияСведений = "packageDescription.xml";
	ЧтениеЗИП = Новый ЧтениеZipФайла(ИмяФайлаКонтейнера);
	ЭлементОписаниеСведений = ЧтениеЗИП.Элементы.Найти(ИмяФайлаОписанияСведений);
	Если ЭлементОписаниеСведений = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	КаталогРаспаковки = СоздатьВременныйКаталогСервер();
	ЧтениеЗИП.Извлечь(ЭлементОписаниеСведений, КаталогРаспаковки, РежимВосстановленияПутейФайловZIP.НеВосстанавливать);
	
	// читаем XML
	ТекстXML = ПрочитатьТекстИзФайла(КаталогРаспаковки + ИмяФайлаОписанияСведений, , Истина);
	Если НЕ ЗначениеЗаполнено(ТекстXML) Тогда
		ЧтениеЗИП.Закрыть();
		УдалитьВременныйФайл(ИмяФайлаКонтейнера);
		УдалитьВременныйФайл(КаталогРаспаковки);
		Возврат Неопределено;
	КонецЕсли;
	
	// загружаем XML в дерево
	ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(ТекстXML);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		ЧтениеЗИП.Закрыть();
		УдалитьВременныйФайл(ИмяФайлаКонтейнера);
		УдалитьВременныйФайл(КаталогРаспаковки);
		Возврат Неопределено;
	КонецЕсли;
	
	// в случае уведомления об ошибке, источником для получения идентификатора пакета должен служить
	// документ описаниеОшибочногоПакета, на который ссылается описание пакета
	Если ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР
	ИЛИ ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС
	ИЛИ ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС
	ИЛИ ОбъектСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка Тогда
		
		// находим элемент описаниеОшибочногоПакета
		Узлы_ТипДокументаОписаниеОшибочногоПакета = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип, Значение", "типДокумента", "А", "описаниеОшибочногоПакета"), Истина);
		Если Узлы_ТипДокументаОписаниеОшибочногоПакета.Количество() > 0 Тогда
			
			Узел_ОписаниеОшибочногоПакета = Узлы_ТипДокументаОписаниеОшибочногоПакета[0].Родитель;
			
			// ищем в подчинении элемент Содержимое
			УзлыСодержимое = Узел_ОписаниеОшибочногоПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "содержимое", "Э"));
			Если УзлыСодержимое.Количество() > 0 Тогда
				
				// ищем в подчинении атрибут имяФайла
				УзелСодержимое = УзлыСодержимое[0];
				УзлыИмяФайла = УзелСодержимое.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "имяФайла", "А"));
				Если УзлыИмяФайла.Количество() > 0 Тогда
					
					УзелИмяФайла = УзлыИмяФайла[0];
					ИмяФайлаОписанияОшибочногоПакета = СокрЛП(УзелИмяФайла.Значение);
					
					ЭлементОписаниеСведений = ЧтениеЗИП.Элементы.Найти(ИмяФайлаОписанияОшибочногоПакета);
					Если ЭлементОписаниеСведений <> Неопределено Тогда
						
						ЧтениеЗИП.Извлечь(ЭлементОписаниеСведений, КаталогРаспаковки, РежимВосстановленияПутейФайловZIP.НеВосстанавливать);
						
						// распаковываем
						ПолноеИмяФайлаДокумента = РазархивироватьФайл(КаталогРаспаковки + ИмяФайлаОписанияОшибочногоПакета);
						Если ПолноеИмяФайлаДокумента <> Неопределено Тогда
						
							// читаем XML
							ТекстXML = ПрочитатьТекстИзФайла(ПолноеИмяФайлаДокумента, , Истина);
							Если ЗначениеЗаполнено(ТекстXML) Тогда
								
								// загружаем XML в дерево
								_ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(ТекстXML);
								
								// подменяем дерево описания сведений
								Если _ДеревоXML <> Неопределено Тогда
									ДеревоXML = _ДеревоXML;
								КонецЕсли;
								
							КонецЕсли;
							
							УдалитьВременныйФайл(ПолноеИмяФайлаДокумента);
							
						КонецЕсли;
						
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// закрываем архив и удаляем временный файл контейнера
	ЧтениеЗИП.Закрыть();
	УдалитьВременныйФайл(ИмяФайлаКонтейнера);
	УдалитьВременныйФайл(КаталогРаспаковки);
	
	// ищем атрибут "идентификаторДокументооборота"
	Узлы_идентификаторДокументооборота = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "идентификаторДокументооборота", "А"), Истина);
	Если Узлы_идентификаторДокументооборота.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// возвращаем первое найденное значение атрибута
	Возврат СокрЛП(Узлы_идентификаторДокументооборота[0].Значение);
	
КонецФункции

// есть в Контейнере и в Общем модуле РегламентированнаяОтчетность
Функция СоздатьВременныйКаталогСервер() Экспорт
	
	ИмяКаталога = КаталогВременныхФайлов();
	РазделительПутиОС = ПолучитьРазделительПути();
	Если Прав(ИмяКаталога, 1) <> РазделительПутиОС Тогда
		ИмяКаталога = ИмяКаталога + РазделительПутиОС;
	КонецЕсли;
	
	ИмяКаталога = ИмяКаталога + Строка(Новый УникальныйИдентификатор) + РазделительПутиОС;
	СоздатьКаталог(ИмяКаталога);
	
	Возврат ИмяКаталога;
	
КонецФункции

// есть и в модуле и в Контейнере
Функция РазархивироватьФайл(ИмяФайлаАрхива, ИмяРаспакованногоФайла = Неопределено)
	
	Попытка
		ОбъектЧтение = Новый ЧтениеZipФайла(ИмяФайлаАрхива);
		Если ОбъектЧтение.Элементы.Количество() = 0 Тогда
			ОбъектЧтение.Закрыть();
			Возврат Неопределено;
		КонецЕсли;
		
		КаталогРаспаковки = ПолучитьИмяВременногоФайла() + ПолучитьРазделительПути();
		СоздатьКаталог(КаталогРаспаковки);
		ИмяФайлаИзАрхива = ОбъектЧтение.Элементы[0].Имя;
		
		ОбъектЧтение.Извлечь(ОбъектЧтение.Элементы[0], КаталогРаспаковки, РежимВосстановленияПутейФайловZIP.НеВосстанавливать);
		ОбъектЧтение.Закрыть();
		
		Если ИмяРаспакованногоФайла = Неопределено Тогда
			Возврат КаталогРаспаковки + ИмяФайлаИзАрхива;
		Иначе
			ПереместитьФайл(КаталогРаспаковки + ИмяФайлаИзАрхива, ИмяРаспакованногоФайла);
			Возврат ИмяРаспакованногоФайла;
		КонецЕсли;
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru='Ошибка распаковки архива: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьПолучателяВходящегоТранспортногоСообщения(Объект)
	
	Если ЗначениеЗаполнено(Объект.ЦиклОбмена) И Объект.Статус = Перечисления.СтатусыПисем.Полученное Тогда
		Возврат Объект.ЦиклОбмена.Организация;
	КонецЕсли;
	
	Если Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколПФР 
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР Тогда
		
		Результат = ОпределитьПолучателяВходящегоСообщенияПФР(Объект);
		Если Результат <> Неопределено И Результат <> Справочники.Организации.ПустаяСсылка() Тогда
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС Тогда
		
		Возврат ОпределитьПолучателяВходящегоСообщенияФСГС(Объект);
		
	КонецЕсли;
	
	// если нет возможности определить получателя по циклу обмена, то определим его по учетной записи
	// если с учетной записью сообщения связана головная организация, то считаем, что получатель - она
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	                      |	Организации.Ссылка
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |ГДЕ
	                      |	Организации.УчетнаяЗаписьОбмена = &УчетнаяЗаписьОбмена
	                      |	И Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами
	                      |	И Организации.ГоловнаяОрганизация = &ПустаяГоловнаяОрганизация
	                      |
	                      |ОБЪЕДИНИТЬ ВСЕ
	                      |
	                      |ВЫБРАТЬ ПЕРВЫЕ 1
	                      |	Организации.Ссылка
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |ГДЕ
	                      |	Организации.УчетнаяЗаписьОбмена = &УчетнаяЗаписьОбмена
	                      |	И Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами
	                      |	И Организации.ГоловнаяОрганизация <> &ПустаяГоловнаяОрганизация");
	Запрос.УстановитьПараметр("УчетнаяЗаписьОбмена", Объект.УчетнаяЗапись);
	Запрос.УстановитьПараметр("ВидОбменаСКонтролирующимиОрганами", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	Запрос.УстановитьПараметр("ПустаяГоловнаяОрганизация", Справочники.Организации.ПустаяСсылка());
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Если ЗначениеЗаполнено(Выборка.Ссылка) Тогда
			Возврат Выборка.Ссылка;
		Иначе
			Возврат ?(Выборка.Следующий(), Выборка.Ссылка, Неопределено);
		КонецЕсли;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьПолучателяВходящегоСообщенияПФР(ОбъектСообщение)
	
	// сначала пробуем определить получателя из пакета
	ПолучательИзПакета = ОпределитьПолучателяВходящегоСообщенияПоОписаниюПакетаПФР(ОбъектСообщение);
	Если ЗначениеЗаполнено(ПолучательИзПакета) Тогда
		Возврат ПолучательИзПакета;
	КонецЕсли;
	
	// если по пакету получателя определить не удалось,
	// то пробуем получить из свойств цикла обмена
	ЦиклОбмена = ОбъектСообщение.ЦиклОбмена;
	Если ЗначениеЗаполнено(ЦиклОбмена) Тогда
		ОрганизацияЦиклаОбмена = ЦиклОбмена.Организация;
		Если ЗначениеЗаполнено(ОрганизацияЦиклаОбмена) Тогда
			Возврат ОрганизацияЦиклаОбмена;
		КонецЕсли;
	КонецЕсли;
	
	// если не удалось определить получателя ни по пакету,
	// ни по родительскому циклу обмена, то возвращаем текущее значение
	Возврат ОбъектСообщение.Получатель;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьПолучателяВходящегоСообщенияПоОписаниюПакетаПФР(ОбъектСообщение)
	
	// получаем дерево описания пакета
	ДеревоОписанияПакета = Неопределено;
	Если НЕ ОбъектСообщение.ДополнительныеСвойства.Свойство("ДеревоОписанияПакета", ДеревоОписанияПакета) Тогда
		ДеревоОписанияПакета = ЗагрузитьДеревоОписанияПакетаДляСообщения(ОбъектСообщение);
	КонецЕсли;
	
	// ищем узел "получатель"
	УзлыПолучатель = ДеревоОписанияПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "получатель", "Э"), Истина);
	Если УзлыПолучатель.Количество() = 0 Тогда
		Возврат Справочники.Организации.ПустаяСсылка();
	КонецЕсли;
	УзелПолучатель = УзлыПолучатель[0];
	
	// ищем атрибут "идентификаторСубъекта"
	УзелИдентификаторСубъекта = УзелПолучатель.Строки.Найти("идентификаторСубъекта", "Имя");
	Если УзелИдентификаторСубъекта = Неопределено Тогда
		Возврат Справочники.Организации.ПустаяСсылка();
	КонецЕсли;
	РегистрационныйНомерПФР = СокрЛП(УзелИдентификаторСубъекта.Значение);
	
	// ищем по справочнику
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	                      |	Организации.Ссылка
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |ГДЕ
	                      |	Организации.РегистрационныйНомерПФР = &РегистрационныйНомерПФР
	                      |	И Организации.УчетнаяЗаписьОбмена = &УчетнаяЗаписьОбмена
	                      |	И Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами");
	Запрос.УстановитьПараметр("РегистрационныйНомерПФР", РегистрационныйНомерПФР);
	Запрос.УстановитьПараметр("УчетнаяЗаписьОбмена", ОбъектСообщение.УчетнаяЗапись);
	Запрос.УстановитьПараметр("ВидОбменаСКонтролирующимиОрганами", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Справочники.Организации.ПустаяСсылка();
	Иначе
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Получить(0);
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьПолучателяВходящегоСообщенияФСГС(ОбъектСообщение)
	
	// сначала пробуем определить получателя из пакета
	ПолучательИзПакета = ОпределитьПолучателяВходящегоСообщенияПоОписаниюПакетаФСГС(ОбъектСообщение);
	Если ЗначениеЗаполнено(ПолучательИзПакета) Тогда
		Возврат ПолучательИзПакета;
	КонецЕсли;
	
	// если по пакету получателя определить не удалось,
	// то пробуем получить из свойств цикла обмена
	ЦиклОбмена = ОбъектСообщение.ЦиклОбмена;
	Если ЗначениеЗаполнено(ЦиклОбмена) Тогда
		ОрганизацияЦиклаОбмена = ЦиклОбмена.Организация;
		Если ЗначениеЗаполнено(ОрганизацияЦиклаОбмена) Тогда
			Возврат ОрганизацияЦиклаОбмена;
		КонецЕсли;
	КонецЕсли;
	
	// если не удалось определить получателя ни по пакету,
	// ни по родительскому циклу обмена, то возвращаем текущее значение
	Возврат ОбъектСообщение.Получатель;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьПолучателяВходящегоСообщенияПоОписаниюПакетаФСГС(ОбъектСообщение)
	
	// получаем дерево описания пакета
	ДеревоОписанияПакета = Неопределено;
	Если НЕ ОбъектСообщение.ДополнительныеСвойства.Свойство("ДеревоОписанияПакета", ДеревоОписанияПакета) Тогда
		ДеревоОписанияПакета = ЗагрузитьДеревоОписанияПакетаДляСообщения(ОбъектСообщение);
	КонецЕсли;
	
	// ищем узел "получатель"
	УзлыПолучатель = ДеревоОписанияПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "получатель", "Э"), Истина);
	Если УзлыПолучатель.Количество() = 0 Тогда
		Возврат Справочники.Организации.ПустаяСсылка();
	КонецЕсли;
	УзелПолучатель = УзлыПолучатель[0];
	
	// ищем атрибут "идентификаторСубъекта"
	УзелИдентификаторСубъекта = УзелПолучатель.Строки.Найти("идентификаторСубъекта", "Имя");
	Если УзелИдентификаторСубъекта = Неопределено Тогда
		Возврат Справочники.Организации.ПустаяСсылка();
	КонецЕсли;
	ИдентификаторПолучателя = СокрЛП(УзелИдентификаторСубъекта.Значение);
	КодПоОКПО = Сред(ИдентификаторПолучателя, Найти(ИдентификаторПолучателя, ".") + 1);
	
	ИмяРеквКодПоОКПО = "КодПоОКПО";
	Если Метаданные.Справочники.Организации.Реквизиты.Найти("КодОКПО") <> Неопределено Тогда
		ИмяРеквКодПоОКПО = "КодОКПО";
	КонецЕсли;
	
	// ищем по справочнику
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	                      |	Организации.Ссылка
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |ГДЕ
	                      |	Организации." + ИмяРеквКодПоОКПО + " = &КодПоОКПО
	                      |	И Организации.УчетнаяЗаписьОбмена = &УчетнаяЗаписьОбмена
	                      |	И Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами");
	Запрос.УстановитьПараметр("КодПоОКПО", КодПоОКПО);
	Запрос.УстановитьПараметр("УчетнаяЗаписьОбмена", ОбъектСообщение.УчетнаяЗапись);
	Запрос.УстановитьПараметр("ВидОбменаСКонтролирующимиОрганами", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Справочники.Организации.ПустаяСсылка();
	Иначе
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Получить(0);
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ЗагрузитьДеревоОписанияПакетаДляСообщения(ОбъектСообщение)
	
	СообщениеСсылка = ОбъектСообщение.Ссылка;
	
	ТранспортныеКонтейнеры = ПолучитьТранспортныйКонтейнер(СообщениеСсылка, Истина);
	Если ТранспортныеКонтейнеры.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	ТранспортныйКонтейнер = ТранспортныеКонтейнеры[0];
	
	// выгружаем пакет во временный файл
	КаталогРаспаковки = СоздатьВременныйКаталогСервер();
	ИмяВременногоФайла = КаталогРаспаковки + ТранспортныйКонтейнер.ИмяФайла;
	Попытка
		ТранспортныйКонтейнер.Данные.Получить().Записать(ИмяВременногоФайла);
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Ошибка выгрузки транспортного пакета во временный файл для анализа:
						|%1'"), ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
		Возврат Неопределено;
	КонецПопытки;
	
	// распаковываем файл описания сведений архива
	Попытка
		ЧтениеЗИП = Новый ЧтениеZipФайла(ИмяВременногоФайла);
	Исключение
		УдалитьВременныйФайл(КаталогРаспаковки);
		Возврат Неопределено;
	КонецПопытки;
	
	ИмяФайлаОписанияСведений = "packageDescription.xml";
	ЭлементОписаниеСведений = ЧтениеЗИП.Элементы.Найти(ИмяФайлаОписанияСведений);
	Если ЭлементОписаниеСведений = Неопределено Тогда
		УдалитьВременныйФайл(КаталогРаспаковки);
		Возврат Неопределено;
	КонецЕсли;
	
	ЧтениеЗИП.Извлечь(ЭлементОписаниеСведений, КаталогРаспаковки, РежимВосстановленияПутейФайловZIP.НеВосстанавливать);
	ЧтениеЗИП.Закрыть();
	
	// читаем XML
	ТекстXML = ПрочитатьТекстИзФайла(КаталогРаспаковки + ИмяФайлаОписанияСведений, , Истина);
	УдалитьВременныйФайл(КаталогРаспаковки);
	Если НЕ ЗначениеЗаполнено(ТекстXML) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// загружаем XML в дерево
	ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(ТекстXML);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// сохраняем дерево в свойствах объекта
	ОбъектСообщение.ДополнительныеСвойства.Вставить("ДеревоОписанияПакета", ДеревоXML);
	
	Возврат ДеревоXML;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьОтправителяВходящегоТранспортногоСообщенияФНС(ОбъектСообщение)
	
	// сначала пробуем определить отправителя из пакета
	ОтправительИзДокумент = ОпределитьОтправителяВходящегоТранспортногоСообщенияПоСвойствамПакетаФНС(ОбъектСообщение);
	Если ТипЗнч(ОтправительИзДокумент) = Тип("СправочникСсылка.НалоговыеОрганы") И ЗначениеЗаполнено(ОтправительИзДокумент) Тогда
		Возврат ОтправительИзДокумент;
	КонецЕсли;
	
	// если не удалось, то пробуем получить из свойств учетной записи
	Если НЕ ОбъектСообщение.УчетнаяЗапись.ОбменНапрямую Тогда
		Возврат ОбъектСообщение.УчетнаяЗапись.СерверДокументооборота;
	Иначе
		Возврат ОбъектСообщение.УчетнаяЗапись.НалоговыйОрган;	
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьОтправителяВходящегоТранспортногоСообщенияПоСвойствамПакетаФНС(ОбъектСообщение)
	
	// получаем дерево описания пакета
	ДеревоОписанияПакета = Неопределено;
	Если НЕ ОбъектСообщение.ДополнительныеСвойства.Свойство("ДеревоОписанияПакета", ДеревоОписанияПакета) Тогда
		ДеревоОписанияПакета = ЗагрузитьДеревоОписанияПакетаДляСообщения(ОбъектСообщение);
	КонецЕсли;
	
	// проверяем дерево на заполненность
	Если НЕ ЗначениеЗаполнено(ДеревоОписанияПакета) Тогда
		Возврат Справочники.НалоговыеОрганы.ПустаяСсылка();
	КонецЕсли;
	
	// ищем узел "отправитель"
	УзлыОтправитель = ДеревоОписанияПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "отправитель", "Э"), Истина);
	Если УзлыОтправитель.Количество() = 0 Тогда
		Возврат Справочники.НалоговыеОрганы.ПустаяСсылка();
	КонецЕсли;
	УзелОтправитель = УзлыОтправитель[0];
	
	// ищем атрибут "идентификаторСубъекта"
	УзелИдентификаторСубъекта = УзелОтправитель.Строки.Найти("идентификаторСубъекта", "Имя");
	Если УзелИдентификаторСубъекта = Неопределено Тогда
		Возврат Справочники.НалоговыеОрганы.ПустаяСсылка();
	КонецЕсли;
	КодОрганаФНС = СокрЛП(УзелИдентификаторСубъекта.Значение);
	
	// ищем по справочнику
	РезультатПоиска = Справочники.НалоговыеОрганы.НайтиПоКоду(КодОрганаФНС);
	Возврат РезультатПоиска;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьОтправителяВходящегоТранспортногоСообщения(Объект)
	
	Если ЗначениеЗаполнено(Объект.Отправитель) Тогда
		Возврат Объект.Отправитель;
	ИначеЕсли Объект.Статус <> Перечисления.СтатусыПисем.Полученное Тогда
		Возврат Неопределено;
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР Тогда
		Возврат ОпределитьОтправителяВходящегоТранспортногоСообщенияПФР(Объект);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС Тогда
		Возврат ОпределитьОтправителяВходящегоТранспортногоСообщенияФСГС(Объект);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПисьмоНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РассылкаНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ДокументНО Тогда
		Возврат ОпределитьОтправителяВходящегоТранспортногоСообщенияФНС(Объект);
	ИначеЕсли НЕ Объект.УчетнаяЗапись.ОбменНапрямую Тогда
		Возврат Объект.УчетнаяЗапись.СерверДокументооборота;
	КонецЕсли;
	
	Если Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО Тогда
		ОтправительСообщения = Объект.УчетнаяЗапись.СерверДокументооборота;
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗапросНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО
	//заявление
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗаявлениеНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО
	
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО
	
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО	
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО Тогда
		ОтправительСообщения = Объект.УчетнаяЗапись.НалоговыйОрган;



	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка Тогда
		ОтправительСообщения = ОпределитьСерверДокументооборотаПоАдресуЭлектроннойПочты(Объект.ОтКогоАдрес);
		Если НЕ ЗначениеЗаполнено(ОтправительСообщения) Тогда
			ОтправительСообщения = ОпределитьНалоговыйОрганПоАдресуЭлектроннойПочты(Объект.ОтКогоАдрес);
		КонецЕсли;
	КонецЕсли;
	
	Возврат ОтправительСообщения;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьНалоговыйОрганПоАдресуЭлектроннойПочты(АдресЭлектроннойПочты, ОпределитьСерверДокументооборотаПриНеобходимости = Истина) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	                      |	НалоговыеОрганы.Ссылка
	                      |ИЗ
	                      |	Справочник.НалоговыеОрганы КАК НалоговыеОрганы
	                      |ГДЕ
	                      |	НалоговыеОрганы.АдресЭлектроннойПочтыДляЦелейДокументооборотаСНалогоплательщиками = &АдресЭлектроннойПочты");
	Запрос.УстановитьПараметр("АдресЭлектроннойПочты", АдресЭлектроннойПочты);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	Если ОпределитьСерверДокументооборотаПриНеобходимости Тогда
		Возврат ОпределитьСерверДокументооборотаПоАдресуЭлектроннойПочты(АдресЭлектроннойПочты, Ложь);
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьСерверДокументооборотаПоАдресуЭлектроннойПочты(АдресЭлектроннойПочты, ОпределитьНалоговыйОрганПриНеобходимости = Истина) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	                      |	СерверыДокументооборота.Ссылка
	                      |ИЗ
	                      |	Справочник.СерверыДокументооборота КАК СерверыДокументооборота
	                      |ГДЕ
	                      |	СерверыДокументооборота.АдресЭлектроннойПочтыФНС = &АдресЭлектроннойПочты
	                      |	ИЛИ СерверыДокументооборота.АдресЭлектроннойПочтыПФР = &АдресЭлектроннойПочты
	                      |	ИЛИ СерверыДокументооборота.АдресЭлектроннойПочтыФСГС = &АдресЭлектроннойПочты");
	Запрос.УстановитьПараметр("АдресЭлектроннойПочты", АдресЭлектроннойПочты);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	Если ОпределитьНалоговыйОрганПриНеобходимости Тогда
		Возврат ОпределитьНалоговыйОрганПоАдресуЭлектроннойПочты(АдресЭлектроннойПочты, Ложь);
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьОтправителяВходящегоТранспортногоСообщенияПФР(ОбъектСообщение)
	
	// сначала пробуем определить отправителя из пакета
	ОтправительИзПакета = ОпределитьОтправителяВходящегоТранспортногоСообщенияПоСвойствамПакетаПФР(ОбъектСообщение);
	Если ЗначениеЗаполнено(ОтправительИзПакета) Тогда
		Возврат ОтправительИзПакета;
	КонецЕсли;
	
	// если по пакету отправителя определить не удалось,
	// то пробуем получить из свойств цикла обмена
	ЦиклОбмена = ОбъектСообщение.ЦиклОбмена;
	Если ЗначениеЗаполнено(ЦиклОбмена) Тогда
		ВнешняяОрганизация = ЦиклОбмена.ВнешняяОрганизация;
		Если ЗначениеЗаполнено(ВнешняяОрганизация) Тогда
			Возврат ВнешняяОрганизация;
		КонецЕсли;
	КонецЕсли;
	
	// если не удалось определить отправителя ни по пакету,
	// ни по родительскому циклу обмена, то возвращаем текущее значение
	Возврат ОбъектСообщение.Отправитель;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьОтправителяВходящегоТранспортногоСообщенияПоСвойствамПакетаПФР(ОбъектСообщение)
	
	// получаем дерево описания пакета
	ДеревоОписанияПакета = Неопределено;
	Если НЕ ОбъектСообщение.ДополнительныеСвойства.Свойство("ДеревоОписанияПакета", ДеревоОписанияПакета) Тогда
		ДеревоОписанияПакета = ЗагрузитьДеревоОписанияПакетаДляСообщения(ОбъектСообщение);
	КонецЕсли;
	
	// проверяем дерево на заполненность
	Если НЕ ЗначениеЗаполнено(ДеревоОписанияПакета) Тогда
		Возврат Справочники.ОрганыПФР.ПустаяСсылка();
	КонецЕсли;
	
	// ищем узел "отправитель"
	УзлыОтправитель = ДеревоОписанияПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "отправитель", "Э"), Истина);
	Если УзлыОтправитель.Количество() = 0 Тогда
		Возврат Справочники.ОрганыПФР.ПустаяСсылка();
	КонецЕсли;
	УзелОтправитель = УзлыОтправитель[0];
	
	// ищем атрибут "идентификаторСубъекта"
	УзелИдентификаторСубъекта = УзелОтправитель.Строки.Найти("идентификаторСубъекта", "Имя");
	Если УзелИдентификаторСубъекта = Неопределено Тогда
		Возврат Справочники.ОрганыПФР.ПустаяСсылка();
	КонецЕсли;
	КодОрганаПФР = СокрЛП(УзелИдентификаторСубъекта.Значение);
	
	// ищем по справочнику
	РезультатПоиска = Справочники.ОрганыПФР.НайтиПоКоду(КодОрганаПФР);
	Если ЗначениеЗаполнено(РезультатПоиска) Тогда
		Возврат РезультатПоиска;
	КонецЕсли;
	
	// пробуем определить отправителя по циклу обмена
	ЦиклОбмена = ОбъектСообщение.ЦиклОбмена;
	Если ЗначениеЗаполнено(ЦиклОбмена) Тогда
		Возврат ЦиклОбмена.ВнешняяОрганизация;
	Иначе
		Возврат ОбъектСообщение.Отправитель;
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ЯвляетсяОтрицательнымПротоколом(Объект) Экспорт
	
	Если Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО Тогда
		КлючВТеме = "ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаДекларацияНО";
		Возврат ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТеме))) = ВРЕГ(КлючВТеме);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО Тогда
		КлючВТеме = "ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаОбращениеНО";
		Возврат ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТеме))) = ВРЕГ(КлючВТеме);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО Тогда
		КлючВТеме = "ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаПредставлениеНО";
		Возврат ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТеме))) = ВРЕГ(КлючВТеме);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО Тогда
		КлючВТеме = "ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаЗаявлениеНО";
		Возврат ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТеме))) = ВРЕГ(КлючВТеме);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО Тогда
		Возврат СообщениеОПроверкеЯвляетсяОтрицательным(Объект);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО 
	ИЛИ Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО Тогда
		Возврат Истина;
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО Тогда
		КлючВТеме = "ФНС:1.0-уведомлениеОбОтказеОтметки-РезультатОбработкиЗаявлениеНО";
		Возврат ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТеме))) = ВРЕГ(КлючВТеме);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО Тогда
		КлючВТеме = "ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаЗапросНО";
		Возврат ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТеме))) = ВРЕГ(КлючВТеме);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО Тогда
		КлючВТеме = "ФНС:1.0-уведомлениеОбУточнении-РезультатОбработкиДекларацияНО";
		Возврат ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТеме))) = ВРЕГ(КлючВТеме);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляЗапросаИОН Тогда
		КлючВТеме = "ФАЙЛ НЕ ПРИНЯТ";
		Возврат ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТеме))) = КлючВТеме;
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО Тогда
		Возврат Протокол2НДФЛЯвляетсяОтрицательным(Объект);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросИОН Тогда
		Возврат ОтветНаЗапросИОНЯвляетсяОтрицательным(Объект);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР Тогда
		Возврат ОтветНаЗапросИОСЯвляетсяОтрицательным(Объект);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР Тогда
		Возврат ПодтверждениеПолученияОтчетностиПФРЯвляетсяОтрицательным(Объект);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколПФР Тогда
		
		КлючВТемеОтрицательный = "Pension-Protocol-N";
		КлючВТемеПоложительный = "Pension-Protocol-P";
		
		Если ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТемеОтрицательный))) = ВРЕГ(КлючВТемеОтрицательный) Тогда
			Возврат Истина;
		ИначеЕсли ВРЕГ(Лев(СокрЛП(Объект.Тема), СтрДлина(КлючВТемеПоложительный))) = ВРЕГ(КлючВТемеПоложительный) Тогда
			Возврат Ложь;
		Иначе
			Возврат ПротоколПФРЯвляетсяОтрицательным(Объект);
		КонецЕсли;	
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС Тогда
		
		Возврат ПротоколФСГСЯвляетсяОтрицательным(Объект);
	ИначеЕсли Объект.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросаНаВыпискуЕРГЮЛ_ЕГРИП Тогда
		Возврат ВРЕГ(Объект.Тема) = ВРЕГ("СОС:1.0-уведомлениеОбОтказе-РезультатПриемаЗапрос");
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Функция ОтветНаЗапросИОНЯвляетсяОтрицательным(Объект)
	
	// ищем ответ на запрос среди содержимого сообщения
	ОтветыНаЗапросыИОН = ПолучитьВложенияТранспортногоСообщения(Объект.Ссылка, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ОтветНаЗапросИОН);
	ЧислоОтветов = ОтветыНаЗапросыИОН.Количество();
	Если ЧислоОтветов = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// ищем отказ
	ПрефиксИмениФайлаОтказа = "NO_NP";
	Для Каждого ОтветНаЗапросИОН Из ОтветыНаЗапросыИОН Цикл
		Если Лев(ОтветНаЗапросИОН.ИмяФайла, СтрДлина(ПрефиксИмениФайлаОтказа)) = ПрефиксИмениФайлаОтказа Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

Функция Протокол2НДФЛЯвляетсяОтрицательным(Объект)
	
	// ищем протокол 2-НДФЛ среди содержимого сообщения
	Протоколы2НДФЛ = ПолучитьВложенияТранспортногоСообщения(Объект.Ссылка, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Протокол2НДФЛ);
	КоличествоПротоколов = Протоколы2НДФЛ.Количество();
	Если КоличествоПротоколов = 0 Тогда
		Возврат Ложь;
	Иначе
		Протокол2НДФЛ = Протоколы2НДФЛ[0];
	КонецЕсли;
	
	// загружаем протокол из файла в строку
	ТекстОшибки = "";
	ТекстПротокола = ТекстИзФайлаВСтроку(Протокол2НДФЛ, ТекстОшибки);
	Если НЕ ЗначениеЗаполнено(ТекстПротокола) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// последовательно перебираем все строки в поисках строки с числом документов, содержащих ошибки
	КлючСтр = "КОЛИЧЕСТВО ДОКУМЕНТОВ С ОШИБКАМИ";
	Для ИндСтр = 1 По СтрЧислоСтрок(ТекстПротокола) Цикл
		ТекСтр = СтрПолучитьСтроку(ТекстПротокола, ИндСтр);
		
		// ищем ключ в текущей строке
		ВхождениеКлюча = Найти(ВРЕГ(ТекСтр), КлючСтр);
		Если ВхождениеКлюча <> 0 Тогда
			
			// перебираем все символы после ключа и до конца строки
			ПервоеВхождениеЦифры = 0;
			СтрокаКоличествоДокументовСОшибками = Неопределено;
			Для НомерСимвола = ВхождениеКлюча + СтрДлина(КлючСтр) По СтрДлина(ТекСтр) Цикл
				ТекСимв = Сред(ТекСтр, НомерСимвола, 1);
				
				Если ТекСимв >= "0" И ТекСимв <= "9" Тогда // если это цифра
					Если ПервоеВхождениеЦифры = 0 Тогда
						ПервоеВхождениеЦифры = НомерСимвола;
					КонецЕсли;
				Иначе
					Если ПервоеВхождениеЦифры <> 0 Тогда
						СтрокаКоличествоДокументовСОшибками = Сред(ТекСтр, ПервоеВхождениеЦифры, НомерСимвола - ПервоеВхождениеЦифры);
						Прервать;
					КонецЕсли;
				КонецЕсли;
				
			КонецЦикла;
			
			Если НЕ ЗначениеЗаполнено(СтрокаКоличествоДокументовСОшибками) И ПервоеВхождениеЦифры <> 0 Тогда
				СтрокаКоличествоДокументовСОшибками = Сред(ТекСтр, ПервоеВхождениеЦифры);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СтрокаКоличествоДокументовСОшибками) Тогда
				СтрокаКоличествоДокументовСОшибками = СокрЛП(СтрокаКоличествоДокументовСОшибками);
				Если СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(СтрокаКоличествоДокументовСОшибками) Тогда
					КоличествоДокументовСОшибками = Число(СтрокаКоличествоДокументовСОшибками);
					Если КоличествоДокументовСОшибками > 0 Тогда
						Возврат Истина;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	// если в протоколе отсутствует текст "КОЛИЧЕСТВО ДОКУМЕНТОВ С ОШИБКАМИ", то возможно
	// присутствует текст "ФАЙЛ НЕ ПРИНЯТ"
	КлючНеПринят = "ФАЙЛ НЕ ПРИНЯТ";
	Если Найти(ТекстПротокола, КлючНеПринят) <> 0 Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;//!!!
	
КонецФункции

Функция ТекстИзФайлаВСтроку(УведомлениеОбУточнении, ТекстИсключения = Неопределено)
	
	ДанныеУведомления = УведомлениеОбУточнении.Данные;
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	
	Попытка
		ДанныеУведомления.Получить().Записать(ИмяВременногоФайла);
	Исключение
		ТекстИсключения = ИнформацияОбОшибке().Описание;
		Возврат Неопределено;
	КонецПопытки;
	
	ОбъектЧтение = Новый ЧтениеТекста(ИмяВременногоФайла);
	ТекстУведомления = ОбъектЧтение.Прочитать();
	ОбъектЧтение.Закрыть();
	
	УдалитьФайлы(ИмяВременногоФайла);
	
	Возврат ТекстУведомления;
	
КонецФункции

// есть в Контейнере
Функция ПротоколПФРЯвляетсяОтрицательным(Объект)
	
	// получаем протокол из базы
	ОбъектСсылка = Объект.Ссылка;
	СтрПротоколы = ПолучитьВложенияТранспортногоСообщения(ОбъектСсылка, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПротоколПФР);
	Если СтрПротоколы.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// выгружаем данные протокола во временный файл
	СтрПротокол = СтрПротоколы[0];
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	Попытка
		СтрПротокол.Данные.Получить().Записать(ИмяВременногоФайла);
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru='Не удалось выгрузить протокол во временный файл для анализа: %1'"),
																					Символы.ПС + ИнформацияОбОшибке().Описание);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецПопытки;
	
	// загружаем XML из файла в память
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ИмяВременногоФайла);
	УдалитьВременныйФайл(ИмяВременногоФайла);
	Если ДеревоXML = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// ищем атрибут, содержащий статус проверки протокола
	РезультатыПоиска = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "являетсяПоложительным", "Э"), Истина);
	Если РезультатыПоиска.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// преобразовываем значение атрибута к Булево и возвращаем
	ЗначениеАтрибутаСтр = РезультатыПоиска[0].Значение;
	ЗначениеАтрибута = БулевоПоСтроке(ЗначениеАтрибутаСтр);
	Если ЗначениеАтрибута <> Неопределено Тогда
		Возврат НЕ ЗначениеАтрибута;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

// есть в Контейнере
Функция ПротоколФСГСЯвляетсяОтрицательным(Объект)
	
	// получаем протокол из базы
	ОбъектСсылка = Объект.Ссылка;
	
	ТипыДИВ = Новый Массив;
	ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОПриемеВОбработкуОтчетаФСГС);
	ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОНесоответствииФорматуОтчетаФСГС);
	ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбУточненииОтчетаФСГС);
	ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбОтказеОтчетаФСГС);

	СтрПротоколы = ПолучитьВложенияТранспортногоСообщения(ОбъектСсылка, Истина, ТипыДИВ);
	Если СтрПротоколы.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// выгружаем данные протокола во временный файл
	СтрПротокол = СтрПротоколы[0];
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	Попытка
		СтрПротокол.Данные.Получить().Записать(ИмяВременногоФайла);
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось выгрузить протокол во временный файл для анализа'") + ":
				|" + ИнформацияОбОшибке().Описание);
		Возврат Неопределено;
	КонецПопытки;
	
	// считываем текст из файла уведомления
	Попытка
		ТекстПротокола = ПрочитатьТекстИзФайла(ИмяВременногоФайла, , Истина);
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось прочитать текст протокола:%1'"),
																					Символы.ПС + ИнформацияОбОшибке().Описание);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		
		Возврат Неопределено;
	КонецПопытки;
	
	// загружаем XML из строки в дерево
	ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(ТекстПротокола);
	
	Если ДеревоXML <> Неопределено Тогда
	
		УзелПротокол = ДеревоXML.Строки.Найти("protocol", "Имя");
		
		Если УзелПротокол <> Неопределено Тогда
			
			УзелСтатусПротокола = УзелПротокол.Строки.Найти("status", "Имя");
			СтатусПротокола = "";
			Если УзелСтатусПротокола <> Неопределено Тогда
				СтатусПротокола = XMLЗначение(Тип("Строка"), УзелСтатусПротокола.Значение);
			КонецЕсли;
			УзелСообщениеПротокола = УзелПротокол.Строки.Найти("msg", "Имя");
			СообщениеПротокола = "";
			Если УзелСообщениеПротокола <> Неопределено Тогда
				СообщениеПротокола = XMLЗначение(Тип("Строка"), УзелСообщениеПротокола.Значение);
			КонецЕсли;
			
			Если НРег(СтатусПротокола) = "ok" ИЛИ (НРег(СтатусПротокола) = "warnings" И Найти(НРег(СообщениеПротокола), "ошибок не обнаружено") > 0) Тогда
				Возврат Ложь;
			ИначеЕсли УзелПротокол.Строки.Найти("group", "Имя") <> Неопределено Тогда
				Возврат Истина;
			КонецЕсли;
				
		КонецЕсли;
		
	КонецЕсли;
	
	// Исключение из стандарта 456.
	// Требуется полное соответствие строке из внешнего файла
	Если Найти(ВРег(ТекстПротокола), ВРег("Отчёт не принят")) > 0 Тогда
	
		Возврат Истина;
	
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

// есть в Контейнере
Функция БулевоПоСтроке(СтрБулево)
	
	Попытка
		Возврат XMLЗначение(Тип("Булево"), СокрЛП(СтрБулево));
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

// есть и в модуле и в Контейнере
Функция ПодтверждениеПолученияОтчетностиПФРЯвляетсяОтрицательным(Объект)
	
	// получаем протокол из базы
	ОбъектСсылка = Объект.Ссылка;
	СтрПодтвержденияПолучения = ПолучитьВложенияТранспортногоСообщения(ОбъектСсылка, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеПолученияОтчетностиПФР);
	Если СтрПодтвержденияПолучения.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// выгружаем данные протокола во временный файл
	СтрПодтверждениеПолучения = СтрПодтвержденияПолучения[0];
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	Попытка
		СтрПодтверждениеПолучения.Данные.Получить().Записать(ИмяВременногоФайла);
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось выгрузить подтверждение получения отчетности ПФР во временный файл для анализа:%1'"),
																					Символы.ПС + ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
		Возврат Неопределено;
	КонецПопытки;
	
	// загружаем XML из файла в память
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ИмяВременногоФайла);
	УдалитьВременныйФайл(ИмяВременногоФайла);
	Если ДеревоXML = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// ищем атрибут, содержащий статус проверки протокола
	РезультатыПоиска = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "отчетПредставлен", "Э"), Истина);
	Если РезультатыПоиска.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// преобразовываем значение атрибута к Булево и возвращаем
	ЗначениеАтрибутаСтр = РезультатыПоиска[0].Значение;
	ЗначениеАтрибута = БулевоПоСтроке(ЗначениеАтрибутаСтр);
	Если ЗначениеАтрибута <> Неопределено Тогда
		Возврат НЕ ЗначениеАтрибута;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Функция СообщениеОПроверкеЯвляетсяОтрицательным(Объект)
	
	// получаем сообщение о проверке из базы
	ОбъектСсылка = Объект.Ссылка;
	СтрСообщения = ПолучитьВложенияТранспортногоСообщения(ОбъектСсылка, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОПроверке);
	Если СтрСообщения.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// выгружаем данные протокола во временный файл
	СтрСообщениеОПроверке = СтрСообщения[0];
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	Попытка
		СтрСообщениеОПроверке.Данные.Получить().Записать(ИмяВременногоФайла);
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось выгрузить сообщение о проверке во временный файл для анализа:%1'"),
		Символы.ПС + ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
		
		Возврат Неопределено;
	КонецПопытки;
	
	// загружаем XML из файла в память
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ИмяВременногоФайла);
	УдалитьВременныйФайл(ИмяВременногоФайла);
	Если ДеревоXML = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// ищем атрибут, содержащий статус проверки протокола
	РезультатыПоиска = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя", "Отметка"), Истина);
	Если РезультатыПоиска.Количество() = 0 Тогда
		ТекстСообщения = НСтр("ru = 'Не удалось получить отметку о проверке заявления'");
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	// преобразовываем значение атрибута к Булево и возвращаем
	ЗначениеОтметки = СокрЛП(РезультатыПоиска[0].Значение);
	Если ЗначениеОтметки = "1" ИЛИ ЗначениеОтметки = "2" Тогда
		Возврат Ложь;
	ИначеЕсли ЗначениеОтметки = "3" Тогда
		Возврат Истина;
	Иначе 
		ТекстСообщения = НСтр("ru = 'Некорректное значение отметки о проверке заявления'");
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьТипСообщения(Сообщение, ВложенияЕсть = Истина) Экспорт
	
	// получаем значения дополнительных реквизитов заголовка
	Отправитель = "";
	СтрокаОтправитель = Сообщение.ДополнительныеРеквизитыЗаголовка.Найти(Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторОтправителя, "Тип");
	Если СтрокаОтправитель <> Неопределено Тогда
		Отправитель = СтрокаОтправитель.Значение;
	КонецЕсли;
	
	Получатель = "";
	СтрокаПолучатель = Сообщение.ДополнительныеРеквизитыЗаголовка.Найти(Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторПолучателя, "Тип");
	Если СтрокаПолучатель <> Неопределено Тогда
		Получатель = СтрокаПолучатель.Значение;
	КонецЕсли;
	
	ИмяПередающейСистемы = "";
	СтрокаИмяПередающейСистемы = Сообщение.ДополнительныеРеквизитыЗаголовка.Найти(Перечисления.ТипыДополнительныхРеквизитов.ИмяПередающейСистемы, "Тип");
	Если СтрокаИмяПередающейСистемы <> Неопределено Тогда
		ИмяПередающейСистемы = СтрокаИмяПередающейСистемы.Значение;
	КонецЕсли;
	
	ТипПередаваемойИнформации = "";
	СтрокаТипПередаваемойИнформации = Сообщение.ДополнительныеРеквизитыЗаголовка.Найти(Перечисления.ТипыДополнительныхРеквизитов.ТипПередаваемойИнформации, "Тип");
	Если СтрокаТипПередаваемойИнформации <> Неопределено Тогда
		ТипПередаваемойИнформации = СтрокаТипПередаваемойИнформации.Значение;
	КонецЕсли;
	
	ИдентификаторПервичногоСообщения = "";
	СтрокаИдентификаторПервичногоСообщения = Сообщение.ДополнительныеРеквизитыЗаголовка.Найти(Перечисления.ТипыДополнительныхРеквизитов.ИдентификаторПервичногоСообщения, "Тип");
	Если СтрокаИдентификаторПервичногоСообщения <> Неопределено Тогда
		ИдентификаторПервичногоСообщения = СтрокаИдентификаторПервичногоСообщения.Значение;
	КонецЕсли;
	
	// 
	Если ЧислоКонтейнеровСообщения(Сообщение) = 0 И ЗначениеЗаполнено(ИдентификаторПервичногоСообщения) Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка;
	КонецЕсли;
	
	Тема = Сообщение.Тема;
	ВРЕГСокрЛПТема = ВРЕГ(СокрЛП(Тема));
	
	// обход ситуации, когда тема модифицируется антиспам-фильтром
	Если Лев(ВРЕГСокрЛПТема, 5) = "[SPAM" Тогда
		ВхождениеЗакрывающейСкобки = Найти(ВРЕГСокрЛПТема, "]");
		Если ВхождениеЗакрывающейСкобки <> 0 Тогда
			ВРЕГСокрЛПТема = СокрЛП(Сред(ВРЕГСокрЛПТема, ВхождениеЗакрывающейСкобки + 1));
		КонецЕсли;
	Конецесли;
	
	// ФНС 534
	Если ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеДекларацияНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеДекларацияСОС") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-извещениеОПолучении-ИзвещениеДекларацияНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаДекларацияНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-квитанцияОПриеме-РезультатПриемаДекларацияНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-уведомлениеОбУточнении-РезультатОбработкиДекларацияНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-извещениеОВводе-РезультатОбработкиДекларацияНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-сообщениеОбОшибке-СообщениеОбОшибке") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеОтправкиСОС") Тогда
		Если ЗначениеЗаполнено(ИдентификаторПервичногоСообщения) Тогда
			ЦиклОбменаСообщения = НайтиЦиклОбменаПоИдентификатору(ИдентификаторПервичногоСообщения);
			Если ЗначениеЗаполнено(ЦиклОбменаСообщения) Тогда
				Если ЦиклОбменаСообщения.Тип = Перечисления.ТипыЦикловОбмена.НалоговаяИлиБухгалтерскаяОтчетность Тогда
					Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО;
				ИначеЕсли ЦиклОбменаСообщения.Тип = Перечисления.ТипыЦикловОбмена.Заявление Тогда
					Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО;
				ИначеЕсли ЦиклОбменаСообщения.Тип = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ Тогда
					Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО;
				ИначеЕсли ЦиклОбменаСообщения.Тип = Перечисления.ТипыЦикловОбмена.ОбращениеНП Тогда
					Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО;
				ИначеЕсли ЦиклОбменаСообщения.Тип = Перечисления.ТипыЦикловОбмена.Представление Тогда
					Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО;
				ИначеЕсли ЦиклОбменаСообщения.Тип = Перечисления.ТипыЦикловОбмена.ИОН Тогда
					Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО;
				КонецЕсли;
			Иначе
				Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО;
			КонецЕсли;
		Иначе
			Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО;
		КонецЕсли;

	// ФНС 534 ДРП НО
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-документ-ДокументНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ДокументНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-извещениеОПолучении-ИзвещениеРезультатПриемаНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНО;
		
	//Заявление
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеЗаявлениеНО") 
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеЗаявлениеСОС") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-извещениеОПолучении-ИзвещениеЗаявлениеНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗаявлениеНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаЗаявлениеНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-квитанцияОПриеме-РезультатПриемаЗаявлениеНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-сообщениеОПроверке-РезультатОбработкиЗаявлениеРФНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-сообщениеОбОтзывеЗаявления-СообщениеОбОтзывеЗаявлениеРФНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-сообщениеОНесоответствиях-РезультатОбработкиЗаявлениеТСНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО;
		
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-сообщениеОПростОтметки-РезультатОбработкиЗаявлениеНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-уведомлениеОбОтказеОтметки-РезультатОбработкиЗаявлениеНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО;
		
	//Запрос на выписку из ЕГР(ЮЛ\ИП)
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("СОС:1.0-уведомлениеОбОтказе-РезультатПриемаЗапрос") ИЛИ
		ВРЕГСокрЛПТема = ВРЕГ("СОС:1.0-ответ-РезультатОбработкиЗапрос") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросаНаВыпискуЕРГЮЛ_ЕГРИП;
		
	// ФНС 534 2-НДФЛ
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеФорма2НДФЛНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-извещениеОПолучении-ИзвещениеФорма2НДФЛНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-протоколПриема2НДФЛ-РезультатПриемаФорма2НДФЛНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО;
		
	// ФНС 534 НФД НП
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеОбращениеНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеОбращениеСОС")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыПолучения-ПодтверждениеОбращениеНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыПолучения-ПодтверждениеОбращениеСОС") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-извещениеОПолучении-ИзвещениеОбращениеНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаОбращениеНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО;
		
	// ФНС 534 Представление
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеПредставлениеНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеПредставлениеСОС")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыПолучения-ПодтверждениеПредставлениеНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыПолучения-ПодтверждениеПредставлениеСОС") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-извещениеОПолучении-ИзвещениеПредставлениеНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаПредставлениеНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-квитанцияОПриеме-РезультатПриемаПредставлениеНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО;
		
	// ФНС 534 НФД НО
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-письмо-ПисьмоНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-рассылка-РассылкаНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РассылкаНО;
		
	// ФНС 534 ИОН
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыПолучения-ПодтверждениеЗапросНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыПолучения-ПодтверждениеЗапросСОС")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеЗапросНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-подтверждениеДатыОтправки-ПодтверждениеЗапросСОС") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-извещениеОПолучении-ИзвещениеЗапросНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗапросНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-уведомлениеОбОтказе-РезультатПриемаЗапросНО")
	ИЛИ ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-квитанцияОПриеме-РезультатПриемаЗапросНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО;
	ИначеЕсли ВРЕГСокрЛПТема = ВРЕГ("ФНС:1.0-ответ-РезультатОбработкиЗапросНО") Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО;
	// Росстат через Такском, Калуга-Астрал и др.
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("Stat-Confirmation")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("ReSign: Stat-Unformal")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("ReSign: Stat")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("Stat-Error-Notification")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("Stat-Unformal")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("Stat-Protocol")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС;
	// ПФР через Такском
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("ReSign: Pension-Unformal")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("ReSign: Pension-Request")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("ReSign: Pension")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("Pension-Error-Notification")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("Pension-Unformal")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("Pension-Protocol-")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ПротоколПФР;
	ИначеЕсли Найти(ВРЕГСокрЛПТема, ВРЕГ("Pension-Reply")) <> 0 Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР;
		
	// ПФР через прочих
	Иначе
		
		// считываем с кэшированием
		ДеревоОписанияПакета = Неопределено;
		Если НЕ Сообщение.ДополнительныеСвойства.Свойство("ДеревоОписанияПакета", ДеревоОписанияПакета) Тогда
			ДеревоОписанияПакета = ЗагрузитьДеревоОписанияПакетаДляСообщения(Сообщение);
			Сообщение.ДополнительныеСвойства.Вставить("ДеревоОписанияПакета", ДеревоОписанияПакета);
		КонецЕсли;
		
		// определяем тип сообщения
		ТипСообщения = Неопределено;
		Если ДеревоОписанияПакета <> Неопределено Тогда
			ТипСообщения = ОпределитьТипСообщенияПоДеревуОписанияПакета(ДеревоОписанияПакета);
		КонецЕсли;
		
		// если тип определить не удалось, то устанавливаем тип Прочее
		Если ТипСообщения = Неопределено Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.Прочее;
		Иначе
			Возврат ТипСообщения;
		КонецЕсли;
		
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
// Только для ПФР. Для ФНС определение производится по теме сообщения.
// 
Функция ОпределитьТипСообщенияПоДеревуОписанияПакета(ДеревоОписанияПакета)
	
	// ищем ключевые узлы
	УзлыТипДокументооборота = ДеревоОписанияПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "типДокументооборота", "А"), Истина);
	УзлыТипТранзакции = ДеревоОписанияПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "типТранзакции", "А"), Истина);
	Если УзлыТипДокументооборота.Количество() = 0 ИЛИ УзлыТипТранзакции.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	УзелТипДокументооборота = УзлыТипДокументооборота[0];
	УзелТипТранзакции = УзлыТипТранзакции[0];
	
	// получаем значения узлов
	ТипДокументооборота = СокрЛП(УзелТипДокументооборота.Значение);
	ТипТранзакции = СокрЛП(УзелТипТранзакции.Значение);
	
	ЭтоФорматФСГС = Ложь;
	УзлыВерсияФормата = ДеревоОписанияПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "версияФормата", "А"), Истина);
	Если УзлыВерсияФормата.Количество() > 0 Тогда
		ВерсияФормата = СокрЛП(УзлыТипТранзакции[0].Значение);
		Если Найти(ВРЕГ(ВерсияФормата), "СТАТ") > 0 Тогда
			ЭтоФорматФСГС = Истина;
		КонецЕсли; 
	КонецЕсли;
	
	// анализируем значения
	Если ТипДокументооборота = "СведенияПФР" Тогда
		Если ТипТранзакции = "сведения" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР;
		ИначеЕсли ТипТранзакции = "подтверждениеПолучения" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР;
		ИначеЕсли ТипТранзакции = "протокол" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПротоколПФР;
		ИначеЕсли ТипТранзакции = "протоколКвитанция" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР;
		КонецЕсли;
	ИначеЕсли ТипДокументооборота = "УточнениеПлатежей" Тогда
		Если ТипТранзакции = "запрос" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР;
		ИначеЕсли ТипТранзакции = "ответКвитанция" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР;
		ИначеЕсли ТипТранзакции = "ответ" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР;
		ИначеЕсли ТипТранзакции = "запросКвитанция" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР;
		КонецЕсли;
	ИначеЕсли ТипДокументооборота = "Письмо" Тогда
		Если ТипТранзакции = "письмо" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР;
		ИначеЕсли ТипТранзакции = "письмоКвитанция" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР;
		КонецЕсли;
	ИначеЕсли ТипДокументооборота = "ОшибкаОбработкиПакета" И НЕ ЭтоФорматФСГС Тогда
		Возврат Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР;
	ИначеЕсли ТипДокументооборота = "отчетСтат" Тогда
		Если ТипТранзакции = "отчет" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС;
		ИначеЕсли ТипТранзакции = "отчетИзвещение" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС;
		ИначеЕсли ТипТранзакции = "протокол" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС;
		ИначеЕсли ТипТранзакции = "протоколИзвещение" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС;
		ИначеЕсли ТипТранзакции = "подтверждениеОператора" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС;
		ИначеЕсли ТипТранзакции = "подтверждениеКвитанция" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС;
		КонецЕсли;
	ИначеЕсли ТипДокументооборота = "письмоОрганФСГС" Тогда
		Если ТипТранзакции = "письмо" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС;
		ИначеЕсли ТипТранзакции = "извещение" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС;
		КонецЕсли;
	ИначеЕсли ТипДокументооборота = "письмоРеспондент" И ЭтоФорматФСГС Тогда
		Если ТипТранзакции = "письмо" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС;
		ИначеЕсли ТипТранзакции = "извещение" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС;
		ИначеЕсли ТипТранзакции = "подтверждениеОператора" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС;
		ИначеЕсли ТипТранзакции = "подтверждениеКвитанция" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС;
		КонецЕсли;
	ИначеЕсли ТипДокументооборота = "ОшибкаОбработкиПакета" Тогда
		Если ТипТранзакции = "уведомлениеОбОшибке" Тогда
			Возврат Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС;
		КонецЕсли; 
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// есть в Контейнере
Функция ЧислоКонтейнеровСообщения(Сообщение)
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	КОЛИЧЕСТВО(Истина) КАК ЧислоСообщений
						  |ИЗ
						  |	РегистрСведений.ТранспортныеКонтейнеры КАК ТранспортныеКонтейнеры
						  |ГДЕ
						  |	ТранспортныеКонтейнеры.ТранспортноеСообщение = &ТранспортноеСообщение");
	Запрос.УстановитьПараметр("ТранспортноеСообщение", ?(Сообщение.ЭтоНовый(), Сообщение.ПолучитьСсылкуНового(), Сообщение.Ссылка));
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат ?(ЗначениеЗаполнено(Выборка.ЧислоСообщений), Выборка.ЧислоСообщений, 0);
	Иначе
		Возврат 0;
	КонецЕсли;
	
КонецФункции

// есть в Контейнере
Функция ДобавитьТранспортныйКонтейнер(ТранспортноеСообщение, Данные, ИмяФайла, Размер = Неопределено) Экспорт
	
	Если Размер = Неопределено Тогда
		Размер = ОпределитьРазмер(Данные);
	КонецЕсли;
	
	МенеджерЗаписи = РегистрыСведений.ТранспортныеКонтейнеры.СоздатьМенеджерЗаписи();
	МенеджерЗаписи.ТранспортноеСообщение = ТранспортноеСообщение;
	МенеджерЗаписи.ИмяФайла = ИмяФайла;
	МенеджерЗаписи.Размер = Размер;
	
	ТипДанных = ТипЗнч(Данные);
	Если ТипДанных = Тип("ХранилищеЗначения") Тогда
		МенеджерЗаписи.Данные = Данные;
	ИначеЕсли ТипДанных = Тип("Строка") Тогда
		МенеджерЗаписи.Данные = Новый ХранилищеЗначения(Новый ДвоичныеДанные(Данные), Новый СжатиеДанных(9));
	Иначе // если двоичные данные
		МенеджерЗаписи.Данные = Новый ХранилищеЗначения(Данные, Новый СжатиеДанных(9));
	КонецЕсли;
	
	Попытка
		МенеджерЗаписи.Записать(Истина);
		Возврат Истина;
	Исключение
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Не удалось сохранить в информационной базе транспортный контейнер сообщения %1!%2'"),
			Символ(34) + ТранспортноеСообщение.Ссылка + Символ(34),
			Символы.ПС + ИнформацияОбОшибке().Описание);
		ЗаписатьСобытиеВЖурнал(УровеньЖурналаРегистрации.Ошибка, ТекстСообщения);
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// есть в Контейнере
Функция УдалитьЛидирующееДвоеточие(Знач ПервичныйИдентификаторСообщения)
	
	ПозицияДвоеточия = Найти(Лев(ПервичныйИдентификаторСообщения, 5), ":");
	Если ПозицияДвоеточия > 0 Тогда 
		ПервичныйИдентификаторСообщения = СокрЛП(Сред(ПервичныйИдентификаторСообщения, ПозицияДвоеточия + 1)); 
	КонецЕсли; 
	Возврат ПервичныйИдентификаторСообщения;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьОтправителяВходящегоТранспортногоСообщенияФСГС(ОбъектСообщение)
	
	// сначала пробуем определить отправителя из пакета
	ОтправительИзПакета = ОпределитьОтправителяВходящегоТранспортногоСообщенияПоСвойствамПакетаФСГС(ОбъектСообщение);
	Если ЗначениеЗаполнено(ОтправительИзПакета) Тогда
		Возврат ОтправительИзПакета;
	КонецЕсли;
	
	// если по пакету отправителя определить не удалось,
	// то пробуем получить из свойств цикла обмена
	ЦиклОбмена = ОбъектСообщение.ЦиклОбмена;
	Если ЗначениеЗаполнено(ЦиклОбмена) Тогда
		ВнешняяОрганизация = ЦиклОбмена.ВнешняяОрганизация;
		Если ЗначениеЗаполнено(ВнешняяОрганизация) Тогда
			Возврат ВнешняяОрганизация;
		КонецЕсли;
	КонецЕсли;
	
	// если не удалось определить отправителя ни по пакету,
	// ни по родительскому циклу обмена, то возвращаем текущее значение
	Возврат ОбъектСообщение.Отправитель;
	
КонецФункции

// есть в Контейнере
Функция ОпределитьОтправителяВходящегоТранспортногоСообщенияПоСвойствамПакетаФСГС(ОбъектСообщение)
	
	// получаем дерево описания пакета
	ДеревоОписанияПакета = Неопределено;
	Если НЕ ОбъектСообщение.ДополнительныеСвойства.Свойство("ДеревоОписанияПакета", ДеревоОписанияПакета) Тогда
		ДеревоОписанияПакета = ЗагрузитьДеревоОписанияПакетаДляСообщения(ОбъектСообщение);
	КонецЕсли;
	
	// проверяем дерево на заполненность
	Если НЕ ЗначениеЗаполнено(ДеревоОписанияПакета) Тогда
		Возврат Справочники.ОрганыФСГС.ПустаяСсылка();
	КонецЕсли;
	
	// ищем узел "отправитель"
	УзлыОтправитель = ДеревоОписанияПакета.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "отправитель", "Э"), Истина);
	Если УзлыОтправитель.Количество() = 0 Тогда
		Возврат Справочники.ОрганыФСГС.ПустаяСсылка();
	КонецЕсли;
	УзелОтправитель = УзлыОтправитель[0];
	
	// ищем атрибут "идентификаторСубъекта"
	УзелИдентификаторСубъекта = УзелОтправитель.Строки.Найти("идентификаторСубъекта", "Имя");
	Если УзелИдентификаторСубъекта = Неопределено Тогда
		Возврат Справочники.ОрганыФСГС.ПустаяСсылка();
	КонецЕсли;
	КодОрганаФСГС = СокрЛП(УзелИдентификаторСубъекта.Значение);
	
	// ищем по справочнику
	РезультатПоиска = Справочники.ОрганыФСГС.НайтиПоКоду(КодОрганаФСГС);
	Если ЗначениеЗаполнено(РезультатПоиска) Тогда
		Возврат РезультатПоиска;
	КонецЕсли;
	
	// пробуем определить отправителя по циклу обмена
	ЦиклОбмена = ОбъектСообщение.ЦиклОбмена;
	Если ЗначениеЗаполнено(ЦиклОбмена) Тогда
		Возврат ЦиклОбмена.ВнешняяОрганизация;
	Иначе
		Возврат ОбъектСообщение.Отправитель;
	КонецЕсли;
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
// Получение требований и представление документов в налоговые органы

Функция ПолучитьКоличествоОтветовНаТребования(Требования) Экспорт
	
	КоличествоОтветов = Новый Соответствие;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ДокументыРеализацииПолномочийНалоговыхОрганов.Ссылка,
	                      |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ОписиИсходящихДокументовВНалоговыеОрганы.Ссылка) КАК КоличествоОтветов
	                      |ИЗ
	                      |	Справочник.ДокументыРеализацииПолномочийНалоговыхОрганов КАК ДокументыРеализацииПолномочийНалоговыхОрганов
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ОписиИсходящихДокументовВНалоговыеОрганы КАК ОписиИсходящихДокументовВНалоговыеОрганы
	                      |		ПО (ОписиИсходящихДокументовВНалоговыеОрганы.Требование = ДокументыРеализацииПолномочийНалоговыхОрганов.Ссылка)
	                      |ГДЕ
	                      |	ДокументыРеализацииПолномочийНалоговыхОрганов.Ссылка В(&Требования)
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ДокументыРеализацииПолномочийНалоговыхОрганов.Ссылка");
	Запрос.УстановитьПараметр("Требования", Требования);
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		КоличествоОтветов.Вставить(Выборка.Ссылка, Выборка.КоличествоОтветов);
	КонецЦикла;
	
	Возврат КоличествоОтветов;
	
КонецФункции

Функция ПолучитьМассивТребованийПоОписиВходящихДокументов(ОписьВходящихДокументовСсылка) Экспорт
	
	МассивТребований = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ 
		|	ОписиВходящихДокументовИзНалоговыхОргановВходящиеДокументы.СсылкаНаОбъект
		|ИЗ
		|	Справочник.ОписиВходящихДокументовИзНалоговыхОрганов.ВходящиеДокументы КАК ОписиВходящихДокументовИзНалоговыхОргановВходящиеДокументы
		|ГДЕ
		|	ОписиВходящихДокументовИзНалоговыхОргановВходящиеДокументы.Ссылка = &ОписьВходящихДокументовСсылка
		|	И ОписиВходящихДокументовИзНалоговыхОргановВходящиеДокументы.СсылкаНаОбъект.ВидДокумента = &ВидДокументаТребование";

	Запрос.УстановитьПараметр("ОписьВходящихДокументовСсылка", ОписьВходящихДокументовСсылка);
	Запрос.УстановитьПараметр("ВидДокументаТребование", Перечисления.ВидыНалоговыхДокументов.ТребованиеОПредставленииДокументов);
	

	Результат = Запрос.Выполнить();

	Выборка = Результат.Выбрать();

	Пока Выборка.Следующий() Цикл
		МассивТребований.Добавить(Выборка.СсылкаНаОбъект);
	КонецЦикла;
	
	Возврат МассивТребований;
	
КонецФункции

Функция ПолучитьОписьВходящихДокументовПоТребованию(ТребованиеСсылка) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	ОписиВходящихДокументовИзНалоговыхОргановВходящиеДокументы.Ссылка 
		|ИЗ
		|	Справочник.ОписиВходящихДокументовИзНалоговыхОрганов.ВходящиеДокументы КАК ОписиВходящихДокументовИзНалоговыхОргановВходящиеДокументы
		|ГДЕ
		|	ОписиВходящихДокументовИзНалоговыхОргановВходящиеДокументы.СсылкаНаОбъект = &ТребованиеСсылка";

	Запрос.УстановитьПараметр("ТребованиеСсылка", ТребованиеСсылка);

	Результат = Запрос.Выполнить();

	Выборка = Результат.Выбрать();

	Пока Выборка.Следующий() Цикл
		Возврат Выборка.Ссылка;
	КонецЦикла;

	Возврат Неопределено;
	
КонецФункции

Функция ПолучитьМассивОписейИсходящихДокументовПоТребованию(ТребованиеСсылка) Экспорт
	
	МассивОписейИсходящихДокументов = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ 		
		|	ОписиИсходящихДокументовВНалоговыеОрганы.Ссылка
		|ИЗ
		|	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы КАК ОписиИсходящихДокументовВНалоговыеОрганы
		|ГДЕ
		|	ОписиИсходящихДокументовВНалоговыеОрганы.Требование = &ТребованиеСсылка";

	Запрос.УстановитьПараметр("ТребованиеСсылка", ТребованиеСсылка);

	Результат = Запрос.Выполнить();

	Выборка = Результат.Выбрать();

	Пока Выборка.Следующий() Цикл
		МассивОписейИсходящихДокументов.Добавить(Выборка.Ссылка);
	КонецЦикла;
	
	Возврат МассивОписейИсходящихДокументов;
	
КонецФункции

Функция ПолучитьМассивОписейИсходящихДокументовПоОписиВходящихДокументов(ОписьВходящихДокументовСсылка) Экспорт
	
	МассивОписейИсходящихДокументов = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ОписиИсходящихДокументовВНалоговыеОрганы.Ссылка 
		|ИЗ
		|	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы КАК ОписиИсходящихДокументовВНалоговыеОрганы
		|ГДЕ
		|	ОписиИсходящихДокументовВНалоговыеОрганы.ОписьВходящихДокументов = &ОписьВходящихДокументовСсылка";

	Запрос.УстановитьПараметр("ОписьВходящихДокументовСсылка", ОписьВходящихДокументовСсылка);

	Результат = Запрос.Выполнить();

	Выборка = Результат.Выбрать();

	Пока Выборка.Следующий() Цикл
		МассивОписейИсходящихДокументов.Добавить(Выборка.Ссылка);
	КонецЦикла;
	
	Возврат МассивОписейИсходящихДокументов;
	
КонецФункции

Функция ПолучитьТекстКоличествоОтветов(ЧислоОтветов) Экспорт
	
	ТекстКоличествоОтветов = СтрЗаменить(ЧислоПрописью(ЧислоОтветов, "НП=Истина, НД=Ложь", "ответ, ответа, ответов, м, , , , ,0"),
										 ЧислоПрописью(ЧислоОтветов, "НП=Ложь, НД=Ложь", " , , , , , , , ,0"),
										 "");
	Возврат Формат(ЧислоОтветов, "ЧГ=") + " " + ТекстКоличествоОтветов;
	
КонецФункции 

Процедура ПередЗаписьюСканированныеДокументыДляПередачиВЭлектронномВиде(Объект, Отказ)

	Если Объект.ПометкаУдаления Тогда
		Возврат;
	КонецЕсли;
	
	Наименование = Строка(Объект.ВидДокумента) + ?(ЗначениеЗаполнено(Объект.НомерДокумента), " " + Объект.НомерДокумента, "") 
	+ ?(ЗначениеЗаполнено(Объект.ДатаДокумента), " от " + Формат(Объект.ДатаДокумента, "ДФ='dd.MM.yyyy ""г.""'"), "");
	Если ЗначениеЗаполнено(Наименование) Тогда
		Объект.Наименование = Наименование;
	КонецЕсли; 
	
КонецПроцедуры

Процедура ПередЗаписьюОписиВходящихДокументов(Объект, Отказ)
	
	Если Объект.ПометкаУдаления Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.Наименование) Тогда
	
		Объект.Наименование = "Опись входящих документов от НО " + Объект.НалоговыйОрган + " от " + Формат(Объект.ДатаСообщения, "ДЛФ=D");
	
	КонецЕсли;

КонецПроцедуры

Процедура ПередЗаписьюОписиИсходящихДокументов(Объект, Отказ)
	
	Если Объект.ПометкаУдаления Тогда
		Возврат;
	КонецЕсли;
	
	Требование = Объект.Требование;
	Наименование = НСтр("ru = 'Ответ на требование о представлении документов'");
	Если ЗначениеЗаполнено(Требование) Тогда
		Наименование = Наименование + " " + Строка(Требование.НомерДокумента) + " от " + Формат(Требование.ДатаДокумента, "ДЛФ=D");
	КонецЕсли;
	
	Объект.Наименование = Наименование;

КонецПроцедуры

Процедура ОбработкаЗаполненияОписиИсходящихДокументов(Объект, ДанныеЗаполнения)
	
	Если ДанныеЗаполнения = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ДанныеЗаполнения.Свойство("ОснованиеСсылка") Тогда
		Возврат;
	КонецЕсли;
	
	Основание = ДанныеЗаполнения.ОснованиеСсылка;
	
	Если ТипЗнч(Основание) = Тип("СправочникСсылка.ДокументыРеализацииПолномочийНалоговыхОрганов") Тогда	
		
		Объект.ДатаСоздания = ТекущаяДатаСеанса();
		Объект.Требование = Основание;    
		Объект.НалоговыйОрган = Основание.НалоговыйОрган;
		Объект.Организация = Основание.Организация;
		Объект.ОписьВходящихДокументов = ПолучитьОписьВходящихДокументовПоТребованию(Основание);
		
	ИначеЕсли ТипЗнч(Основание) = Тип("СправочникСсылка.ОписиВходящихДокументовИзНалоговыхОрганов") Тогда
		
		Объект.ДатаСоздания = ТекущаяДатаСеанса();
		Объект.НалоговыйОрган = Основание.НалоговыйОрган;
		Объект.Организация = Основание.Организация;
		Объект.ОписьВходящихДокументов = Основание;
		
		МассивТребований = ПолучитьМассивТребованийПоОписиВходящихДокументов(Основание);
		
		Если МассивТребований.Количество() = 1 Тогда
			Объект.Требование = МассивТребований[0];	
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// есть в контейнере
Функция ПолучитьФайлыДокументовРеализацииПолномочийНалоговыхОрганов(СсылкаДокумент, ИменаВложений = Неопределено) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.ИмяФайла КАК ИмяФайла,
						  |	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Данные КАК Данные
						  |ИЗ
						  |	РегистрСведений.ФайлыДокументовРеализацииПолномочийНалоговыхОрганов КАК ФайлыДокументовРеализацииПолномочийНалоговыхОрганов
						  |ГДЕ
						  |	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Документ = &СсылкаДокумент");
	Запрос.УстановитьПараметр("СсылкаДокумент", СсылкаДокумент);
	Если ИменаВложений <> Неопределено Тогда
		Запрос.Текст = Запрос.Текст + "
						  |	И ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.ИмяФайла В(&ИмяФайла)";
		Запрос.УстановитьПараметр("ИмяФайла", ИменаВложений);
	КонецЕсли;
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// помещает в регистр сведений ФайлыДокументовРеализацииПолномочийНалоговыхОрганов данные файлов, расположенных во временном хранилище
// ТаблицаДобавляемыхФайлов - таблица значений: ИмяФайла, АдресФайла
Функция ПоместитьФайлыДокументовРеализацииПолномочийНалоговыхОрганов(СсылкаДокумент, ТаблицаДобавляемыхФайлов) Экспорт
	
	Попытка
		// Наполняем регистр сведений ФайлыДокументовРеализацииПолномочийНалоговыхОрганов файлами
		НаборЗаписей = РегистрыСведений.ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.СоздатьНаборЗаписей(); 
		НаборЗаписей.Отбор.Документ.Установить(СсылкаДокумент); 
		НаборЗаписей.Прочитать();
		
		Для каждого СтрокаТЗ Из ТаблицаДобавляемыхФайлов Цикл
			
			ИмяФайла 					= СтрокаТЗ.ИмяФайла;
			АдресВоВременномХранилище 	= СтрокаТЗ.АдресФайла;
			
			РасширениеСТочкой = нрег(Прав(ИмяФайла, 4));
			Если РасширениеСТочкой = ".xml" Тогда
				ТипСодержимого = Перечисления.ТипыСодержимогоФайлов.xml;
			Иначе
				ТипСодержимого = Перечисления.ТипыСодержимогоФайлов.Неизвестный;
			КонецЕсли;
			
			ФайлДвоичныеДанные = ПолучитьИзВременногоХранилища(АдресВоВременномХранилище);
			РазмерФайла = ФайлДвоичныеДанные.Размер();
			
			НоваяЗапись = НаборЗаписей.Добавить();
			
			НоваяЗапись.Документ = СсылкаДокумент;
			НоваяЗапись.ИмяФайла = ИмяФайла;
			НоваяЗапись.ТипСодержимого = ТипСодержимого;
			НоваяЗапись.Размер = РазмерФайла;
			НоваяЗапись.Данные = Новый ХранилищеЗначения(ФайлДвоичныеДанные, Новый СжатиеДанных(9));;
			
		КонецЦикла;
		
		НаборЗаписей.Записать();
		
	Исключение
		
		Возврат Ложь;
		
	КонецПопытки;
	
	Возврат Истина;
	
КонецФункции

Функция УдалитьФайлыДокументовРеализацииПолномочийНалоговыхОргановПоВладельцу(ВладелецСсылка, МассивИменФайлов = Неопределено) Экспорт
	
	НаборЗаписей = РегистрыСведений.ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.СоздатьНаборЗаписей(); 
	НаборЗаписей.Отбор.Документ.Установить(ВладелецСсылка);
	
	Если МассивИменФайлов = Неопределено Тогда
		//Требуется удалить все файлы владельца		
		НаборЗаписей.Записать();
	Иначе
		Для каждого ИмяФайла Из МассивИменФайлов Цикл
			НаборЗаписей.Отбор.ИмяФайла.Установить(ИмяФайла);
			НаборЗаписей.Записать();
		КонецЦикла;
	КонецЕсли;
	
КонецФункции

Функция ИзменитьВладельцаФайловДокументовРеализацииПолномочийНалоговыхОрганов(ОписьСсылка, ТаблицаФайловИзменяющихВладельца)
	
	Попытка
		
		МенЗап = РегистрыСведений.ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.СоздатьМенеджерЗаписи();
		
		Для каждого СтрокаТЗ Из ТаблицаФайловИзменяющихВладельца Цикл
			
			МенЗап.Документ = ОписьСсылка;
			МенЗап.ИмяФайла = СтрокаТЗ.ИмяФайла;
			МенЗап.Прочитать();
			Если МенЗап.Выбран() Тогда
				МенЗап.Документ = СтрокаТЗ.НовыйВладелец;
				МенЗап.Записать(Истина);
			КонецЕсли;
			
		КонецЦикла;
		
	Исключение
		
		Возврат Ложь;
		
	КонецПопытки;
	
	Возврат Истина;
	
КонецФункции

Функция ОриентировочныйРазмерОписиИсходящихДокументовПриОтправке(ОписьСсылка) Экспорт
	
	//Вычислим размер файлов скандокументов описи
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект
	|ИЗ
	|	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	|ГДЕ
	|	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	|	И ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект ССЫЛКА Справочник.СканированныеДокументыДляПередачиВЭлектронномВиде");
	
	Запрос.УстановитьПараметр("ОписьСсылка", ОписьСсылка);
	
	МасивСканДокументов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("СсылкаНаОбъект");
	
	РазмерСканДокументов = ПолучитьСтруктуруРазмеровСканДокументов(МасивСканДокументов).Размер;
	
	//Вычислим размер файлов описи
	//Сформируем список сжимаемых типов содержимого файлов
	СписокСжимаемыхТипов = Новый СписокЗначений;
	СписокСжимаемыхТипов.Добавить(Перечисления.ТипыСодержимогоФайлов.xml);
	СписокСжимаемыхТипов.Добавить(Перечисления.ТипыСодержимогоФайлов.Текст1251);
	СписокСжимаемыхТипов.Добавить(Перечисления.ТипыСодержимогоФайлов.Текст866);
	
	// Определим ориентировочный размер описи
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЕСТЬNULL(СУММА(ВЫБОР
	|				КОГДА ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.ТипСодержимого В (&СписокСжимаемыхТипов)
	|					ТОГДА ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Размер * &КоэффициентСжатия
	|				ИНАЧЕ ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Размер
	|			КОНЕЦ), 0) КАК РазмерФайловОписи
	|ИЗ
	|	РегистрСведений.ФайлыДокументовРеализацииПолномочийНалоговыхОрганов КАК ФайлыДокументовРеализацииПолномочийНалоговыхОрганов
	|ГДЕ
	|	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Документ  = &ОписьСсылка");
	
	Запрос.УстановитьПараметр("ОписьСсылка", ОписьСсылка);
	Запрос.УстановитьПараметр("СписокСжимаемыхТипов", СписокСжимаемыхТипов);
	Запрос.УстановитьПараметр("КоэффициентСжатия", 0.15);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	РазмерФайловОписи = 0;
	Если Выборка.Следующий() Тогда
		РазмерФайловОписи = Выборка.РазмерФайловОписи;
	КонецЕсли;
	
	Возврат РазмерФайловОписи + РазмерСканДокументов;
	
КонецФункции

Функция КоличествоФайловОписиИсходящихДокументовПриОтправке(ОписьСсылка) Экспорт
	
	// Общее количество файлов состоит из:
	// Документы Такском и Документы НДС – каждый состоит из двух файлов (файл выгрузки и файл подписи)
	// Сканированные документы – каждый состоит из произвольного количества файлов изображений
	// Файлы подписи на каждый из файлов из пунктов 1 и 2 (то есть количество передаваемых файлов увеличивается вдвое)
	// 1 файл описания всех документов из пунктов 1 и 2
	// 1 файл подписи для файла описания всех документов из пунктов 1 и 2
	// 1 файл описание сведений
	// 1 служебный файл packagedescription
	// 1 файл доверенности (потенциально возможен)
	// 1 файл подписи доверенности (потенциально возможен)

	// Определелим количество файлов всех скандокументов данной описи
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КОЛИЧЕСТВО(СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы.Ссылка) КАК КоличествоФайловСканДокументовОписи
	|ИЗ
	|	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы КАК СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы
	|		ПО ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект = СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы.ВладелецФайла
	|ГДЕ
	|	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	|	И ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект ССЫЛКА Справочник.СканированныеДокументыДляПередачиВЭлектронномВиде");
	
	Запрос.УстановитьПараметр("ОписьСсылка", ОписьСсылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	КоличествоФайловСканДокументовОписи = 0;
	
	Если Выборка.Следующий() Тогда
		КоличествоФайловСканДокументовОписи = Выборка.КоличествоФайловСканДокументовОписи;
	КонецЕсли;
	
	// Определим количество файлов выгрузки, прикрепленных к документам, входящим в состав описи (сюда войдут документы БЭД, документы НДС и документы, загруженные из пакета обмена)
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	КОЛИЧЕСТВО(ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаДанных) КАК КоличествоФайловВыгрузки
	|ИЗ
	|	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	|ГДЕ
	|	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	|	И ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаДанных > """"");

	Запрос.УстановитьПараметр("ОписьСсылка", ОписьСсылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	КоличествоФайловВыгрузки = 0;
	
	Если Выборка.Следующий() Тогда
		КоличествоФайловВыгрузки = Выборка.КоличествоФайловВыгрузки;
	КонецЕсли;
	
	КоличествоФайловВложений = (КоличествоФайловВыгрузки * 2) + КоличествоФайловСканДокументовОписи;
	
	Возврат (КоличествоФайловВложений * 2) + 6;
	
КонецФункции

Функция ПолучитьТаблицуДокументовОписиИРазмерыФайлов(ОписьСсылка) Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаДанных
	                      |ПОМЕСТИТЬ ТЗ_ИменФайловДанных
	                      |ИЗ
	                      |	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	                      |ГДЕ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	                      |	И ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаДанных <> &ПустаяСтрока
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ТЗ_ИменФайловДанных.ИмяФайлаДанных,
	                      |	ЕСТЬNULL(СУММА(4), 0) КАК КолвоФайлов,
	                      |	ЕСТЬNULL(СУММА(ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Размер), 0) КАК РазмерФайлов
	                      |ПОМЕСТИТЬ ТЗ_ФайлыОписи
	                      |ИЗ
	                      |	ТЗ_ИменФайловДанных КАК ТЗ_ИменФайловДанных
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ФайлыДокументовРеализацииПолномочийНалоговыхОрганов КАК ФайлыДокументовРеализацииПолномочийНалоговыхОрганов
	                      |		ПО ТЗ_ИменФайловДанных.ИмяФайлаДанных = ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.ИмяФайла
	                      |ГДЕ
	                      |	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Документ = &ОписьСсылка
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ТЗ_ИменФайловДанных.ИмяФайлаДанных
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект КАК СканСсылка
	                      |ПОМЕСТИТЬ ТЗ_Сканы
	                      |ИЗ
	                      |	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	                      |ГДЕ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	                      |	И ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект ССЫЛКА Справочник.СканированныеДокументыДляПередачиВЭлектронномВиде
	                      |	И ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект <> ЗНАЧЕНИЕ(Справочник.СканированныеДокументыДляПередачиВЭлектронномВиде.ПустаяСсылка)
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ТЗ_Сканы.СканСсылка,
	                      |	ЕСТЬNULL(СУММА(2), 0) КАК КолвоФайлов,
	                      |	ЕСТЬNULL(СУММА(ПрисоединенныеФайлыСканов.Размер), 0) КАК РазмерФайлов
	                      |ПОМЕСТИТЬ ТЗ_ФайлыСканов
	                      |ИЗ
	                      |	ТЗ_Сканы КАК ТЗ_Сканы
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы КАК ПрисоединенныеФайлыСканов
	                      |		ПО ТЗ_Сканы.СканСсылка = ПрисоединенныеФайлыСканов.ВладелецФайла
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	ТЗ_Сканы.СканСсылка
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаДанных КАК ИдентификаторДокумента,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ЯвляетсяИнформацией КАК ЯвляетсяИнформацией,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ПорядковыйНомер КАК ПорядковыйНомер,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ВидДокумента,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_Номер,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_Дата,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_Контрагент,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.НомерДокументаОснования,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ДатаДокументаОснования,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_КНД,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_Направление,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаДанных,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаПодписи,
	                      |	ЕСТЬNULL(ТЗ_ФайлыОписи.КолвоФайлов, 0) КАК КоличествоФайлов,
	                      |	ЕСТЬNULL(ТЗ_ФайлыОписи.РазмерФайлов, 0) КАК РазмерФайлов
	                      |ИЗ
	                      |	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТЗ_ФайлыОписи КАК ТЗ_ФайлыОписи
	                      |		ПО ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаДанных = ТЗ_ФайлыОписи.ИмяФайлаДанных
	                      |ГДЕ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	                      |
	                      |ОБЪЕДИНИТЬ ВСЕ
	                      |
	                      |ВЫБРАТЬ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ЯвляетсяИнформацией,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ПорядковыйНомер,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ВидДокумента,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_Номер,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_Дата,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_Контрагент,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.НомерДокументаОснования,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ДатаДокументаОснования,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_КНД,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен_Направление,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаДанных,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаПодписи,
	                      |	ЕСТЬNULL(ТЗ_ФайлыСканов.КолвоФайлов, 0),
	                      |	ЕСТЬNULL(ТЗ_ФайлыСканов.РазмерФайлов, 0)
	                      |ИЗ
	                      |	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТЗ_ФайлыСканов КАК ТЗ_ФайлыСканов
	                      |		ПО ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект = ТЗ_ФайлыСканов.СканСсылка
	                      |ГДЕ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	                      |
	                      |УПОРЯДОЧИТЬ ПО
						  //|	ЯвляетсяИнформацией,
						  //|	ПорядковыйНомер,
	                      |	РазмерФайлов");
	
	Запрос.УстановитьПараметр("ОписьСсылка", ОписьСсылка);
	Запрос.УстановитьПараметр("ПустаяСтрока", "");
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция КритичныеДокументыОписиИсходящихДокументовПриОтправке(ОписьСсылка) Экспорт
	
	// Сформируем массив скандокументов описи
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект
	|ИЗ
	|	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	|ГДЕ
	|	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	|	И ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект ССЫЛКА Справочник.СканированныеДокументыДляПередачиВЭлектронномВиде");
	
	Запрос.УстановитьПараметр("ОписьСсылка", ОписьСсылка);
	
	МасивСканДокументов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("СсылкаНаОбъект");
	
	// Сформируем список владельцев файлов
	СписокВладельцевФайлов = Новый СписокЗначений;
	СписокВладельцевФайлов.ЗагрузитьЗначения(МасивСканДокументов);
	// Добавим в список саму опись
	СписокВладельцевФайлов.Добавить(ОписьСсылка);
	
	//Сформируем список сжимаемых типов содержимого файлов
	СписокСжимаемыхТипов = Новый СписокЗначений;
	СписокСжимаемыхТипов.Добавить(Перечисления.ТипыСодержимогоФайлов.xml);
	СписокСжимаемыхТипов.Добавить(Перечисления.ТипыСодержимогоФайлов.Текст1251);
	СписокСжимаемыхТипов.Добавить(Перечисления.ТипыСодержимогоФайлов.Текст866);
	
	// Определим ориентировочный размер описи
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Документ,
	                      |	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.ИмяФайла,
	                      |	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.ТипСодержимого,
	                      |	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Размер,
	                      |	ВЫБОР
	                      |		КОГДА ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Размер > 256 * 1024 * 1024
	                      |			ТОГДА 2
	                      |		ИНАЧЕ 1
	                      |	КОНЕЦ КАК СтатусКритичности
	                      |ИЗ
	                      |	РегистрСведений.ФайлыДокументовРеализацииПолномочийНалоговыхОрганов КАК ФайлыДокументовРеализацииПолномочийНалоговыхОрганов
	                      |ГДЕ
	                      |	ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Документ В(&СписокВладельцевФайлов)
	                      |	И ВЫБОР
	                      |			КОГДА ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.ТипСодержимого В (&СписокСжимаемыхТипов)
	                      |				ТОГДА ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Размер * &КоэффициентСжатия
	                      |			ИНАЧЕ ФайлыДокументовРеализацииПолномочийНалоговыхОрганов.Размер
	                      |		КОНЕЦ > 15 * 1024 * 1024");
	
	Запрос.УстановитьПараметр("СписокВладельцевФайлов", СписокВладельцевФайлов);
	Запрос.УстановитьПараметр("СписокСжимаемыхТипов", СписокСжимаемыхТипов);
	Запрос.УстановитьПараметр("КоэффициентСжатия", 0.15);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ПолучитьОбщееСоответствиеФайловЭДиНДС(СоответствиеЭД, СоответствиеНДС)
	
	ОбщееСоответствие = Новый Соответствие;
	
	Если ТипЗнч(СоответствиеНДС) = Тип("Соответствие") Тогда
		Для каждого Соотв Из СоответствиеНДС Цикл
			СтруктураЗначение = Новый Структура("ИмяФайлаДанных, ИмяФайлаПодписи, АдресФайлаДанных, АдресФайлаПодписи", "", "", "", "");
			
			МассивФайлов = Соотв.Значение;
			Для каждого ДанныеФайла Из МассивФайлов Цикл
				Если ДанныеФайла.ТипФайла = "ФайлВыгрузки" Тогда
					СтруктураЗначение.ИмяФайлаДанных = ДанныеФайла.ИмяФайла;
					СтруктураЗначение.АдресФайлаДанных = ДанныеФайла.АдресВременногоХранилища;
				КонецЕсли;
			КонецЦикла;
			
			ОбщееСоответствие.Вставить(Соотв.Ключ, СтруктураЗначение);
			
		КонецЦикла;
	КонецЕсли;

	Если ТипЗнч(СоответствиеЭД) = Тип("Соответствие") Тогда
		Для каждого Соотв Из СоответствиеЭД Цикл
			СтруктураЗначение = Новый Структура("ИмяФайлаДанных, ИмяФайлаПодписи, АдресФайлаДанных, АдресФайлаПодписи", "", "", "", "");
			
			МассивФайлов = Соотв.Значение;
			
			Для каждого ДанныеФайла Из МассивФайлов Цикл
				Если ДанныеФайла.ТипФайла = "ФайлВыгрузки" Тогда
					СтруктураЗначение.ИмяФайлаДанных = ДанныеФайла.ИмяФайла;	
					СтруктураЗначение.АдресФайлаДанных = ДанныеФайла.АдресВременногоХранилища;
				ИначеЕсли ДанныеФайла.ТипФайла = "ЭЦП" Тогда
					СтруктураЗначение.АдресФайлаПодписи = ДанныеФайла.АдресВременногоХранилища;
				КонецЕсли;
			КонецЦикла;
			
			//относительно имени файла данных генерируем имя файла подписи
			СтруктураЗначение.ИмяФайлаПодписи = Сред(СтруктураЗначение.ИмяФайлаДанных, 1, СтрДлина(СтруктураЗначение.ИмяФайлаДанных) - 4) + "SGN.sgn";
			
			ОбщееСоответствие.Вставить(Соотв.Ключ, СтруктураЗначение);
			
		КонецЦикла
	КонецЕсли;

	Возврат ОбщееСоответствие;
	
КонецФункции

Функция ПолучитьСтруктуруРеквизитовОписиИсходящихДокументов(ОписьСсылка)
	
	СтруктураРеквизитовОписи = Новый Структура;
	СтруктураРеквизитовОписи.Вставить("Организация", ОписьСсылка);
	СтруктураРеквизитовОписи.Вставить("ОписьВходящихДокументов", );
	СтруктураРеквизитовОписи.Вставить("Требование", );
	СтруктураРеквизитовОписи.Вставить("НалоговыйОрган", );

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ОписиИсходящихДокументовВНалоговыеОрганы.Организация,
		|	ОписиИсходящихДокументовВНалоговыеОрганы.ОписьВходящихДокументов,
		|	ОписиИсходящихДокументовВНалоговыеОрганы.Требование,
		|	ОписиИсходящихДокументовВНалоговыеОрганы.НалоговыйОрган
		|ИЗ
		|	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы КАК ОписиИсходящихДокументовВНалоговыеОрганы
		|ГДЕ
		|	ОписиИсходящихДокументовВНалоговыеОрганы.Ссылка = &ОписьСсылка";

	Запрос.УстановитьПараметр("ОписьСсылка", ОписьСсылка);

	Выборка = Запрос.Выполнить().Выбрать();

	Выборка.Следующий();

	ЗаполнитьЗначенияСвойств(СтруктураРеквизитовОписи, Выборка);

	Возврат СтруктураРеквизитовОписи;

КонецФункции 

Функция РазбитьОписьИсходящихДокументовНаНесколько(ОписьСсылка, ТекстПредупреждения) Экспорт
	
	// Проверка ситуации:
	// Размер вложения превышает 256 Мб.
	// Разбиением на несколько описей ситуацию не исправить.
	ТЗКритичныеФайлы = КритичныеДокументыОписиИсходящихДокументовПриОтправке(ОписьСсылка);
	
	ЕстьНедопустимыеФайлы = Ложь;
	Для каждого КритичныйФайл Из ТЗКритичныеФайлы Цикл
		Если КритичныйФайл.СтатусКритичности = 2 Тогда
			ЕстьНедопустимыеФайлы = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;

	Если ЕстьНедопустимыеФайлы Тогда
		ТекстПредупреждения = "Размеры некоторых файлов превышают допустимые! Требуется устранить нарушение до разбиения описи на несколько!";
		Возврат Неопределено;
	КонецЕсли;
	
	// Проверка ситуации:
	// Нет ли сканированных документов с более чем 29 вложений? 
	// Если есть – разбиением на несколько описей ситуацию не исправить
	ТЗКритичныеСканДокументы = ПолучитьСканированныеДокументыСКритичнымКоличествомФайлов(ОписьСсылка);
	Если ТЗКритичныеСканДокументы.Количество() > 0 Тогда
		ТекстПредупреждения = "В составе некоторых отправляемых документов количество файлов превышает допустимое значение! Требуется устранить нарушение до разбиения описи на несколько!";
		Возврат Неопределено;
	КонецЕсли;
	
	//ситации, при которых нельзя разбить проверили, начинаем разбивать
	ТЗДокументыФайлыРазмер = ПолучитьТаблицуДокументовОписиИРазмерыФайлов(ОписьСсылка);
	
	ДеревоСоздаваемыхОписей = Новый ДеревоЗначений;
	ДеревоСоздаваемыхОписей.Колонки.Добавить("ЯвляетсяИнформацией");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("ПорядковыйНомер");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("ВидДокумента");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("СсылкаНаОбъект");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("Загружен");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("Загружен_Номер");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("Загружен_Дата");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("Загружен_Контрагент");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("НомерДокументаОснования");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("ДатаДокументаОснования");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("Загружен_КНД");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("Загружен_Направление");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("ИмяФайлаДанных");
	ДеревоСоздаваемыхОписей.Колонки.Добавить("ИмяФайлаПодписи");
	
	СуммаКолвоФайлов = 6;
	СуммаРазмерФайлов = 0;
	МаксКолвоФайлов = 64;
	МаксРазмерФайлов = 18*1024*1024;
	
	НоваяСтрокаОпись = ДеревоСоздаваемыхОписей.Строки.Добавить();
	
	Для каждого СтрокаДокумент Из ТЗДокументыФайлыРазмер Цикл
		
		СуммаКолвоФайлов = СуммаКолвоФайлов + СтрокаДокумент.КоличествоФайлов;
		СуммаРазмерФайлов = СуммаРазмерФайлов + СтрокаДокумент.РазмерФайлов;

		Если (СуммаКолвоФайлов > МаксКолвоФайлов ИЛИ СуммаРазмерФайлов > МаксРазмерФайлов) И НоваяСтрокаОпись.Строки.Количество() > 0 Тогда
			//начинаем новую опись
			ДобавленаНоваяОпись = Истина;
			НоваяСтрокаОпись = ДеревоСоздаваемыхОписей.Строки.Добавить();
			
			СуммаКолвоФайлов = СтрокаДокумент.КоличествоФайлов;
			СуммаРазмерФайлов = СтрокаДокумент.РазмерФайлов;

		КонецЕсли;
		
		НоваяСтрокаДокумент = НоваяСтрокаОпись.Строки.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрокаДокумент, СтрокаДокумент); 
	
	КонецЦикла;
	
	СтрокиОписей = ДеревоСоздаваемыхОписей.Строки;
	
	Если СтрокиОписей.Количество() = 1 Тогда
		//все файлы уместились в текущей описи, разбития не происходило
		ТекстПредупреждения = "Разбития описи не требуется.";
		Возврат Неопределено;
	КонецЕсли;
	
	СтруктураРеквизитовОписи = ПолучитьСтруктуруРеквизитовОписиИсходящихДокументов(ОписьСсылка);
	
	ТаблицаФайловИзменяющихВладельца = Новый ТаблицаЗначений;
	ТаблицаФайловИзменяющихВладельца.Колонки.Добавить("ИмяФайла");
	ТаблицаФайловИзменяющихВладельца.Колонки.Добавить("НовыйВладелец");
	
	МассивСозданныхОписей = Новый Массив;
	// спроектировано наполнение описей, начинаем работать с метаданными
	НачатьТранзакцию();
	
	Попытка
		
		НачальнаяОписьЗаполнена = Ложь;
		
		РедактируемаяОписьСсылка = ОписьСсылка;
		РедактируемаяОписьОбъект = ОписьСсылка.ПолучитьОбъект();
		
		РедактируемаяОписьОбъект.ПредставляемыеДокументы.Очистить();
		
		Для каждого СтрокаОпись Из СтрокиОписей Цикл
			
			Если НачальнаяОписьЗаполнена Тогда
				//создаем новую опись
				РедактируемаяОписьОбъект = Справочники.ОписиИсходящихДокументовВНалоговыеОрганы.СоздатьЭлемент();
				ЗаполнитьЗначенияСвойств(РедактируемаяОписьОбъект, СтруктураРеквизитовОписи);
				РедактируемаяОписьОбъект.ДатаСоздания = ТекущаяДатаСеанса();
				РедактируемаяОписьОбъект.Записать();
				РедактируемаяОписьСсылка = РедактируемаяОписьОбъект.Ссылка;
				
				МассивСозданныхОписей.Добавить(РедактируемаяОписьСсылка);
			КонецЕсли;
			
			//заполняем табличную часть
			Для каждого СтрокаДокумент Из СтрокаОпись.Строки Цикл
				
				НоваяСтрокаДокумент = РедактируемаяОписьОбъект.ПредставляемыеДокументы.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрокаДокумент, СтрокаДокумент);
				
				Если НачальнаяОписьЗаполнена И ЗначениеЗаполнено(СтрокаДокумент.ИмяФайлаДанных) Тогда
					//надо изменить владельца файла данных
					НоваяСтрокаФайл = ТаблицаФайловИзменяющихВладельца.Добавить();
					НоваяСтрокаФайл.ИмяФайла = СтрокаДокумент.ИмяФайлаДанных;
					НоваяСтрокаФайл.НовыйВладелец = РедактируемаяОписьСсылка;
					
					Если ЗначениеЗаполнено(СтрокаДокумент.ИмяФайлаПодписи) Тогда
						//надо изменить владельца файла подписи
						НоваяСтрокаФайл = ТаблицаФайловИзменяющихВладельца.Добавить();
						НоваяСтрокаФайл.ИмяФайла = СтрокаДокумент.ИмяФайлаПодписи;
						НоваяСтрокаФайл.НовыйВладелец = РедактируемаяОписьСсылка;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЦикла;
			
			РедактируемаяОписьОбъект.Записать();
			НачальнаяОписьЗаполнена = Истина;
			
		КонецЦикла;
		
		//изменяем владельца у "переброшенных" файлов
		Если НЕ ИзменитьВладельцаФайловДокументовРеализацииПолномочийНалоговыхОрганов(ОписьСсылка, ТаблицаФайловИзменяющихВладельца) Тогда
			ОтменитьТранзакцию();
			Возврат Неопределено;
		КонецЕсли;
		
	Исключение
		
		ОтменитьТранзакцию();
		Возврат Неопределено;

	КонецПопытки; 
	
	ЗафиксироватьТранзакцию();
	
	Возврат МассивСозданныхОписей;
	
КонецФункции

Функция ОбновитьФайлыДокументовИБОписиИсходящихДокументов(ОписьСсылка) Экспорт
	
	СписокВидовДокументовЭД = Новый СписокЗначений;
	СписокВидовДокументовЭД.Добавить(Перечисления.ВидыПредставляемыхДокументов.СчетФактура);
	СписокВидовДокументовЭД.Добавить(Перечисления.ВидыПредставляемыхДокументов.КорректировочныйСчетФактура);
	СписокВидовДокументовЭД.Добавить(Перечисления.ВидыПредставляемыхДокументов.АктПриемкиСдачиРабот);
	СписокВидовДокументовЭД.Добавить(Перечисления.ВидыПредставляемыхДокументов.ТоварнаяНакладнаяТОРГ12);
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект,
	                      |	ВЫБОР
	                      |		КОГДА ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ВидДокумента В (&СписокВидовДокументовЭД)
	                      |			ТОГДА ""ЭД""
	                      |		ИНАЧЕ ""НДС""
	                      |	КОНЕЦ КАК КатегорияВидаДокумента,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаДанных,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ИмяФайлаПодписи,
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.ВерсияФайлаДанных
	                      |ИЗ
	                      |	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	                      |ГДЕ
	                      |	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	                      |	И НЕ ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект ССЫЛКА Справочник.СканированныеДокументыДляПередачиВЭлектронномВиде
	                      |	И ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Загружен = ЛОЖЬ");
	
	Запрос.УстановитьПараметр("ОписьСсылка", ОписьСсылка);
	Запрос.УстановитьПараметр("СписокВидовДокументовЭД", СписокВидовДокументовЭД);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ТаблицаДобавляемыхФайлов = Новый ТаблицаЗначений;
	ТаблицаДобавляемыхФайлов.Колонки.Добавить("ИмяФайла");
	ТаблицаДобавляемыхФайлов.Колонки.Добавить("АдресФайла");
	
	МассивУдаляемыхФайлов = Новый Массив;
	
	МассивЭД = Новый Массив;
	МассивНДС = Новый Массив;
	
	СоответствиеВерсияДанныхПоСсылке = Новый Соответствие;
		
	//проходим выборку для заполнения МассивУдаляемыхФайлов, МассивЭД, МассивНДС
	Пока Выборка.Следующий() Цикл
		
		ВерсияДанныхПоСсылке = Выборка.СсылкаНаОбъект.ВерсияДанных;
						  
		Если Выборка.ВерсияФайлаДанных = ВерсияДанныхПоСсылке Тогда
			Продолжить;
		Иначе
			СоответствиеВерсияДанныхПоСсылке.Вставить(Выборка.СсылкаНаОбъект, ВерсияДанныхПоСсылке);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Выборка.ИмяФайлаДанных) Тогда
			МассивУдаляемыхФайлов.Добавить(Выборка.ИмяФайлаДанных);
		КонецЕсли;	
		Если ЗначениеЗаполнено(Выборка.ИмяФайлаПодписи) Тогда
			МассивУдаляемыхФайлов.Добавить(Выборка.ИмяФайлаПодписи);
		КонецЕсли;	
		
		Если Выборка.КатегорияВидаДокумента = "ЭД" Тогда
			МассивЭД.Добавить(Выборка.СсылкаНаОбъект);
		Иначе
			МассивНДС.Добавить(Выборка.СсылкаНаОбъект);
		КонецЕсли;
	КонецЦикла;
	
	Если СоответствиеВерсияДанныхПоСсылке.Количество() = 0 Тогда
		//обновлять файлы не требуется, в описи нет документов ЭД и НДС либо версия данных у них не менялась
		Возврат Истина;
	КонецЕсли;
	
	СоответствиеНДС = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ПолучитьФайлыВыгрузкиНДС(МассивНДС, Новый УникальныйИдентификатор);
	СоответствиеЭД 	= ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ПолучитьФайлыВыгрузкиЭД(МассивЭД, Новый УникальныйИдентификатор);
	
	ОбщееСоответствиеФайлов = ПолучитьОбщееСоответствиеФайловЭДиНДС(СоответствиеЭД, СоответствиеНДС);
	
	// Заполняем ТаблицаДобавляемыхФайлов
	Для каждого Соотв Из ОбщееСоответствиеФайлов Цикл
		
		СтруктураРеквизитов = Соотв.Значение;
		Если ЗначениеЗаполнено(СтруктураРеквизитов.ИмяФайлаДанных) Тогда
			НоваяСтрока = ТаблицаДобавляемыхФайлов.Добавить();
			НоваяСтрока.ИмяФайла = СтруктураРеквизитов.ИмяФайлаДанных;
			НоваяСтрока.АдресФайла = СтруктураРеквизитов.АдресФайлаДанных;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СтруктураРеквизитов.ИмяФайлаПодписи) Тогда
			НоваяСтрока = ТаблицаДобавляемыхФайлов.Добавить();
			НоваяСтрока.ИмяФайла = СтруктураРеквизитов.ИмяФайлаПодписи;
			НоваяСтрока.АдресФайла = СтруктураРеквизитов.АдресФайлаПодписи;
		КонецЕсли;
			
	КонецЦикла;
	
	НачатьТранзакцию();
	
	Попытка
		//удаляем старые файлы
		УдалитьФайлыДокументовРеализацииПолномочийНалоговыхОргановПоВладельцу(ОписьСсылка, МассивУдаляемыхФайлов);
		
		//записываем новые файлы
		Если НЕ ПоместитьФайлыДокументовРеализацииПолномочийНалоговыхОрганов(ОписьСсылка, ТаблицаДобавляемыхФайлов) Тогда
			ОтменитьТранзакцию();
			Возврат Ложь;
		КонецЕсли;
		
		//обновляем сведения в табличной части
		ТипСкан = Тип("СправочникСсылка.СканированныеДокументыДляПередачиВЭлектронномВиде");
		
		ОписьОбъект = ОписьСсылка.ПолучитьОбъект();
		Для каждого СтрокаТЧ Из ОписьОбъект.ПредставляемыеДокументы Цикл
			ДокументСсылка = СтрокаТЧ.СсылкаНаОбъект;
			Если НЕ СтрокаТЧ.Загружен И ТипЗнч(ДокументСсылка) <> ТипСкан Тогда
				
				РекизитыСтроки = ОбщееСоответствиеФайлов[ДокументСсылка];
				Если РекизитыСтроки <> Неопределено Тогда
					СтрокаТЧ.ИмяФайлаДанных = РекизитыСтроки.ИмяФайлаДанных;
					СтрокаТЧ.ИмяФайлаПодписи = РекизитыСтроки.ИмяФайлаПодписи;
				КонецЕсли;
				
				СтрокаТЧ.ВерсияФайлаДанных = СоответствиеВерсияДанныхПоСсылке[ДокументСсылка];
				
			КонецЕсли;
		КонецЦикла;
		
		ОписьОбъект.Записать();
	
	Исключение
		
	    ОтменитьТранзакцию();
		Возврат Ложь;
		
	КонецПопытки;
	
	ЗафиксироватьТранзакцию();
	
	Возврат Истина;
	
КонецФункции

Функция ПолучитьСканированныеДокументыСКритичнымКоличествомФайлов(ОписьСсылка) Экспорт
	
	// Сформируем массив скандокументов описи
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект
	|ИЗ
	|	Справочник.ОписиИсходящихДокументовВНалоговыеОрганы.ПредставляемыеДокументы КАК ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы
	|ГДЕ
	|	ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.Ссылка = &ОписьСсылка
	|	И ОписиИсходящихДокументовВНалоговыеОрганыПредставляемыеДокументы.СсылкаНаОбъект ССЫЛКА Справочник.СканированныеДокументыДляПередачиВЭлектронномВиде");
	
	Запрос.УстановитьПараметр("ОписьСсылка", ОписьСсылка);
	
	МасивСканДокументов = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("СсылкаНаОбъект");
	
	// Сформируем список владельцев файлов
	СписокВладельцевФайлов = Новый СписокЗначений;
	СписокВладельцевФайлов.ЗагрузитьЗначения(МасивСканДокументов);
		
	//Сформируем список сжимаемых типов содержимого файлов
	СписокСжимаемыхТипов = Новый СписокЗначений;
	СписокСжимаемыхТипов.Добавить(Перечисления.ТипыСодержимогоФайлов.xml);
	СписокСжимаемыхТипов.Добавить(Перечисления.ТипыСодержимогоФайлов.Текст1251);
	СписокСжимаемыхТипов.Добавить(Перечисления.ТипыСодержимогоФайлов.Текст866);
	
	// Определим ориентировочный размер описи
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы.ВладелецФайла КАК Документ,
	                      |	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы.Ссылка) КАК КоличествоФайлов
	                      |ПОМЕСТИТЬ КоличествоФайловСканированныхДокументов
	                      |ИЗ
	                      |	Справочник.СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы КАК СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы
	                      |ГДЕ
	                      |	СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы.ВладелецФайла В(&СписокВладельцевФайлов)
	                      |
	                      |СГРУППИРОВАТЬ ПО
	                      |	СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы.ВладелецФайла
	                      |;
	                      |
	                      |////////////////////////////////////////////////////////////////////////////////
	                      |ВЫБРАТЬ
	                      |	КоличествоФайловСканированныхДокументов.Документ,
	                      |	КоличествоФайловСканированныхДокументов.КоличествоФайлов
	                      |ИЗ
	                      |	КоличествоФайловСканированныхДокументов КАК КоличествоФайловСканированныхДокументов
	                      |ГДЕ
	                      |	КоличествоФайловСканированныхДокументов.КоличествоФайлов > &КритическоеКоличествоФайлов");
	
	Запрос.УстановитьПараметр("СписокВладельцевФайлов", СписокВладельцевФайлов);
	Запрос.УстановитьПараметр("КритическоеКоличествоФайлов", 29);
	
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Получение требований и представление документов в налоговые органы
///////////////////////////////////////////////////////////////////////////////

// есть в Контейнере
Функция ОтветНаЗапросИОСЯвляетсяОтрицательным(Объект)
	
	// получаем протокол из базы
	ОбъектСсылка = Объект.Ссылка;
	СтрПротоколы = ПолучитьВложенияТранспортногоСообщения(ОбъектСсылка, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ОтветНаЗапросПФР);
	Если СтрПротоколы.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// выгружаем данные протокола во временный файл
	СтрПротокол = СтрПротоколы[0];
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	Попытка
		СтрПротокол.Данные.Получить().Записать(ИмяВременногоФайла);
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось выгрузить ответ на запрос во временный файл для анализа'") + ":
				|" + ИнформацияОбОшибке().Описание);
		Возврат Неопределено;
	КонецПопытки;
	
	// загружаем XML из файла в память
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ИмяВременногоФайла);
	УдалитьВременныйФайл(ИмяВременногоФайла);
	Если ДеревоXML = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// ищем атрибут, содержащий статус проверки протокола
	РезультатыПоиска = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "запросОбработанУспешно", "Э"), Истина);
	Если РезультатыПоиска.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// преобразовываем значение атрибута к Булево и возвращаем
	ЗначениеАтрибутаСтр = РезультатыПоиска[0].Значение;
	ЗначениеАтрибута = БулевоПоСтроке(ЗначениеАтрибутаСтр);
	Если ЗначениеАтрибута <> Неопределено Тогда
		Возврат НЕ ЗначениеАтрибута;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Процедура ПередЗаписьюЗапросаНаИнформационноеОбслуживаниеСтрахователя(Объект, Отказ, РежимЗаписи, РежимПроведения)
	
	Если Объект.ВидУслуги = Перечисления.ВидыУслугПриИОС.СправкаОСостоянииРасчетов Тогда
		Объект.ЗастрахованныеЛица.Очистить();
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьОтветыНаЗапросИОС(парамЗапрос, СДанными = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = Запрос.Текст + "ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	ОтветыНаЗапросыИОС.ИмяФайла,
						  |	ОтветыНаЗапросыИОС.Размер,
						  |	ОтветыНаЗапросыИОС.ОтветОтрицательный,
						  |	ОтветыНаЗапросыИОС.ТипСодержимогоФайла";
	Если СДанными Тогда
		Запрос.Текст = Запрос.Текст + ",
						  |	ОтветыНаЗапросыИОС.Данные";
	КонецЕсли;
	Запрос.Текст = Запрос.Текст + "
						  |ИЗ
						  |	РегистрСведений.ОтветыНаЗапросыИОС КАК ОтветыНаЗапросыИОС
						  |ГДЕ
						  |	ОтветыНаЗапросыИОС.Запрос = &Запрос";
	Запрос.УстановитьПараметр("Запрос", парамЗапрос);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
// Заявление абонента спецоператора связи

////////////////////////////////////////////////////////////////////////////////
// ЗАПРОС НА ВЫПИСКУ ИЗ ЕДИНОГО ГОСУДАРСТВЕННОГО РЕЕСТРА
//
Функция ПолучитьОтветыНаЗапросыВыпискиИзЕГРЮЛ_ЕГРИП(парамЗапрос, СДанными = Ложь) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = Запрос.Текст + "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	                      |	ОтветыНаЗапросыЕГР.ИмяФайла,
	                      |	ОтветыНаЗапросыЕГР.Размер,
	                      |	ОтветыНаЗапросыЕГР.РезультатОбработкиЗапроса";
	Если СДанными Тогда
		Запрос.Текст = Запрос.Текст + ",
	                      |	ОтветыНаЗапросыЕГР.Данные";
	КонецЕсли;
	Запрос.Текст = Запрос.Текст + "
	                      |ИЗ
	                      |	РегистрСведений.ОтветыНаЗапросыВыпискиИзЕГРЮЛ_ЕГРИП КАК ОтветыНаЗапросыЕГР
	                      |ГДЕ
	                      |	ОтветыНаЗапросыЕГР.Запрос = &Запрос";
	Запрос.УстановитьПараметр("Запрос", парамЗапрос);
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ДатаИзСтроки(СтрДата) Экспорт
	Если СтрДата = "" Тогда
		ВозвращаемаяДата = Дата(1, 1, 1);
	Иначе
		МассивПодстрок = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(СтрДата, ".");
		Если Число(МассивПодстрок[0]) = 0 Тогда
			МассивПодстрок[0] = "1";
		КонецЕсли;
		Если Число(МассивПодстрок[1]) = 0 Тогда
			МассивПодстрок[1] = "1";
		КонецЕсли;
		Если Число(МассивПодстрок[2]) = 0 Тогда
			МассивПодстрок[2] = "1";
		КонецЕсли;
		ВозвращаемаяДата = Дата(МассивПодстрок[2], МассивПодстрок[1], МассивПодстрок[0]);
	КонецЕсли;
	
	Возврат ВозвращаемаяДата;
	
КонецФункции

Функция РазбитьБольшойФайлУведомленияНаНесколькоМаленьких(ОписаниеФайлаВыгрузки, УникальныйИдентификаторВызывающейФормы) Экспорт
	
	// фрагмент кода для управляемого приложения
	ИмяФайлаВыгрузки = ПолучитьКаталогВременныхФайлов() + ОписаниеФайлаВыгрузки.Имя;
	ПолучитьИзВременногоХранилища(ОписаниеФайлаВыгрузки.АдресДанных).Записать(ИмяФайлаВыгрузки);
	
	// делаем запас на погрешность расчетов в 1 Мб
	МаксимальныйРазмерФайлаУведомленияОКонтролируемыхСделках = МаксимальныйРазмерФайлаУведомленияОКонтролируемыхСделках() - 1024 * 1024 * 1;
	
	ТекстШапкиФайла 		= "";
	ТекстПодвалаФайла 		= "";
	ОткрывающийТэг			= "<УвКонтрСд>";
	ЗакрывающийТэг			= "</УвКонтрСд>";
	ЗакрывающийТэгСвКонтрСд = "</СвКонтрСд>";
	
	МассивФайлов = Новый Массив;
	
	// построчно считываем файл, если читать сразу весь текст, то возникает ошибка переполнения памяти
	ОбъектЧтениеТекста 		= Новый ЧтениеТекста(ИмяФайлаВыгрузки, "windows-1251");
	ФайлВыгрузки 			= Новый Файл(ИмяФайлаВыгрузки);
	РазмерИсходногоФайла 	= ФайлВыгрузки.Размер();
	ФайлВыгрузки 			= Неопределено;
	
	// считываем строку до тэга <УвКонтрСд>
	ТекстШапкиФайла 	= ОбъектЧтениеТекста.ПрочитатьСтроку(ОткрывающийТэг) + ОткрывающийТэг;
	ТекстПодвалаФайла 	= 	"		</УвКонтрСд>
							|	</Документ>
							|</Файл>";
	МаксимальныйРазмерФайлаУведомленияОКонтролируемыхСделкахБезРазмераПодвала = МаксимальныйРазмерФайлаУведомленияОКонтролируемыхСделках - РазмерВБайтах(ТекстПодвалаФайла);

	НовыйТекстШапкиФайла = "";
	РазмерСформированнойШапки = 0;
	ВремФайл 	= "";
	ИдФайлПерв 	= "";
	НомФайл 	= 1;
	КолФайл 	= (РазмерИсходногоФайла - РазмерВБайтах(ТекстШапкиФайла) + РазмерВБайтах(ТекстПодвалаФайла)) / (МаксимальныйРазмерФайлаУведомленияОКонтролируемыхСделках - РазмерВБайтах(ТекстШапкиФайла) - РазмерВБайтах(ТекстПодвалаФайла));
	Если КолФайл <> Цел(КолФайл) Тогда
		КолФайл = Цел(КолФайл) + 1;
	КонецЕсли;
	
	НовыйЗапись = НоваяЗаписьФайлаКомплекта(ИмяФайлаВыгрузки, ИдФайлПерв, ТекстШапкиФайла, ВремФайл, КолФайл, НомФайл, РазмерСформированнойШапки, НовыйТекстШапкиФайла);
	РазмерТекстаСодержимогоФайла = РазмерСформированнойШапки;
	РазмерЗакрывающегоТэгаСвКонтрСд = РазмерВБайтах(ЗакрывающийТэгСвКонтрСд);
	
	ЗакрывающийТэгСвКонтрСдСОтступом = "   " + ЗакрывающийТэгСвКонтрСд;
	
	// читаем текст до тэга </СвКонтрСд>
	ТекущаяСтрока = ОбъектЧтениеТекста.ПрочитатьСтроку(ЗакрывающийТэгСвКонтрСд);
	ЗакрывающийТэгСвКонтрСдСОтступом = "   " + ЗакрывающийТэгСвКонтрСд;
	
	Пока ТекущаяСтрока <> Неопределено Цикл
		
		РазмерТекущейСтроки = РазмерВБайтах(ТекущаяСтрока);
		РазмерТекстаСодержимогоФайла = РазмерТекстаСодержимогоФайла + РазмерТекущейСтроки + РазмерЗакрывающегоТэгаСвКонтрСд;
		
		Если РазмерТекстаСодержимогоФайла > МаксимальныйРазмерФайлаУведомленияОКонтролируемыхСделках Тогда
			// закрываем файл
			ПозицияЗакрывающегоТэгаУвКонтрСд = Найти(ТекущаяСтрока, ЗакрывающийТэг);
			Если ПозицияЗакрывающегоТэгаУвКонтрСд = 0 Тогда
				НовыйЗапись.Записать(Символы.ПС + ТекстПодвалаФайла);
			КонецЕсли; 
				
			НовыйЗапись.Закрыть();
			НовыйЗапись = Неопределено;
			МассивФайлов.Добавить(ВремФайл);
			
			// если найден закрывающий тэг, то нового файла не создаем, цикл прерываем
			Если НЕ ПозицияЗакрывающегоТэгаУвКонтрСд = 0 Тогда
				Прервать;
			КонецЕсли;
			// открываем новый файл
			НомФайл = НомФайл + 1;
			НовыйЗапись = НоваяЗаписьФайлаКомплекта(ИмяФайлаВыгрузки, ИдФайлПерв, ТекстШапкиФайла, ВремФайл, КолФайл, НомФайл, РазмерСформированнойШапки, НовыйТекстШапкиФайла);
			РазмерТекстаСодержимогоФайла = РазмерСформированнойШапки + РазмерТекущейСтроки;
		КонецЕсли;
		
        ПредыдущееЗначениеТекущейСтроки = ТекущаяСтрока;
		ТекущаяСтрока = ОбъектЧтениеТекста.ПрочитатьСтроку(ЗакрывающийТэгСвКонтрСд);
		
		Если ТекущаяСтрока = Неопределено Тогда
			НовыйЗапись.Записать(ПредыдущееЗначениеТекущейСтроки);
		Иначе 
			НовыйЗапись.Записать(ПредыдущееЗначениеТекущейСтроки + ЗакрывающийТэгСвКонтрСдСОтступом);
		КонецЕсли;
	КонецЦикла;
	
	ОбъектЧтениеТекста.Закрыть();

	// если мы еще не закрыли этот файл
	Если МассивФайлов.Найти(ВремФайл) = Неопределено Тогда
		// подвал не добавляем в файл, поскольку сюда записался конец общего файла
		НовыйЗапись.Закрыть();
		НовыйЗапись = Неопределено;
		МассивФайлов.Добавить(ВремФайл);
	КонецЕсли;
	
	ОбъектЧтениеТекста = Неопределено;
	
	// фрагмент кода для управляемого приложения
	МассивОписанийФайлов = Новый Массив;
	Для каждого ФайлМассива Из МассивФайлов Цикл
		Файл = Новый Файл(ФайлМассива);
		АдресВоВременномХранилище = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(ФайлМассива), УникальныйИдентификаторВызывающейФормы);
		МассивОписанийФайлов.Добавить(Новый Структура("Имя, ПолноеИмя, Расширение, АдресДанных", Файл.Имя, Файл.ПолноеИмя, Файл.Расширение, АдресВоВременномХранилище));
	КонецЦикла; 
	
	Возврат МассивОписанийФайлов;
	
КонецФункции

Функция ПолучитьКаталогВременныхФайлов() Экспорт
	
	ВременныйКаталог = КаталогВременныхФайлов();
	РазделительПутиОС = ПолучитьРазделительПути();
	Возврат ?(Прав(ВременныйКаталог, 1) = РазделительПутиОС, ВременныйКаталог, ВременныйКаталог + РазделительПутиОС);
	
КонецФункции

Функция НоваяЗаписьФайлаКомплекта(ИмяФайлаВыгрузки, ИдФайлПерв, Знач ТекстШапкиФайла, ВремФайл, КолФайл, НомФайл, РазмерСформированнойШапки, НовыйТекстШапкиФайла)
	
	КороткоеИмяФайлаБезГУИДНаКонце = КороткоеИмяФайлаБезГУИДНаКонце(ИмяФайлаВыгрузки);
	
	ИдентификационныйНомерФайла = Новый УникальныйИдентификатор;
	ВремФайл = ПолучитьКаталогВременныхФайлов() + КороткоеИмяФайлаБезГУИДНаКонце + ИдентификационныйНомерФайла + ".xml";
	НовыйЗапись = Новый ЗаписьТекста(ВремФайл, "windows-1251");

	Если НЕ ЗначениеЗаполнено(ИдФайлПерв) Тогда
		ИдФайлПерв = КороткоеИмяФайлаБезГУИДНаКонце + ИдентификационныйНомерФайла;
	КонецЕсли;
	
	ФайлВыгрузки = Новый Файл(ИмяФайлаВыгрузки);
	ИдФайлИсх = ФайлВыгрузки.ИмяБезРасширения;
	ФайлВыгрузки = Неопределено;
	
	ДополнениеФайлаВерсии502 = "ВерсФорм=""%1"" ИдФайлИсх=""%2"" ИдФайлПерв=""%3"" КолФайл=""%4"" НомФайл=""%5""";
	ДополнениеФайлаВерсии502 = СтрЗаменить(ДополнениеФайлаВерсии502, "%1", "5.02");
	ДополнениеФайлаВерсии502 = СтрЗаменить(ДополнениеФайлаВерсии502, "%2", ИдФайлИсх);
	ДополнениеФайлаВерсии502 = СтрЗаменить(ДополнениеФайлаВерсии502, "%3", ИдФайлПерв);
	ДополнениеФайлаВерсии502 = СтрЗаменить(ДополнениеФайлаВерсии502, "%4", КолФайл);
	ДополнениеФайлаВерсии502 = СтрЗаменить(ДополнениеФайлаВерсии502, "%5", НомФайл);
	
	ОбъектФайл = Новый Файл(ИмяФайлаВыгрузки);
	ИмяБезРасширения = ОбъектФайл.ИмяБезРасширения;

	ТекстШапкиФайла = СтрЗаменить(ТекстШапкиФайла, "ВерсФорм=""5.01""", ДополнениеФайлаВерсии502);
	ТекстШапкиФайла = СтрЗаменить(ТекстШапкиФайла, "ИдФайл=" + """" + ИмяБезРасширения + """", "ИдФайл=" + """" + КороткоеИмяФайлаБезГУИДНаКонце + ИдентификационныйНомерФайла + """");
	
	НовыйТекстШапкиФайла = ТекстШапкиФайла;
	РазмерСформированнойШапки = РазмерВБайтах(НовыйТекстШапкиФайла);
	НовыйЗапись.Записать(СокрЛП(ТекстШапкиФайла));
	
	Возврат НовыйЗапись;

КонецФункции

Функция КороткоеИмяФайлаБезГУИДНаКонце(ИмяФайлаВыгрузки)
	ФайлНаДиске = Новый Файл(ИмяФайлаВыгрузки);
	КороткоеИмяФайла = ФайлНаДиске.ИмяБезРасширения;
	
	КороткоеИмяФайлаБезГУИДНаКонце = "";
	Строки = СтрЗаменить(КороткоеИмяФайла,"_",Символы.ПС);
	Для НомерСтроки = 1 По 6 Цикл
		КороткоеИмяФайлаБезГУИДНаКонце = КороткоеИмяФайлаБезГУИДНаКонце + СтрПолучитьСтроку(Строки,НомерСтроки) + "_";
	КонецЦикла;
	
	Возврат КороткоеИмяФайлаБезГУИДНаКонце;
	
КонецФункции

Функция РазмерВБайтах(Знач ПроверяемыйТекст)
	
	// каждый символ строки кодируется 1 байтом, каждый символ переноса строки кодируется 2 байтами
	КоличествоВхожденийПС 	= СтрЧислоВхождений(ПроверяемыйТекст, Символы.ПС); 
	ПолнаяДлинаСтроки 		= СтрДлина(ПроверяемыйТекст);
	ДлинаСтрокиБезСимволаПС = ПолнаяДлинаСтроки - КоличествоВхожденийПС;
	Результат = ДлинаСтрокиБезСимволаПС + КоличествоВхожденийПС * 2;
	
	Возврат Результат;
	
КонецФункции


Функция ЭтоФайлВыгрузкиУведомленияОКонтролируемыхСделках(КороткоеИмяФайла) Экспорт
	
	Возврат ВРег(Лев(КороткоеИмяФайла, 10)) = "UT_UVKNRSD";
	
КонецФункции

Функция ЭтоФайлВыгрузкиУведомленияОРозничныхЦенахНаТабак(КороткоеИмяФайла) Экспорт
	
	Возврат ВРег(Лев(КороткоеИмяФайла, 11)) = "ON_UVCENTAB";
	
КонецФункции

Функция ЭтоФайлВыгрузкиДекларацияНДС(КороткоеИмяФайла) Экспорт
	
	Возврат ВРег(Лев(КороткоеИмяФайла, 7)) = "NO_NDS_";	
	
КонецФункции

Функция МаксимальныйРазмерФайлаУведомленияОКонтролируемыхСделках() Экспорт
	Возврат 1024 * 1024 * 100;
КонецФункции


//////////////////////////////////////////////////////////////////////////////////
//// ДОКУМЕНТООБОРОТ С ФСС
////

Функция ВыгрузитьПакетДляОтправкиВФССЭлектроннаяПодписьВМоделиСервиса(ПараметрыФункции) Экспорт
	
	ТекстФайлаВыгрузки = ПараметрыФункции.ТекстФайлаВыгрузки;
	ИдентификаторДокументооборота = ПараметрыФункции.Идентификатор;
	
	СертификатыПолучателей = Новый Массив;
	СертификатыПолучателей.Добавить(ПараметрыФункции.СертификатФСС);
	
	Файл = Новый Файл(ПолучитьИмяВременногоФайла());
	ИмяФайлаВыгрузки = Файл.Имя;
	
	// инициализируем объект для работы с двоичными данными и получим временный каталог
	ДвДанные = Неопределено;
	ВременныйКаталог = КаталогВременныхФайловДвоичныхДанных(ДвДанные);
	Если ДвДанные = Неопределено Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Ошибка при инициализации объекта для работы с двоичными данными!'"));
		Возврат Неопределено;
	КонецЕсли;
	
	// получим имя временного файла
	ПолноеИмяФайлаВыгрузки = ВременныйКаталог + ИмяФайлаВыгрузки;
	
	Попытка
		ДвДанные.ДобавитьСтроку(ТекстФайлаВыгрузки);
		ДвДанные.Записать(ПолноеИмяФайлаВыгрузки);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ЗаписьЖурналаРегистрации(НСтр("ru = 'Электронная подпись в модели сервиса.Работа с двоичными данными'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,,, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	// подписываем и шифруем
	
	Данные = Новый ДвоичныеДанные(ПолноеИмяФайлаВыгрузки);
	Попытка
		ЗашифрованныйПакет = КриптосервисВМоделиСервиса.ПодписатьИЗашифровать(ИдентификаторДокументооборота, СертификатыПолучателей, Данные);
		ИмяФайлаЗашифрованногоПакета = ПоместитьВоВременноеХранилище(ЗашифрованныйПакет, ПараметрыФункции.Адрес);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ЗаписьЖурналаРегистрации(НСтр("ru = 'Электронная подпись в модели сервиса.Криптосервис.ПодписатьИЗашифровать'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,,, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
			
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось подписать и зашифровать файл выгрузки!'"));
		Возврат Неопределено;
	КонецПопытки;
	
	ФайлОбъект = Новый Файл(ПараметрыФункции.ИмяФайлаВыгрузки);
	КороткоеИмяЗашифрованногоПакета = ФайлОбъект.ИмяБезРасширения + ПараметрыФункции.РасширениеСТочкой;
	
	Возврат Новый Структура("ИмяФайлаЗашифрованногоПакета, ИмяФайлаВыгрузки", ИмяФайлаЗашифрованногоПакета, КороткоеИмяЗашифрованногоПакета);
	
КонецФункции

Функция СформироватьФайлОтправкиВФССССервера(КороткоеИмяФайлаВыгрузки, СтрокаBase64ФайлаВыгрузки, ЭтоАдреса = Истина, Адрес = Неопределено, ТипОтправляемогоДокумента = Неопределено) Экспорт
	
	ДвДанные = Неопределено;
	ВременныйКаталог = КаталогВременныхФайловДвоичныхДанных(ДвДанные);
	Если ДвДанные = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// формируем файл с запросами для отсылки данных.
	ИмяФайлаОтправки = ВременныйКаталог + Строка(Новый УникальныйИдентификатор);
	
	// формируем POST-данные.
	Если ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
		И ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС Тогда
		
		СодержимоеФайла = "--My1cV8bNdr"
		+ Символы.ВК + Символы.ПС + "Content-Disposition: form-data; name=""filein""; filename=""" + КороткоеИмяФайлаВыгрузки + """"
		+ Символы.ВК + Символы.ПС + "Content-Type: application/octet-stream"
		+ Символы.ВК + Символы.ПС
		+ Символы.ВК + Символы.ПС + "*"
		+ Символы.ВК + Символы.ПС + "--My1cV8bNdr--";
		
	Иначе
		СодержимоеФайла = "*";
	КонецЕсли;
	
	ДвДанные.ДобавитьСтроку(СодержимоеФайла);
	ДвДанные.Записать(ИмяФайлаОтправки);
	
	ЗаменитьМаркерВЗапросеДвоичнымиДаннымиСервер(ИмяФайлаОтправки, СтрокаBase64ФайлаВыгрузки, ЭтоАдреса, Адрес);
	
	Возврат ИмяФайлаОтправки;
	
КонецФункции

Процедура ОбновитьРезультатКонкретнойОтправкиФССССервера(ОтправкаСсылка, ПолученРезультатОтСервераФСС) Экспорт
	
	ТипОтправляемогоДокумента = ПолучитьТипВидаОтправляемогоДокументаПоСсылкеНаОбъектОтправкиДляФСС(ОтправкаСсылка);
	
	АдресСервера = СерверПриемаОтчетностиФСС(ТипОтправляемогоДокумента);
	
	Если АдресСервера = Неопределено Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось определить тип документа!'"));
		Возврат;
	
	КонецЕсли;
	
	РезультатОтправки = ПолучитьРезультатОтправкиФСС(АдресСервера, ОтправкаСсылка.ИдентификаторОтправкиНаСервере, ОтправкаСсылка, ТипОтправляемогоДокумента);
	ПолученРезультатОтСервераФСС = (РезультатОтправки <> Неопределено);
	СохранитьРезультатОтправкиФСС(ОтправкаСсылка, РезультатОтправки);
	
КонецПроцедуры

Процедура ОбновитьРезультатОтправленногоОтчетаФССССервера(ОтчетСсылка, БылаПопыткаПолученияРезультатаОтСервераФСС, ПолученРезультатОтСервераФСС) Экспорт
	
	РезультатОбновлен = Ложь;
	
	СвойстваОтправки = ПолучитьОсновныеСвойстваПоследнейОтправкиОтчетаВФСС(ОтчетСсылка);
	
	Если СвойстваОтправки <> Неопределено Тогда
		
		ТипОтправляемогоДокумента = ПолучитьТипВидаОтправляемогоДокументаПоСсылкеНаОбъектОтправкиДляФСС(ОтчетСсылка);
		
		АдресСервера = СерверПриемаОтчетностиФСС(ТипОтправляемогоДокумента);
		
		Если АдресСервера = Неопределено Тогда
			
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось определить тип документа!'"));
			Возврат;
			
		КонецЕсли;
		
		РезультатОтправки = ПолучитьРезультатОтправкиФСС(АдресСервера, СвойстваОтправки.Идентификатор, СвойстваОтправки.Ссылка, ТипОтправляемогоДокумента);
		
		БылаПопыткаПолученияРезультатаОтСервераФСС = Истина;
		ПолученРезультатОтСервераФСС = (РезультатОтправки <> Неопределено);
		
		СохранитьРезультатОтправкиФСС(СвойстваОтправки.Ссылка, РезультатОтправки);
		
	КонецЕсли;
	
КонецПроцедуры


Функция ПолучитьРезультатОтправкиФСС(АдресСервера, ИдентификаторОтправкиНаСервере, ОтправкаСсылка, ТипОтправляемогоДокумента = Неопределено)
	
	НаименованиеОтчета = "";
	
	СсылкаКвитанция = "";
	СсылкаПротоколОшибок = "";
	СтатусОтчета = "";
	ЦветСтатуса = ЦветаСтиля.ЦветНезавершившейсяОтправкиБРО;
	СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен;
	ЕстьОшибки = Ложь;
	
	//запрос протокола обработки
	Если ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
	И ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС Тогда
		РесурсСервера = "/fss/statusreport?id=" + ИдентификаторОтправкиНаСервере;
	Иначе
		РесурсСервера = "/home/Results?id=" + ИдентификаторОтправкиНаСервере;
	КонецЕсли;
	ФайлРезультата = ПолучитьРезультатЗапросаGet(АдресСервера, РесурсСервера);
	
	Результат = Неопределено;
	
	Если ФайлРезультата <> Неопределено ИЛИ ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
		ИЛИ ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС Тогда
		
		Если ФайлРезультата <> Неопределено Тогда
			// получен протокол обработки
			Попытка
				// извлекаем таблицу обработки из файла результата
				ТЗОбработки = ИзвлечьИзФайлаТаблицуОбработки(ФайлРезультата, ТипОтправляемогоДокумента);
			Исключение
				// обрабатываем ошибки, возникшие в случае, если невозможно разобрать ответ от сервера
				ОбъектЧтениеТекста = Новый ЧтениеТекста;
				ОбъектЧтениеТекста.Открыть(ФайлРезультата);
				ТекстОтвета = ОбъектЧтениеТекста.Прочитать();
				ОбъектЧтениеТекста.Закрыть();
				
				Если (ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
				ИЛИ ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС) И (СокрЛП(ТекстОтвета) = "OK;") Тогда
					//ситуация, когда отчет еще не обработан
					ФайлРезультата = Неопределено;
					ТЗОбработки = Новый ТаблицаЗначений;
				Иначе
					
					Если Найти(ВРЕГ(ТекстОтвета), НСтр("ru = 'НЕДОСТУПЕН'")) <> 0 Тогда
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Сервер ФСС недоступен'"));
					Иначе
						ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось разобрать ответ, полученный от сервера ФСС'"));
					КонецЕсли;
					
					Возврат Результат;
				КонецЕсли;
			КонецПопытки;
		Иначе
			ТЗОбработки = Новый ТаблицаЗначений;
		КонецЕсли;
		
		Если ФайлРезультата <> Неопределено Тогда
			// читаем содержимое протокола обработки
			ОбъектЧтение = Новый ЧтениеТекста(ФайлРезультата, "utf-8");
			стрРезультатОбработки = СокрЛП(ОбъектЧтение.Прочитать());
			
			ОбъектЧтение.Закрыть();
		Иначе
			//ситуация, когда отчет еще не обработан
			стрРезультатОбработки = "";
		КонецЕсли;
		
		// анализируем содержимое страницы протокола обработки
		Если Найти(стрРезультатОбработки, "invoice?id") > 0 Тогда
			// есть ссылка на квитанцию - отчет принят
			Если ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
			И ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС Тогда
				СсылкаКвитанция = "invoice?id=" + ИдентификаторОтправкиНаСервере;
			Иначе
				НомерОтправкиНаСервере = ТекстПослеПрефикса(стрРезультатОбработки, "invoice?id=", """");
				Попытка
					// вызываем генерацию квитанции
					ПолучитьРезультатЗапросаGet(АдресСервера, "invoice?id=" + НомерОтправкиНаСервере);
				Исключение
				КонецПопытки;
				СсылкаКвитанция = "/Tickets/" + НомерОтправкиНаСервере + ".p7e";
			КонецЕсли;
			
			Если Найти(стрРезультатОбработки, "invoice?lid") > 0 Тогда
				// есть ссылка на протокол ошибок логического контроля
				СтатусОтправки = Перечисления.СтатусыОтправки.ПринятЕстьОшибки;
				СсылкаПротоколОшибок = "invoice?lid=" + ИдентификаторОтправкиНаСервере;
				СтатусОтчета = НСтр("ru = 'Сдан, обнаружены ошибки при логическом контроле'");
				ЦветСтатуса = ЦветаСтиля.ЦветОшибкиВПротоколеБРО;
				ЕстьОшибки = Истина;
			Иначе
				СтатусОтправки = Перечисления.СтатусыОтправки.Сдан;
				СтатусОтчета = НСтр("ru = 'Сдан, ошибок не обнаружено.'");
				ЦветСтатуса = ЦветаСтиля.ЦветПоложительногоПротокола;
			КонецЕсли;
			
		ИначеЕсли Найти(стрРезультатОбработки, "invoice?fid") > 0 ИЛИ ((ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
			ИЛИ ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС) И (ТЗОбработки.Количество() = 0) И (стрРезультатОбработки <> "OK;") И (стрРезультатОбработки <> "")) Тогда
			// есть ссылка на протокол ошибок форматного контроля - отчет не принят
			СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят;
			Если Найти(стрРезультатОбработки, "invoice?fid") > 0 Тогда
				СсылкаПротоколОшибок = "invoice?fid=" + ИдентификаторОтправкиНаСервере;
			КонецЕсли;
			СтатусОтчета = НСтр("ru = 'Не принят, обнаружены ошибки при форматном контроле'");
			ЦветСтатуса = ЦветаСтиля.ЦветОшибкиВПротоколеБРО;
			ЕстьОшибки = Истина;
		ИначеЕсли ЕстьОшибкиСтатуса(ТЗОбработки) Тогда
			СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят;
			СтатусОтчета = НСтр("ru = 'Не принят, обнаружены ошибки'");
			ЦветСтатуса = ЦветаСтиля.ЦветОшибкиВПротоколеБРО;
			ЕстьОшибки = Истина;
		Иначе
			//отчет еще не обработан
			СтатусОтчета = НСтр("ru = 'Находится в обработке'");
		КонецЕсли;
		
		ПротоколОшибок = "";
		ПротоколОшибокЭтоHTML = Ложь;
		Если СсылкаПротоколОшибок <> "" ИЛИ ((ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
			ИЛИ ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС)
			И (ФайлРезультата <> Неопределено) И (ТЗОбработки.Количество() = 0)) Тогда
			
			Если СсылкаПротоколОшибок <> "" Тогда
				//по полученной ссылке скачаем протокол ошибок
				ФайлРезультата = ПолучитьРезультатЗапросаGet(АдресСервера, СсылкаПротоколОшибок);
			КонецЕсли;
			// считаем содержимое протокола ошибок
			ОбъектЧтение = Новый ЧтениеТекста(ФайлРезультата);
			ПротоколОшибок = СокрЛП(ОбъектЧтение.Прочитать());
			
			ПротоколОшибокЭтоHTML = Найти(ВРЕГ(ПротоколОшибок), "HTML") > 0;
			
			Если ПротоколОшибокЭтоHTML Тогда
				ОбъектЧтение = Новый ЧтениеТекста(ФайлРезультата, "utf-8");
				ПротоколОшибок = СокрЛП(ОбъектЧтение.Прочитать());
			КонецЕсли;
		КонецЕсли;
		
		Если ПротоколОшибокЭтоHTML Тогда
			Протокол = ПротоколОшибок;
		Иначе
			Протокол = ГенерироватьHTMLПротоколаОбработкиФСС(ИдентификаторОтправкиНаСервере, ТЗОбработки, ПротоколОшибок, СтатусОтчета, ЦветСтатуса, ОтправкаСсылка, ЕстьОшибки);
		КонецЕсли;
		
		//заполняем результирующую структуру
		Результат = Новый Структура("ДатаПолученияРезультата, СтатусОтправки, Протокол, Квитанция");
		Результат.Вставить("ДатаПолученияРезультата", ТекущаяДатаСеанса());
		Результат.Вставить("Протокол", Протокол);
		Результат.Вставить("СтатусОтправки", СтатусОтправки);
		
		Если СсылкаКвитанция <> "" Тогда
			//по полученной ссылке скачаем квитанцию
			ФайлРезультата = ПолучитьРезультатЗапросаGet(АдресСервера, СсылкаКвитанция);
			Квитанция = Новый ДвоичныеДанные(ФайлРезультата);
			Результат.Вставить("Квитанция", Квитанция);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция СохранитьРезультатОтправкиФСС(ОправкаСсылка, РезультатОтправки)
	
	Если РезультатОтправки <> Неопределено Тогда
		ОтправкаОбъект = ОправкаСсылка.ПолучитьОбъект();
		ОтправкаОбъект.ДатаПолученияРезультата = РезультатОтправки.ДатаПолученияРезультата;
		ОтправкаОбъект.СтатусОтправки = РезультатОтправки.СтатусОтправки;
		ОтправкаОбъект.Протокол = Новый ХранилищеЗначения(РезультатОтправки.Протокол);
		Если РезультатОтправки.Квитанция <> Неопределено Тогда
			ОтправкаОбъект.Квитанция = Новый ХранилищеЗначения(РезультатОтправки.Квитанция);
		КонецЕсли;
		ОтправкаОбъект.Записать();
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьРезультатЗапросаGet(АдресСервера, РесурсСервера)
	
	// инициализируем настройки прокси, если они определены
	НастройкаПроксиСервера = ПолучениеФайловИзИнтернета.НастройкиПроксиНаСервере();
	
	Если НастройкаПроксиСервера <> Неопределено Тогда
		Прокси = СформироватьПрокси(НастройкаПроксиСервера, "HTTP");
	Иначе
		Прокси = Новый ИнтернетПрокси;
	КонецЕсли;
	
	// устанавливаем соединение с сервером
	Попытка
		Соединение = Новый HTTPСоединение(АдресСервера, , , , Прокси);
	Исключение
		//ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки:'") + Символы.ПС + ИнформацияОбОшибке().Описание);
		Возврат Неопределено;
	КонецПопытки;
	
	// посылаем запрос
	ФайлРезультата = ПолучитьИмяВременногоФайла();
	Попытка
		Соединение.Получить(РесурсСервера, ФайлРезультата);
		Соединение = Неопределено;
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат ФайлРезультата;
	
КонецФункции

// Функция формирует прокси по настройкам прокси (передаваемому параметру)
//
// Параметры:
// 
// НастройкиПрокси - Соответствие -
//                 ключи:
//                 НеИспользоватьПроксиДляЛокальныхАдресов - строка - 
//                 Сервер       - адрес прокси-сервера
//                 Порт         - порт прокси-сервера
//                 Пользователь - имя пользователя для авторизации на прокси-сервере
//                 Пароль       - пароль пользователя
// Протокол      - строка - протокол для которого устанавливаются параметры прокси сервера
//                 например "http", "https", "ftp"
// 
Функция СформироватьПрокси(НастройкиПрокси, Протокол)
	
	Прокси = Новый ИнтернетПрокси;
	Прокси.НеИспользоватьПроксиДляЛокальныхАдресов = НастройкиПрокси["НеИспользоватьПроксиДляЛокальныхАдресов"];
	Прокси.Установить(Протокол, НастройкиПрокси["Сервер"], НастройкиПрокси["Порт"]);
	Прокси.Пользователь = НастройкиПрокси["Пользователь"];
	Прокси.Пароль       = НастройкиПрокси["Пароль"];
	
	Возврат Прокси;
	
КонецФункции

Функция ГенерироватьHTMLПротоколаОбработкиФСС(ИдентификаторОтчета, ТЗОбработки, ПротоколОшибок, СтатусОтчета, ЦветСтатуса, ОтправкаСсылка, ЕстьОшибки)
	
	ТабДок = Новый ТабличныйДокумент;
	
	Шаблон = ПолучитьМакет("ФССШаблонДляHTML");
	
	СекцияШапка = Шаблон.ПолучитьОбласть("Шапка");
	
	СвойстваОрганизации 			= РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(ОтправкаСсылка.Организация, ,"НаимЮЛПол, ИННЮЛ");
	ПолноеНаименованиеОрганизации 	= СвойстваОрганизации.НаимЮЛПол;
	ИННОрганизации 					= СвойстваОрганизации.ИННЮЛ;

	// Наименование протокола 
	НаименованиеПротокола = "";
	Если ЕстьОшибки Тогда
		НаименованиеПротокола = НСтр("ru = 'Протокол ошибок'");
	Иначе
		НаименованиеПротокола = НСтр("ru = 'Протокол о сдаче'");
	КонецЕсли;
	СекцияШапка.Параметры.НаименованиеПротокола = НаименованиеПротокола;
	
	СведенияПоОбъекту 	= СведенияПоОтправляемымОбъектам(ОтправкаСсылка.ОтчетСсылка);
	НаименованиеОргана 	= СведенияПоОбъекту.ПредставлениеКонтролирующегоОргана;
	НаименованиеОтчета 	= СведенияПоОбъекту.Наименование;

	СекцияШапка.Параметры.Организация 	= ПолноеНаименованиеОрганизации;
	СекцияШапка.Параметры.ИНН 			= НСтр("ru = 'ИНН '") + ИННОрганизации;
	СекцияШапка.Параметры.Получатель 	= НаименованиеОргана;
	СекцияШапка.Параметры.Отчет 		= НаименованиеОтчета;
	СекцияШапка.Параметры.СтатусОтчета 	= СтатусОтчета;
	СекцияШапка.Параметры.Файл 			= ИдентификаторОтчета;
	СекцияШапка.Области.СтатусОтчета.ЦветТекста = ЦветСтатуса;
			
	ТабДок.Вывести(СекцияШапка);
	
	СекцияСтрока = Шаблон.ПолучитьОбласть("Строка");
	Для каждого СтрокаТЗ Из ТЗОбработки Цикл
		СекцияСтрока.Параметры.Заполнить(СтрокаТЗ);
		ТабДок.Вывести(СекцияСтрока);
	КонецЦикла;
	
	СекцияПодвал = Шаблон.ПолучитьОбласть("Подвал");
	ТабДок.Вывести(СекцияПодвал);
	
	Если ПротоколОшибок <> "" Тогда
		СекцияПротоколОшибок = Шаблон.ПолучитьОбласть("ПротоколОшибок");
		СекцияПротоколОшибок.Параметры.ПротоколОшибок = ПротоколОшибок;
		ТабДок.Вывести(СекцияПротоколОшибок);
	КонецЕсли;

	ИмяТемпФайла = ПолучитьИмяВременногоФайла();
	ТабДок.Записать(ИмяТемпФайла, ТипФайлаТабличногоДокумента.HTML);
	ТекстHTML = Новый ТекстовыйДокумент;
	ТекстHTML.Прочитать(ИмяТемпФайла);
	ТекстHTML = ТекстHTML.ПолучитьТекст();
	
	Возврат ТекстHTML;
	
КонецФункции

Функция ЕстьОшибкиСтатуса(ТЗОбработки)
	
	Для каждого СтрокаТЗ Из ТЗОбработки Цикл
		Если СтрокаТЗ.Статус = "Ошибка" Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

Функция ИзвлечьИзФайлаТаблицуОбработки(ФайлОтвета, ТипОтправляемогоДокумента = Неопределено)
	
	ТЗОбработки = Новый ТаблицаЗначений;
	ТЗОбработки.Колонки.Добавить("СтадияОбработки");
	ТЗОбработки.Колонки.Добавить("Статус");
	ТЗОбработки.Колонки.Добавить("Дата");
	ТЗОбработки.Колонки.Добавить("КодОшибки");
	ТЗОбработки.Колонки.Добавить("ОписаниеОшибки");
	ТЗОбработки.Колонки.Добавить("Действие");
	
	ЧтениеHTML = Новый ЧтениеHTML;
	ЧтениеHTML.ОткрытьФайл(ФайлОтвета, "utf-8");
	ПостроительDOM = Новый ПостроительDOM;
	ДокументDOM = ПостроительDOM.Прочитать(ЧтениеHTML);
	
	ЭлементыTABLE = ДокументDOM.ПолучитьЭлементыПоИмени("TABLE");
	
	СтрокиТаблицыHTML = ЭлементыTABLE[?(ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
		И ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС, 2, 0)].ДочерниеУзлы;
	
	//перебираем все строки из таблицы обработки, первая строка таблицы (индекс 0)- заголовки - не используем
	КолвоСтрок = СтрокиТаблицыHTML.Количество();
	Для НомСтроки = 1 По (КолвоСтрок - 1) Цикл
		СтрокаТаблицыHTML = СтрокиТаблицыHTML[НомСтроки];
		НоваяСтрокаТЗ = ТЗОбработки.Добавить();
	    //перебираем ячейки строки таблицы (выделяя их из общего списка узлов по типу), заполняем ТЗ
		УзлыСтрокиHTML = СтрокаТаблицыHTML.ДочерниеУзлы;
		НомЯчейки = 0;
		Для каждого УзелСтрокиHTML Из УзлыСтрокиHTML Цикл
			Если УзелСтрокиHTML.ТипУзла = ТипУзлаDOM.Элемент Тогда
				НоваяСтрокаТЗ[НомЯчейки] = СокрЛП(УзелСтрокиHTML.ТекстовоеСодержимое);
				НомЯчейки = НомЯчейки + 1;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Возврат ТЗОбработки;
	
КонецФункции

Функция ПроверитьПередОтправкойВФСС(Отчет, ТекстВопроса) Экспорт
	
	ТекущаяОтправка = ПолучитьПоследнююОтправкуОтчетаВФСС(Отчет);
	Если ЗначениеЗаполнено(ТекущаяОтправка) Тогда
		СтатусОтправки = ТекущаяОтправка.СтатусОтправки;
		Если СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен Тогда
			ТекстВопроса = НСтр("ru = 'Отчет уже отправлен, результат отправки не получен.
									  |Вы действительно хотите отправить отчет повторно?'");
			Возврат Ложь;
		ИначеЕсли СтатусОтправки = Перечисления.СтатусыОтправки.Сдан Тогда
			ТекстВопроса = НСтр("ru = 'Отчет уже отправлен и успешно сдан.
									  |Вы действительно хотите отправить отчет повторно?'");
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

Функция ОтправкаНаСерверФСС(ЭтоЭлектроннаяПодписьВМоделиСервиса, АдресСервера, КороткоеИмяФайлаПакета, СтрокаBase64ФайлаПакета, ИмяФайлаОтправки, ОтчетСсылка, ПоляДляЗаписиОтправки, ПовторятьСоединение, ТипОтправляемогоДокумента)
	
	Идентификатор = Неопределено;
	ОписаниеОшибкиСервером = Неопределено;
	ОтветПолучен = ОтправкаЗашифрованногоПакетаНаСерверФСС(АдресСервера, ИмяФайлаОтправки, ТипОтправляемогоДокумента, КороткоеИмяФайлаПакета, Идентификатор, ОписаниеОшибкиСервером);
	Если ОтветПолучен Тогда
		ПовторятьСоединение = Ложь;
		Если Идентификатор <> Неопределено Тогда
			//отправленный файл принят сервером, отправке присвоен идентификатор
			НоваяЗапись = Справочники.ОтправкиФСС.СоздатьЭлемент();
			НоваяЗапись.ОтчетСсылка = ОтчетСсылка;
			НоваяЗапись.ИдентификаторОтправкиНаСервере = Идентификатор;
			
			Если ЭтоЭлектроннаяПодписьВМоделиСервиса Тогда
				ДвоичныеДанныеФайлаПакета = ПолучитьИзВременногоХранилища(СтрокаBase64ФайлаПакета);
			Иначе
				ДвоичныеДанныеФайлаПакета = Base64Значение(СтрокаBase64ФайлаПакета);
			КонецЕсли;
			
			НоваяЗапись.ЗашифрованныйПакет = Новый ХранилищеЗначения(ДвоичныеДанныеФайлаПакета);
			НоваяЗапись.ИмяФайлаПакета = КороткоеИмяФайлаПакета;
			НоваяЗапись.СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен;
			НоваяЗапись.ДатаОтправки = ТекущаяДатаСеанса();
			НоваяЗапись.Организация = ОтчетСсылка.Организация;
			НоваяЗапись.КодОрганаФСС = ПоляДляЗаписиОтправки.КодОрганаФСС;
			НоваяЗапись.ДатаНачалаПериода = ПоляДляЗаписиОтправки.ДатаНачалаПериода;
			НоваяЗапись.ДатаОкончанияПериода = ПоляДляЗаписиОтправки.ДатаОкончанияПериода;
			НоваяЗапись.Версия = ПоляДляЗаписиОтправки.Версия;
			НоваяЗапись.ПредставлениеПериода = ПредставлениеПериода(НоваяЗапись.ДатаНачалаПериода, КонецДня(НоваяЗапись.ДатаОкончанияПериода), "ФП=Истина");
			НоваяЗапись.ПредставлениеВидаДокумента = РегламентированнаяОтчетность.ПредставлениеВидаДокумента(НоваяЗапись.Версия);
			
			ТипЗнчСсылкаНаОтчет = ТипЗнч(ОтчетСсылка);
			ЭтоРеестрСведений = ДокументооборотСФССКлиентСервер.ЭтоРеестрСведенийНаВыплатуПособийФСС(ОтчетСсылка);
			
			ВидОтчета = Неопределено;
			
			Если ТипЗнчСсылкаНаОтчет = Тип("ДокументСсылка.РегламентированныйОтчет") Тогда
				// ОбъектФСС - рег отчет
				ВидОтчета = Справочники.ВидыОтправляемыхДокументов.НайтиПоРеквизиту("Источник", ОтчетСсылка.ИсточникОтчета);
			ИначеЕсли ЭтоРеестрСведений Тогда
				ВидОтчета = Справочники.ВидыОтправляемыхДокументов.РеестрСведенийВФСС;
			ИначеЕсли ТипЗнчСсылкаНаОтчет = Тип("СправочникСсылка.ЭлектронныеПредставленияРегламентированныхОтчетов") Тогда
				ВидОтчета = ОтчетСсылка.ВидОтчета;
			КонецЕсли;
			
			Если ВидОтчета = Неопределено Тогда
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось определить тип документа!'"));
				Возврат Неопределено;
			КонецЕсли;
			
			НоваяЗапись.ВидОтчета = ВидОтчета;
			НоваяЗапись.Записать();
			
			Возврат НоваяЗапись.Ссылка;
		Иначе
			Если ОписаниеОшибкиСервером <> Неопределено Тогда
				//отправленный файл не был принят сервером, получено описание ошибки
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Отчет не принят сервером.'") + " " + ОписаниеОшибкиСервером);
			Иначе
				// в ответе сервера отсутствует как идентификатор, так и описание ошибки
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Зашифрованный пакет не удалось отправить на сервер ФСС.'"));
			КонецЕсли;
			Возврат Неопределено;
		КонецЕсли;
	Иначе
		ПовторятьСоединение = Истина;
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Функция ОтправитьВФССССервера(ЭтоЭлектроннаяПодписьВМоделиСервиса, АдресСервера, КороткоеИмяФайлаПакета, СтрокаBase64ФайлаОтправки, СтрокаBase64ФайлаПакета, ОтчетСсылка, ПоляДляЗаписиОтправки, ПовторятьСоединение, ТипОтправляемогоДокумента) Экспорт
	
	ВременныйКаталог = КаталогВременныхФайлов();
	РазделительПутиОС = ПолучитьРазделительПути();
	Если Прав(ВременныйКаталог, 1) <> РазделительПутиОС Тогда
		ВременныйКаталог = ВременныйКаталог + РазделительПутиОС;
	КонецЕсли;
	
	ИмяФайлаОтправки = ВременныйКаталог + КороткоеИмяФайлаПакета;
	
	Если ЭтоЭлектроннаяПодписьВМоделиСервиса Тогда
		ДвоичныеДанныеФайлаОтправки = ПолучитьИзВременногоХранилища(СтрокаBase64ФайлаОтправки);
	Иначе
		ДвоичныеДанныеФайлаОтправки = Base64Значение(СтрокаBase64ФайлаОтправки);
	КонецЕсли;
	ДвоичныеДанныеФайлаОтправки.Записать(ИмяФайлаОтправки);
	
	Возврат ОтправкаНаСерверФСС(ЭтоЭлектроннаяПодписьВМоделиСервиса, АдресСервера, КороткоеИмяФайлаПакета, СтрокаBase64ФайлаПакета, ИмяФайлаОтправки, ОтчетСсылка, ПоляДляЗаписиОтправки, ПовторятьСоединение, ТипОтправляемогоДокумента);
	
КонецФункции

Функция ПолучитьОтпечаткиСертификатовИзНастроекОрганизацииДляФСС(ОрганизацияСсылка) Экспорт
	
	Запрос = Новый Запрос;
	ТекстЗапроса =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НастройкиОбменаФСС.СертификатСтрахователяОтпечаток КАК СертификатСтрахователяОтпечаток,
		|	НастройкиОбменаФСС.СертификатФССОтпечаток КАК СертификатФССОтпечаток
		|ИЗ
		|	РегистрСведений.НастройкиОбменаФСС КАК НастройкиОбменаФСС
		|ГДЕ
		|	НастройкиОбменаФСС.Организация = &ОрганизацияСсылка
		|	И НастройкиОбменаФСС.ИспользоватьОбмен = ИСТИНА";
	
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("ОрганизацияСсылка", ОрганизацияСсылка);
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если НЕ Выборка.Следующий() Тогда
		Возврат Неопределено;
	Иначе
		Возврат Новый Структура("СертификатСтрахователяОтпечаток, СертификатФССОтпечаток", 
		Выборка.СертификатСтрахователяОтпечаток, Выборка.СертификатФССОтпечаток);
	КонецЕсли;
	
КонецФункции

Функция ПолучитьОсновныеСвойстваПоследнейОтправкиОтчетаВФСС(ОтчетСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	ОтправкиФСС.Ссылка,
	               |	ОтправкиФСС.ИдентификаторОтправкиНаСервере КАК Идентификатор,
	               |	ОтправкиФСС.СтатусОтправки КАК Статус,
	               |	ОтправкиФСС.Организация КАК Организация,
	               |	ОтправкиФСС.КодОрганаФСС КАК КодОрганаФСС,
	               |	ОтправкиФСС.Наименование КАК Наименование,
	               |	ОтправкиФСС.ИмяФайлаПакета КАК ИмяФайлаПакета
				   |ИЗ
	               |	Справочник.ОтправкиФСС КАК ОтправкиФСС
	               |ГДЕ
	               |	ОтправкиФСС.ОтчетСсылка = &ЭтотОтчет
	               |	И ОтправкиФСС.ПометкаУдаления = ЛОЖЬ
	               |
	               |УПОРЯДОЧИТЬ ПО
	               |	ОтправкиФСС.ДатаОтправки УБЫВ";
	Запрос.Параметры.Вставить("ЭтотОтчет", ОтчетСсылка);
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции 

Функция ПолучитьПоследнююОтправкуОтчетаВФСС(ОтчетСсылка) Экспорт
	
	Отправка = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
				   |	ОтправкиФСС.Ссылка
				   |ИЗ
				   |	Справочник.ОтправкиФСС КАК ОтправкиФСС
				   |ГДЕ
				   |	ОтправкиФСС.ОтчетСсылка = &ЭтотОтчет
				   |	И ОтправкиФСС.ПометкаУдаления = ЛОЖЬ
				   |
				   |УПОРЯДОЧИТЬ ПО
				   |	ОтправкиФСС.ДатаОтправки УБЫВ";
	Запрос.Параметры.Вставить("ЭтотОтчет", ОтчетСсылка);
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Отправка = Выборка.Ссылка;
	КонецЕсли;
	Возврат Отправка;
	
КонецФункции

Процедура ОбновитьСтатусОтправкиФССОтчета(Отчет)
	
	// находим последнюю не помеченную на удаление отправку отчета
	ПоследняяОтправка = ПолучитьПоследнююОтправкуОтчетаВФСС(Отчет);
	
	// вычисляем значение статуса отправки (Перечисления.СтатусыОтправки)
	Если ЗначениеЗаполнено(ПоследняяОтправка) Тогда
		СтатусОтправки = ПоследняяОтправка.СтатусОтправки;
		Если СтатусОтправки = Перечисления.СтатусыОтправки.ПринятЕстьОшибки Тогда
			//введено после добавления дополнительного статуса ПринятЕстьОшибки, при котором отчет считается сданным
			СтатусОтправки = Перечисления.СтатусыОтправки.Сдан;
		КонецЕсли;
	Иначе
		СтатусОтправки = Неопределено;
	КонецЕсли;
	
	// сохраняем статус в базе
	ЗаписатьСтатусОтправкиФССОтчета(Отчет, СтатусОтправки, ПоследняяОтправка);
	
КонецПроцедуры

Процедура ЗаписатьСтатусОтправкиФССОтчета(Отчет, СтатусОтправки, ОснованиеСтатуса)
	
	Если ЗначениеЗаполнено(СтатусОтправки) Тогда
		МенЗап = РегистрыСведений.СтатусыОтправки.СоздатьМенеджерЗаписи();
		МенЗап.Объект = Отчет;
		МенЗап.Статус = СтатусОтправки;
		МенЗап.Основание = ОснованиеСтатуса;
		МенЗап.Записать(Истина);
	Иначе
		МенЗап = РегистрыСведений.СтатусыОтправки.СоздатьМенеджерЗаписи();
		МенЗап.Объект = Отчет;
		МенЗап.Прочитать();
		Если МенЗап.Выбран() Тогда
			МенЗап.Удалить();
		КонецЕсли;
	КонецЕсли;
	
	// вызываем переопределяемую процедуру отработки изменения статуса отправки
	ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ПриИзмененииСтатусаОтправкиДокумента(Отчет, СтатусОтправки);
	
КонецПроцедуры

Функция ПолучитьПустуюДатуЗавершенияОтправкиФСС()
	
	Возврат '39991231235959';
	
КонецФункции

Процедура ПередЗаписьюОтправкиФСС(Объект, Отказ)
	
	Если НЕ ЗначениеЗаполнено(Объект.Период) Тогда
		Объект.Период = СокрЛП(Формат(Объект.ДатаОкончанияПериода, "ДФ=yyyyMMdd") + Формат('39991231' - Объект.ДатаНачалаПериода, "ДФ=yyyyMMdd"));
	КонецЕсли;
	
	Если Объект.СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен Тогда
		
		Если НЕ ЗначениеЗаполнено(Объект.ДатаЗакрытия) Тогда
			Объект.ДатаЗакрытия = ПолучитьПустуюДатуЗавершенияОтправкиФСС();
		КонецЕсли;
		
	Иначе
		Объект.ДатаЗакрытия = Объект.ДатаПолученияРезультата;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписиОтправкиФСС(Объект, Отказ)
	
	Если Объект.ОтчетСсылка <> Неопределено Тогда
		// отражаем изменения в регистре статусов отправки
		ОбновитьСтатусОтправкиФССОтчета(Объект.ОтчетСсылка);
		ЭлектронныйДокументооборотСКонтролирующимиОрганами.ЗаписьОбъектовРегламентированнойОтчетности(Объект.ОтчетСсылка, Отказ);
	КонецЕсли;
	
КонецПроцедуры

Функция СписокДопустимыхОрганизацийВОбъектахОбменаФСС() Экспорт
	
	Запрос = Новый Запрос;
	ТекстЗапроса =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НастройкиОбменаФСС.Организация КАК Организация
		|ИЗ
		|	РегистрСведений.НастройкиОбменаФСС КАК НастройкиОбменаФСС
		|ГДЕ
		|	НастройкиОбменаФСС.ИспользоватьОбмен = Истина";
	
	Запрос.Текст = ТекстЗапроса;
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Организация");
	
КонецФункции

Функция ОрганизацияИспользуетОбменСФСС(ОрганизацияСсылка, ИспользуетсяАвтонастройка = Ложь, ДоступностьОнлайнПроверки = Ложь) Экспорт
	
	Если ДоступностьОнлайнПроверки Тогда
		СвойстваОрганизации = ЗначенияРеквизитовОбъекта(ОрганизацияСсылка, "ВидОбменаСКонтролирующимиОрганами, УчетнаяЗаписьОбмена");
		
		Попытка
			ОбменИОнлайнПроверкаВключены = СвойстваОрганизации.ВидОбменаСКонтролирующимиОрганами = Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате И ЗначениеЗаполнено(СвойстваОрганизации.УчетнаяЗаписьОбмена)
				И НЕ СвойстваОрганизации.УчетнаяЗаписьОбмена.ОбменНапрямую И СвойстваОрганизации.УчетнаяЗаписьОбмена.ИспользоватьСервисОнлайнПроверкиОтчетов;
		Исключение
			ОбменИОнлайнПроверкаВключены = Ложь;
		КонецПопытки;
		
		ДоступностьОнлайнПроверки = ОбменИОнлайнПроверкаВключены И СвойстваОрганизации.УчетнаяЗаписьОбмена.СпецоператорСвязи <> Перечисления.СпецоператорыСвязи.Такском
			И Найти(";" + ВРег(СокрЛП(ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПолучитьПараметрСпецоператора(СвойстваОрганизации.УчетнаяЗаписьОбмена.СпецоператорСвязи, "ОнлайнПроверкаКонтролирующиеОрганы"))) + ";", ";ФСС;") > 0;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	ТекстЗапроса =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НастройкиОбменаФСС.ИспользоватьОбмен КАК ИспользоватьОбмен,
		|	НастройкиОбменаФСС.ИспользоватьАвтонастройку КАК ИспользоватьАвтонастройку
		|ИЗ
		|	РегистрСведений.НастройкиОбменаФСС КАК НастройкиОбменаФСС
		|ГДЕ
		|	НастройкиОбменаФСС.Организация = &ОрганизацияСсылка";
	
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("ОрганизацияСсылка", ОрганизацияСсылка);
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() И Выборка.ИспользоватьОбмен Тогда
		ИспользуетсяАвтонастройка = Выборка.ИспользоватьАвтонастройку;
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция ОрганизацияИспользуетОбменСФСРАР(ОрганизацияСсылка) Экспорт
	
	Возврат НастройкиФСРАР(ОрганизацияСсылка).ИспользоватьОбмен;
	
КонецФункции

Функция ОрганизацияИспользуетОбменСРПН(ОрганизацияСсылка) Экспорт
	
	Возврат НастройкиРПН(ОрганизацияСсылка).ИспользоватьОбмен;
	
КонецФункции

Функция ОрганизацияИспользуетОбменСФНС(ОрганизацияСсылка) Экспорт
	
	УчетнаяЗапись = УчетнаяЗаписьОрганизации(ОрганизацияСсылка);
	Если УчетнаяЗапись = Справочники.УчетныеЗаписиДокументооборота.ПустаяСсылка() Тогда
		ДокументооборотПодключен = Ложь;
	Иначе
		ДокументооборотПодключен = ДокументооборотСКОВызовСервера.УчетнаяЗаписьПредназначенаДляДокументооборотаСФНС(УчетнаяЗапись);
	КонецЕсли;
	
	Возврат ДокументооборотПодключен;
	
КонецФункции

Функция ОрганизацияИспользуетОбменСПФР(ОрганизацияСсылка) Экспорт
	
	УчетнаяЗапись = УчетнаяЗаписьОрганизации(ОрганизацияСсылка);
	Если УчетнаяЗапись = Справочники.УчетныеЗаписиДокументооборота.ПустаяСсылка() Тогда
		ДокументооборотПодключен = Ложь;
	Иначе
		ДокументооборотПодключен = ДокументооборотСКОВызовСервера.УчетнаяЗаписьПредназначенаДляДокументооборотаСПФР(УчетнаяЗапись);
	КонецЕсли;
	
	Возврат ДокументооборотПодключен;
	
КонецФункции

Функция ОрганизацияИспользуетОбменСФСГС(ОрганизацияСсылка) Экспорт
	
	УчетнаяЗапись = УчетнаяЗаписьОрганизации(ОрганизацияСсылка);
	Если УчетнаяЗапись = Справочники.УчетныеЗаписиДокументооборота.ПустаяСсылка() Тогда
		ДокументооборотПодключен = Ложь;
	Иначе
		ДокументооборотПодключен = ДокументооборотСКОВызовСервера.УчетнаяЗаписьПредназначенаДляДокументооборотаСФСГС(УчетнаяЗапись);
	КонецЕсли;
	
	Возврат ДокументооборотПодключен;
	
КонецФункции

Процедура ПолучитьСвойстваОрганизацииДляФСС(Организация, НастроенОбменВУниверсальномФормате, ОрганизацияИспользуетОбменСФСС, ОрганизацияИспользуетАвтонастройкуПоУчетнойЗаписи) Экспорт
	
	ОрганизацияИспользуетОбменСФСС = Ложь;
	НастроенОбменВУниверсальномФормате = Ложь;
	
	ОрганизацияИспользуетОбменСФСС = ОрганизацияИспользуетОбменСФСС(Организация, ОрганизацияИспользуетАвтонастройкуПоУчетнойЗаписи);
	
	СвойстваОрганизации = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Организация, "ВидОбменаСКонтролирующимиОрганами, УчетнаяЗаписьОбмена");
	
	УчетнаяЗаписьДокументооборота = СвойстваОрганизации.УчетнаяЗаписьОбмена;
	
	Если СвойстваОрганизации.ВидОбменаСКонтролирующимиОрганами = Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате
		И ЗначениеЗаполнено(УчетнаяЗаписьДокументооборота) Тогда
		НастроенОбменВУниверсальномФормате = Истина;
	КонецЕсли;
	
КонецПроцедуры

Функция ОтправкаЗашифрованногоПакетаНаСерверФСС(АдресСервера, ИмяФайлаОтправки, ТипОтправляемогоДокумента = Неопределено, КороткоеИмяФайлаПакета = Неопределено, Идентификатор = Неопределено, ОписаниеОшибкиСервером = Неопределено)
	
	Идентификатор = Неопределено;
	ОписаниеОшибкиСервером = Неопределено;
	ОтветПолучен = Ложь;
	
	// инициализируем настройки прокси, если они определены
	НастройкаПроксиСервера = ПолучениеФайловИзИнтернета.НастройкиПроксиНаСервере();
	
	Если НастройкаПроксиСервера <> Неопределено Тогда
		Прокси = СформироватьПрокси(НастройкаПроксиСервера, "HTTP");
	Иначе
		Прокси = Новый ИнтернетПрокси;
	КонецЕсли;
	
	// устанавливаем соединение с сервером
	Попытка
		Соединение = Новый HTTPСоединение(АдресСервера, , , , Прокси);
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось установить соединение с сервером'") + ":" + Символы.ПС + ИнформацияОбОшибке().Описание);
		Возврат Ложь;
	КонецПопытки;
	
	Если ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
	И ТипОтправляемогоДокумента <> Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС Тогда
		
		РесурсНаСервере = "uploadfile";
		
		// формируем общие заголовки
		ЗаголовокHTTP = Новый Соответствие();
		
		ЗаголовокHTTP.Вставить("Content-Type", "multipart/form-data; boundary=My1cV8bNdr");
		
		// посылаем запрос
		ФайлРезультата = ПолучитьИмяВременногоФайла();
		Попытка
			Соединение.ОтправитьДляОбработки(ИмяФайлаОтправки, РесурсНаСервере, ФайлРезультата, ЗаголовокHTTP);
			Соединение = Неопределено;
		Исключение
			Возврат Ложь;
		КонецПопытки;
		
		ОтветПолучен = Истина;
		Идентификатор = ИзвлечьЗначениеТега(ФайлРезультата, "identifier");
		Если Идентификатор = Неопределено Тогда
			ОписаниеОшибкиСервером = ИзвлечьЗначениеТега(ФайлРезультата, "error");
		КонецЕсли;
		УдалитьВременныйФайл(ФайлРезультата);
		
	Иначе
		
		РесурсНаСервере = "/home/UploadFiles";
		РесурсНаСервереПодтверждение = "/home/UploadFilesFinish";
		РесурсНаСервереЗапросаСписка = "/home/CheckUpload";
		
		ИдентификаторСессии = УникальныйИдентификаторСессииASPNET();
		
		// формируем общие заголовки
		ЗаголовкиHTTP = Новый Соответствие();
		ЗаголовкиHTTP.Вставить("Content-Type", "multipart/form-data");
		ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
		ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
		ЗаголовкиHTTP.Вставить("Cookie", "ASP.NET_SessionId=" + ИдентификаторСессии);
		
		// посылаем запрос
		ФайлРезультата = ПолучитьИмяВременногоФайла();
		Попытка
			Соединение.ОтправитьДляОбработки(ИмяФайлаОтправки, РесурсНаСервере, ФайлРезультата, ЗаголовкиHTTP);
		Исключение
			Возврат Ложь;
		КонецПопытки;
		
		ТекстовыйФайлРезультата = Новый ЧтениеТекста(ФайлРезультата, "utf-8");
		ТекстРезультата = ТекстовыйФайлРезультата.Прочитать();
		ТекстовыйФайлРезультата.Закрыть();
		УдалитьВременныйФайл(ФайлРезультата);
		
		ОтветПолучен = Истина;
		ОписаниеОшибкиСервером = ТекстОшибкиПорталаФСС(ТекстРезультата);
		Если ЗначениеЗаполнено(ОписаниеОшибкиСервером) Тогда
			Возврат ОтветПолучен;
		КонецЕсли;
		
		// посылаем подтверждение отправки
		ЗаголовкиHTTP = Новый Соответствие();
		ЗаголовкиHTTP.Вставить("Content-Type", "application/json; charset=UTF-8");
		ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
		ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
		ЗаголовкиHTTP.Вставить("Cookie", "ASP.NET_SessionId=" + ИдентификаторСессии);
		
		ТекстПодтверждения = "{""fileName"":""" + КороткоеИмяФайлаПакета + """}";
		
		ИмяФайлаПодтверждения = ПолучитьИмяВременногоФайла();
		ТекстовыйФайлПодтверждения = Новый ЗаписьТекста(ИмяФайлаПодтверждения, "utf-8");
		ТекстовыйФайлПодтверждения.Записать(ТекстПодтверждения);
		ТекстовыйФайлПодтверждения.Закрыть();
		
		ФайлРезультата = ПолучитьИмяВременногоФайла();
		Попытка
			Соединение.ОтправитьДляОбработки(ИмяФайлаПодтверждения, РесурсНаСервереПодтверждение, ФайлРезультата, ЗаголовкиHTTP);
		Исключение
			УдалитьВременныйФайл(ИмяФайлаПодтверждения);
			Возврат Ложь;
		КонецПопытки;
		
		ТекстовыйФайлРезультата = Новый ЧтениеТекста(ФайлРезультата, "utf-8");
		ТекстРезультата = ТекстовыйФайлРезультата.Прочитать();
		ТекстовыйФайлРезультата.Закрыть();
		УдалитьВременныйФайл(ИмяФайлаПодтверждения);
		УдалитьВременныйФайл(ФайлРезультата);
		
		ОписаниеОшибкиСервером = ТекстОшибкиПорталаФСС(ТекстРезультата);
		Если ЗначениеЗаполнено(ОписаниеОшибкиСервером) Тогда
			Возврат ОтветПолучен;
		КонецЕсли;
		
		// запрашиваем список отправок
		ЗаголовкиHTTP = Новый Соответствие();
		ЗаголовкиHTTP.Вставить("Content-Type", "application/json; charset=UTF-8");
		ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
		ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
		ЗаголовкиHTTP.Вставить("Cookie", "ASP.NET_SessionId=" + ИдентификаторСессии);
		
		РегистрационныйНомер = Строка(ТекстПослеПрефикса(?(ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС, "_", "")
			+ КороткоеИмяФайлаПакета, "_", "_"));
		ТекстЗапросаСписка = "{""filter"":""TwoDays"",""regNum"":""" + РегистрационныйНомер + """,""pageNum"":""0""}";
		
		ИмяФайлаЗапросаСписка = ПолучитьИмяВременногоФайла();
		ТекстовыйФайлЗапросаСписка = Новый ЗаписьТекста(ИмяФайлаЗапросаСписка, "utf-8");
		ТекстовыйФайлЗапросаСписка.Записать(ТекстЗапросаСписка);
		ТекстовыйФайлЗапросаСписка.Закрыть();
		
		ФайлРезультата = ПолучитьИмяВременногоФайла();
		Попытка
			Соединение.ОтправитьДляОбработки(ИмяФайлаЗапросаСписка, РесурсНаСервереЗапросаСписка, ФайлРезультата, ЗаголовкиHTTP);
		Исключение
			УдалитьВременныйФайл(ИмяФайлаЗапросаСписка);
			Возврат Ложь;
		КонецПопытки;
		
		ТекстовыйФайлРезультата = Новый ЧтениеТекста(ФайлРезультата, "utf-8");
		ТекстРезультата = ТекстовыйФайлРезультата.Прочитать();
		ТекстовыйФайлРезультата.Закрыть();
		УдалитьВременныйФайл(ИмяФайлаЗапросаСписка);
		УдалитьВременныйФайл(ФайлРезультата);
		
		ТекстРезультатаПослеИмениФайла = Строка(ТекстПослеПрефикса(ТекстРезультата, """FILE_FILENAME"":""" + КороткоеИмяФайлаПакета + """", , , -1));
		ТекстИдентификатора = СокрЛП(Строка(ТекстПослеПрефикса(ТекстРезультатаПослеИмениФайла, """ID"":""", """")));
		
		Если ЗначениеЗаполнено(ТекстИдентификатора) Тогда
			Идентификатор = ТекстИдентификатора;
		Иначе
			ОписаниеОшибкиСервером = ТекстОшибкиПорталаФСС(ТекстРезультата, Истина);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ОтветПолучен;
	
КонецФункции

Функция ИзвлечьЗначениеТега(ФайлОтвета, Ид)
	
	ЧтениеHTML = Новый ЧтениеHTML;
	ЧтениеHTML.ОткрытьФайл(ФайлОтвета); 
	ПостроительDOM = Новый ПостроительDOM;
	ДокументDOM = ПостроительDOM.Прочитать(ЧтениеHTML);
	
	Результат = Неопределено;
	
	УзлыСпан = ДокументDOM.ПолучитьЭлементыПоИмени("span");
	Если УзлыСпан <> Неопределено Тогда
		Для каждого Узел Из УзлыСпан Цикл
			АтрибутИд = Узел.ПолучитьАтрибут("id");
			Если АтрибутИд <> Неопределено Тогда
				Если АтрибутИд = Ид Тогда
					Результат = Узел.ТекстовоеСодержимое;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ТекстОшибкиПорталаФСС(ТекстОтвета, ИгнорироватьОтветКрасным = Ложь)
	
	Результат = ТекстПослеПрефикса(ТекстОтвета, "id=""error""");
	
	Если ЗначениеЗаполнено(Результат) Тогда
		Результат = Строка(ТекстПослеПрефикса(Результат, ">", "<"));
		Результат = СокрЛП(ТекстИзHTML(Результат));
		
	Иначе
		Если НЕ ИгнорироватьОтветКрасным Тогда
			Результат = ТекстПослеПрефикса(ТекстОтвета, "\""color:red\""");
			
			Если ЗначениеЗаполнено(Результат) Тогда
				Результат = Строка(ТекстПослеПрефикса(Результат, "\u003e", "\u003c"));
				Результат = СокрЛП(ТекстИзHTML(Результат));
				
			Иначе
				Возврат Неопределено;
			КонецЕсли;
		Иначе
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Результат) Тогда
		Результат = НСтр("ru = 'Ошибочный ответ сервера'");
	КонецЕсли;
	Возврат Результат;
	
КонецФункции

Функция УникальныйИдентификаторСессииASPNET()
	
	Результат = "";
	
	ШестнадцатеричныеСимволы = "0123456789abcdef";
	ТридцатьДваСимвола = "abcdefghijklmnopqrstuvwxyz012345";
	
	Пока СтрДлина(Результат) < 24 Цикл
		
		СтрокаУникальногоИдентификатора = Строка(Новый УникальныйИдентификатор);
		СтрокаУникальногоИдентификатора = нрег(СтрЗаменить(СтрокаУникальногоИдентификатора, "-", ""));
		
		ПредыдущаяЦифраВСтроке = Неопределено;
		Для ПозицияВСтроке = 1 По СтрДлина(СтрокаУникальногоИдентификатора) Цикл
			СимволВСтроке = Сред(СтрокаУникальногоИдентификатора, ПозицияВСтроке, 1);
			ЦифраВСтроке = Найти(ШестнадцатеричныеСимволы, СимволВСтроке);
			ЦифраВСтроке = ?(ЦифраВСтроке > 0, ЦифраВСтроке - 1, 0);
			
			Если ПредыдущаяЦифраВСтроке = Неопределено Тогда
				ПредыдущаяЦифраВСтроке = ЦифраВСтроке;
			Иначе
				ЦифраДляРезультата = ПредыдущаяЦифраВСтроке + ЦифраВСтроке;
				Результат = Результат + Сред(ТридцатьДваСимвола, ЦифраДляРезультата + 1, 1);
				Если СтрДлина(Результат) >= 24 Тогда
					Прервать;
				КонецЕсли;
				
				ПредыдущаяЦифраВСтроке = Неопределено;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Процедура ИзвлечьЭлектронноеПредставлениеИзХранилищаИПерекодировать(Владелец, ТекстВыгрузки, ИмяФайлаВыгрузки) Экспорт
	
	// получаем электронное представление
	ХранилищеВыгрузки = "";
	ИмяФайлаВыгрузки = "";

	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
						  |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ИмяФайла,
						  |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.Данные
						  |ИЗ
						  |	РегистрСведений.ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов КАК ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов
						  |ГДЕ
						  |	ХранилищеЭлектронныхПредставленийРегламентированныхОтчетов.ЭлектронноеПредставление = &ЭлектронноеПредставление");
	Запрос.УстановитьПараметр("ЭлектронноеПредставление", Владелец);
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Если Выборка.Следующий() Тогда
			ИмяФайлаВыгрузки = СокрЛП(Выборка.ИмяФайла);
			ХранилищеВыгрузки = Выборка.Данные;
		КонецЕсли;
	КонецЕсли;
	
	Если ИмяФайлаВыгрузки = "" ИЛИ ХранилищеВыгрузки = Неопределено Тогда
		ТекстСообщения = НСтр("ru = 'Не обнаружена информация для отправки!'");
		СообщитьПользователю(ТекстСообщения);
		ИмяФайлаВыгрузки = "";
		ТекстВыгрузки = "";
		Возврат;
	КонецЕсли;
	
	// пишем электронное представление в файл
	ВремФайл = ПолучитьИмяВременногоФайла();
	ХранилищеВыгрузки.Получить().Записать(ВремФайл);
	ОбъектЧтениеТекста = Новый ЧтениеТекста(ВремФайл, ?(нрег(Прав(ИмяФайлаВыгрузки, 4)) = ".xml", "windows-1251", "cp866"));
	ТекстВыгрузки = ОбъектЧтениеТекста.Прочитать();
	ОбъектЧтениеТекста.Закрыть();
	УдалитьФайлы(ВремФайл);
	
КонецПроцедуры

Процедура ПолучитьСвойстваФайлаВыгрузки(ОбъектСсылка, ТекстВыгрузки, ИмяФайлаВыгрузки, КодировкаФайлаВыгрузки = Неопределено) Экспорт
	
	СвойстваФайлаВыгрузки = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ВыгрузитьДокумент(ОбъектСсылка);
	
	Если СвойстваФайлаВыгрузки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ВремФайл = ПолучитьИмяВременногоФайла();
	ДвоичныеДанныеФайла = ПолучитьИзВременногоХранилища(СвойстваФайлаВыгрузки.АдресФайлаВыгрузки);
	ДвоичныеДанныеФайла.Записать(ВремФайл);
	ОбъектЧтениеТекста = Новый ЧтениеТекста(ВремФайл, СвойстваФайлаВыгрузки.КодировкаФайлаВыгрузки);
	
	ТекстВыгрузки = ОбъектЧтениеТекста.Прочитать();
	ОбъектЧтениеТекста.Закрыть();
	УдалитьФайлы(ВремФайл);
	
	ИмяФайлаВыгрузки = СвойстваФайлаВыгрузки.ИмяФайлаВыгрузки;
	КодировкаФайлаВыгрузки = СвойстваФайлаВыгрузки.КодировкаФайлаВыгрузки;
	
КонецПроцедуры

Функция ПоляНаСервереДляЗаписиОтправкиВФСС(ОбъектСсылка) Экспорт
	
	Возврат Новый Структура("КодОрганаФСС, ДатаНачалаПериода, ДатаОкончанияПериода, Версия",
		ОбъектСсылка.Получатель,
		ОбъектСсылка.ДатаНачала,
		ОбъектСсылка.ДатаОкончания,
		ОбъектСсылка.Версия);
	
КонецФункции

Функция ПолучитьТипВидаОтправляемогоДокументаПоСсылкеНаОбъектОтправкиДляФСС(ОбъектСсылка) Экспорт
	
	ТипЗнчОбъектСсылка = ТипЗнч(ОбъектСсылка);
	
	ВидОтправляемогоДокумента = Неопределено;
	
	Если ТипЗнчОбъектСсылка = Тип("ДокументСсылка.РегламентированныйОтчет") Тогда
		
		// ищем отчет в справочнике "ВидыОтправляемыхДокументов"
		ИсточникОтчета = ОбъектСсылка.ИсточникОтчета;	
		РезультатПоиска = Справочники.ВидыОтправляемыхДокументов.НайтиПоРеквизиту("Источник", ИсточникОтчета);
		Если РезультатПоиска = Справочники.ВидыОтправляемыхДокументов.ПустаяСсылка() Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'В справочнике ""Виды отправляемых документов"" не найден элемент с именем объекта метаданных ""%1""!'"), ИсточникОтчета));
			ВидОтправляемогоДокумента = Неопределено;
		Иначе
			ВидОтправляемогоДокумента = РезультатПоиска; 
		КонецЕсли;
		
	ИначеЕсли ТипЗнчОбъектСсылка = Тип("СправочникСсылка.ЭлектронныеПредставленияРегламентированныхОтчетов") 
		ИЛИ ТипЗнчОбъектСсылка = Тип("СправочникОбъект.ЭлектронныеПредставленияРегламентированныхОтчетов") Тогда
		
		ВидОтправляемогоДокумента = ОбъектСсылка.ВидОтчета;
		
	ИначеЕсли ТипЗнчОбъектСсылка = Тип("СправочникСсылка.ОтправкиФСС") Тогда
		
		ВидОтправляемогоДокумента = ОбъектСсылка.ВидОтчета;
		
	ИначеЕсли ДокументооборотСФССКлиентСервер.ЭтоРеестрСведенийНаВыплатуПособийФСС(ОбъектСсылка) Тогда
		
		ВидОтправляемогоДокумента = Справочники.ВидыОтправляемыхДокументов.РеестрСведенийВФСС;
		
	КонецЕсли;

	Если ВидОтправляемогоДокумента <> Неопределено Тогда
		
		Возврат ВидОтправляемогоДокумента.ТипДокумента;
		
	Иначе
		
		Возврат Неопределено;
	
	КонецЕсли;
	
КонецФункции

Функция КаталогВременныхФайловДвоичныхДанных(ОбъектДвоичныхДанных = Неопределено, УдалитьКонфликтующийФайл = Истина)
	
	Если ОбъектДвоичныхДанных = Неопределено Тогда
		Если УдалитьКонфликтующийФайл Тогда
			ОбъектДвоичныхДанных = ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьОбъектДляРаботыСДвоичнымиДанными();
			Если ОбъектДвоичныхДанных = Неопределено Тогда
				Возврат Неопределено;
			КонецЕсли;
			
			ВременныйКаталог = ОбъектДвоичныхДанных.ПолучитьКаталогВременныхФайлов();
			
			ОбъектДвоичныхДанных = Неопределено;
			
			КонфликтующийФайл = Новый Файл(ВременныйКаталог);
			Если КонфликтующийФайл.Существует() И КонфликтующийФайл.ЭтоФайл() Тогда
				УдалитьВременныйФайл(ВременныйКаталог);
			КонецЕсли;
		КонецЕсли;
		
		ОбъектДвоичныхДанных = ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьОбъектДляРаботыСДвоичнымиДанными();
		Если ОбъектДвоичныхДанных = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	
	ВременныйКаталог = ОбъектДвоичныхДанных.ПолучитьКаталогВременныхФайлов();
	РазделительПутиОС = ПолучитьРазделительПути();
	Если Прав(ВременныйКаталог, 1) <> РазделительПутиОС Тогда
		ВременныйКаталог = ВременныйКаталог + РазделительПутиОС;
	КонецЕсли;
	
	Возврат ВременныйКаталог;
	
КонецФункции

///////////////////////////////////////////////////////////////////////////////
// Функции с использованием общих модулей и дублирующие функции для организации
// вызовов общих модулей при документообороте с ФСРАР

Функция ВыгрузитьПакетДляОтправкиВФСРАРЭлектроннаяПодписьВМоделиСервиса(ПараметрыФункции) Экспорт
	
	ТекстФайлаВыгрузки = ПараметрыФункции.ТекстФайлаВыгрузки;
	ИдентификаторДокументооборота = ПараметрыФункции.Идентификатор;
	
	СертификатыПолучателей = Новый Массив;
	Для Каждого ЭлементСписка Из ПараметрыФункции.Сертификаты Цикл
		СертификатыПолучателей.Добавить(ЭлементСписка.Значение);
	КонецЦикла;
	
	ИмяФайлаВыгрузки = ПараметрыФункции.ИмяФайлаВыгрузки;
	
	// инициализируем объект для работы с двоичными данными
	ДвДанные = Неопределено;
	ВременныйКаталог = КаталогВременныхФайловДвоичныхДанных(ДвДанные);
	Если ДвДанные = Неопределено Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Ошибка при инициализации объекта для работы с двоичными данными!'"));
		Возврат Неопределено;
	КонецЕсли;
	
	//Получим имя временного файла
	ПолноеИмяФайлаВыгрузки = ВременныйКаталог + ИмяФайлаВыгрузки;
	
	Попытка
		ДвДанные.ДобавитьСтроку(ТекстФайлаВыгрузки);
		ДвДанные.Записать(ПолноеИмяФайлаВыгрузки);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ЗаписьЖурналаРегистрации(НСтр("ru = 'Электронная подпись в модели сервиса.Работа с двоичными данными'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,,, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	Попытка
		ФайлПодписи = КриптосервисВМоделиСервиса.Подписать(ИдентификаторДокументооборота, Новый ДвоичныеДанные(ПолноеИмяФайлаВыгрузки), Истина);
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось подписать файл выгрузки!'"));
		Возврат Неопределено;
	КонецПопытки;
	
	// упаковываем
	СтрокаBase64ПодписаннойВыгрузки = Base64Строка(ФайлПодписи);

	АдресАрхиваВыгрузки = ЗаписатьZipФайлПакета(СтрокаBase64ПодписаннойВыгрузки, ИмяФайлаВыгрузки + ".sig");
	Если АдресАрхиваВыгрузки = Неопределено Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось упаковать файл выгрузки!'"));
		Возврат Неопределено;
	КонецЕсли;
	
	ДанныеАрхиваВыгрузки = ПолучитьИзВременногоХранилища(АдресАрхиваВыгрузки);
	
	// шифруем
	Попытка
		ЗашифрованныеДанные = КриптосервисВМоделиСервиса.Зашифровать(ИдентификаторДокументооборота, СертификатыПолучателей, ДанныеАрхиваВыгрузки);
		ИмяФайлаЗашифрованногоПакета = ПоместитьВоВременноеХранилище(ЗашифрованныеДанные, ПараметрыФункции.Адрес);
		
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Не удалось зашифровать файл выгрузки!'"));
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат Новый Структура("ИмяФайлаЗашифрованногоПакета, ИмяФайлаВыгрузки", ИмяФайлаЗашифрованногоПакета, ПараметрыФункции.ИмяФайлаВыгрузки);
	
КонецФункции

Функция СформироватьФайлОтправкиВФСРАРССервера(КороткоеИмяФайлаВыгрузки, СхемаСдачиОтчетности, СтрокаBase64ФайлаВыгрузки, ЭтоАдреса = Истина, Адрес = Неопределено, ЗначениеCAPTCHA = "") Экспорт
	
	// формируем файл с запросами для отсылки данных.
	ДвДанные = Неопределено;
	ВременныйКаталог = КаталогВременныхФайловДвоичныхДанных(ДвДанные);
	Если ДвДанные = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ИмяФайлаОтправки = ВременныйКаталог + Строка(Новый УникальныйИдентификатор);
	
	ФедеральныйСервер = ПредопределенноеЗначение("Перечисление.СхемыСдачиОтчетностиФСРАР.ФедеральныйСервер");
	ТиповойРегиональныйИФедеральныйСерверы = ПредопределенноеЗначение("Перечисление.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы");
	МосковскийРегиональныйИФедеральныйСерверы = ПредопределенноеЗначение("Перечисление.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы");
	
	// формируем POST-данные.
	СодержимоеФайла = "--My1cV8bNdr"
	+ ?(СхемаСдачиОтчетности = ТиповойРегиональныйИФедеральныйСерверы, "",
	Символы.ВК + Символы.ПС + "Content-Disposition: form-data; name=""" + ?(СхемаСдачиОтчетности = МосковскийРегиональныйИФедеральныйСерверы, "import", "format") + """"
	+ Символы.ВК + Символы.ПС
	+ Символы.ВК + Символы.ПС + ?(СхемаСдачиОтчетности = МосковскийРегиональныйИФедеральныйСерверы, "yes", "4.20" + ?(СхемаСдачиОтчетности = ФедеральныйСервер, "", ".region"))
	+ Символы.ВК + Символы.ПС + "--My1cV8bNdr")
	+ ?(НЕ ЗначениеЗаполнено(ЗначениеCAPTCHA), "",
	Символы.ВК + Символы.ПС + "Content-Disposition: form-data; name=""vercode"""
	+ Символы.ВК + Символы.ПС
	+ Символы.ВК + Символы.ПС + ЗначениеCAPTCHA
	+ Символы.ВК + Символы.ПС + "--My1cV8bNdr")
	+ Символы.ВК + Символы.ПС + "Content-Disposition: form-data; name=""" + ?(СхемаСдачиОтчетности = ТиповойРегиональныйИФедеральныйСерверы, "fileUpload",
	?(СхемаСдачиОтчетности = МосковскийРегиональныйИФедеральныйСерверы, "file", "file_")) + """; filename=""" + КороткоеИмяФайлаВыгрузки + """"
	+ Символы.ВК + Символы.ПС + "Content-Type: application/octet-stream"
	+ Символы.ВК + Символы.ПС
	+ Символы.ВК + Символы.ПС + "*"
	+ Символы.ВК + Символы.ПС + "--My1cV8bNdr--";
	
	ДвДанные.ДобавитьСтроку(СодержимоеФайла);
	ДвДанные.Записать(ИмяФайлаОтправки);
	
	ЗаменитьМаркерВЗапросеДвоичнымиДаннымиСервер(ИмяФайлаОтправки, СтрокаBase64ФайлаВыгрузки, ЭтоАдреса, Адрес);
	
	Возврат ИмяФайлаОтправки;
	
КонецФункции

Процедура ЗаменитьМаркерВЗапросеДвоичнымиДаннымиСервер(ИмяФайлаОтправки, ИмяФайлаВыгрузки, ЭтоАдреса = Истина, Адрес = Неопределено)
	
	КодМаркера = 42;
	
	ДвДанные = ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьОбъектДляРаботыСДвоичнымиДанными();
	ДвДанные2 = ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьОбъектДляРаботыСДвоичнымиДанными();
	Если ДвДанные = Неопределено ИЛИ ДвДанные2 = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ДвДанные.Прочитать(ИмяФайлаОтправки);
	ДвДанные.ТекущаяПозиция = 0;
	
	РазмерИсходныхДанных = ДвДанные.Размер;
	
	// считываем начало из первого файла и находим маркер "*"
	Для Инд = 1 По РазмерИсходныхДанных Цикл
		ОчереднойБайт = ДвДанные.ПолучитьЧисло(1);
		Если ОчереднойБайт = КодМаркера Тогда
			Прервать;
		КонецЕсли;
		ДвДанные2.ДобавитьЧисло(ОчереднойБайт, 1);
	КонецЦикла;
	
	Если Инд = РазмерИсходныхДанных + 1 Тогда
		Возврат;
	КонецЕсли;
	
	// добавляем данные из файла
	ВременныйКаталог = КаталогВременныхФайловДвоичныхДанных(ДвДанные2);
	ИмяВременногоФайлаВыгрузки = ВременныйКаталог + Строка(Новый УникальныйИдентификатор);
	
	Если ЭтоАдреса Тогда
		ПолучитьИзВременногоХранилища(ИмяФайлаВыгрузки).Записать(ИмяВременногоФайлаВыгрузки);
	Иначе
		ФайлВыгрузки = Base64Значение(ИмяФайлаВыгрузки);
		ФайлВыгрузки.Записать(ИмяВременногоФайлаВыгрузки);
	КонецЕсли;
	ДвДанные2.ДобавитьИзФайла(ИмяВременногоФайлаВыгрузки, Истина);
	
	// дописываем окончание из первого файла
	Для Инд = ДвДанные.ТекущаяПозиция + 1 По РазмерИсходныхДанных Цикл
		ОчереднойБайт = ДвДанные.ПолучитьЧисло(1);
		ДвДанные2.ДобавитьЧисло(ОчереднойБайт, 1);
	КонецЦикла;
	
	ИмяВременногоФайлаОтправки = ВременныйКаталог + Строка(Новый УникальныйИдентификатор);
	
	// записываем в файл
	ДвДанные2.Записать(ИмяВременногоФайлаОтправки);
	Если ЭтоАдреса Тогда
		ИмяФайлаОтправки = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(ИмяВременногоФайлаОтправки), Адрес);
	Иначе
		ИмяФайлаОтправки = ДвДанные2.ПолучитьСтрокуBase64();
	КонецЕсли;
	
КонецПроцедуры

Функция СформироватьПодписанныйПакетДляМосковскогоПорталаСубъектаРФССервера(УчетнаяЗапись, ПодписываемыеДанные) Экспорт
	
	ОбъектДвоичныхДанных = Неопределено;
	ВременныйКаталог = КаталогВременныхФайловДвоичныхДанных(ОбъектДвоичныхДанных);
	Если ОбъектДвоичныхДанных = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ИмяФайлаПодписываемыхДанныхВUnicode = ВременныйКаталог + Строка(Новый УникальныйИдентификатор);
	
	Для ПозицияСимвола = 1 По СтрДлина(ПодписываемыеДанные) Цикл
		
		ОбъектДвоичныхДанных.ДобавитьСтроку(Сред(ПодписываемыеДанные, ПозицияСимвола, 1));
		ОбъектДвоичныхДанных.ДобавитьЧисло(0, 1);
		
	КонецЦикла;
	ОбъектДвоичныхДанных.Записать(ИмяФайлаПодписываемыхДанныхВUnicode);
	
	Попытка
		Подпись = КриптосервисВМоделиСервиса.Подписать(
			УчетнаяЗапись.ИдентификаторДокументооборота, Новый ДвоичныеДанные(ИмяФайлаПодписываемыхДанныхВUnicode), Истина);
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось подписать информацию для авторизации:
		|%1'"), ИнформацияОбОшибке().Описание));
		Возврат Неопределено;
	КонецПопытки;
	
	ЗакодированнаяПодпись = Base64Строка(Подпись);
	
	Возврат ЗакодированнаяПодпись;
	
КонецФункции

Функция СформироватьПодписанныйПакетДляПорталаФСРАРССервера(УчетнаяЗапись, ПодписываемыеДанные) Экспорт
	
	ОбъектДвоичныхДанных = Неопределено;
	ВременныйКаталог = КаталогВременныхФайловДвоичныхДанных(ОбъектДвоичныхДанных);
	Если ОбъектДвоичныхДанных = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ИмяФайлаПодписываемыхДанныхВUnicode = ВременныйКаталог + Строка(Новый УникальныйИдентификатор);
	
	Для ПозицияСимвола = 1 По СтрДлина(ПодписываемыеДанные) Цикл
		
		ОбъектДвоичныхДанных.ДобавитьСтроку(Сред(ПодписываемыеДанные, ПозицияСимвола, 1));
		ОбъектДвоичныхДанных.ДобавитьЧисло(0, 1);
		
	КонецЦикла;
	ОбъектДвоичныхДанных.Записать(ИмяФайлаПодписываемыхДанныхВUnicode);
	
	Попытка
		Подпись = КриптосервисВМоделиСервиса.Подписать(УчетнаяЗапись.ИдентификаторДокументооборота, Новый ДвоичныеДанные(ИмяФайлаПодписываемыхДанныхВUnicode), Истина);
	Исключение
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось подписать информацию для авторизации:
		|%1'"), ИнформацияОбОшибке().Описание));
		Возврат Неопределено;
	КонецПопытки;
	ЗакодированнаяПодпись = Base64Строка(Подпись);
	
	Возврат ЗакодированнаяПодпись;
	
КонецФункции

Функция ПолучитьСвойстваСертификатаПоОтпечаткуССервера(Отпечаток, ЛогическоеХранилище = Неопределено) Экспорт
	
	Возврат ХранилищеСертификатовВМоделиСервиса.ПолучитьСвойстваСертификатаПоОтпечатку(Отпечаток, ЛогическоеХранилище);
	
КонецФункции

Функция ПодставитьПараметрыВСтроку(Знач СтрокаПодстановки,
	Знач Параметр1, Знач Параметр2 = Неопределено, Знач Параметр3 = Неопределено,
	Знач Параметр4 = Неопределено, Знач Параметр5 = Неопределено, Знач Параметр6 = Неопределено,
	Знач Параметр7 = Неопределено, Знач Параметр8 = Неопределено, Знач Параметр9 = Неопределено)
	
	Возврат СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(СтрокаПодстановки,
		Параметр1, Параметр2, Параметр3, Параметр4, Параметр5, Параметр6, Параметр7, Параметр8, Параметр9);
		
КонецФункции

Процедура СообщитьПользователю(ТекстСообщения, СообщенияПользователю = Неопределено)
	
	Если СообщенияПользователю <> Неопределено Тогда
		СообщенияПользователю.Добавить(ТекстСообщения);
	Иначе
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
	КонецЕсли;
	
КонецПроцедуры

Функция НастройкиПроксиНаСервере()
	
	Возврат ПолучениеФайловИзИнтернета.НастройкиПроксиНаСервере();
	
КонецФункции

Функция ЗначенияРеквизитовОбъекта(Ссылка, Реквизиты)
	
	Возврат ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Ссылка, Реквизиты);
	
КонецФункции

Функция ПредставлениеВидаДокумента(Вид)
	
	Возврат РегламентированнаяОтчетность.ПредставлениеВидаДокумента(Вид);
	
КонецФункции

Функция ИННОрганизации(Организация, ЗначениеПоУмолчаниюДляИНН, ПолноеНаименованиеОрганизации = "")
	
	Если Организация <> Неопределено Тогда
		
		Если РегламентированнаяОтчетностьВызовСервера.ЭтоЮридическоеЛицо(Организация) Тогда
			СвойстваОрганизации = РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(Организация, , "НаимЮЛПол, ИННЮЛ");
			Результат = СвойстваОрганизации.ИННЮЛ;
		Иначе
			СвойстваОрганизации = РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(Организация, , "НаимЮЛПол, ИННФЛ");
			Результат = СвойстваОрганизации.ИННФЛ;
		КонецЕсли;
		
		ПолноеНаименованиеОрганизации = СвойстваОрганизации.НаимЮЛПол;
		Возврат Результат;
		
	Иначе
		Возврат ЗначениеПоУмолчаниюДляИНН;
	КонецЕсли;
	
КонецФункции

Процедура ПриИзмененииСтатусаОтправкиДокумента(Ссылка, СтатусОтправки)
	
	ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ПриИзмененииСтатусаОтправкиДокумента(Ссылка, СтатусОтправки);
	
КонецПроцедуры

//////////////////////////////////////////////////////////////////////////////////
//// ДОКУМЕНТООБОРОТ С ФСРАР, код без использования вызовов общих модулей
////

Функция ОбновитьРезультатКонкретнойОтправкиФСРАРССервера(Знач ОтправкаСсылка, Знач ОтправкаОбъектЗагружен, Знач ПодписанныйПакетДляАвторизации, Знач ПараметрыОтправки, ПараметрыСоединения, ПодписанныйРегиональнымДляОтправкиНаФедеральныйСерверПакетBase64 = Неопределено, Знач ВызовИзАвтозапроса = Ложь, ОсновныеПоляРезультатаОтправки = Неопределено) Экспорт
	
	Если ОтправкаОбъектЗагружен Тогда
		ОсновныеРеквизитыОтправки = Новый Структура("ИмяФайлаПакета, СтатусОтправки, СхемаСдачиОтчетности, СтатусОтправкиНаРегиональныйСервер, ПротоколРегиональногоСервера, ЗаверенныйРегиональнымСерверомПакет, ЗаверенныйПакетОтправлен",
			ОтправкаСсылка.ИмяФайлаПакета, ОтправкаСсылка.СтатусОтправки, ОтправкаСсылка.СхемаСдачиОтчетности, ОтправкаСсылка.СтатусОтправкиНаРегиональныйСервер, ОтправкаСсылка.ПротоколРегиональногоСервера, ОтправкаСсылка.ЗаверенныйРегиональнымСерверомПакет, ОтправкаСсылка.ЗаверенныйПакетОтправлен);
	Иначе
		ОсновныеРеквизитыОтправки = ЗначенияРеквизитовОбъекта(ОтправкаСсылка, "ИмяФайлаПакета, СтатусОтправки, СхемаСдачиОтчетности, СтатусОтправкиНаРегиональныйСервер, ПротоколРегиональногоСервера, ЗаверенныйРегиональнымСерверомПакет, ЗаверенныйПакетОтправлен");
	КонецЕсли;
	
	РезультатОтправки = ПолучитьРезультатОтправкиФСРАР(ОсновныеРеквизитыОтправки, ПодписанныйПакетДляАвторизации, ПараметрыОтправки, ПараметрыСоединения, ВызовИзАвтозапроса, ОтправкаСсылка);
	
	ПараметрыСоединения.СоединениеHTTP = Неопределено;
	
	СохранитьРезультатОтправкиФСРАР(ОтправкаСсылка, РезультатОтправки);
	
	Если (РезультатОтправки <> Неопределено И (ОсновныеРеквизитыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы
		ИЛИ ОсновныеРеквизитыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы)
		И (ОсновныеРеквизитыОтправки.СтатусОтправкиНаРегиональныйСервер = Перечисления.СтатусыОтправки.Сдан ИЛИ РезультатОтправки.СтатусОтправкиНаРегиональныйСервер = Перечисления.СтатусыОтправки.Сдан)
		И ОсновныеРеквизитыОтправки.ЗаверенныйПакетОтправлен <> Истина И РезультатОтправки.ЗаверенныйПакетОтправлен <> Истина) Тогда
		Если РезультатОтправки.ЗаверенныйРегиональнымСерверомПакет = Неопределено Тогда
			РезультатОтправки.ЗаверенныйРегиональнымСерверомПакет = ОсновныеРеквизитыОтправки.ЗаверенныйРегиональнымСерверомПакет.Получить();
		КонецЕсли;
		ПодписанныйРегиональнымДляОтправкиНаФедеральныйСерверПакетBase64 = Base64Строка(РезультатОтправки.ЗаверенныйРегиональнымСерверомПакет);
	Иначе
		ПодписанныйРегиональнымДляОтправкиНаФедеральныйСерверПакетBase64 = Неопределено;
	КонецЕсли;
	
	Если ОсновныеПоляРезультатаОтправки <> Неопределено И РезультатОтправки <> Неопределено Тогда
		ОсновныеПоляРезультатаОтправки.ДатаПолученияРезультата = РезультатОтправки.ДатаПолученияРезультата;
		ОсновныеПоляРезультатаОтправки.СтатусОтправки = РезультатОтправки.СтатусОтправки;
		ОсновныеПоляРезультатаОтправки.Протокол = РезультатОтправки.Протокол;
		ОсновныеПоляРезультатаОтправки.СтатусОтправкиНаРегиональныйСервер = РезультатОтправки.СтатусОтправкиНаРегиональныйСервер;
		ОсновныеПоляРезультатаОтправки.ЗаверенныйПакетОтправлен = РезультатОтправки.ЗаверенныйПакетОтправлен;
	КонецЕсли;
	
	Возврат (РезультатОтправки <> Неопределено);
	
КонецФункции

Функция ОтправкаПакетаПослеРегиональногоНаФедеральныйПортал(ЭтоЭлектроннаяПодписьВМоделиСервиса, Знач ОтправкаСсылка, Знач ИмяФайлаПакета, Знач ПодписанныйПакетДляАвторизации, Знач СтрокаBase64ФайлаОтправки, Знач ЭтоРегламентированныйОтчет, Знач ПараметрыОтправки, ПараметрыСоединения) Экспорт
	
	Результат = Ложь;
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	Если ЭтоЭлектроннаяПодписьВМоделиСервиса Тогда
		ДвоичныеДанныеФайлаОтправки = ПолучитьИзВременногоХранилища(СтрокаBase64ФайлаОтправки);
	Иначе
		ДвоичныеДанныеФайлаОтправки = Base64Значение(СтрокаBase64ФайлаОтправки);
	КонецЕсли;
	ИмяФайлаОтправки = ПолучитьИмяВременногоФайла();
	ДвоичныеДанныеФайлаОтправки.Записать(ИмяФайлаОтправки);
	
	ФайлыИДанныеОтправки = Новый Структура("ПодписанныйПакетДляАвторизации, КороткоеИмяФайлаПакета, ИмяФайлаОтправки, ИмяФайлаПакета", ПодписанныйПакетДляАвторизации, ИмяФайлаПакета + ".sig", ИмяФайлаОтправки, "");
	
	ТекстСообщенияПриУспехе = ОтправитьЗашифрованныйПакетНаСерверФСРАР(ФайлыИДанныеОтправки, ПараметрыОтправки, ПараметрыСоединения);
	ОтправкаПроизведена = (ТекстСообщенияПриУспехе <> Неопределено);
	
	Если ОтправкаПроизведена Тогда
		
		//отправленный файл принят сервером
		ПараметрыСоединения.ПовторятьСоединение = Ложь;
		ОтправкаОбъект = ОтправкаСсылка.ПолучитьОбъект();
		ОтправкаОбъект.ЗаверенныйПакетОтправлен = Истина;
		ОтправкаОбъект.Записать();
		
		Результат = Истина;
		
	ИначеЕсли ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) ИЛИ НЕ ПараметрыСоединения.ПовторятьСоединение Тогда
		
		Если ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) Тогда
			
			//отправленный файл не был принят сервером, получено описание ошибки
			Если Прав(ПараметрыСоединения.ОписаниеОшибкиСервером, 1) <> "." И Прав(ПараметрыСоединения.ОписаниеОшибкиСервером, 1) <> "!" Тогда
				ПараметрыСоединения.ОписаниеОшибкиСервером = ПараметрыСоединения.ОписаниеОшибкиСервером + ".";
			КонецЕсли;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Отчет не принят сервером. %1'"), ПараметрыСоединения.ОписаниеОшибкиСервером) + " " + ?(ЭтоРегламентированныйОтчет,
				НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Выгрузка"" - ""Выгрузить для портала ФСРАР"".'"), НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Еще"" - ""Выгрузить"".'"))
				+ " " + НСтр("ru = 'С информацией о порядке представления отчета ознакомьтесь на сайте http://service.fsrar.ru'"), ПараметрыСоединения.СообщенияПользователю);
			
		Иначе
			// в ответе сервера отсутствует описание ошибки и установлен признак повтора соединения
			СообщитьПользователю(НСтр("ru = 'Зашифрованный пакет не удалось отправить на сервер Росалкогольрегулирования.'") + " " + ?(ЭтоРегламентированныйОтчет,
				НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Выгрузка"" - ""Выгрузить для портала ФСРАР"".'"), НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Еще"" - ""Выгрузить"".'"))
				+ " " + НСтр("ru = 'С информацией о порядке представления отчета ознакомьтесь на сайте http://service.fsrar.ru'"), ПараметрыСоединения.СообщенияПользователю);
		КонецЕсли;
		
	КонецЕсли;
	
	ПараметрыСоединения.СоединениеHTTP = Неопределено;
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	
	Возврат Результат;
	
КонецФункции

Функция СохранитьРезультатОтправкиФСРАР(ОтправкаСсылка, РезультатОтправки)
	
	Если РезультатОтправки <> Неопределено Тогда
		ОтправкаОбъект = ОтправкаСсылка.ПолучитьОбъект();
		ОтправкаОбъект.ДатаПолученияРезультата = РезультатОтправки.ДатаПолученияРезультата;
		ОтправкаОбъект.СтатусОтправки = РезультатОтправки.СтатусОтправки;
		ОтправкаОбъект.Протокол = Новый ХранилищеЗначения(РезультатОтправки.Протокол);
		Если РезультатОтправки.СтатусОтправкиНаРегиональныйСервер <> Неопределено Тогда
			ОтправкаОбъект.СтатусОтправкиНаРегиональныйСервер = РезультатОтправки.СтатусОтправкиНаРегиональныйСервер;
			ОтправкаОбъект.ПротоколРегиональногоСервера = Новый ХранилищеЗначения(РезультатОтправки.Протокол);
		КонецЕсли;
		Если РезультатОтправки.ЗаверенныйРегиональнымСерверомПакет <> Неопределено Тогда
			ОтправкаОбъект.ЗаверенныйРегиональнымСерверомПакет = Новый ХранилищеЗначения(РезультатОтправки.ЗаверенныйРегиональнымСерверомПакет);
		КонецЕсли;
		Если РезультатОтправки.ЗаверенныйПакетОтправлен <> Неопределено Тогда
			ОтправкаОбъект.ЗаверенныйПакетОтправлен = РезультатОтправки.ЗаверенныйПакетОтправлен;
		КонецЕсли;
		ОтправкаОбъект.Записать();
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьРезультатОтправкиФСРАР(ОсновныеРеквизитыОтправки, ПодписанныйПакетДляАвторизации, ПараметрыОтправки, ПараметрыСоединения, ВызовИзАвтозапроса, ОтправкаСсылка)
	
	СтатусОтчета = "";
	ЦветСтатуса = ЦветаСтиля.ЦветНезавершившейсяОтправкиБРО;
	СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен;
	
	//запрос протокола обработки
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ПараметрыСоединения.ПовторятьЗапросПароля = Ложь;
	
	ПолучениеРезультатовОтправкиПослеРегиональногоНаФедеральномПортале = ((ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы
		ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы)
		И ОсновныеРеквизитыОтправки.ЗаверенныйПакетОтправлен = Истина);
	ПолученыРезультатыРегиональногоПередОтправкойНаФедеральныйПортал = ((ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы
		ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы)
		И НЕ ПолучениеРезультатовОтправкиПослеРегиональногоНаФедеральномПортале И ОсновныеРеквизитыОтправки.СтатусОтправкиНаРегиональныйСервер = Перечисления.СтатусыОтправки.Сдан);
	ПолучениеРезультатовОтправкиНаРегиональномПортале = ((ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы
		ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы)
		И НЕ ПолучениеРезультатовОтправкиПослеРегиональногоНаФедеральномПортале И НЕ ПолученыРезультатыРегиональногоПередОтправкойНаФедеральныйПортал);
	ФайлЗаверенногоРегиональнымСерверомПакета = Неопределено;
	НаходитсяВОчередиЗагрузки = Ложь;
	
	Если ПолучениеРезультатовОтправкиПослеРегиональногоНаФедеральномПортале Тогда
		// декларация загружена на региональный портал и на федеральный, получение протокола с федерального
		ПараметрыОтправкиНаФедеральныйПортал = Новый Структура("Организация, ФедеральныйПортал, КодРегиона, КодИНаименованиеРегиона, СсылкаНаПорталОнлайнПроверки, СхемаСдачиОтчетности, ПоляДляЗаписиОтправки",
			ПараметрыОтправки.Организация, Истина, ПараметрыОтправки.КодРегиона, ПараметрыОтправки.КодИНаименованиеРегиона, "", Перечисления.СхемыСдачиОтчетностиФСРАР.ФедеральныйСервер, Неопределено);
		ЗаголовокДекларации = ПолучитьИнформациюОДекларацииНаПорталеФСРАР(ОсновныеРеквизитыОтправки.ИмяФайлаПакета + ".sig", ПодписанныйПакетДляАвторизации, ПараметрыОтправкиНаФедеральныйПортал, ПараметрыСоединения);
		Если ЗаголовокДекларации <> Неопределено Тогда
			ЗаголовокДекларации.РегиональныйПротокол = ОсновныеРеквизитыОтправки.ПротоколРегиональногоСервера;
		КонецЕсли;
		
	ИначеЕсли ПолученыРезультатыРегиональногоПередОтправкойНаФедеральныйПортал Тогда
		// декларация загружена на региональный портал и успешно обработана, но еще не отправлялась на федеральный, возвращает протокол регионального портала в виде хранилища значения
		ЗаголовокДекларации = Новый Структура("ИдентификаторЗаписи, ИмяФайла, Состояние, ЗначениеСостояния, ДатаЗагрузки, РегиональныйПротокол, ОшибкаПолученияРегиональногоПротокола, ФедеральныйПротокол, ОшибкаПолученияФедеральногоПротокола",
			"", ОсновныеРеквизитыОтправки.ИмяФайлаПакета, "", Неопределено, Неопределено, ОсновныеРеквизитыОтправки.ПротоколРегиональногоСервера, "", Неопределено, "");
		
	ИначеЕсли ПолучениеРезультатовОтправкиНаРегиональномПортале Тогда
		// декларация загружена на региональный портал, ожидает обработки
		Если ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы Тогда
			ЗаголовокДекларации = ПолучитьИнформациюОДекларацииНаМосковскомПорталеСубъектаРФ(ОсновныеРеквизитыОтправки.ИмяФайлаПакета, ПодписанныйПакетДляАвторизации, ПараметрыОтправки, ПараметрыСоединения, НаходитсяВОчередиЗагрузки);
		Иначе
			ЗаголовокДекларации = ПолучитьИнформациюОДекларацииНаТиповомПорталеСубъектаРФ(ОсновныеРеквизитыОтправки.ИмяФайлаПакета, ПараметрыОтправки, ПараметрыСоединения);
		КонецЕсли;
		
	Иначе
		// декларация загружена на общий портал
		ЗаголовокДекларации = ПолучитьИнформациюОДекларацииНаПорталеФСРАР(ОсновныеРеквизитыОтправки.ИмяФайлаПакета, ПодписанныйПакетДляАвторизации, ПараметрыОтправки, ПараметрыСоединения);
	КонецЕсли;
	
	УспешноОбработана = ПолученыРезультатыРегиональногоПередОтправкойНаФедеральныйПортал;
	ОбработанаСОшибками = Ложь;
	ОшибкаЗапросаПодписанногоРегиональнымПорталомПакета = Ложь;
	Если ЗаголовокДекларации <> Неопределено И НЕ ПолученыРезультатыРегиональногоПередОтправкойНаФедеральныйПортал Тогда
		
		ОсновнойПротоколПуст = Неопределено;
		Если ПолучениеРезультатовОтправкиНаРегиональномПортале Тогда
			УспешноОбработанаПоОсновномуПротоколу = УспешноОбработанаДекларацияФСРАР(ЗаголовокДекларации.РегиональныйПротокол, ПараметрыОтправки.СхемаСдачиОтчетности, НаходитсяВОчередиЗагрузки, ОсновнойПротоколПуст);
		Иначе
			УспешноОбработанаПоОсновномуПротоколу = УспешноОбработанаДекларацияФСРАР(ЗаголовокДекларации.ФедеральныйПротокол, Перечисления.СхемыСдачиОтчетностиФСРАР.ФедеральныйСервер, НаходитсяВОчередиЗагрузки, ОсновнойПротоколПуст);
		КонецЕсли;
		ОбработанаСОшибкамиПоДополнительномуПротоколу = Ложь;
		Если НЕ ПараметрыОтправки.ФедеральныйПортал И НЕ ПолучениеРезультатовОтправкиПослеРегиональногоНаФедеральномПортале И НЕ ПолучениеРезультатовОтправкиНаРегиональномПортале Тогда
			УспешноОбработанаПоРегиональномуПротоколу = УспешноОбработанаДекларацияФСРАР(ЗаголовокДекларации.РегиональныйПротокол, ПараметрыОтправки.СхемаСдачиОтчетности, НаходитсяВОчередиЗагрузки);
			ОбработанаСОшибкамиПоДополнительномуПротоколу = (УспешноОбработанаПоРегиональномуПротоколу <> Неопределено И НЕ УспешноОбработанаПоРегиональномуПротоколу);
		КонецЕсли;
		
		УспешноОбработана = УспешноОбработанаПоОсновномуПротоколу <> Неопределено И УспешноОбработанаПоОсновномуПротоколу И НЕ ОбработанаСОшибкамиПоДополнительномуПротоколу;
		
		Если УспешноОбработана И ПолучениеРезультатовОтправкиНаРегиональномПортале Тогда
			
			// запрос подписанного региональным порталом пакета
			Если ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы Тогда
				ФайлЗаверенногоРегиональнымСерверомПакета = ПолучитьДекларациюПодписаннуюНаМосковскомПорталеСубъектаРФ(ЗаголовокДекларации.ИдентификаторЗаписи, ПараметрыОтправки, ПараметрыСоединения);
			Иначе
				ФайлЗаверенногоРегиональнымСерверомПакета = ПолучитьДекларациюПодписаннуюНаТиповомПорталеСубъектаРФ(ЗаголовокДекларации.ИдентификаторЗаписи, ПараметрыОтправки, ПараметрыСоединения);
			КонецЕсли;
			
			Если НЕ ЗначениеЗаполнено(ФайлЗаверенногоРегиональнымСерверомПакета) И НЕ ПараметрыСоединения.ПовторятьСоединение Тогда
				Если ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) Тогда
					СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Подписанная декларация не получена с сервера. %1'"), ПараметрыСоединения.ОписаниеОшибкиСервером), ПараметрыСоединения.СообщенияПользователю);
				Иначе
					СообщитьПользователю(НСтр("ru = 'Не удалось получить декларацию с подписью регионального сервера Росалкогольрегулирования.'"), ПараметрыСоединения.СообщенияПользователю);
				КонецЕсли;
				ПараметрыСоединения.ОписаниеОшибкиСервером = "";
				
				УспешноОбработанаПоОсновномуПротоколу = Неопределено;
				УспешноОбработана = Ложь;
				ОшибкаЗапросаПодписанногоРегиональнымПорталомПакета = Истина;
			КонецЕсли;
			
		КонецЕсли;
		
		ОбработанаСОшибками = (УспешноОбработанаПоОсновномуПротоколу <> Неопределено И НЕ УспешноОбработана) ИЛИ (ОбработанаСОшибкамиПоДополнительномуПротоколу
			И ОсновнойПротоколПуст И ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ОбщийРегиональныйИФедеральныйСервер);
		
	КонецЕсли;
	
	Если ЗаголовокДекларации <> Неопределено И НЕ ПараметрыСоединения.ПовторятьСоединение Тогда
		
		// получен протокол обработки и отсутствовали ошибки соединения, в том числе при получении подписанного региональным порталом пакета
		
		// анализируем содержимое страницы протокола обработки
		Если УспешноОбработана Тогда
			// есть ссылка на квитанцию - отчет принят
			Если ПолученыРезультатыРегиональногоПередОтправкойНаФедеральныйПортал ИЛИ ПолучениеРезультатовОтправкиНаРегиональномПортале Тогда
				СтатусОтправкиНаРегиональныйСервер = Перечисления.СтатусыОтправки.Сдан;
				СтатусОтчета = НСтр("ru = 'Сдан, ошибок не обнаружено'");
			Иначе
				СтатусОтправки = Перечисления.СтатусыОтправки.Сдан;
				СтатусОтчета = НСтр("ru = 'Сдан, ошибок не обнаружено'");
				ЦветСтатуса = ЦветаСтиля.ЦветПоложительногоПротокола;
			КонецЕсли;
			
		ИначеЕсли ОбработанаСОшибками Тогда
			// отчет не принят
			СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят;
			Если ПолучениеРезультатовОтправкиНаРегиональномПортале Тогда
				СтатусОтправкиНаРегиональныйСервер = Перечисления.СтатусыОтправки.НеПринят;
			КонецЕсли;
			Если ОшибкаЗапросаПодписанногоРегиональнымПорталомПакета Тогда
				СтатусОтчета = НСтр("ru = 'Не принят, обнаружены ошибки'");
			Иначе
				СтатусОтчета = НСтр("ru = 'Не принят, обнаружены ошибки'");
			КонецЕсли;
			ЦветСтатуса = ЦветаСтиля.ЦветОшибкиВПротоколеБРО;
			
		Иначе
			// отчет еще не обработан
			СтатусОтчета = НСтр("ru = 'Находится в обработке'");
		КонецЕсли;
		
		Протокол = ГенерироватьHTMLПротоколаОбработкиФСРАР(ЗаголовокДекларации, СтатусОтчета, ЦветСтатуса, ПараметрыОтправки.ФедеральныйПортал, ОтправкаСсылка, ОбработанаСОшибками);
		
		ЗаверенныйРегиональнымСерверомПакет = Неопределено;
		Если ЗначениеЗаполнено(ФайлЗаверенногоРегиональнымСерверомПакета) Тогда
			ЗаверенныйРегиональнымСерверомПакет = Новый ДвоичныеДанные(ФайлЗаверенногоРегиональнымСерверомПакета);
		КонецЕсли;
		
		//заполняем результирующую структуру
		Результат = Новый Структура("ДатаПолученияРезультата, СтатусОтправки, Протокол, СтатусОтправкиНаРегиональныйСервер, ЗаверенныйРегиональнымСерверомПакет, ЗаверенныйПакетОтправлен",
			ТекущаяДатаСеанса(), СтатусОтправки, Протокол, ?(ПолучениеРезультатовОтправкиНаРегиональномПортале, СтатусОтправкиНаРегиональныйСервер, Неопределено), ЗаверенныйРегиональнымСерверомПакет, Неопределено);
		
	ИначеЕсли ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) ИЛИ НЕ ПараметрыСоединения.ПовторятьСоединение Тогда
		
		Если ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) Тогда
			Если ПараметрыСоединения.ОписаниеОшибкиСервером <> НСтр("ru = 'Выполнение операции не поддерживается'") Тогда
				СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Результаты отправки не получены с сервера. %1'"), ПараметрыСоединения.ОписаниеОшибкиСервером) + ?(ВызовИзАвтозапроса, "", " " + НСтр("ru = 'Попробуйте через некоторое время использовать в отчете кнопку ""Обновить состояние отправки"".'")), ПараметрыСоединения.СообщенияПользователю);
			КонецЕсли;
		Иначе
			СообщитьПользователю(НСтр("ru = 'Не удалось получить результаты отправки с сервера Росалкогольрегулирования.'") + ?(ВызовИзАвтозапроса, "", " " + НСтр("ru = 'Возможно, сервер перегружен. Попробуйте через некоторое время использовать в отчете кнопку ""Обновить состояние отправки"".'")), ПараметрыСоединения.СообщенияПользователю);
		КонецЕсли;
		Результат = Неопределено;
		
	Иначе
		
		// возможно, проблемы с доступом в интернет
		Результат = Неопределено;
		
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ФайлЗаверенногоРегиональнымСерверомПакета) Тогда
		УдалитьВременныйФайл(ФайлЗаверенногоРегиональнымСерверомПакета);
	КонецЕсли;
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	
	Возврат Результат;
	
КонецФункции

Функция ПроверитьПередОтправкойВФСРАР(Отчет, ТекстВопроса) Экспорт
	
	ТекущаяОтправка = ПолучитьПоследнююОтправкуОтчетаВФСРАР(Отчет);
	Если ЗначениеЗаполнено(ТекущаяОтправка) Тогда
		СтатусОтправки = ТекущаяОтправка.СтатусОтправки;
		Если СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен Тогда
			ТекстВопроса = НСтр("ru = 'Отчет уже отправлен, результат отправки не получен.
									  |Вы действительно хотите отправить отчет повторно?'");
			Возврат Ложь;
		ИначеЕсли СтатусОтправки = Перечисления.СтатусыОтправки.Сдан Тогда
			ТекстВопроса = НСтр("ru = 'Отчет уже отправлен и успешно сдан.
									  |Вы действительно хотите отправить отчет повторно?'");
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

Функция ОтправкаНаСерверФСРАР(ФайлыИДанныеОтправки, ОтчетСсылка, ПараметрыОтправки, ПараметрыСоединения, Данные64CAPTCHA = "")
	
	Данные64CAPTCHA = "";
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ПараметрыСоединения.ПовторятьЗапросПароля = Ложь;
	ЗаголовокДекларации = Неопределено;
	
	Если ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы Тогда
		ОтправкаПроизведена = ОтправитьЗашифрованныйПакетНаТиповойСерверСубъектаРФ(ФайлыИДанныеОтправки, ПараметрыОтправки, ПараметрыСоединения);
		
	ИначеЕсли ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы Тогда
		ЗаголовокДекларации = ОтправитьЗашифрованныйПакетНаМосковскийСерверСубъектаРФ(ФайлыИДанныеОтправки, ПараметрыОтправки, ПараметрыСоединения);
		ОтправкаПроизведена = (ЗаголовокДекларации <> Неопределено);
		
	Иначе
		ТекстСообщенияПриУспехе = ОтправитьЗашифрованныйПакетНаСерверФСРАР(ФайлыИДанныеОтправки, ПараметрыОтправки, ПараметрыСоединения, Данные64CAPTCHA);
		ОтправкаПроизведена = (ТекстСообщенияПриУспехе <> Неопределено);
	КонецЕсли;
	
	Если ОтправкаПроизведена Тогда
		
		ПараметрыСоединения.ПовторятьСоединение = Ложь;
		
		УспешноОбработана = Неопределено;
		РегиональныйПротоколHTML = "";
		
		Если ЗаголовокДекларации <> Неопределено Тогда
			
			УспешноОбработана = УспешноОбработанаДекларацияФСРАР(ЗаголовокДекларации.РегиональныйПротокол, ПараметрыОтправки.СхемаСдачиОтчетности, Истина);
			
			Если УспешноОбработана = Ложь Тогда
				СтатусОтчета = НСтр("ru = 'Отчет не принят, обнаружены ошибки.'");
				ЦветСтатуса = Новый Цвет(255, 0, 0);
			Иначе
				СтатусОтчета = НСтр("ru = 'Отчет принят региональным сервером и будет отправлен на федеральный сервер.'");
				ЦветСтатуса = Новый Цвет(0, 0, 192);
			КонецЕсли;
			
			ОтправкаСсылка = ПолучитьПоследнююОтправкуОтчетаВФСРАР(ОтчетСсылка);
			РегиональныйПротоколHTML = ГенерироватьHTMLПротоколаОбработкиФСРАР(ЗаголовокДекларации, СтатусОтчета, ЦветСтатуса, Ложь, ОтправкаСсылка, НЕ УспешноОбработана);
			
		КонецЕсли;
		
		//отправленный файл принят сервером
		НоваяЗапись = Справочники.ОтправкиФСРАР.СоздатьЭлемент();
		НоваяЗапись.ОтчетСсылка = ОтчетСсылка;
		НоваяЗапись.ИдентификаторОтправкиНаСервере = ПараметрыСоединения.ИдентификаторОтправкиНаСервере;
		ДвоичныеДанныеПакета = Новый ДвоичныеДанные(ФайлыИДанныеОтправки.ИмяФайлаПакета);
		НоваяЗапись.ЗашифрованныйПакет = Новый ХранилищеЗначения(ДвоичныеДанныеПакета);
		НоваяЗапись.ИмяФайлаПакета = ФайлыИДанныеОтправки.КороткоеИмяФайлаПакета;
		
		Если УспешноОбработана = Ложь Тогда
			НоваяЗапись.СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят;
			НоваяЗапись.Протокол = Новый ХранилищеЗначения(РегиональныйПротоколHTML);
			
		Иначе
			НоваяЗапись.СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен;
		КонецЕсли;
		
		НоваяЗапись.ДатаОтправки = ТекущаяДатаСеанса();
		НоваяЗапись.Организация = ?(ОтчетСсылка <> Неопределено, ОтчетСсылка.Организация, Неопределено);
		НоваяЗапись.СхемаСдачиОтчетности = ПараметрыОтправки.СхемаСдачиОтчетности;
		
		Если ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы
			ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы Тогда
			
			Если УспешноОбработана = Ложь Тогда
				НоваяЗапись.СтатусОтправкиНаРегиональныйСервер = Перечисления.СтатусыОтправки.НеПринят;
			Иначе
				НоваяЗапись.СтатусОтправкиНаРегиональныйСервер = Перечисления.СтатусыОтправки.Отправлен;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(РегиональныйПротоколHTML) Тогда
				НоваяЗапись.ПротоколРегиональногоСервера = Новый ХранилищеЗначения(РегиональныйПротоколHTML);
			КонецЕсли;
			
			НоваяЗапись.ЗаверенныйПакетОтправлен = Ложь;
			
		КонецЕсли;
		
		НоваяЗапись.ДатаНачалаПериода = ПараметрыОтправки.ПоляДляЗаписиОтправки.ДатаНачалаПериода;
		НоваяЗапись.ДатаОкончанияПериода = ПараметрыОтправки.ПоляДляЗаписиОтправки.ДатаОкончанияПериода;
		
		Если ОтчетСсылка <> Неопределено И ТипЗнч(ОтчетСсылка) = Тип("ДокументСсылка.РегламентированныйОтчет") Тогда
			НоваяЗапись.ВидОтчета = Справочники.ВидыОтправляемыхДокументов.НайтиПоРеквизиту("Источник", ОтчетСсылка.ИсточникОтчета)
			
		Иначе // электронные представления
			НоваяЗапись.ВидОтчета = ?(ОтчетСсылка <> Неопределено, ОтчетСсылка.ВидОтчета, Неопределено);
		КонецЕсли;
		
		НоваяЗапись.Версия = ПараметрыОтправки.ПоляДляЗаписиОтправки.Версия;
		НоваяЗапись.ПредставлениеПериода = ПредставлениеПериода(НоваяЗапись.ДатаНачалаПериода, КонецДня(НоваяЗапись.ДатаОкончанияПериода), "ФП=Истина");
		НоваяЗапись.ПредставлениеВидаДокумента = ПредставлениеВидаДокумента(НоваяЗапись.Версия);
		НоваяЗапись.Записать();
		
		Результат = Новый Структура("НоваяОтправкаСсылка, УспешноОбработана", НоваяЗапись.Ссылка, УспешноОбработана);
		
		Возврат Результат;
		
	ИначеЕсли (ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) ИЛИ НЕ ПараметрыСоединения.ПовторятьСоединение) И (НЕ ЗначениеЗаполнено(Данные64CAPTCHA)) И (ПараметрыСоединения.ТребуетсяРегистрация <> Истина) Тогда
		
		ЭтоРегламентированныйОтчет = (ТипЗнч(ОтчетСсылка) = Тип("ДокументСсылка.РегламентированныйОтчет") ИЛИ ТипЗнч(ОтчетСсылка) = Тип("Неопределено"));
		
		Если ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) Тогда
			
			//отправленный файл не был принят сервером, получено описание ошибки
			Если Прав(ПараметрыСоединения.ОписаниеОшибкиСервером, 1) <> "." И Прав(ПараметрыСоединения.ОписаниеОшибкиСервером, 1) <> "!" Тогда
				ПараметрыСоединения.ОписаниеОшибкиСервером = ПараметрыСоединения.ОписаниеОшибкиСервером + ".";
			КонецЕсли;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Отчет не принят сервером. %1'"), ПараметрыСоединения.ОписаниеОшибкиСервером) + " " + ?(ЭтоРегламентированныйОтчет,
				НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Выгрузка"" - ""Выгрузить для портала ФСРАР"".'"), НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Еще"" - ""Выгрузить"".'"))
				+ " " + НСтр("ru = 'С информацией о порядке представления отчета ознакомьтесь на сайте http://service.fsrar.ru'"), ПараметрыСоединения.СообщенияПользователю);
			
		Иначе
			// в ответе сервера отсутствует описание ошибки и установлен признак повтора соединения
			СообщитьПользователю(НСтр("ru = 'Зашифрованный пакет не удалось отправить на сервер Росалкогольрегулирования.'") + " " + ?(ЭтоРегламентированныйОтчет,
				НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Выгрузка"" - ""Выгрузить для портала ФСРАР"".'"), НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Еще"" - ""Выгрузить"".'"))
				+ " " + НСтр("ru = 'С информацией о порядке представления отчета ознакомьтесь на сайте http://service.fsrar.ru'"), ПараметрыСоединения.СообщенияПользователю);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция ОтправитьВФСРАРССервера(ЭтоЭлектроннаяПодписьВМоделиСервиса, Знач СтрокаBase64ФайлаОтправки, Знач СтрокаBase64ФайлаПакета, Знач ПодписанныйПакетДляАвторизации, Знач КороткоеИмяФайлаПакета, Знач ОтчетСсылка, Знач ПараметрыОтправки, ПараметрыСоединения, Данные64CAPTCHA = "") Экспорт
	
	// получаем двоичные данные файлов
	Если ЭтоЭлектроннаяПодписьВМоделиСервиса Тогда
		ДвоичныеДанныеФайлаОтправки = ПолучитьИзВременногоХранилища(СтрокаBase64ФайлаОтправки);
		ДвоичныеДанныеФайлаПакета = ПолучитьИзВременногоХранилища(СтрокаBase64ФайлаПакета);
	Иначе
		ДвоичныеДанныеФайлаОтправки = Base64Значение(СтрокаBase64ФайлаОтправки);
		ДвоичныеДанныеФайлаПакета = Base64Значение(СтрокаBase64ФайлаПакета);
	КонецЕсли;
	
	// выгружаем двоичные данные в файл
	ИмяФайлаОтправки = ПолучитьИмяВременногоФайла();
	ДвоичныеДанныеФайлаОтправки.Записать(ИмяФайлаОтправки);
	
	ИмяФайлаПакета = ПолучитьИмяВременногоФайла();
	ДвоичныеДанныеФайлаПакета.Записать(ИмяФайлаПакета);
	
	ФайлыИДанныеОтправки = Новый Структура("ПодписанныйПакетДляАвторизации, КороткоеИмяФайлаПакета, ИмяФайлаОтправки, ИмяФайлаПакета", ПодписанныйПакетДляАвторизации, КороткоеИмяФайлаПакета, ИмяФайлаОтправки, ИмяФайлаПакета);
	
	Результат = ОтправкаНаСерверФСРАР(ФайлыИДанныеОтправки, ОтчетСсылка, ПараметрыОтправки, ПараметрыСоединения, Данные64CAPTCHA);
	
	ПараметрыСоединения.СоединениеHTTP = Неопределено;
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	
	УдалитьВременныйФайл(ИмяФайлаОтправки);
	УдалитьВременныйФайл(ИмяФайлаПакета);
	
	Возврат Результат;
	
КонецФункции

Функция ГенерироватьHTMLПротоколаОбработкиФСРАР(ЗаголовокДекларации, СтатусОтчета, ЦветСтатуса, ФедеральныйПортал, ОтправкаСсылка, ЕстьОшибки = Ложь)
	
	ТабДок = Новый ТабличныйДокумент;
	
	Шаблон = ПолучитьМакет("ФСРАРШаблонДляHTML");
	
	СекцияШапка = Шаблон.ПолучитьОбласть("ШапкаСЗаголовком");

	СвойстваОрганизации 			= РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(ОтправкаСсылка.Организация, ,"НаимЮЛПол, ИННЮЛ");
	ПолноеНаименованиеОрганизации 	= СвойстваОрганизации.НаимЮЛПол;
	ИННОрганизации 					= СвойстваОрганизации.ИННЮЛ;

	// Наименование протокола 
	НаименованиеПротокола = "";
	Если ЕстьОшибки Тогда
		НаименованиеПротокола = НСтр("ru = 'Протокол ошибок'");
	Иначе
		НаименованиеПротокола = НСтр("ru = 'Протокол о сдаче'");
	КонецЕсли;
	СекцияШапка.Параметры.НаименованиеПротокола = НаименованиеПротокола;
	
	СведенияПоОбъекту 	= СведенияПоОтправляемымОбъектам(ОтправкаСсылка.ОтчетСсылка);
	НаименованиеОргана 	= СведенияПоОбъекту.ПредставлениеКонтролирующегоОргана;
	НаименованиеОтчета 	= СведенияПоОбъекту.Наименование;

	СекцияШапка.Параметры.Организация 	= ПолноеНаименованиеОрганизации;
	СекцияШапка.Параметры.ИНН 			= НСтр("ru = 'ИНН '") + ИННОрганизации;
	СекцияШапка.Параметры.Получатель 	= НаименованиеОргана;
	СекцияШапка.Параметры.Отчет 		= НаименованиеОтчета;
	СекцияШапка.Параметры.Файл 			= ЗаголовокДекларации.ИмяФайла;
	СекцияШапка.Параметры.СтатусОтчета 	= СтатусОтчета;
	СекцияШапка.Области.СтатусОтчета.ЦветТекста = ЦветСтатуса;
			
	ТабДок.Вывести(СекцияШапка);
	
	
	Если НЕ ФедеральныйПортал Тогда
		
		// выводим заголовок и региональный протокол
		
		СекцияШапка = Шаблон.ПолучитьОбласть("Шапка");
		ТабДок.Вывести(СекцияШапка);
		
		Если ЗаголовокДекларации.РегиональныйПротокол <> Неопределено И ТипЗнч(ЗаголовокДекларации.РегиональныйПротокол) <> Тип("ХранилищеЗначения") Тогда
			СекцияСтрока = Шаблон.ПолучитьОбласть("Строка");
			Для Каждого СтрокаРегиональногоПротокола Из ЗаголовокДекларации.РегиональныйПротокол Цикл
				
				СекцияСтрока.Параметры.Дата = ДатаИзСтрокиРазныхФорматов(СтрокаРегиональногоПротокола.Дата);
				СекцияСтрока.Параметры.Модуль = СтрокаРегиональногоПротокола.Модуль;
				СекцияСтрока.Параметры.Сообщение = СтрокаРегиональногоПротокола.Сообщение;
				ТабДок.Вывести(СекцияСтрока);
				
			КонецЦикла;
			
		КонецЕсли;
		
		СекцияПодвал = Шаблон.ПолучитьОбласть("Подвал");
		ТабДок.Вывести(СекцияПодвал);
		
		Если ЗначениеЗаполнено(ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола) Тогда
			СекцияОписаниеОшибки = Шаблон.ПолучитьОбласть("ОписаниеОшибки");
			СекцияОписаниеОшибки.Параметры.ОписаниеОшибки = ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола;
			ТабДок.Вывести(СекцияОписаниеОшибки);
		КонецЕсли;
		
		СекцияРазделительПротоколов = Шаблон.ПолучитьОбласть("РазделительПротоколов");
		ТабДок.Вывести(СекцияРазделительПротоколов);
		
	КонецЕсли;
	
	// выводим федеральный протокол и статус
	
	СекцияШапка = Шаблон.ПолучитьОбласть("ШапкаФедеральный");
	ТабДок.Вывести(СекцияШапка);
	
	Если ЗаголовокДекларации.ФедеральныйПротокол <> Неопределено Тогда
		СекцияСтрока = Шаблон.ПолучитьОбласть("СтрокаФедеральный");
		Для Каждого СтрокаФедеральногоПротокола Из ЗаголовокДекларации.ФедеральныйПротокол Цикл
			
			СекцияСтрока.Параметры.ДатаФедеральный = ДатаИзСтрокиРазныхФорматов(СтрокаФедеральногоПротокола.Дата);
			СекцияСтрока.Параметры.МодульФедеральный = СтрокаФедеральногоПротокола.Модуль;
			СекцияСтрока.Параметры.СообщениеФедеральный = СтрокаФедеральногоПротокола.Сообщение;
			ТабДок.Вывести(СекцияСтрока);
			
		КонецЦикла;
	КонецЕсли;
	
	СекцияПодвал = Шаблон.ПолучитьОбласть("ПодвалФедеральный");
	ТабДок.Вывести(СекцияПодвал);
	
	Если ЗначениеЗаполнено(ЗаголовокДекларации.ОшибкаПолученияФедеральногоПротокола) Тогда
		СекцияОписаниеОшибки = Шаблон.ПолучитьОбласть("ОписаниеОшибкиФедеральный");
		СекцияОписаниеОшибки.Параметры.ОписаниеОшибкиФедеральный = ЗаголовокДекларации.ОшибкаПолученияФедеральногоПротокола;
		ТабДок.Вывести(СекцияОписаниеОшибки);
	КонецЕсли;

	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	ТабДок.Записать(ИмяВременногоФайла, ТипФайлаТабличногоДокумента.HTML);
	ТекстHTML = Новый ТекстовыйДокумент;
	ТекстHTML.Прочитать(ИмяВременногоФайла);
	ТекстHTML = ТекстHTML.ПолучитьТекст();
	ТекстHTML = СтрЗаменить(ТекстHTML, "МеткаРазделителяПротоколов", "<!--МеткаРазделителяПротоколов-->");
	
	// соединить сгенерированный ранее текст регионального протокола и сгенериованный сейчас текст федерального протокола
	
	Если ЗаголовокДекларации.РегиональныйПротокол <> Неопределено И ТипЗнч(ЗаголовокДекларации.РегиональныйПротокол) = Тип("ХранилищеЗначения") Тогда
		
		ТекстHTMLРегиональныйПротокол = ЗаголовокДекларации.РегиональныйПротокол.Получить();
		ТекстHTMLФедеральныйПротокол = ТекстHTML;
		ТекстHTMLФедеральныйПротокол = СтрЗаменить(ТекстHTMLФедеральныйПротокол, "CLASS=R", "CLASS=FR");
		ТекстHTMLФедеральныйПротокол = СтрЗаменить(ТекстHTMLФедеральныйПротокол, "CLASS=""R", "CLASS=""FR");
		ТекстHTMLФедеральныйПротокол = СтрЗаменить(ТекстHTMLФедеральныйПротокол, "tr.R", "tr.FR");
		ТекстHTMLФедеральныйПротокол = СтрЗаменить(ТекстHTMLФедеральныйПротокол, "td.R", "td.FR");
		
		НачалоСтилейТаблиц = Найти(ТекстHTMLФедеральныйПротокол, "tr.FR");
		КонецСтилейТаблиц = Найти(ТекстHTMLФедеральныйПротокол, "table {");
		Если КонецСтилейТаблиц = 0 Тогда
			КонецСтилейТаблиц = Найти(ТекстHTMLФедеральныйПротокол, "table{");
		КонецЕсли;
		СтилиТаблицФедеральныйПротокол = "";
		Если НачалоСтилейТаблиц > 0 И КонецСтилейТаблиц > 0 И КонецСтилейТаблиц > НачалоСтилейТаблиц Тогда
			СтилиТаблицФедеральныйПротокол = Сред(ТекстHTMLФедеральныйПротокол, НачалоСтилейТаблиц, КонецСтилейТаблиц - НачалоСтилейТаблиц);
		КонецЕсли;
		
		ПозицияОкончанияРегиональногоПротокола = Найти(ТекстHTMLРегиональныйПротокол, "<!--МеткаРазделителяПротоколов-->");
		ПозицияНачалаФедеральногоПротокола = Найти(ТекстHTMLФедеральныйПротокол, "<!--МеткаРазделителяПротоколов-->");
		Если ПозицияОкончанияРегиональногоПротокола > 0 И ПозицияНачалаФедеральногоПротокола > 0 Тогда
			
			ТекстHTML = Лев(ТекстHTMLРегиональныйПротокол, ПозицияОкончанияРегиональногоПротокола - 1)
				+ Сред(ТекстHTMLФедеральныйПротокол, ПозицияНачалаФедеральногоПротокола);
				
			Если ЗначениеЗаполнено(СтилиТаблицФедеральныйПротокол) Тогда
				НачалоСтилейТаблиц = Найти(ТекстHTMLРегиональныйПротокол, "tr.R");
				Если НачалоСтилейТаблиц > 0 Тогда
					ТекстHTML = Лев(ТекстHTML, НачалоСтилейТаблиц - 1) + СтилиТаблицФедеральныйПротокол + Сред(ТекстHTML, НачалоСтилейТаблиц);
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
			
	КонецЕсли;
	
	Возврат ТекстHTML;
	
КонецФункции

Функция ПолучитьОсновныеСвойстваПоследнейОтправкиОтчетаВФСРАР(Знач ОтчетСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ОтправкиФСРАР.Ссылка,
		|	ОтправкиФСРАР.ИдентификаторОтправкиНаСервере КАК Идентификатор,
		|	ОтправкиФСРАР.ИмяФайлаПакета КАК ИмяФайлаПакета,
		|	ОтправкиФСРАР.СтатусОтправки КАК Статус,
		|	ОтправкиФСРАР.СхемаСдачиОтчетности КАК СхемаСдачиОтчетности,
		|	ОтправкиФСРАР.СтатусОтправкиНаРегиональныйСервер КАК СтатусОтправкиНаРегиональныйСервер,
		|	ОтправкиФСРАР.ЗаверенныйПакетОтправлен КАК ЗаверенныйПакетОтправлен
		|ИЗ
		|	Справочник.ОтправкиФСРАР КАК ОтправкиФСРАР
		|ГДЕ
		|	ОтправкиФСРАР.ОтчетСсылка = &ЭтотОтчет
		|	И ОтправкиФСРАР.ПометкаУдаления = ЛОЖЬ
		|
		|УПОРЯДОЧИТЬ ПО
		|	ОтправкиФСРАР.ДатаОтправки УБЫВ";
	Запрос.Параметры.Вставить("ЭтотОтчет", ОтчетСсылка);
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьПоследнююОтправкуОтчетаВФСРАР(ОтчетСсылка) Экспорт
	
	Отправка = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ОтправкиФСРАР.Ссылка
		|ИЗ
		|	Справочник.ОтправкиФСРАР КАК ОтправкиФСРАР
		|ГДЕ
		|	ОтправкиФСРАР.ОтчетСсылка = &ЭтотОтчет
		|	И ОтправкиФСРАР.ПометкаУдаления = ЛОЖЬ
		|
		|УПОРЯДОЧИТЬ ПО
		|	ОтправкиФСРАР.ДатаОтправки УБЫВ";
	Запрос.Параметры.Вставить("ЭтотОтчет", ОтчетСсылка);
	Результат = Запрос.Выполнить();
	
	Если НЕ Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Отправка = Выборка.Ссылка;
		
	КонецЕсли;
	
	Возврат Отправка;
	
КонецФункции

Процедура ОбновитьСтатусОтправкиФСРАРОтчета(Отчет)
	
	// находим последнюю не помеченную на удаление отправку отчета
	ПоследняяОтправка = ПолучитьПоследнююОтправкуОтчетаВФСРАР(Отчет);
	
	// вычисляем значение статуса отправки (ПеречислениеСсылка.СтатусыОтправки)
	Если ЗначениеЗаполнено(ПоследняяОтправка) Тогда
		
		СтатусОтправки = ПоследняяОтправка.СтатусОтправки;
		Если СтатусОтправки = Перечисления.СтатусыОтправки.ПринятЕстьОшибки Тогда
			//введено после добавления дополнительного статуса ПринятЕстьОшибки, при котором отчет считается сданным
			СтатусОтправки = Перечисления.СтатусыОтправки.Сдан;
		КонецЕсли;
		
	Иначе
		СтатусОтправки = Неопределено;
	КонецЕсли;
	
	// сохраняем статус в базе
	ЗаписатьСтатусОтправкиФСРАРОтчета(Отчет, СтатусОтправки, ПоследняяОтправка);
	
КонецПроцедуры

Процедура ЗаписатьСтатусОтправкиФСРАРОтчета(Отчет, СтатусОтправки, ОснованиеСтатуса)
	
	Если ЗначениеЗаполнено(СтатусОтправки) Тогда
		МенЗап = РегистрыСведений.СтатусыОтправки.СоздатьМенеджерЗаписи();
		МенЗап.Объект = Отчет;
		МенЗап.Статус = СтатусОтправки;
		МенЗап.Основание = ОснованиеСтатуса;
		МенЗап.Записать(Истина);
	Иначе
		МенЗап = РегистрыСведений.СтатусыОтправки.СоздатьМенеджерЗаписи();
		МенЗап.Объект = Отчет;
		МенЗап.Прочитать();
		Если МенЗап.Выбран() Тогда
			МенЗап.Удалить();
		КонецЕсли;
	КонецЕсли;
	
	// вызываем переопределяемую процедуру отработки изменения статуса отправки
	ПриИзмененииСтатусаОтправкиДокумента(Отчет, СтатусОтправки);
	
КонецПроцедуры

Функция ПолучитьПустуюДатуЗавершенияОтправкиФСРАР() Экспорт
	
	Возврат '39991231235959';
	
КонецФункции

Процедура ПриЗаписиОтправкиФСРАР(Объект, Отказ) Экспорт
	
	Если Объект.ОтчетСсылка <> Неопределено Тогда
		// отражаем изменения в регистре статусов отправки
		ОбновитьСтатусОтправкиФСРАРОтчета(Объект.ОтчетСсылка);
		ЭлектронныйДокументооборотСКонтролирующимиОрганами.ЗаписьОбъектовРегламентированнойОтчетности(Объект.ОтчетСсылка, Отказ);
	КонецЕсли;
	
КонецПроцедуры

Функция ПоляНаСервереДляЗаписиОтправкиВФСРАР(ОбъектСсылка) Экспорт
	
	ФедеральныйПортал = (ОбъектСсылка.ВидОтчета <> Неопределено И ОбъектСсылка.ВидОтчета.ТипДокумента = Перечисления.ТипыОтправляемыхДокументов.ОтчетФСРАРОпт);
	
	Возврат Новый Структура("ДатаНачалаПериода, ДатаОкончанияПериода, Версия, ФедеральныйПортал",
		ОбъектСсылка.ДатаНачала, ОбъектСсылка.ДатаОкончания, ОбъектСсылка.Версия, ФедеральныйПортал);
	
КонецФункции

Процедура ПередЗаписьюОтправкиФСРАР(Объект, Отказ)
	
	Если НЕ ЗначениеЗаполнено(Объект.Период) Тогда
		Объект.Период = СокрЛП(Формат(Объект.ДатаОкончанияПериода, "ДФ=yyyyMMdd") + Формат('39991231' - Объект.ДатаНачалаПериода, "ДФ=yyyyMMdd"));
	КонецЕсли;
	
	Если Объект.СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен Тогда
		
		Если НЕ ЗначениеЗаполнено(Объект.ДатаЗакрытия) Тогда
			Объект.ДатаЗакрытия = ПолучитьПустуюДатуЗавершенияОтправкиФСРАР();
		КонецЕсли;
		
	Иначе
		Объект.ДатаЗакрытия = Объект.ДатаПолученияРезультата;
	КонецЕсли;
	
КонецПроцедуры

Функция СписокДопустимыхОрганизацийВОбъектахОбменаФСРАР() Экспорт
	
	Запрос = Новый Запрос;
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НастройкиОбменаФСРАР.Организация КАК Организация
	|ИЗ
	|	РегистрСведений.НастройкиОбменаФСРАР КАК НастройкиОбменаФСРАР
	|ГДЕ
	|	НастройкиОбменаФСРАР.ИспользоватьОбмен = ИСТИНА";
	
	Запрос.Текст = ТекстЗапроса;
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Организация");
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Обмен с общим региональным и федеральным сервером на площадке ФСРАР

Функция ЗарегистрироватьсяВФСРАРССервера(Знач ПодписанныйПакетДляРегистрации, Знач ПараметрыОтправки, ПараметрыСоединения, ОтправкаРегламентированногоОтчета = Неопределено) Экспорт
	
	ПараметрыСоединения.ИдентификаторОтправкиНаСервере = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	СистемнаяИнформация = Новый СистемнаяИнформация;
	Если ОбщегоНазначенияКлиентСервер.СравнитьВерсии(СистемнаяИнформация.ВерсияПриложения, "8.3.4.0") >= 0
	И ОбщегоНазначенияКлиентСервер.СравнитьВерсии(СистемнаяИнформация.ВерсияПриложения, "8.3.4.437") < 0 Тогда
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.3.4.437'"), ПараметрыСоединения.СообщенияПользователю);
		Возврат Ложь;
	КонецЕсли;
	
	Если ПараметрыОтправки.ФедеральныйПортал ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы
		ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы Тогда
		АдресСервера = "service.fsrar.ru";
	Иначе
		АдресСервера = "service.alcolicenziat.ru";
	КонецЕсли;
	
	// инициализируем настройки прокси, если они определены
	НастройкаПроксиСервера = НастройкиПроксиНаСервере();
	
	Если НастройкаПроксиСервера <> Неопределено Тогда
		Прокси = СформироватьПрокси(НастройкаПроксиСервера, "HTTPS");
	Иначе
		Прокси = Новый ИнтернетПрокси;
	КонецЕсли;
	
	// устанавливаем соединение с сервером
	СоединениеSSL = Неопределено;
	
	Попытка
		Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
	Исключение
		
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
		Возврат Ложь;
		
	КонецПопытки;
	
	Попытка
		Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(АдресСервера, , , , Прокси, , СоединениеSSL)");
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
		Возврат Ложь;
		
	КонецПопытки;
	
	// отправка данных регистрации
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "application/x-www-form-urlencoded");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаПодписанногоПакета = ПолучитьИмяВременногоФайла();
	ЗаписываемыйФайл = Новый ЗаписьТекста(ИмяФайлаПодписанногоПакета, КодировкаТекста.ANSI);
	ЗаписываемыйФайл.Записать(ПодписанныйПакетДляРегистрации);
	ЗаписываемыйФайл.Закрыть();
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаПодписанногоПакета, "/registration", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаПодписанногоПакета);
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Ложь;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, "utf-8");
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаПодписанногоПакета);
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ПараметрыСоединения.СоединениеHTTP = Неопределено;
	
	ТекстОшибки = ТекстПослеПрефикса(ТекстОтвета, "<center><b>Ошибка.<", "</center>");
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ЗаголовокОшибки = "";
		ТекстОшибки = Строка(ТекстПослеПрефикса(ТекстОшибки, "'")); // текст после завершение строки "Ошибка"
		ТекстОшибки = Строка(ТекстПослеПрефикса(ТекстОшибки, "'")); // текст с начала заголовка информации об ошибке
		ПозицияКонцаЗаголовка = Найти(ТекстОшибки, "'");
		Если ПозицияКонцаЗаголовка > 0 Тогда
			ЗаголовокОшибки = Лев(ТекстОшибки, ПозицияКонцаЗаголовка - 1);
			ЗаголовокОшибки = СтрЗаменить(ЗаголовокОшибки, "<br>", " ");
			ЗаголовокОшибки = СокрЛП(ЗаголовокОшибки);
			ТекстОшибки = Сред(ТекстОшибки, ПозицияКонцаЗаголовка + 1);
			ТекстОшибки = Строка(ТекстПослеПрефикса(ТекстОшибки, "'", "'"));  // текст описания ошибки
		КонецЕсли;
		ТекстОшибки = СтрЗаменить(ТекстОшибки, "<br>", " ");
		ТекстОшибки = СокрЛП(ТекстОшибки);
		ТекстОшибки = ЗаголовокОшибки + ?(ЗаголовокОшибки <> "" И ТекстОшибки <> "", ". ", "") + ТекстОшибки;
		
	Иначе
		ТекстОшибки = ТекстПослеПрефикса(ТекстОтвета, "<font color=""red""><b>", "</");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстИзHTML(ТекстОшибки);
		ПараметрыСоединения.ОписаниеОшибкиСервером = СокрЛП(ПараметрыСоединения.ОписаниеОшибкиСервером);
		Если НЕ ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) Тогда
			ПараметрыСоединения.ОписаниеОшибкиСервером = НСтр("ru = 'Ошибка при регистрации на портале ФСРАР.'");
		КонецЕсли;
		Если Прав(ПараметрыСоединения.ОписаниеОшибкиСервером, 1) <> "." И Прав(ПараметрыСоединения.ОписаниеОшибкиСервером, 1) <> "!" Тогда
			ПараметрыСоединения.ОписаниеОшибкиСервером = ПараметрыСоединения.ОписаниеОшибкиСервером + ".";
		КонецЕсли;
		
		СообщитьПользователю(ПараметрыСоединения.ОписаниеОшибкиСервером + ?(ОтправкаРегламентированногоОтчета = Неопределено, "", " " + ?(ОтправкаРегламентированногоОтчета = Истина,
			НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Выгрузка"" - ""Выгрузить для портала ФСРАР"".'"), НСтр("ru = 'Для выгрузки отчета в файл используйте меню ""Еще"" - ""Выгрузить"".'"))
			+ " " + НСтр("ru = 'С информацией о порядке представления отчета ознакомьтесь на сайте http://service.fsrar.ru'")), ПараметрыСоединения.СообщенияПользователю);
		
		Возврат Ложь;
		
	Иначе
		ПараметрыСоединения.ТребуетсяРегистрация = Ложь;
		Возврат Истина;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьПодписываемыеДанныеПорталаФСРАРССервера(СлучайныйКлюч, Данные64CAPTCHA, Знач ПараметрыОтправки, ПараметрыСоединения, ВызовИзОтправки = Истина, ДляРегистрации = Ложь) Экспорт
	
	Если ПараметрыОтправки.ФедеральныйПортал ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы
		ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы Тогда
		АдресСервераОнлайнПроверки = "service.fsrar.ru";
	Иначе
		АдресСервераОнлайнПроверки = "service.alcolicenziat.ru";
	КонецЕсли;
	
	СлучайныйКлюч = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	СистемнаяИнформация = Новый СистемнаяИнформация;
	Если ОбщегоНазначенияКлиентСервер.СравнитьВерсии(СистемнаяИнформация.ВерсияПриложения, "8.3.4.0") >= 0
	И ОбщегоНазначенияКлиентСервер.СравнитьВерсии(СистемнаяИнформация.ВерсияПриложения, "8.3.4.437") < 0 Тогда
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.3.4.437'"), ПараметрыСоединения.СообщенияПользователю);
		Если НЕ ВызовИзОтправки Тогда
			ПараметрыСоединения.ОписаниеОшибкиСервером = НСтр("ru = 'Выполнение операции не поддерживается'");
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;
	
	// инициализируем настройки прокси, если они определены
	НастройкаПроксиСервера = НастройкиПроксиНаСервере();
	
	Если НастройкаПроксиСервера <> Неопределено Тогда
		Прокси = СформироватьПрокси(НастройкаПроксиСервера, "HTTPS");
	Иначе
		Прокси = Новый ИнтернетПрокси;
	КонецЕсли;
	
	// устанавливаем соединение с сервером
	СоединениеSSL = Неопределено;
	
	Попытка
		Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
	Исключение
		
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
		Возврат Неопределено;
		
	КонецПопытки;
	
	Попытка
		Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(АдресСервераОнлайнПроверки, , , , Прокси, , СоединениеSSL)");
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ЗапросHTTP = Неопределено;
	
	Попытка
		Если НЕ ДляРегистрации Тогда
			Выполнить("ЗапросHTTP = Новый HTTPЗапрос(""/auth/ecplogin"", ЗаголовкиHTTP)");
		Иначе
			Выполнить("ЗапросHTTP = Новый HTTPЗапрос(""/registration"", ЗаголовкиHTTP)");
		КонецЕсли;
	Исключение
		
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
		Возврат Неопределено;
		
	КонецПопытки;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(ЗапросHTTP, ИмяФайлаОтвета);
	Исключение
		
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		Возврат Неопределено;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	НачалоСлучайногоКлюча = Найти(ТекстОтвета, "name: 'csrf'");
	Если НачалоСлучайногоКлюча = 0 Тогда
		НачалоСлучайногоКлюча = Найти(ТекстОтвета, "name: 'csrf_Vseh_pokarau)'");
	КонецЕсли;
	
	Если НачалоСлучайногоКлюча <> 0 Тогда
		
		ТекстОтветаСМетки = Прав(ТекстОтвета, СтрДлина(ТекстОтвета) - НачалоСлучайногоКлюча + 1);
		ПрефиксЗначенияСлучайногоКлюча = "value: '";
		НачалоЗначенияСлучайногоКлюча = Найти(ТекстОтветаСМетки, ПрефиксЗначенияСлучайногоКлюча);
		
		Если НачалоЗначенияСлучайногоКлюча <> 0 Тогда
			
			ТекстОтветаСМетки = Прав(ТекстОтветаСМетки, СтрДлина(ТекстОтветаСМетки) - НачалоЗначенияСлучайногоКлюча - СтрДлина(ПрефиксЗначенияСлучайногоКлюча) + 1);
			КонецЗначенияСлучайногоКлюча = Найти(ТекстОтветаСМетки, "'");
			Если КонецЗначенияСлучайногоКлюча <> 0 Тогда
				СлучайныйКлюч = Лев(ТекстОтветаСМетки, КонецЗначенияСлучайногоКлюча - 1);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Результат = СлучайныйКлюч;
	
	СсылкаCAPTCHA = "";
	НачалоCAPTCHA = Найти(ТекстОтвета, "id: 'capcha_go'");
	Если НачалоCAPTCHA <> 0 Тогда
		
		ТекстОтветаСМетки = Прав(ТекстОтвета, СтрДлина(ТекстОтвета) - НачалоCAPTCHA + 1);
		ПрефиксЗначенияCAPTCHA = "src : '";
		НачалоЗначенияCAPTCHA = Найти(ТекстОтветаСМетки, ПрефиксЗначенияCAPTCHA);
		
		Если НачалоЗначенияCAPTCHA <> 0 Тогда
			
			ТекстПараметровCAPTCHA = Лев(ТекстОтветаСМетки, НачалоЗначенияCAPTCHA - 1);
			НачалоCAPTCHAСкрыта = Найти(ТекстОтветаСМетки, "hidden: true");
			Если НачалоCAPTCHAСкрыта = 0 Тогда
				
				ТекстОтветаСМетки = Прав(ТекстОтветаСМетки, СтрДлина(ТекстОтветаСМетки) - НачалоЗначенияCAPTCHA - СтрДлина(ПрефиксЗначенияCAPTCHA) + 1);
				КонецЗначенияCAPTCHA = Найти(ТекстОтветаСМетки, "'");
				Если КонецЗначенияCAPTCHA <> 0 Тогда
					СсылкаCAPTCHA = Лев(ТекстОтветаСМетки, КонецЗначенияCAPTCHA - 1);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Результат) И ЗначениеЗаполнено(СсылкаCAPTCHA) Тогда
		Данные64CAPTCHA = ПолучитьДанные64КартинкиCAPTCHAСПорталаФСРАР(СсылкаCAPTCHA, ПараметрыСоединения);
	КонецЕсли;
	
	ПараметрыСоединения.СоединениеHTTP = Неопределено;
	
	Если НЕ ЗначениеЗаполнено(Результат) Тогда
		Если НЕ ДляРегистрации Тогда
			СообщитьПользователю(НСтр("ru = 'Ошибка формата страницы авторизации'"), ПараметрыСоединения.СообщенияПользователю);
		Иначе
			СообщитьПользователю(НСтр("ru = 'Ошибка формата страницы регистрации'"), ПараметрыСоединения.СообщенияПользователю);
		КонецЕсли;
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ОтправитьЗашифрованныйПакетНаСерверФСРАР(ФайлыИДанныеОтправки, ПараметрыОтправки, ПараметрыСоединения, Данные64CAPTCHA = "")
	
	ПараметрыСоединения.ИдентификаторОтправкиНаСервере = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	СистемнаяИнформация = Новый СистемнаяИнформация;
	Если ОбщегоНазначенияКлиентСервер.СравнитьВерсии(СистемнаяИнформация.ВерсияПриложения, "8.3.4.0") >= 0
	И ОбщегоНазначенияКлиентСервер.СравнитьВерсии(СистемнаяИнформация.ВерсияПриложения, "8.3.4.437") < 0 Тогда
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.3.4.437'"), ПараметрыСоединения.СообщенияПользователю);
		Возврат Неопределено;
	КонецЕсли;
	
	Если ПараметрыОтправки.ФедеральныйПортал ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы
		ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы Тогда
		АдресСервераОнлайнПроверки = "service.fsrar.ru";
	Иначе
		АдресСервераОнлайнПроверки = "service.alcolicenziat.ru";
	КонецЕсли;
	
	// инициализируем настройки прокси, если они определены
	НастройкаПроксиСервера = НастройкиПроксиНаСервере();
	
	Если НастройкаПроксиСервера <> Неопределено Тогда
		Прокси = СформироватьПрокси(НастройкаПроксиСервера, "HTTPS");
	Иначе
		Прокси = Новый ИнтернетПрокси;
	КонецЕсли;
	
	// устанавливаем соединение с сервером
	СоединениеSSL = Неопределено;
	
	Попытка
		Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
	Исключение
		
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
		Возврат Неопределено;
		
	КонецПопытки;
	
	Попытка
		Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(АдресСервераОнлайнПроверки, , , , Прокси, , СоединениеSSL)");
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ТекстСообщенияПриУспехе = Неопределено;
	
	Если НЕ ЗначениеЗаполнено(ФайлыИДанныеОтправки.ПодписанныйПакетДляАвторизации) ИЛИ АвторизоватьсяНаПорталеФСРАР(ФайлыИДанныеОтправки.ПодписанныйПакетДляАвторизации, ПараметрыСоединения) Тогда
		
		Если ЗначениеЗаполнено(ФайлыИДанныеОтправки.ПодписанныйПакетДляАвторизации) Тогда
			КоличествоОтправок = ПолучитьКоличествоОтправокНаПорталеФСРАР(ПараметрыСоединения);
			Если КоличествоОтправок = Неопределено Тогда
				Возврат Неопределено;
			КонецЕсли;
			
			Если КоличествоОтправок >= 6 Тогда
				Данные64CAPTCHA = ПолучитьДанные64КартинкиCAPTCHAСПорталаФСРАР("/sapcha/declar?_dc=", ПараметрыСоединения);
				Возврат Неопределено;
			КонецЕсли;
		КонецЕсли;
		
		ТекстСообщенияПриУспехе = ЗагрузитьДекларациюНаПорталФСРАР(ФайлыИДанныеОтправки.КороткоеИмяФайлаПакета, ФайлыИДанныеОтправки.ИмяФайлаОтправки, ПараметрыСоединения);
		Если ТекстСообщенияПриУспехе <> Неопределено Тогда
			ПараметрыСоединения.ИдентификаторОтправкиНаСервере = Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMddhhmmss") + ФайлыИДанныеОтправки.КороткоеИмяФайлаПакета;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ТекстСообщенияПриУспехе;
	
КонецФункции

Функция АвторизоватьсяНаПорталеФСРАР(ПодписанныйПакет, ПараметрыСоединения)
	
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "application/x-www-form-urlencoded");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаПодписанногоПакета = ПолучитьИмяВременногоФайла();
	ЗаписываемыйФайл = Новый ЗаписьТекста(ИмяФайлаПодписанногоПакета, КодировкаТекста.ANSI);
	ЗаписываемыйФайл.Записать(ПодписанныйПакет);
	ЗаписываемыйФайл.Закрыть();
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаПодписанногоПакета, "/auth/ecplogin", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаПодписанногоПакета);
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Ложь;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, "utf-8");
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	УдалитьВременныйФайл(ИмяФайлаПодписанногоПакета);
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ТекстОшибки = ТекстПослеПрефикса(ТекстОтвета, "<font color=""red""><b>", "</");
	
	Если ЗначениеЗаполнено(ТекстОшибки) Тогда
		ТекстОшибки = ТекстИзHTML(ТекстОшибки);
		Если ПараметрыСоединения.ТребуетсяРегистрация <> Неопределено И Найти(ТекстОшибки, "не зарегистрирован") > 0 Тогда
			ПараметрыСоединения.ТребуетсяРегистрация = Истина;
		Иначе
			ПараметрыСоединения.ОписаниеОшибкиСервером = СокрЛП(ТекстОшибки);
		КонецЕсли;
		Возврат Ложь;
		
	Иначе
		Возврат Истина;
	КонецЕсли;
	
КонецФункции

Функция ЗагрузитьДекларациюНаПорталФСРАР(КороткоеИмяФайлаПакета, ИмяФайлаОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	// формируем общие заголовки
	ЗаголовкиHTTP = Новый Соответствие();
	
	ЗаголовкиHTTP.Вставить("Content-Type", "multipart/form-data; boundary=My1cV8bNdr");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	// посылаем запрос
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаОтправки, "/declaring/uploaddecl", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		Возврат Неопределено;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	Если Найти(ТекстОтвета, "Application_Model_Declaration::getMessage()") > 0 Тогда
		ПараметрыСоединения.ОписаниеОшибкиСервером = "";
		ТекстСообщенияПриУспехе = "Загружена декларация " + КороткоеИмяФайлаПакета;
		
	Иначе
		ТекстСообщенияПриУспехе = "";
		ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиПорталаФСРАР(ТекстОтвета, ТекстСообщенияПриУспехе);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат ТекстСообщенияПриУспехе;
	
КонецФункции

Функция ПолучитьДанные64КартинкиCAPTCHAСПорталаФСРАР(СсылкаCAPTCHA, ПараметрыСоединения)
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ЗапросHTTP = Неопределено;
	
	Попытка
		Выполнить("ЗапросHTTP = Новый HTTPЗапрос(""" + СсылкаCAPTCHA + """, ЗаголовкиHTTP)");
	Исключение
		
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
		Возврат Неопределено;
		
	КонецПопытки;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла("jpg");
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(ЗапросHTTP, ИмяФайлаОтвета);
	Исключение
		
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		Возврат Неопределено;
		
	КонецПопытки;
	
	ДанныеCAPTCHA = Новый ДвоичныеДанные(ИмяФайлаОтвета);
	Данные64CAPTCHA = Base64Строка(ДанныеCAPTCHA);
	
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	Возврат Данные64CAPTCHA;
	
КонецФункции

Функция ПолучитьКоличествоОтправокНаПорталеФСРАР(ПараметрыСоединения)
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ЗапросHTTP = Неопределено;
	
	Попытка
		Выполнить("ЗапросHTTP = Новый HTTPЗапрос(""/declaring/getcountvercode?_dc="", ЗаголовкиHTTP)");
	Исключение
		
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
		Возврат Неопределено;
		
	КонецПопытки;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла("jpg");
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(ЗапросHTTP, ИмяФайлаОтвета);
	Исключение
		
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		Возврат Неопределено;
		
	КонецПопытки;
	
	Результат = Неопределено;
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, "windows-1251");
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	Если Найти(ТекстОтвета, """success"":true") > 0 Тогда
		
		ИмяПараметраКоличестваОтправок = """count_vercode"":";
		ПозицияПараметраКоличестваОтправок = Найти(ТекстОтвета, ИмяПараметраКоличестваОтправок);
		
		Если ПозицияПараметраКоличестваОтправок > 0 Тогда
			
			ПозицияПараметраКоличестваОтправок = ПозицияПараметраКоличестваОтправок + СтрДлина(ИмяПараметраКоличестваОтправок);
			ТекстКоличестваОтправок = Сред(ТекстОтвета, ПозицияПараметраКоличестваОтправок);
			
			ПозицияЗавершения = Найти(ТекстКоличестваОтправок, "}");
			ПозицияРазделителя = Найти(ТекстКоличестваОтправок, ",");
			Если ПозицияРазделителя = 0 ИЛИ (ПозицияЗавершения > 0 И ПозицияРазделителя > 0 И ПозицияЗавершения < ПозицияРазделителя) Тогда
				ПозицияРазделителя = ПозицияЗавершения;
			КонецЕсли;
			
			Если ПозицияРазделителя > 0 Тогда
				ТекстКоличестваОтправок = Лев(ТекстКоличестваОтправок, ПозицияРазделителя - 1);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ТекстКоличестваОтправок) Тогда
				Попытка
					Результат = Число(ТекстКоличестваОтправок);
				Исключение
				КонецПопытки;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ТекстОшибкиПорталаФСРАР(ТекстОтвета, ТекстСообщенияПриУспехе = "")
	
	ТекстСообщенияПриУспехе = "";
	
	ЗавершеноУспешно = Неопределено;
	Если Найти(ТекстОтвета, """success"":true") > 0 Тогда
		ЗавершеноУспешно = Истина;
	ИначеЕсли Найти(ТекстОтвета, """success"":false") > 0 Тогда
		ЗавершеноУспешно = Ложь;
	КонецЕсли;
	
	Если ЗавершеноУспешно <> Неопределено Тогда
		
		Позиция = 1;
		Разделитель = "";
		ОжидаемыйРазделитель = "{";
		Пока Позиция <= СтрДлина(ТекстОтвета) Цикл
			
			ИмяПараметра = СледующееЗначениеJSON(ТекстОтвета, Позиция, Разделитель);
			Если Разделитель <> ОжидаемыйРазделитель Тогда
				Прервать;
			КонецЕсли;
			
			ЗначениеПараметра = СледующееЗначениеJSON(ТекстОтвета, Позиция, Разделитель);
			Если Разделитель <> ":" Тогда
				Прервать;
			КонецЕсли;
			
			Если ИмяПараметра = "msg" ИЛИ (ИмяПараметра = "error" И НЕ ЗавершеноУспешно) Тогда
				
				ЗначениеПараметра = ТекстЗначенияJSONВШестнадцатеричнойUTF16(ЗначениеПараметра);
				ЗначениеПараметра = ТекстИзHTML(ЗначениеПараметра);
				ЗначениеПараметра = СтрЗаменить(ЗначениеПараметра, "<br>", " ");
				ЗначениеПараметра = СтрЗаменить(ЗначениеПараметра, "   ", " ");
				ЗначениеПараметра = СтрЗаменить(ЗначениеПараметра, "  ", " ");
				
				Если ЗначениеПараметра <> "" Тогда
					
					Если ЗавершеноУспешно Тогда
						ТекстСообщенияПриУспехе = ЗначениеПараметра;
						Возврат "";
					Иначе
						Возврат ЗначениеПараметра;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
			ОжидаемыйРазделитель = ",";
			
		КонецЦикла;
		
		Если ЗавершеноУспешно Тогда
			Возврат "";
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат "Ошибочный ответ сервера";
	
КонецФункции

Функция ПолучитьИнформациюОДекларацииНаПорталеФСРАР(ИмяФайлаВыгрузки, ПодписанныйПакетДляАвторизации, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	Если ПараметрыОтправки.ФедеральныйПортал ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.ТиповойРегиональныйИФедеральныйСерверы
		ИЛИ ПараметрыОтправки.СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы Тогда
		АдресСервераОнлайнПроверки = "service.fsrar.ru";
	Иначе
		АдресСервераОнлайнПроверки = "service.alcolicenziat.ru";
	КонецЕсли;
	
	Если ПараметрыСоединения.СоединениеHTTP = Неопределено Тогда
		
		СистемнаяИнформация = Новый СистемнаяИнформация;
		Если ОбщегоНазначенияКлиентСервер.СравнитьВерсии(СистемнаяИнформация.ВерсияПриложения, "8.3.4.0") >= 0
		И ОбщегоНазначенияКлиентСервер.СравнитьВерсии(СистемнаяИнформация.ВерсияПриложения, "8.3.4.437") < 0 Тогда
			СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.3.4.437'"), ПараметрыСоединения.СообщенияПользователю);
			ПараметрыСоединения.ОписаниеОшибкиСервером = НСтр("ru = 'Выполнение операции не поддерживается'");
			Возврат Неопределено;
		КонецЕсли;
		
		// инициализируем настройки прокси, если они определены
		НастройкаПроксиСервера = НастройкиПроксиНаСервере();
		
		Если НастройкаПроксиСервера <> Неопределено Тогда
			Прокси = СформироватьПрокси(НастройкаПроксиСервера, "HTTPS");
		Иначе
			Прокси = Новый ИнтернетПрокси;
		КонецЕсли;
		
		// устанавливаем соединение с сервером
		СоединениеSSL = Неопределено;
		Попытка
			Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
		Исключение
			
			СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
		Попытка
			Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(АдресСервераОнлайнПроверки, , , , Прокси, , СоединениеSSL)");
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
	КонецЕсли;
	
	АвторизацияПроизведена = (НЕ ЗначениеЗаполнено(ПодписанныйПакетДляАвторизации));
	
	Если НЕ АвторизацияПроизведена Тогда
		АвторизацияПроизведена = АвторизоватьсяНаПорталеФСРАР(ПодписанныйПакетДляАвторизации, ПараметрыСоединения);
	КонецЕсли;
	
	Если АвторизацияПроизведена Тогда
		
		ЗаголовокДекларации = НайтиЗаголовокДекларацииНаПорталеФСРАР(ИмяФайлаВыгрузки, ПараметрыСоединения);
		
		Если ЗаголовокДекларации <> Неопределено Тогда
			
			// получение регионального протокола
			
			ЗаголовокДекларации.РегиональныйПротокол = Неопределено;
			ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола = "";
			
			ОшибкаСоединенияПриПолученииПротокола = Ложь;
			ОшибкаПолученияРегиональногоПротокола = "";
			РегиональныйПротокол = Неопределено;
			
			Если НЕ ПараметрыОтправки.ФедеральныйПортал Тогда
				
				ЗаголовокДекларации.РегиональныйПротокол = ПолучитьПротоколОбработкиДекларацииНаПорталеФСРАР(ЗаголовокДекларации.ИдентификаторЗаписи, ЗаголовокДекларации.ИмяФайла, Ложь, ПараметрыСоединения);
				ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола = ПараметрыСоединения.ОписаниеОшибкиСервером;
				
				Если ЗаголовокДекларации.РегиональныйПротокол = Неопределено И НЕ ЗначениеЗаполнено(ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола) Тогда
					ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола = ?(ПараметрыСоединения.ПовторятьСоединение, НСтр("ru = 'Ошибка при обращении к серверу Росалкогольрегулирования'"), НСтр("ru = 'Не удалось получить региональный протокол'"));
				КонецЕсли;
				
				ПараметрыСоединения.ОписаниеОшибкиСервером = "";
				ПараметрыСоединения.ПовторятьСоединение = Ложь;
				
			КонецЕсли;
			
			// получение федерального протокола
			
			ОшибкаСоединенияПриПолученииПротокола = Ложь;
			ОшибкаПолученияФедеральногоПротокола = "";
			
			ЗаголовокДекларации.ФедеральныйПротокол = ПолучитьПротоколОбработкиДекларацииНаПорталеФСРАР(ЗаголовокДекларации.ИдентификаторЗаписи, ЗаголовокДекларации.ИмяФайла, Истина, ПараметрыСоединения);
			ЗаголовокДекларации.ОшибкаПолученияФедеральногоПротокола = ПараметрыСоединения.ОписаниеОшибкиСервером;
			
			Если ЗаголовокДекларации.ФедеральныйПротокол = Неопределено И НЕ ЗначениеЗаполнено(ЗаголовокДекларации.ОшибкаПолученияФедеральногоПротокола) Тогда
				ЗаголовокДекларации.ОшибкаПолученияФедеральногоПротокола = ?(ПараметрыСоединения.ПовторятьСоединение, НСтр("ru = 'Ошибка при обращении к серверу Росалкогольрегулирования'"), НСтр("ru = 'Не удалось получить федеральный протокол'"));
			КонецЕсли;
			
			ПараметрыСоединения.ОписаниеОшибкиСервером = "";
			ПараметрыСоединения.ПовторятьСоединение = Ложь;
			
			Возврат ЗаголовокДекларации;
			
		КонецЕсли;
		
	Иначе
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция НайтиЗаголовокДекларацииНаПорталеФСРАР(ИмяФайлаВыгрузки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЭлементовНаСтранице = 25;
	НомерСтраницы = 1;
	
	Пока Истина Цикл
		
		ЗаголовкиHTTP = Новый Соответствие();
		ЗаголовкиHTTP.Вставить("Content-Type", "application/x-www-form-urlencoded");
		ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
		ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
		Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
			ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
		КонецЕсли;
		
		ТекстЗапроса = "page=" + Формат(НомерСтраницы, "ЧН=0; ЧГ=") + "&start=" + Формат((НомерСтраницы - 1) * ЭлементовНаСтранице, "ЧН=0; ЧГ=")
			+ "&limit=" + Формат(ЭлементовНаСтранице, "ЧН=0; ЧГ=") + "&sort=%5B%7B%22property%22%3A%22insdate%22%2C%22direction%22%3A%22DESC%22%7D%5D";
		
		ИмяФайлаЗапроса = ПолучитьИмяВременногоФайла();
		ЗаписываемыйФайл = Новый ЗаписьТекста(ИмяФайлаЗапроса, КодировкаТекста.ANSI);
		ЗаписываемыйФайл.Записать(ТекстЗапроса);
		ЗаписываемыйФайл.Закрыть();
		
		ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
		
		Попытка
			ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаЗапроса, "/declaring/getdeclarations?_dc=", ИмяФайлаОтвета, ЗаголовкиHTTP);
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			УдалитьВременныйФайл(ИмяФайлаЗапроса);
			УдалитьВременныйФайл(ИмяФайлаОтвета);
			Возврат Неопределено;
			
		КонецПопытки;
		
		ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
		ТекстОтвета = ФайлОтвета.Прочитать();
		ФайлОтвета.Закрыть();
		
		ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
		ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
		
		УдалитьВременныйФайл(ИмяФайлаЗапроса);
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		
		// разбор списка заголовков деклараций
		ЗаголовкиДеклараций = ТаблицаJSON(ТекстОтвета, """decls"":[",
			"ИдентификаторЗаписи, ИмяФайла, СостояниеJSON, КодСостояния, ДатаЗагрузки, СтатусJSON",
			"id, filename, curr_state_Descr, curr_state, insdate, status_name");
			
		Если ЗаголовкиДеклараций = Неопределено Тогда
			
			ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиПорталаФСРАР(ТекстОтвета);
			Возврат Неопределено;
			
		КонецЕсли;
			
		Для Каждого СтрокаЗаголовковДеклараций Из ЗаголовкиДеклараций Цикл
			Если ВРег(СтрокаЗаголовковДеклараций.ИмяФайла) = ВРег(ИмяФайлаВыгрузки) Тогда
				
				СостояниеДекларации = ?(ЗначениеЗаполнено(СтрокаЗаголовковДеклараций.СостояниеJSON),
					СтрокаЗаголовковДеклараций.СостояниеJSON, СтрокаЗаголовковДеклараций.СтатусJSON);
				СостояниеДекларации = ТекстЗначенияJSONВШестнадцатеричнойUTF16(СостояниеДекларации);
				СостояниеДекларации = СокрЛП(ТекстИзHTML(СостояниеДекларации));
				
				ЗаголовокДекларации = Новый Структура("ИдентификаторЗаписи, ИмяФайла, Состояние, ЗначениеСостояния, ДатаЗагрузки, РегиональныйПротокол, ОшибкаПолученияРегиональногоПротокола, ФедеральныйПротокол, ОшибкаПолученияФедеральногоПротокола",
					СтрокаЗаголовковДеклараций.ИдентификаторЗаписи, СтрокаЗаголовковДеклараций.ИмяФайла, СостояниеДекларации,
					СтрокаЗаголовковДеклараций.КодСостояния, СтрокаЗаголовковДеклараций.ДатаЗагрузки, Неопределено, "", Неопределено, "");
				
				Возврат ЗаголовокДекларации;
				
			КонецЕсли;
		КонецЦикла;
		
		Если ЗаголовкиДеклараций.Количество() < ЭлементовНаСтранице Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		НомерСтраницы = НомерСтраницы + 1;
		
	КонецЦикла;
	
КонецФункции

Функция ПолучитьПротоколОбработкиДекларацииНаПорталеФСРАР(ИдентификаторЗаписи, ИмяФайлаВыгрузки, ФедеральныйПротокол, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "application/x-www-form-urlencoded");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ТекстЗапроса = ?(ФедеральныйПротокол, "decl_id=" + ИдентификаторЗаписи, "filename=" + ИмяФайлаВыгрузки) + "&page=1&start=0&limit=25";
	
	ИмяФайлаЗапроса = ПолучитьИмяВременногоФайла();
	ЗаписываемыйФайл = Новый ЗаписьТекста(ИмяФайлаЗапроса, КодировкаТекста.ANSI);
	ЗаписываемыйФайл.Записать(ТекстЗапроса);
	ЗаписываемыйФайл.Закрыть();
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаЗапроса, ?(ФедеральныйПротокол, "/declaring/getprotocols?_dc=", "/declaring/getregprotocols?_dc="), ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаЗапроса);
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаЗапроса);
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	// разбор протокола
	Протокол = ТаблицаJSON(ТекстОтвета, """protocols"":[",
		"Дата, Модуль, Сообщение",
		"controltime, Context, Message");
		
	Если Протокол = Неопределено Тогда
		
		ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиПорталаФСРАР(ТекстОтвета);
		Возврат Неопределено;
		
	КонецЕсли;
		
	Для Каждого СтрокаПротокола Из Протокол Цикл
		Для ИндексКолонки = 0 По Протокол.Колонки.Количество() - 1 Цикл
			
			ЗначениеКолонки = СтрокаПротокола.Получить(ИндексКолонки);
			ЗначениеКолонки = ТекстЗначенияJSONВШестнадцатеричнойUTF16(ЗначениеКолонки);
			ЗначениеКолонки = СокрЛП(ТекстИзHTML(ЗначениеКолонки));
			ЗначениеКолонки = СтрЗаменить(ЗначениеКолонки, "\r\n", " ");
			СтрокаПротокола.Установить(ИндексКолонки, ЗначениеКолонки);
			
		КонецЦикла;
	КонецЦикла;
	
	Возврат Протокол;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Обмен с типовыми региональными серверами, расположенными на площадках конкретных регионов и имеющими однотипную реализацию

Функция ОтправитьЗашифрованныйПакетНаТиповойСерверСубъектаРФ(ФайлыИДанныеОтправки, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ИдентификаторОтправкиНаСервере = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ЗагрузкаПроизведена = Ложь;
	ЭлементыСсылки = ЭлементыСсылкиНаПортал(ПараметрыОтправки.СсылкаНаПорталОнлайнПроверки, Истина);
	
	АвторизацияПроизведена = (ПараметрыСоединения.СоединениеHTTP <> Неопределено);
	
	Если НЕ АвторизацияПроизведена Тогда
		
		// очистить пароль, если в диалоге сохранения пароля не установлена галочка сохранения
		Если НЕ ПараметрыСоединения.СохранитьПароль И ЗначениеЗаполнено(ПараметрыСоединения.СохраненныйПароль) Тогда
			ЗаписатьПарольПорталаСубъектаРФ(ПараметрыОтправки.Организация, "");
			ПараметрыСоединения.СохраненныйПароль = "";
		КонецЕсли;
		
		// инициализируем настройки прокси, если они определены
		НастройкаПроксиСервера = НастройкиПроксиНаСервере();
		
		Если НастройкаПроксиСервера <> Неопределено Тогда
			Прокси = СформироватьПрокси(НастройкаПроксиСервера, ?(ЭлементыСсылки.ЗащищенноеСоединение, "HTTPS", "HTTP"));
		Иначе
			Прокси = Новый ИнтернетПрокси;
		КонецЕсли;
		
		// устанавливаем соединение с сервером
		СоединениеSSL = Неопределено;
		
		Если ЭлементыСсылки.ЗащищенноеСоединение Тогда
			
			Попытка
				Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
			Исключение
				
				СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
				Возврат Неопределено;
				
			КонецПопытки;
			
		КонецЕсли;
		
		Попытка
			Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(ЭлементыСсылки.АдресСервера, , , , Прокси" + ?(ЭлементыСсылки.ЗащищенноеСоединение, ", , СоединениеSSL", "") + ")");
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
		ПараметрыСоединения.ЗначениеCookie = "";
		АвторизацияПроизведена = АвторизоватьсяНаТиповомПорталеСубъектаРФ(ЭлементыСсылки.Страница, ПараметрыОтправки, ПараметрыСоединения);
		
	КонецЕсли;
	
	Если АвторизацияПроизведена Тогда
		
		ЗагрузкаПроизведена = ЗагрузитьДекларациюНаТиповойПорталСубъектаРФ(ЭлементыСсылки.Страница, ФайлыИДанныеОтправки.ИмяФайлаОтправки, ПараметрыСоединения);
		Если ЗагрузкаПроизведена Тогда
			ПараметрыСоединения.ИдентификаторОтправкиНаСервере = Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMddhhmmss") + ФайлыИДанныеОтправки.КороткоеИмяФайлаПакета;
		КонецЕсли;
		
	Иначе
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
	КонецЕсли;
	
	Возврат ЗагрузкаПроизведена;
	
КонецФункции

Функция АвторизоватьсяНаТиповомПорталеСубъектаРФ(Страница, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	// вход на страницу авторизации для получения первой Cookie
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ЗапросHTTP = Неопределено;
	
	Попытка
		Выполнить("ЗапросHTTP = Новый HTTPЗапрос(""" + Страница + "/Account/LogOn"", ЗаголовкиHTTP)");
	Исключение
		
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
		Возврат Ложь;
		
	КонецПопытки;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(ЗапросHTTP, ИмяФайлаОтвета);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		Возврат Ложь;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	// авторизация
	
	ИНН = ИННОрганизации(ПараметрыОтправки.Организация, ПараметрыОтправки.ИНН);
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "application/x-www-form-urlencoded");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаЗапроса = ПолучитьИмяВременногоФайла();
	ЗаписываемыйФайл = Новый ЗаписьТекста(ИмяФайлаЗапроса, КодировкаТекста.ANSI);
	ЗаписываемыйФайл.Записать("UserName=" + ИНН + "&Password=" + ПараметрыСоединения.Пароль);
	ЗаписываемыйФайл.Закрыть();
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаЗапроса, Страница + "/Account/LogOn", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаЗапроса);
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Ложь;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаЗапроса);
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиТиповогоПорталаСубъектаРФ(ТекстОтвета);
	
	ПараметрыСоединения.ПовторятьЗапросПароля = ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером);
	
	// сохранить пароль при успешной авторизации
	
	Если НЕ ПараметрыСоединения.ПовторятьЗапросПароля И ПараметрыСоединения.СохранитьПароль И ПараметрыСоединения.Пароль <> ПараметрыСоединения.СохраненныйПароль Тогда
		ЗаписатьПарольПорталаСубъектаРФ(ПараметрыОтправки.Организация, ПараметрыСоединения.Пароль);
		ПараметрыСоединения.СохраненныйПароль = ПараметрыСоединения.Пароль;
	КонецЕсли;
	
	Возврат (НЕ ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером));
	
КонецФункции

Функция ЗагрузитьДекларациюНаТиповойПорталСубъектаРФ(Страница, ИмяФайлаОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "multipart/form-data; boundary=My1cV8bNdr");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	// посылаем запрос
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаОтправки, Страница + "/UploadDecl", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		Возврат Ложь;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиТиповогоПорталаСубъектаРФ(ТекстОтвета);
	
	Возврат НЕ ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером);
	
КонецФункции

Функция ТекстОшибкиТиповогоПорталаСубъектаРФ(ТекстОтвета)
	
	ТекстОшибки = "";
	ПозицияМеткиОшибки = Найти(ТекстОтвета, "validation-summary-errors");
	
	Если ПозицияМеткиОшибки > 0 Тогда
		
		ДеталиОшибки = "";
		ТекстОтветаСМетки = Прав(ТекстОтвета, СтрДлина(ТекстОтвета) - ПозицияМеткиОшибки);
		ПозицияМеткиНачалаТекстаОшибки = Найти(ТекстОтветаСМетки, "<span>");
		ПозицияМеткиКонцаТекстаОшибки = Найти(ТекстОтветаСМетки, "</span>");
		ПозицияМеткиНачалаДеталейОшибки = Найти(ТекстОтветаСМетки, "<li>");
		ПозицияМеткиКонцаДеталейОшибки = Найти(ТекстОтветаСМетки, "</li>");
		
		Если ПозицияМеткиНачалаТекстаОшибки > 0 И ПозицияМеткиКонцаТекстаОшибки > 0 И ПозицияМеткиКонцаТекстаОшибки > ПозицияМеткиНачалаТекстаОшибки + 6 Тогда
			
			ТекстОшибки = Сред(ТекстОтветаСМетки, ПозицияМеткиНачалаТекстаОшибки + 6, ПозицияМеткиКонцаТекстаОшибки - ПозицияМеткиНачалаТекстаОшибки - 6);
			ТекстОшибки = ТекстИзHTML(СокрЛП(ТекстОшибки));
			
		КонецЕсли;
		
		Если ПозицияМеткиНачалаДеталейОшибки > 0 И ПозицияМеткиКонцаДеталейОшибки > 0 И ПозицияМеткиКонцаДеталейОшибки > ПозицияМеткиНачалаДеталейОшибки + 4 Тогда
			
			ДеталиОшибки = Сред(ТекстОтветаСМетки, ПозицияМеткиНачалаДеталейОшибки + 4, ПозицияМеткиКонцаДеталейОшибки - ПозицияМеткиНачалаДеталейОшибки - 4);
			ДеталиОшибки = ТекстИзHTML(СокрЛП(ДеталиОшибки));
			
		КонецЕсли;
		
		ТекстОшибки = ТекстОшибки + ?(ТекстОшибки <> "" ИЛИ ДеталиОшибки <> "", " ", "") + ДеталиОшибки;
		ТекстОшибки = ТекстИзUTF8(ТекстОшибки);
		
	КонецЕсли;
	
	Если ТекстОшибки = "" И Найти(ТекстОтвета, "/Account/LogOff") = 0 И (Найти(ТекстОтвета, "Object moved") = 0 ИЛИ Найти(ТекстОтвета, "/Account/LogOn") > 0) Тогда
		ТекстОшибки = "Ошибочный ответ сервера";
	КонецЕсли;
	
	Возврат ТекстОшибки;
	
КонецФункции

Функция ПолучитьИнформациюОДекларацииНаТиповомПорталеСубъектаРФ(ИмяФайлаВыгрузки, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ЭлементыСсылки = ЭлементыСсылкиНаПортал(ПараметрыОтправки.СсылкаНаПорталОнлайнПроверки, Истина);
	
	АвторизацияПроизведена = (ПараметрыСоединения.СоединениеHTTP <> Неопределено);
	
	Если НЕ АвторизацияПроизведена Тогда
		
		// очистить пароль, если в диалоге сохранения пароля не установлена галочка сохранения
		Если НЕ ПараметрыСоединения.СохранитьПароль И ЗначениеЗаполнено(ПараметрыСоединения.СохраненныйПароль) Тогда
			ЗаписатьПарольПорталаСубъектаРФ(ПараметрыОтправки.Организация, "");
			ПараметрыСоединения.СохраненныйПароль = "";
		КонецЕсли;
		
		// инициализируем настройки прокси, если они определены
		НастройкаПроксиСервера = НастройкиПроксиНаСервере();
		
		Если НастройкаПроксиСервера <> Неопределено Тогда
			Прокси = СформироватьПрокси(НастройкаПроксиСервера, ?(ЭлементыСсылки.ЗащищенноеСоединение, "HTTPS", "HTTP"));
		Иначе
			Прокси = Новый ИнтернетПрокси;
		КонецЕсли;
		
		// устанавливаем соединение с сервером
		СоединениеSSL = Неопределено;
		
		Если ЭлементыСсылки.ЗащищенноеСоединение Тогда
			
			Попытка
				Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
			Исключение
				
				СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
				Возврат Неопределено;
				
			КонецПопытки;
			
		КонецЕсли;
		
		Попытка
			Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(ЭлементыСсылки.АдресСервера, , , , Прокси" + ?(ЭлементыСсылки.ЗащищенноеСоединение, ", , СоединениеSSL", "") + ")");
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
		ПараметрыСоединения.ЗначениеCookie = "";
		АвторизацияПроизведена = АвторизоватьсяНаТиповомПорталеСубъектаРФ(ЭлементыСсылки.Страница, ПараметрыОтправки, ПараметрыСоединения);
		
	КонецЕсли;
	
	Если АвторизацияПроизведена Тогда
		
		ЗаголовокДекларации = НайтиЗаголовокДекларацииНаТиповомПорталеСубъектаРФ(ЭлементыСсылки.Страница, ИмяФайлаВыгрузки, ПараметрыСоединения);
		
		Если ЗаголовокДекларации <> Неопределено Тогда
			
			ЗаголовокДекларации.РегиональныйПротокол = ПолучитьПротоколОбработкиДекларацииНаТиповомПорталеСубъектаРФ(ЭлементыСсылки.Страница, ЗаголовокДекларации.ИдентификаторЗаписи, ПараметрыСоединения);
			ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола = ПараметрыСоединения.ОписаниеОшибкиСервером;
			
			Если ЗаголовокДекларации.РегиональныйПротокол = Неопределено И НЕ ЗначениеЗаполнено(ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола) Тогда
				ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола = ?(ПараметрыСоединения.ПовторятьСоединение, НСтр("ru = 'Ошибка при обращении к серверу Росалкогольрегулирования'"), НСтр("ru = 'Не удалось получить региональный протокол'"));
			КонецЕсли;
			
			ПараметрыСоединения.ОписаниеОшибкиСервером = "";
			ПараметрыСоединения.ПовторятьСоединение = Ложь;
			
			ЗаголовокДекларации.ФедеральныйПротокол = Неопределено;
			ЗаголовокДекларации.ОшибкаПолученияФедеральногоПротокола = "";
			
			Возврат ЗаголовокДекларации;
			
		КонецЕсли;
		
	Иначе
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция НайтиЗаголовокДекларацииНаТиповомПорталеСубъектаРФ(Страница, ИмяФайлаВыгрузки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЭлементовНаСтранице = 10;
	НомерСтраницы = 1;
	
	Пока Истина Цикл
		
		ЗаголовкиHTTP = Новый Соответствие();
		ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
		ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
		Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
			ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
		КонецЕсли;
		
		ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
		
		Попытка
			ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(Страница + "/UploadDecl/GetUploadDecl/?_search=false&rows=" + Формат(ЭлементовНаСтранице, "ЧН=0; ЧГ=")
				+ "&page=" + Формат(НомерСтраницы, "ЧН=0; ЧГ=") + "&sidx=&sord=asc", ИмяФайлаОтвета, ЗаголовкиHTTP);
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			УдалитьВременныйФайл(ИмяФайлаОтвета);
			Возврат Неопределено;
			
		КонецПопытки;
		
		ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
		ТекстОтвета = ФайлОтвета.Прочитать();
		ФайлОтвета.Закрыть();
		
		ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
		ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
		
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		
		// разбор списка заголовков деклараций
		ЗаголовкиДеклараций = ТаблицаJSON(ТекстОтвета, """rows"":[", "МассивЭлементов", "cell", "{""total"":", Истина);
			
		Если ЗаголовкиДеклараций = Неопределено Тогда
			
			ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиТиповогоПорталаСубъектаРФ(ТекстОтвета);
			Возврат Неопределено;
			
		КонецЕсли;
		
		Для Каждого СтрокаЗаголовковДеклараций Из ЗаголовкиДеклараций Цикл
			Если ТипЗнч(СтрокаЗаголовковДеклараций.МассивЭлементов) = Тип("Массив") И СтрокаЗаголовковДеклараций.МассивЭлементов.Количество() >= 6
				И ВРег(СтрокаЗаголовковДеклараций.МассивЭлементов[1]) = ВРег(ИмяФайлаВыгрузки) Тогда
				
				СостояниеДекларации = ТекстИзUTF8(СтрокаЗаголовковДеклараций.МассивЭлементов[3]);
				СостояниеДекларации = СокрЛП(ТекстИзHTML(СостояниеДекларации));
				
				ЗаголовокДекларации = Новый Структура("ИдентификаторЗаписи, ИмяФайла, Состояние, ЗначениеСостояния, ДатаЗагрузки, РегиональныйПротокол, ОшибкаПолученияРегиональногоПротокола, ФедеральныйПротокол, ОшибкаПолученияФедеральногоПротокола",
					СтрокаЗаголовковДеклараций.МассивЭлементов[0], СтрокаЗаголовковДеклараций.МассивЭлементов[1], СостояниеДекларации,
					СтрокаЗаголовковДеклараций.МассивЭлементов[4], СтрокаЗаголовковДеклараций.МассивЭлементов[2], Неопределено, "", Неопределено, "");
				
				Возврат ЗаголовокДекларации;
				
			КонецЕсли;
		КонецЦикла;
		
		Если ЗаголовкиДеклараций.Количество() < ЭлементовНаСтранице Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		НомерСтраницы = НомерСтраницы + 1;
		
	КонецЦикла;
	
КонецФункции

Функция ПолучитьПротоколОбработкиДекларацииНаТиповомПорталеСубъектаРФ(Страница, ИдентификаторЗаписи, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(Страница + "/UploadDecl/DeclDetail?q=1&id=" + ИдентификаторЗаписи +
			"&_search=false&rows=20&page=1&sidx=&sord=asc", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ЗаписиПротокола = ТаблицаJSON(ТекстОтвета, """rows"":[", "МассивЭлементов", "cell", "{""total"":", Истина);
	
	Если ЗаписиПротокола = Неопределено Тогда
		
		ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиТиповогоПорталаСубъектаРФ(ТекстОтвета);
		Возврат Неопределено;
		
	КонецЕсли;
	
	Протокол = Новый ТаблицаЗначений;
	Протокол.Колонки.Добавить("Дата");
	Протокол.Колонки.Добавить("Модуль");
	Протокол.Колонки.Добавить("Сообщение");
	
	ОбъектДвоичныхДанных = Неопределено;
	Для Каждого ЗаписьПротокола Из ЗаписиПротокола Цикл
		Если ТипЗнч(ЗаписьПротокола.МассивЭлементов) = Тип("Массив") И ЗаписьПротокола.МассивЭлементов.Количество() >= 4 Тогда
			
			ДатаЭлементаПротокола = ЗаписьПротокола.МассивЭлементов[1];
			МодульЭлементаПротокола = ТекстИзUTF8(ЗаписьПротокола.МассивЭлементов[2]);
			МодульЭлементаПротокола = СокрЛП(ТекстИзHTML(МодульЭлементаПротокола));
			СообщениеЭлементаПротокола = ТекстИзUTF8(ЗаписьПротокола.МассивЭлементов[3]);
			СообщениеЭлементаПротокола = СокрЛП(ТекстИзHTML(СообщениеЭлементаПротокола));
			
			СтрокаПротокола = Протокол.Добавить();
			СтрокаПротокола.Установить(0, ДатаЭлементаПротокола);
			СтрокаПротокола.Установить(1, МодульЭлементаПротокола);
			СтрокаПротокола.Установить(2, СообщениеЭлементаПротокола);
			
		КонецЕсли;
	КонецЦикла;
	
	Возврат Протокол;
	
КонецФункции

Функция ПолучитьДекларациюПодписаннуюНаТиповомПорталеСубъектаРФ(ИдентификаторЗаписи, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ЭлементыСсылки = ЭлементыСсылкиНаПортал(ПараметрыОтправки.СсылкаНаПорталОнлайнПроверки, Истина);
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(ЭлементыСсылки.Страница + "/UploadDecl/GetSign/" + ИдентификаторЗаписи, ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	// в случае успешного возврата файла подписанной деклараци возвращаются заголовки, например,
	// Content-Type: application/octet-stream
	// Content-Disposition: attachment; filename=R2_7800111111_002_05042013_226CAD52-8F19-4FD4-BF29-E679CB9FE5FF.xml.sig.zip.enc.sig
	// при ошибке возвращается заголовок
	// Content-Type: text/html; charset=utf-8
	// в содержимом страницы присутствует текст ошибки, например,
	// <div class="validation-summary-errors"><span>Возникли ошибки при обработке запроса.</span>
	// <ul><li>Подписаный файл отсутствует. Подписываются только принятые файлы.</li>
	
	ТипСодержимого = ОтветHTTP.Заголовки.Получить("Content-Type");
	Если нрег(СокрЛП(ТипСодержимого)) <> "application/octet-stream" Тогда
		
		ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
		ТекстОтвета = ФайлОтвета.Прочитать();
		ФайлОтвета.Закрыть();
		
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		
		ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиТиповогоПорталаСубъектаРФ(ТекстОтвета);
		Возврат Неопределено;
		
	КонецЕсли;
	
	Возврат ИмяФайлаОтвета;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Обмен с региональным сервером Москвы

Функция ПолучитьПодписываемыеДанныеМосковскогоПорталаСубъектаРФССервера(СлучайныйКлюч, Знач ПараметрыОтправки, ПараметрыСоединения) Экспорт
	
	СлучайныйКлюч = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ЭлементыСсылки = ЭлементыСсылкиНаПортал(ПараметрыОтправки.СсылкаНаПорталОнлайнПроверки, Истина);
	
	// инициализируем настройки прокси, если они определены
	НастройкаПроксиСервера = НастройкиПроксиНаСервере();
	
	Если НастройкаПроксиСервера <> Неопределено Тогда
		Прокси = СформироватьПрокси(НастройкаПроксиСервера, ?(ЭлементыСсылки.ЗащищенноеСоединение, "HTTPS", "HTTP"));
	Иначе
		Прокси = Новый ИнтернетПрокси;
	КонецЕсли;
	
	// устанавливаем соединение с сервером
	СоединениеSSL = Неопределено;
	
	Если ЭлементыСсылки.ЗащищенноеСоединение Тогда
		
		Попытка
			Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
		Исключение
			
			СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
	КонецЕсли;
	
	Попытка
		Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(ЭлементыСсылки.АдресСервера, , , , Прокси" + ?(ЭлементыСсылки.ЗащищенноеСоединение, ", , СоединениеSSL", "") + ")");
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ЗапросHTTP = Неопределено;
	
	Попытка
		Выполнить("ЗапросHTTP = Новый HTTPЗапрос(""/mosdecl/index.do"", ЗаголовкиHTTP)");
	Исключение
		
		СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
		Возврат Неопределено;
		
	КонецПопытки;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(ЗапросHTTP, ИмяФайлаОтвета);
	Исключение
		
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		Возврат Неопределено;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ПараметрыСоединения.СоединениеHTTP = Неопределено;
	
	ПрефиксСлучайногоКлюча = "name=j_rndKey value=""";
	НачалоСлучайногоКлюча = Найти(ТекстОтвета, ПрефиксСлучайногоКлюча);
	
	Если НачалоСлучайногоКлюча > 0 Тогда
		
		НачалоСлучайногоКлюча = НачалоСлучайногоКлюча + СтрДлина(ПрефиксСлучайногоКлюча);
		ТекстОтветаСМетки = Прав(ТекстОтвета, СтрДлина(ТекстОтвета) - НачалоСлучайногоКлюча + 1);
		КонецСлучайногоКлюча = Найти(ТекстОтветаСМетки, """");
		СлучайныйКлюч = Лев(ТекстОтветаСМетки, КонецСлучайногоКлюча - 1);
		
	КонецЕсли;
	
	ИНН = ИННОрганизации(ПараметрыОтправки.Организация, ПараметрыОтправки.ИНН);
	
	Возврат ИНН;
	
КонецФункции

Функция ОтправитьЗашифрованныйПакетНаМосковскийСерверСубъектаРФ(ФайлыИДанныеОтправки, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ИдентификаторОтправкиНаСервере = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ЗаголовокДекларации = Неопределено;
	ЭлементыСсылки = ЭлементыСсылкиНаПортал(ПараметрыОтправки.СсылкаНаПорталОнлайнПроверки, Истина);
	
	АвторизацияПроизведена = (ПараметрыСоединения.СоединениеHTTP <> Неопределено);
	
	Если НЕ АвторизацияПроизведена Тогда
		
		// инициализируем настройки прокси, если они определены
		НастройкаПроксиСервера = НастройкиПроксиНаСервере();
		
		Если НастройкаПроксиСервера <> Неопределено Тогда
			Прокси = СформироватьПрокси(НастройкаПроксиСервера, ?(ЭлементыСсылки.ЗащищенноеСоединение, "HTTPS", "HTTP"));
		Иначе
			Прокси = Новый ИнтернетПрокси;
		КонецЕсли;
		
		// устанавливаем соединение с сервером
		СоединениеSSL = Неопределено;
		
		Если ЭлементыСсылки.ЗащищенноеСоединение Тогда
			Попытка
				Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
			Исключение
				
				СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
				Возврат Неопределено;
				
			КонецПопытки;
		КонецЕсли;
		
		Попытка
			Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(ЭлементыСсылки.АдресСервера, , , , Прокси" + ?(ЭлементыСсылки.ЗащищенноеСоединение, ", , СоединениеSSL", "") + ")");
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
		АвторизацияПроизведена = АвторизоватьсяНаМосковскомПорталеСубъектаРФ(ЭлементыСсылки.Страница, ФайлыИДанныеОтправки.ПодписанныйПакетДляАвторизации, ПараметрыСоединения);
		
	КонецЕсли;
	
	Если АвторизацияПроизведена Тогда
		
		ЗаголовокДекларации = ЗагрузитьДекларациюНаМосковскийПорталСубъектаРФ(ЭлементыСсылки.Страница, ФайлыИДанныеОтправки.КороткоеИмяФайлаПакета, ФайлыИДанныеОтправки.ИмяФайлаОтправки, ПараметрыСоединения);
		Если ЗаголовокДекларации <> Неопределено Тогда
			ПараметрыСоединения.ИдентификаторОтправкиНаСервере = Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMddhhmmss") + ФайлыИДанныеОтправки.КороткоеИмяФайлаПакета;
		КонецЕсли;
		
	Иначе
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
	КонецЕсли;
	
	Возврат ЗаголовокДекларации;
	
КонецФункции

Функция АвторизоватьсяНаМосковскомПорталеСубъектаРФ(Страница, ПодписанныйПакет, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "application/x-www-form-urlencoded");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаЗапроса = ПолучитьИмяВременногоФайла();
	ЗаписываемыйФайл = Новый ЗаписьТекста(ИмяФайлаЗапроса, КодировкаТекста.ANSI);
	ЗаписываемыйФайл.Записать(ПодписанныйПакет);
	ЗаписываемыйФайл.Закрыть();
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаЗапроса, Страница + "/mosdecl/j_security_check.do", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаЗапроса);
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Ложь;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаЗапроса);
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	Если НЕ ЗначениеЗаполнено(ТекстОтвета) Тогда
		ПараметрыСоединения.ОписаниеОшибкиСервером = НСтр("ru = 'Ошибка при авторизации на региональном сервере.'");
	КонецЕсли;
	
	Возврат (НЕ ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером));
	
КонецФункции

Функция ЗагрузитьДекларациюНаМосковскийПорталСубъектаРФ(Страница, КороткоеИмяФайлаПакета, ИмяФайлаОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "multipart/form-data; boundary=My1cV8bNdr");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	// посылаем запрос
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаОтправки, Страница + "/mosdecl/declaration_import.do", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		Возврат Ложь;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	РегиональныйПротокол = Новый ТаблицаЗначений;
	РегиональныйПротокол.Колонки.Добавить("Дата");
	РегиональныйПротокол.Колонки.Добавить("Модуль");
	РегиональныйПротокол.Колонки.Добавить("Сообщение");
	
	НачалоЗаписиНайдено = Ложь;
	ЗаписьПротокола = "";
	ТекущаяСтрока = ФайлОтвета.ПрочитатьСтроку();
	
	Пока ТекущаяСтрока <> Неопределено Цикл
		
		Если НЕ НачалоЗаписиНайдено Тогда
			
			ПозицияНачалаЗаписи = Найти(ТекущаяСтрока, "<td class=""tdLogInfo"">");
			
			Если ПозицияНачалаЗаписи > 0 Тогда
				ПозицияНачалаЗаписи = ПозицияНачалаЗаписи + 22;
			Иначе
				
				ПозицияНачалаЗаписи = Найти(ТекущаяСтрока, "<td class=""tdLogWarn"">");
				
				Если ПозицияНачалаЗаписи > 0 Тогда
					ПозицияНачалаЗаписи = ПозицияНачалаЗаписи + 22;
				Иначе
					
					ПозицияНачалаЗаписи = Найти(ТекущаяСтрока, "<td class=""tdLogError"">");
					
					Если ПозицияНачалаЗаписи > 0 Тогда
						ПозицияНачалаЗаписи = ПозицияНачалаЗаписи + 23;
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
			Если ПозицияНачалаЗаписи > 0 Тогда
				
				ТекущаяСтрока = Сред(ТекущаяСтрока, ПозицияНачалаЗаписи);
				НачалоЗаписиНайдено = Истина;
				ЗаписьПротокола = "";
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если НачалоЗаписиНайдено Тогда
			
			КонецЗаписи = Найти(ТекущаяСтрока, "</td>");
			
			Если КонецЗаписи > 0 Тогда
				ТекущаяСтрока = Лев(ТекущаяСтрока, КонецЗаписи - 1);
			КонецЕсли;
			
			ТекущаяСтрокаЗаписиПротокола = СокрЛП(ТекстИзHTML(ТекущаяСтрока));
			
			ЗаписьПротокола = ЗаписьПротокола + ?(ЗначениеЗаполнено(ЗаписьПротокола) И ЗначениеЗаполнено(ТекущаяСтрокаЗаписиПротокола), " ", "") + ТекущаяСтрокаЗаписиПротокола;
			
			Если КонецЗаписи Тогда
				
				СтрокаПротокола = РегиональныйПротокол.Добавить();
				СтрокаПротокола.Дата = Строка(ТекущаяДатаСеанса());
				СтрокаПротокола.Модуль = НСтр("ru = 'Загрузка файла'");
				СтрокаПротокола.Сообщение = ЗаписьПротокола;
				
				НачалоЗаписиНайдено = Ложь;
				
			КонецЕсли;
			
		КонецЕсли;
		
		ТекущаяСтрока = ФайлОтвета.ПрочитатьСтроку();
		
	КонецЦикла;
	
	ФайлОтвета.Закрыть();
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	Если РегиональныйПротокол.Количество() = 0 Тогда
		
		ПараметрыСоединения.ОписаниеОшибкиСервером = НСтр("ru = 'Ошибочный ответ сервера'");
		Возврат Неопределено;
		
	КонецЕсли;
	
	ФедеральныйПротокол = Новый ТаблицаЗначений;
	ФедеральныйПротокол.Колонки.Добавить("Дата");
	ФедеральныйПротокол.Колонки.Добавить("Модуль");
	ФедеральныйПротокол.Колонки.Добавить("Сообщение");
	
	Результат = Новый Структура("ИдентификаторЗаписи, ИмяФайла, Состояние, ЗначениеСостояния, ДатаЗагрузки, РегиональныйПротокол, ОшибкаПолученияРегиональногоПротокола, ФедеральныйПротокол, ОшибкаПолученияФедеральногоПротокола",
		"", КороткоеИмяФайлаПакета, "", "", Строка(ТекущаяДатаСеанса()), РегиональныйПротокол, "", ФедеральныйПротокол, "");
	
	Возврат Результат;
	
КонецФункции

Функция ПолучитьИнформациюОДекларацииНаМосковскомПорталеСубъектаРФ(ИмяФайлаВыгрузки, ПодписанныйПакетДляАвторизации, ПараметрыОтправки, ПараметрыСоединения, НаходитсяВОчередиЗагрузки)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ЭлементыСсылки = ЭлементыСсылкиНаПортал(ПараметрыОтправки.СсылкаНаПорталОнлайнПроверки, Истина);
	
	Если ПараметрыСоединения.СоединениеHTTP = Неопределено Тогда
		
		// инициализируем настройки прокси, если они определены
		НастройкаПроксиСервера = НастройкиПроксиНаСервере();
		
		Если НастройкаПроксиСервера <> Неопределено Тогда
			Прокси = СформироватьПрокси(НастройкаПроксиСервера, ?(ЭлементыСсылки.ЗащищенноеСоединение, "HTTPS", "HTTP"));
		Иначе
			Прокси = Новый ИнтернетПрокси;
		КонецЕсли;
		
		// устанавливаем соединение с сервером
		СоединениеSSL = Неопределено;
		
		Если ЭлементыСсылки.ЗащищенноеСоединение Тогда
			
			Попытка
				Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
			Исключение
				
				СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
				Возврат Неопределено;
				
			КонецПопытки;
			
		КонецЕсли;
		
		Попытка
			Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(ЭлементыСсылки.АдресСервера, , , , Прокси" + ?(ЭлементыСсылки.ЗащищенноеСоединение, ", , СоединениеSSL", "") + ")");
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
	КонецЕсли;
	
	АвторизацияПроизведена = (НЕ ЗначениеЗаполнено(ПодписанныйПакетДляАвторизации));
	
	Если НЕ АвторизацияПроизведена Тогда
		
		ПараметрыСоединения.ЗначениеCookie = "";
		АвторизацияПроизведена = АвторизоватьсяНаМосковскомПорталеСубъектаРФ(ЭлементыСсылки.Страница, ПодписанныйПакетДляАвторизации, ПараметрыСоединения);
		
	КонецЕсли;
	
	Если АвторизацияПроизведена Тогда
		
		ЗаголовокДекларации = НайтиЗаголовокДекларацииНаМосковскомПорталеСубъектаРФ(ЭлементыСсылки.Страница, ИмяФайлаВыгрузки, ПараметрыСоединения);
		
		Если ЗаголовокДекларации <> Неопределено Тогда
			
			НаходитсяВОчередиЗагрузки = (Строка(ЗаголовокДекларации.ЗначениеСостояния) = "-1");
			ЗаголовокДекларации.РегиональныйПротокол = ПолучитьПротоколОбработкиДекларацииНаМосковскомПорталеСубъектаРФ(ЭлементыСсылки.Страница, ЗаголовокДекларации.ИдентификаторЗаписи, ПараметрыСоединения, НаходитсяВОчередиЗагрузки);
			ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола = ПараметрыСоединения.ОписаниеОшибкиСервером;
			
			Если ЗаголовокДекларации.РегиональныйПротокол = Неопределено И НЕ ЗначениеЗаполнено(ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола) Тогда
				ЗаголовокДекларации.ОшибкаПолученияРегиональногоПротокола = ?(ПараметрыСоединения.ПовторятьСоединение, НСтр("ru = 'Ошибка при обращении к серверу Росалкогольрегулирования'"), НСтр("ru = 'Не удалось получить региональный протокол'"));
			КонецЕсли;
			
			ПараметрыСоединения.ОписаниеОшибкиСервером = "";
			ПараметрыСоединения.ПовторятьСоединение = Ложь;
			
			ЗаголовокДекларации.ФедеральныйПротокол = Неопределено;
			ЗаголовокДекларации.ОшибкаПолученияФедеральногоПротокола = "";
			
			Возврат ЗаголовокДекларации;
			
		КонецЕсли;
		
	Иначе
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция НайтиЗаголовокДекларацииНаМосковскомПорталеСубъектаРФ(Страница, ИмяФайлаВыгрузки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	// поиск по списку загруженных деклараций
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "application/x-www-form-urlencoded");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ТекстЗапроса = "mode=clear";
	
	ИмяФайлаЗапроса = ПолучитьИмяВременногоФайла();
	ЗаписываемыйФайл = Новый ЗаписьТекста(ИмяФайлаЗапроса, КодировкаТекста.ANSI);
	ЗаписываемыйФайл.Записать(ТекстЗапроса);
	ЗаписываемыйФайл.Закрыть();
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаЗапроса, Страница + "/mosdecl/declaration_filter.do", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаЗапроса);
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаЗапроса);
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ЭлементовНаСтранице = 15;
	НомерСтраницы = 1;
	
	Пока Истина Цикл
		
		// получить страницу списка деклараций
		
		ЗаголовкиHTTP = Новый Соответствие();
		ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
		ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
		Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
			ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
		КонецЕсли;
		
		ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
		
		Попытка
			ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(Страница + ?(НомерСтраницы = 1, "/mosdecl/declaration_list.do",
				"/mosdecl/set_declaration_page.do?p=" + Формат(НомерСтраницы, "ЧН=0; ЧГ=")), ИмяФайлаОтвета, ЗаголовкиHTTP);
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			УдалитьВременныйФайл(ИмяФайлаОтвета);
			Возврат Неопределено;
			
		КонецПопытки;
		
		ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
		
		ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
		ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
		
		// прочитать поля заголовков деклараций
		
		ЗаголовкиДеклараций = Новый ТаблицаЗначений;
		ЗаголовкиДеклараций.Колонки.Добавить("ИдентификаторЗаписи");
		ЗаголовкиДеклараций.Колонки.Добавить("Состояние");
		ЗаголовкиДеклараций.Колонки.Добавить("ДатаЗагрузки");
		ИдентификаторЗаписи = "";
		НомерКолонки = 1;
		
		ТекущаяСтрока = ФайлОтвета.ПрочитатьСтроку();
		
		Пока ТекущаяСтрока <> Неопределено Цикл
			
			ПозицияСкриптаЗаписи = Найти(ТекущаяСтрока, "onclick=""editRow(");
			Если ПозицияСкриптаЗаписи > 0 Тогда
				
				ТекущаяСтрока = Сред(ТекущаяСтрока, ПозицияСкриптаЗаписи + 17);
				
				КонецСкриптаЗаписи = Найти(ТекущаяСтрока, ")");
				Если КонецСкриптаЗаписи > 1 Тогда
					
					ИдентификаторЗаписиСтроки = Лев(ТекущаяСтрока, КонецСкриптаЗаписи - 1);
					Если ИдентификаторЗаписи = "" ИЛИ ИдентификаторЗаписиСтроки <> ИдентификаторЗаписи Тогда
						
						ИдентификаторЗаписи = ИдентификаторЗаписиСтроки;
						НомерКолонки = 1;
						
						ЗаголовокДекларации = ЗаголовкиДеклараций.Добавить();
						ЗаголовокДекларации.ИдентификаторЗаписи = ИдентификаторЗаписи;
						ЗаголовокДекларации.Состояние = "";
						ЗаголовокДекларации.ДатаЗагрузки = "";
						
					Иначе
						НомерКолонки = НомерКолонки + 1;
					КонецЕсли;
					
					Если НомерКолонки = 8 ИЛИ НомерКолонки = 9 Тогда
						
						ЗначениеКолонки = "";
						
						ПозицияПрефиксаЗначения = Найти(ТекущаяСтрока, "style=""cursor:pointer"">");
						Если ПозицияПрефиксаЗначения > 0 Тогда
							
							ТекущаяСтрока = Сред(ТекущаяСтрока, ПозицияПрефиксаЗначения + 23);
							КонецЗначения = Найти(ТекущаяСтрока, "</TD>");
							
							Если КонецЗначения > 0 Тогда
								
								ЗначениеКолонкиHTML = Лев(ТекущаяСтрока, КонецЗначения - 1);
								ЗначениеКолонки = СокрЛП(ТекстИзHTML(ЗначениеКолонкиHTML));
								
							КонецЕсли;
							
						КонецЕсли;
						
						Если НомерКолонки = 8 Тогда
							ЗаголовокДекларации.Состояние = ЗначениеКолонки;
							
						ИначеЕсли НомерКолонки = 9 Тогда
							ЗаголовокДекларации.ДатаЗагрузки = ЗначениеКолонки;
						КонецЕсли;
						
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
			ТекущаяСтрока = ФайлОтвета.ПрочитатьСтроку();
			
		КонецЦикла;
		
		ФайлОтвета.Закрыть();
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		
		// читать более детальную информацию о декларациях, содержащюю имя файла, пока не будет найдено нужное
		
		Для Каждого ЗаголовокДекларации ИЗ ЗаголовкиДеклараций Цикл
			
			ЗаголовкиHTTP = Новый Соответствие();
			ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
			ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
			Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
				ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
			КонецЕсли;
			
			ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
			
			Попытка
				ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(Страница + "/mosdecl/declaration_edit.do?id=" + ЗаголовокДекларации.ИдентификаторЗаписи, ИмяФайлаОтвета, ЗаголовкиHTTP);
			Исключение
				
				ПараметрыСоединения.ПовторятьСоединение = Истина;
				УдалитьВременныйФайл(ИмяФайлаОтвета);
				Возврат Неопределено;
				
			КонецПопытки;
			
			ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
			ТекстОтвета = ФайлОтвета.Прочитать();
			ФайлОтвета.Закрыть();
			
			ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
			ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
			
			УдалитьВременныйФайл(ИмяФайлаОтвета);
			
			ПозицияМеткиИмениФайла = Найти(ТекстОтвета, "<td class=table_td>Файл</td>");
			Если ПозицияМеткиИмениФайла > 0 Тогда
				
				ТекстОтвета = Сред(ТекстОтвета, ПозицияМеткиИмениФайла + 28);
				
				ПозицияПрефиксаИмениФайла = Найти(ТекстОтвета, "<td class=table_td>");
				Если ПозицияПрефиксаИмениФайла > 0 Тогда
					
					ТекстОтвета = Сред(ТекстОтвета, ПозицияПрефиксаИмениФайла + 19);
					
					КонецИмениФайла = Найти(ТекстОтвета, "</td>");
					Если КонецИмениФайла > 0 Тогда
						
						ИмяПодписанногоФайлаВыгрузкиHTML = Лев(ТекстОтвета, КонецИмениФайла - 1);
						
						ИмяПодписанногоФайлаВыгрузки = СокрЛП(ТекстИзHTML(ИмяПодписанногоФайлаВыгрузкиHTML));
						
						Если ВРег(ИмяПодписанногоФайлаВыгрузки) = ВРег(ИмяФайлаВыгрузки + ".sig") Тогда
							
							Результат = Новый Структура("ИдентификаторЗаписи, ИмяФайла, Состояние, ЗначениеСостояния, ДатаЗагрузки, РегиональныйПротокол, ОшибкаПолученияРегиональногоПротокола, ФедеральныйПротокол, ОшибкаПолученияФедеральногоПротокола",
								ЗаголовокДекларации.ИдентификаторЗаписи, ИмяФайлаВыгрузки, ЗаголовокДекларации.Состояние, "", ЗаголовокДекларации.ДатаЗагрузки, Неопределено, "", Неопределено, "");
								
							Возврат Результат;
							
						КонецЕсли;
						
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
		Если ЗаголовкиДеклараций.Количество() < ЭлементовНаСтранице Тогда
			Прервать;
		КонецЕсли;
		
		НомерСтраницы = НомерСтраницы + 1;
		
	КонецЦикла;
	
	// поиск по списку очереди загрузки деклараций
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "application/x-www-form-urlencoded");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ТекстЗапроса = "mode=clear";
	
	ИмяФайлаЗапроса = ПолучитьИмяВременногоФайла();
	ЗаписываемыйФайл = Новый ЗаписьТекста(ИмяФайлаЗапроса, КодировкаТекста.ANSI);
	ЗаписываемыйФайл.Записать(ТекстЗапроса);
	ЗаписываемыйФайл.Закрыть();
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаЗапроса, Страница + "/mosdecl/incoming_filter.do", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаЗапроса);
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаЗапроса);
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	НомерСтраницы = 1;
	
	Пока Истина Цикл
		
		// получить страницу списка деклараций
		
		ЗаголовкиHTTP = Новый Соответствие();
		ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
		ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
		Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
			ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
		КонецЕсли;
		
		ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
		
		Попытка
			ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(Страница + ?(НомерСтраницы = 1, "/mosdecl/incoming_list.do",
				"/mosdecl/incoming_page.do?p=" + Формат(НомерСтраницы, "ЧН=0; ЧГ=")), ИмяФайлаОтвета, ЗаголовкиHTTP);
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			УдалитьВременныйФайл(ИмяФайлаОтвета);
			Возврат Неопределено;
			
		КонецПопытки;
		
		ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
		
		ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
		ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
		
		// прочитать поля заголовков деклараций
		
		Результат = Неопределено;
		ВерсияРезультата = 1;
		КоличествоДеклараций = 0;
		НомерКолонки = 1;
		
		ТекущаяСтрока = ФайлОтвета.ПрочитатьСтроку();
		
		Пока ТекущаяСтрока <> Неопределено Цикл
			
			ВерсияПоискаРезультата = 1;
			ПозицияСкриптаЗаписи = Найти(ТекущаяСтрока, "winOpen('incoming_info.do");
			Если ПозицияСкриптаЗаписи = 0 Тогда
				ВерсияПоискаРезультата = 2;
				ПозицияСкриптаЗаписи = Найти(ТекущаяСтрока, "<TR class='table_row");
			КонецЕсли;
			
			Если ПозицияСкриптаЗаписи > 0 Тогда
				
				Результат = Новый Структура("ИдентификаторЗаписи, ИмяФайла, Состояние, ЗначениеСостояния, ДатаЗагрузки, РегиональныйПротокол, ОшибкаПолученияРегиональногоПротокола, ФедеральныйПротокол, ОшибкаПолученияФедеральногоПротокола",
					"", "", "", "-1", "", Неопределено, "", Неопределено, "");
				ВерсияРезультата = ВерсияПоискаРезультата;
				КоличествоДеклараций = КоличествоДеклараций + 1;
				НомерКолонки = 1;
				
			КонецЕсли;
			
			Если Результат <> Неопределено Тогда
				
				Если ВерсияРезультата = 1 Тогда
					
					ПозицияЗначения = Найти(ТекущаяСтрока, "<TD class=table_td align=left >");
					Если ПозицияЗначения > 0 Тогда
						ПозицияЗначения = ПозицияЗначения + 31;
					Иначе
						
						ПозицияЗначения = Найти(ТекущаяСтрока, "<TD class=table_td align=left nowrap>");
						
						Если ПозицияЗначения > 0 Тогда
							ПозицияЗначения = ПозицияЗначения + 37;
						КонецЕсли;
						
					КонецЕсли;
					
				Иначе
					
					ПозицияЗначения = Найти(ТекущаяСтрока, Символы.Таб + Символы.Таб + Символы.Таб + ">");
					Если ПозицияЗначения > 0 Тогда
						ПозицияЗначения = ПозицияЗначения + 4;
					КонецЕсли;
					
				КонецЕсли;
				
				Если ПозицияЗначения > 0 Тогда
					
					Если НомерКолонки <= 4 Тогда
						
						ТекущаяСтрока = Сред(ТекущаяСтрока, ПозицияЗначения);
						КонецЗначения = Найти(ТекущаяСтрока, "</TD>");
						
						Если КонецЗначения > 0 Тогда
							ТекущаяСтрока = Лев(ТекущаяСтрока, КонецЗначения - 1);
						КонецЕсли;
						
						ЗначениеКолонки = СокрЛП(ТекстИзHTML(ТекущаяСтрока));
						
						Если НомерКолонки = 1 Тогда
							Результат.ИдентификаторЗаписи = ЗначениеКолонки;
							
						ИначеЕсли НомерКолонки = 2 Тогда
							Результат.ИмяФайла = ЗначениеКолонки;
							
						ИначеЕсли НомерКолонки = 3 Тогда
							Результат.Состояние = ЗначениеКолонки;
							
						ИначеЕсли НомерКолонки = 4 Тогда
							
							Результат.ДатаЗагрузки = ЗначениеКолонки;
							
							Если ВРег(Результат.ИмяФайла) = ВРег(ИмяФайлаВыгрузки) Тогда
								Возврат Результат;
							КонецЕсли;
							
						КонецЕсли;
						
					КонецЕсли;
					
					НомерКолонки = НомерКолонки + 1;
					
				КонецЕсли;
				
			КонецЕсли;
			
			ТекущаяСтрока = ФайлОтвета.ПрочитатьСтроку();
			
		КонецЦикла;
		
		ФайлОтвета.Закрыть();
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		
		Если КоличествоДеклараций < ЭлементовНаСтранице Тогда
			Прервать;
		КонецЕсли;
		
		НомерСтраницы = НомерСтраницы + 1;
		
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

Функция ПолучитьПротоколОбработкиДекларацииНаМосковскомПорталеСубъектаРФ(Страница, ИдентификаторЗаписи, ПараметрыСоединения, НаходитсяВОчередиЗагрузки)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(Страница + ?(НаходитсяВОчередиЗагрузки, "/mosdecl/incoming_info.do?id=", "/mosdecl/declaration_log.do?id=") + ИдентификаторЗаписи, ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	Протокол = Новый ТаблицаЗначений;
	Протокол.Колонки.Добавить("Дата");
	Протокол.Колонки.Добавить("Модуль");
	Протокол.Колонки.Добавить("Сообщение");
	
	ЗаголовокПротокола = "";
	ДатаПротокола = "";
	ТекущаяДатаПротокола = Строка(ТекущаяДатаСеанса());
	НачалоЗаписиНайдено = Ложь;
	ЗаписьПротокола = "";
	ИндексВставкиЗаписи = 0;
	ТекущаяСтрока = ФайлОтвета.ПрочитатьСтроку();
	
	Пока ТекущаяСтрока <> Неопределено Цикл
		
		ПозицияЗаголовка = Найти(ТекущаяСтрока, "<legend>");
		Если ПозицияЗаголовка > 0 Тогда
			
			// извлечение заголовка
			
			ТекущаяСтрока = Сред(ТекущаяСтрока, ПозицияЗаголовка + 8);
			
			КонецЗаголовка = Найти(ТекущаяСтрока, "</legend>");
			
			Если КонецЗаголовка > 0 Тогда
				
				ЗаголовокПротоколаHTML = Лев(ТекущаяСтрока, КонецЗаголовка - 1);
				
				ПозицияРазделителя = Найти(ЗаголовокПротоколаHTML, "&nbsp;&nbsp;&nbsp;&nbsp;");
				
				ДатаПротокола = "";
				Если ПозицияРазделителя > 0 Тогда
					ДатаПротоколаHTML = Лев(ЗаголовокПротоколаHTML, ПозицияРазделителя - 1);
					ДатаПротокола = СокрЛП(ТекстИзHTML(ДатаПротоколаHTML));
					ЗаголовокПротоколаHTML = Сред(ЗаголовокПротоколаHTML, ПозицияРазделителя + 24);
				КонецЕсли;
				
				ЗаголовокПротокола = СокрЛП(ТекстИзHTML(ЗаголовокПротоколаHTML));
				
				ИндексВставкиЗаписи = 0;
				
			КонецЕсли;
			
		ИначеЕсли ЗначениеЗаполнено(ЗаголовокПротокола) Тогда
			
			// извлечение записи протокола
			
			Если НЕ НачалоЗаписиНайдено Тогда
				
				ПозицияНачалаЗаписи = Найти(ТекущаяСтрока, "<td class=""tdLogInfo"">");
				
				Если ПозицияНачалаЗаписи > 0 Тогда
					ПозицияНачалаЗаписи = ПозицияНачалаЗаписи + 22;
				Иначе
					
					ПозицияНачалаЗаписи = Найти(ТекущаяСтрока, "<td class=""tdLogWarn"">");
					
					Если ПозицияНачалаЗаписи > 0 Тогда
						ПозицияНачалаЗаписи = ПозицияНачалаЗаписи + 22;
					Иначе
						
						ПозицияНачалаЗаписи = Найти(ТекущаяСтрока, "<td class=""tdLogError"">");
						
						Если ПозицияНачалаЗаписи > 0 Тогда
							ПозицияНачалаЗаписи = ПозицияНачалаЗаписи + 23;
						КонецЕсли;
						
					КонецЕсли;
					
				КонецЕсли;
				
				Если ПозицияНачалаЗаписи > 0 Тогда
					
					ТекущаяСтрока = Сред(ТекущаяСтрока, ПозицияНачалаЗаписи);
					НачалоЗаписиНайдено = Истина;
					ЗаписьПротокола = "";
					
				КонецЕсли;
				
			КонецЕсли;
			
			Если НачалоЗаписиНайдено Тогда
				
				КонецЗаписи = Найти(ТекущаяСтрока, "</td>");
				
				Если КонецЗаписи > 0 Тогда
					ТекущаяСтрока = Лев(ТекущаяСтрока, КонецЗаписи - 1);
				КонецЕсли;
				
				ТекущаяСтрокаЗаписиПротокола = СокрЛП(ТекстИзHTML(ТекущаяСтрока));
				
				ЗаписьПротокола = ЗаписьПротокола + ?(ЗначениеЗаполнено(ЗаписьПротокола) И ЗначениеЗаполнено(ТекущаяСтрокаЗаписиПротокола), " ", "") + ТекущаяСтрокаЗаписиПротокола;
				
				Если КонецЗаписи Тогда
					
					СтрокаПротокола = Протокол.Вставить(ИндексВставкиЗаписи);
					СтрокаПротокола.Дата = ?(ЗначениеЗаполнено(ДатаПротокола), ДатаПротокола, ТекущаяДатаПротокола);
					СтрокаПротокола.Модуль = ЗаголовокПротокола;
					СтрокаПротокола.Сообщение = ЗаписьПротокола;
					
					НачалоЗаписиНайдено = Ложь;
					ИндексВставкиЗаписи = ИндексВставкиЗаписи + 1;
					
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		ТекущаяСтрока = ФайлОтвета.ПрочитатьСтроку();
		
	КонецЦикла;
	
	ФайлОтвета.Закрыть();
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	Возврат Протокол;
	
КонецФункции

Функция ПолучитьДекларациюПодписаннуюНаМосковскомПорталеСубъектаРФ(ИдентификаторЗаписи, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ЭлементыСсылки = ЭлементыСсылкиНаПортал(ПараметрыОтправки.СсылкаНаПорталОнлайнПроверки, Истина);
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить(ЭлементыСсылки.Страница + "/mosdecl/declaration_sign_export.do?id=" + ИдентификаторЗаписи, ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	// в случае успешного возврата файла подписанной деклараци возвращается заголовок Content-Type: application/pkcs7-signature
	
	ТипСодержимого = ОтветHTTP.Заголовки.Получить("Content-Type");
	ТипСодержимого = нрег(СокрЛП(ТипСодержимого));
	
	Если ТипСодержимого <> "application/octet-stream" И ТипСодержимого <> "application/pkcs7-signature" Тогда
		
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		
		ПараметрыСоединения.ОписаниеОшибкиСервером = НСтр("ru = 'Ошибочный ответ сервера'");
		Возврат Неопределено;
		
	КонецЕсли;
	
	Возврат ИмяФайлаОтвета;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Служебные функции ФСРАР

Функция ОтчетПодаетсяЧерезФедеральныйПортал(ОтчетСсылка, ОтправкаСсылка = Неопределено) Экспорт
	
	Если ОтчетСсылка = Неопределено Тогда
		ОтчетСсылка = ОтправкаСсылка.ОтчетСсылка;
	КонецЕсли;
	
	Если ТипЗнч(ОтчетСсылка) = Тип("ДокументСсылка.РегламентированныйОтчет") Тогда
		ВидОтчета = Справочники.ВидыОтправляемыхДокументов.НайтиПоРеквизиту("Источник", ОтчетСсылка.ИсточникОтчета)
		
	Иначе // электронные представления
		ВидОтчета = ОтчетСсылка.ВидОтчета;
	КонецЕсли;
	
	Результат = (ВидОтчета <> Неопределено И ВидОтчета.ТипДокумента = Перечисления.ТипыОтправляемыхДокументов.ОтчетФСРАРОпт);
	Возврат Результат;
	
КонецФункции

Функция НастройкиФСРАР(Знач ОрганизацияСсылка, Знач ПолучитьПараметрыОнлайнПроверки = Ложь) Экспорт
	
	Результат = Новый Структура("ИспользоватьОбмен, СертификатАбонентаОтпечаток, СертификатСубъектаРФОтпечаток, СертификатФСРАРОтпечаток, КодРегиона, ИспользоватьАвтонастройку, ПарольПорталаСубъектаРФ", Ложь, "", "", "", "", Ложь, "");
	
	Если ПолучитьПараметрыОнлайнПроверки Тогда
		СвойстваОрганизации = ЗначенияРеквизитовОбъекта(ОрганизацияСсылка, "ВидОбменаСКонтролирующимиОрганами, УчетнаяЗаписьОбмена");
		
		Результат.Вставить("УчетнаяЗаписьОбмена", СвойстваОрганизации.УчетнаяЗаписьОбмена);
		Результат.Вставить("НастроенОбменВУниверсальномФормате", СвойстваОрганизации.ВидОбменаСКонтролирующимиОрганами = Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате
			И ЗначениеЗаполнено(СвойстваОрганизации.УчетнаяЗаписьОбмена));
		
		Попытка
			ОбменИОнлайнПроверкаВключены = Результат.НастроенОбменВУниверсальномФормате И НЕ СвойстваОрганизации.УчетнаяЗаписьОбмена.ОбменНапрямую И СвойстваОрганизации.УчетнаяЗаписьОбмена.ИспользоватьСервисОнлайнПроверкиОтчетов;
		Исключение
			ОбменИОнлайнПроверкаВключены = Ложь;
		КонецПопытки;
		
		Результат.Вставить("ОнлайнПроверкаДоступна", ОбменИОнлайнПроверкаВключены И СвойстваОрганизации.УчетнаяЗаписьОбмена.СпецоператорСвязи <> Перечисления.СпецоператорыСвязи.Такском И Найти(";" + ВРег(СокрЛП(ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПолучитьПараметрСпецоператора(СвойстваОрганизации.УчетнаяЗаписьОбмена.СпецоператорСвязи, "ОнлайнПроверкаКонтролирующиеОрганы"))) + ";", ";ФСРАР;") > 0);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				   |	НастройкиОбменаФСРАР.ИспользоватьОбмен КАК ИспользоватьОбмен,
				   |	НастройкиОбменаФСРАР.СертификатАбонентаОтпечаток КАК СертификатАбонентаОтпечаток,
				   |	НастройкиОбменаФСРАР.СертификатСубъектаРФОтпечаток КАК СертификатСубъектаРФОтпечаток,
				   |	НастройкиОбменаФСРАР.СертификатФСРАРОтпечаток КАК СертификатФСРАРОтпечаток,
				   |	НастройкиОбменаФСРАР.КодРегиона КАК КодРегиона,
				   |	НастройкиОбменаФСРАР.ИспользоватьАвтонастройку КАК ИспользоватьАвтонастройку,
				   |	НастройкиОбменаФСРАР.ПарольПорталаСубъектаРФ КАК ПарольПорталаСубъектаРФ
				   |ИЗ
				   |	РегистрСведений.НастройкиОбменаФСРАР КАК НастройкиОбменаФСРАР
				   |ГДЕ
				   |	НастройкиОбменаФСРАР.Организация = &ОрганизацияСсылка";
	Запрос.УстановитьПараметр("ОрганизацияСсылка", ОрганизацияСсылка);
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		ЗаписьЗапроса = РезультатЗапроса.Выгрузить()[0];
		Если ЗаписьЗапроса.ИспользоватьОбмен Тогда
			
			Результат.ИспользоватьОбмен = ЗаписьЗапроса.ИспользоватьОбмен;
			Результат.СертификатАбонентаОтпечаток = СокрЛП(ЗаписьЗапроса.СертификатАбонентаОтпечаток);
			Результат.СертификатСубъектаРФОтпечаток = СокрЛП(ЗаписьЗапроса.СертификатСубъектаРФОтпечаток);
			Результат.СертификатФСРАРОтпечаток = СокрЛП(ЗаписьЗапроса.СертификатФСРАРОтпечаток);
			Результат.КодРегиона = СокрЛП(ЗаписьЗапроса.КодРегиона);
			Результат.ИспользоватьАвтонастройку = ЗаписьЗапроса.ИспользоватьАвтонастройку;
			Результат.ПарольПорталаСубъектаРФ = ЗаписьЗапроса.ПарольПорталаСубъектаРФ;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// ОтправкаСсылка ссылается на загруженный объект
Функция СвойстваОбменаОрганизации(Знач ОрганизацияСсылка, Знач ОпределитьОтправкуЧерезФедеральныйПорталДляОтчета, Знач ОпределитьНастроенностьОбменаВУниверсальномФормате, Знач ПолучитьОсновныеСвойстваПоследнейОтправки, Знач ПолучитьИнформациюОРегионе = Ложь, Знач ОтправкаСсылка = Неопределено, ОтчетСсылка = Неопределено) Экспорт
	
	Результат = Новый Структура("ОтправкаЧерезФедеральныйПортал, НастроенОбменВУниверсальномФормате, СвойстваОтправки, НастройкиОбмена, ИнформацияОРегионе, ОрганизацияИзОтправки, ПравоИзмененияУчетнойЗаписи, ЭтоРегламентированныйОтчет, ЭтоЭлектроннаяПодписьВМоделиСервиса", Неопределено, Неопределено, Неопределено, Неопределено, Неопределено, Неопределено, Неопределено, Неопределено, ЭлектроннаяПодписьВМоделиСервисаВызовСервера.ЭтоЭлектроннаяПодписьВМоделиСервиса(ОрганизацияСсылка));
	
	Если ОпределитьОтправкуЧерезФедеральныйПорталДляОтчета Тогда
		
		Результат.ОтправкаЧерезФедеральныйПортал = ОтчетПодаетсяЧерезФедеральныйПортал(ОтчетСсылка, ОтправкаСсылка);
		
		Если Результат.ОтправкаЧерезФедеральныйПортал Тогда
			ПолучитьИнформациюОРегионе = Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	Если ОрганизацияСсылка = Неопределено Тогда
		
		ОрганизацияСсылка = ОтправкаСсылка.Организация;
		Результат.ОрганизацияИзОтправки = ОрганизацияСсылка;
		
	КонецЕсли;
	
	Если ОпределитьНастроенностьОбменаВУниверсальномФормате Тогда
		
		СвойстваОрганизации = ЗначенияРеквизитовОбъекта(ОрганизацияСсылка, "ВидОбменаСКонтролирующимиОрганами, УчетнаяЗаписьОбмена");
		
		Результат.НастроенОбменВУниверсальномФормате = (СвойстваОрганизации.ВидОбменаСКонтролирующимиОрганами = Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате
			И ЗначениеЗаполнено(СвойстваОрганизации.УчетнаяЗаписьОбмена));
		
	КонецЕсли;
	
	Если ПолучитьОсновныеСвойстваПоследнейОтправки Тогда
		
		СвойстваОтправки = ПолучитьОсновныеСвойстваПоследнейОтправкиОтчетаВФСРАР(ОтчетСсылка);
		Если СвойстваОтправки <> Неопределено Тогда
			Результат.СвойстваОтправки = Новый Структура("Ссылка, Идентификатор, ИмяФайлаПакета, Статус, СхемаСдачиОтчетности, СтатусОтправкиНаРегиональныйСервер, ЗаверенныйПакетОтправлен",
				СвойстваОтправки.Ссылка, СвойстваОтправки.Идентификатор, СвойстваОтправки.ИмяФайлаПакета, СвойстваОтправки.Статус, СвойстваОтправки.СхемаСдачиОтчетности, СвойстваОтправки.СтатусОтправкиНаРегиональныйСервер, СвойстваОтправки.ЗаверенныйПакетОтправлен);
		КонецЕсли;
		
	КонецЕсли;
	
	Результат.НастройкиОбмена = НастройкиФСРАР(ОрганизацияСсылка);
	
	Результат.ИнформацияОРегионе = ИнформацияОРегионеФСРАР(?(ПолучитьИнформациюОРегионе, Результат.НастройкиОбмена.КодРегиона, ""));
	
	Результат.ПравоИзмененияУчетнойЗаписи = ПравоДоступа("Изменение", Метаданные.Справочники.УчетныеЗаписиДокументооборота);
	
	Если ОтчетСсылка <> Неопределено ИЛИ ОтправкаСсылка <> Неопределено Тогда
		
		Если ОтчетСсылка <> Неопределено Тогда
			ТипЗнчСсылкаНаОтчет = ТипЗнч(ОтчетСсылка);
		Иначе
			ТипЗнчСсылкаНаОтчет = ТипЗнч(ОтправкаСсылка.ОтчетСсылка);
		КонецЕсли;
		
		Результат.ЭтоРегламентированныйОтчет = (ТипЗнчСсылкаНаОтчет = Тип("ДокументСсылка.РегламентированныйОтчет") ИЛИ ТипЗнчСсылкаНаОтчет = Тип("Неопределено"));
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаписатьПарольПорталаСубъектаРФ(Организация, Пароль)
	
	Попытка
		
		МенеджерЗаписи = РегистрыСведений.НастройкиОбменаФСРАР.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Организация = Организация;
		МенеджерЗаписи.Прочитать();
		
		Если МенеджерЗаписи.Выбран() Тогда
			МенеджерЗаписи.ПарольПорталаСубъектаРФ = Пароль;
			МенеджерЗаписи.Записать();
		КонецЕсли;
		
	Исключение
	КонецПопытки;
	
КонецПроцедуры

Функция ИнформацияОРегионеФСРАР(Знач КодРегиона) Экспорт
	
	Результат = Новый Структура("НаименованиеРегиона, ТипПортала, СсылкаНаПортал", "", "", "");
	
	Если ЗначениеЗаполнено(КодРегиона) Тогда
		
		Макет = ПолучитьМакет("ФСРАРПорталыРегионов");
		НомерКолонкиКодРегиона = Макет.Область("КодРегиона").Лево;
		ОбластьПоиска = Макет.Область(1, НомерКолонкиКодРегиона, Макет.ВысотаТаблицы, НомерКолонкиКодРегиона);
		
		Ячейка = Макет.НайтиТекст(КодРегиона, , ОбластьПоиска, , Истина);
		
		Если Ячейка <> Неопределено Тогда
			
			НомерСтроки = Ячейка.Верх;
			
			НомерКолонкиНаименованиеРегиона = Макет.Область("НаименованиеРегиона").Лево;
			Результат.НаименованиеРегиона = Макет.Область(НомерСтроки, НомерКолонкиНаименованиеРегиона).Текст;
			НомерКолонкиТипПортала = Макет.Область("ТипПортала").Лево;
			Результат.ТипПортала = Макет.Область(НомерСтроки, НомерКолонкиТипПортала).Текст;
			НомерКолонкиСсылкаНаПортал = Макет.Область("СсылкаНаПортал").Лево;
			Результат.СсылкаНаПортал = Макет.Область(НомерСтроки, НомерКолонкиСсылкаНаПортал).Текст;
			
		КонецЕсли;
	
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция УспешноОбработанаДекларацияФСРАР(Протокол, СхемаСдачиОтчетности, НаходитсяВОчередиЗагрузки, ПротоколПуст = Неопределено)
	
	ПоследняяСтрокаПротокола = "";
	Если Протокол <> Неопределено Тогда
		
		КоличествоСтрокПротокола = Протокол.Количество();
		Если КоличествоСтрокПротокола > 0 Тогда
			ПоследняяСтрокаПротокола = Протокол.Получить(КоличествоСтрокПротокола - 1).Сообщение;
		КонецЕсли;
		ПротоколПуст = (КоличествоСтрокПротокола = 0);
		
	Иначе
		ПротоколПуст = Истина;
	КонецЕсли;
	
	Если СхемаСдачиОтчетности = Перечисления.СхемыСдачиОтчетностиФСРАР.МосковскийРегиональныйИФедеральныйСерверы Тогда
		Если ЗначениеЗаполнено(ПоследняяСтрокаПротокола) Тогда
			
			Результат = (Лев(ПоследняяСтрокаПротокола, 1) <> "-" И Найти(ПоследняяСтрокаПротокола, "не может быть загружена") = 0 И Найти(ПоследняяСтрокаПротокола, "Ошибка при") = 0);
			Если Результат И НаходитсяВОчередиЗагрузки Тогда
				Результат = Неопределено;
			КонецЕсли;
			Возврат Результат;
			
		Иначе
			Возврат Неопределено;
		КонецЕсли;
		
	ИначеЕсли Найти(ПоследняяСтрокаПротокола, "Декларация успешно обработана и сохранена в базу.") > 0 Тогда
		Возврат Истина;
		
	ИначеЕсли Найти(ПоследняяСтрокаПротокола, "содержит ошибки.") > 0 ИЛИ Найти(ПоследняяСтрокаПротокола, "Подробнее об ошибке") > 0 ИЛИ Найти(ПоследняяСтрокаПротокола, "Ошибка при") > 0 ИЛИ Найти(ПоследняяСтрокаПротокола, "Декларация уже есть в базе.") > 0 Тогда
		Возврат Ложь;
		
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Общие служебные функции, используются при документообороте с ФСРАР

Функция ЗаписатьZipФайлПакета(Знач СтрокаBase64, Знач ИмяАрхивируемогоФайла) Экспорт
	
	// создаем временный каталог, в который помещаем пакуемый файл
	ВременныйКаталог = КаталогВременныхФайлов();
	РазделительПутиОС = ПолучитьРазделительПути();
	Если Прав(ВременныйКаталог, 1) <> РазделительПутиОС Тогда
		ВременныйКаталог = ВременныйКаталог + РазделительПутиОС;
	КонецЕсли;
	ВременныйКаталог = ВременныйКаталог + Строка(Новый УникальныйИдентификатор) + РазделительПутиОС;
	СоздатьКаталог(ВременныйКаталог);
	
	// выгружаем двоичные данные в файл
	ПолноеИмяАрхивируемогоФайла = ВременныйКаталог + ИмяАрхивируемогоФайла;
	ДвоичныеДанныеФайла = Base64Значение(СтрокаBase64);
	ДвоичныеДанныеФайла.Записать(ПолноеИмяАрхивируемогоФайла);
	
	// пишем архив
	КороткоеИмяФайлаАрхива = Строка(Новый УникальныйИдентификатор);
	ПолноеИмяФайлаАрхива = ВременныйКаталог + КороткоеИмяФайлаАрхива;
	
	Попытка
		
		ОбъектЗаписьZip = Новый ЗаписьZipФайла(ПолноеИмяФайлаАрхива);
		ОбъектЗаписьZip.Добавить(ПолноеИмяАрхивируемогоФайла);
		ОбъектЗаписьZip.Записать();
		
	Исключение
		
		// уведомляем об ошибке, если она была
		СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Ошибка создания архива: %1'"), ИнформацияОбОшибке().Описание));
		
		Попытка
			УдалитьФайлы(ВременныйКаталог);
		Исключение
		КонецПопытки;
		
		Возврат Неопределено;
		
	КонецПопытки;
	
	// помещаем архив обратно во временное хранилище
	Результат = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(ПолноеИмяФайлаАрхива));
	
	// удаляем временный каталог
	Попытка
		УдалитьФайлы(ВременныйКаталог);
	Исключение
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

Функция ПоместитьФайлВоВременноеХранилищеНаСервере(СтрокаBase64Файла) Экспорт
	
	// получаем двоичные данные файла, переданного в виде строки Base64
	ДвоичныеДанныеФайла = Base64Значение(СтрокаBase64Файла);
	
	// помещаем данные обратно во временное хранилище
	Результат = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла);
	
	Возврат Результат;
	
КонецФункции

Функция ЧислоИзШестнадцатеричного(ШестнадцатеричноеЗначение, ЗначениеПриОшибке = 0, ПозицияОшибки = 0)
	
	Результат = 0;
	ПозицияОшибки = 0;
	
	Для Позиция = 1 По СтрДлина(ШестнадцатеричноеЗначение) Цикл
		
		ТекущийСимвол = Сред(ШестнадцатеричноеЗначение, Позиция, 1);
		КодТекущегоСимвола = КодСимвола(ТекущийСимвол);
		
		Если КодТекущегоСимвола >= КодСимвола("0") И КодТекущегоСимвола <= КодСимвола("9") Тогда
			
			Результат = Результат * 16 + (КодТекущегоСимвола - КодСимвола("0"));
			
		ИначеЕсли КодТекущегоСимвола >= КодСимвола("A") И КодТекущегоСимвола <= КодСимвола("F") Тогда
			
			Результат = Результат * 16 + (КодТекущегоСимвола - КодСимвола("A") + 10);
			
		ИначеЕсли КодТекущегоСимвола >= КодСимвола("a") И КодТекущегоСимвола <= КодСимвола("f") Тогда
			
			Результат = Результат * 16 + (КодТекущегоСимвола - КодСимвола("a") + 10);
			
		Иначе
			
			ПозицияОшибки = Позиция;
			Результат = ЗначениеПриОшибке;
			Прервать;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ТекстИзHTML(ТекстHTML)
	
	Результат = "";
	Позиция = 1;
	
	Пока Позиция <= СтрДлина(ТекстHTML) Цикл
		
		ТекущийСимвол = Сред(ТекстHTML, Позиция, 1);
		СимволHTML = Неопределено;
		
		Если ТекущийСимвол = "&" Тогда
			
			Для Длина = 2 По 10 Цикл
				Если Сред(ТекстHTML, Позиция + Длина - 1, 1) = ";" Тогда
					СимволHTML = Сред(ТекстHTML, Позиция, Длина);
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			Если СимволHTML <> Неопределено Тогда
				
				Если СимволHTML = "&quot;" ИЛИ СимволHTML = "&laquo;" ИЛИ СимволHTML = "&raquo;" Тогда
					Результат = Результат + """";
				ИначеЕсли СимволHTML = "&nbsp;" Тогда
					Результат = Результат + " ";
				ИначеЕсли СимволHTML = "&amp;" Тогда
					Результат = Результат + "&";
				ИначеЕсли СимволHTML = "&lt;" Тогда
					Результат = Результат + "<";
				ИначеЕсли СимволHTML = "&gt;" Тогда
					Результат = Результат + ">";
				ИначеЕсли Сред(СимволHTML, 2, 1) = "#" И СтрДлина(СимволHTML) > 3 Тогда
				
					ПодстрокаСКодомСимволаВUTF16 = Сред(СимволHTML, 3, СтрДлина(СимволHTML) - 3);
					КодСимволаВUTF16 = Неопределено;
					Попытка
						КодСимволаВUTF16 = Число(ПодстрокаСКодомСимволаВUTF16);
					Исключение
					КонецПопытки;
					
					Если Формат(КодСимволаВUTF16, "ЧН=0; ЧГ=") <> ПодстрокаСКодомСимволаВUTF16 Тогда
						КодСимволаВUTF16 = Неопределено;
					КонецЕсли;
					
					Если КодСимволаВUTF16 <> Неопределено И КодСимволаВUTF16 >= 0 И КодСимволаВUTF16 <= 65535 Тогда
						Результат = Результат + Символ(КодСимволаВUTF16);
					Иначе
						СимволHTML = Неопределено;
					КонецЕсли;
				
				Иначе
					СимволHTML = Неопределено;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если СимволHTML = Неопределено Тогда
			Результат = Результат + ТекущийСимвол;
			Позиция = Позиция + 1;
		Иначе
			Позиция = Позиция + СтрДлина(СимволHTML);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция СледующееЗначениеJSON(ТекстJSON, Позиция, ПредшествующийСимволРазделителя)
	
	Пока Позиция <= СтрДлина(ТекстJSON) Цикл
		
		Если Сред(ТекстJSON, Позиция, 1) <= " " Тогда
			Позиция = Позиция + 1;
		Иначе
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	Если Позиция <= СтрДлина(ТекстJSON) Тогда
		
		ТекущийСимвол = Сред(ТекстJSON, Позиция, 1);
		Если ТекущийСимвол = ":" ИЛИ ТекущийСимвол = "," ИЛИ ТекущийСимвол = ";" ИЛИ ТекущийСимвол = "{" ИЛИ ТекущийСимвол = "}"
			ИЛИ ТекущийСимвол = "[" ИЛИ ТекущийСимвол = "]" Тогда
			ПредшествующийСимволРазделителя = ТекущийСимвол;
			Позиция = Позиция + 1;
		КонецЕсли;
		
	КонецЕсли;
	
	Пока Позиция <= СтрДлина(ТекстJSON) Цикл
		
		Если Сред(ТекстJSON, Позиция, 1) <= " " Тогда
			Позиция = Позиция + 1;
		Иначе
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	ЗначениеВКавычках = Истина;
	
	Если Позиция <= СтрДлина(ТекстJSON) Тогда
		
		Если Сред(ТекстJSON, Позиция, 1) = """" Тогда
			Позиция = Позиция + 1;
		Иначе
			ЗначениеВКавычках = Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	ПозицияНачала = Позиция;
	ПозицияКонца = СтрДлина(ТекстJSON);
	
	Пока Позиция <= СтрДлина(ТекстJSON) Цикл
		
		ТекущийСимвол = Сред(ТекстJSON, Позиция, 1);
		Если ТекущийСимвол = """" И ЗначениеВКавычках И Сред(ТекстJSON, Позиция - 1, 1) <> "\" Тогда
			
			ПозицияКонца = Позиция - 1;
			Позиция = Позиция + 1;
			Прервать;
			
		ИначеЕсли (ТекущийСимвол = ":" ИЛИ ТекущийСимвол = "," ИЛИ ТекущийСимвол = ";" ИЛИ ТекущийСимвол = "{" ИЛИ ТекущийСимвол = "}"
			ИЛИ ТекущийСимвол = "[" ИЛИ ТекущийСимвол = "]") И НЕ ЗначениеВКавычках Тогда
			
			ПозицияКонца = Позиция - 1;
			Прервать;
			
		Иначе
			
			Позиция = Позиция + 1;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Результат = Сред(ТекстJSON, ПозицияНачала, ПозицияКонца - ПозицияНачала + 1);
	Если ЗначениеВКавычках Тогда
		Результат = СтрЗаменить(Результат, "\""", """");
	КонецЕсли;
	Возврат Результат;
	
КонецФункции

Функция ТаблицаJSON(ТекстJSON, Префикс, ИменаКолонокЧерезЗапятую, ИдентификаторыКолонокЧерезЗапятую, ПодстрокаНаличияДанных = """success"":true", ЗначенияМассивыРазрешены = Ложь)
	
	Если ЗначениеЗаполнено(ПодстрокаНаличияДанных) И Найти(ТекстJSON, ПодстрокаНаличияДанных) = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Позиция = Найти(ТекстJSON, Префикс);
	Если Позиция = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	Позиция = Позиция + СтрДлина(Префикс);
	
	Результат = Новый ТаблицаЗначений;
	СтрокаРезультата = Неопределено;
	
	ИменаКолонокСтроками = СтрЗаменить(ИменаКолонокЧерезЗапятую, ",", Символы.ПС);
	Для НомерСтроки = 1 По СтрЧислоСтрок(ИменаКолонокСтроками) Цикл
		ИмяКолонки = СокрЛП(СтрПолучитьСтроку(ИменаКолонокСтроками, НомерСтроки));
		Результат.Колонки.Добавить(ИмяКолонки);
	КонецЦикла;
	
	ИдентификаторыКолонок = Новый Массив;
	ИдентификаторыКолонокСтроками = СтрЗаменить(ИдентификаторыКолонокЧерезЗапятую, ",", Символы.ПС);
	Для НомерСтроки = 1 По СтрЧислоСтрок(ИдентификаторыКолонокСтроками) Цикл
		ИдентификаторКолонки = СокрЛП(СтрПолучитьСтроку(ИдентификаторыКолонокСтроками, НомерСтроки));
		ИдентификаторыКолонок.Добавить(ИдентификаторКолонки);
	КонецЦикла;
	
	Разделитель = "";
	ОжидаемыйРазделитель = "{";
	Пока Позиция <= СтрДлина(ТекстJSON) Цикл
		
		ИмяПараметра = СледующееЗначениеJSON(ТекстJSON, Позиция, Разделитель);
		
		Если Разделитель <> ОжидаемыйРазделитель Тогда
			
			Если Разделитель <> "}" Тогда
				Прервать;
			КонецЕсли;
			СтрокаРезультата = Неопределено;
			
			СледующееЗначениеJSON(ТекстJSON, Позиция, Разделитель);
			Если Разделитель <> "," Тогда
				Прервать;
			КонецЕсли;
			
			ИмяПараметра = СледующееЗначениеJSON(ТекстJSON, Позиция, Разделитель);
			Если Разделитель <> "{" Тогда
				Прервать;
			КонецЕсли;
			
		КонецЕсли;
		
		ЗначениеПараметра = СледующееЗначениеJSON(ТекстJSON, Позиция, Разделитель);
		
		Если Разделитель <> ":" Тогда
			Прервать;
		КонецЕсли;
		
		Если ЗначенияМассивыРазрешены И ПустаяСтрока(ЗначениеПараметра) И Сред(ТекстJSON, Позиция, 1) = "[" Тогда
			
			ЗначениеПараметра = Новый Массив;
			ЭлементМассива = СледующееЗначениеJSON(ТекстJSON, Позиция, Разделитель);
			
			Пока Истина Цикл
				
				ЗначениеПараметра.Добавить(ЭлементМассива);
				
				ЭлементМассива = СледующееЗначениеJSON(ТекстJSON, Позиция, Разделитель);
				Если Разделитель <> "," Тогда
					Прервать;
				КонецЕсли;
				
			КонецЦикла;
			
			Если Разделитель <> "]" Тогда
				Прервать;
			КонецЕсли;
			
		КонецЕсли;
		
		ИндексКолонки = ИдентификаторыКолонок.Найти(ИмяПараметра);
		Если ИндексКолонки <> Неопределено И ИндексКолонки < Результат.Колонки.Количество() Тогда
			
			Если СтрокаРезультата = Неопределено Тогда
				СтрокаРезультата = Результат.Добавить();
			КонецЕсли;
			СтрокаРезультата.Установить(ИндексКолонки, ЗначениеПараметра);
			
		КонецЕсли;
		
		ОжидаемыйРазделитель = ",";
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ТекстЗначенияJSONВШестнадцатеричнойUTF16(ЗначениеJSON)
	
	Результат = "";
	Позиция = 1;
	Пока Позиция <= СтрДлина(ЗначениеJSON) Цикл
		
		ТекущийСимвол = Сред(ЗначениеJSON, Позиция, 1);
		Если ТекущийСимвол = "\" И Сред(ЗначениеJSON, Позиция + 1, 1) = "u" Тогда
			
			ШестнадцатеричныйКодСимволаUTF8 = Сред(ЗначениеJSON, Позиция + 2, 4);
			КодСимволаUTF8 = ЧислоИзШестнадцатеричного(ШестнадцатеричныйКодСимволаUTF8, Неопределено);
			Если КодСимволаUTF8 <> Неопределено Тогда
				
				Результат = Результат + Символ(КодСимволаUTF8);
				Позиция = Позиция + 6;
				ТекущийСимвол = Неопределено;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если ТекущийСимвол <> Неопределено Тогда
			
			Результат = Результат + ТекущийСимвол;
			Позиция = Позиция + 1;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ТекстИзСтрокиJSON(СтрокаJSON, ЗаменаПереводаСтроки = Неопределено)
	
	Результат = "";
	
	НомерСимвола = 1;
	НачалоНедобавленногоФрагмента = 1;
	Пока НомерСимвола + 5 <= СтрДлина(СтрокаJSON) Цикл
		Если Сред(СтрокаJSON, НомерСимвола, 2) = "\u" Тогда
			ШестнадцатеричныйКодСимвола = Сред(СтрокаJSON, НомерСимвола + 2, 4);
			КодСимволаЧислом = ЧислоИзШестнадцатеричного(ШестнадцатеричныйКодСимвола, -1);
			Если КодСимволаЧислом <> -1 Тогда
				Результат = Результат + Сред(СтрокаJSON, НачалоНедобавленногоФрагмента, НомерСимвола - НачалоНедобавленногоФрагмента) + Символ(КодСимволаЧислом);
				НомерСимвола = НомерСимвола + 6;
				НачалоНедобавленногоФрагмента = НомерСимвола;
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		НомерСимвола = НомерСимвола + 1;
	КонецЦикла;
	Результат = Результат + Сред(СтрокаJSON, НачалоНедобавленногоФрагмента);
	
	Если ЗаменаПереводаСтроки <> Неопределено Тогда
		Результат = СтрЗаменить(Результат, "\r\n", ЗаменаПереводаСтроки);
		Результат = СтрЗаменить(Результат, "\r", ЗаменаПереводаСтроки);
		Результат = СтрЗаменить(Результат, "\n", ЗаменаПереводаСтроки);
	Иначе
		Результат = СтрЗаменить(Результат, "\r", Символы.ВК);
		Результат = СтрЗаменить(Результат, "\n", Символы.ПС);
	КонецЕсли;
	Результат = СтрЗаменить(Результат, "\t", Символы.Таб);
	Результат = СтрЗаменить(Результат, "\v", Символы.ВТаб);
	Результат = СтрЗаменить(Результат, "\f", Символы.ПФ);
	Результат = СтрЗаменить(Результат, "\\", "\");
	
	Возврат Результат;
	
КонецФункции

Функция ТекстИзUTF8(ТекстВКодировкеUTF8)
	
	Результат = "";
	
	// Исключение из стандарта 456.
	СимволыСКодами1056ДалееС152По187 = "И       Р   Ф ЦЧ Щ ЫЬЭЮ аб   ежз   л";
	СимволыСКодами1056ДалееС1025По1169 = "Ш ЁЪнвЯУ     С                                                                  иА когпмКМОН ТП                                                Хд";
	СимволыСКодами1056ДалееС8211По8250 = "ЖЗ   БВ  ГД    Е                       Л";
	СимволыСКодами1056ДалееС8470По8482 = "й           Й";
	СимволыСКодами1057ДалееС1026По1107 = "рс     ъьюэ  я                                                                   у";
	СимволыСКодами1057ДалееС8216По8364 = "ё т   ф цч    х         щ        ы                                                                                                                  ш";
	
	НомерСимвола = 1;
	Пока НомерСимвола <= СтрДлина(ТекстВКодировкеUTF8) Цикл
		
		ПервыйСимвол = Сред(ТекстВКодировкеUTF8, НомерСимвола, 1);
		КодПервогоСимвола = КодСимвола(ПервыйСимвол);
		
		Если КодПервогоСимвола <= 128 Тогда
			Результат = Результат + ПервыйСимвол;
			
		ИначеЕсли НомерСимвола < СтрДлина(ТекстВКодировкеUTF8) Тогда
			НомерСимвола = НомерСимвола + 1;
			ВторойСимвол = Сред(ТекстВКодировкеUTF8, НомерСимвола, 1);
			КодВторогоСимвола = КодСимвола(ВторойСимвол);
			
			Если КодПервогоСимвола = 1056 Тогда
				Если КодВторогоСимвола >= 152 И КодВторогоСимвола <= 187 Тогда
					Результат = Результат + Сред(СимволыСКодами1056ДалееС152По187, КодВторогоСимвола - 151, 1);
				ИначеЕсли КодВторогоСимвола >= 1025 И КодВторогоСимвола <= 1169 Тогда
					Результат = Результат + Сред(СимволыСКодами1056ДалееС1025По1169, КодВторогоСимвола - 1024, 1);
				ИначеЕсли КодВторогоСимвола >= 8211 И КодВторогоСимвола <= 8250 Тогда
					Результат = Результат + Сред(СимволыСКодами1056ДалееС8211По8250, КодВторогоСимвола - 8210, 1);
				ИначеЕсли КодВторогоСимвола >= 8470 И КодВторогоСимвола <= 8482 Тогда
					Результат = Результат + Сред(СимволыСКодами1056ДалееС8470По8482, КодВторогоСимвола - 8469, 1);
				Иначе
					Результат = Результат + " ";
				КонецЕсли
				
			ИначеЕсли КодПервогоСимвола = 1057 Тогда
				Если КодВторогоСимвола >= 1026 И КодВторогоСимвола <= 1107 Тогда
					Результат = Результат + Сред(СимволыСКодами1057ДалееС1026По1107, КодВторогоСимвола - 1025, 1);
				ИначеЕсли КодВторогоСимвола >= 8216 И КодВторогоСимвола <= 8364 Тогда
					Результат = Результат + Сред(СимволыСКодами1057ДалееС8216По8364, КодВторогоСимвола - 8215, 1);
				Иначе
					Результат = Результат + " ";
				КонецЕсли;
				
			ИначеЕсли КодПервогоСимвола = 1042 И (КодВторогоСимвола = 171 ИЛИ КодВторогоСимвола = 187) Тогда
				Результат = Результат + """";
				
			ИначеЕсли КодПервогоСимвола = 1074 И КодВторогоСимвола = 8222 И НомерСимвола < СтрДлина(ТекстВКодировкеUTF8) Тогда
				НомерСимвола = НомерСимвола + 1;
				ТретийСимвол = Сред(ТекстВКодировкеUTF8, НомерСимвола, 1);
				КодТретьегоСимвола = КодСимвола(ТретийСимвол);
				Если КодТретьегоСимвола = 8211 Тогда
					Результат = Результат + "N";
				Иначе
					Результат = Результат + " ";
				КонецЕсли;
				
			Иначе
				Результат = Результат + " ";
			КонецЕсли;
			
		КонецЕсли;
		
		НомерСимвола = НомерСимвола + 1;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ЭлементыСсылкиНаПортал(СсылкаНаПортал, УбратьСлэшВКонцеСтраницы = Ложь) Экспорт
	
	ЗначениеСсылкиНаПортал = СокрЛП(СсылкаНаПортал);
	ЗащищенноеСоединение = Ложь;
	АдресСервера = ЗначениеСсылкиНаПортал;
	Страница = "";
	
	Если нрег(Лев(ЗначениеСсылкиНаПортал, 7)) = "http://" Тогда
		ЗначениеСсылкиНаПортал = Сред(ЗначениеСсылкиНаПортал, 8);
	ИначеЕсли нрег(Лев(ЗначениеСсылкиНаПортал, 8)) = "https://" Тогда
		ЗначениеСсылкиНаПортал = Сред(ЗначениеСсылкиНаПортал, 9);
		ЗащищенноеСоединение = Истина;
	КонецЕсли;
	
	ПозицияСлэша = Найти(ЗначениеСсылкиНаПортал, "/");
	ПозицияВопроса = Найти(ЗначениеСсылкиНаПортал, "?");
	ПозицияРазделителя = ПозицияСлэша;
	Если ПозицияСлэша > 0 И ПозицияВопроса > 0 И ПозицияВопроса < ПозицияСлэша Тогда
		ПозицияРазделителя = ПозицияВопроса;
	КонецЕсли;
	
	Если ПозицияРазделителя > 0 Тогда
		
		АдресСервера = Лев(ЗначениеСсылкиНаПортал, ПозицияРазделителя - 1);
		Страница = Сред(ЗначениеСсылкиНаПортал, ПозицияРазделителя);
		
		Если УбратьСлэшВКонцеСтраницы И Прав(Страница, 1) = "/" Тогда
			Страница = Лев(Страница, СтрДлина(Страница) - 1);
		КонецЕсли;
			
	КонецЕсли;
	
	Результат = Новый Структура("ЗащищенноеСоединение, АдресСервера, Страница", ЗащищенноеСоединение, АдресСервера, Страница);
	Возврат Результат;
	
КонецФункции

Функция ОбновленноеЗначениеCookie(ЗначениеCookie, ЗначениеSetCookie)
	
	Результат = ЗначениеCookie;
	
	Если НЕ ЗначениеЗаполнено(ЗначениеSetCookie) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Результат = СтрЗаменить(Результат, ",", ";");
	
	ПредыдущаяПозицияSetCookie = 1;
	
	Для ПозицияSetCookie = 1 По СтрДлина(ЗначениеSetCookie) + 1 Цикл
		Если ПозицияSetCookie > СтрДлина(ЗначениеSetCookie) ИЛИ Сред(ЗначениеSetCookie, ПозицияSetCookie, 1) = ";" ИЛИ Сред(ЗначениеSetCookie, ПозицияSetCookie, 1) = "," Тогда
			
			ЭлементSetCookie = СокрЛП(Сред(ЗначениеSetCookie, ПредыдущаяПозицияSetCookie, ПозицияSetCookie - ПредыдущаяПозицияSetCookie));
			ИмяЭлементаSetCookie = "";
			ЗначениеЭлементаSetCookie = "";
			ПозицияРазделителя = Найти(ЭлементSetCookie, "=");
			Если ПозицияРазделителя > 0 Тогда
				ИмяЭлементаSetCookie = СокрП(Лев(ЭлементSetCookie, ПозицияРазделителя - 1));
				ИмяЭлементаSetCookie = ВРег(ИмяЭлементаSetCookie);
				ЗначениеЭлементаSetCookie = СокрП(Сред(ЭлементSetCookie, ПозицияРазделителя + 1));
			КонецЕсли;
			
			Если ИмяЭлементаSetCookie <> "" И ИмяЭлементаSetCookie <> "PATH" И ИмяЭлементаSetCookie <> "MAX-AGE"
				И ИмяЭлементаSetCookie <> "EXPIRES" И ИмяЭлементаSetCookie <> "DOMAIN" И ИмяЭлементаSetCookie <> "SECURE"
				И ИмяЭлементаSetCookie <> "VERSION" И ИмяЭлементаSetCookie <> "COMMENT" И ИмяЭлементаSetCookie <> "COMMENTURL"
				И ИмяЭлементаSetCookie <> "DISCARD" И ИмяЭлементаSetCookie <> "PORT"
				И ЗначениеЭлементаSetCookie <> "" И ЗначениеЭлементаSetCookie <> """""" Тогда
				
				// Поиск элемента по ЗначениеCookie
				ПредыдущаяПозицияCookie = 1;
				ЭлементSetCookieНайден = Ложь;
				
				ПозицияCookie = 1;
				Пока ПозицияCookie <= СтрДлина(Результат) + 1 Цикл
					
					Если ПозицияCookie > СтрДлина(Результат) ИЛИ Сред(Результат, ПозицияCookie, 1) = ";" Тогда
						
						ЭлементCookie = СокрЛП(Сред(Результат, ПредыдущаяПозицияCookie, ПозицияCookie - ПредыдущаяПозицияCookie));
						ИмяЭлементаCookie = ЭлементCookie;
						ПозицияРазделителя = Найти(ЭлементCookie, "=");
						Если ПозицияРазделителя > 0 Тогда
							ИмяЭлементаCookie = СокрП(Лев(ЭлементCookie, ПозицияРазделителя - 1));
						КонецЕсли;
						ИмяЭлементаCookie = ВРег(ИмяЭлементаCookie);
						
						Если ИмяЭлементаCookie = ИмяЭлементаSetCookie Тогда
							
							Результат = Лев(Результат, ПредыдущаяПозицияCookie - 1) + ЭлементSetCookie + Сред(Результат, ПозицияCookie);
							
							ПриростДлиныCookie = СтрДлина(ЭлементSetCookie) - (ПозицияCookie - ПредыдущаяПозицияCookie);
							ПозицияCookie = ПозицияCookie + ПриростДлиныCookie;
							
							ЭлементSetCookieНайден = Истина;
							
						КонецЕсли;
						
						ПредыдущаяПозицияCookie = ПозицияCookie + 1;
						
					КонецЕсли;
					
					ПозицияCookie = ПозицияCookie + 1;
					
				КонецЦикла;
				
				Если НЕ ЭлементSetCookieНайден Тогда
					
					РазделительВКонце = (Прав(СокрП(Результат), 1) = ";");
					Результат = Результат + ?(ПустаяСтрока(Результат) ИЛИ РазделительВКонце, "", ";") + ЭлементSetCookie;
					
				КонецЕсли;
				
			КонецЕсли;
			
			ПредыдущаяПозицияSetCookie = ПозицияSetCookie + 1;
			
		КонецЕсли;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ДатаИзСтрокиРазныхФорматов(СтрокаДаты)
	
	Результат = СокрЛП(СтрокаДаты);
	
	Попытка
		Возврат Дата(Результат);
	Исключение
	КонецПопытки;
	
	ЧисловаяДата = ТекстПослеПрефикса(Результат, "\/Date(", ")\/");
	Если ЧисловаяДата <> Неопределено Тогда
		Попытка
			Возврат '00010101000000' + Число(ЧисловаяДата) / 1000 + ('19700101000000' - '00010101000000');
		Исключение
		КонецПопытки;
	КонецЕсли;
	
	Если СтрДлина(Результат) = 10 Тогда
		Результат = Результат + " 00:00:00";
		
	ИначеЕсли СтрДлина(Результат) = 16 Тогда
		Результат = Результат + ":00"
	КонецЕсли;
	
	Если (СтрДлина(Результат) = 19 ИЛИ СтрДлина(Результат) = 23) И Сред(Результат, 11, 1) = " " И
		(Сред(Результат, 14, 1) = ":" ИЛИ Сред(Результат, 14, 1) = ".") И (Сред(Результат, 17, 1) = ":" ИЛИ Сред(Результат, 17, 1) = ".") Тогда
		
		Если (Сред(Результат, 3, 1) = "." ИЛИ Сред(Результат, 3, 1) = "-") И (Сред(Результат, 6, 1) = "." ИЛИ Сред(Результат, 6, 1) = "-") Тогда
			Результат = Сред(Результат, 7, 4) + Сред(Результат, 4, 2) + Сред(Результат, 1, 2) + Сред(Результат, 12, 2) + Сред(Результат, 15, 2) + Сред(Результат, 18, 2);
			
		ИначеЕсли (Сред(Результат, 5, 1) = "." ИЛИ Сред(Результат, 5, 1) = "-") И (Сред(Результат, 8, 1) = "." ИЛИ Сред(Результат, 8, 1) = "-") Тогда
			Результат = Сред(Результат, 1, 4) + Сред(Результат, 6, 2) + Сред(Результат, 9, 2) + Сред(Результат, 12, 2) + Сред(Результат, 15, 2) + Сред(Результат, 18, 2);
		КонецЕсли;
		
	КонецЕсли;
	
	Попытка
		Возврат Дата(Результат);
	Исключение
	КонецПопытки;
	
	Возврат СтрокаДаты;
	
КонецФункции

// Вторичное заявление на подключение к 1С-Отчетности  
//

Функция ИзменившиесяПараметрыПодключенияИHTMLДокумент(СтруктураПараметров) Экспорт
	
	КоличествоДнейЗаКотороеВыполнятьПредупреждениеОбИстеченииСроков = 30;
	РеквизитHTMLДокументаСообщение = "";
	
	ТекДата = ТекущаяДатаСеанса();
	ДатаИстечения = ТекДата + КоличествоДнейЗаКотороеВыполнятьПредупреждениеОбИстеченииСроков * 24 * 60 * 60;
	
	ОтпечаткиИменаДатыСертификатов = СтруктураПараметров.ОтпечаткиИменаДатыСертификатов;
	
	ИгнорироватьДатуПоследнегоОтображения = Ложь;
	
	// Сертификаты
	ИстекающиеСертификатыУчетныхЗаписей = СертификатыУчетныхЗаписейПользователяСОрганизациями(Пользователи.ТекущийПользователь());
	ОставитьТолькоИстекающиеСертификатыХранилища(ИстекающиеСертификатыУчетныхЗаписей, ОтпечаткиИменаДатыСертификатов, ТекДата, ДатаИстечения, ИгнорироватьДатуПоследнегоОтображения);
	
	// Лицензии
	ИстекающиеЛицензии = ЛицензииУчетныхЗаписейПользователяСОрганизациями(Пользователи.ТекущийПользователь());
	ОставитьТолькоИстекающиеЛицензииХранилища(ИстекающиеЛицензии, ТекДата, ДатаИстечения, ИгнорироватьДатуПоследнегоОтображения);
	
	// Изменившиеся параметры подключения 
	ИзменившиесяРеквизитыОрганизаций = ИзменившиесяРеквизитыУчетнойЗаписи(Пользователи.ТекущийПользователь());
	ОставитьТолькоИзменившиесяРеквизитыТребующиеНапоминания(ИзменившиесяРеквизитыОрганизаций, ТекДата, ИгнорироватьДатуПоследнегоОтображения);
	
	// Объединение данных об истекающих сертификатах, лицензиях, измененных параметрах в одну таблицу
	ИзменившиесяПараметрыПодключения = ОбъединитьТриТаблицыВОдну(ИстекающиеСертификатыУчетныхЗаписей, ИстекающиеЛицензии, ИзменившиесяРеквизитыОрганизаций);
	
	// Добавляем колонку с признаком поддержки вторичных заявлений
	ОпределитьДляКаждойОрганизацииВозможностьПоддержкиВторичныхЗаявлений(ИзменившиесяПараметрыПодключения);
	
	РеквизитHTMLДокументаСообщение = "";
	Если ИзменившиесяПараметрыПодключения.Количество() > 0 Тогда
		
		ТекстМакета = ПолучитьМакет("ПредупреждениеОбИстеченииСпискаСертификатов").ПолучитьТекст();
		ТекстМакета = СформироватьТекстПредупрежденияОбИзменившихсяПараметрахПодключения(ИзменившиесяПараметрыПодключения, ТекстМакета);
		РеквизитHTMLДокументаСообщение = ТекстМакета;
		
	КонецЕсли;
	
	ВозвращаемыеПараметры = Новый Структура();
	ВозвращаемыеПараметры.Вставить("РеквизитHTMLДокументаСообщение", РеквизитHTMLДокументаСообщение);
	ВозвращаемыеПараметры.Вставить("ИзменившиесяПараметрыПодключения", ИзменившиесяПараметрыПодключения);
	
	Возврат ВозвращаемыеПараметры;
	
КонецФункции

Функция ИзменилсяСоставРеквизитов(ИзменившиесяРеквизиты, ИзменившиесяРеквизитыИзХранилища)
	
	СоставИзменился = Ложь;
	
	Если ИзменившиесяРеквизиты = Неопределено И ИзменившиесяРеквизитыИзХранилища <> Неопределено
		ИЛИ ИзменившиесяРеквизиты <> Неопределено И ИзменившиесяРеквизитыИзХранилища = Неопределено Тогда
		// Если один из списков пустой
		СоставИзменился = Истина;
	ИначеЕсли ИзменившиесяРеквизиты.Количество() <> ИзменившиесяРеквизитыИзХранилища.Количество() Тогда
		// Если количество элементов различно
		СоставИзменился = Истина;
	Иначе
		// Если количество элементов одинаково
		Для каждого ИзменившийсяРеквизит Из ИзменившиесяРеквизиты Цикл
			НайденныйИзменившийсяРеквизит = ИзменившиесяРеквизитыИзХранилища.НайтиПоЗначению(ИзменившийсяРеквизит.Значение);
			Если НайденныйИзменившийсяРеквизит = Неопределено Тогда 
				СоставИзменился = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Возврат СоставИзменился;
	
КонецФункции

Функция ИзменившиесяРеквизитыУчетнойЗаписи(Пользователь)
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	                      |	Организации.Ссылка КАК Организация,
	                      |	УчетныеЗаписиДокументооборота.Ссылка КАК УчетнаяЗаписьДокументооборота
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.УчетныеЗаписиДокументооборота КАК УчетныеЗаписиДокументооборота
	                      |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПользователиУчетныхЗаписейДокументооборота КАК ПользователиУчетныхЗаписейДокументооборота
	                      |			ПО УчетныеЗаписиДокументооборота.Ссылка = ПользователиУчетныхЗаписейДокументооборота.УчетнаяЗапись
	                      |		ПО Организации.УчетнаяЗаписьОбмена = УчетныеЗаписиДокументооборота.Ссылка
	                      |ГДЕ
	                      |	ПользователиУчетныхЗаписейДокументооборота.Пользователь = &Пользователь
						  |	И Организации.ВидОбменаСКонтролирующимиОрганами = &ОбменВУниверсальномФормате
	                      |	И НЕ УчетныеЗаписиДокументооборота.ПометкаУдаления
	                      |	И Организации.ПометкаУдаления = ЛОЖЬ");
						  
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	Запрос.УстановитьПараметр("ОбменВУниверсальномФормате", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	ИзменившиесяРеквизитыОрганизаций = Запрос.Выполнить().Выгрузить();
	ИзменившиесяРеквизитыОрганизаций.Колонки.Добавить("СписокИзменившихсяРеквизитов");
	ИзменившиесяРеквизитыОрганизаций.Колонки.Добавить("ПредставлениеИзменившихсяРеквизитов", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(300)));
	
	
	Для каждого ИзменившиесяРеквизитыОрганизации Из ИзменившиесяРеквизитыОрганизаций Цикл
		ДобавитьВТаблицуСписокИзменившихсяРеквизитовПодключенияК1СОтчетности(ИзменившиесяРеквизитыОрганизации);
	КонецЦикла; 
		
	Возврат ИзменившиесяРеквизитыОрганизаций;
	
КонецФункции

Функция ОбъединитьТриТаблицыВОдну(ИстекающиеСертификатыУчетныхЗаписей, ИстекающиеЛицензии, ИзменившиесяРеквизитыОрганизаций)
	
	// Исключение из стандарта 282.
	// Возможны одинаковые записи, требуется их исключение из результатов запроса
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	ТекстЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	 |	ИстекающиеСертификатыУчетныхЗаписей.Организация КАК Организация,
	 |	ИстекающиеСертификатыУчетныхЗаписей.УчетнаяЗаписьДокументооборота КАК УчетнаяЗаписьДокументооборота,
	 |	ИстекающиеСертификатыУчетныхЗаписей.НаименованиеСертификата КАК НаименованиеСертификата,
	 |	ИстекающиеСертификатыУчетныхЗаписей.СертификатДействителенПо КАК СертификатДействителенПо,
	 |	ИстекающиеСертификатыУчетныхЗаписей.ОтпечатокСертификата КАК ОтпечатокСертификата
	 |ПОМЕСТИТЬ ИстекающиеСертификатыУчетныхЗаписей 
	 |ИЗ 
	 |	&ИстекающиеСертификатыУчетныхЗаписей КАК ИстекающиеСертификатыУчетныхЗаписей;
	 |
	 |ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	 |	ИстекающиеЛицензии.Организация КАК Организация,
	 |	ИстекающиеЛицензии.УчетнаяЗаписьДокументооборота КАК УчетнаяЗаписьДокументооборота,
	 |	ИстекающиеЛицензии.ЛицензияНаименование КАК ЛицензияНаименование,
	 |	ИстекающиеЛицензии.ЛицензияДатаОкончания КАК ЛицензияДатаОкончания
 	 |ПОМЕСТИТЬ ИстекающиеЛицензии 
	 |ИЗ 
	 |	&ИстекающиеЛицензии КАК ИстекающиеЛицензии;
	 |
	 |ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	 |	ИзменившиесяРеквизитыОрганизаций.Организация КАК Организация,
	 |	ИзменившиесяРеквизитыОрганизаций.УчетнаяЗаписьДокументооборота КАК УчетнаяЗаписьДокументооборота,
	 |	ИзменившиесяРеквизитыОрганизаций.ПредставлениеИзменившихсяРеквизитов КАК ПредставлениеИзменившихсяРеквизитов
	 |ПОМЕСТИТЬ ИзменившиесяРеквизитыОрганизаций 
	 |ИЗ 
	 |	&ИзменившиесяРеквизитыОрганизаций КАК ИзменившиесяРеквизитыОрганизаций;
	 |
	 |ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	 |	Организация,
	 |	УчетнаяЗаписьДокументооборота
	 |ПОМЕСТИТЬ УчетныеЗаписиОрганизаций
	 |ИЗ
	 |	ИстекающиеСертификатыУчетныхЗаписей
	 |
	 |ОБЪЕДИНИТЬ
	 |
	 |ВЫБРАТЬ РАЗЛИЧНЫЕ
	 |	Организация,
	 |	УчетнаяЗаписьДокументооборота
	 |ИЗ
	 |	ИстекающиеЛицензии
	 |
	 |ОБЪЕДИНИТЬ
	 |
	 |ВЫБРАТЬ РАЗЛИЧНЫЕ
	 |	Организация,
	 |	УчетнаяЗаписьДокументооборота
	 |ИЗ
	 |	ИзменившиесяРеквизитыОрганизаций;
	 |
	 |ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	 |	УчетныеЗаписиОрганизаций.Организация,
	 |	УчетныеЗаписиОрганизаций.УчетнаяЗаписьДокументооборота,
	 |	ИстекающиеСертификатыУчетныхЗаписей.ОтпечатокСертификата КАК ОтпечатокСертификата,
	 |	ИстекающиеСертификатыУчетныхЗаписей.НаименованиеСертификата КАК НаименованиеСертификата,
	 |	ИстекающиеСертификатыУчетныхЗаписей.СертификатДействителенПо КАК СертификатДействителенПо,
	 |	ИстекающиеЛицензии.ЛицензияНаименование КАК ЛицензияНаименование,
	 |	ИстекающиеЛицензии.ЛицензияДатаОкончания КАК ЛицензияДатаОкончания,
	 |	ИзменившиесяРеквизитыОрганизаций.ПредставлениеИзменившихсяРеквизитов КАК ПредставлениеИзменившихсяРеквизитов
	 |ИЗ
	 |	УчетныеЗаписиОрганизаций КАК УчетныеЗаписиОрганизаций
	 |	ЛЕВОЕ СОЕДИНЕНИЕ ИстекающиеСертификатыУчетныхЗаписей КАК ИстекающиеСертификатыУчетныхЗаписей
	 |	ПО УчетныеЗаписиОрганизаций.Организация = ИстекающиеСертификатыУчетныхЗаписей.Организация
	 |	И УчетныеЗаписиОрганизаций.УчетнаяЗаписьДокументооборота = ИстекающиеСертификатыУчетныхЗаписей.УчетнаяЗаписьДокументооборота
	 |	ЛЕВОЕ СОЕДИНЕНИЕ ИстекающиеЛицензии КАК ИстекающиеЛицензии
	 |	ПО УчетныеЗаписиОрганизаций.Организация = ИстекающиеЛицензии.Организация
	 |	И УчетныеЗаписиОрганизаций.УчетнаяЗаписьДокументооборота = ИстекающиеЛицензии.УчетнаяЗаписьДокументооборота
	 |	ЛЕВОЕ СОЕДИНЕНИЕ ИзменившиесяРеквизитыОрганизаций КАК ИзменившиесяРеквизитыОрганизаций
	 |	ПО УчетныеЗаписиОрганизаций.Организация = ИзменившиесяРеквизитыОрганизаций.Организация
	 |	И УчетныеЗаписиОрганизаций.УчетнаяЗаписьДокументооборота = ИзменившиесяРеквизитыОрганизаций.УчетнаяЗаписьДокументооборота
	 |УПОРЯДОЧИТЬ ПО
	 |	УчетныеЗаписиОрганизаций.Организация";
	 
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("ИстекающиеСертификатыУчетныхЗаписей", ИстекающиеСертификатыУчетныхЗаписей);
	Запрос.УстановитьПараметр("ИстекающиеЛицензии", ИстекающиеЛицензии);
	Запрос.УстановитьПараметр("ИзменившиесяРеквизитыОрганизаций", ИзменившиесяРеквизитыОрганизаций);
	Результат = Запрос.Выполнить().Выгрузить();
	
	// Добавляем в результирующую таблицу колонку СписокИзменившихсяРеквизитов и заполняем ее 
	Результат.Колонки.Добавить("СписокИзменившихсяРеквизитов");
	Для каждого СтрокаРезультата Из Результат Цикл
		Отбор = Новый Структура();
		Отбор.Вставить("Организация", СтрокаРезультата.Организация);
		Отбор.Вставить("УчетнаяЗаписьДокументооборота", СтрокаРезультата.УчетнаяЗаписьДокументооборота);
		
		НайденныеСтроки = ИзменившиесяРеквизитыОрганизаций.НайтиСтроки(Отбор);
		
		Если НайденныеСтроки.Количество() > 0 Тогда 
			СтрокаРезультата.СписокИзменившихсяРеквизитов = НайденныеСтроки[0].СписокИзменившихсяРеквизитов;
		КонецЕсли;
	КонецЦикла; 
	
	Возврат Результат;
	
КонецФункции

Функция СертификатыУчетныхЗаписейПользователяСОрганизациями(Пользователь)
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	                      |	Организации.Ссылка КАК Организация,
	                      |	УчетныеЗаписиДокументооборота.Ссылка КАК УчетнаяЗаписьДокументооборота,
	                      |	УчетныеЗаписиДокументооборота.СертификатРуководителя КАК СертификатРуководителя
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.УчетныеЗаписиДокументооборота КАК УчетныеЗаписиДокументооборота
	                      |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПользователиУчетныхЗаписейДокументооборота КАК ПользователиУчетныхЗаписейДокументооборота
	                      |			ПО УчетныеЗаписиДокументооборота.Ссылка = ПользователиУчетныхЗаписейДокументооборота.УчетнаяЗапись
	                      |		ПО Организации.УчетнаяЗаписьОбмена = УчетныеЗаписиДокументооборота.Ссылка
	                      |ГДЕ
	                      |	ПользователиУчетныхЗаписейДокументооборота.Пользователь = &Пользователь
						  |	И Организации.ВидОбменаСКонтролирующимиОрганами = &ОбменВУниверсальномФормате
	                      |	И НЕ УчетныеЗаписиДокументооборота.ПометкаУдаления
	                      |	И Организации.ПометкаУдаления = ЛОЖЬ");
						  
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	Запрос.УстановитьПараметр("ОбменВУниверсальномФормате", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	
	Результат = Новый ТаблицаЗначений;
	Результат.Колонки.Добавить("УчетнаяЗаписьДокументооборота", Новый ОписаниеТипов("СправочникСсылка.УчетныеЗаписиДокументооборота"));
	Результат.Колонки.Добавить("ОтпечатокСертификата", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(40)));
	Результат.Колонки.Добавить("Организация", Новый ОписаниеТипов("СправочникСсылка.Организации"));
	
	Попытка
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			СертификатРуководителя 	= нрег(СокрЛП(Выборка.СертификатРуководителя));
			
			Если НЕ ПустаяСтрока(СертификатРуководителя) Тогда
				
				НоваяСтрокаРезультата = Результат.Добавить();
				НоваяСтрокаРезультата.УчетнаяЗаписьДокументооборота = Выборка.УчетнаяЗаписьДокументооборота;
				НоваяСтрокаРезультата.ОтпечатокСертификата 			= СертификатРуководителя;
				НоваяСтрокаРезультата.Организация 					= Выборка.Организация;
				
			КонецЕсли;
			
		КонецЦикла;
		
	Исключение
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

Функция ЛицензииУчетныхЗаписейПользователяСОрганизациями(Пользователь)
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	                      |	Организации.Ссылка КАК Организация,
	                      |	УчетныеЗаписиДокументооборота.Ссылка КАК УчетнаяЗаписьДокументооборота,
	                      |	УчетныеЗаписиДокументооборота.ЛицензияНаименование КАК ЛицензияНаименование,
	                      |	УчетныеЗаписиДокументооборота.ЛицензияДатаОкончания КАК ЛицензияДатаОкончания
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.УчетныеЗаписиДокументооборота КАК УчетныеЗаписиДокументооборота
	                      |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПользователиУчетныхЗаписейДокументооборота КАК ПользователиУчетныхЗаписейДокументооборота
	                      |			ПО УчетныеЗаписиДокументооборота.Ссылка = ПользователиУчетныхЗаписейДокументооборота.УчетнаяЗапись
	                      |		ПО Организации.УчетнаяЗаписьОбмена = УчетныеЗаписиДокументооборота.Ссылка
	                      |ГДЕ
	                      |	ПользователиУчетныхЗаписейДокументооборота.Пользователь = &Пользователь
	                      |	И НЕ УчетныеЗаписиДокументооборота.ПометкаУдаления
	                      |	И УчетныеЗаписиДокументооборота.ЛицензияТребуетсяНапоминаниеОбОкончанииСрокаДействия = ИСТИНА
	                      |	И УчетныеЗаписиДокументооборота.ЛицензияДатаОкончания <> ДАТАВРЕМЯ(1, 1, 1)
						  |	И Организации.ВидОбменаСКонтролирующимиОрганами = &ОбменВУниверсальномФормате
	                      |	И Организации.ПометкаУдаления = ЛОЖЬ");
						  
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	Запрос.УстановитьПараметр("ОбменВУниверсальномФормате", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	
	Результат = Запрос.Выполнить().Выгрузить();
		
	Возврат Результат;
	
КонецФункции

Функция ЗаявлениеАбонентаДляЗаменыСертификатаБылоСоздано(ОтпечатокСертификата, ДатаОтсчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ЗаявлениеАбонентаСпецоператораСвязи.Ссылка
		|ИЗ
		|	Документ.ЗаявлениеАбонентаСпецоператораСвязи.ИзменившиесяРеквизитыВторичногоЗаявления КАК ЗаявлениеАбонентаСпецоператораСвязи
		|ГДЕ
		|	ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.ТипЗаявления = &ТипЗаявления
		|	И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.Статус = &Статус
		|	И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.УчетнаяЗапись.СертификатРуководителя = &ОтпечатокСертификата
		|	И РАЗНОСТЬДАТ(НАЧАЛОПЕРИОДА(ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.Дата, ДЕНЬ), НАЧАЛОПЕРИОДА(&ДатаОтсчета, ДЕНЬ), ДЕНЬ) <= 10
		|	И ЗаявлениеАбонентаСпецоператораСвязи.ИзмененныйРеквизит = &ИзмененныйРеквизит";

	Запрос.УстановитьПараметр("ОтпечатокСертификата", ОтпечатокСертификата);
	Запрос.УстановитьПараметр("Статус", Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Отправлено);
	Запрос.УстановитьПараметр("ТипЗаявления", Перечисления.ТипыЗаявленияАбонентаСпецоператораСвязи.Изменение);
	Запрос.УстановитьПараметр("ДатаОтсчета", ДатаОтсчета);
	Запрос.УстановитьПараметр("ИзмененныйРеквизит", Перечисления.ПараметрыПодключенияК1СОтчетности.ПереизданиеСертификата);

	Результат = Запрос.Выполнить();
 	ЗаявленияАбонентаСпецоператораСвязи = Результат.Выбрать();

	Если ЗаявленияАбонентаСпецоператораСвязи.Количество() = 0 Тогда
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;
	
КонецФункции

Функция ЗаявлениеАбонентаДляПродленияЛицензииБылоСоздано(УчетнаяЗапись, ЛицензияНаименование, ЛицензияДатаОкончания, ДатаОтсчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ЗаявлениеАбонентаСпецоператораСвязи.Ссылка
		|ИЗ
		|	Документ.ЗаявлениеАбонентаСпецоператораСвязи.ИзменившиесяРеквизитыВторичногоЗаявления КАК ЗаявлениеАбонентаСпецоператораСвязи
		|ГДЕ
		|	ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.ТипЗаявления = &ТипЗаявления
		|	И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.Статус = &Статус
		|	И РАЗНОСТЬДАТ(НАЧАЛОПЕРИОДА(ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.Дата, ДЕНЬ), НАЧАЛОПЕРИОДА(&ДатаОтсчета, ДЕНЬ), ДЕНЬ) <= 10
		|	И ЗаявлениеАбонентаСпецоператораСвязи.ИзмененныйРеквизит = &ИзмененныйРеквизит
		|	И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.УчетнаяЗапись = &УчетнаяЗапись
		|	И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.УчетнаяЗапись.ЛицензияНаименование = &ЛицензияНаименование
		|	И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.УчетнаяЗапись.ЛицензияТребуетсяНапоминаниеОбОкончанииСрокаДействия = ИСТИНА
		|	И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.УчетнаяЗапись.ЛицензияДатаОкончания = &ЛицензияДатаОкончания";

	Запрос.УстановитьПараметр("Статус", Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Отправлено);
	Запрос.УстановитьПараметр("ТипЗаявления", Перечисления.ТипыЗаявленияАбонентаСпецоператораСвязи.Изменение);
	Запрос.УстановитьПараметр("ДатаОтсчета", ДатаОтсчета);
	Запрос.УстановитьПараметр("ИзмененныйРеквизит", Перечисления.ПараметрыПодключенияК1СОтчетности.ПродлениеЛицензии);
	Запрос.УстановитьПараметр("УчетнаяЗапись", УчетнаяЗапись);
	Запрос.УстановитьПараметр("ЛицензияНаименование", ЛицензияНаименование);
	Запрос.УстановитьПараметр("ЛицензияДатаОкончания", ЛицензияДатаОкончания);

	Результат = Запрос.Выполнить();
 	ЗаявленияАбонентаСпецоператораСвязи = Результат.Выбрать();

	Если ЗаявленияАбонентаСпецоператораСвязи.Количество() = 0 Тогда
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;
	
КонецФункции

Функция ЗаявлениеАбонентаДляОбновленияРеквизитовБылоСоздано(УчетнаяЗапись, СписокИзменившихсяРеквизитов, ДатаОтсчета)
	
	Если СписокИзменившихсяРеквизитов = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	МассивИзменившихсяРеквизитов = Новый Массив;
	Для каждого ИзменившийсяРеквизит Из СписокИзменившихсяРеквизитов Цикл
		МассивИзменившихсяРеквизитов.Добавить(ИзменившийсяРеквизит.Значение);
	КонецЦикла; 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ЗаявлениеАбонентаСпецоператораСвязи.ИзмененныйРеквизит) КАК ИзмененныйРеквизит
		|ИЗ
		|	(ВЫБРАТЬ
		|		ЗаявлениеАбонентаСпецоператораСвязи.ИзмененныйРеквизит КАК ИзмененныйРеквизит
		|	ИЗ
		|		Документ.ЗаявлениеАбонентаСпецоператораСвязи.ИзменившиесяРеквизитыВторичногоЗаявления КАК ЗаявлениеАбонентаСпецоператораСвязи
		|	ГДЕ
		|		ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.ТипЗаявления = &ТипЗаявления
		|		И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.Статус = &Статус
		|		И РАЗНОСТЬДАТ(НАЧАЛОПЕРИОДА(ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.Дата, ДЕНЬ), НАЧАЛОПЕРИОДА(&ДатаОтсчета, ДЕНЬ), ДЕНЬ) <= 10
		|		И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.УчетнаяЗапись = &УчетнаяЗапись
		|		И ЗаявлениеАбонентаСпецоператораСвязи.Ссылка.ПометкаУдаления = ЛОЖЬ) КАК ЗаявлениеАбонентаСпецоператораСвязи
		|ГДЕ
		|	ЗаявлениеАбонентаСпецоператораСвязи.ИзмененныйРеквизит В(&МассивИзменившихсяРеквизитов)
		|
		|ИМЕЮЩИЕ
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ ЗаявлениеАбонентаСпецоператораСвязи.ИзмененныйРеквизит) >= &КоличествоИзменившихсяРеквизитов";

	Запрос.УстановитьПараметр("Статус", Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Отправлено);
	Запрос.УстановитьПараметр("ТипЗаявления", Перечисления.ТипыЗаявленияАбонентаСпецоператораСвязи.Изменение);
	Запрос.УстановитьПараметр("ДатаОтсчета", ДатаОтсчета);
	Запрос.УстановитьПараметр("МассивИзменившихсяРеквизитов", МассивИзменившихсяРеквизитов);
	Запрос.УстановитьПараметр("КоличествоИзменившихсяРеквизитов", МассивИзменившихсяРеквизитов.Количество());
	Запрос.УстановитьПараметр("УчетнаяЗапись", УчетнаяЗапись);

	Результат = Запрос.Выполнить();
 	ЗаявленияАбонентаСпецоператораСвязи = Результат.Выбрать();

	Если ЗаявленияАбонентаСпецоператораСвязи.Количество() = 0 Тогда
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;
	
КонецФункции

Процедура ОставитьТолькоИзменившиесяРеквизитыТребующиеНапоминания(ИзменившиесяРеквизитыОрганизаций, ДатаОтсчета, ИгнорироватьДатуПоследнегоОтображения = Ложь) Экспорт

	// Достаем из хранилища общих настроек информацию о предыдущих показах этого предупреждения
	ДатыНапоминанийПоИзменившимсяРеквизитам = ХранилищеОбщихНастроек.Загрузить("ДокументооборотСКонтролирующимиОрганами_ДатыНапоминанийПоИзменившимсяРеквизитам");
	
	// Если приедыдущих показов предупреждений не было, то создаем пустую таблицу 
	Если ДатыНапоминанийПоИзменившимсяРеквизитам = Неопределено ИЛИ ИгнорироватьДатуПоследнегоОтображения Тогда
		
		ДатыНапоминанийПоИзменившимсяРеквизитам = Новый ТаблицаЗначений;
		ДатыНапоминанийПоИзменившимсяРеквизитам.Колонки.Добавить("Организация");
		ДатыНапоминанийПоИзменившимсяРеквизитам.Колонки.Добавить("УчетнаяЗапись");
		ДатыНапоминанийПоИзменившимсяРеквизитам.Колонки.Добавить("СписокИзменившихсяРеквизитов");
		ДатыНапоминанийПоИзменившимсяРеквизитам.Колонки.Добавить("ДатаНапоминания");
		
	КонецЕсли;
	
	ИндексТекущейСтроки = ИзменившиесяРеквизитыОрганизаций.Количество() - 1;
	НачальныйИндексТекущейСтроки = 0;
	
	Пока ИндексТекущейСтроки >= НачальныйИндексТекущейСтроки Цикл
		
		ИзменившиесяРеквизитыОрганизации = ИзменившиесяРеквизитыОрганизаций[ИндексТекущейСтроки];
		ТребуетсяНапоминание = Ложь;
		
		ДатаНапоминанияПоИзмененнымРеквизитам = Неопределено;
		
		ПоддерживаетсяВторичноеЗаявление = ПоддерживаетсяВторичноеЗаявление(ИзменившиесяРеквизитыОрганизации.Организация);
		Если НЕ ПоддерживаетсяВторичноеЗаявление Тогда
			ТребуетсяНапоминание = Ложь;
		ИначеЕсли ЗначениеЗаполнено(ИзменившиесяРеквизитыОрганизации.СписокИзменившихсяРеквизитов) Тогда
			
			// Было ли раньше показано напоминание ?
			Отбор = Новый Структура; 
			Отбор.Вставить("Организация", ИзменившиесяРеквизитыОрганизации.Организация);
			Отбор.Вставить("УчетнаяЗапись", ИзменившиесяРеквизитыОрганизации.УчетнаяЗаписьДокументооборота);
			СтрокиДатыНапоминанияПоИзменившимсяРеквизитам = ДатыНапоминанийПоИзменившимсяРеквизитам.НайтиСтроки(Отбор);
			Если СтрокиДатыНапоминанияПоИзменившимсяРеквизитам.Количество() > 0 Тогда
				СтрокаДатыНапоминанияПоИзменившимсяРеквизитам = СтрокиДатыНапоминанияПоИзменившимсяРеквизитам[0];
				ДатаНапоминанияПоИзмененнымРеквизитам = СтрокаДатыНапоминанияПоИзменившимсяРеквизитам.ДатаНапоминания;
			Иначе
				СтрокаДатыНапоминанияПоИзменившимсяРеквизитам = Неопределено;
			КонецЕсли;
			
			// Проверяем, отправлялось ли заявление для обновления этих реквизитов
			ЗаявлениеАбонентаДляОбновленияРеквизитовБылоСоздано = ЗаявлениеАбонентаДляОбновленияРеквизитовБылоСоздано(
					ИзменившиесяРеквизитыОрганизации.УчетнаяЗаписьДокументооборота, ИзменившиесяРеквизитыОрганизации.СписокИзменившихсяРеквизитов, ДатаОтсчета);
			
			// Определяем, нужно ли показывать предупреждения
			Если ДатаНапоминанияПоИзмененнымРеквизитам = Неопределено Тогда
				// Напоминания раньше не было
				ТребуетсяНапоминание = Истина;
			ИначеЕсли ДатаНапоминанияПоИзмененнымРеквизитам <= ДатаОтсчета И ЗначениеЗаполнено(ДатаНапоминанияПоИзмененнымРеквизитам) Тогда 
				// напоминание не откладывали навседа
				Если НЕ ЗаявлениеАбонентаДляОбновленияРеквизитовБылоСоздано Тогда
					ТребуетсяНапоминание = Истина;
				КонецЕсли;
			Иначе
				// Проверяем, изменился ли состав измененных реквизитов с момента прошлого показа предупреждения
				ИзменилсяСоставРеквизитов = ИзменилсяСоставРеквизитов(ИзменившиесяРеквизитыОрганизации.СписокИзменившихсяРеквизитов, 
						СтрокаДатыНапоминанияПоИзменившимсяРеквизитам.СписокИзменившихсяРеквизитов);
						
				// Если пользователь отложил навсегда показ предупреждения, но состав реквизитов изменился, то 
				// предупреждение показываем все равно.
				Если ИзменилсяСоставРеквизитов И НЕ ЗаявлениеАбонентаДляОбновленияРеквизитовБылоСоздано Тогда
					ТребуетсяНапоминание = Истина;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если НЕ ТребуетсяНапоминание Тогда
			// Если напоминание не требуется, то удаляем из таблицы эту строку
			ИзменившиесяРеквизитыОрганизации = Неопределено;
			ИзменившиесяРеквизитыОрганизаций.Удалить(ИндексТекущейСтроки);
		Иначе
			// Заполняем представление на основе списка изменившихся реквизитов
			ИзменившиесяРеквизитыОрганизации.ПредставлениеИзменившихсяРеквизитов = ПредставлениеИзменившихсяРеквизитов(
				ИзменившиесяРеквизитыОрганизации.СписокИзменившихсяРеквизитов);
		КонецЕсли;
		
		ИндексТекущейСтроки = ИндексТекущейСтроки - 1;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ОставитьТолькоИстекающиеЛицензииХранилища(ЛицензииУчетныхЗаписейПользователя, ДатаОтсчета, ДатаИстечения, ИгнорироватьДатуПоследнегоОтображения = Ложь)
	
	ДатыНапоминанийПоИстекающимЛицензиям = ХранилищеОбщихНастроек.Загрузить("ДокументооборотСКонтролирующимиОрганами_ДатыНапоминанийПоИстекающимЛицензиям");
	
	Если ДатыНапоминанийПоИстекающимЛицензиям = Неопределено ИЛИ ИгнорироватьДатуПоследнегоОтображения Тогда
		
		ДатыНапоминанийПоИстекающимЛицензиям = Новый ТаблицаЗначений;
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("Организация");
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("УчетнаяЗапись");
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("ЛицензияНаименование");
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("ЛицензияДатаОкончания");
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("ДатаНапоминания");
		
	КонецЕсли;
	
	ИндексТекущейСтроки = ЛицензииУчетныхЗаписейПользователя.Количество() - 1;
	НачальныйИндексТекущейСтроки = 0;
	
	Пока ИндексТекущейСтроки >= НачальныйИндексТекущейСтроки Цикл
		
		ЛицензияУчетнойЗаписиПользователя = ЛицензииУчетныхЗаписейПользователя[ИндексТекущейСтроки];
		ЕстьПросроченные = Ложь;
		ТребуетсяНапоминание = Ложь;
		
		// Подходит срок окончания лицензии
		ПоддерживаетсяВторичноеЗаявление = ПоддерживаетсяВторичноеЗаявление(ЛицензияУчетнойЗаписиПользователя.Организация);
		Если НЕ ПоддерживаетсяВторичноеЗаявление Тогда
			ТребуетсяНапоминание = Ложь;
		ИначеЕсли РазницаДатВМесяцах(ТекущаяДатаСеанса(), ЛицензияУчетнойЗаписиПользователя.ЛицензияДатаОкончания) > 13 Тогда
			ТребуетсяНапоминание = Ложь;
		ИначеЕсли ЛицензияУчетнойЗаписиПользователя.ЛицензияДатаОкончания <= ДатаИстечения Тогда
			
			ДатаНапоминанияПоИстекшейЛицензии = Неопределено;
			
			// Было ли раньше показано напоминание?
			// Ищем среди лицензий, сохраненных в хранилище по наименованию и окончнию лицензии
			ПараметрыОтбора =  Новый Структура();
			ПараметрыОтбора.Вставить("Организация", ЛицензияУчетнойЗаписиПользователя.Организация);
			ПараметрыОтбора.Вставить("УчетнаяЗапись", ЛицензияУчетнойЗаписиПользователя.УчетнаяЗаписьДокументооборота);
			ПараметрыОтбора.Вставить("ЛицензияНаименование", ЛицензияУчетнойЗаписиПользователя.ЛицензияНаименование);
			ПараметрыОтбора.Вставить("ЛицензияДатаОкончания", ЛицензияУчетнойЗаписиПользователя.ЛицензияДатаОкончания);
			
			СтрокиДатыНапоминанияПоИстекающейЛицензии = ДатыНапоминанийПоИстекающимЛицензиям.НайтиСтроки(ПараметрыОтбора);
				
			Если СтрокиДатыНапоминанияПоИстекающейЛицензии.Количество() > 0 Тогда
				ДатаНапоминанияПоИстекшейЛицензии = СтрокиДатыНапоминанияПоИстекающейЛицензии[0].ДатаНапоминания;
			КонецЕсли;
						
			Если ДатаНапоминанияПоИстекшейЛицензии = Неопределено Тогда
				// Напоминания раньше не было
				ТребуетсяНапоминание = Истина;
			ИначеЕсли ДатаНапоминанияПоИстекшейЛицензии <= ДатаОтсчета И ЗначениеЗаполнено(ДатаНапоминанияПоИстекшейЛицензии) Тогда
				// Напоминание было, но срок показа подошел
				УчетнаяЗапись = ЛицензияУчетнойЗаписиПользователя.УчетнаяЗаписьДокументооборота;
				ЛицензияНаименование = ЛицензияУчетнойЗаписиПользователя.ЛицензияНаименование;
				ЛицензияДатаОкончания = ЛицензияУчетнойЗаписиПользователя.ЛицензияДатаОкончания;
				
				ЗаявлениеАбонентаДляПродленияЛицензииБылоСоздано =
					ЗаявлениеАбонентаДляПродленияЛицензииБылоСоздано(УчетнаяЗапись, ЛицензияНаименование, ЛицензияДатаОкончания, ДатаОтсчета);

				Если НЕ ЗаявлениеАбонентаДляПродленияЛицензииБылоСоздано Тогда
					ТребуетсяНапоминание = Истина;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		// Если напоминания по лицензии не требуется, то удаляем ее из таблицы
		Если НЕ ТребуетсяНапоминание Тогда
			ЛицензияУчетнойЗаписиПользователя = Неопределено;
			ЛицензииУчетныхЗаписейПользователя.Удалить(ИндексТекущейСтроки);
		КонецЕсли;
		ИндексТекущейСтроки = ИндексТекущейСтроки - 1;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ОставитьТолькоИстекающиеСертификатыХранилища(СертификатыУчетныхЗаписейПользователя, ОтпечаткиИменаДатыСертификатовВХранилище, ДатаОтсчета, ДатаИстечения, ИгнорироватьДатуПоследнегоОтображения = Ложь)
	
	ДатыНапоминанийПоИстекающимСертификатам = ХранилищеОбщихНастроек.Загрузить("ДокументооборотСКонтролирующимиОрганами_НапоминаниеПоИстекающимСертификатам");
	
	Если ДатыНапоминанийПоИстекающимСертификатам = Неопределено ИЛИ ИгнорироватьДатуПоследнегоОтображения Тогда
		
		ДатыНапоминанийПоИстекающимСертификатам = Новый ТаблицаЗначений;
		ДатыНапоминанийПоИстекающимСертификатам.Колонки.Добавить("Организация");
		ДатыНапоминанийПоИстекающимСертификатам.Колонки.Добавить("Отпечаток");
		ДатыНапоминанийПоИстекающимСертификатам.Колонки.Добавить("ДействителенПо");
		ДатыНапоминанийПоИстекающимСертификатам.Колонки.Добавить("ДатаНапоминания");
		
	КонецЕсли;
	
	// Определяем соответствие
	Отпечатки = Новый Соответствие;
	Для Каждого СертификатУчетнойЗаписиПользователя Из СертификатыУчетныхЗаписейПользователя Цикл
		Отпечатки.Вставить(СертификатУчетнойЗаписиПользователя.ОтпечатокСертификата, Неопределено);
	КонецЦикла;

	Если ОтпечаткиИменаДатыСертификатовВХранилище <> Неопределено Тогда
		Для Каждого Отпечаток Из Отпечатки Цикл
			CвойстваСертификата = ОтпечаткиИменаДатыСертификатовВХранилище.Получить(Отпечаток.Ключ);
			Если CвойстваСертификата <> Неопределено Тогда
				// игнорировать сертификаты, истекшите более года назад
				Если (CвойстваСертификата.ДействителенПо <= ДатаИстечения)
					И (CвойстваСертификата.ДействителенПо > ДобавитьМесяц(ДатаОтсчета, -12)) Тогда
					Отпечатки.Вставить(Отпечаток.Ключ, CвойстваСертификата);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	ИндексТекущейСтроки = СертификатыУчетныхЗаписейПользователя.Количество() - 1;
	НачальныйИндексТекущейСтроки = 0;
	// добавляем колонки с заданным типом
	СертификатыУчетныхЗаписейПользователя.Колонки.Добавить("НаименованиеСертификата", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(100)));
	СертификатыУчетныхЗаписейПользователя.Колонки.Добавить("СертификатДействителенПо", Новый ОписаниеТипов("Дата", , Новый КвалификаторыДаты(ЧастиДаты.ДатаВремя)));
	
	Пока ИндексТекущейСтроки >= НачальныйИндексТекущейСтроки Цикл
		
		СертификатУчетнойЗаписиПользователя = СертификатыУчетныхЗаписейПользователя[ИндексТекущейСтроки];
		Отпечаток = Отпечатки.Получить(СертификатУчетнойЗаписиПользователя.ОтпечатокСертификата);
		ЕстьПросроченные = Ложь;
		ТребуетсяНапоминание = Ложь;
		
		Если Отпечаток <> Неопределено Тогда
			
			// Подходит срок окончания сертификата 
			Если Отпечаток.ДействителенПо <= ДатаИстечения Тогда
				
				ДатаНапоминанияПоИстекающемуСертификату = Неопределено;
				
				// Было ли раньше показано напоминание ?
				Отбор = Новый Структура();
				Отбор.Вставить("Организация", СертификатУчетнойЗаписиПользователя.Организация);
				Отбор.Вставить("Отпечаток", СертификатУчетнойЗаписиПользователя.ОтпечатокСертификата);
				СтрокиДатыНапоминанияПоИстекающемуСертификату = ДатыНапоминанийПоИстекающимСертификатам.НайтиСтроки(Отбор);
				
				Если СтрокиДатыНапоминанияПоИстекающемуСертификату.Количество() > 0 Тогда
					СтрокаДатыНапоминанияПоИстекающемуСертификату = СтрокиДатыНапоминанияПоИстекающемуСертификату[0];
					ДатаНапоминанияПоИстекающемуСертификату = СтрокаДатыНапоминанияПоИстекающемуСертификату.ДатаНапоминания;
				Иначе
					СтрокаДатыНапоминанияПоИстекающемуСертификату = Неопределено;
				КонецЕсли;
				
				Если ДатаНапоминанияПоИстекающемуСертификату = Неопределено Тогда
					// Напоминания раньше не было
					ТребуетсяНапоминание = Истина;
				ИначеЕсли ДатаНапоминанияПоИстекающемуСертификату <= ДатаОтсчета И ЗначениеЗаполнено(ДатаНапоминанияПоИстекающемуСертификату) Тогда
					// Напоминание было, но срок показа подошел
					ЗаявлениеАбонентаДляЗаменыСертификатаБылоСоздано =
						ЗаявлениеАбонентаДляЗаменыСертификатаБылоСоздано(СертификатУчетнойЗаписиПользователя.ОтпечатокСертификата, ДатаОтсчета);
						
					Если НЕ ЗаявлениеАбонентаДляЗаменыСертификатаБылоСоздано Тогда
						ТребуетсяНапоминание = Истина;
					КонецЕсли;
				КонецЕсли;
				
			КонецЕсли;
		КонецЕсли;
		
		Если ТребуетсяНапоминание Тогда
			
			СертификатУчетнойЗаписиПользователя.НаименованиеСертификата	 = Отпечаток.Наименование;
			СертификатУчетнойЗаписиПользователя.СертификатДействителенПо = Отпечаток.ДействителенПо;
			 
			Если СертификатУчетнойЗаписиПользователя.СертификатДействителенПо <= ДатаОтсчета Тогда
				ЕстьПросроченные = Истина;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ЕстьПросроченные Тогда
			// Сертификаты, которые вот-вот истекут перемещаем на самый верх
			Если ИндексТекущейСтроки > 0 Тогда
				СертификатыУчетныхЗаписейПользователя.Сдвинуть(ИндексТекущейСтроки, - ИндексТекущейСтроки);
			КонецЕсли;
			НачальныйИндексТекущейСтроки = НачальныйИндексТекущейСтроки + 1;
		Иначе
			Если НЕ ТребуетсяНапоминание Тогда
				СертификатУчетнойЗаписиПользователя = Неопределено;
				СертификатыУчетныхЗаписейПользователя.Удалить(ИндексТекущейСтроки);
			КонецЕсли;
			ИндексТекущейСтроки = ИндексТекущейСтроки - 1;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция СформироватьТекстПредупрежденияОбИзменившихсяПараметрахПодключения(ИзменившиесяПараметрыПодключения, ТекстМакета)
	
	НачалоИнформацииОбОрганизации 	= Найти(ТекстМакета, "<!--НачалоБлока-->");
	КонецИнформацииОбОрганизации 	= Найти(ТекстМакета, "<!--КонецБлока-->");
	БлокHTMLТаблицы 				= Сред(ТекстМакета, НачалоИнформацииОбОрганизации, КонецИнформацииОбОрганизации - НачалоИнформацииОбОрганизации);
	
	НачалоКнопки 		= Найти(БлокHTMLТаблицы, "<!--НачалоКартинки-->");
	КонецКнопки 		= Найти(БлокHTMLТаблицы, "<!--КонецКартинки-->");
	КодКартинкиКонопки 	= Сред(БлокHTMLТаблицы, НачалоКнопки, КонецКнопки - НачалоКнопки);
	
	// Устанавливаем заголовок предупреждения
	ПолныйHTMLТекстПредупреждения 	= ТекстМакета;
	ЗаголовокПредупреждения 		= ЗаголовокПредупреждения(ИзменившиесяПараметрыПодключения);
	ПолныйHTMLТекстПредупреждения 	= СтрЗаменить(ПолныйHTMLТекстПредупреждения, "#Заголовок#", ЗаголовокПредупреждения);
	
	// Устанавливаем текст предупреждения
	ТекстПредупреждения 			= ТекстПредупреждения(ИзменившиесяПараметрыПодключения);
	ПолныйHTMLТекстПредупреждения 	= СтрЗаменить(ПолныйHTMLТекстПредупреждения, "#ТекстПредупреждения#", ТекстПредупреждения);
	
	КоличествоОрганизаций = ИзменившиесяПараметрыПодключения.Количество();
	
	// Формируем строки HTML таблицы
	HTMLКодТаблицы = "";
	Для НомерСтроки = 1 По КоличествоОрганизаций Цикл
		
		ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи = ИзменившиесяПараметрыПодключения[НомерСтроки - 1];
		НоваяСтрокаHTMLТаблицы 		= ТекстБлока(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи, БлокHTMLТаблицы);
		
		// Организация
		ИнформацияОбОрганизацииHTML = "<A style=""color: black"" href=""&amp;ПросмотрОрганизации" + Формат(НомерСтроки, "ЧН=0; ЧГ=") + "КонецСсылки"">" 
			+ ТекстВHTML(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.Организация.Наименование) + "</A>";
		НоваяСтрокаHTMLТаблицы		= СтрЗаменить(НоваяСтрокаHTMLТаблицы, "#ИнформацияОбОрганизации#", ИнформацияОбОрганизацииHTML);
			
		// Сертификат
		ИнформацияПоСертификату		= ИнформацияПоСертификату(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи, НомерСтроки);
		НоваяСтрокаHTMLТаблицы		= СтрЗаменить(НоваяСтрокаHTMLТаблицы, "#Сертификат#", ИнформацияПоСертификату);
				
		// Лицензия
		ИнформацияПоЛицензии		= ИнформацияПоЛицензии(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи);
		НоваяСтрокаHTMLТаблицы		= СтрЗаменить(НоваяСтрокаHTMLТаблицы, "#Лицензия#", ИнформацияПоЛицензии);
			
		// Изменившиеся реквизиты
		ИнформацияПоРеквизитам		= ИнформацияПоРеквизитам(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи);
		НоваяСтрокаHTMLТаблицы		= СтрЗаменить(НоваяСтрокаHTMLТаблицы, "#Реквизиты#", ИнформацияПоРеквизитам);
		
		// Кнопка "Отправить заявление"
		КнопкаОтправкиЗаявление 	= КнопкаОтправкиЗаявление(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи, НоваяСтрокаHTMLТаблицы, НомерСтроки);
		НоваяСтрокаHTMLТаблицы 		= СтрЗаменить(НоваяСтрокаHTMLТаблицы, КодКартинкиКонопки, КнопкаОтправкиЗаявление);
		
		// Добавляем строку в HTML-документ
		HTMLКодТаблицы = HTMLКодТаблицы + НоваяСтрокаHTMLТаблицы;
		
	КонецЦикла;
	
	// Подставляем в макет сформированную таблицу
	ПолныйHTMLТекстПредупреждения = СтрЗаменить(ПолныйHTMLТекстПредупреждения, БлокHTMLТаблицы, HTMLКодТаблицы);
	ПолныйHTMLТекстПредупреждения = УбратьФорматированиеДляFirefox(ПолныйHTMLТекстПредупреждения);
	
	Возврат ПолныйHTMLТекстПредупреждения;
	
КонецФункции

Функция ИспользуетсяFirefox() Экспорт
	
	ИспользуетсяFirefox = Ложь;
	
	СисИнфо = Новый СистемнаяИнформация;
	ВебБраузер = СисИнфо.ИнформацияПрограммыПросмотра;
	
	ИспользуетсяFirefox = (СтрЧислоВхождений(ВРег(ВебБраузер), "FIREFOX") > 0);
	
	Возврат ИспользуетсяFirefox;
	
КонецФункции

Функция УбратьФорматированиеДляFirefox(Текст) Экспорт
	
	Результат = Текст;
	Если ИспользуетсяFirefox() Тогда
		
		Результат = СтрЗаменить(Результат, "class=leftline", "");
		Результат = СтрЗаменить(Результат, "border=""1""", "border=""0""");
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции


Функция ТекстБлока(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи, Знач ТекстДляЗамены)
		
	НачалоЯчейкиОрганизация = Найти(ТекстДляЗамены,"<!--НачалоЯчейкиОрганизация-->");
	КонецЯчейкиОрганизация 	= Найти(ТекстДляЗамены,"<!--КонецЯчейкиОрганизация-->");
	ЯчейкаОрганизация 		= Сред(ТекстДляЗамены, НачалоЯчейкиОрганизация, КонецЯчейкиОрганизация - НачалоЯчейкиОрганизация);
	
	НачалоЯчейкиСертификат 	= Найти(ТекстДляЗамены,"<!--НачалоЯчейкиСертификат-->");
	КонецЯчейкиСертификат 	= Найти(ТекстДляЗамены,"<!--КонецЯчейкиСертификат-->");
	ЯчейкаСертификат 		= Сред(ТекстДляЗамены, НачалоЯчейкиСертификат, КонецЯчейкиСертификат - НачалоЯчейкиСертификат);
	
	НачалоЯчейкиЗаявление 	= Найти(ТекстДляЗамены,"<!--НачалоЯчейкиЗаявление-->");
	КонецЯчейкиЗаявление 	= Найти(ТекстДляЗамены,"<!--КонецЯчейкиЗаявление-->");
	ЯчейкаЗаявление 		= Сред(ТекстДляЗамены, НачалоЯчейкиЗаявление, КонецЯчейкиЗаявление - НачалоЯчейкиЗаявление);
	
	НачалоЯчейкиЛицензия 	= Найти(ТекстДляЗамены,"<!--НачалоЯчейкиЛицензия-->");
	КонецЯчейкиЛицензия 	= Найти(ТекстДляЗамены,"<!--КонецЯчейкиЛицензия-->");
	ЯчейкаЛицензия 			= Сред(ТекстДляЗамены, НачалоЯчейкиЛицензия, КонецЯчейкиЛицензия - НачалоЯчейкиЛицензия);
	
	НачалоЯчейкиНастроки 	= Найти(ТекстДляЗамены,"<!--НачалоЯчейкиРеквизиты-->");
	КонецЯчейкиНастроки 	= Найти(ТекстДляЗамены,"<!--КонецЯчейкиРеквизиты-->");
	ЯчейкиНастроки			= Сред(ТекстДляЗамены, НачалоЯчейкиНастроки, КонецЯчейкиНастроки - НачалоЯчейкиНастроки);
	
	НачалоВысотыБлока 		= Найти(ТекстДляЗамены,"<!--НачалоВысотыБлока-->");
	КонецВысотыБлока 		= Найти(ТекстДляЗамены,"<!--КонецВысотыБлока-->");
	ТэгВысотыБлока 			= Сред(ТекстДляЗамены, НачалоВысотыБлока, КонецВысотыБлока - НачалоВысотыБлока);
	
	НачалоЯчейкиОтступ 		= Найти(ТекстДляЗамены,"<!--НачалоЯчейкиОтступ-->");
	КонецЯчейкиОтступ 		= Найти(ТекстДляЗамены,"<!--КонецЯчейкиОтступ-->");
	ЯчейкиОтступ 			= Сред(ТекстДляЗамены, НачалоЯчейкиОтступ, КонецЯчейкиОтступ - НачалоЯчейкиОтступ);
	
	НачалоВысотыБлокаЗаявления 	= Найти(ТекстДляЗамены,"<!--НачалоВысотыБлокаЗаявления-->");
	КонецВысотыБлокаЗаявления 	= Найти(ТекстДляЗамены,"<!--КонецВысотыБлокаЗаявления-->");
	ТэгВысотыБлокаЗаявления 	= Сред(ТекстДляЗамены, НачалоВысотыБлокаЗаявления, КонецВысотыБлокаЗаявления - НачалоВысотыБлокаЗаявления);	
	
	// В зависимости от количества строк в блоке, оставляем один блок
	ЕстьСертификат = ЗначениеЗаполнено(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.СертификатДействителенПо) 
		И ЗначениеЗаполнено(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.НаименованиеСертификата);
	
	ЕстьЛицензия = ЗначениеЗаполнено(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.ЛицензияНаименование) 
		И ЗначениеЗаполнено(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.ЛицензияДатаОкончания);
	
	ЕстьРеквизиты = ЗначениеЗаполнено(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.ПредставлениеИзменившихсяРеквизитов);
	
	ВысотаБлока = 0;
	Если ЕстьСертификат И ЕстьЛицензия И ЕстьРеквизиты Тогда
		ВысотаБлока = 3;
	ИначеЕсли ЕстьСертификат И ЕстьЛицензия И НЕ ЕстьРеквизиты 
		ИЛИ ЕстьСертификат И НЕ ЕстьЛицензия И ЕстьРеквизиты 
		ИЛИ НЕ ЕстьСертификат И ЕстьЛицензия И ЕстьРеквизиты Тогда
		ВысотаБлока = 2;
	Иначе 
		ВысотаБлока = 1;
	КонецЕсли;
	
	// Собираем текст блока
	СертификатУжеБыл = Ложь;
	ЛицензияУжеБыла = Ложь;
	РеквизитыУжеБыли = Ложь;
	
	БлокHTMLТаблицы = "";
	// Первая строка
	БлокHTMLТаблицы = БлокHTMLТаблицы + "<TR>" + СтрЗаменить(ЯчейкаОрганизация, ТэгВысотыБлока, "<TD class=rightline rowSpan=" + Строка(ВысотаБлока) + ">" ) + Символы.ПС;
	Если ЕстьСертификат Тогда
		БлокHTMLТаблицы = БлокHTMLТаблицы + ЯчейкаСертификат + Символы.ПС;
		СертификатУжеБыл = Истина;
	ИначеЕсли ЕстьЛицензия Тогда
		БлокHTMLТаблицы = БлокHTMLТаблицы + ЯчейкаЛицензия + Символы.ПС;
		ЛицензияУжеБыла = Истина; 
	ИначеЕсли ЕстьРеквизиты Тогда
		БлокHTMLТаблицы = БлокHTMLТаблицы + ЯчейкиНастроки + Символы.ПС;
		РеквизитыУжеБыли = Истина;
	КонецЕсли;
	БлокHTMLТаблицы = БлокHTMLТаблицы + СтрЗаменить(ЯчейкаЗаявление, ТэгВысотыБлокаЗаявления, "<TD class=leftline align=center rowSpan=" + Строка(ВысотаБлока) + ">" ) + "</TR>" + Символы.ПС;
	// Вторая строка
	Если ЕстьЛицензия И НЕ ЛицензияУжеБыла ИЛИ ЕстьРеквизиты И НЕ РеквизитыУжеБыли Тогда
		БлокHTMLТаблицы = БлокHTMLТаблицы + "<TR>";
	КонецЕсли;
	Если ЕстьЛицензия И НЕ ЛицензияУжеБыла Тогда
		БлокHTMLТаблицы = БлокHTMLТаблицы + ЯчейкаЛицензия + Символы.ПС;
		ЛицензияУжеБыла = Истина; 
	ИначеЕсли ЕстьРеквизиты И НЕ РеквизитыУжеБыли Тогда
		БлокHTMLТаблицы = БлокHTMLТаблицы + ЯчейкиНастроки + Символы.ПС;
		РеквизитыУжеБыли = Истина;
	КонецЕсли;
	Если ЕстьЛицензия И НЕ ЛицензияУжеБыла ИЛИ ЕстьРеквизиты И НЕ РеквизитыУжеБыли Тогда
		БлокHTMLТаблицы = БлокHTMLТаблицы + "</TR>";
	КонецЕсли;
	// Третья строка
	Если ЕстьРеквизиты И НЕ РеквизитыУжеБыли Тогда
		БлокHTMLТаблицы = БлокHTMLТаблицы + "<TR>" + ЯчейкиНастроки + "</TR>";
		РеквизитыУжеБыли = Истина;
	КонецЕсли;
	
	БлокHTMLТаблицы = БлокHTMLТаблицы + ЯчейкиОтступ;
	
	Возврат БлокHTMLТаблицы;
	
КонецФункции

Функция ИнформацияПоЛицензии(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи)

	ИнформацияПоЛицензии = "";
	
	ДвеНедели = 2 * 7 * 24 * 60 * 60;
	ТекДата = ТекущаяДатаСеанса();

	ДатаОкончанияЛицензии = ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.ЛицензияДатаОкончания;
	
	Если ЗначениеЗаполнено(ДатаОкончанияЛицензии) Тогда
		ЛицензияНаименование 	= """" + ТекстВHTML(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.ЛицензияНаименование) + """";
		
		СрокИстеченияЛицензии 			= ТекстЧерезСколькоЛетМесяцевНедельДней(ТекДата, ДатаОкончанияЛицензии, "<nobr>", "</nobr>");
		СрокИстеченияЛицензииВФормате 	= Формат(ДатаОкончанияЛицензии, "ДФ=""дд ММММ гггг 'г.'""");

		Если СрокИстеченияЛицензии = Неопределено Тогда
			// Истекшие лицензии выводим красным
			СрокИстеченияЛицензии	= НСтр("ru='. Истекла '") + ТекстБезПереносов(СрокИстеченияЛицензииВФормате);
			ИнформацияПоЛицензии	= "<li style=""color: b22222"">" + НСтр("ru = 'Лицензия '") + ЛицензияНаименование + " "+ СрокИстеченияЛицензии;
			
		Иначе
			Если НачалоДня(ДатаОкончанияЛицензии) - НачалоДня(ТекДата) < ДвеНедели Тогда
				// Лицензии, срок действия которых заканчивается менее чем через 2 недели
				СрокИстеченияЛицензии	= НСтр("ru='. Истекает через '") + СрокИстеченияЛицензии+ " (" + СрокИстеченияЛицензииВФормате+ ")";
				ИнформацияПоЛицензии	= "<li style=""color: b22222"">" + НСтр("ru = 'Лицензия '") + ЛицензияНаименование + " "+ СрокИстеченияЛицензии;
			Иначе
				// Лицензии, срок действия которых заканчивается более чем через 2 недели
				СрокИстеченияЛицензии	= НСтр("ru='. Истекает через '")  + СрокИстеченияЛицензии+ " (" + СрокИстеченияЛицензииВФормате+ ")";
				ИнформацияПоЛицензии	= "<li style=""color: black"">" + НСтр("ru = 'Лицензия '") + ЛицензияНаименование + " "+ СрокИстеченияЛицензии;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ИнформацияПоЛицензии;
	
КонецФункции

Функция ИнформацияПоРеквизитам(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи)

	ИнформацияПоРеквизитам = "";
	
	ЕстьИзменившиесяРеквизиты = ЗначениеЗаполнено(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.ПредставлениеИзменившихсяРеквизитов);
	Если ЕстьИзменившиесяРеквизиты Тогда
		
		ИнформацияПоРеквизитам 	= "<li>" + НСтр("ru = 'Изменились реквизиты подключения - '") 
			+ ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.ПредставлениеИзменившихсяРеквизитов;
		
	КонецЕсли;
	
	Возврат ИнформацияПоРеквизитам;
	
КонецФункции

Функция ИнформацияПоСертификату(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи, НомерСтроки)
	
	ИнформацияПоСертификату = "";
	
	ДвеНедели = 2 * 7 * 24 * 60 * 60;
	ТекДата = ТекущаяДатаСеанса();
	
	СертификатДействителенПо 	= ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.СертификатДействителенПо;
	
	Если ЗначениеЗаполнено(СертификатДействителенПо) Тогда
		НаименованиеСертификата 	= ТекстВHTML(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.НаименованиеСертификата);
			
		ЗаголовокСертификата 		= НСтр("ru = 'Срок действия сертификата '");

		СрокИстеченияСертификата 			= ТекстЧерезСколькоЛетМесяцевНедельДней(ТекДата, СертификатДействителенПо, "<nobr>", "</nobr>");
		СрокИстеченияСертификатаВФормате 	= Формат(СертификатДействителенПо, "ДФ=""дд ММММ гггг 'г.'""");
		
		Если СрокИстеченияСертификата = Неопределено Тогда
			// Истекшие сертификаты
			СрокИстеченияСертификата 	= НСтр("ru='истек '") + ТекстБезПереносов(СрокИстеченияСертификатаВФормате);
			ГиперссылкаСертификата 		= "<A style=""color: b22222"" href=""&amp;ПросмотрСертификата" + Формат(НомерСтроки, "ЧН=0; ЧГ=") + "КонецСсылки"">" + НаименованиеСертификата + "</A>";
			ИнформацияПоСертификату 	= "<li style=""color: b22222"">" + ЗаголовокСертификата + " " + ГиперссылкаСертификата + " " + СрокИстеченияСертификата;
		Иначе
			
			Если НачалоДня(СертификатДействителенПо) - НачалоДня(ТекДата) < ДвеНедели Тогда
				// Сертификаты, срок действия которых заканчивается менее чем через 2 недели
				СрокИстеченияСертификата 	= НСтр("ru='истекает через '") + СрокИстеченияСертификата + " (" + СрокИстеченияСертификатаВФормате+ ")";
				ГиперссылкаСертификата 		= "<A style=""color: b22222"" href=""&amp;ПросмотрСертификата" + Формат(НомерСтроки, "ЧН=0; ЧГ=") + "КонецСсылки"">" + НаименованиеСертификата + "</A>";
				ИнформацияПоСертификату 	= "<li style=""color: b22222"">" + ЗаголовокСертификата + " " + ГиперссылкаСертификата + " " + СрокИстеченияСертификата;
			Иначе
				// Сертификаты, срок действия которых заканчивается более чем через 2 недели
			 	СрокИстеченияСертификата 	= НСтр("ru='истекает через '") + СрокИстеченияСертификата + " (" + СрокИстеченияСертификатаВФормате+ ")";
				ГиперссылкаСертификата 		= "<A style=""color: black"" href=""&amp;ПросмотрСертификата" + Формат(НомерСтроки, "ЧН=0; ЧГ=") + "КонецСсылки"">" + НаименованиеСертификата + "</A>";
				ИнформацияПоСертификату 	= "<li style=""color: black"">" + ЗаголовокСертификата + " " + ГиперссылкаСертификата + " " + СрокИстеченияСертификата;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ИнформацияПоСертификату;

КонецФункции

Функция ЗаголовокПредупреждения(ИзменившиесяПараметрыПодключения)

	КоличествоОрганизаций = ИзменившиесяПараметрыПодключения.Количество();
	
	// Определяем, о чем нужно предупреждать
	ЕстьЗакончившиесяЛицензии = 
		ИзменившиесяПараметрыПодключения.НайтиСтроки(Новый Структура("ЛицензияНаименование", Null)).Количество() <> КоличествоОрганизаций;
		
	ЕстьЗакончившиесяСертификаты = 
		ИзменившиесяПараметрыПодключения.НайтиСтроки(Новый Структура("ОтпечатокСертификата", Null)).Количество() <> КоличествоОрганизаций;
		
	ЕстьИзменившиесяРеквизиты = 
		ИзменившиесяПараметрыПодключения.НайтиСтроки(Новый Структура("СписокИзменившихсяРеквизитов", Null)).Количество() <> КоличествоОрганизаций;
		
	// Формируем заголовок в зависимости от того, о чем нужно предупреждать
	Если ЕстьЗакончившиесяЛицензии И НЕ ЕстьЗакончившиесяСертификаты И НЕ ЕстьИзменившиесяРеквизиты Тогда
		Результат = НСтр("ru = 'Истекает срок действия лицензии на 1С-Отчетность'");
	ИначеЕсли НЕ ЕстьЗакончившиесяЛицензии И ЕстьЗакончившиесяСертификаты И НЕ ЕстьИзменившиесяРеквизиты Тогда
		Результат = НСтр("ru = 'Истекает срок действия сертификата'");
	ИначеЕсли ЕстьЗакончившиесяЛицензии ИЛИ ЕстьЗакончившиесяСертификаты Тогда
		Результат = НСтр("ru = 'Истекает срок действия лицензии (сертификата) на 1С-Отчетность'");
	Иначе
		Результат = НСтр("ru = 'Изменились настройки подключения к 1С-Отчетности'");
	КонецЕсли;
	
	// Если ни одна из организаций не поддерживает вторичные заявления,
	// то убираем понятие 1С-Отчетность из предупреждения
	ОрганизацииНеПоддерживающиеВторичныеЗаявления = ИзменившиесяПараметрыПодключения.НайтиСтроки(
		Новый Структура("ПоддерживаетсяОтправкаВторичногоЗаявления", Ложь));
	КоличествоОрганизацийНеПоддерживающихОтправку = ОрганизацииНеПоддерживающиеВторичныеЗаявления.Количество(); 
	НиОднаИзОрганизацийНеПоддерживаетВторичныеЗаявления = (КоличествоОрганизацийНеПоддерживающихОтправку = КоличествоОрганизаций);
	
	// Если ни одна из организаций не поддерживает вторичные заявления,
	// то убираем понятие 1С-Отчетность из предупреждения
	Если НиОднаИзОрганизацийНеПоддерживаетВторичныеЗаявления Тогда
		Результат = СтрЗаменить(Результат, НСтр("ru = ' к 1С-Отчетности'"), "");
		Результат = СтрЗаменить(Результат, НСтр("ru = ' на 1С-Отчетность'"), "");
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

Функция ТекстПредупреждения(ИзменившиесяПараметрыПодключения)

	КоличествоОрганизаций = ИзменившиесяПараметрыПодключения.Количество();
	
	ОрганизацииНеПоддерживающиеВторичныеЗаявления = ИзменившиесяПараметрыПодключения.НайтиСтроки(
		Новый Структура("ПоддерживаетсяОтправкаВторичногоЗаявления", Ложь));
	КоличествоОрганизацийНеПоддерживающихОтправку = ОрганизацииНеПоддерживающиеВторичныеЗаявления.Количество(); 
	
	// Текст предупрежедения для второго предложения
	НиОднаИзОрганизацийНеПоддерживаетВторичныеЗаявления = (КоличествоОрганизацийНеПоддерживающихОтправку = КоличествоОрганизаций);
	ВсеОрганизацииПоддерживаютВторичныеЗаявления = (КоличествоОрганизацийНеПоддерживающихОтправку = 0);
	Если НиОднаИзОрганизацийНеПоддерживаетВторичныеЗаявления Тогда
		Результат = НСтр("ru = 'Сообщите об изменении настроек подключения в службу тех. поддержки специализированного оператора связи.'");
	ИначеЕсли ВсеОрганизацииПоддерживаютВторичныеЗаявления Тогда
		Результат = НСтр("ru = 'Отправьте заявление на изменение настроек подключения к 1С-Отчетности из программы.'");
	Иначе 
		Результат = НСтр("ru = 'Сообщите об изменении настроек подключения в службу тех. поддержки специализированного оператора связи или отправьте заявление из программы.'");
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

Функция КнопкаОтправкиЗаявление(ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи, НоваяСтрокаHTMLТаблицы, НомерСтроки)
	
	НачалоКнопки 		= Найти(НоваяСтрокаHTMLТаблицы, "<!--НачалоКартинки-->");
	КонецКнопки 		= Найти(НоваяСтрокаHTMLТаблицы, "<!--КонецКартинки-->");
	КодКартинкиКонопки 	= Сред(НоваяСтрокаHTMLТаблицы, НачалоКнопки, КонецКнопки - НачалоКнопки);
	
	КнопкаОтправкиЗаявление = "";
	
	// Гиперссылка на заявление. Не показывается, если спецоператор не поддерживает вторичные заявления
	ПоддерживаетсяОтправкаВторичногоЗаявления = ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.ПоддерживаетсяОтправкаВторичногоЗаявления;
	
	// Не показываем гиперссылку на заявление, если спецоператор не поддерживает вторичные заявления
	Если ПоддерживаетсяОтправкаВторичногоЗаявления Тогда
		// Показываем гиперссылку на заявление, если спецоператор поддерживает вторичные заявления
		КнопкаОтправкиЗаявление = "<A href=""&amp;ОтправкаЗаявленияНаИзменениеРеквизитовПодключения"
			+ Формат(НомерСтроки, "ЧН=0; ЧГ=") + "КонецСсылки"">" + КодКартинкиКонопки + "</A>";
	Иначе
		// Определяем текст надписи для случая, когда спецоператор не поддерживает вторичные заявления
		СпецоператорСвязи = ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.УчетнаяЗаписьДокументооборота.СпецоператорСвязи;
		Если СпецоператорСвязи = Перечисления.СпецоператорыСвязи.Прочие Тогда
			// Если спецоператор Прочий, тогда выводим 'Обратитесь к своему спецоператору'
			КнопкаОтправкиЗаявление = "<FONT class=head2>" + НСтр("ru = 'Обратитесь к своему спецоператору'") + "</FONT>";
		Иначе
			// Если спецоператор конкретный, а не Прочий, тогда выводим 'Обратитесь к спецоператору Калуга Астрал'
			КнопкаОтправкиЗаявление = НСтр("ru = 'Обратитесь к спецоператору %1'");
			КнопкаОтправкиЗаявление = "<FONT class=head2>" + СтрЗаменить(КнопкаОтправкиЗаявление, "%1", СпецоператорСвязи) + "</FONT>";
		КонецЕсли;
		
	КонецЕсли; 
	
	Возврат КнопкаОтправкиЗаявление;
	
КонецФункции

Процедура ОпределитьДляКаждойОрганизацииВозможностьПоддержкиВторичныхЗаявлений(ИзменившиесяПараметрыПодключения)
	
	ИзменившиесяПараметрыПодключения.Колонки.Добавить("ПоддерживаетсяОтправкаВторичногоЗаявления");
	
	КоличествоОрганизаций = ИзменившиесяПараметрыПодключения.Количество();
	
	Для НомерСтроки = 1 По КоличествоОрганизаций Цикл
		
		ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи = ИзменившиесяПараметрыПодключения[НомерСтроки - 1];
		
		// Гиперссылка на заявление. Не показывается, если спецоператор не поддерживает вторичные заявления
		СпецоператорСвязи = ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.УчетнаяЗаписьДокументооборота.СпецоператорСвязи;
		ПоддерживаетсяОтправкаВторичногоЗаявления = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПолучитьПараметрСпецоператора(СпецоператорСвязи, "ПоддерживаетсяОтправкаВторичногоЗаявления");
		ИзменившиесяПараметрыПодключенияПоОднойУчетнойЗаписи.ПоддерживаетсяОтправкаВторичногоЗаявления = ПоддерживаетсяОтправкаВторичногоЗаявления = "Истина";
		
	КонецЦикла;
	
КонецПроцедуры

Функция ТекстБезПереносов(Текст)
	
	Возврат "<nobr>" + Текст + "</nobr>";
	
КонецФункции

Функция ТекстВHTML(Текст)
	
	Возврат СтрЗаменить(СтрЗаменить(СтрЗаменить(СтрЗаменить(Текст, "<", "&lt;"), ">", "&gt;"), """", "&quot;"), Символы.ПС, " &#13;&#10;");
	
КонецФункции

Функция ТекстЧерезСколькоЛетМесяцевНедельДней(ДатаОтсчета, ДатаЗавершения, ПрефиксЧисла, ПостфиксСуществительного) Экспорт
	
	Если ДатаЗавершения <= ДатаОтсчета Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ГодОтсчета = Год(ДатаОтсчета);
	МесяцОтсчета = Месяц(ДатаОтсчета);
	ДеньОтсчета = День(ДатаОтсчета);
	ЧасОтсчета = Час(ДатаОтсчета);
	МинутаОтсчета = Минута(ДатаОтсчета);
	СекундаОтсчета = Секунда(ДатаОтсчета);
	
	ГодЗавершения = Год(ДатаЗавершения);
	МесяцЗавершения = Месяц(ДатаЗавершения);
	ДеньЗавершения = День(ДатаЗавершения);
	ЧасЗавершения = Час(ДатаЗавершения);
	МинутаЗавершения = Минута(ДатаЗавершения);
	СекундаЗавершения = Секунда(ДатаЗавершения);
	
	РазницаВГодах = ГодЗавершения - ГодОтсчета;
	РазницаВМесяцах = МесяцЗавершения - МесяцОтсчета;
	РазницаВДнях = ДеньЗавершения - ДеньОтсчета;
	РазницаВЧасах = ЧасЗавершения - ЧасОтсчета;
	РазницаВМинутах = МинутаЗавершения - МинутаОтсчета;
	РазницаВСекундах = СекундаЗавершения - СекундаОтсчета;
	
	Если РазницаВСекундах < 0 Тогда
		РазницаВМинутах = РазницаВМинутах - 1;
		РазницаВСекундах = РазницаВСекундах + 60;
	КонецЕсли;
	
	Если РазницаВМинутах < 0 Тогда
		РазницаВЧасах = РазницаВЧасах - 1;
		РазницаВМинутах = РазницаВМинутах + 60;
	КонецЕсли;
	
	Если РазницаВЧасах < 0 Тогда
		РазницаВДнях = РазницаВДнях - 1;
		РазницаВЧасах = РазницаВЧасах + 24;
	КонецЕсли;
	
	Если РазницаВДнях < 0 Тогда
		
		РазницаВМесяцах = РазницаВМесяцах - 1;
		Если МесяцЗавершения = 3 Тогда
			// берем год отсчета, в который существуют все дни месяца, например, с 29.02.2008 по 1.03.2009
			// прошло 1 год 1 день: c 29.02.2008 по 1.03.2008 прошел 1 день, далее 1 год
			Если (ГодОтсчета % 4 = 0) И ((ГодОтсчета % 100 <> 0) ИЛИ (ГодОтсчета % 400 = 0)) Тогда
				РазницаВДнях = РазницаВДнях + 29;
			Иначе
				РазницаВДнях = РазницаВДнях + 28;
			КонецЕсли;
			
		ИначеЕсли (МесяцЗавершения = 5) ИЛИ (МесяцЗавершения = 7) ИЛИ (МесяцЗавершения = 10)
			ИЛИ (МесяцЗавершения = 12) Тогда
			РазницаВДнях = РазницаВДнях + 30;
			
		Иначе
			РазницаВДнях = РазницаВДнях + 31;
		КонецЕсли;
		
	КонецЕсли;
	
	Если РазницаВМесяцах < 0 Тогда
		РазницаВМесяцах = РазницаВМесяцах + 12;
		РазницаВГодах = РазницаВГодах - 1;
	КонецЕсли;
	РазницаВНеделях = Цел(РазницаВДнях / 7);
	РазницаВДнях = РазницаВДнях % 7;
	
	Результат = "";
	Если РазницаВГодах > 0 Тогда
		Результат = ПрефиксЧисла + ЧислоССуществительным(РазницаВГодах, НСтр("ru='год'"), НСтр("ru='года'"), НСтр("ru='лет'")) + ПостфиксСуществительного;
	КонецЕсли;
	
	Если РазницаВМесяцах > 0 Тогда
		НомерМесяца = ЧислоССуществительным(РазницаВМесяцах, НСтр("ru='месяц'"), НСтр("ru='месяца'"), НСтр("ru='месяцев'"));
		Разделитель = ?(РазницаВНеделях = 0 И РазницаВДнях = 0, " " + НСтр("ru='и'") + " ", ", ");
		Результат = СоединитьЧерез(Результат, Разделитель, ПрефиксЧисла + НомерМесяца + ПостфиксСуществительного);
	КонецЕсли;
	
	Если РазницаВНеделях > 0 Тогда
		НомерНедели = ЧислоССуществительным(РазницаВНеделях, НСтр("ru='неделю'"), НСтр("ru='недели'"), НСтр("ru='недель'"));
		Разделитель = ?(РазницаВДнях = 0, " " + НСтр("ru='и'") + " ", ", ");
		Результат = СоединитьЧерез(Результат, Разделитель, ПрефиксЧисла + НомерНедели + ПостфиксСуществительного);
	КонецЕсли;
	
	Если РазницаВДнях > 0 Тогда
		НомерДня = ЧислоССуществительным(РазницаВДнях, НСтр("ru='день'"), НСтр("ru='дня'"), НСтр("ru='дней'"));
		Результат = СоединитьЧерез(Результат, " " + НСтр("ru='и'") + " ", ПрефиксЧисла + НомерДня + ПостфиксСуществительного);
	ИначеЕсли (РазницаВДнях = 0) И (Результат = "") Тогда
		
		Если (РазницаВЧасах > 0) ИЛИ (РазницаВМинутах > 0) Тогда
			Если РазницаВЧасах > 0 Тогда
				НомерЧаса = ЧислоССуществительным(РазницаВЧасах, НСтр("ru='час'"), НСтр("ru='часа'"), НСтр("ru='часов'"));
				Результат = ПрефиксЧисла + НомерЧаса + ПостфиксСуществительного;
			КонецЕсли;
			Если РазницаВМинутах > 0 Тогда
				НомерМинуты = ЧислоССуществительным(РазницаВМинутах, НСтр("ru='минуту'"), НСтр("ru='минуты'"), НСтр("ru='минут'"));
				Результат = СоединитьЧерез(Результат, " " + НСтр("ru='и'") + " ", ПрефиксЧисла + НомерМинуты + ПостфиксСуществительного);
			КонецЕсли;
		Иначе
			НомерСекунды = ЧислоССуществительным(РазницаВСекундах, НСтр("ru='секунду'"), НСтр("ru='секунды'"), НСтр("ru='секунд'"));
			Результат = ПрефиксЧисла + НомерСекунды + ПостфиксСуществительного;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ЧислоССуществительным(Количество, ИменительныйИлиВинительныйПадежЕдинственноеЧисло, РодительныйПадежЕдинственноеЧисло, РодительныйПадежМножественноеЧисло)
	
	ОстатокДеленияКоличестваНа100 = Количество % 100;
	ОстатокДеленияКоличестваНа10 = Количество % 10;
	
	Если (ОстатокДеленияКоличестваНа10 = 1) И (ОстатокДеленияКоличестваНа100 <> 11) Тогда
		Возврат Строка(Количество) + " " + ИменительныйИлиВинительныйПадежЕдинственноеЧисло;
		
	ИначеЕсли (ОстатокДеленияКоличестваНа10 >= 2) И (ОстатокДеленияКоличестваНа10 <= 4) И ((ОстатокДеленияКоличестваНа100 < 12) ИЛИ (ОстатокДеленияКоличестваНа100 > 14)) Тогда
		Возврат Строка(Количество) + " " + РодительныйПадежЕдинственноеЧисло;
		
	Иначе
		Возврат Строка(Количество) + " " + РодительныйПадежМножественноеЧисло;
	КонецЕсли;
	
КонецФункции

Функция СоединитьЧерез(Строка1, Разделитель, Строка2)
	
	Если ПустаяСтрока(Строка(Строка1)) Тогда
		Возврат Строка2;
	ИначеЕсли ПустаяСтрока(Строка(Строка2)) Тогда
		Возврат Строка1;
	Иначе
		Возврат Строка1 + Разделитель + Строка2;
	КонецЕсли;
	
КонецФункции

Процедура ДобавитьВТаблицуСписокИзменившихсяРеквизитовПодключенияК1СОтчетности(ИзменившиесяРеквизитыОрганизации) Экспорт
	
	Организация = ИзменившиесяРеквизитыОрганизации.Организация;
	УчетнаяЗапись = ИзменившиесяРеквизитыОрганизации.УчетнаяЗаписьДокументооборота;
	
	ДанныеЗаполнения = Неопределено;
	
	// Заполняем текущие реквизиты организации 
	СтруктураРеквизитов = Новый Структура("Организация, ПриОткрытии", Организация, НЕ ДанныеЗаполнения = Неопределено);
	Если ДанныеЗаполнения <> Неопределено Тогда
		СтруктураРеквизитов.Вставить("АдресЮридический",);
		СтруктураРеквизитов.Вставить("АдресФактический",);
	КонецЕсли;
	ЗаполнитьДанные(СтруктураРеквизитов);
	ДанныеЗаполнения = ПолучитьДанныеЗаполнения(СтруктураРеквизитов);
	ДанныеОрганизации = ДанныеЗаполнения.СтруктураДанныхОрганизации;
	
	// Получаем реквизиты организации
	Руководитель	= ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.Руководитель(Организация); 
	ГлБухгалтер		= ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ГлБухгалтер(Организация);
	
	ЭтоЮридическоеЛицо		 = ДанныеОрганизации.ТипОрганизации;
	ПолноеНаименование		 = ДанныеОрганизации.НаимЮЛПол;
	КраткоеНаименование		 = ДанныеОрганизации.КраткоеНаименование;
	ИНН						 = ДанныеОрганизации.ИННЮЛ;
	КПП						 = ДанныеОрганизации.КППЮЛ;
	ОГРН					 = ДанныеОрганизации.ОГРН;
	РегНомерПФР				 = ДанныеОрганизации.РегНомПФР;
	РегНомерФСС				 = ДанныеОрганизации.РегистрационныйНомерФСС;
	ТелефонОсновной			 = ДанныеОрганизации.ТелОрганизации;
	ТелефонДополнительный	 = ДанныеОрганизации.ТелРук;
	АдрЮР					 = ДанныеЗаполнения.АдресЮридический;
	АдрФакт				 	 = ДанныеЗаполнения.АдресФактический;
	АдресЮридический		 = ДанныеЗаполнения.ЮрАдрес;
	АдресФактический		 = ДанныеЗаполнения.ФактАдрес;
	
	Если АдресЮридический = ",,,,,,,,," Тогда
		АдресЮридический = "";
	КонецЕсли;
	
	Если АдресФактический = ",,,,,,,,," Тогда
		АдресФактический = "";
	КонецЕсли;
	
	ЭлектроннаяПочтаИсходная = ДанныеОрганизации.ЭлектроннаяПочта;
	КодРегионаФСРАР = РегламентированнаяОтчетностьКлиентСервер.РазложитьАдрес(АдрЮр).Регион;
	
	КодПФР = КодПФР(ДанныеОрганизации);
	КодРосстата = КодРосстата(ДанныеОрганизации);
	
	// Спецоператор
	ОператорПоддерживаетСМСУведомление = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПолучитьПараметрСпецоператора(УчетнаяЗапись.СпецоператорСвязи, "ПризнакПоддержкиСМС") = "Истина";
	Спецоператор = УчетнаяЗапись.СпецоператорСвязи;
	
	// Определяем исходные параметры подключенния к 1С-Отчетности
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ДополнительныеРеквизитыУчетнойЗаписи.ТипКриптопровайдера,
		|	ДополнительныеРеквизитыУчетнойЗаписи.НомерОсновнойПоставки1с,
		|	ДополнительныеРеквизитыУчетнойЗаписи.КраткоеНаименование,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ПолноеНаименование,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ИНН,
		|	ДополнительныеРеквизитыУчетнойЗаписи.КПП,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ОГРН,
		|	ДополнительныеРеквизитыУчетнойЗаписи.РегНомерПФР,
		|	ДополнительныеРеквизитыУчетнойЗаписи.РегНомерФСС,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ЭлектроннаяПочта,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ВладелецЭЦПФамилия,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ВладелецЭЦПИмя,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ВладелецЭЦПОтчество,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ВладелецЭЦППодразделение,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ВладелецЭЦПСНИЛС,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ВладелецЭЦПДолжность,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ТелефонМобильный,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ТелефонОсновной,
		|	ДополнительныеРеквизитыУчетнойЗаписи.ТелефонДополнительный,
		|	ДополнительныеРеквизитыУчетнойЗаписи.КодРегионаФСРАР
		|ИЗ
		|	РегистрСведений.ДополнительныеРеквизитыУчетнойЗаписи КАК ДополнительныеРеквизитыУчетнойЗаписи
		|ГДЕ
		|	ДополнительныеРеквизитыУчетнойЗаписи.УчетнаяЗапись = &УчетнаяЗапись";

	Запрос.УстановитьПараметр("УчетнаяЗапись", УчетнаяЗапись);
	ДополнительныеРеквизитыУчетнойЗаписи = Запрос.Выполнить().Выгрузить();
	
	Если ДополнительныеРеквизитыУчетнойЗаписи.Количество() > 0 Тогда
		ТипКриптопровайдераИсходный 		= ДополнительныеРеквизитыУчетнойЗаписи[0].ТипКриптопровайдера;
		КраткоеНаименованиеИсходное 		= ДополнительныеРеквизитыУчетнойЗаписи[0].КраткоеНаименование;
		ПолноеНаименованиеИсходное 			= ДополнительныеРеквизитыУчетнойЗаписи[0].ПолноеНаименование;
		КППИсходный 						= ДополнительныеРеквизитыУчетнойЗаписи[0].КПП;
		ОГРНИсходный 						= ДополнительныеРеквизитыУчетнойЗаписи[0].ОГРН;
		РегНомерПФРИсходный 				= ДополнительныеРеквизитыУчетнойЗаписи[0].РегНомерПФР;
		РегНомерФССИсходный 				= ДополнительныеРеквизитыУчетнойЗаписи[0].РегНомерФСС;
		ЭлектроннаяПочтаИсходная 			= ДополнительныеРеквизитыУчетнойЗаписи[0].ЭлектроннаяПочта;
		ВладелецЭЦПФамилияИсходный 			= ДополнительныеРеквизитыУчетнойЗаписи[0].ВладелецЭЦПФамилия;
		ВладелецЭЦПИмяИсходный 				= ДополнительныеРеквизитыУчетнойЗаписи[0].ВладелецЭЦПИмя;
		ВладелецЭЦПОтчествоИсходный 		= ДополнительныеРеквизитыУчетнойЗаписи[0].ВладелецЭЦПОтчество;
		ВладелецЭЦППодразделениеИсходное 	= ДополнительныеРеквизитыУчетнойЗаписи[0].ВладелецЭЦППодразделение;
		ВладелецЭЦПСНИЛСИсходный 			= ДополнительныеРеквизитыУчетнойЗаписи[0].ВладелецЭЦПСНИЛС;
		ВладелецЭЦПДолжностьИсходная 		= ДополнительныеРеквизитыУчетнойЗаписи[0].ВладелецЭЦПДолжность;
		ТелефонОсновнойИсходный 			= ДополнительныеРеквизитыУчетнойЗаписи[0].ТелефонОсновной;
		ТелефонДополнительныйИсходный 		= ДополнительныеРеквизитыУчетнойЗаписи[0].ТелефонДополнительный;
		КодРегионаФСРАРИсходный 			= ДополнительныеРеквизитыУчетнойЗаписи[0].КодРегионаФСРАР;
	Иначе
		// Если в регистре ДополнительныеРеквизитыУчетнойЗаписи ничего нет, то расхождения реквизитов найти невозможно
		ИзменившиесяРеквизитыОрганизации.СписокИзменившихсяРеквизитов = Неопределено;
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ДополнительныеРеквизитыУчетнойЗаписиПолучатели.ТипПолучателя,
		|	ДополнительныеРеквизитыУчетнойЗаписиПолучатели.КодПолучателя,
		|	ДополнительныеРеквизитыУчетнойЗаписиПолучатели.КПП
		|ИЗ
		|	РегистрСведений.ДополнительныеРеквизитыУчетнойЗаписиПолучатели КАК ДополнительныеРеквизитыУчетнойЗаписиПолучатели
		|ГДЕ
		|	ДополнительныеРеквизитыУчетнойЗаписиПолучатели.УчетнаяЗапись = &УчетнаяЗапись";

	Запрос.УстановитьПараметр("УчетнаяЗапись", УчетнаяЗапись);
	Результат = Запрос.Выполнить().Выгрузить();
	
	// Направляения сдачи отчетности и коды
	СдаватьВФССИсходный 	= Ложь;
	СдаватьВФСРАРИсходный 	= Ложь;
	СдаватьВРПНИсходный 	= Ложь;
	СдаватьВПФРИсходный 	= Ложь;
	КодПФРИсходный 			= "";
	СдаватьВРосстатИсходный = Ложь;
	КодРосстатаИсходный 	= "";
	
	Для Каждого СтрокаНаправлений Из Результат Цикл
		Если СтрокаНаправлений.ТипПолучателя = Перечисления.ТипыКонтролирующихОрганов.ПФР Тогда
			СдаватьВПФРИсходный = Истина;
			КодПФРИсходный = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(СтрокаНаправлений.КодПолучателя);
		ИначеЕсли СтрокаНаправлений.ТипПолучателя = Перечисления.ТипыКонтролирующихОрганов.ФСС Тогда
			СдаватьВФССИсходный = Истина;
		ИначеЕсли СтрокаНаправлений.ТипПолучателя = Перечисления.ТипыКонтролирующихОрганов.ФСГС Тогда
			СдаватьВРосстатИсходный = Истина;
			КодРосстатаИсходный = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(СтрокаНаправлений.КодПолучателя);
		ИначеЕсли СтрокаНаправлений.ТипПолучателя = Перечисления.ТипыКонтролирующихОрганов.ФСРАР Тогда
			СдаватьВФСРАРИсходный = Истина;
		ИначеЕсли СтрокаНаправлений.ТипПолучателя = Перечисления.ТипыКонтролирующихОрганов.РПН Тогда
			СдаватьВРПНИсходный = Истина;
		КонецЕсли;
	КонецЦикла;
	
	// Если не удалось определить тип владельца ЭЦП из-за того что не был доступен сертификат, то 
	// пытаемся определить тип исходя из ФИО
	СтруктураФИОРуководителя = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ФИОФизЛица(Руководитель);
	СтруктураФИОГлБухгалтер = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ФИОФизЛица(ГлБухгалтер);
	// Сравниваем с ФИО руководителя
	Если ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(СтруктураФИОРуководителя.Имя) 
			= ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПИмяИсходный) 
		И ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(СтруктураФИОРуководителя.Отчество) 
			= ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПОтчествоИсходный)
		И ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(СтруктураФИОРуководителя.Фамилия) 
			= ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПФамилияИсходный) Тогда
		ВладелецЭЦПТипИсходный = 1;
	// Сравниваем с ФИО бухгалтера
	ИначеЕсли ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(СтруктураФИОГлБухгалтер.Имя) 
			= ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПИмяИсходный)
		И ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(СтруктураФИОГлБухгалтер.Отчество) 
			= ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПОтчествоИсходный)
		И ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(СтруктураФИОГлБухгалтер.Фамилия) 
			= ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПФамилияИсходный) Тогда
		ВладелецЭЦПТипИсходный = 2;
	Иначе
		// Если владелец ЭЦП не руководитель и не бухгалтер, то мы можем найти его только по ФИО 
		ВладелецЭЦПИсходный = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ФизЛицоПоФИО(
			ВладелецЭЦПФамилияИсходный, ВладелецЭЦПИмяИсходный, ВладелецЭЦПОтчествоИсходный, ВладелецЭЦПСНИЛСИсходный, Организация);

		СотрудникВыборИсходный  = ВладелецЭЦПИсходный;
		СотрудникВыбор 			= СотрудникВыборИсходный;
		
		ВладелецЭЦПТипИсходный = 3;
	КонецЕсли; 
	
	ВладелецЭЦПТип = ВладелецЭЦПТипИсходный;
	ТипВладелецаЭЦП = ВладелецЭЦПТип;
	
	ВладелецЭЦП = Неопределено;
	
	Если ТипВладелецаЭЦП = 1 Тогда
		ВладелецЭЦП = Руководитель;
	ИначеЕсли ТипВладелецаЭЦП = 2 Тогда
		ВладелецЭЦП = ГлБухгалтер;
	ИначеЕсли ТипВладелецаЭЦП = 3 Тогда
		ВладелецЭЦП = СотрудникВыбор;
	КонецЕсли;
	
	ТипЗаполнения = ВладелецЭЦПТипИсходный;
	
 	ДанныеОрганизации.Вставить("Организация", Организация);
	ДанныеСотрудника = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.ПолучитьДанныеСотрудника(ТипЗаполнения, ДанныеОрганизации, ВладелецЭЦП);
	
	ВладелецЭЦПИмя					= ДанныеСотрудника.ФИО.Имя;
	ВладелецЭЦПФамилия				= ДанныеСотрудника.ФИО.Фамилия;
	ВладелецЭЦПОтчество				= ДанныеСотрудника.ФИО.Отчество;
	ВладелецЭЦПДолжность           	= ДанныеСотрудника.Должность;
	ВладелецЭЦППодразделение       	= ДанныеСотрудника.Подразделение;
	ВладелецЭЦПСНИЛС			   	= ДанныеСотрудника.СНИЛС;
	
	ВладелецЭЦПИсходныйНайден = ВладелецЭЦПИсходный <> ПредопределенноеЗначение("Справочник.ФизическиеЛица.ПустаяСсылка");
	
	// Сравниваем исходные и текущие параметры подключения к 1С-Отчетности
	// Изменился ли владелец ЭЦП ?
	//
	ВладелецЭЦПИзменился = ((ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПФамилия) 
								<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПФамилияИсходный) 
							ИЛИ ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПИмя) 
								<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПИмяИсходный) 
							ИЛИ ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПОтчество) 
								<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПОтчествоИсходный)))
							И ВладелецЭЦПИсходныйНайден;// если в базе не найден владелец - значит говорим, что он не изменился
	ВладелецЭЦПИзменился = Ложь; // для целей предупреждения временно не отслеживаем
	
	// Изменились ли реквизиты подключения к 1С-Отчетности ?
	//
	// Краткое наименование
	КраткоеНаименованиеИзменилось = Ложь;// для целей предупреждения не отслеживаем
	
	// Полное наименование
	ПолноеНаименованиеИзменилось = Ложь;// для целей предупреждения не отслеживаем
	
	// КПП
	КППИзменился = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(КПП) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(КППИсходный) И ЗначениеЗаполнено(КПП);
	
	// ОГРН
	ОГРНИзменился = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ОГРН) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ОГРНИсходный) И ЗначениеЗаполнено(СтрокаБезДефисов(ОГРН));
	
	// Регистрационный номер в ПФР
	РегНомерПФРИзменился = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(РегНомерПФР) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(РегНомерПФРИсходный) 
		И СдаватьВПФРИсходный И ЗначениеЗаполнено(СтрокаБезДефисов(РегНомерПФР));
	
	// Регистрационный номер в ФСС
	РегНомерФССИзменился = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(РегНомерФСС) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(РегНомерФССИсходный) 
		И СдаватьВФССИсходный И ЗначениеЗаполнено(СтрокаБезДефисов(РегНомерФСС));
	
	// Регион
	КодРегионаФСРАРИзменился = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(КодРегионаФСРАРИсходный) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(КодРегионаФСРАР) 
		И СдаватьВФСРАРИсходный И ЗначениеЗаполнено(КодРегионаФСРАР) И ЗначениеЗаполнено(КодРегионаФСРАРИсходный);
	
	// Электронная почта
	ЭлектроннаяПочтаИзменилась = Ложь; // для целей предупреждения не отслеживаем
	
	// Телефон основной
	ТелефонОсновнойИзменился = Ложь;// для целей предупреждения не отслеживаем
	
	// Телефон дополнительный
	ТелефонДополнительныйИзменился = Ложь;// для целей предупреждения не отслеживаем
	
	// Сведения о сотруднике – владельце электронной подписи
	
	// Подразделение
	ВладелецЭЦППодразделениеИзменилось = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦППодразделение) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦППодразделениеИсходное) И ВладелецЭЦПИсходныйНайден
		И ЗначениеЗаполнено(ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦППодразделение));
	ВладелецЭЦППодразделениеИзменилось = Ложь; // для целей предупреждения временно не отслеживаем
	
	// Должность
	ВладелецЭЦПДолжностьИзменилась = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПДолжность) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПДолжностьИсходная) И ВладелецЭЦПИсходныйНайден
		И ЗначениеЗаполнено(ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПДолжность));
	ВладелецЭЦПДолжностьИзменилась = Ложь; // для целей предупреждения временно не отслеживаем
	
	// СНИЛС
	ВладелецЭЦПСНИЛСИзменился = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПСНИЛС) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(ВладелецЭЦПСНИЛСИсходный)
		И ВладелецЭЦПИсходныйНайден // владельца ЭЦП удалось определить
		И ЗначениеЗаполнено(СтрокаБезДефисов(ВладелецЭЦПСНИЛС))// СНИЛС не пустой
		И ВладелецЭЦПСНИЛС <> "000-000-000 00" // СНИЛС не нулевой
		И (ВладелецЭЦПТипИсходный = 1 ИЛИ ВладелецЭЦПТипИсходный = 2); // это бухгалтер или директор
	ВладелецЭЦПСНИЛСИзменился = Ложь; // для целей предупреждения временно не отслеживаем
	
	// КодПФР
	КодПФРИзменился = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(КодПФР) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(КодПФРИсходный) 
		И СдаватьВПФРИсходный И ЗначениеЗаполнено(СтрокаБезДефисов(КодПФР));
	
	// КодРосстата
	КодРосстатаИзменился = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(КодРосстата) 
		<> ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСервер.СтрокаВФорматеДляСравнения(КодРосстатаИсходный) 
		И СдаватьВРосстатИсходный И ЗначениеЗаполнено(СтрокаБезДефисов(КодРосстата));
	
	// Добавляем измененные реквизиты в список
	//
	СписокИзменившихсяРеквизитов = Новый СписокЗначений;
	
	// Краткое наименование
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(КраткоеНаименованиеИзменилось, СписокИзменившихсяРеквизитов,
		Перечисления.ПараметрыПодключенияК1СОтчетности.КраткоеНаименование);
	
	// Полное наименование
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(ПолноеНаименованиеИзменилось, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.ПолноеНаименование);
	
	// КПП
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(КППИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.КПП);
	
	// ОГРН
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(ОГРНИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.ОГРН);
	
	// Регистрационный номер в ПФР
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(РегНомерПФРИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.РегНомерПФР);
	
	// Регистрационный номер в ФСС
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(РегНомерФССИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.РегНомерФСС);
	
	// Регион
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(КодРегионаФСРАРИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.КодРегионаФСРАР);
	
	// Электронная почта
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(ЭлектроннаяПочтаИзменилась, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.ЭлектроннаяПочта);
		
	// Телефон основной
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(ТелефонОсновнойИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.ТелефонОсновной);
		
	// КодПФР
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(КодПФРИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.КодПФР);
		
	// КодРосстата
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(КодРосстатаИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.КодРосстата);
		
	// Сведения о сотруднике – владельце электронной подписи
	
	// Владелец ЭЦП
    Если ВладелецЭЦПИзменился Тогда
		ДобавитьРеквизитВСписокИзменившихсяРеквизитов(ВладелецЭЦПИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.ВладелецЭЦП);
	КонецЕсли;
	
	// Подразделение
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(ВладелецЭЦППодразделениеИзменилось, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.ВладелецЭЦППодразделение);
	
	// Должность
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(ВладелецЭЦПДолжностьИзменилась, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.ВладелецЭЦПДолжность);
	
	// СНИЛС
	ДобавитьРеквизитВСписокИзменившихсяРеквизитов(ВладелецЭЦПСНИЛСИзменился, СписокИзменившихсяРеквизитов,  
		Перечисления.ПараметрыПодключенияК1СОтчетности.ВладелецЭЦПСНИЛС);
	
	Если СписокИзменившихсяРеквизитов.Количество() = 0 Тогда
		ИзменившиесяРеквизитыОрганизации.СписокИзменившихсяРеквизитов = Неопределено;
	Иначе
		ИзменившиесяРеквизитыОрганизации.СписокИзменившихсяРеквизитов = СписокИзменившихсяРеквизитов;
	КонецЕсли;

КонецПроцедуры

Функция СтрокаБезДефисов(Текст) Экспорт
	
	Возврат СтрЗаменить(Текст, "-", "");
	
КонецФункции

Функция КодПФР(РеквизитыОрганизации)
	
	ПолученыйКодПФР = "";
	
	Если ПустаяСтрока(РеквизитыОрганизации.КодОрганаПФР) ИЛИ СтрДлина(РеквизитыОрганизации.КодОрганаПФР) < 7 Тогда
		ПолученыйКодПФР = Лев(РеквизитыОрганизации.КодОрганаПФР,7); 
	Иначе
		ПолученыйКодПФР = РеквизитыОрганизации.КодОрганаПФР;
	КонецЕсли;
	
	Возврат ПолученыйКодПФР;
	
КонецФункции

Функция КодРосстата(РеквизитыОрганизации)
	
	Возврат РеквизитыОрганизации.КодОрганаФСГС;
	
КонецФункции


Функция ПредставлениеИзменившихсяРеквизитов(СписокИзменившихсяРеквизитов) Экспорт
	
	Если СписокИзменившихсяРеквизитов = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ИзмененныеРеквизиты = "";
	
	// Краткое наименование
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.КраткоеНаименование, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// Полное наименование
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.ПолноеНаименование, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// КПП
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.КПП, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// ОГРН
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.ОГРН, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// Регистрационный номер в ПФР
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.РегНомерПФР, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// Регистрационный номер в ФСС
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.РегНомерФСС, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// Регион
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.КодРегионаФСРАР, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// Электронная почта
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.ЭлектроннаяПочта, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// КодПФР
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.КодПФР, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// КодРосстата
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.КодРосстата, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	Если НЕ ПустаяСтрока(ИзмененныеРеквизиты) Тогда
		ИзмененныеРеквизиты = ИзмененныеРеквизиты + НСтр("ru = ' организации'");
	КонецЕсли;
	
	// Сведения о сотруднике – владельце электронной подписи
	
	// Владелец ЭЦП
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.ВладелецЭЦП, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
		
	// Должность
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.ВладелецЭЦПДолжность, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
	
	// СНИЛС
	ДобавитьРеквизитКСтроке(Перечисления.ПараметрыПодключенияК1СОтчетности.ВладелецЭЦПСНИЛС, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты);
		
	ВладелецЭЦПДолжностьИзменилась = СписокИзменившихсяРеквизитов.НайтиПоЗначению(Перечисления.ПараметрыПодключенияК1СОтчетности.ВладелецЭЦПДолжность) <> Неопределено;
	ВладелецЭЦПСНИЛСИзменился = СписокИзменившихсяРеквизитов.НайтиПоЗначению(Перечисления.ПараметрыПодключенияК1СОтчетности.ВладелецЭЦПСНИЛС) <> Неопределено;
	
	Если ВладелецЭЦПДолжностьИзменилась ИЛИ ВладелецЭЦПСНИЛСИзменился Тогда
		ИзмененныеРеквизиты = ИзмененныеРеквизиты + НСтр("ru = ' сотрудника-владельца ЭП'");
	КонецЕсли;
	
	ЗаменитьЗапятуюНаИВСтроке(ИзмененныеРеквизиты);
	
	Возврат ИзмененныеРеквизиты;
	
КонецФункции

Процедура ДобавитьРеквизитВСписокИзменившихсяРеквизитов(РеквизитИзменился, СписокИзменившихсяРеквизитов, Перечисление)
	
	РеквизитыНеХранящиесяВБазе = ЭлектронныйДокументооборотСКонтролирующимиОрганамиКлиентСерверПереопределяемый.РеквизитыНеХранящиесяВБазе();
	
	РеквизитЕстьВСправочникеОрганизации = РеквизитыНеХранящиесяВБазе.Найти(Перечисление) = Неопределено;
	
	Если РеквизитИзменился И РеквизитЕстьВСправочникеОрганизации Тогда
		СписокИзменившихсяРеквизитов.Добавить(Перечисление);
	КонецЕсли;
	
КонецПроцедуры

Процедура ДобавитьРеквизитКСтроке(Перечисление, СписокИзменившихсяРеквизитов, ИзмененныеРеквизиты) Экспорт
	
	НазваниеРеквизита = Строка(Перечисление);
	
	// Делаем так, чтобы все слова начинались с маленькой буквы
	// Если вторая буква большая, то считаем что слово целиком состоит из больших букв (например ИНН) и не переводим это слово в нижний регистр
	Если Сред(НазваниеРеквизита, 2, 1) <> Врег(Сред(НазваниеРеквизита, 2, 1)) Тогда
		НазваниеРеквизита = НРег(Лев(НазваниеРеквизита, 1)) + Сред(НазваниеРеквизита, 2);
	КонецЕсли;

	РеквизитИзменился = СписокИзменившихсяРеквизитов.НайтиПоЗначению(Перечисление) <> Неопределено;
	
	Если РеквизитИзменился Тогда
		Если ИзмененныеРеквизиты = "" Тогда
			ИзмененныеРеквизиты = НазваниеРеквизита;
		Иначе
			ИзмененныеРеквизиты = ИзмененныеРеквизиты + "%1" + НазваниеРеквизита;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаменитьЗапятуюНаИВСтроке(ИзмененныеРеквизиты) Экспорт

	// В списке реквизитов заменяем последнюю запятую на букву "и"
	Если СтрЧислоВхождений(ИзмененныеРеквизиты, "%1") = 1 Тогда
		ИзмененныеРеквизиты = СтрЗаменить(ИзмененныеРеквизиты, "%1", " и ");
	ИначеЕсли СтрЧислоВхождений(ИзмененныеРеквизиты, "%1") > 1 Тогда
		МассивПодстрок = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ИзмененныеРеквизиты, "%1");
		ПоследнийЭлементМассива = МассивПодстрок[МассивПодстрок.Количество() - 1];
		ИзмененныеРеквизиты = СтрЗаменить(ИзмененныеРеквизиты, "%1" + ПоследнийЭлементМассива, " и " + ПоследнийЭлементМассива);
	КонецЕсли;
	ИзмененныеРеквизиты = СтрЗаменить(ИзмененныеРеквизиты, "%1", ", ");

КонецПроцедуры

Функция РазобратьСтроку(Строка, СтрокаРазделитель) экспорт
	НоваяСтрока = СтрЗаменить(Строка, СтрокаРазделитель, Символы.ПС);
	МассивСтрок = новый Массив();
	Для i = 1 По СтрЧислоСтрок(НоваяСтрока) Цикл
		МассивСтрок.Добавить(СтрПолучитьСтроку(НоваяСтрока, i));
	КонецЦикла;
	возврат МассивСтрок;
КонецФункции

Функция ПолучитьТипИсполнителя(Тип) Экспорт
	
	Если Тип = Перечисления.ТипыВладельцевЭЦП.Руководитель Тогда
		ТипИсполнителя = 1;
	ИначеЕсли Тип = Перечисления.ТипыВладельцевЭЦП.ГлавныйБухгалтер Тогда
		ТипИсполнителя = 2;
	ИначеЕсли Тип = Перечисления.ТипыВладельцевЭЦП.ДругойСотрудник Тогда
		ТипИсполнителя = 3;
	Иначе
		ТипИсполнителя = 0;
	КонецЕсли;
	
	Возврат ТипИсполнителя;
КонецФункции

Функция ПолучитьТипВладельцаЭЦП(Тип) Экспорт
	
	Если Тип = 1 Тогда
		ТипИсполнителя = Перечисления.ТипыВладельцевЭЦП.Руководитель;
	ИначеЕсли Тип = 2 Тогда
		ТипИсполнителя = Перечисления.ТипыВладельцевЭЦП.ГлавныйБухгалтер;
	Иначе
		ТипИсполнителя = Перечисления.ТипыВладельцевЭЦП.ДругойСотрудник;
	КонецЕсли;
	
	Возврат ТипИсполнителя;
	
КонецФункции

Функция ПолучитьДанныеЗаполнения(СтруктураРеквизитов) Экспорт
	
	Если СтруктураРеквизитов.Организация <> Неопределено Тогда
		ДанныеОрганизации = СтруктураРеквизитов.СтруктураДанныхОрганизации;
		
		ДанныеИсполнителей = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервераПереопределяемый.ПолучитьДанныеОтветственныхЛиц(СтруктураРеквизитов.Организация, Истина);
		ДолжностьРук = "";
		ДолжностьБух = "";
		
		Если ДанныеИсполнителей <> Неопределено И ДанныеИсполнителей.Количество() > 0 Тогда
			ДанныеРук = ДанныеИсполнителей.Получить("Руководитель");
			ДанныеБух = ДанныеИсполнителей.Получить("ГлавныйБухгалтер");
		КонецЕсли;
		
		Если НЕ ПустаяСтрока(ДанныеОрганизации.ФИОРук) Тогда
			
			СтруктураФИО = Новый Структура();
			
			СтруктураФИО.Вставить("Фамилия", 	ДанныеОрганизации.ФамилияРук);
			СтруктураФИО.Вставить("Имя", 		ДанныеОрганизации.ИмяРук);
			СтруктураФИО.Вставить("Отчество", 	ДанныеОрганизации.ОтчествоРук);
			
			ДанныеОрганизации.Вставить("СтруктураФИОРук",СтруктураФИО);
			Если ДанныеРук <> Неопределено Тогда
				ДанныеОрганизации.Вставить("ДолжностьРук", ДанныеРук.Должность);
				ДанныеОрганизации.Вставить("СНИЛСРук", ДанныеРук.СНИЛС);
			КонецЕсли;
			
		КонецЕсли;
		
		Если НЕ ПустаяСтрока(ДанныеОрганизации.ФИОБух) Тогда
			
			СтруктураФИО = Новый Структура();

			СтруктураФИО.Вставить("Фамилия", 	ДанныеОрганизации.ФамилияБух);
			СтруктураФИО.Вставить("Имя", 		ДанныеОрганизации.ИмяБух);
			СтруктураФИО.Вставить("Отчество", 	ДанныеОрганизации.ОтчествоБух);
			
			ДанныеОрганизации.Вставить("СтруктураФИОБух",СтруктураФИО);
			Если ДанныеБух <> Неопределено Тогда
				ДанныеОрганизации.Вставить("ДолжностьБух", ДанныеБух.Должность);
				ДанныеОрганизации.Вставить("СНИЛСБух", ДанныеБух.СНИЛС);
			КонецЕсли;
			
		КонецЕсли;
		СтруктураРеквизитов.Вставить("СтруктураДанныхОрганизации",ДанныеОрганизации);
	КонецЕсли;
	
	Возврат СтруктураРеквизитов;
	
КонецФункции

Функция РазложитьСтрокуВМассивПодстрокКлиент(Знач Строка, Знач Разделитель = ",", Знач ПропускатьПустыеСтроки = Неопределено) Экспорт
	
	Результат = Новый Массив;
	
	// для обеспечения обратной совместимости
	Если ПропускатьПустыеСтроки = Неопределено Тогда
		ПропускатьПустыеСтроки = ?(Разделитель = " ", Истина, Ложь);
		Если ПустаяСтрока(Строка) Тогда 
			Если Разделитель = " " Тогда
				Результат.Добавить("");
			КонецЕсли;
			Возврат Результат;
		КонецЕсли;
	КонецЕсли;
	
	Позиция = Найти(Строка, Разделитель);
	Пока Позиция > 0 Цикл
		Подстрока = Лев(Строка, Позиция - 1);
		Если Не ПропускатьПустыеСтроки Или Не ПустаяСтрока(Подстрока) Тогда
			Результат.Добавить(Подстрока);
		КонецЕсли;
		Строка = Сред(Строка, Позиция + СтрДлина(Разделитель));
		Позиция = Найти(Строка, Разделитель);
	КонецЦикла;
	
	Если Не ПропускатьПустыеСтроки Или Не ПустаяСтрока(Строка) Тогда
		Результат.Добавить(Строка);
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаполнитьДанные(СтруктураРеквизитов)
	
	Если СтруктураРеквизитов.Организация <> Неопределено Тогда
		
		ДанныеОрганизации = ПолучитьДанныеОрганизацииСервер(СтруктураРеквизитов.Организация);
		ДанныеОрганизации.Вставить("Организация", СтруктураРеквизитов.Организация);
		
		Если НЕ СтруктураРеквизитов.Свойство("ПолучитьАдрес") тогда
			
			Если СтруктураРеквизитов.ПриОткрытии И НЕ ПустаяСтрока(СтруктураРеквизитов.АдресЮридический) И НЕ ПустаяСтрока(СтруктураРеквизитов.АдресФактический) Тогда
				АдресЮридический = СтруктураРеквизитов.АдресЮридический;
				АдресФактический = СтруктураРеквизитов.АдресФактический;
			Иначе
				Если ДанныеОрганизации.ТипОрганизации Тогда
					АдресЮридический = ДанныеОрганизации.АдрЮР;
					АдресФактический = ДанныеОрганизации.АдрФакт;
				Иначе
					АдресЮридический = ДанныеОрганизации.АдрМЖ;
					АдресФактический = ДанныеОрганизации.АдрПрописки;
				КонецЕсли;
			КонецЕсли;
			
			Если НЕ СтруктураРеквизитов.ПриОткрытии ИЛИ 
				ПустаяСтрока(СтруктураРеквизитов.АдресЮридический) И ПустаяСтрока(СтруктураРеквизитов.АдресФактический) Тогда
				СтруктураРеквизитов.Вставить("АдресЮридический",РегламентированнаяОтчетностьВызовСервера.ЗаменитьТекстРегионаНаКодРегиона(АдресЮридический));
				СтруктураРеквизитов.Вставить("АдресФактический",РегламентированнаяОтчетностьВызовСервера.ЗаменитьТекстРегионаНаКодРегиона(АдресФактический));
			КонецЕсли;
			СтруктураРеквизитов.Вставить("ЮрАдрес",РегламентированнаяОтчетностьКлиентСервер.ПредставлениеАдресаВФормате9Запятых(АдресЮридический,Истина));
			СтруктураРеквизитов.Вставить("ФактАдрес",РегламентированнаяОтчетностьКлиентСервер.ПредставлениеАдресаВФормате9Запятых(АдресФактический,Истина));
		КонецЕсли;
		СтруктураРеквизитов.Вставить("СтруктураДанныхОрганизации",ДанныеОрганизации);
		
	КонецЕсли;
	
	Если СтруктураРеквизитов.ПриОткрытии Тогда
		СтруктураРеквизитов.Вставить("СпецоператорыСвязи",ПолучитьСпецоператоровСвязи());
		СтруктураРеквизитов.Вставить("ТекстМакетаСоглашение",ПросмотрМакета("ПечатьСоглашениеHTML"));
		СтруктураРеквизитов.Вставить("МакетПараметрыСпецоператоровСвязи",ПолучитьМакетОбработки("ПараметрыСпецоператоровСвязи"));
		СтруктураРеквизитов.Вставить("ЗначениеЗаполненияСпецоператораСвязи",ЗначениеЗаполненияСпецоператораСвязи(СтруктураРеквизитов.Организация));
	КонецЕсли;
	
	
КонецПроцедуры

Функция ПолучитьМакетОбработки(ИмяМакета)  Экспорт
	
	ОбработкаЭДО = ДокументооборотСКОВызовСервера.ПолучитьОбработкуЭДО();
	Возврат ОбработкаЭДО.ПолучитьМакет(ИмяМакета);
	
КонецФункции

Функция ЗначениеЗаполненияСпецоператораСвязи(Организация)
	Спецоператор = Неопределено;
	Попытка
		
		Если Организация = Неопределено Тогда
			ОсновнаяОрганизация = ХранилищеОбщихНастроек.Загрузить(ВРег("ОсновнаяОрганизация"),,, );//ПолучитьЗначениеПоУмолчанию("ОсновнаяОрганизация");
		Иначе
			ОсновнаяОрганизация = Организация;
		КонецЕсли;
		
		Если ОсновнаяОрганизация = Неопределено Тогда
			Возврат Спецоператор;
		КонецЕсли;
		
		РегионИзКПП = Лев(ОсновнаяОрганизация.КПП,2);
		РегионИзИНН = Лев(ОсновнаяОрганизация.ИНН,2);
		
		СтруктураДанныхОрганизации = РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(ОсновнаяОрганизация,ТекущаяДатаСеанса(),"АдрЮР,АдрМЖ");
		
		Если СтрДлина(ОсновнаяОрганизация.ИНН)=10 Тогда
			РегионИзАдреса = СтруктураДанныхОрганизации.АдрЮР;
		Иначе
			РегионИзАдреса = СтруктураДанныхОрганизации.АдрМЖ;
		КонецЕсли;
		
		РегионыФорус = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПолучитьПараметрСпецоператора(Перечисления.СпецоператорыСвязи.Форус, "Регионы");
		РегионИзАдреса = КодРегионаИзАдреса(РегионИзАдреса);
			
			Если (НЕ ПустаяСтрока(РегионИзКПП) И Найти(РегионыФорус,РегионИзКПП)>0) ИЛИ 
				(НЕ ПустаяСтрока(РегионИзИНН) И Найти(РегионыФорус,РегионИзИНН)>0) ИЛИ 
				(НЕ ПустаяСтрока(РегионИзАдреса) И Найти(РегионыФорус,РегионИзАдреса)>0) Тогда
				
				Спецоператор = Перечисления.СпецоператорыСвязи.Форус;
			Иначе
				Спецоператор = Перечисления.СпецоператорыСвязи.КалугаАстрал;
				
			КонецЕсли;
	Исключение
	
	КонецПопытки;
	
	Возврат Спецоператор;
	
КонецФункции

Функция КодРегионаИзАдреса(Знач Адрес)
	
	Если ТипЗнч(Адрес) <> Тип("Структура") Тогда
		Адрес = РегламентированнаяОтчетностьКлиентСервер.РазложитьАдрес(Адрес);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Адрес.Регион) Тогда
		Возврат "";
	КонецЕсли;
	
	МакетРегионы = ПолучитьМакетОбработки("Регионы");
	нрегАдресРегион = нрег(Адрес.Регион);
	Для Инд = 1 По МакетРегионы.ВысотаТаблицы Цикл
		ТекРегион = СокрЛП(МакетРегионы.Область(Инд, 1, Инд, 1).Текст);
		Если Лев(нрегАдресРегион, СтрДлина(ТекРегион)) = нрег(ТекРегион) Тогда
			Возврат СокрЛП(МакетРегионы.Область(Инд, 2, Инд, 2).Текст);
		КонецЕсли;
	КонецЦикла;
	
	Возврат РегламентированнаяОтчетностьВызовСервера.КодРегионаПоНазванию(Адрес.Регион);
	
КонецФункции

Функция ПолучитьДанныеОрганизацииСервер(Организация) Экспорт
	
	РеквизитыОрганизации = "ОГРН,РегНомПФР, РегистрационныйНомерФСС,КодОрганаФСГС,КодПодчиненностиФСС,ТелОрганизации, ТелРук, АдресЭлПочтыИсп,НаимЮЛПол,ИННЮЛ,КППЮЛ,КодОрганаПФР,КодНО,
	|АдрФакт ,АдрЮР, АдрМЖ,АдрПрописки,НаимГоловнОрг,
	|ФИОРук, ФамилияРук, ИмяРук, ОтчествоРук, НомерУдЛичнРук, СерияУдЛичнРук, ВидУдЛичнРук, ДатаУдЛичнРук, ОрганВыданУдЛичнРук, 
	|ФИОБух, ФамилияБух, ИмяБух, ОтчествоБух, НомерУдЛичнБух, СерияУдЛичнБух, ВидУдЛичнБух, ДатаУдЛичнБух, ОрганВыданУдЛичнБух,";
	
	СтруктураДанныхОрганизации = РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(Организация,, РеквизитыОрганизации);
	
	Если Метаданные.Справочники.Организации.Реквизиты.Найти("НаименованиеСокращенное") = Неопределено Тогда
		КраткоеНаименованиеОрганизации = СокрЛП(Организация.Наименование);
	Иначе
		КраткоеНаименованиеОрганизации = СокрЛП(Организация.НаименованиеСокращенное);
	КонецЕсли;
	
	СтруктураДанныхОрганизации.Вставить("КраткоеНаименование", КраткоеНаименованиеОрганизации);
	
	СтруктураДанныхОрганизации.Вставить("НомерОсновнойПоставки1с", ПолучитьНомерОсновнойПоставки1с());
	
	Если НЕ ПустаяСтрока(СтруктураДанныхОрганизации.ВидУдЛичнБух) Тогда
		СтруктураДанныхОрганизации.Вставить("ВидУдЛичнБух", ПолучитьВидДокумента(СтруктураДанныхОрганизации.ВидУдЛичнБух));
	КонецЕсли;
	Если НЕ ПустаяСтрока(СтруктураДанныхОрганизации.ВидУдЛичнРук) Тогда
		СтруктураДанныхОрганизации.Вставить("ВидУдЛичнРук", ПолучитьВидДокумента(СтруктураДанныхОрганизации.ВидУдЛичнРук));
	КонецЕсли;
	
	ТипОрганизации = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ЭтоЮрЛицо(Организация);
	
	СтруктураДанныхОрганизации.Вставить("ТипОрганизации",ТипОрганизации);
	
	Если ТипОрганизации Тогда 
		Если Метаданные.Справочники.Организации.Реквизиты.Найти("ОбособленноеПодразделение") = Неопределено Тогда
			ПризнакОбособленногоПодразделения = НЕ Организация.ГоловнаяОрганизация.Ссылка = Справочники.Организации.ПустаяСсылка();
		Иначе
			ПризнакОбособленногоПодразделения = Организация.ОбособленноеПодразделение;
		КонецЕсли;
		СтруктураДанныхОрганизации.Вставить("ПризнакОбособленногоПодразделения", ПризнакОбособленногоПодразделения);
		СтруктураДанныхОрганизации.Вставить("КрупнейшийНалогоплательщик", Организация.КрупнейшийНалогоплательщик И НЕ ПустаяСтрока(Организация.КодНалоговогоОрганаПолучателя));
	Иначе
		ПризнакОбособленногоПодразделения = Ложь;
	КонецЕсли;
	
	Если ПризнакОбособленногоПодразделения
		И Метаданные.Справочники.Организации.Реквизиты.Найти("ДополнительныйКодФСС") <> Неопределено Тогда
		РеквизитДопКодФСС = Организация.ДополнительныйКодФСС;
	Иначе 
		РеквизитДопКодФСС = "";
	КонецЕсли; 
	
	СтруктураДанныхОрганизации.Вставить("РеквизитДопКодФСС",РеквизитДопКодФСС);
	
	СтруктураДанныхОрганизации.Вставить("ЭлектроннаяПочта",УправлениеКонтактнойИнформацией.ПолучитьКонтактнуюИнформацияОбъекта(Организация,Справочники.ВидыКонтактнойИнформации.EmailОрганизации));
	
	Возврат СтруктураДанныхОрганизации;
	
Конецфункции

Функция ПолучитьВидДокумента(ВидДокумента)
	Возврат Справочники.ВидыДокументовФизическихЛиц.НайтиПоНаименованию(ВидДокумента,Ложь);
КонецФункции

Функция ПолучитьНомерОсновнойПоставки1с() Экспорт
	
	НомерОсновнойПоставки1с = "";
	
	//Если Метаданные.РегистрыСведений.Найти("ПараметрыИнтернетПоддержкиПользователей") = Неопределено Тогда
	//	
	//Иначе
	//	
	//	 Попытка найти среди общих параметров.
	//	Выборка = РегистрыСведений.ПараметрыИнтернетПоддержкиПользователей.Выбрать();
	//	
	//	Пока Выборка.Следующий() Цикл 
	//		
	//		Если НРег("regnumber") = НРег(СокрЛП(Выборка.Имя)) и Строка(Выборка.Пользователь) = "00000000-0000-0000-0000-000000000000" Тогда
	//			
	//			Возврат Выборка.Значение;
	//			
	//		КонецЕсли;
	//		
	//	КонецЦикла;
	//	
	//	 Поиск среди параметров пользователя.
	//	Фильтр = Новый Структура("Пользователь", ПараметрыСеанса.ТекущийПользователь.УникальныйИдентификатор());
	//	
	//	Выборка = РегистрыСведений.ПараметрыИнтернетПоддержкиПользователей.Выбрать(Фильтр);
	//	
	//	Пока Выборка.Следующий() Цикл 
	//		
	//		Если НРег("regnumber") = НРег(СокрЛП(Выборка.Имя)) Тогда
	//			
	//			Возврат Выборка.Значение;
	//			
	//		КонецЕсли;
	//		
	//	КонецЦикла;
	//	
	//КонецЕсли;
	
	Возврат НомерОсновнойПоставки1с;
	
КонецФункции

Функция ПолучитьСпецоператоровСвязи()
	
	Запрос = Новый Запрос;
	Массив = Новый Массив();
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СпецоператорыСвязи.Ссылка
	|ИЗ
	|	Перечисление.СпецоператорыСвязи КАК СпецоператорыСвязи";
	
	Попытка
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			
			СпецоператорыСвязи = Выборка.Ссылка;
			ИмяСпецоператорыСвязи = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПолучитьИмяЗначенияПеречисленияСпецоператорыСвязиПоСинониму(СпецоператорыСвязи);
			Массив.Добавить(Новый Структура("Ссылка,Имя", СпецоператорыСвязи, ИмяСпецоператорыСвязи));
		КонецЦикла;
	Исключение
		Массив = Неопределено;
	КонецПопытки;
	
	Возврат Массив;
	
КонецФункции

Функция ПросмотрМакета(ИмяМакета)
	ШаблонМакета = ПолучитьМакетОбработки(ИмяМакета);
	Макет = ШаблонМакета.ПолучитьТекст();
	Возврат Макет;
КонецФункции

Процедура СохранитьДатуНапоминанияДляИзменившихсяРеквизитов(ИзмененныеПараметрыПодключения, ДатаНапоминания) Экспорт
	
	// Получаем из хранилища общих настроек сведения по изменившимся реквизитам
	ДатыНапоминанийПоИзменившимсяРеквизитам = ХранилищеОбщихНастроек.Загрузить("ДокументооборотСКонтролирующимиОрганами_ДатыНапоминанийПоИзменившимсяРеквизитам");
	
	Если ДатыНапоминанийПоИзменившимсяРеквизитам = Неопределено Тогда
		
		ДатыНапоминанийПоИзменившимсяРеквизитам = Новый ТаблицаЗначений;
		ДатыНапоминанийПоИзменившимсяРеквизитам.Колонки.Добавить("Организация");
		ДатыНапоминанийПоИзменившимсяРеквизитам.Колонки.Добавить("УчетнаяЗапись");
		ДатыНапоминанийПоИзменившимсяРеквизитам.Колонки.Добавить("СписокИзменившихсяРеквизитов");
		ДатыНапоминанийПоИзменившимсяРеквизитам.Колонки.Добавить("ДатаНапоминания");
		
	КонецЕсли;
	
	// Если запись в хранилище общих настроек существует, то обновляем дату напоминания, иначе создаем новую запись 
	Для Каждого СтрокаИзмененныхПараметровПодключения Из ИзмененныеПараметрыПодключения Цикл
		Если ЗначениеЗаполнено(СтрокаИзмененныхПараметровПодключения.СписокИзменившихсяРеквизитов) Тогда
			
			// Ищем строки среди запомненных
			Отбор = Новый Структура; 
			Отбор.Вставить("Организация", СтрокаИзмененныхПараметровПодключения.Организация);
			Отбор.Вставить("УчетнаяЗапись", СтрокаИзмененныхПараметровПодключения.УчетнаяЗаписьДокументооборота);
			СтрокиДатыНапоминанияПоИзменившимсяРеквизитам = ДатыНапоминанийПоИзменившимсяРеквизитам.НайтиСтроки(Отбор);
			Если СтрокиДатыНапоминанияПоИзменившимсяРеквизитам.Количество() > 0 Тогда
				СтрокаДатыНапоминанияПоИзменившимсяРеквизитам = СтрокиДатыНапоминанияПоИзменившимсяРеквизитам[0];
				ДатаНапоминанияПоИзмененнымРеквизитам = СтрокаДатыНапоминанияПоИзменившимсяРеквизитам.ДатаНапоминания;
			Иначе
				СтрокаДатыНапоминанияПоИзменившимсяРеквизитам = Неопределено;
			КонецЕсли;

			// Заполнение данных в строке
			Если СтрокаДатыНапоминанияПоИзменившимсяРеквизитам = Неопределено Тогда
				СтрокаДатыНапоминанияПоИзменившимсяРеквизитам = ДатыНапоминанийПоИзменившимсяРеквизитам.Добавить();
				СтрокаДатыНапоминанияПоИзменившимсяРеквизитам.Организация = СтрокаИзмененныхПараметровПодключения.Организация;
				СтрокаДатыНапоминанияПоИзменившимсяРеквизитам.УчетнаяЗапись = СтрокаИзмененныхПараметровПодключения.УчетнаяЗаписьДокументооборота;
			КонецЕсли;
			СтрокаДатыНапоминанияПоИзменившимсяРеквизитам.СписокИзменившихсяРеквизитов = СтрокаИзмененныхПараметровПодключения.СписокИзменившихсяРеквизитов;
			СтрокаДатыНапоминанияПоИзменившимсяРеквизитам.ДатаНапоминания = ДатаНапоминания;
		КонецЕсли;
	КонецЦикла;
	
	// Если сейчас расхождений нет, но раньше были, то удаляем такие строки из запомненых 
	Счетчик = ИзмененныеПараметрыПодключения.Количество() - 1;
	Пока Счетчик >= 0 Цикл
		
		// Ищем строки среди запомненных
		Отбор = Новый Структура; 
		Отбор.Вставить("Организация", ИзмененныеПараметрыПодключения[Счетчик].Организация);
		Отбор.Вставить("УчетнаяЗапись", ИзмененныеПараметрыПодключения[Счетчик].УчетнаяЗаписьДокументооборота);
		СтрокиДатыНапоминанияПоИзменившимсяРеквизитам = ДатыНапоминанийПоИзменившимсяРеквизитам.НайтиСтроки(Отбор);
		Если СтрокиДатыНапоминанияПоИзменившимсяРеквизитам.Количество() > 0 Тогда
			СтрокаДатыНапоминанияПоИзменившимсяРеквизитам = СтрокиДатыНапоминанияПоИзменившимсяРеквизитам[0];
		Иначе
			СтрокаДатыНапоминанияПоИзменившимсяРеквизитам = Неопределено;
		КонецЕсли;
		
		// Удаляем лишние строки
		Если НЕ ЗначениеЗаполнено(ИзмененныеПараметрыПодключения[Счетчик].СписокИзменившихсяРеквизитов) // сейчас нет изменившихся реквизитов 
			И СтрокаДатыНапоминанияПоИзменившимсяРеквизитам <> Неопределено Тогда // раньше были изменившиеся реквизиты
			ДатыНапоминанийПоИзменившимсяРеквизитам.Удалить(СтрокаДатыНапоминанияПоИзменившимсяРеквизитам);
		КонецЕсли;
		Счетчик = Счетчик - 1;
	КонецЦикла;
	
	ХранилищеОбщихНастроек.Сохранить("ДокументооборотСКонтролирующимиОрганами_ДатыНапоминанийПоИзменившимсяРеквизитам", , ДатыНапоминанийПоИзменившимсяРеквизитам);
	
КонецПроцедуры

Процедура СохранитьДатуНапоминанияДляСертификатов(ИзмененныеПараметрыПодключения, ДатаНапоминания) Экспорт
	
	// Получаем из хранилища общих настроек сведения по сертификатам
	ДатыНапоминанийПоИстекающимСертификатам = ХранилищеОбщихНастроек.Загрузить("ДокументооборотСКонтролирующимиОрганами_НапоминаниеПоИстекающимСертификатам");
	Если ДатыНапоминанийПоИстекающимСертификатам = Неопределено Тогда
		ДатыНапоминанийПоИстекающимСертификатам = Новый ТаблицаЗначений;
		ДатыНапоминанийПоИстекающимСертификатам.Колонки.Добавить("Организация");
		ДатыНапоминанийПоИстекающимСертификатам.Колонки.Добавить("Отпечаток");
		ДатыНапоминанийПоИстекающимСертификатам.Колонки.Добавить("ДействителенПо");
		ДатыНапоминанийПоИстекающимСертификатам.Колонки.Добавить("ДатаНапоминания");
	КонецЕсли;
	
	// Если серификат найден в хранилище общих настроек, то обновляем дату напоминания, иначе создаем новую запись 
	Для Каждого ОтпечатокИстекающегоСертификата Из ИзмененныеПараметрыПодключения Цикл
		Если ЗначениеЗаполнено(ОтпечатокИстекающегоСертификата.ОтпечатокСертификата) Тогда
			
			Отбор = Новый Структура();
			Отбор.Вставить("Организация", ОтпечатокИстекающегоСертификата.Организация);
			Отбор.Вставить("Отпечаток", ОтпечатокИстекающегоСертификата.ОтпечатокСертификата);
			СтрокиДатыНапоминанияПоИстекающемуСертификату = ДатыНапоминанийПоИстекающимСертификатам.НайтиСтроки(Отбор);
			
			Если СтрокиДатыНапоминанияПоИстекающемуСертификату.Количество() > 0 Тогда
				СтрокаДатыНапоминанияПоИстекающемуСертификату = СтрокиДатыНапоминанияПоИстекающемуСертификату[0];
				ДатаНапоминанияПоИстекающемуСертификату = СтрокаДатыНапоминанияПоИстекающемуСертификату.ДатаНапоминания;
			Иначе
				СтрокаДатыНапоминанияПоИстекающемуСертификату = Неопределено;
			КонецЕсли;
			
			Если СтрокаДатыНапоминанияПоИстекающемуСертификату = Неопределено Тогда
				СтрокаДатыНапоминанияПоИстекающемуСертификату = ДатыНапоминанийПоИстекающимСертификатам.Добавить();
				СтрокаДатыНапоминанияПоИстекающемуСертификату.Организация = ОтпечатокИстекающегоСертификата.Организация;
				СтрокаДатыНапоминанияПоИстекающемуСертификату.Отпечаток = ОтпечатокИстекающегоСертификата.ОтпечатокСертификата;
			КонецЕсли;
			СтрокаДатыНапоминанияПоИстекающемуСертификату.ДействителенПо = ОтпечатокИстекающегоСертификата.СертификатДействителенПо;
			СтрокаДатыНапоминанияПоИстекающемуСертификату.ДатаНапоминания = ДатаНапоминания;
		КонецЕсли;
	КонецЦикла;
	
	// если сертификат истек более полугода назад, то делаем ему дату напоминания - Дата(1,1,1) - никогда не напоминать 
	ТекДата = ТекущаяДатаСеанса();
	ИндексДатыНапоминания = ДатыНапоминанийПоИстекающимСертификатам.Количество() - 1;
	Пока ИндексДатыНапоминания >= 0 Цикл
		Если ДатыНапоминанийПоИстекающимСертификатам[ИндексДатыНапоминания].ДействителенПо <= ДобавитьМесяц(ТекДата, -6) Тогда
			ДатыНапоминанийПоИстекающимСертификатам[ИндексДатыНапоминания].ДатаНапоминания = Дата(1,1,1);
		КонецЕсли;
		ИндексДатыНапоминания = ИндексДатыНапоминания - 1;
	КонецЦикла;
	
	ХранилищеОбщихНастроек.Сохранить("ДокументооборотСКонтролирующимиОрганами_НапоминаниеПоИстекающимСертификатам", , ДатыНапоминанийПоИстекающимСертификатам);
	
КонецПроцедуры

Процедура СохранитьДатуНапоминанияДляЛицензий(ИзмененныеПараметрыПодключения,ДатаНапоминания) Экспорт
	
	// Получаем из хранилища общих настроек сведения по лицензиям
	ДатыНапоминанийПоИстекающимЛицензиям = ХранилищеОбщихНастроек.Загрузить("ДокументооборотСКонтролирующимиОрганами_ДатыНапоминанийПоИстекающимЛицензиям");
	
	Если ДатыНапоминанийПоИстекающимЛицензиям = Неопределено Тогда
		
		ДатыНапоминанийПоИстекающимЛицензиям = Новый ТаблицаЗначений;
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("Организация");
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("УчетнаяЗапись");
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("ЛицензияНаименование");
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("ЛицензияДатаОкончания");
		ДатыНапоминанийПоИстекающимЛицензиям.Колонки.Добавить("ДатаНапоминания");
		
	КонецЕсли;
	
	// Если лицензия найдена в хранилище общих настроек, то обновляем дату напоминания, иначе создаем новую запись 
	Для Каждого ЛицензияУчетнойЗаписиПользователя Из ИзмененныеПараметрыПодключения Цикл
		
		Если ЗначениеЗаполнено(ЛицензияУчетнойЗаписиПользователя.ЛицензияНаименование) Тогда
			ПараметрыОтбора =  Новый Структура();
			ПараметрыОтбора.Вставить("Организация", ЛицензияУчетнойЗаписиПользователя.Организация);
			ПараметрыОтбора.Вставить("УчетнаяЗапись", ЛицензияУчетнойЗаписиПользователя.УчетнаяЗаписьДокументооборота);
			ПараметрыОтбора.Вставить("ЛицензияНаименование", ЛицензияУчетнойЗаписиПользователя.ЛицензияНаименование);
			ПараметрыОтбора.Вставить("ЛицензияДатаОкончания", ЛицензияУчетнойЗаписиПользователя.ЛицензияДатаОкончания);
			
			СтрокиДатыНапоминанияПоИстекающейЛицензии = ДатыНапоминанийПоИстекающимЛицензиям.НайтиСтроки(ПараметрыОтбора);
			
			Если СтрокиДатыНапоминанияПоИстекающейЛицензии.Количество() = 0 Тогда
				СтрокаДатыНапоминанияПоИстекающейЛицензии = ДатыНапоминанийПоИстекающимЛицензиям.Добавить();
				СтрокаДатыНапоминанияПоИстекающейЛицензии.Организация = ЛицензияУчетнойЗаписиПользователя.Организация;
				СтрокаДатыНапоминанияПоИстекающейЛицензии.УчетнаяЗапись = ЛицензияУчетнойЗаписиПользователя.УчетнаяЗаписьДокументооборота;
				СтрокаДатыНапоминанияПоИстекающейЛицензии.ЛицензияНаименование = ЛицензияУчетнойЗаписиПользователя.ЛицензияНаименование;
				СтрокаДатыНапоминанияПоИстекающейЛицензии.ЛицензияДатаОкончания = ЛицензияУчетнойЗаписиПользователя.ЛицензияДатаОкончания;
			Иначе
				СтрокаДатыНапоминанияПоИстекающейЛицензии = СтрокиДатыНапоминанияПоИстекающейЛицензии[0]; 
			КонецЕсли;
			СтрокаДатыНапоминанияПоИстекающейЛицензии.ДатаНапоминания = ДатаНапоминания;
		КонецЕсли;
			
	КонецЦикла;
	
	// если лицензия истекла более полугода назад, то делаем ей дату напоминания - Дата(1,1,1) - никогда не напоминать 
	ТекДата = ТекущаяДатаСеанса();
	ИндексДатыНапоминания = ДатыНапоминанийПоИстекающимЛицензиям.Количество() - 1;
	Пока ИндексДатыНапоминания >= 0 Цикл
		Если ДатыНапоминанийПоИстекающимЛицензиям[ИндексДатыНапоминания].ЛицензияДатаОкончания <= ДобавитьМесяц(ТекДата, -6) Тогда
			ДатыНапоминанийПоИстекающимЛицензиям[ИндексДатыНапоминания].ДатаНапоминания = Дата(1,1,1);
		КонецЕсли;
		ИндексДатыНапоминания = ИндексДатыНапоминания - 1;
	КонецЦикла;
	
	ХранилищеОбщихНастроек.Сохранить("ДокументооборотСКонтролирующимиОрганами_ДатыНапоминанийПоИстекающимЛицензиям", , ДатыНапоминанийПоИстекающимЛицензиям);
	
КонецПроцедуры

Функция ПолучитьПараметрыКриптопровайдераПоЗначениюПеречисления(ЗначениеПеречисления) Экспорт
	
	Криптопровайдер = Новый Структура("Тип, Имя, ОтображаемоеНазвание");
	
	Если ЗначениеПеречисления = Перечисления.ТипыКриптоПровайдеров.VipNet Тогда
		Криптопровайдер.Тип = "2";
		Криптопровайдер.Имя = "Infotecs Cryptographic Service Provider";
		Криптопровайдер.ОтображаемоеНазвание = "VipNet CSP"
	ИначеЕсли ЗначениеПеречисления = Перечисления.ТипыКриптоПровайдеров.CryptoPro Тогда
		Криптопровайдер.Тип = "75";
		Криптопровайдер.Имя = "Crypto-Pro GOST R 34.10-2001 Cryptographic Service Provider";
		Криптопровайдер.ОтображаемоеНазвание = "CryptoPro CSP"
	Иначе
		Криптопровайдер.Тип = "0";
		Криптопровайдер.Имя = "";
	КонецЕсли;
	
	Возврат Криптопровайдер;
	
КонецФункции

Функция ЭтотПараметрИзменился(ТабличнаяЧасть, НазваниеРеквизита) Экспорт
	
	СтруктураПоиска = Новый Структура("ИзмененныйРеквизит", НазваниеРеквизита);
	Возврат ТабличнаяЧасть.НайтиСтроки(СтруктураПоиска).Количество() > 0 ;
	
КонецФункции

Функция ПоддерживаетсяВторичноеЗаявление(Организация) Экспорт
	
	УчетнаяЗапись = УчетнаяЗаписьОрганизации(Организация);
	Попытка
		Спецоператор = УчетнаяЗапись.СпецоператорСвязи;
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
	ПоддерживаетсяВторичноеЗаявление = Истина;
	
	СпецоператорПоддерживаетВторичныеЗаявления = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПолучитьПараметрСпецоператора(Спецоператор, "ПоддерживаетсяОтправкаВторичногоЗаявления") = "Истина";
	
	Если НЕ ЗначениеЗаполнено(УчетнаяЗапись) ИЛИ НЕ ЗначениеЗаполнено(Организация) ИЛИ НЕ СпецоператорПоддерживаетВторичныеЗаявления Тогда
		ПоддерживаетсяВторичноеЗаявление = Ложь;
	КонецЕсли;
	
	Возврат ПоддерживаетсяВторичноеЗаявление;
	
КонецФункции

Функция БылиИзменененыРеквизитыПодключенияК1СОтчетности(ТабличнаяЧасть) Экспорт
	
	Возврат ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.КраткоеНаименование)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.ПолноеНаименование)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.КПП)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.ОГРН)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.РегНомерПФР)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.РегНомерФСС)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.КодРегионаФСРАР)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.ЭлектроннаяПочта)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.ТелефонОсновной)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.ТелефонДополнительный)
		ИЛИ ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.НомерОсновнойПоставки1С);
	
КонецФункции
	
Функция БылИзмененСоставКонтролирующихОрганов(ТабличнаяЧасть) Экспорт
	
	СдаватьВФНСИзменился 		= ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.СдаватьВФНС);
	КодыФНСИзменились 			= ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.КодыФНС);
	СдаватьВПФРИзменился 		= ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.СдаватьВПФР);
	КодПФРИзменился 			= ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.КодПФР); 
	СдаватьВФССИзменился 		= ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.СдаватьВФСС);
	СдаватьВРосстатИзменился 	= ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.СдаватьВРосстат);
	КодРосстатаИзменился		= ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.КодРосстата); 
	СдаватьВФСРАРИзменился 		= ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.СдаватьВФСРАР);
	СдаватьВРПНИзменился 		= ЭтотПараметрИзменился(ТабличнаяЧасть, Перечисления.ПараметрыПодключенияК1СОтчетности.СдаватьВРПН);
	
	Возврат СдаватьВФНСИзменился ИЛИ КодыФНСИзменились ИЛИ СдаватьВПФРИзменился ИЛИ КодПФРИзменился 
		ИЛИ СдаватьВФССИзменился ИЛИ СдаватьВРосстатИзменился ИЛИ КодРосстатаИзменился ИЛИ СдаватьВФСРАРИзменился ИЛИ СдаватьВРПНИзменился;
	
	
КонецФункции

Функция УчетнаяЗаписьОрганизации(Организация) Экспорт
	
	ВидОбменаСКонтролирующимиОрганами = ОбщегоНазначения.ПолучитьЗначениеРеквизита(Организация, "ВидОбменаСКонтролирующимиОрганами");
	Если ВидОбменаСКонтролирующимиОрганами = Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате Тогда
		Возврат Организация.УчетнаяЗаписьОбмена;
	Иначе
		Возврат Справочники.УчетныеЗаписиДокументооборота.ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

Функция ПодключенДокументооборотСКонтролирующимОрганом(Организация, КонтролирующийОрган) Экспорт
	
	ДокументооборотПодключен = Ложь;
	
	Если КонтролирующийОрган = Перечисления.ТипыКонтролирующихОрганов.ФНС Тогда
		
		ДокументооборотПодключен = ОрганизацияИспользуетОбменСФНС(Организация);

	ИначеЕсли КонтролирующийОрган = Перечисления.ТипыКонтролирующихОрганов.ПФР Тогда
		
		ДокументооборотПодключен = ОрганизацияИспользуетОбменСПФР(Организация);
		
	ИначеЕсли КонтролирующийОрган = Перечисления.ТипыКонтролирующихОрганов.ФСГС Тогда
		
		ДокументооборотПодключен = ОрганизацияИспользуетОбменСФСГС(Организация);
		
	ИначеЕсли КонтролирующийОрган = Перечисления.ТипыКонтролирующихОрганов.ФСС Тогда
		
		ДокументооборотПодключен = ОрганизацияИспользуетОбменСФСС(Организация);
		
	ИначеЕсли КонтролирующийОрган = Перечисления.ТипыКонтролирующихОрганов.ФСРАР Тогда
		
		ДокументооборотПодключен = ОрганизацияИспользуетОбменСФСРАР(Организация);

	ИначеЕсли КонтролирующийОрган = Перечисления.ТипыКонтролирующихОрганов.РПН Тогда
		
		ДокументооборотПодключен = ОрганизацияИспользуетОбменСРПН(Организация);
		
	КонецЕсли;
		
	
	Возврат ДокументооборотПодключен = Истина; // может вернуться Неопределено
	
КонецФункции

Функция ПараметрыПредупрежденияОСменеРеквизитовПодключенияК1СОтчетности(ТекущаяДатаСервер) Экспорт
	
	ТекущаяДатаСервер = ТекущаяДатаСеанса();
	СписокПараметровПредупреждения = Новый СписокЗначений;
	
	ПараметрыОтбора = Новый Структура();
	ПараметрыОтбора.Вставить("КлючОбъекта","ПараметрыПредупрежденияОСменеРеквизитовПодключенияК1СОтчетности");
	ПараметрыОтбора.Вставить("Пользователь",ИмяПользователя());
	
	ВыборкаНастроек = ХранилищеОбщихНастроек.Выбрать(ПараметрыОтбора);
	
	Пока ВыборкаНастроек.Следующий() Цикл
		СписокПараметровПредупреждения.Добавить(ВыборкаНастроек.Настройки, ВыборкаНастроек.КлючНастроек)
	КонецЦикла;
	
	Возврат СписокПараметровПредупреждения;
	
КонецФункции


Функция ПодключенныеОрганизации(ОтборОрганизации = Неопределено) Экспорт
	
	ТипОтбораОрганизации = ТипЗнч(ОтборОрганизации);
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
						  |	Организации.Ссылка КАК Ссылка
						  |ИЗ
						  |	Справочник.Организации КАК Организации
						  |ГДЕ
						  |	Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами
						  |	И Организации.УчетнаяЗаписьОбмена <> &ПустаяУчетнаяЗаписьОбмена"
						  + ?(ОтборОрганизации <> Неопределено, ?(ТипОтбораОрганизации <> Тип("Массив"), "
						  |	И Организации.Ссылка = &ОтборОрганизации", "
						  |	И Организации.Ссылка В (&ОтборОрганизации)"), "") + "
						  |	И НЕ Организации.ПометкаУдаления
						  |	И НЕ Организации.УчетнаяЗаписьОбмена.ПометкаУдаления");
	Запрос.УстановитьПараметр("ВидОбменаСКонтролирующимиОрганами", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	Запрос.УстановитьПараметр("ПустаяУчетнаяЗаписьОбмена", Справочники.УчетныеЗаписиДокументооборота.ПустаяСсылка());
	Запрос.УстановитьПараметр("ОтборОрганизации", ОтборОрганизации);
	
	Попытка
		ТаблицаЗапроса = Запрос.Выполнить().Выгрузить();
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
	Если ОтборОрганизации <> Неопределено И ТипОтбораОрганизации <> Тип("Массив") Тогда
		Результат = (ТаблицаЗапроса.Количество() > 0);
		
	Иначе
		Результат = Новый Массив;
		Для Каждого СтрокаЗапроса Из ТаблицаЗапроса Цикл
			Результат.Добавить(СтрокаЗапроса.Ссылка);
		КонецЦикла;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ИспользуетсяТестовыйСерверФСС() Экспорт
	
	Возврат ИспользуетсяРежимТестирования();
	
КонецФункции

Функция ИспользуетсяРежимТестирования() Экспорт
	
	Возврат Константы.ДокументооборотСКонтролирующимиОрганами_РежимТестирования.Получить();
	
КонецФункции

Функция СерверПриемаОтчетностиФСС(ТипОтправляемогоДокумента) Экспорт
	
	ИспользуетсяТестовыйСерверФСС = ИспользуетсяТестовыйСерверФСС();
	
	Если ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.Отчет4ФСС Тогда
		
		Если ИспользуетсяТестовыйСерверФСС Тогда
			// Возвращаем адрес тестового сервера
			Возврат "forma4.fss.ru";
			
		Иначе
			// Возвращаем адрес реального сервера
			Возврат "f4.fss.ru";
			
		КонецЕсли;
		
	ИначеЕсли ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС
		ИЛИ ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС Тогда
		
		Если ИспользуетсяТестовыйСерверФСС Тогда
			// Возвращаем адрес тестового сервера
			Возврат "docs-test.fss.ru";
			
		Иначе
			// Возвращаем адрес реального сервера
			Возврат "docs.fss.ru";
			
		КонецЕсли;
	
	Иначе
		
		Возврат Неопределено;
		
	КонецЕсли;
	
КонецФункции

Функция СформироватьИмяФайла(ИсходноеИмяФайла) Экспорт
	
	ИмяФайла = СтрЗаменить(ИсходноеИмяФайла, "/", "_");
	ИмяФайла = СтрЗаменить(ИмяФайла, "\", "_");
	ИмяФайла = СтрЗаменить(ИмяФайла, ":", "_");
	ИмяФайла = СтрЗаменить(ИмяФайла, "*", "_");
	ИмяФайла = СтрЗаменить(ИмяФайла, "?", "_");
	ИмяФайла = СтрЗаменить(ИмяФайла, """","_");
	ИмяФайла = СтрЗаменить(ИмяФайла, "<", "_");
	ИмяФайла = СтрЗаменить(ИмяФайла, ">", "_");
	Возврат СтрЗаменить(ИмяФайла, "|", "_");
	
КонецФункции

Функция РазницаДатВМесяцах(Дата1, Дата2) Экспорт
	
	ДатаНач	= ?(Дата1 < Дата2, Дата1, Дата2);
	ДатаКон	= ?(Дата1 < Дата2, Дата2, Дата1);
		
	Годы    = Год( датаКон ) - Год( датаНач );
	Месяцы  = Месяц( датаКон ) - Месяц( датаНач );

	Разность = месяцы + годы * 12;

	Возврат Разность;

КонецФункции

Процедура ПриЗаписиЭлектронногоПредставленияРегламентированногоОтчета(Объект, Отказ)
	
	Возврат;
КонецПроцедуры

Функция ПолучитьОсновныеСвойстваИзКвитанцииОПриеме(СтрКвитанция) Экспорт
	
	Если НЕ ЗначениеЗаполнено(СтрКвитанция) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// создаем дерево на основе строки XML
	ОписаниеОшибки = "";
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений( , СтрКвитанция, ОписаниеОшибки);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Ошибка разбора XML квитанции о приеме:%1'"),
			Символы.ПС + ИнформацияОбОшибке().Описание);
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	// анализируем XML
	УзелФайл = ДеревоXML.Строки.Найти("Файл", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелФайл) Тогда
		ТекстСообщения = НСтр("ru = 'Некорректная структура XML квитанции о приеме: не обнаружен узел ""Файл"".'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	УзелДокумент = УзелФайл.Строки.Найти("Документ", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелДокумент) Тогда
		ТекстСообщения = НСтр("ru = 'Некорректная структура XML квитанции о приеме: не обнаружен узел ""Документ"".'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	УзелСвКвит = УзелДокумент.Строки.Найти("СвКвит", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелСвКвит) Тогда
		ТекстСообщения = НСтр("ru = 'Некорректная структура XML квитанции о приеме: не обнаружен узел ""СвКвит"".'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Возврат Неопределено;
	КонецЕсли;
	
	// разбираем узел с общими сведениями
	ОбщиеСведения = Новый Структура;
	Для Каждого УзелОбщСвед Из УзелСвКвит.Строки Цикл
		ОбщиеСведения.Вставить(УзелОбщСвед.Имя, СокрЛП(УзелОбщСвед.Значение));
	КонецЦикла;
	
	Если ОбщиеСведения.Свойство("ДатаПредст") И ОбщиеСведения.Свойство("ВремПредст") Тогда
		ОбщиеСведения.Вставить("ДатаВремяПредст", ОбщиеСведения.ДатаПредст + " " + ОбщиеСведения.ВремПредст);
	КонецЕсли;
	Если ОбщиеСведения.Свойство("Период") И ОбщиеСведения.Свойство("ПериодНаим") Тогда
		ОбщиеСведения.Вставить("ОтчетПериод", ОбщиеСведения.Период + " (" + ОбщиеСведения.ПериодНаим + ")");
	КонецЕсли;
	
	// разбираем сведения о налоговом органе который подтвердил получение отчетности
	НалОргПодт = СокрЛП(УзелДокумент.Строки.Найти("НаимНОПодт", "Имя").Значение);
	КодНалОргПодт = СокрЛП(УзелДокумент.Строки.Найти("КодНОПодт", "Имя").Значение);
	
	Если НалОргПодт <> КодНалОргПодт Тогда
		НалОргПодт = КодНалОргПодт + " (" + НалОргПодт + ")";
	КонецЕсли;
	
	// разбираем сведения о налоговом органе в который поступила отчетность
	УзелСвНалОргПост = УзелДокумент.Строки.Найти("СвНалОргПост", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелСвНалОргПост) Тогда
		ТекстСообщения = НСтр("ru = 'Некорректная структура XML квитанции: не обнаружен узел ""СвНалОргПост"".'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения);
		Отказ = Истина;
		Возврат Неопределено;
	КонецЕсли;
	
	НалоговыйОрганПост = "";
	
	УзелКодНО = УзелСвНалОргПост.Строки.Найти("КодНО", "Имя");
	Если ЗначениеЗаполнено(УзелКодНО) Тогда
		НалоговыйОрганПост = СокрЛП(УзелКодНО.Значение);
	КонецЕсли;
	
	УзелНаимНО = УзелСвНалОргПост.Строки.Найти("НаимНО", "Имя");
	Если ЗначениеЗаполнено(УзелНаимНО) Тогда
		Если ЗначениеЗаполнено(НалоговыйОрганПост) Тогда
			НаименованиеНО = СокрЛП(УзелНаимНО.Значение);
			Если НалоговыйОрганПост <> НаименованиеНО Тогда
				НалоговыйОрганПост = НалоговыйОрганПост + " (" + НаименованиеНО + ")";
			КонецЕсли;
		Иначе
			НалоговыйОрганПост = СокрЛП(УзелНаимНО.Значение);
		КонецЕсли;
	КонецЕсли;
	
	// Сведения об отправителе отчетности
	ПредставлениеОтпр = "";
	ДанныеОтправителя = УзелДокумент.Строки.Найти("СвОтпр", "Имя");
	ОтпрЮЛ = ДанныеОтправителя.Строки.Найти("ОтпрЮЛ", "Имя");
	ОтпрФЛ = ДанныеОтправителя.Строки.Найти("ОтпрФЛ", "Имя");
	
	Если ЗначениеЗаполнено(ОтпрФЛ) Тогда
		ПредставлениеОтпр = ПолучитьПредставлениеНП(Ложь,ОтпрФЛ);
	ИначеЕсли ЗначениеЗаполнено(ОтпрЮЛ) Тогда
		ПредставлениеОтпр = ПолучитьПредставлениеНП(Истина,ОтпрЮЛ);
	КонецЕсли;
	
	// Сведения о налогоплательщике
	ПредставлениеНП = ""; 	
	ДанныеОтправителя = УзелДокумент.Строки.Найти("СвНП", "Имя");
	ОтпрФЛ = ДанныеОтправителя.Строки.Найти("НПФЛ", "Имя");
	ОтпрЮЛ = ДанныеОтправителя.Строки.Найти("НПЮЛ", "Имя");
	
	Если ЗначениеЗаполнено(ОтпрФЛ) Тогда
		ПредставлениеНП = ПолучитьПредставлениеНП(Ложь,ОтпрФЛ);
	ИначеЕсли ЗначениеЗаполнено(ОтпрЮЛ) Тогда
		ПредставлениеНП = ПолучитьПредставлениеНП(Истина,ОтпрЮЛ);
	КонецЕсли;
	
	Возврат Новый Структура("НалоговыйОрганПодтверждающий, НалоговыйОрганПолучатель, ОбщиеСведения, ПредставлениеНП, ПредставлениеОтпр", НалОргПодт, НалоговыйОрганПост, ОбщиеСведения, ПредставлениеНП, ПредставлениеОтпр);
	
КонецФункции

Функция ПолучитьПредставлениеНП(ЮрФизЛицо,ДанныеНП)
	
	Представление = "";
	
	Если ЮрФизЛицо Тогда
		Если ДанныеНП.Строки.Количество() > 0 Тогда
			
			ИННСтрока = "";
			КППСтрока = "";
			НаимСтрока = "";
			Для Каждого УзелОбщСведНП Из ДанныеНП.Строки Цикл
				ДанныеСтроки = СокрЛП(УзелОбщСведНП.Значение);
				Если Лев(УзелОбщСведНП.Имя,3) = "ИНН" Тогда
					ИННСтрока = ", "+ДанныеСтроки;
				ИначеЕсли УзелОбщСведНП.Имя = "КПП" Тогда
					КППСтрока = " / "+ДанныеСтроки;
				ИначеЕсли УзелОбщСведНП.Имя = "НаимОрг" Тогда
					НаимСтрока = ДанныеСтроки;
				КонецЕсли;
			КонецЦикла;
			
			Представление = НаимСтрока + ИННСтрока + КППСтрока;
			
		КонецЕсли;
	Иначе
		
		ФИОДанныеНП = ДанныеНП.Строки.Найти("ФИО", "Имя");
		
		Если НЕ ЗначениеЗаполнено(ФИОДанныеНП) Тогда
			ФИОДанныеНП = ДанныеНП.Родитель.Строки.Найти("ФИО", "Имя");
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ФИОДанныеНП) Тогда
			Для Каждого СтрокаФИО Из ФИОДанныеНП.Строки Цикл
				Представление = Представление+ " " +СтрокаФИО.Значение;
			КонецЦикла; 
		КонецЕсли;
		
		ИННДанныеНП = ДанныеНП.Строки.Найти("ИННФЛ", "Имя");
		
		Если ЗначениеЗаполнено(ИННДанныеНП) Тогда
			Представление = Представление + ", " + ИННДанныеНП.Значение;
		КонецЕсли;
	
	КонецЕсли;
	
	Возврат СокрЛП(Представление);
	
КонецФункции

// есть в Контейнере
Функция ОпределитьОрганПФРОрганизации(Организация) Экспорт
     
     КодОрганаПФР = СокрЛП(РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(Организация, , "КодОрганаПФР").КодОрганаПФР);
     Если НЕ ЗначениеЗаполнено(КодОрганаПФР) Тогда
          Возврат Неопределено;
     Иначе
          Возврат Справочники.ОрганыПФР.НайтиПоКоду(КодОрганаПФР);
     КонецЕсли;
     
 КонецФункции

///////////////////////////////////////////////////////////////////////////////
// Функции с использованием общих модулей и дублирующие функции для организации
// вызовов общих модулей при документообороте с РПН

Функция ВыгрузитьПакетДляОтправкиВРПНЭлектроннаяПодписьВМоделиСервиса(ПараметрыФункции) Экспорт
	
	ТекстФайлаВыгрузки = ПараметрыФункции.ТекстФайлаВыгрузки;
	ИдентификаторДокументооборота = ПараметрыФункции.Идентификатор;
	
	СертификатыПолучателей = Новый Массив;
	Для Каждого ЭлементСписка Из ПараметрыФункции.Сертификаты Цикл
		СертификатыПолучателей.Добавить(ЭлементСписка.Значение);
	КонецЦикла;
	
	ИмяФайлаВыгрузки = ПараметрыФункции.ИмяФайлаВыгрузки;
	Кодировка = ПараметрыФункции.Кодировка;
	ЭтоНеподписываемыйОтчет = ПараметрыФункции.ЭтоНеподписываемыйОтчет;
	
	// инициализируем объект для работы с двоичными данными
	ДвДанные = Неопределено;
	ВременныйКаталог = КаталогВременныхФайловДвоичныхДанных(ДвДанные);
	Если ДвДанные = Неопределено Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'Ошибка при инициализации объекта для работы с двоичными данными!'"));
		Возврат Неопределено;
	КонецЕсли;
	
	//Получим имя временного файла
	ПолноеИмяФайлаВыгрузки = ВременныйКаталог + ИмяФайлаВыгрузки;
	
	// при необходимости конвертируем текст выгрузки в нужную кодировку
	ТекстФайлаВыгрузки64 = Неопределено;
	Если ЭтоНеподписываемыйОтчет И ЗначениеЗаполнено(Кодировка) Тогда
		ТекстФайлаВыгрузки64 = ТекстВКодировке64(ТекстФайлаВыгрузки, Кодировка);
	КонецЕсли;
	
	Попытка
		Если НЕ ЗначениеЗаполнено(ТекстФайлаВыгрузки64) Тогда
			ДвДанные.ДобавитьСтроку(ТекстФайлаВыгрузки);
		Иначе
			ДвДанные.ДобавитьИзСтрокиBase64(ТекстФайлаВыгрузки64, Ложь);
		КонецЕсли;
		ДвДанные.Записать(ПолноеИмяФайлаВыгрузки);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ЗаписьЖурналаРегистрации(НСтр("ru = 'Электронная подпись в модели сервиса.Работа с двоичными данными'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,,, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	РезультатВыгрузки = Неопределено;
	Если НЕ ЭтоНеподписываемыйОтчет Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru = 'В настоящее время сервис не поддерживается'"));
		Возврат Неопределено;
		
	Иначе
		ДанныеВыгрузки = Новый ДвоичныеДанные(ПолноеИмяФайлаВыгрузки);
		РезультатВыгрузки = ПоместитьВоВременноеХранилище(ДанныеВыгрузки, ПараметрыФункции.Адрес);
	КонецЕсли;
	
	Результат = Новый Структура("РезультатВыгрузки, ИмяФайлаВыгрузки", РезультатВыгрузки, ИмяФайлаВыгрузки);
	Возврат Результат;
	
КонецФункции

Функция СформироватьФайлОтправкиВРПНССервера(КороткоеИмяФайлаВыгрузки, СтрокаBase64ФайлаВыгрузки, ЭтоАдреса = Истина, Адрес = Неопределено) Экспорт
	
	// формируем файл с запросами для отсылки данных.
	ДвДанные = Неопределено;
	ВременныйКаталог = КаталогВременныхФайловДвоичныхДанных(ДвДанные);
	Если ДвДанные = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ИмяФайлаОтправки = ВременныйКаталог + Строка(Новый УникальныйИдентификатор);
	
	// формируем POST-данные.
	СодержимоеФайла = "--My1cV8bNdr"
	+ Символы.ВК + Символы.ПС + "Content-Disposition: form-data; name=""fileUpload""; filename=""" + КороткоеИмяФайлаВыгрузки + """"
	+ Символы.ВК + Символы.ПС + "Content-Type: application/octet-stream"
	+ Символы.ВК + Символы.ПС
	+ Символы.ВК + Символы.ПС + "*"
	+ Символы.ВК + Символы.ПС + "--My1cV8bNdr"
	+ Символы.ВК + Символы.ПС + "Content-Disposition: form-data; name=""Submit"""
	+ Символы.ВК + Символы.ПС
	+ Символы.ВК + Символы.ПС + "Submit"
	+ Символы.ВК + Символы.ПС + "--My1cV8bNdr--";
	
	ДвДанные.ДобавитьСтроку(СодержимоеФайла);
	ДвДанные.Записать(ИмяФайлаОтправки);
	
	ЗаменитьМаркерВЗапросеДвоичнымиДаннымиСервер(ИмяФайлаОтправки, СтрокаBase64ФайлаВыгрузки, ЭтоАдреса, Адрес);
	
	Возврат ИмяФайлаОтправки;
	
КонецФункции

//////////////////////////////////////////////////////////////////////////////////
//// ДОКУМЕНТООБОРОТ С РПН, код без использования вызовов общих модулей
////

Функция ОбновитьРезультатКонкретнойОтправкиРПНССервера(Знач ОтправкаСсылка, Знач ОтправкаОбъектЗагружен, Знач ПараметрыОтправки, ПараметрыСоединения, Знач ВызовИзАвтозапроса = Ложь) Экспорт
	
	Если ОтправкаОбъектЗагружен Тогда
		ОсновныеРеквизитыОтправки = Новый Структура("ОтчетСсылка, ИмяФайлаПакета, ИдентификаторОтправкиНаСервере, СтатусОтправки, СтатусПроверкиНаПортале",
			ОтправкаСсылка.ОтчетСсылка, ОтправкаСсылка.ИмяФайлаПакета, ОтправкаСсылка.ИдентификаторОтправкиНаСервере, ОтправкаСсылка.СтатусОтправки, ОтправкаСсылка.СтатусПроверкиНаПортале);
	Иначе
		ОсновныеРеквизитыОтправки = ЗначенияРеквизитовОбъекта(ОтправкаСсылка, "ОтчетСсылка, ИмяФайлаПакета, ИдентификаторОтправкиНаСервере, СтатусОтправки, СтатусПроверкиНаПортале");
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(ПараметрыСоединения.ИдентификаторОтправкиНаСервере) Тогда
		ПараметрыСоединения.ИдентификаторОтправкиНаСервере = ОсновныеРеквизитыОтправки.ИдентификаторОтправкиНаСервере;
	КонецЕсли;
	
	РезультатОтправки = ПолучитьРезультатОтправкиРПН(ОсновныеРеквизитыОтправки, ПараметрыОтправки, ПараметрыСоединения, ВызовИзАвтозапроса, ОтправкаСсылка);
	
	ПараметрыСоединения.СоединениеHTTP = Неопределено;
	
	СохранитьРезультатОтправкиРПН(ОтправкаСсылка, РезультатОтправки);
	
	Возврат (РезультатОтправки <> Неопределено);
	
КонецФункции

Функция СохранитьРезультатОтправкиРПН(ОтправкаСсылка, РезультатОтправки)
	
	Если РезультатОтправки <> Неопределено Тогда
		ОтправкаОбъект = ОтправкаСсылка.ПолучитьОбъект();
		ОтправкаОбъект.ДатаПолученияРезультата = РезультатОтправки.ДатаПолученияРезультата;
		ОтправкаОбъект.ИдентификаторОтправкиНаСервере = РезультатОтправки.ИдентификаторОтправкиНаСервере;
		ОтправкаОбъект.СтатусОтправки = РезультатОтправки.СтатусОтправки;
		ОтправкаОбъект.СтатусПроверкиНаПортале = РезультатОтправки.СтатусПроверкиНаПортале;
		ОтправкаОбъект.Протокол = Новый ХранилищеЗначения(РезультатОтправки.Протокол);
		ОтправкаОбъект.Записать();
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьРезультатОтправкиРПН(ОсновныеРеквизитыОтправки, ПараметрыОтправки, ПараметрыСоединения, ВызовИзАвтозапроса, ОтправкаСсылка)
	
	СтатусОтчета = "";
	ЦветСтатуса = Новый Цвет(0, 0, 192);
	СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен;
	
	//запрос результатов обработки
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ПараметрыСоединения.ПовторятьЗапросПароля = Ложь;
	
	ЗаголовокОтчета = ПолучитьИнформациюОбОтчетеНаПорталеРПН(ОсновныеРеквизитыОтправки.ИмяФайлаПакета, ПараметрыОтправки, ПараметрыСоединения);
	
	УспешноОбработан = Неопределено;
	ПройденаПроверкаНаПортале = Неопределено;
	Если ЗаголовокОтчета <> Неопределено Тогда
		УспешноОбработан = УспешноОбработанОтчетРПН(ЗаголовокОтчета.ИдентификаторЗаписи, ЗаголовокОтчета.Состояние, ПройденаПроверкаНаПортале);
	КонецЕсли;
	
	Если ЗаголовокОтчета <> Неопределено И НЕ ПараметрыСоединения.ПовторятьСоединение Тогда
		
		// получен протокол обработки и отсутствовали ошибки соединения
		
		// анализируем содержимое страницы протокола обработки
		Если УспешноОбработан = Истина Тогда
			// отчет принят
			СтатусОтправки = Перечисления.СтатусыОтправки.Сдан;
			СтатусПроверкиНаПортале = Перечисления.СтатусыОтправки.Сдан;
			СтатусОтчета = НСтр("ru = 'Отчет принят, ошибок не обнаружено.'");
			ЦветСтатуса = Новый Цвет(0, 179, 16);
			
		ИначеЕсли УспешноОбработан = Ложь Тогда
			// отчет не принят
			СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят;
			Если ПройденаПроверкаНаПортале = Истина Тогда
				СтатусПроверкиНаПортале = Перечисления.СтатусыОтправки.Сдан;
				СтатусОтчета = НСтр("ru = 'Отчет не принят, обнаружены ошибки при проверке в управлении.'");
			Иначе
				СтатусПроверкиНаПортале = Перечисления.СтатусыОтправки.НеПринят;
				СтатусОтчета = НСтр("ru = 'Отчет не принят, обнаружены ошибки.'");
			КонецЕсли;
			ЦветСтатуса = Новый Цвет(255, 0, 0);
			
		Иначе
			// отчет еще не обработан
			Если ПройденаПроверкаНаПортале = Истина Тогда
				// неполный идентификатор начинается с пяти звездочек
				Если Лев(ЗаголовокОтчета.ИдентификаторЗаписи, 5) = "*****" Тогда
					СтатусОтчета = НСтр("ru = 'Отчет находится в обработке, обработан на портале и ждет доставки в управление.'");
				Иначе
					СтатусОтчета = НСтр("ru = 'Отчет находится в обработке, на проверке в управлении.'");
				КонецЕсли;
				СтатусПроверкиНаПортале = Перечисления.СтатусыОтправки.Сдан;
			Иначе
				СтатусОтчета = НСтр("ru = 'Отчет находится в обработке.'");
			КонецЕсли;
		КонецЕсли;
		
		Протокол = ГенерироватьHTMLПротоколаОбработкиРПН(ЗаголовокОтчета, СтатусОтчета, ЦветСтатуса, СтатусОтправки, ПараметрыОтправки, ОсновныеРеквизитыОтправки.ОтчетСсылка);
		
		//заполняем результирующую структуру
		Результат = Новый Структура("ДатаПолученияРезультата, ИдентификаторОтправкиНаСервере, СтатусОтправки, СтатусПроверкиНаПортале, Протокол",
			ТекущаяДатаСеанса(), ЗаголовокОтчета.ИдентификаторЗаписи, СтатусОтправки, СтатусПроверкиНаПортале, Протокол);
		
	ИначеЕсли ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) ИЛИ НЕ ПараметрыСоединения.ПовторятьСоединение Тогда
		
		Если ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) Тогда
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Результаты отправки не получены с портала. %1'"), ПараметрыСоединения.ОписаниеОшибкиСервером) + ?(ВызовИзАвтозапроса, "", " " + НСтр("ru = 'Попробуйте через некоторое время использовать в отчете кнопку ""Обновить состояние отправки"".'")), ПараметрыСоединения.СообщенияПользователю);
		Иначе
			СообщитьПользователю(НСтр("ru = 'Не удалось получить результаты отправки с портала Росприроднадзора.'") + ?(ВызовИзАвтозапроса, "", " " + НСтр("ru = 'Возможно, портал перегружен. Попробуйте через некоторое время использовать в отчете кнопку ""Обновить состояние отправки"".'")), ПараметрыСоединения.СообщенияПользователю);
		КонецЕсли;
		Результат = Неопределено;
		
	Иначе
		
		// возможно, проблемы с доступом в интернет
		Результат = Неопределено;
		
	КонецЕсли;
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	
	Возврат Результат;
	
КонецФункции

Функция ПроверитьПередОтправкойВРПН(Отчет, ТекстВопроса) Экспорт
	
	ТекущаяОтправка = ПолучитьПоследнююОтправкуОтчетаВРПН(Отчет);
	Если ЗначениеЗаполнено(ТекущаяОтправка) Тогда
		СтатусОтправки = ТекущаяОтправка.СтатусОтправки;
		Если СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен Тогда
			ТекстВопроса = НСтр("ru = 'Отчет уже отправлен, результат отправки не получен.
									  |Вы действительно хотите отправить отчет повторно?'");
			Возврат Ложь;
		ИначеЕсли СтатусОтправки = Перечисления.СтатусыОтправки.Сдан Тогда
			ТекстВопроса = НСтр("ru = 'Отчет уже отправлен и успешно сдан.
									  |Вы действительно хотите отправить отчет повторно?'");
			Возврат Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

Функция ОтправкаНаСерверРПН(ФайлыИДанныеОтправки, ОтчетСсылка, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ПараметрыСоединения.ПовторятьЗапросПароля = Ложь;
	ЗаголовокОтчета = Неопределено;
	
	ОтправкаПроизведена = ОтправитьЗашифрованныйПакетНаСерверРПН(ФайлыИДанныеОтправки, ПараметрыОтправки, ПараметрыСоединения);
	
	Если ОтправкаПроизведена Тогда
		
		ПараметрыСоединения.ПовторятьСоединение = Ложь;
		
		//отправленный файл принят сервером
		НоваяЗапись = Справочники.ОтправкиРПН.СоздатьЭлемент();
		НоваяЗапись.ОтчетСсылка = ОтчетСсылка;
		НоваяЗапись.ИдентификаторОтправкиНаСервере = ПараметрыСоединения.ИдентификаторОтправкиНаСервере;
		ДвоичныеДанныеПакета = Новый ДвоичныеДанные(ФайлыИДанныеОтправки.ИмяФайлаПакета);
		НоваяЗапись.ЗашифрованныйПакет = Новый ХранилищеЗначения(ДвоичныеДанныеПакета);
		НоваяЗапись.ИмяФайлаПакета = ФайлыИДанныеОтправки.КороткоеИмяФайлаПакета;
		НоваяЗапись.СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен;
		НоваяЗапись.ДатаОтправки = ТекущаяДатаСеанса();
		НоваяЗапись.Организация = ?(ОтчетСсылка <> Неопределено, ОтчетСсылка.Организация, Неопределено);
		НоваяЗапись.ДатаНачалаПериода = ПараметрыОтправки.ПоляДляЗаписиОтправки.ДатаНачалаПериода;
		НоваяЗапись.ДатаОкончанияПериода = ПараметрыОтправки.ПоляДляЗаписиОтправки.ДатаОкончанияПериода;
		
		Если ОтчетСсылка <> Неопределено И ТипЗнч(ОтчетСсылка) = Тип("ДокументСсылка.РегламентированныйОтчет") Тогда
			НоваяЗапись.ВидОтчета = Справочники.ВидыОтправляемыхДокументов.НайтиПоРеквизиту("Источник", ОтчетСсылка.ИсточникОтчета)
			
		Иначе // электронные представления
			НоваяЗапись.ВидОтчета = ?(ОтчетСсылка <> Неопределено, ОтчетСсылка.ВидОтчета, Неопределено);
		КонецЕсли;
		
		НоваяЗапись.Версия = ПараметрыОтправки.ПоляДляЗаписиОтправки.Версия;
		НоваяЗапись.СтатусПроверкиНаПортале = Перечисления.СтатусыОтправки.Отправлен;
		НоваяЗапись.ПредставлениеПериода = ПредставлениеПериода(НоваяЗапись.ДатаНачалаПериода, КонецДня(НоваяЗапись.ДатаОкончанияПериода), "ФП=Истина");
		НоваяЗапись.ПредставлениеВидаДокумента = ПредставлениеВидаДокумента(НоваяЗапись.Версия);
		НоваяЗапись.Записать();
		
		Результат = НоваяЗапись.Ссылка;
		
		Возврат Результат;
		
	ИначеЕсли (ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) ИЛИ НЕ ПараметрыСоединения.ПовторятьСоединение) Тогда
		
		ЭтоРегламентированныйОтчет = (ТипЗнч(ОтчетСсылка) = Тип("ДокументСсылка.РегламентированныйОтчет") ИЛИ ТипЗнч(ОтчетСсылка) = Тип("Неопределено"));
		
		Если ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером) Тогда
			
			//отправленный файл не был принят сервером, получено описание ошибки
			Если Прав(ПараметрыСоединения.ОписаниеОшибкиСервером, 1) <> "." И Прав(ПараметрыСоединения.ОписаниеОшибкиСервером, 1) <> "!" Тогда
				ПараметрыСоединения.ОписаниеОшибкиСервером = ПараметрыСоединения.ОписаниеОшибкиСервером + ".";
			КонецЕсли;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Отчет не принят порталом. %1'"), ПараметрыСоединения.ОписаниеОшибкиСервером) + " " + НСтр("ru = 'Портал находится на стадии пилотного проекта.'") + " " + ?(ЭтоРегламентированныйОтчет И НЕ ПараметрыОтправки.ЭтоНеподписываемыйОтчет,
				НСтр("ru = 'Для отправки отчета выгрузите его в файл, используя меню ""Выгрузка"" - ""Выгрузить для портала Росприроднадзора"".'"), НСтр("ru = 'Для отправки отчета выгрузите его в файл, используя меню ""Еще"" - ""Выгрузить"".'"))
				+ " " + ПодставитьПараметрыВСтроку(НСтр("ru = 'Далее отправьте данный файл на портале %1'"), "https://" + ПараметрыОтправки.АдресСервера), ПараметрыСоединения.СообщенияПользователю);
			
		Иначе
			// в ответе сервера отсутствует описание ошибки и установлен признак повтора соединения
			СообщитьПользователю(НСтр("ru = 'Зашифрованный пакет не удалось отправить на портал Росприроднадзора.'") + " " + НСтр("ru = 'Портал находится на стадии пилотного проекта.'") + " " + ?(ЭтоРегламентированныйОтчет И НЕ ПараметрыОтправки.ЭтоНеподписываемыйОтчет,
				НСтр("ru = 'Для отправки отчета выгрузите его в файл, используя меню ""Выгрузка"" - ""Выгрузить для портала Росприроднадзора"".'"), НСтр("ru = 'Для отправки отчета выгрузите его в файл, используя меню ""Еще"" - ""Выгрузить"".'"))
				+ " " + ПодставитьПараметрыВСтроку(НСтр("ru = 'Далее отправьте данный файл на портале %1'"), "https://" + ПараметрыОтправки.АдресСервера), ПараметрыСоединения.СообщенияПользователю);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция ОтправитьВРПНССервера(ЭтоЭлектроннаяПодписьВМоделиСервиса, Знач СтрокаBase64ФайлаОтправки, Знач СтрокаBase64ФайлаПакета, Знач КороткоеИмяФайлаПакета, Знач ОтчетСсылка, Знач ПараметрыОтправки, ПараметрыСоединения) Экспорт
	
	// получаем двоичные данные файлов
	Если ЭтоЭлектроннаяПодписьВМоделиСервиса Тогда
		ДвоичныеДанныеФайлаОтправки = ПолучитьИзВременногоХранилища(СтрокаBase64ФайлаОтправки);
		ДвоичныеДанныеФайлаПакета = ПолучитьИзВременногоХранилища(СтрокаBase64ФайлаПакета);
	Иначе
		ДвоичныеДанныеФайлаОтправки = Base64Значение(СтрокаBase64ФайлаОтправки);
		ДвоичныеДанныеФайлаПакета = Base64Значение(СтрокаBase64ФайлаПакета);
	КонецЕсли;
	
	// выгружаем двоичные данные в файл
	ИмяФайлаОтправки = ПолучитьИмяВременногоФайла();
	ДвоичныеДанныеФайлаОтправки.Записать(ИмяФайлаОтправки);
	
	ИмяФайлаПакета = ПолучитьИмяВременногоФайла();
	ДвоичныеДанныеФайлаПакета.Записать(ИмяФайлаПакета);
	
	ФайлыИДанныеОтправки = Новый Структура("КороткоеИмяФайлаПакета, ИмяФайлаОтправки, ИмяФайлаПакета", КороткоеИмяФайлаПакета, ИмяФайлаОтправки, ИмяФайлаПакета);
	
	Результат = ОтправкаНаСерверРПН(ФайлыИДанныеОтправки, ОтчетСсылка, ПараметрыОтправки, ПараметрыСоединения);
	
	ПараметрыСоединения.СоединениеHTTP = Неопределено;
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	
	УдалитьВременныйФайл(ИмяФайлаОтправки);
	УдалитьВременныйФайл(ИмяФайлаПакета);
	
	Возврат Результат;
	
КонецФункции

Функция ГенерироватьHTMLПротоколаОбработкиРПН(ЗаголовокОтчета, СтатусОтчета, ЦветСтатуса, СтатусОтправки, ПараметрыОтправки, ОтчетСсылка)
	
	ТабДок = Новый ТабличныйДокумент;
	
	Шаблон = ПолучитьМакет("РПНШаблонДляHTML");
	
	НаименованиеОрганизации = "";
	ИНН = ИННОрганизации(ПараметрыОтправки.Организация, "", НаименованиеОрганизации);
	СведенияПоОбъекту 	= СведенияПоОтправляемымОбъектам(ОтчетСсылка);
	НаименованиеОргана 	= СведенияПоОбъекту.ПредставлениеКонтролирующегоОргана;
	НаименованиеОтчета 	= СведенияПоОбъекту.Наименование;
	
	СекцияШапкаСЗаголовком = Шаблон.ПолучитьОбласть("ШапкаСЗаголовком");
	Если СтатусОтправки = Перечисления.СтатусыОтправки.Сдан Тогда
		СекцияШапкаСЗаголовком.Параметры.НаименованиеПротокола = НСтр("ru = 'Протокол о сдаче'") + "*";
	ИначеЕсли СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят Тогда
		СекцияШапкаСЗаголовком.Параметры.НаименованиеПротокола = НСтр("ru = 'Протокол ошибок'") + "*";
	Иначе
		СекцияШапкаСЗаголовком.Параметры.НаименованиеПротокола = НСтр("ru = 'Протокол'") + "*";
	КонецЕсли;
	СекцияШапкаСЗаголовком.Параметры.Отправитель = НаименованиеОрганизации;
	СекцияШапкаСЗаголовком.Параметры.ИНН = НСтр("ru = 'ИНН'") + " " + ИНН;
	СекцияШапкаСЗаголовком.Параметры.Получатель = НаименованиеОргана;
	СекцияШапкаСЗаголовком.Параметры.Отчет = НаименованиеОтчета;
	СекцияШапкаСЗаголовком.Параметры.СтатусОтчета = СтатусОтчета;
	СекцияШапкаСЗаголовком.Области.СтатусОтчета.ЦветТекста = ЦветСтатуса;
	ТабДок.Вывести(СекцияШапкаСЗаголовком);
	
	СекцияСтроки = Шаблон.ПолучитьОбласть("Строки");
	СекцияСтроки.Параметры.НомерНаименование = НСтр("ru = 'Входящий номер отчета'") + ?(ПараметрыОтправки.ЭтоНеподписываемыйОтчет, "**", "");
	СекцияСтроки.Параметры.Обновлено = ЗаголовокОтчета.ДатаОбновления;
	СекцияСтроки.Параметры.Номер = ЗаголовокОтчета.ИдентификаторЗаписи;
	СекцияСтроки.Параметры.Подано = ЗаголовокОтчета.ДатаЗагрузки;
	СекцияСтроки.Параметры.Статус = ЗаголовокОтчета.Состояние;
	СекцияСтроки.Параметры.Комментарий = ЗаголовокОтчета.ТекстСостояния;
	ТабДок.Вывести(СекцияСтроки);
	
	СекцияПодвал = Шаблон.ПолучитьОбласть("Подвал");
	ТабДок.Вывести(СекцияПодвал);
	
	СекцияПримечание = Шаблон.ПолучитьОбласть("Примечание");
	СекцияПримечание.Параметры.СсылкаНаПортал = "https://" + ПараметрыОтправки.АдресСервера;
	ТабДок.Вывести(СекцияПримечание);
	
	Если ПараметрыОтправки.ЭтоНеподписываемыйОтчет Тогда
		СекцияПримечаниеНеподписываемые = Шаблон.ПолучитьОбласть("ПримечаниеНеподписываемые");
		ТабДок.Вывести(СекцияПримечаниеНеподписываемые);
	КонецЕсли;
	
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	ТабДок.Записать(ИмяВременногоФайла, ТипФайлаТабличногоДокумента.HTML);
	ТекстHTML = Новый ТекстовыйДокумент;
	ТекстHTML.Прочитать(ИмяВременногоФайла);
	ТекстHTML = ТекстHTML.ПолучитьТекст();
	УдалитьВременныйФайл(ИмяВременногоФайла);
	
	Возврат ТекстHTML;
	
КонецФункции

Функция ПолучитьОсновныеСвойстваПоследнейОтправкиОтчетаВРПН(Знач ОтчетСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ОтправкиРПН.Ссылка,
		|	ОтправкиРПН.ИдентификаторОтправкиНаСервере КАК Идентификатор,
		|	ОтправкиРПН.ИмяФайлаПакета КАК ИмяФайлаПакета,
		|	ОтправкиРПН.СтатусОтправки КАК Статус,
		|	ОтправкиРПН.СтатусПроверкиНаПортале КАК СтатусПроверкиНаПортале
		|ИЗ
		|	Справочник.ОтправкиРПН КАК ОтправкиРПН
		|ГДЕ
		|	ОтправкиРПН.ОтчетСсылка = &ЭтотОтчет
		|	И ОтправкиРПН.ПометкаУдаления = ЛОЖЬ
		|
		|УПОРЯДОЧИТЬ ПО
		|	ОтправкиРПН.ДатаОтправки УБЫВ";
	Запрос.Параметры.Вставить("ЭтотОтчет", ОтчетСсылка);
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьПоследнююОтправкуОтчетаВРПН(ОтчетСсылка) Экспорт
	
	Отправка = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ОтправкиРПН.Ссылка
		|ИЗ
		|	Справочник.ОтправкиРПН КАК ОтправкиРПН
		|ГДЕ
		|	ОтправкиРПН.ОтчетСсылка = &ЭтотОтчет
		|	И ОтправкиРПН.ПометкаУдаления = ЛОЖЬ
		|
		|УПОРЯДОЧИТЬ ПО
		|	ОтправкиРПН.ДатаОтправки УБЫВ";
	Запрос.Параметры.Вставить("ЭтотОтчет", ОтчетСсылка);
	Результат = Запрос.Выполнить();
	
	Если НЕ Результат.Пустой() Тогда
		
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Отправка = Выборка.Ссылка;
		
	КонецЕсли;
	
	Возврат Отправка;
	
КонецФункции

Процедура ОбновитьСтатусОтправкиРПНОтчета(Отчет)
	
	// находим последнюю не помеченную на удаление отправку отчета
	ПоследняяОтправка = ПолучитьПоследнююОтправкуОтчетаВРПН(Отчет);
	
	// вычисляем значение статуса отправки (ПеречислениеСсылка.СтатусыОтправки)
	Если ЗначениеЗаполнено(ПоследняяОтправка) Тогда
		
		СтатусОтправки = ПоследняяОтправка.СтатусОтправки;
		Если СтатусОтправки = Перечисления.СтатусыОтправки.ПринятЕстьОшибки Тогда
			//введено после добавления дополнительного статуса ПринятЕстьОшибки, при котором отчет считается сданным
			СтатусОтправки = Перечисления.СтатусыОтправки.Сдан;
		КонецЕсли;
		
	Иначе
		СтатусОтправки = Неопределено;
	КонецЕсли;
	
	// сохраняем статус в базе
	ЗаписатьСтатусОтправкиРПНОтчета(Отчет, СтатусОтправки, ПоследняяОтправка);
	
КонецПроцедуры

Процедура ЗаписатьСтатусОтправкиРПНОтчета(Отчет, СтатусОтправки, ОснованиеСтатуса)
	
	Если ЗначениеЗаполнено(СтатусОтправки) Тогда
		МенЗап = РегистрыСведений.СтатусыОтправки.СоздатьМенеджерЗаписи();
		МенЗап.Объект = Отчет;
		МенЗап.Статус = СтатусОтправки;
		МенЗап.Основание = ОснованиеСтатуса;
		МенЗап.Записать(Истина);
	Иначе
		МенЗап = РегистрыСведений.СтатусыОтправки.СоздатьМенеджерЗаписи();
		МенЗап.Объект = Отчет;
		МенЗап.Прочитать();
		Если МенЗап.Выбран() Тогда
			МенЗап.Удалить();
		КонецЕсли;
	КонецЕсли;
	
	// вызываем переопределяемую процедуру отработки изменения статуса отправки
	ПриИзмененииСтатусаОтправкиДокумента(Отчет, СтатусОтправки);
	
КонецПроцедуры

Функция ПолучитьПустуюДатуЗавершенияОтправкиРПН() Экспорт
	
	Возврат '39991231235959';
	
КонецФункции

Процедура ПриЗаписиОтправкиРПН(Объект, Отказ) Экспорт
	
	Если Объект.ОтчетСсылка <> Неопределено Тогда
		// отражаем изменения в регистре статусов отправки
		ОбновитьСтатусОтправкиРПНОтчета(Объект.ОтчетСсылка);
		ЭлектронныйДокументооборотСКонтролирующимиОрганами.ЗаписьОбъектовРегламентированнойОтчетности(Объект.ОтчетСсылка, Отказ);
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриЗаписиОписиИсходящихДокументовВНалоговыеОрганы(Объект, Отказ) Экспорт
	
	Если Объект.Ссылка <> Неопределено Тогда
		
		Требование = Объект.Ссылка.Требование;
		
		// Ответы
		Результат 			= ПолучитьКоличествоОтветовНаТребования(Требование);
		КоличествоОтветов 	= Результат.Получить(Требование);
		
		ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ИзменитьЗначениеВРегистреЖурналОтправокВКонтролирующиеОрганы(Требование, "ЕстьОтвет", КоличествоОтветов <> Неопределено И КоличествоОтветов > 0);
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьСтрокуСостоянияОтправкиОтчетаИДополнительныеСвойстваДляРПН(ОтчетСсылка, ОрганизацияСсылка, ЦветТекста, ПоказыватьКнопкуОткрытияПротокола) Экспорт
	
	ПоказыватьКнопкуОткрытияПротокола = Ложь;
	ЦветТекста = Новый Цвет(0, 0, 192);
	
	// определяем последнюю отправку
	ОтправкаСсылка = ПолучитьПоследнююОтправкуОтчетаВРПН(ОтчетСсылка);
	Если НЕ ЗначениеЗаполнено(ОтправкаСсылка) Тогда
		СтрокаСостояния = НСтр("ru = 'Отчет не отправлялся.'");
	Иначе
		СтрокаСостояния = ПодставитьПараметрыВСтроку(НСтр("ru = 'Отчет отправлен %1.'"), Формат(ОтправкаСсылка.ДатаОтправки, "ДЛФ=DDT"));
		
		Если ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят Тогда
			
			Если ОтправкаСсылка.СтатусПроверкиНаПортале = Перечисления.СтатусыОтправки.Сдан Тогда
				СтрокаСостояния = СтрокаСостояния + " " + НСтр("ru = 'Отчет не принят: получен протокол, обнаружены ошибки.'");
			Иначе
				СтрокаСостояния = СтрокаСостояния + " " + НСтр("ru = 'Отчет не принят, получен протокол ошибок.'");
			КонецЕсли;
			ЦветТекста = Новый Цвет(255, 0, 0);
			ПоказыватьКнопкуОткрытияПротокола = Истина;
			
		ИначеЕсли ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.Сдан Тогда
			
			ОтчетСдан = Истина;
			СтрокаСостояния = СтрокаСостояния + " " + НСтр("ru = 'Отчет сдан: получен протокол, ошибок не обнаружено.'");
			ЦветТекста = Новый Цвет(0, 179, 16);
			ПоказыватьКнопкуОткрытияПротокола = Истина;
			
		ИначеЕсли ОтправкаСсылка.СтатусПроверкиНаПортале = Перечисления.СтатусыОтправки.Сдан Тогда
			
			// неполный идентификатор начинается с пяти звездочек
			Если Лев(ОтправкаСсылка.ИдентификаторОтправкиНаСервере, 5) = "*****" Тогда
				СтрокаСостояния = СтрокаСостояния + " " + НСтр("ru = 'Отчет обработан на портале и ждет доставки в управление.'");
			Иначе
				СтрокаСостояния = СтрокаСостояния + " " + НСтр("ru = 'Отчет обработан на портале и находится на проверке в управлении.'");
			КонецЕсли;
			ПоказыватьКнопкуОткрытияПротокола = Истина;
			
		ИначеЕсли ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен Тогда
			
			ПоказыватьКнопкуОткрытияПротокола = ЗначениеЗаполнено(ОтправкаСсылка.Протокол.Получить());
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат СтрокаСостояния;
	
КонецФункции

Функция ПоляНаСервереДляЗаписиОтправкиВРПН(ОбъектСсылка) Экспорт
	
	Возврат Новый Структура("ДатаНачалаПериода, ДатаОкончанияПериода, Версия",
		ОбъектСсылка.ДатаНачала, ОбъектСсылка.ДатаОкончания, ОбъектСсылка.Версия);
	
КонецФункции

Процедура ПередЗаписьюОтправкиРПН(Объект, Отказ)
	
	Если НЕ ЗначениеЗаполнено(Объект.Период) Тогда
		Объект.Период = СокрЛП(Формат(Объект.ДатаОкончанияПериода, "ДФ=yyyyMMdd") + Формат('39991231' - Объект.ДатаНачалаПериода, "ДФ=yyyyMMdd"));
	КонецЕсли;
	
	Если Объект.СтатусОтправки = Перечисления.СтатусыОтправки.Отправлен Тогда
		
		Если НЕ ЗначениеЗаполнено(Объект.ДатаЗакрытия) Тогда
			Объект.ДатаЗакрытия = ПолучитьПустуюДатуЗавершенияОтправкиРПН();
		КонецЕсли;
		
	Иначе
		Объект.ДатаЗакрытия = Объект.ДатаПолученияРезультата;
	КонецЕсли;
	
КонецПроцедуры

Функция СписокДопустимыхОрганизацийВОбъектахОбменаРПН() Экспорт
	
	Запрос = Новый Запрос;
	ТекстЗапроса = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	НастройкиОбменаРПН.Организация КАК Организация
	|ИЗ
	|	РегистрСведений.НастройкиОбменаРПН КАК НастройкиОбменаРПН
	|ГДЕ
	|	НастройкиОбменаРПН.ИспользоватьОбмен = ИСТИНА";
	
	Запрос.Текст = ТекстЗапроса;
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Организация");
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Обмен сервером

Функция ОтправитьЗашифрованныйПакетНаСерверРПН(ФайлыИДанныеОтправки, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ИдентификаторОтправкиНаСервере = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	ЗагрузкаПроизведена = Ложь;
	АдресСервера = ПараметрыОтправки.АдресСервера;
	
	АвторизацияПроизведена = (ПараметрыСоединения.СоединениеHTTP <> Неопределено);
	
	Если НЕ АвторизацияПроизведена Тогда
		
		// очистить пароль, если в диалоге сохранения пароля не установлена галочка сохранения
		Если НЕ ПараметрыСоединения.СохранитьПароль И ЗначениеЗаполнено(ПараметрыСоединения.СохраненныйПароль) Тогда
			ЗаписатьEMailИПарольПорталаРПН(ПараметрыОтправки.Организация, , "");
			ПараметрыСоединения.СохраненныйПароль = "";
		КонецЕсли;
		
		// инициализируем настройки прокси, если они определены
		НастройкаПроксиСервера = НастройкиПроксиНаСервере();
		
		Если НастройкаПроксиСервера <> Неопределено Тогда
			Прокси = СформироватьПрокси(НастройкаПроксиСервера, "HTTPS");
		Иначе
			Прокси = Новый ИнтернетПрокси;
		КонецЕсли;
		
		// устанавливаем соединение с сервером
		СоединениеSSL = Неопределено;
		
		Попытка
			Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
		Исключение
			
			СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
		Попытка
			Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(АдресСервера, , , , Прокси, , СоединениеSSL)");
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
		ПараметрыСоединения.ЗначениеCookie = "";
		АвторизацияПроизведена = АвторизоватьсяНаПорталеРПН(ПараметрыОтправки, ПараметрыСоединения);
		
	КонецЕсли;
	
	Если АвторизацияПроизведена Тогда
		
		ЗагрузкаПроизведена = ЗагрузитьОтчетНаПорталРПН(ФайлыИДанныеОтправки.ИмяФайлаОтправки, ПараметрыСоединения);
		
	Иначе
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
	КонецЕсли;
	
	Возврат ЗагрузкаПроизведена;
	
КонецФункции

Функция АвторизоватьсяНаПорталеРПН(ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "application/x-www-form-urlencoded");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаЗапроса = ПолучитьИмяВременногоФайла();
	ЗаписываемыйФайл = Новый ЗаписьТекста(ИмяФайлаЗапроса, КодировкаТекста.ANSI);
	ЗаписываемыйФайл.Записать("UserName=" + ПараметрыСоединения.EMail + "&Password=" + ПараметрыСоединения.Пароль + "&RememberMe=false");
	ЗаписываемыйФайл.Закрыть();
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаЗапроса, "/Account/Account/LogOn", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаЗапроса);
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Ложь;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаЗапроса);
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиПорталаРПН(ТекстОтвета);
	
	ПараметрыСоединения.ПовторятьЗапросПароля = ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером);
	
	// сохранить пароль при успешной авторизации
	
	Если НЕ ПараметрыСоединения.ПовторятьЗапросПароля И (ПараметрыСоединения.EMail <> ПараметрыСоединения.СохраненныйEMail ИЛИ (ПараметрыСоединения.СохранитьПароль И ПараметрыСоединения.Пароль <> ПараметрыСоединения.СохраненныйПароль)) Тогда
		ПарольДляСохранения = ?(ПараметрыСоединения.СохранитьПароль, ПараметрыСоединения.Пароль, "");
		ЗаписатьEMailИПарольПорталаРПН(ПараметрыОтправки.Организация, ПараметрыСоединения.EMail, ПарольДляСохранения);
		ПараметрыСоединения.СохраненныйEMail = ПараметрыСоединения.EMail;
		ПараметрыСоединения.СохраненныйПароль = ПарольДляСохранения;
	КонецЕсли;
	
	Возврат (НЕ ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером));
	
КонецФункции

Функция ЗагрузитьОтчетНаПорталРПН(ИмяФайлаОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Content-Type", "multipart/form-data; boundary=My1cV8bNdr");
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	// посылаем запрос
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.ОтправитьДляОбработки(ИмяФайлаОтправки, "/Index/Upload", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		Возврат Ложь;
		
	КонецПопытки;
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, КодировкаТекста.ANSI);
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиПорталаРПН(ТекстОтвета);
	
	ТекстСодержимогоОтвета = ТекстПослеПрефикса(ТекстОтвета, "<div align=""left"" class=""MasterContent"">");
	ПараметрыСоединения.ИдентификаторОтправкиНаСервере = ТекстПослеПрефикса(ТекстСодержимогоОтвета, "<h1 style=""color: #f60; border-bottom: 1px dashed #f60; display: inline-block;"">", "<");
	Если НЕ ЗначениеЗаполнено(ПараметрыСоединения.ИдентификаторОтправкиНаСервере) Тогда
		ПараметрыСоединения.ОписаниеОшибкиСервером = "Ошибочный ответ сервера";
	КонецЕсли;
	
	Возврат НЕ ЗначениеЗаполнено(ПараметрыСоединения.ОписаниеОшибкиСервером);
	
КонецФункции

Функция ТекстОшибкиПорталаРПН(ТекстОтвета)
	
	ТекстОшибкиВHTML = ТекстПослеПрефикса(ТекстОтвета, "<div class=""validation-summary-errors""><span>", "<");
	Если ЗначениеЗаполнено(ТекстОшибкиВHTML) Тогда
		ТекстОшибкиВHTML = ТекстПослеПрефикса(ТекстОтвета, "<div class=""validation-summary-errors""><span>", "</ul>");
		ТекстОшибкиВHTML = СтрЗаменить(ТекстОшибкиВHTML, "</span>", "");
		ТекстОшибкиВHTML = СтрЗаменить(ТекстОшибкиВHTML, "<ul>", "");
		ТекстОшибкиВHTML = СтрЗаменить(ТекстОшибкиВHTML, "<li>", " ");
		ТекстОшибкиВHTML = СтрЗаменить(ТекстОшибкиВHTML, "<li style=""display:none"">", " ");
		ТекстОшибкиВHTML = СтрЗаменить(ТекстОшибкиВHTML, "</li>", "");
		ТекстОшибкиВHTML = СтрЗаменить(ТекстОшибкиВHTML, Символы.ВК + Символы.ПС, "");
		ТекстОшибкиВHTML = СтрЗаменить(ТекстОшибкиВHTML, Символы.ПС, "");
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(ТекстОшибкиВHTML) Тогда
		ТекстОшибкиВHTML = ТекстПослеПрефикса(ТекстОтвета, "<p class='error alert alert-danger' id=""errorText"">", "<")
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ТекстОшибкиВHTML) Тогда
		Возврат "";
	КонецЕсли;
	
	ТекстОшибки = ТекстИзHTML(ТекстОшибкиВHTML);
	ТекстОшибки = ТекстИзUTF8(ТекстОшибки);
	ВнутренняяОшибка = "An error occurred while updating the entries. See the inner exception for details.";
	Если Лев(ТекстОшибки, СтрДлина(ВнутренняяОшибка)) = ВнутренняяОшибка Тогда
		ТекстОшибки = "Произошла ошибка. Возможно, неверный формат отчета или слишком частые попытки отправки отчета.";
	КонецЕсли;
	
	Возврат СокрЛП(ТекстОшибки);
	
КонецФункции

Функция ТекстПослеПрефикса(ПолныйТекст, Префикс, Постфикс = "", ПозицияПослеПостфикса = Неопределено, НомерВхожденияПрефикса = 1)
	
	НачалоПрефикса = НайтиНомерВхождения(ПолныйТекст, Префикс, НомерВхожденияПрефикса);
	Если НачалоПрефикса = 0 Тогда
		ПозицияПослеПостфикса = СтрДлина(ПолныйТекст) + 1;
		Возврат Неопределено;
	КонецЕсли;
	
	ДлинаПрефикса = СтрДлина(Префикс);
	Результат = Сред(ПолныйТекст, НачалоПрефикса + ДлинаПрефикса);
	ПозицияПослеПостфикса = НачалоПрефикса + ДлинаПрефикса;
	
	Если ЗначениеЗаполнено(Постфикс) Тогда
		КонецПрефикса = Найти(Результат, Постфикс);
		
		Если КонецПрефикса > 0 Тогда
			Результат = Лев(Результат, КонецПрефикса - 1);
			ПозицияПослеПостфикса = НачалоПрефикса + ДлинаПрефикса + КонецПрефикса - 1 + СтрДлина(Постфикс);
		Иначе
			ПозицияПослеПостфикса = СтрДлина(ПолныйТекст) + 1;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// отрицательный НомерВхождения - отсчитать с конца, вернется номер вхождения сначала
Функция НайтиНомерВхождения(Строка, ПодстрокаПоиска, НомерВхождения)
	
	СтрокаВыполненияПоиска = Строка;
	МассивПозиций = Новый Массив;
	ПозицияПодстрокиВИсходнойСтроке = 0;
	НомерНайденнойПодстроки = 0;
	
	Пока СтрокаВыполненияПоиска <> "" Цикл
		ПозицияПодстроки = Найти(СтрокаВыполненияПоиска, ПодстрокаПоиска);
		Если ПозицияПодстроки = 0 Тогда
			Прервать;
		КонецЕсли;
		ПозицияПодстрокиВИсходнойСтроке = ПозицияПодстрокиВИсходнойСтроке + ПозицияПодстроки;
		НомерНайденнойПодстроки = НомерНайденнойПодстроки + 1;
		
		Если НомерВхождения >= 0 Тогда
			Если НомерНайденнойПодстроки >= НомерВхождения Тогда
				Возврат ПозицияПодстрокиВИсходнойСтроке;
			КонецЕсли;
			
		Иначе
			МассивПозиций.Добавить(ПозицияПодстрокиВИсходнойСтроке);
		КонецЕсли;
		
		СтрокаВыполненияПоиска = Сред(СтрокаВыполненияПоиска, ПозицияПодстроки + 1);
	КонецЦикла;
	
	Если НомерВхождения < 0 И МассивПозиций.Количество() >= - НомерВхождения Тогда
		НомерВхождения = МассивПозиций.Количество() + НомерВхождения + 1;
		Возврат МассивПозиций[НомерВхождения - 1];
	КонецЕсли;
		
	Возврат 0;
	
КонецФункции

Функция ПолучитьИнформациюОбОтчетеНаПорталеРПН(ИмяФайлаВыгрузки, ПараметрыОтправки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	АдресСервера = ПараметрыОтправки.АдресСервера;
	
	АвторизацияПроизведена = (ПараметрыСоединения.СоединениеHTTP <> Неопределено);
	
	Если НЕ АвторизацияПроизведена Тогда
		
		// очистить пароль, если в диалоге сохранения пароля не установлена галочка сохранения
		Если НЕ ПараметрыСоединения.СохранитьПароль И ЗначениеЗаполнено(ПараметрыСоединения.СохраненныйПароль) Тогда
			ЗаписатьEMailИПарольПорталаРПН(ПараметрыОтправки.Организация, , "");
			ПараметрыСоединения.СохраненныйПароль = "";
		КонецЕсли;
		
		// инициализируем настройки прокси, если они определены
		НастройкаПроксиСервера = НастройкиПроксиНаСервере();
		
		Если НастройкаПроксиСервера <> Неопределено Тогда
			Прокси = СформироватьПрокси(НастройкаПроксиСервера, "HTTPS");
		Иначе
			Прокси = Новый ИнтернетПрокси;
		КонецЕсли;
		
		// устанавливаем соединение с сервером
		СоединениеSSL = Неопределено;
		
		Попытка
			Выполнить("СоединениеSSL = Новый ЗащищенноеСоединениеOpenSSL");
		Исключение
			
			СообщитьПользователю(НСтр("ru = 'Для выполнения обмена необходима версия платформы не ниже 8.2.18'"), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
		Попытка
			Выполнить("ПараметрыСоединения.СоединениеHTTP = Новый HTTPСоединение(АдресСервера, , , , Прокси, , СоединениеSSL)");
		Исключение
			
			ПараметрыСоединения.ПовторятьСоединение = Истина;
			СообщитьПользователю(ПодставитьПараметрыВСтроку(НСтр("ru = 'Не удалось установить соединение с сервером онлайн-проверки: %1'"), Символы.ПС + ИнформацияОбОшибке().Описание), ПараметрыСоединения.СообщенияПользователю);
			Возврат Неопределено;
			
		КонецПопытки;
		
		ПараметрыСоединения.ЗначениеCookie = "";
		АвторизацияПроизведена = АвторизоватьсяНаПорталеРПН(ПараметрыОтправки, ПараметрыСоединения);
		
	КонецЕсли;
	
	Если АвторизацияПроизведена Тогда
		
		ЗаголовокОтчета = НайтиЗаголовокОтчетаНаПорталеРПН(ИмяФайлаВыгрузки, ПараметрыСоединения);
		
		Если ЗаголовокОтчета <> Неопределено Тогда
			
			ПараметрыСоединения.ОписаниеОшибкиСервером = "";
			ПараметрыСоединения.ПовторятьСоединение = Ложь;
			
			Возврат ЗаголовокОтчета;
			
		КонецЕсли;
		
	Иначе
		ПараметрыСоединения.СоединениеHTTP = Неопределено;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

Функция НайтиЗаголовокОтчетаНаПорталеРПН(ИмяФайлаВыгрузки, ПараметрыСоединения)
	
	ПараметрыСоединения.ОписаниеОшибкиСервером = "";
	ПараметрыСоединения.ПовторятьСоединение = Ложь;
	
	ЗаголовкиHTTP = Новый Соответствие();
	ЗаголовкиHTTP.Вставить("Proxy-Connection", "Keep-Alive");
	ЗаголовкиHTTP.Вставить("Pragma", "no-cache");
	Если ЗначениеЗаполнено(ПараметрыСоединения.ЗначениеCookie) Тогда
		ЗаголовкиHTTP.Вставить("Cookie", ПараметрыСоединения.ЗначениеCookie);
	КонецЕсли;
	
	ИмяФайлаОтвета = ПолучитьИмяВременногоФайла();
	
	Попытка
		ОтветHTTP = ПараметрыСоединения.СоединениеHTTP.Получить("/Index/StatusGrid", ИмяФайлаОтвета, ЗаголовкиHTTP);
	Исключение
		
		ПараметрыСоединения.ПовторятьСоединение = Истина;
		УдалитьВременныйФайл(ИмяФайлаОтвета);
		Возврат Неопределено;
		
	КонецПопытки;
	
	ФайлОтвета = Новый ЧтениеТекста(ИмяФайлаОтвета, "windows-1251");
	ТекстОтвета = ФайлОтвета.Прочитать();
	ФайлОтвета.Закрыть();
	
	ЗначениеSetCookie = ОтветHTTP.Заголовки.Получить("Set-Cookie");
	ПараметрыСоединения.ЗначениеCookie = ОбновленноеЗначениеCookie(ПараметрыСоединения.ЗначениеCookie, ЗначениеSetCookie);
	
	УдалитьВременныйФайл(ИмяФайлаОтвета);
	
	ПозицияИдентификатора = Найти(ТекстОтвета, """ticket"":""" + ПараметрыСоединения.ИдентификаторОтправкиНаСервере + """");
	Если ПозицияИдентификатора = 0 И Лев(ПараметрыСоединения.ИдентификаторОтправкиНаСервере, 5) = "*****" Тогда
		ПозицияИдентификатора = Найти(ТекстОтвета, Сред(ПараметрыСоединения.ИдентификаторОтправкиНаСервере, 6) + """,""") - 15;
		Если ПозицияИдентификатора <= 0 Тогда
			ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиПорталаРПН(ТекстОтвета);
			Возврат Неопределено;
		КонецЕсли;
	КонецЕсли;
	
	ЗаголовокОтчета = Новый Структура("ИдентификаторЗаписи, ИмяФайла, Состояние, ДатаЗагрузки, ДатаОбновления, ТекстСостояния",
		ПараметрыСоединения.ИдентификаторОтправкиНаСервере, ИмяФайлаВыгрузки, "", Неопределено, Неопределено, "");
	
	ПозицияНачала = 1;
	ПозицияВТексте = ПозицияИдентификатора;
	Пока ПозицияВТексте > 0 Цикл
		Если Сред(ТекстОтвета, ПозицияВТексте, 1) = "{" Тогда
			ПозицияНачала = ПозицияВТексте;
			Прервать;
		КонецЕсли;
		ПозицияВТексте = ПозицияВТексте - 1;
	КонецЦикла;
	
	ОжидаемыйСимволРазделителя = "{";
	СимволРазделителя = "";
	ЧасовойПоясСеанса = ЧасовойПоясСеанса();
	Пока Истина Цикл
		ИмяПараметра = СледующееЗначениеJSON(ТекстОтвета, ПозицияНачала, СимволРазделителя);
		Если СимволРазделителя <> ОжидаемыйСимволРазделителя Тогда
			Прервать;
		КонецЕсли;
		
		ЗначениеПараметра = СледующееЗначениеJSON(ТекстОтвета, ПозицияНачала, СимволРазделителя);
		Если СимволРазделителя <> ":" Тогда
			Прервать;
		КонецЕсли;
		ОжидаемыйСимволРазделителя = ",";
		
		Если ИмяПараметра = "ticket" Тогда
			ЗаголовокОтчета.ИдентификаторЗаписи = ЗначениеПараметра;
		ИначеЕсли ИмяПараметра = "status" Тогда
			ЗаголовокОтчета.Состояние = ТекстИзUTF8(ЗначениеПараметра);
			ЗаголовокОтчета.Состояние = ТекстИзСтрокиJSON(ЗаголовокОтчета.Состояние, " ");
		ИначеЕсли ИмяПараметра = "uploadDate" Тогда
			ЗаголовокОтчета.ДатаЗагрузки = ДатаИзСтрокиРазныхФорматов(ЗначениеПараметра);
			Если ТипЗнч(ЗаголовокОтчета.ДатаЗагрузки) = Тип("Дата") Тогда
				ЗаголовокОтчета.ДатаЗагрузки = МестноеВремя(ЗаголовокОтчета.ДатаЗагрузки, ЧасовойПоясСеанса);
				ЗаголовокОтчета.ДатаЗагрузки = МестноеВремя(ЗаголовокОтчета.ДатаЗагрузки, ЧасовойПоясСеанса); // коррекция ошибки на портале
			КонецЕсли;
		ИначеЕсли ИмяПараметра = "changeDate" Тогда
			ЗаголовокОтчета.ДатаОбновления = ДатаИзСтрокиРазныхФорматов(ЗначениеПараметра);
			Если ТипЗнч(ЗаголовокОтчета.ДатаОбновления) = Тип("Дата") Тогда
				ЗаголовокОтчета.ДатаОбновления = МестноеВремя(ЗаголовокОтчета.ДатаОбновления, ЧасовойПоясСеанса);
				ЗаголовокОтчета.ДатаОбновления = МестноеВремя(ЗаголовокОтчета.ДатаОбновления, ЧасовойПоясСеанса); // коррекция ошибки на портале
			КонецЕсли;
		ИначеЕсли ИмяПараметра = "comment" Тогда
			ЗаголовокОтчета.ТекстСостояния = ТекстИзUTF8(ЗначениеПараметра);
			ЗаголовокОтчета.ТекстСостояния = ТекстИзСтрокиJSON(ЗаголовокОтчета.ТекстСостояния, " ");
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ ЗначениеЗаполнено(ЗаголовокОтчета.Состояние) Тогда
		ПараметрыСоединения.ОписаниеОшибкиСервером = ТекстОшибкиПорталаРПН(ТекстОтвета);
		Возврат Неопределено;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ЗаголовокОтчета.ДатаОбновления) Тогда
		ЗаголовокОтчета.ДатаОбновления = ЗаголовокОтчета.ДатаЗагрузки;
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(ЗаголовокОтчета.ТекстСостояния) Тогда
		ЗаголовокОтчета.ТекстСостояния = ЗаголовокОтчета.Состояние;
	КонецЕсли;
	
	Возврат ЗаголовокОтчета;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Служебные функции РПН

Функция ИспользуетсяТестовыйСерверРПН() Экспорт
	
	Возврат ИспользуетсяРежимТестирования();
	
КонецФункции

Функция СерверПриемаОтчетностиРПН() Экспорт
	
	Если ИспользуетсяТестовыйСерверРПН() Тогда
		// Возвращаем адрес тестового сервера
		Возврат "rpn.gov.ru:8090";
		
	Иначе
		// Возвращаем адрес реального сервера
		Возврат "pnv-rpn.ru";
		
	КонецЕсли;
	
КонецФункции

Функция НастройкиРПН(Знач ОрганизацияСсылка, Знач ПолучитьПараметрыОнлайнПроверки = Ложь) Экспорт
	
	Результат = Новый Структура("ИспользоватьОбмен, СертификатАбонентаОтпечаток, СертификатРПНОтпечаток, EMail, Пароль, ИспользоватьАвтонастройку, СертификатУЦОтпечаток, СертификатУЦДанные64, СертификатРПНДанные64", Ложь, "", "", "", "", Ложь, "", "", "");
	
	СвойстваОрганизации = Неопределено;
	Если ПолучитьПараметрыОнлайнПроверки Тогда
		СвойстваОрганизации = ЗначенияРеквизитовОбъекта(ОрганизацияСсылка, "ВидОбменаСКонтролирующимиОрганами, УчетнаяЗаписьОбмена");
	КонецЕсли;
		
	Если ПолучитьПараметрыОнлайнПроверки Тогда
		Результат.Вставить("УчетнаяЗаписьОбмена", СвойстваОрганизации.УчетнаяЗаписьОбмена);
		Результат.Вставить("НастроенОбменВУниверсальномФормате", СвойстваОрганизации.ВидОбменаСКонтролирующимиОрганами = Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате
			И ЗначениеЗаполнено(СвойстваОрганизации.УчетнаяЗаписьОбмена));
		
		Попытка
			ОбменИОнлайнПроверкаВключены = Результат.НастроенОбменВУниверсальномФормате И НЕ СвойстваОрганизации.УчетнаяЗаписьОбмена.ОбменНапрямую И СвойстваОрганизации.УчетнаяЗаписьОбмена.ИспользоватьСервисОнлайнПроверкиОтчетов;
		Исключение
			ОбменИОнлайнПроверкаВключены = Ложь;
		КонецПопытки;
		
		Результат.Вставить("ОнлайнПроверкаДоступна", ОбменИОнлайнПроверкаВключены И СвойстваОрганизации.УчетнаяЗаписьОбмена.СпецоператорСвязи <> Перечисления.СпецоператорыСвязи.Такском И Найти(";" + ВРег(СокрЛП(ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПолучитьПараметрСпецоператора(СвойстваОрганизации.УчетнаяЗаписьОбмена.СпецоператорСвязи, "ОнлайнПроверкаКонтролирующиеОрганы"))) + ";", ";РПН;") > 0);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
				   |	НастройкиОбменаРПН.ИспользоватьОбмен КАК ИспользоватьОбмен,
				   |	НастройкиОбменаРПН.СертификатАбонентаОтпечаток КАК СертификатАбонентаОтпечаток,
				   |	НастройкиОбменаРПН.СертификатРПНОтпечаток КАК СертификатРПНОтпечаток,
				   |	НастройкиОбменаРПН.EMail КАК EMail,
				   |	НастройкиОбменаРПН.Пароль КАК Пароль,
				   |	НастройкиОбменаРПН.ИспользоватьАвтонастройку КАК ИспользоватьАвтонастройку
				   |ИЗ
				   |	РегистрСведений.НастройкиОбменаРПН КАК НастройкиОбменаРПН
				   |ГДЕ
				   |	НастройкиОбменаРПН.Организация = &ОрганизацияСсылка";
	Запрос.УстановитьПараметр("ОрганизацияСсылка", ОрганизацияСсылка);
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		ЗаписьЗапроса = РезультатЗапроса.Выгрузить()[0];
		Если ЗаписьЗапроса.ИспользоватьОбмен Тогда
			
			Результат.ИспользоватьОбмен = ЗаписьЗапроса.ИспользоватьОбмен;
			Результат.СертификатАбонентаОтпечаток = СокрЛП(ЗаписьЗапроса.СертификатАбонентаОтпечаток);
			Результат.СертификатРПНОтпечаток = СокрЛП(ЗаписьЗапроса.СертификатРПНОтпечаток);
			Результат.EMail = СокрЛП(ЗаписьЗапроса.EMail);
			Результат.Пароль = СокрЛП(ЗаписьЗапроса.Пароль);
			Результат.ИспользоватьАвтонастройку = ЗаписьЗапроса.ИспользоватьАвтонастройку;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция СвойстваОбменаОрганизацииДляРПН(Знач ОрганизацияСсылка, Знач ОпределитьНастроенностьОбменаВУниверсальномФормате, Знач ПолучитьОсновныеСвойстваПоследнейОтправки, Знач ОтправкаСсылка = Неопределено, ОтчетСсылка = Неопределено, ПараметрыПолученияИнформацииОбОтчете = Неопределено) Экспорт
	
	Результат = Новый Структура("НастроенОбменВУниверсальномФормате, СвойстваОтправки, НастройкиОбмена, ОрганизацияИзОтправки, ПравоИзмененияУчетнойЗаписи, ЭтоРегламентированныйОтчет, ЭтоЭлектроннаяПодписьВМоделиСервиса, ЭтоНеподписываемыйОтчет", Неопределено, Неопределено, Неопределено, Неопределено, Неопределено, Неопределено, ЭлектроннаяПодписьВМоделиСервисаВызовСервера.ЭтоЭлектроннаяПодписьВМоделиСервиса(ОрганизацияСсылка), Неопределено);
	
	Если ОрганизацияСсылка = Неопределено Тогда
		
		ОрганизацияСсылка = ОтправкаСсылка.Организация;
		Результат.ОрганизацияИзОтправки = ОрганизацияСсылка;
		
	КонецЕсли;
	
	Если ОпределитьНастроенностьОбменаВУниверсальномФормате Тогда
		
		СвойстваОрганизации = ЗначенияРеквизитовОбъекта(ОрганизацияСсылка, "ВидОбменаСКонтролирующимиОрганами, УчетнаяЗаписьОбмена");
		
		Результат.НастроенОбменВУниверсальномФормате = (СвойстваОрганизации.ВидОбменаСКонтролирующимиОрганами = Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате
			И ЗначениеЗаполнено(СвойстваОрганизации.УчетнаяЗаписьОбмена));
		
	КонецЕсли;
	
	Если ПолучитьОсновныеСвойстваПоследнейОтправки Тогда
		
		СвойстваОтправки = ПолучитьОсновныеСвойстваПоследнейОтправкиОтчетаВРПН(ОтчетСсылка);
		Если СвойстваОтправки <> Неопределено Тогда
			Результат.СвойстваОтправки = Новый Структура("Ссылка, Идентификатор, ИмяФайлаПакета, Статус, СтатусПроверкиНаПортале",
				СвойстваОтправки.Ссылка, СвойстваОтправки.Идентификатор, СвойстваОтправки.ИмяФайлаПакета, СвойстваОтправки.Статус, СвойстваОтправки.СтатусПроверкиНаПортале);
		КонецЕсли;
		
	КонецЕсли;
	
	Результат.НастройкиОбмена = НастройкиРПН(ОрганизацияСсылка);
	
	Результат.ПравоИзмененияУчетнойЗаписи = ПравоДоступа("Изменение", Метаданные.Справочники.УчетныеЗаписиДокументооборота);
	
	Если ОтчетСсылка <> Неопределено ИЛИ ОтправкаСсылка <> Неопределено Тогда
		
		СсылкаНаОтчет = ?(ОтчетСсылка <> Неопределено, ОтчетСсылка, ОтправкаСсылка.ОтчетСсылка);
		ТипЗнчСсылкаНаОтчет = ТипЗнч(СсылкаНаОтчет);
		Результат.ЭтоРегламентированныйОтчет = (ТипЗнчСсылкаНаОтчет = Тип("ДокументСсылка.РегламентированныйОтчет") ИЛИ ТипЗнчСсылкаНаОтчет = Тип("Неопределено"));
		
		Если ПараметрыПолученияИнформацииОбОтчете = Неопределено ИЛИ НЕ ПараметрыПолученияИнформацииОбОтчете.ОтключитьОпределениеНеподписываемыхОтчетов Тогда
			Если Результат.ЭтоРегламентированныйОтчет Тогда
				ВидОтчета = Справочники.ВидыОтправляемыхДокументов.НайтиПоРеквизиту("Источник", СсылкаНаОтчет.ИсточникОтчета);
				
			Иначе // электронные представления
				ВидОтчета = СсылкаНаОтчет.ВидОтчета;
			КонецЕсли;
			
			Результат.ЭтоНеподписываемыйОтчет = (ВидОтчета <> Справочники.ВидыОтправляемыхДокументов.РасчетПлатыОкрСреда) И (ВидОтчета <> Справочники.ВидыОтправляемыхДокументов.Форма2ТПОтходы);
		КонецЕсли;
		
	ИначеЕсли ПараметрыПолученияИнформацииОбОтчете <> Неопределено И НЕ ПараметрыПолученияИнформацииОбОтчете.ОтключитьОпределениеНеподписываемыхОтчетов Тогда
		
		Если НЕ ЗначениеЗаполнено(ПараметрыПолученияИнформацииОбОтчете.ВидОтчетаФормыЭлектронногоПредставления) Тогда
			Результат.ЭтоНеподписываемыйОтчет = (Найти(ПараметрыПолученияИнформацииОбОтчете.ИмяФормы, "РасчетПлатыОкрСреда") = 0) И (Найти(ПараметрыПолученияИнформацииОбОтчете.ИмяФормы, "Форма2ТПОтходы") = 0);
			
		Иначе // электронные представления
			Результат.ЭтоНеподписываемыйОтчет = (ПараметрыПолученияИнформацииОбОтчете.ВидОтчетаФормыЭлектронногоПредставления <> Справочники.ВидыОтправляемыхДокументов.РасчетПлатыОкрСреда) И (ПараметрыПолученияИнформацииОбОтчете.ВидОтчетаФормыЭлектронногоПредставления <> Справочники.ВидыОтправляемыхДокументов.Форма2ТПОтходы);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаписатьEMailИПарольПорталаРПН(Организация, EMail = Неопределено, Пароль = "")
	
	Попытка
		
		МенеджерЗаписи = РегистрыСведений.НастройкиОбменаРПН.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Организация = Организация;
		МенеджерЗаписи.Прочитать();
		
		Если МенеджерЗаписи.Выбран() Тогда
			Если МенеджерЗаписи.ИспользоватьОбмен <> Истина Тогда
				МенеджерЗаписи.ИспользоватьОбмен = Истина;
				МенеджерЗаписи.ИспользоватьАвтонастройку = Ложь;
			КонецЕсли;
			Если EMail <> Неопределено Тогда
				МенеджерЗаписи.EMail = EMail;
			КонецЕсли;
			МенеджерЗаписи.Пароль = Пароль;
			МенеджерЗаписи.Записать();
			
		ИначеЕсли ЗначениеЗаполнено(EMail) ИЛИ ЗначениеЗаполнено(Пароль) Тогда
			МенеджерЗаписи.Организация = Организация;
			МенеджерЗаписи.ИспользоватьОбмен = Истина;
			МенеджерЗаписи.СертификатАбонентаОтпечаток = "";
			МенеджерЗаписи.СертификатРПНОтпечаток = "";
			МенеджерЗаписи.ИспользоватьАвтонастройку = Ложь;
			МенеджерЗаписи.EMail = Строка(EMail);
			МенеджерЗаписи.Пароль = Пароль;
			МенеджерЗаписи.Записать();
		КонецЕсли;
		
	Исключение
	КонецПопытки;
	
КонецПроцедуры

Функция УспешноОбработанОтчетРПН(ИдентификаторЗаписи, СтрокаСостояния, ПройденаПроверкаНаПортале = Неопределено)
	
	Если СтрокаСостояния = "Обработан" ИЛИ Лев(ИдентификаторЗаписи, 5) <> "*****" Тогда
		ПройденаПроверкаНаПортале = Истина;
	Иначе
		ПройденаПроверкаНаПортале = Неопределено;
	КонецЕсли;
	
	ПрефиксОшибка = "Ошибка";
	ДлинаПрефиксаОшибка = СтрДлина(ПрефиксОшибка);
	ПрефиксОтклонен = "Отклон";
	ДлинаПрефиксаОтклонен = СтрДлина(ПрефиксОтклонен);
	ПрефиксНеПринят = "Не принят";
	ДлинаПрефиксаНеПринят = СтрДлина(ПрефиксНеПринят);
	ПрефиксНеУтвержден = "Не утвержд";
	ДлинаПрефиксаНеУтвержден = СтрДлина(ПрефиксНеУтвержден);
	ПрефиксНекорректный = "Некорректн";
	ДлинаПрефиксаНекорректный = СтрДлина(ПрефиксНекорректный);
	ПрефиксОтчетОтклонен = "Отчет отклон";
	ДлинаПрефиксаОтчетОтклонен = СтрДлина(ПрефиксОтчетОтклонен);
	ПрефиксОтчетНеПринят = "Отчет не принят";
	ДлинаПрефиксаОтчетНеПринят = СтрДлина(ПрефиксОтчетНеПринят);
	ПрефиксОтчетНеУтвержден = "Отчет не утвержд";
	ДлинаПрефиксаОтчетНеУтвержден = СтрДлина(ПрефиксОтчетНеУтвержден);
	ПрефиксУтвержден = "Утвержд";
	ДлинаПрефиксаУтвержден = СтрДлина(ПрефиксУтвержден);
	ПрефиксПринят = "Принят";
	ДлинаПрефиксаПринят = СтрДлина(ПрефиксПринят);
	ПрефиксСдан = "Сдан";
	ДлинаПрефиксаСдан = СтрДлина(ПрефиксСдан);
	ПрефиксОтчетУтвержден = "Отчет утвержд";
	ДлинаПрефиксаОтчетУтвержден = СтрДлина(ПрефиксОтчетУтвержден);
	ПрефиксОтчетПринят = "Отчет принят";
	ДлинаПрефиксаОтчетПринят = СтрДлина(ПрефиксОтчетПринят);
	ПрефиксОтчетСдан = "Отчет сдан";
	ДлинаПрефиксаОтчетСдан = СтрДлина(ПрефиксОтчетСдан);
	ПрефиксОтчетЗагруженВоФГИС = "Отчет загружен во ФГИС";
	ДлинаПрефиксаОтчетЗагруженВоФГИС = СтрДлина(ПрефиксОтчетЗагруженВоФГИС);
	ПрефиксОтчетСЭПЗагруженВоФГИС = "Отчет с ЭП принят и загружен во ФГИС";
	ДлинаПрефиксаОтчетСЭПЗагруженВоФГИС = СтрДлина(ПрефиксОтчетСЭПЗагруженВоФГИС);
	
	Если Лев(СтрокаСостояния, ДлинаПрефиксаОшибка) = ПрефиксОшибка ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаОтклонен) = ПрефиксОтклонен
		ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаНеПринят) = ПрефиксНеПринят ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаНеУтвержден) = ПрефиксНеУтвержден
		ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаНекорректный) = ПрефиксНекорректный ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаОтчетОтклонен) = ПрефиксОтчетОтклонен
		ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаОтчетНеПринят) = ПрефиксОтчетНеПринят ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаОтчетНеУтвержден) = ПрефиксОтчетНеУтвержден Тогда
		
		Если ПройденаПроверкаНаПортале <> Истина Тогда
			ПройденаПроверкаНаПортале = Ложь;
		КонецЕсли;
		Возврат Ложь;
		
	ИначеЕсли (Лев(СтрокаСостояния, ДлинаПрефиксаУтвержден) = ПрефиксУтвержден ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаПринят) = ПрефиксПринят
		ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаСдан) = ПрефиксСдан ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаОтчетУтвержден) = ПрефиксОтчетУтвержден
		ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаОтчетПринят) = ПрефиксОтчетПринят ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаОтчетСдан) = ПрефиксОтчетСдан
		ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаОтчетЗагруженВоФГИС) = ПрефиксОтчетЗагруженВоФГИС ИЛИ Лев(СтрокаСостояния, ДлинаПрефиксаОтчетСЭПЗагруженВоФГИС) = ПрефиксОтчетСЭПЗагруженВоФГИС)
		И ПройденаПроверкаНаПортале = Истина Тогда
		
		Возврат Истина;
		
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьПараметрыИнтернета() Экспорт
	
	ИспользуетсяРежимТестирования = ИспользуетсяРежимТестирования();
	
	ПараметрыСервераИнтернета = Новый Структура("URLСервера, КаталогФайловНаСервере, ИмяКлючевогоФайлаНаСервере");
	ПараметрыСервераИнтернета.URLСервера = "downloads.1c.ru";
	ПараметрыСервераИнтернета.КаталогФайловНаСервере = "/RO_OnlineServices/XCHG_FNS";
	Если ИспользуетсяРежимТестирования Тогда
		ПараметрыСервераИнтернета.КаталогФайловНаСервере = ПараметрыСервераИнтернета.КаталогФайловНаСервере + "/Test"; 
	КонецЕсли;
	ПараметрыСервераИнтернета.ИмяКлючевогоФайлаНаСервере = "/infomap.dat";
	Возврат ПараметрыСервераИнтернета;
	
КонецФункции

Функция КнопкаОбновленияВЗаявленииНаПодключениеДоступна(Ссылка) Экспорт

	КнопкаДоступна = Истина;
	
	// Определяем доступность кнопки обновления в зависимости от состояния заявления
	Если НЕ ЗначениеЗаполнено(Ссылка.Статус) Тогда
		КнопкаДоступна = Ложь;
	ИначеЕсли Ссылка.Статус = Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Подготовлено Тогда
		КнопкаДоступна = Ложь;
	ИначеЕсли Ссылка.Статус = Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Отправлено Тогда
		КнопкаДоступна = НЕ Ссылка.ЭлектроннаяПодписьВМоделиСервиса;
	ИначеЕсли Ссылка.Статус = Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Одобрено Тогда
		Если НЕ Ссылка.ЭлектроннаяПодписьВМоделиСервиса ИЛИ Ссылка.ЭлектроннаяПодписьВМоделиСервиса И ЗначениеЗаполнено(Ссылка.УчетнаяЗапись) Тогда
			// Если это не ЭЦП в облаке или ЭЦП в облаке с созданной учетной записью, тогда кнопка обновления недоступна
			КнопкаДоступна = Ложь;
		Иначе
			КнопкаДоступна = Истина;
		КонецЕсли;
	ИначеЕсли Ссылка.Статус = Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Отклонено Тогда
		КнопкаДоступна = Ложь;
	КонецЕсли;
	
	Возврат КнопкаДоступна;
	
КонецФункции

Функция ТекстВКодировке64(Текст, Кодировка)
	
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	ЗаписьТекста = Новый ЗаписьТекста(ИмяВременногоФайла, Кодировка);
	ЗаписьТекста.Записать(Текст);
	ЗаписьТекста.Закрыть();
	
	ДвоичныеДанные = Новый ДвоичныеДанные(ИмяВременногоФайла);
	Результат = Base64Строка(ДвоичныеДанные);
	УдалитьВременныйФайл(ИмяВременногоФайла);
	
	Возврат Результат;
	
КонецФункции

#Область РаботаСоСпискомКБК

Функция ПолучитьДанныеВыбораКБК(СтрокаПоиска) Экспорт
	
	ПодстрокаПоиска = ОбработатьСтрокуПоискаКБК(СтрокаПоиска);
	
	Если СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(ПодстрокаПоиска) Тогда 
		ОбластьПоиска = "КБК";
	Иначе
		ОбластьПоиска = "Наименование";
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаКБК.КБК,
	|	ТаблицаКБК.Наименование
	|ПОМЕСТИТЬ ТаблицаКБК
	|ИЗ
	|	&ТаблицаКБК КАК ТаблицаКБК
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 50
	|	ТаблицаКБК.КБК КАК КБК,
	|	ТаблицаКБК.Наименование
	|ИЗ
	|	ТаблицаКБК КАК ТаблицаКБК
	|ГДЕ
	|	(&ОтбиратьПоКБК
	|				И ТаблицаКБК.КБК ПОДОБНО &СтрокаПоиска
	|			ИЛИ &ОтбиратьПоНаименование
	|				И ТаблицаКБК.Наименование ПОДОБНО &СтрокаПоиска)
	|
	|УПОРЯДОЧИТЬ ПО
	|	КБК";
	Запрос.УстановитьПараметр("ОтбиратьПоКБК", ОбластьПоиска = "КБК");
	Запрос.УстановитьПараметр("ОтбиратьПоНаименование", ОбластьПоиска = "Наименование");
	Запрос.УстановитьПараметр("СтрокаПоиска", "%" + ПодстрокаПоиска + "%");
	Запрос.УстановитьПараметр("ТаблицаКБК", ПолучитьТаблицуКБК());
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	СписокВыбора = Новый СписокЗначений;
	Пока Выборка.Следующий() Цикл
		СписокВыбора.Добавить(Выборка.КБК, Выборка.КБК + " (" + Выборка.Наименование + ")");
	КонецЦикла;
	
	Возврат СписокВыбора;
	
КонецФункции

Функция ОбработатьСтрокуПоискаКБК(СтрокаПоиска) Экспорт
	
	// Если больше 26 символов, скорее всего это не Код БК, а текст -
	// см. шаблон отформатированного КБК: 182 1 01 01011 01 1000 110
	Если СтрДлина(СокрЛП(СтрокаПоиска)) > 26 Тогда
		Возврат СтрокаПоиска;
	КонецЕсли;
	
	// Попробуем получить Код БК
	СтрокаПоискаБезПробелов = СтрЗаменить(СтрокаПоиска, " ", "");
	
	// В Коде БК должны быть только цифры
	Если НЕ СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(СтрокаПоискаБезПробелов) Тогда
		Возврат СтрокаПоиска;
	КонецЕсли;
	
	Если СтрДлина(СтрокаПоискаБезПробелов) = 20 Тогда
		СтрокаПоиска = Сред(СтрокаПоискаБезПробелов, 4);
	Иначе
		СтрокаПоиска = СтрокаПоискаБезПробелов;
	КонецЕсли;
	
	Если СтрДлина(СтрокаПоиска) = 17 Тогда
		ВидДохода = Лев(СтрокаПоиска, 10);
		КОСГУ = Сред(СтрокаПоиска, 15);
		
		ПодстрокаПоиска = ВидДохода + "0000" + КОСГУ;
	Иначе
		ПодстрокаПоиска = СтрокаПоиска;
	КонецЕсли;
		
	Возврат ПодстрокаПоиска;
	
КонецФункции

Функция ПолучитьТаблицуКБК() Экспорт
	
	КБК = Новый ТаблицаЗначений;
	КБК.Колонки.Добавить("КБК", Новый ОписаниеТипов("Строка",,,, Новый КвалификаторыСтроки(20)));
	КБК.Колонки.Добавить("Наименование", Новый ОписаниеТипов("Строка"));
	
	МакетКБК = ДокументооборотСКОВызовСервера.ПолучитьОбработкуЭДО().ПолучитьМакет("КБК");

	Для Инд = 1 По МакетКБК.ВысотаТаблицы Цикл
		НовСтр = КБК.Добавить();
		НовСтр.КБК = СокрЛП(МакетКБК.Область(Инд, 1, Инд, 1).Текст);
		НовСтр.Наименование = СокрЛП(МакетКБК.Область(Инд, 2, Инд, 2).Текст);
	КонецЦикла;
	
	Возврат КБК;
	
КонецФункции

#КонецОбласти

#Область НоваяФормаРегламентированнойОтчетности

#Область ПолучениеТекущегоСостоянияОтправки

//Результат работы функции - структура с полями:
//	ТекущийЭтапОтправки - структура с полями:
//		ТекстНадписи - Строка - текст, отображаемый в панели отправки объекта
//		ТекстСтатуса - Строка - текст, отображаемый в колонке Состояние таблиц формы Отчетность
//		Дата - Дата - Дата текущего этапа
//		КомментарийКСостоянию
//		НаименованиеПротокола
//		Протокол
//		СостояниеСдачиОтчетности - ПеречислениеСсылка.СостояниеСдачиОтчетности
//		ЭтапПройден - Булево
//	НеотправленныеИзвещения - структура с полями:
//		МассивСообщенийНеИмеющихПодтверждений - Массив
//		МассивНеотправленныхПодтверждений - Массив
//		ЕстьНеотправленныеИзвещения - Булево
//	ЕстьКритическиеОшибки - Булево
//В случае ошибки или отсуствия данных, возвращается значение Неопределено
Функция ТекущееСостояниеОтправки(Знач Ссылка, Знач КонтролирующийОрган = "ФНС", ДополнительныеПараметры = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Попытка
		
		ПолучатьДаты 				= Истина;
		ПолучатьОшибкиОтправки 		= Истина;
		Если ТипЗнч(ДополнительныеПараметры) = Тип("Структура") Тогда
			Если ДополнительныеПараметры.Свойство("ПолучатьДаты") Тогда
				ПолучатьДаты = ДополнительныеПараметры.ПолучатьДаты;
			КонецЕсли;
			Если ДополнительныеПараметры.Свойство("ПолучатьОшибкиОтправки") Тогда
				ПолучатьОшибкиОтправки = ДополнительныеПараметры.ПолучатьОшибкиОтправки;
			КонецЕсли;
		КонецЕсли;
		
		// Преобразуем контролирующий орган к нужному виду
		КонтролирующийОрган = ТипКонтролирующегоОргана(КонтролирующийОрган);
		
		ТекущееСостояние = Новый Структура;
		ТекущееСостояние.Вставить("ТекущийЭтапОтправки");
		ТекущееСостояние.Вставить("НеотправленныеИзвещения");
		ТекущееСостояние.Вставить("ЕстьКритическиеОшибки");
		
		// Вся таблица этапов
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправки(Ссылка, КонтролирующийОрган, НЕ ПолучатьДаты);
		
		Если ТаблицаЭтаповОтправки = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		// Текущий этап отправки (для прорисовки панели и определния статуса в списке отчетов)
		ТекущийЭтапОтправки = ТекущийЭтапОтправки(ТаблицаЭтаповОтправки);
		ТекущееСостояние.Вставить("ТекущийЭтапОтправки", ТекущийЭтапОтправки);
		
		Если ПолучатьОшибкиОтправки Тогда
			// Критические ошибки
			ТекущееСостояние.Вставить("ЕстьКритическиеОшибки", ЕстьКритическиеСообщения(Ссылка));
			
			// Неотправленные или несозданные подтверждения
			ТекущееСостояние.Вставить("НеотправленныеИзвещения", НеотправленныеИзвещения(Ссылка));
		КонецЕсли;
		
	Исключение
		
		ТекущееСостояние = Неопределено;
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Получение текущего состояния отправки, критических ошибок и неотправленных извещений'"), 
			УровеньЖурналаРегистрации.Ошибка,,Ссылка,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
		
	КонецПопытки;
		
	Возврат ТекущееСостояние;
		
КонецФункции

Функция ТекущийЭтапОтправки(ТаблицаЭтаповОтправки) Экспорт
	
	НомерЭтапа = ТаблицаЭтаповОтправки.Количество();
	
	// В таблице этапов определяем последний
	ТекущийЭтап = Неопределено;
	Пока НомерЭтапа >= 0 Цикл
		
		НомерЭтапа = НомерЭтапа - 1;
		
		ТекущийЭтап = ТаблицаЭтаповОтправки[НомерЭтапа];
		Если ТекущийЭтап.ЭтапПройден Тогда
			Прервать;
		Конецесли;
	
	КонецЦикла;
	
	// Строку таблицы значений последнего этапа преобразуем к структуре
	Если ТекущийЭтап <> Неопределено Тогда
		СтруктураТекущегоЭтапа = Новый Структура;
		Для каждого Колонка Из ТаблицаЭтаповОтправки.Колонки Цикл
			СтруктураТекущегоЭтапа.Вставить(Колонка.Имя, ТекущийЭтап[Колонка.Имя]);
		КонецЦикла;
		
		Возврат СтруктураТекущегоЭтапа;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Функция ЕстьКритическиеСообщения(Знач Ссылка) Экспорт
	
	Если Ссылка <> Неопределено Тогда
		ДокСсылка = Ссылка.Ссылка;
		Если Не ЗначениеЗаполнено(ДокСсылка) Тогда
			Возврат Ложь;
		КонецЕсли;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
	Если ТипЗнч(Ссылка) = Тип("СправочникСсылка.ДокументыРеализацииПолномочийНалоговыхОрганов") Тогда
		Ссылка = ПолучитьОписьВходящихДокументовПоТребованию(Ссылка);
	КонецЕсли;
	
	ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(Ссылка);
	
	Если ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		                      |	ТранспортноеСообщение.Ссылка КАК Сообщение
		                      |ИЗ
		                      |	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
		                      |ГДЕ
		                      |	ТранспортноеСообщение.ЦиклОбмена = &ЦиклОбмена
		                      |	И ТранспортноеСообщение.Тип В (&Тип)
		                      |	И ТранспортноеСообщение.ПометкаУдаления = ЛОЖЬ");
							  
		Запрос.УстановитьПараметр("ЦиклОбмена", ПоследнийЦиклОбмена);
		
		ТипыКритическихОшибок = Новый Массив;
		ТипыКритическихОшибок.Добавить(Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка);
		ТипыКритическихОшибок.Добавить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР);
		ТипыКритическихОшибок.Добавить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС);
		ТипыКритическихОшибок.Добавить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС);
		Запрос.УстановитьПараметр("Тип", ТипыКритическихОшибок);
		
		КоличествоТранспортныхСообщенийСОшибками = Запрос.Выполнить().Выбрать().Количество();
	Иначе
		КоличествоТранспортныхСообщенийСОшибками = 0;
	КонецЕсли;
	
	Возврат КоличествоТранспортныхСообщенийСОшибками > 0;
	
КонецФункции

Функция НеотправленныеИзвещения(Знач ОтчетСсылка)
	
	МассивСообщенийНеИмеющихПодтверждений = Новый Массив;
	МассивНеотправленныхПодтверждений = Новый Массив;
	
	Результат = Новый Структура;
	Результат.Вставить("МассивСообщенийНеИмеющихПодтверждений", МассивСообщенийНеИмеющихПодтверждений);
	Результат.Вставить("МассивНеотправленныхПодтверждений", МассивНеотправленныхПодтверждений);
	Результат.Вставить("ЕстьНеотправленныеИзвещения", Ложь);
	
	Если ОтчетСсылка <> Неопределено Тогда
		Ссылка = ОтчетСсылка.Ссылка;
		Если Не ЗначениеЗаполнено(Ссылка) Тогда
			Возврат Результат;
		КонецЕсли;
	Иначе
		Возврат Результат;
	КонецЕсли;
	
	Если ТипЗнч(ОтчетСсылка) = Тип("СправочникСсылка.ДокументыРеализацииПолномочийНалоговыхОрганов") Тогда
		ОтчетСсылка = ПолучитьОписьВходящихДокументовПоТребованию(ОтчетСсылка);
	КонецЕсли;
	
	ЦиклОбмена = ПолучитьПоследнийЦиклОбмена(ОтчетСсылка);
	
	Если ЗначениеЗаполнено(ЦиклОбмена) Тогда
		Сообщения = ПолучитьСообщенияЦиклаОбмена(ЦиклОбмена);
		
		// определяем соответствие между типами сообщений-оснований и сообщений-подтверждений на них
		ТипыОснованийИПодтверждений = Новый Соответствие;
		
		// ФНС 534
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО , Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП);
		
		// ФНС 534 2-НДФЛ
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
		// ФНС 534 НФД
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
		// ФНС 534 Представление
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
		// ФНС 534 ИОН
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП);
		
		// ПФР
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколПФР, Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР, Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР, Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР);
		
		// Росстат
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС);
		
		// ФНС 534 НФД НО
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП);
		
		// ФНС 534 ДРП НО
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ДокументНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП);
		
		// ФНС 534 Заявление
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП);
		
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП);
		
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП);
		ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП);
		
		Если ЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.РассылкаГрупповая Тогда
			ТипыОснованийИПодтверждений.Вставить(Перечисления.ТипыТранспортныхСообщений.РассылкаНО, Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП);
		КонецЕсли;
		
		// перебираем соответствие подтверждений основаниям
		Для Каждого ТипОснованияИПодтверждения Из ТипыОснованийИПодтверждений Цикл
			
			ТипОснования = ТипОснованияИПодтверждения.Ключ;
			ТипПодтверждения = ТипОснованияИПодтверждения.Значение;
			
			// для каждого основания...
			СообщенияОснования = Сообщения.НайтиСтроки(Новый Структура("Тип", ТипОснования));
			Для Каждого СообщениеОснование Из СообщенияОснования Цикл
				
				// ... ищем подтверждение, и если не находим, то возвращаем Ложь
				СообщенияПодтверждения = Сообщения.НайтиСтроки(Новый Структура("Основание", СообщениеОснование.Ссылка));
				Если СообщенияПодтверждения.Количество() = 0 Тогда
					МассивСообщенийНеИмеющихПодтверждений.Добавить(СообщениеОснование.Ссылка);
				Иначе
					// формируем массив неотправленных подтверждений
					Для каждого СообщениеПодтверждения Из СообщенияПодтверждения Цикл
						Если СообщениеПодтверждения.Статус <> Перечисления.СтатусыПисем.Отправленное 
							И СообщениеПодтверждения.Статус <> Перечисления.СтатусыПисем.Полученное Тогда
							МассивНеотправленныхПодтверждений.Добавить(СообщениеПодтверждения.Ссылка);
						КонецЕсли;
					КонецЦикла;  
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЦикла;
	КонецЕсли;
	
	Результат.Вставить("МассивСообщенийНеИмеющихПодтверждений", МассивСообщенийНеИмеющихПодтверждений);
	Результат.Вставить("МассивНеотправленныхПодтверждений", МассивНеотправленныхПодтверждений);
	Результат.Вставить("ЕстьНеотправленныеИзвещения", МассивСообщенийНеИмеющихПодтверждений.Количество() > 0 ИЛИ МассивНеотправленныхПодтверждений.Количество() > 0);
	
	Возврат Результат;
	
КонецФункции

Функция ТаблицаЭтаповОтправки(Знач Ссылка, Знач КонтролирующийОрган = "ФНС", Знач НеПолучатьДаты = Ложь) Экспорт
	
	// Преобразуем контролирующий орган к нужному виду
	ТипКонтролирующегоОргана = ТипКонтролирующегоОргана(КонтролирующийОрган);
	
	// Заявление абонента на подключенпие к 1С-Отчетности
	Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗаявлениеАбонентаСпецоператораСвязи") Тогда
		
		 ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиЗаявленияАбонентаСпецоператораСвязи(Ссылка, НеПолучатьДаты);
	
	// Документ реализации полномочий
	ИначеЕсли ТипЗнч(Ссылка) = Тип("СправочникСсылка.ДокументыРеализацииПолномочийНалоговыхОрганов") Тогда
		
		 ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиДокументаРеализацииПолномочийНалоговыхОрганов(Ссылка, НеПолучатьДаты);
			
	// Переписка
	ИначеЕсли ТипЗнч(Ссылка) = Тип("СправочникСсылка.ПерепискаСКонтролирующимиОрганами") Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиПерепискиСКонтролирующимиОрганами(Ссылка, НеПолучатьДаты);
				
	// ЕГРЮЛ, ЕГРИП
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаВыпискуИзЕГРЮЛ_ЕГРИП") Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиЗапросаНаВыпискуИзЕГРЮЛ_ЕГРИП(Ссылка, НеПолучатьДаты);
				
	// Запрос ИОН
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаИнформационноеОбслуживаниеНалогоплательщика") Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиЗапросаИОН(Ссылка, НеПолучатьДаты);
		
	// Входящие описи
	ИначеЕсли ТипЗнч(Ссылка) = Тип("СправочникСсылка.ОписиВходящихДокументовИзНалоговыхОрганов") Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиОписиВходящихДокументовВНалоговыеОрганы(Ссылка, НеПолучатьДаты);
			
	// Исходящие описи
	ИначеЕсли ТипЗнч(Ссылка) = Тип("СправочникСсылка.ОписиИсходящихДокументовВНалоговыеОрганы") Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиОписиИсходящихДокументовВНалоговыеОрганы(Ссылка, НеПолучатьДаты);
			
	// Запрос ИОС
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаИнформационноеОбслуживаниеСтрахователя") Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиЗапросаНаИнформационноеОбслуживаниеСтрахователя(Ссылка, НеПолучатьДаты);

	// ФНС
	ИначеЕсли ТипКонтролирующегоОргана = Перечисления.ТипыКонтролирующихОрганов.ФНС Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиФНС(Ссылка, НеПолучатьДаты);
		
	// ПФР
	ИначеЕсли ТипКонтролирующегоОргана = Перечисления.ТипыКонтролирующихОрганов.ПФР Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиПФР(Ссылка, НеПолучатьДаты);
			
	// ФСС
	ИначеЕсли ТипКонтролирующегоОргана = Перечисления.ТипыКонтролирующихОрганов.ФСС Тогда
	
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиФСС(Ссылка, НеПолучатьДаты);
		
	// Росстат
	ИначеЕсли ТипКонтролирующегоОргана = Перечисления.ТипыКонтролирующихОрганов.ФСГС Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиРосстат(Ссылка, НеПолучатьДаты);

	// ФСРАР
	ИначеЕсли ТипКонтролирующегоОргана = Перечисления.ТипыКонтролирующихОрганов.ФСРАР Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиФСРАР(Ссылка, НеПолучатьДаты);
		
	// РПН
	ИначеЕсли ТипКонтролирующегоОргана = Перечисления.ТипыКонтролирующихОрганов.РПН Тогда
		
		ТаблицаЭтаповОтправки = ТаблицаЭтаповОтправкиРПН(Ссылка, НеПолучатьДаты);
		
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

#Область ФормированиеТаблицЭтаповОтправки

Функция ТаблицаЭтаповОтправкиЗаявленияАбонентаСпецоператораСвязи(Ссылка, НеПолучатьДаты);
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// Показываем гиперссылку на заявление только в тестовом режиме и только если текст есть
	Если ЗначениеЗаполнено(Ссылка.ТекстОтправленногоЗаявления) 
		И Ссылка.ТекстОтправленногоЗаявления.Получить() <> Неопределено
		И ИспользуетсяРежимТестирования() Тогда
		
		НаименованиеПротокола 	= "Заявление";
		Протокол				= ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.АдресТекстаОтправленногоЗаявления(Ссылка);
		
	Иначе
		НаименованиеПротокола	= "";
		Протокол				= "";
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
	СтрокаЭтапа.Дата						= Ссылка.ДатаОтправкиЗаявления;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки'");
	СтрокаЭтапа.НаименованиеПротокола		= НаименованиеПротокола;
	СтрокаЭтапа.Протокол					= Протокол;
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= Ссылка.Статус <> Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Подготовлено
												И ЗначениеЗаполнено(Ссылка.Статус);

	ЕстьКомментарий = НЕ ПустаяСтрока(Ссылка.СтатусКомментарий);
	Если Ссылка.Статус = Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Отклонено Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отклонено'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отклонено'");
		СтрокаЭтапа.Дата						= Ссылка.ДатаПолученияОтвета;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и сформируйте заявление еще раз'");
		СтрокаЭтапа.НаименованиеПротокола		= ?(ЕстьКомментарий, НСтр("ru = 'Протокол ошибок'"), "");
		СтрокаЭтапа.Протокол					= "";
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= Истина;

	Иначе
		Если ЕстьКомментарий Тогда
			Информация = Ссылка.СтатусКомментарий;
		Иначе
			Информация = "";
		КонецЕсли;
		
		ЭтапПройден = Ссылка.Статус = Перечисления.СтатусыЗаявленияАбонентаСпецоператораСвязи.Одобрено;
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Одобрено'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Одобрено'");
		СтрокаЭтапа.Дата						= ?(ЭтапПройден, Ссылка.ДатаПолученияОтвета, Дата(1,1,1));
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= ?(ЕстьКомментарий, НСтр("ru = 'Протокол'"), "");
		СтрокаЭтапа.Протокол					= "";
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= ЭтапПройден;
		
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;

КонецФункции

Функция ТаблицаЭтаповОтправкиОписиВходящихДокументовВНалоговыеОрганы(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Получено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Получено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтправленоИзКонтролирующегоОргана;
	СтрокаЭтапа.ЭтапПройден					= Истина;

	Возврат ТаблицаЭтаповОтправки;

КонецФункции

Функция ТаблицаЭтаповОтправкиДокументаРеализацииПолномочийНалоговыхОрганов(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	// По документу реализации полномочий определяем опись входящих документов
	Опись = ПолучитьОписьВходящихДокументовПоТребованию(СсылкаНаОтчет);
	
	// У описи не может быть пустого цикла обмена
	
	// получаем список сообщений
	ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(Опись);
	СообщенияЦикла 		= ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
	
	// выделяем основные типы сообщений
	СтрДокументНО 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ДокументНО));
	СтрИзвещениеДокументНП 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип, Статус", Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП, Перечисления.СтатусыПисем.Отправленное));
	СтрРезультатПриемаДокументНП 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП));
	СтрИзвещениеРезультатПриемаНО 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНО));
	
	Если НеПолучатьДаты Тогда
		ДатаОтправкиИзФНС 	= Дата(1,1,1);
		ДатаОтказаВПриеме 	= Дата(1,1,1);
		ДатаПриемаОписиНами = Дата(1,1,1);
	Иначе
		ДатаОтправкиИзФНС 	= ?(СтрДокументНО.Количество() > 0,					ДатаИзОтветовКонтролирующихОрганов(СтрДокументНО[0].Ссылка), 	Дата(1,1,1));
		ДатаОтказаВПриеме 	= ?(СтрРезультатПриемаДокументНП.Количество() > 0, 	СтрРезультатПриемаДокументНП[0].ДатаТранспорта, 				Дата(1,1,1));
		ДатаПриемаОписиНами = ?(СтрРезультатПриемаДокументНП.Количество() > 0, 	СтрРезультатПриемаДокументНП[0].Дата, 							Дата(1,1,1));
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено'");
	СтрокаЭтапа.Дата						= ДатаОтправкиИзФНС;
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтправленоИзКонтролирующегоОргана;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// Случай, когда в Описи нет требований
	Если СтрРезультатПриемаДокументНП.Количество() > 0 И ПолучитьМассивТребованийПоОписиВходящихДокументов(Опись).Количество() = 0 Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Получено'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Получено'");
		СтрокаЭтапа.Дата						= ДатаПриемаОписиНами;
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= "";
		СтрокаЭтапа.Протокол					= "";
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПриемПодтвержден;
		СтрокаЭтапа.ЭтапПройден					= Истина;

	Иначе
		
		ЭтоТребование = СсылкаНаОтчет.ВидДокумента = Перечисления.ВидыНалоговыхДокументов.ТребованиеОПредставленииДокументов;
		
		Требования = Новый Массив;
		Требования.Добавить(СсылкаНаОтчет);
		Результат = ПолучитьКоличествоОтветовНаТребования(Требования);
		КоличествоОтветов = Результат.Получить(СсылкаНаОтчет);
		КоличествоОтветовПредставление = ?(КоличествоОтветов = 0 ИЛИ КоличествоОтветов = Неопределено, "", НСтр("ru = 'Ответы('") + Строка(КоличествоОтветов) + ")");
		
		Если ЭтоТребование Тогда
			КомментарийКСостоянию = НСтр("ru = 'Если прием требования не будет подтвержден в течение 1 рабочего дня с момента отправки из ФНС, то документы будут высланы по почте'");
		Иначе
			КомментарийКСостоянию = НСтр("ru = 'Этот документ получен вместе с требованием о представлении документов. Подтверждение приема происходит по всем документам одновременно'");
		КонецЕсли;

		Если СтрРезультатПриемаДокументНП.Количество() > 0 Тогда
			ЧислоСообщений = СтрРезультатПриемаДокументНП.Количество();
			Если ЧислоСообщений = 1 Тогда
				РезультатПриема = СтрРезультатПриемаДокументНП[0];
			Иначе
				// если протоколов несколько, то ориентируемся на наиболее свежий из них
				НаиболееПозднийРезультат = Неопределено;
				ДатаНаиболееПозднегоРезультата = '00010101';
				Для Каждого РезультатПриема Из СтрРезультатПриемаДокументНП Цикл
					ДатаРезультатаПриема = РезультатПриема.Дата;
					Если ДатаРезультатаПриема >= ДатаНаиболееПозднегоРезультата Тогда
						ДатаНаиболееПозднегоРезультата = ДатаРезультатаПриема;
						НаиболееПозднийРезультат = РезультатПриема;
					КонецЕсли;
				КонецЦикла;
				РезультатПриема = НаиболееПозднийРезультат;
			КонецЕсли;
			
			Если РезультатПриема <> Неопределено И РезультатПриема.Ссылка.ПротоколСОшибкой Тогда
		
				СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
				СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отказано в приеме'");
				СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отказано в приеме'");
				СтрокаЭтапа.Дата						= Дата(1,1,1);
				СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Отказ в приеме сформирован '") + Формат(ДатаОтказаВПриеме, "ДЛФ=DT");
				СтрокаЭтапа.НаименованиеПротокола		= КоличествоОтветовПредставление;
				СтрокаЭтапа.Протокол					= РезультатПриема.Ссылка;
				СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
				СтрокаЭтапа.ЭтапПройден					= СтрРезультатПриемаДокументНП.Количество() > 0;

			Иначе
				
				Если ЭтоТребование Тогда
					ТекстНадписи = НСтр("ru = 'Прием подтвержден'");
				Иначе
					ТекстНадписи = НСтр("ru = 'Получено'");
				КонецЕсли;
				
				СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
				СтрокаЭтапа.ТекстНадписи				= ТекстНадписи;
				СтрокаЭтапа.ТекстСтатуса				= ТекстНадписи;
				СтрокаЭтапа.Дата						= ДатаПриемаОписиНами;
				СтрокаЭтапа.КомментарийКСостоянию		= "";
				СтрокаЭтапа.НаименованиеПротокола		= КоличествоОтветовПредставление;
				СтрокаЭтапа.Протокол					= ?(СтрРезультатПриемаДокументНП.Количество() > 0, СтрРезультатПриемаДокументНП[0].Ссылка, "");
				СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПриемПодтвержден;
				СтрокаЭтапа.ЭтапПройден					= СтрРезультатПриемаДокументНП.Количество() > 0;
				
			КонецЕсли;
		Иначе
			
			// Случай, когда в Описи есть требования
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Подтвердите прием'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Подтвердите прием'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= КомментарийКСостоянию;
			СтрокаЭтапа.НаименованиеПротокола		= КоличествоОтветовПредставление;
			СтрокаЭтапа.Протокол					= "";
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ТребуетсяПодтверждениеПриема;
			СтрокаЭтапа.ЭтапПройден					= СтрИзвещениеДокументНП.Количество() > 0;
			
		КонецЕсли;
				
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
		
КонецФункции

Функция ТаблицаЭтаповОтправкиОписиИсходящихДокументовВНалоговыеОрганы(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// получаем список сообщений
	ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(СсылкаНаОтчет);
	
	Если НЕ ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	СообщенияЦикла = ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
	
	// выделяем основные типы сообщений
	СтрПредставленияНП					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП));
	СтрПодтвержденияПредставлениеНО		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО));
	СтрИзвещенияПодтверждениеНП			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП));
	СтрИзвещенияПредставлениеНО			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО));
	СтрРезультатыПриемаПредставлениеНО	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО));
	СтрИзвещенияРезультатПриемаНП		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП));
	
	// Если статус первичного - не отправлено, тогда выходим 
	Если СтрПредставленияНП.Количество() > 0 И СтрПредставленияНП[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;

	// получаем свойства для анализа
	Если НеПолучатьДаты Тогда
		ДатаОтправкиПервичного 		= Дата(1,1,1);
		ДатаИзПодтверждения			= Дата(1,1,1);
		ДатаИзИзвещенияПолучения	= Дата(1,1,1);
	Иначе
		ДатаОтправкиПервичного 		= ?(СтрПредставленияНП.Количество() > 0, 				СтрПредставленияНП[0].ДатаТранспорта, 											Дата(1,1,1));
		ДатаИзПодтверждения			= ?(СтрПодтвержденияПредставлениеНО.Количество() > 0, 	ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияПредставлениеНО[0].Ссылка), 	Дата(1,1,1));
		ДатаИзИзвещенияПолучения	= ?(СтрИзвещенияПредставлениеНО.Количество() > 0,		ДатаИзОтветовКонтролирующихОрганов(СтрИзвещенияПредставлениеНО[0].Ссылка), 		Дата(1,1,1));
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
	СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается подтверждение даты отправки'");
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрПредставленияНП.Количество() > 0;

	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ФНС'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ФНС'");
	СтрокаЭтапа.Дата						= ДатаИзПодтверждения;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки'");
	СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Подтверждение даты отправки'");
	СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияПредставлениеНО.Количество() > 0, СтрПодтвержденияПредставлениеНО[0].Ссылка, "");
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияПредставлениеНО.Количество() > 0;
	
	// определяем наиболее свежее сообщение с результатом приема
	ПоследнийРезультатПриема = Неопределено;
	Для Каждого СтрРезультатПриемаПредставлениеНО Из СтрРезультатыПриемаПредставлениеНО Цикл
		Если ПоследнийРезультатПриема = Неопределено ИЛИ СтрРезультатПриемаПредставлениеНО.Дата > ПоследнийРезультатПриема.Дата Тогда
			ПоследнийРезультатПриема = СтрРезультатПриемаПредставлениеНО;
		КонецЕсли;
	КонецЦикла;
	
	// если результат приема отрицательный, то выводим соответствующее сообщение
	Если ПоследнийРезультатПриема <> Неопределено И ПоследнийРезультатПриема.ПротоколСОшибкой Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не принято'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не принято'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте новую опись'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Уведомление об отказе'");
		СтрокаЭтапа.Протокол					= ?(СтрРезультатыПриемаПредставлениеНО.Количество() > 0, СтрРезультатыПриемаПредставлениеНО[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаПредставлениеНО.Количество() > 0;

	Иначе
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Принято'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Принято'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Квитанция о приеме'");
		СтрокаЭтапа.Протокол					= ?(СтрРезультатыПриемаПредставлениеНО.Количество() > 0, СтрРезультатыПриемаПредставлениеНО[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаПредставлениеНО.Количество() > 0;
		
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиЗапросаИОН(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	 
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;

	// получаем список сообщений
	ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(СсылкаНаОтчет);
	
	Если НЕ ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;

	СообщенияЦикла = ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
	
	// выделяем основные типы сообщений
	СтрЗапросыНП 						= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ЗапросНП));
	СтрПодтвержденияЗапросНО 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО));
	СтрИзвещенияПодтверждениеНП 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП));
	СтрИзвещенияЗапросНО 				= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗапросНО));
	СтрРезультатыПриемаЗапросНО 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО));
	СтрИзвещенияРезультатПриемаНП 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП));
	СтрРезультатыОбработкиЗапросНО 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО));
	СтрИзвещенияРезультатОбработкиНП 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП));
	
	// Если статус первичного - не отправлено, тогда выходим 
	Если СтрЗапросыНП.Количество() > 0 И СтрЗапросыНП[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	Если НеПолучатьДаты Тогда
		ДатаОтправкиПервичного 	= Дата(1,1,1);
		ДатаИзПодтверждения 	= Дата(1,1,1);
		ДатаПринятияВОбработку 	= Дата(1,1,1);
	Иначе
		ДатаОтправкиПервичного 	= ?(СтрЗапросыНП.Количество() > 0, СтрЗапросыНП[0].ДатаТранспорта, Дата(1,1,1));
		ДатаИзПодтверждения 	= ?(СтрПодтвержденияЗапросНО.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияЗапросНО[0].Ссылка), Дата(1,1,1));
		ДатаПринятияВОбработку 	= ?(СтрРезультатыПриемаЗапросНО.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрРезультатыПриемаЗапросНО[0].Ссылка), Дата(1,1,1));
	КонецЕсли;
	
	Если ДатаИзПодтверждения <> Дата(1,1,1) И ДатаОтправкиПервичного > ДатаИзПодтверждения Тогда
		ДатаОтправкиПервичного = ДатаИзПодтверждения;
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
	СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается подтверждение даты отправки'");
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрЗапросыНП.Количество() > 0;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ФНС'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ФНС'");
	СтрокаЭтапа.Дата						= ДатаИзПодтверждения;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается прием запроса в обработку'");
	СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Подтверждение даты отправки'");
	СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияЗапросНО.Количество() > 0, СтрПодтвержденияЗапросНО[0].Ссылка, "");
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияЗапросНО.Количество() > 0;
	
	// определяем наиболее свежее сообщение с результатом приема
	ПоследнийРезультатПриема = Неопределено;
	Для Каждого СтрРезультатПриемаЗапросНО Из СтрРезультатыПриемаЗапросНО Цикл
		Если ПоследнийРезультатПриема = Неопределено ИЛИ СтрРезультатПриемаЗапросНО.Дата > ПоследнийРезультатПриема.Дата Тогда
			ПоследнийРезультатПриема = СтрРезультатПриемаЗапросНО;
		КонецЕсли;
	КонецЦикла;
	
	// если результат приема отрицательный, то выводим соответствующее сообщение
	Если ПоследнийРезультатПриема <> Неопределено И ПоследнийРезультатПриема.ПротоколСОшибкой Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отказано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отказано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте новый запрос'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Уведомление об отказе'");
		СтрокаЭтапа.Протокол					= ?(СтрРезультатыПриемаЗапросНО.Количество() > 0, СтрРезультатыПриемаЗапросНО[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаЗапросНО.Количество() > 0;
		
	Иначе
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Принято в обработку'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Принято в обработку'");
		СтрокаЭтапа.Дата						= ДатаПринятияВОбработку;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается ответ на запрос'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Квитанция о приеме'");
		СтрокаЭтапа.Протокол					= ?(СтрРезультатыПриемаЗапросНО.Количество() > 0, СтрРезультатыПриемаЗапросНО[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
		СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаЗапросНО.Количество() > 0;
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Готово'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Готово'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= СсылкаНаОтчет.ВидУслуги;
		СтрокаЭтапа.Протокол					= ?(СтрРезультатыОбработкиЗапросНО.Количество() > 0, СтрРезультатыОбработкиЗапросНО[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= СтрРезультатыОбработкиЗапросНО.Количество() > 0;
		
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиЗапросаНаВыпискуИзЕГРЮЛ_ЕГРИП(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// получаем список сообщений
	ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(СсылкаНаОтчет);
	
	Если НЕ ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	СообщенияЦикла = ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);

	// выделяем основные типы сообщений
	СтрЗапросЕГР 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ЗапросНаВыпискуЕРГЮЛ_ЕГРИП));
	СтрРезультатыОбработкиЗапросЕГР = СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросаНаВыпискуЕРГЮЛ_ЕГРИП));
	
	// Если статус первичного - не отправлено, тогда выходим 
	Если СтрЗапросЕГР.Количество() > 0 И СтрЗапросЕГР[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	Если НеПолучатьДаты Тогда
		ДатаОтправкиПервичного = Дата(1,1,1);
	Иначе
		ДатаОтправкиПервичного = ?(СтрЗапросЕГР.Количество() > 0, СтрЗапросЕГР[0].ДатаТранспорта, Дата(1,1,1));
	КонецЕсли;
		
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Принято в обработку'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Принято в обработку'");
	СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается ответ на запрос'");
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрЗапросЕГР.Количество() > 0;
	
	// определяем наиболее свежее сообщение с результатом приема
	ПоследнийРезультатПриема = Неопределено;
	Для Каждого СтрРезультатОбработкиЗапроса Из СтрРезультатыОбработкиЗапросЕГР Цикл
		Если ПоследнийРезультатПриема = Неопределено ИЛИ СтрРезультатОбработкиЗапроса.Дата > СтрРезультатОбработкиЗапроса.Дата Тогда
			ПоследнийРезультатПриема = СтрРезультатОбработкиЗапроса;
		КонецЕсли;
	КонецЦикла;
	
	// если результат приема отрицательный, то выводим соответствующее сообщение
	Если ПоследнийРезультатПриема <> Неопределено И ПоследнийРезультатПриема.ПротоколСОшибкой Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отказано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отказано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте новый запрос'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Уведомление об отказе'");
		СтрокаЭтапа.Протокол					= ?(СтрРезультатыОбработкиЗапросЕГР.Количество() > 0, СтрРезультатыОбработкиЗапросЕГР[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= СтрРезультатыОбработкиЗапросЕГР.Количество() > 0;

	Иначе
		
		ЕстьОтвет = ЕстьОтветНаЗапросыВыпискиИзЕГРЮЛ_ЕГРИП(СсылкаНаОтчет);
		
		Если СтрРезультатыОбработкиЗапросЕГР.Количество() > 0 И НЕ ЕстьОтвет Тогда
			
			Если СсылкаНаОтчет.ВидПараметраЗапроса	= Перечисления.ВидыПараметровЗапросаНаВыпискуИзЕГРЮЛ_ЕГРИП.ИНН Тогда
				Комментарий = НСтр("ru = 'По запрошенному ИНН информация в реестре не найдена'");
			Иначе
				Комментарий = НСтр("ru = 'По запрошенному ОГРН информация в реестре не найдена'");
			КонецЕсли;
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не найдено в реестре'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не найдено в реестре'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= Комментарий;
			СтрокаЭтапа.НаименованиеПротокола		= "";
			СтрокаЭтапа.Протокол					= "";
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= СтрРезультатыОбработкиЗапросЕГР.Количество() > 0;
			
		Иначе

			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Готово'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Готово'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= "";
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Выписка'");
			СтрокаЭтапа.Протокол					= ?(СтрРезультатыОбработкиЗапросЕГР.Количество() > 0, СтрРезультатыОбработкиЗапросЕГР[0].Ссылка, "");
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= СтрРезультатыОбработкиЗапросЕГР.Количество() > 0;
			
		КонецЕсли;
			
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиЗапросаНаИнформационноеОбслуживаниеСтрахователя(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// получаем список сообщений
	ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(СсылкаНаОтчет);
	
	Если НЕ ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	СообщенияЦикла = ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
	
	// выделяем основные типы сообщений
	СтрПервичныеСообщенияСодержащееЗапросПФР 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР));
	СтрПодтвержденияПолученияЗапросаПФР 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР));
	СтрОтветыНаЗапросПФР 						= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР));
	СтрОтветыНаЗапросКвитанцияПФР 				= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР));
	
	Если НеПолучатьДаты Тогда
		ДатаОтправкиПервичного 	= Дата(1,1,1);
		ДатаИзПодтверждения 	= Дата(1,1,1);
	Иначе
		ДатаОтправкиПервичного = ?(СтрПервичныеСообщенияСодержащееЗапросПФР.Количество() > 0, СтрПервичныеСообщенияСодержащееЗапросПФР[0].ДатаТранспорта, Дата(1,1,1));
		ДатаИзПодтверждения = ?(СтрПодтвержденияПолученияЗапросаПФР.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияПолученияЗапросаПФР[0].Ссылка), Дата(1,1,1));
	КонецЕсли;
	
	Если ДатаИзПодтверждения <> Дата(1,1,1) И ДатаОтправкиПервичного > ДатаИзПодтверждения Тогда
		ДатаОтправкиПервичного = ДатаИзПодтверждения;
	КонецЕсли;
	
	// Если статус первичного - не отправлено, тогда выходим 
	Если СтрПервичныеСообщенияСодержащееЗапросПФР.Количество() > 0 И СтрПервичныеСообщенияСодержащееЗапросПФР[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	// Отправлено в ПФР
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ПФР'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ПФР'");
	СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается прием запроса в обработку'");
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрПервичныеСообщенияСодержащееЗапросПФР.Количество() > 0;

	// Принято в обработку
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Принято в обработку'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Принято в обработку'");
	СтрокаЭтапа.Дата						= ДатаИзПодтверждения;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается ответ на запрос'");
	СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Подтверждение получения'");
	СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияПолученияЗапросаПФР.Количество() > 0, СтрПодтвержденияПолученияЗапросаПФР[0].Ссылка, "");
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияПолученияЗапросаПФР.Количество() > 0;
			
	// определяем наиболее свежее сообщение с результатом приема
	ПоследнийОтветНаЗапрос = Неопределено;
	Для Каждого СтрОтветНаЗапросПФР Из СтрОтветыНаЗапросПФР Цикл
		Если ПоследнийОтветНаЗапрос = Неопределено ИЛИ СтрОтветНаЗапросПФР.Дата > ПоследнийОтветНаЗапрос.Дата Тогда
			ПоследнийОтветНаЗапрос = СтрОтветНаЗапросПФР;
		КонецЕсли;
	КонецЦикла;
	
	// если результат отрицательный, то выводим соответствующее сообщение
	Если ПоследнийОтветНаЗапрос <> Неопределено И ПоследнийОтветНаЗапрос.ПротоколСОшибкой Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отказано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отказано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте новый запрос'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Уведомление об отказе'");
		СтрокаЭтапа.Протокол					= ?(СтрОтветыНаЗапросПФР.Количество() > 0, СтрОтветыНаЗапросПФР[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= СтрОтветыНаЗапросПФР.Количество() > 0;
		
	Иначе
		
		Если СсылкаНаОтчет.ВидУслуги = Перечисления.ВидыУслугПриИОС.СправкаОСостоянииРасчетов Тогда
			НаименованиеПротокола = НСтр("ru = 'Справка о состоянии расчетов'");
		Иначе
			НаименованиеПротокола = НСтр("ru = 'Сверка ФИО и СНИЛС'");
		КонецЕсли;
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Готово'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Готово'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= НаименованиеПротокола;
		СтрокаЭтапа.Протокол					= ?(СтрОтветыНаЗапросПФР.Количество() > 0, СтрОтветыНаЗапросПФР[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= СтрОтветыНаЗапросПФР.Количество() > 0;
		
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиФСРАР(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// определяем последнюю отправку
	ОтправкаСсылка =  ПолучитьПоследнююОтправкуОтчетаВФСРАР(СсылкаНаОтчет);
	
	Если НЕ ЗначениеЗаполнено(ОтправкаСсылка) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ФСРАР'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ФСРАР'");
	СтрокаЭтапа.Дата						= ?(ЗначениеЗаполнено(ОтправкаСсылка), ОтправкаСсылка.ДатаОтправки, Дата(1,1,1));
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки отчета'");
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= ОтправкаСсылка <> Неопределено;

	
	Если ОтправкаСсылка <> Неопределено И  ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол ошибок'");
		СтрокаЭтапа.Протокол					= ОтправкаСсылка;
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= Истина;
		
	Иначе
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.Дата						= ?(ЗначениеЗаполнено(ОтправкаСсылка) И ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.Сдан, ОтправкаСсылка.ДатаОтправки, Дата(1,1,1));
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол о сдаче'");
		СтрокаЭтапа.Протокол					= ОтправкаСсылка;
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= ОтправкаСсылка <> Неопределено И ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.Сдан;
			
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиРПН(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// определяем последнюю отправку
	ОтправкаСсылка =  ПолучитьПоследнююОтправкуОтчетаВРПН(СсылкаНаОтчет);
	
	Если НЕ ЗначениеЗаполнено(ОтправкаСсылка) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в РПН'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в РПН'");
	СтрокаЭтапа.Дата						= ?(ЗначениеЗаполнено(ОтправкаСсылка), ОтправкаСсылка.ДатаОтправки, Дата(1,1,1));
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки'");
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= ОтправкаСсылка <> Неопределено;

	
	Если ОтправкаСсылка <> Неопределено И  ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол ошибок'");
		СтрокаЭтапа.Протокол					= ОтправкаСсылка;
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= Истина;
		
	Иначе
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.Дата						= ?(ЗначениеЗаполнено(ОтправкаСсылка) И ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.Сдан, ОтправкаСсылка.ДатаОтправки, Дата(1,1,1));
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол о сдаче'");
		СтрокаЭтапа.Протокол					= ОтправкаСсылка;
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= ОтправкаСсылка <> Неопределено И ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.Сдан;
			
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиФСС(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	// определяем последнюю отправку
	ОтправкаСсылка = ПолучитьПоследнююОтправкуОтчетаВФСС(СсылкаНаОтчет);
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	Если НЕ ЗначениеЗаполнено(ОтправкаСсылка) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ФСС'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ФСС'");
	СтрокаЭтапа.Дата						= ?(ЗначениеЗаполнено(ОтправкаСсылка), ОтправкаСсылка.ДатаОтправки, Дата(1,1,1));
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки отчета'");
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= ОтправкаСсылка <> Неопределено;


	Если ОтправкаСсылка <> Неопределено И ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.НеПринят Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол ошибок'");
		СтрокаЭтапа.Протокол					= ОтправкаСсылка;
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= Истина;
		
	ИначеЕсли ОтправкаСсылка <> Неопределено И ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.ПринятЕстьОшибки Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано, требует уточнения'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано, требует уточнения'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Подготовьте и отправьте корректирующий отчет'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол ошибок'");
		СтрокаЭтапа.Протокол					= ОтправкаСсылка;
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= Истина;
		
	Иначе
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.Дата						= ?(ЗначениеЗаполнено(ОтправкаСсылка) И ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.Сдан, ОтправкаСсылка.ДатаОтправки, Дата(1,1,1));
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол о сдаче'");
		СтрокаЭтапа.Протокол					= ОтправкаСсылка;
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= ОтправкаСсылка <> Неопределено И ОтправкаСсылка.СтатусОтправки = Перечисления.СтатусыОтправки.Сдан;
		
	КонецЕсли;
		
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиРосстат(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	// определяем последний цикл обмена по отчету
	Если ЗначениеЗаполнено(СсылкаНаОтчет) Тогда
		ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(СсылкаНаОтчет);
	Иначе
		ПоследнийЦиклОбмена = Справочники.ЦиклыОбмена.ПустаяСсылка();
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// если у пользователя недостаточно прав для получения сведений об отправке, то скроем панель
	Если НЕ ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
		
	// получаем список всех не помеченных на удаление сообщений последнего цикла
	СообщенияЦикла = ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
	
	// выделяем основные типы сообщений
	СтрПервичныеСообщения 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС));
	СтрПодтвержденияДатыОтправки 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС));
	СтрИзвещенияПодтвержденияДатыОтправки 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС));
	СтрИзвещенияОПриеме 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС));
	СтрПротоколыВходногоКонтроля 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС));
	СтрИзвещенияПротоколыВходногоКонтроля 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС));
	СтрКритическиеОшибки 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка));
	
	Если СтрПервичныеСообщения.Количество() > 0 И СтрПервичныеСообщения[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	Если НеПолучатьДаты Тогда
		ДатаОтправкиПервичного 			= Дата(1,1,1);
		ДатаИзПодтвержденияДатыОтправки = Дата(1,1,1);
	Иначе
		ДатаОтправкиПервичного 			= ?(СтрПервичныеСообщения.Количество() > 0, СтрПервичныеСообщения[0].ДатаТранспорта, Дата(1,1,1));
		ДатаИзПодтвержденияДатыОтправки = ?(СтрПодтвержденияДатыОтправки.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияДатыОтправки[0].Ссылка), Дата(1,1,1));
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
	СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается подтверждение даты отправки'");
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрПервичныеСообщения.Количество() > 0;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в Росстат'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в Росстат'");
	СтрокаЭтапа.Дата						= ДатаИзПодтвержденияДатыОтправки;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки отчета'");
	СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Подтверждение даты отправки'");
	СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияДатыОтправки.Количество() > 0, СтрПодтвержденияДатыОтправки[0].Ссылка, "");
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияДатыОтправки.Количество() > 0;

	ПоследнийПротокол = Неопределено;
	Для Каждого СтрПротокол Из СтрПротоколыВходногоКонтроля Цикл
		Если ПоследнийПротокол = Неопределено ИЛИ СтрПротокол.Дата > ПоследнийПротокол.Дата Тогда
			ПоследнийПротокол = СтрПротокол;
		КонецЕсли;
	КонецЦикла;
	
	Если ПоследнийПротокол <> Неопределено И ПоследнийПротокол.ПротоколСОшибкой Тогда
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
		СтрокаЭтапа.НаименованиеПротокола		= "Протокол ошибок";
		СтрокаЭтапа.Протокол					= ПоследнийПротокол.Ссылка;
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= Истина;
		
	Иначе
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол о сдаче'");
		СтрокаЭтапа.Протокол					= ?(СтрПротоколыВходногоКонтроля.Количество() > 0, СтрПротоколыВходногоКонтроля[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= СтрПротоколыВходногоКонтроля.Количество() > 0;
		
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиФНС(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();

	// определяем последний цикл обмена по отчету
	Если ЗначениеЗаполнено(СсылкаНаОтчет) Тогда
		ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(СсылкаНаОтчет);
	Иначе
		ПоследнийЦиклОбмена = Справочники.ЦиклыОбмена.ПустаяСсылка();
	КонецЕсли;
	
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// если у пользователя недостаточно прав для получения сведений об отправке, то скроем панель
	Если НЕ ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	// получаем список всех не помеченных на удаление сообщений последнего цикла
	СообщенияЦикла = ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
		
	Если ПоследнийЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Заявление Тогда
		
		// выделяем основные типы сообщений
		СтрЗаявленияНП 							= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП));
		СтрПодтвержденияЗаявлениеНО				= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО));
		СтрИзвещенияПодтверждениеНП 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП));
		СтрИзвещенияЗаявлениеНО 				= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗаявлениеНО));
		СтрРезультатыПриемаЗаявлениеНО 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО));
		СтрИзвещенияРезультатПриемаНП 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП));
		
		СтрРезультатыОбработкиЗаявлениеНО		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО));
		СтрИзвещенияРезультатОбработкиНП 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП));
	
		СтрРезультатыОбработкиЗаявлениеРФНО		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО));
		СтрИзвещенияРезультатОбработкиРФНП 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП));
		СтрСообщенияОбОтзывеЗаявлениеРФНО 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО));
		СтрИзвещенияОбОтзывеЗаявлениеРФНП 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП));
		СтрРезультатыОбработкиЗаявлениеТСНО 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО));
		СтрИзвещенияРезультатОбработкиТСНП 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП));
		
		СтрКритическиеОшибки 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС));
		
		Если СтрЗаявленияНП.Количество() > 0 И СтрЗаявленияНП[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
			Возврат ТаблицаЭтаповОтправки;
		КонецЕсли;
		
		Если НеПолучатьДаты Тогда
			ДатаОтправкиПервичного 		= Дата(1,1,1);
			ДатаИзПодтвержденияОтравки 	= Дата(1,1,1);
			ДатаПринятияВОбработку 		= Дата(1,1,1);
		Иначе
			ДатаОтправкиПервичного 		= ?(СтрЗаявленияНП.Количество() > 0,	СтрЗаявленияНП[0].ДатаТранспорта, Дата(1,1,1));
			ДатаИзПодтвержденияОтравки 	= ?(СтрПодтвержденияЗаявлениеНО.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияЗаявлениеНО[0].Ссылка), Дата(1,1,1));
			ДатаПринятияВОбработку 		= ?(СтрИзвещенияРезультатПриемаНП.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрИзвещенияРезультатПриемаНП[0].Ссылка), Дата(1,1,1));
		КонецЕсли;
		
		Если ДатаИзПодтвержденияОтравки <> Дата(1,1,1) И ДатаОтправкиПервичного > ДатаИзПодтвержденияОтравки Тогда
			ДатаОтправкиПервичного = ДатаИзПодтвержденияОтравки;
		КонецЕсли;
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
		СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается подтверждение даты отправки'");
		СтрокаЭтапа.НаименованиеПротокола		= "";
		СтрокаЭтапа.Протокол					= "";
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
		СтрокаЭтапа.ЭтапПройден					= СтрЗаявленияНП.Количество() > 0;
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ФНС'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ФНС'");
		СтрокаЭтапа.Дата						= ДатаИзПодтвержденияОтравки;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается прием отчета в обработку'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Подтверждение даты отправки'");
		СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияЗаявлениеНО.Количество() > 0, СтрПодтвержденияЗаявлениеНО[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
		СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияЗаявлениеНО.Количество() > 0;
		
		// определяем наиболее свежее сообщение с результатом приема
		ПоследнийРезультатПриема = Неопределено;
		Для Каждого СтрРезультатПриемаЗаявлениеНО Из СтрРезультатыПриемаЗаявлениеНО Цикл
			Если ПоследнийРезультатПриема = Неопределено ИЛИ СтрРезультатПриемаЗаявлениеНО.Дата > ПоследнийРезультатПриема.Дата Тогда
				ПоследнийРезультатПриема = СтрРезультатПриемаЗаявлениеНО;
			КонецЕсли;
		КонецЦикла;
		
		// если результат приема отрицательный, то выводим соответствующее сообщение
		Если ПоследнийРезультатПриема <> Неопределено И ПоследнийРезультатПриема.ПротоколСОшибкой Тогда
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не принято в обработку'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не принято в обработку'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Уведомление об отказе'");
			СтрокаЭтапа.Протокол					= ПоследнийРезультатПриема.Ссылка;
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= Истина;
			
		Иначе
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Принято в обработку'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Принято в обработку'");
			СтрокаЭтапа.Дата						= ДатаПринятияВОбработку;
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки отчета'");
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Квитанция о приеме'");
			СтрокаЭтапа.Протокол					= ?(СтрИзвещенияРезультатПриемаНП.Количество() > 0, СтрИзвещенияРезультатПриемаНП[0].Ссылка, "");
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
			СтрокаЭтапа.ЭтапПройден					= СтрИзвещенияРезультатПриемаНП.Количество() > 0;
			
			// определяем наиболее свежее сообщение с результатом обработки
			ПоследнийРезультатОбработки = Неопределено;
			Для Каждого СтрРезультатОбработки Из СтрРезультатыОбработкиЗаявлениеРФНО Цикл
				Если ПоследнийРезультатОбработки = Неопределено ИЛИ СтрРезультатОбработки.Дата > ПоследнийРезультатОбработки.Дата Тогда
					ПоследнийРезультатОбработки = СтрРезультатОбработки;
				КонецЕсли;
			КонецЦикла;
			
			// если результат обработки отрицательный, то выводим соответствующее сообщение
			Если ПоследнийРезультатОбработки <> Неопределено И ПоследнийРезультатОбработки.ПротоколСОшибкой Тогда
				
				СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
				СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
				СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
				СтрокаЭтапа.Дата						= Дата(1,1,1);
				СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
				СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Сообщение о проверке'");
				СтрокаЭтапа.Протокол					= ПоследнийРезультатОбработки.Ссылка;
				СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
				СтрокаЭтапа.ЭтапПройден					= Истина;
				
			Иначе
				
				Если СтрРезультатыОбработкиЗаявлениеНО.Количество() = 0 Тогда
					
					Если СтрСообщенияОбОтзывеЗаявлениеРФНО.Количество() <> 0 Тогда

						СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
						СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
						СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
						СтрокаЭтапа.Дата						= Дата(1,1,1);
						СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
						СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Сообщение об отзыве заявления'");
						СтрокаЭтапа.Протокол					= СтрСообщенияОбОтзывеЗаявлениеРФНО[0].Ссылка;
						СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
						СтрокаЭтапа.ЭтапПройден					= Истина;
					
					Иначе
						Если СтрРезультатыОбработкиЗаявлениеТСНО.Количество() <> 0 Тогда
							
							СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
							СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
							СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
							СтрокаЭтапа.Дата						= Дата(1,1,1);
							СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
							СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Сообщение о несоответствиях'");
							СтрокаЭтапа.Протокол					= СтрРезультатыОбработкиЗаявлениеТСНО[0].Ссылка;
							СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
							СтрокаЭтапа.ЭтапПройден					= Истина;

						Иначе
							
							СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
							СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
							СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
							СтрокаЭтапа.Дата						= Дата(1,1,1);
							СтрокаЭтапа.КомментарийКСостоянию		= "";
							СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Сообщение о проверке'");
							СтрокаЭтапа.Протокол					= ?(СтрРезультатыПриемаЗаявлениеНО.Количество() > 0, СтрРезультатыПриемаЗаявлениеНО[0].Ссылка, "");
							СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
							СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаЗаявлениеНО.Количество() > 0 И СтрРезультатыОбработкиЗаявлениеТСНО.Количество() = 0;

						КонецЕсли;
					КонецЕсли;
			
				Иначе
					
					// определяем наиболее свежее сообщение с результатом обработки
					ПоследнийРезультатОбработки = Неопределено;
					Для Каждого СтрРезультатОбработки Из СтрРезультатыОбработкиЗаявлениеНО Цикл
						Если ПоследнийРезультатОбработки = Неопределено ИЛИ СтрРезультатОбработки.Дата > ПоследнийРезультатОбработки.Дата Тогда
							ПоследнийРезультатОбработки = СтрРезультатОбработки;
						КонецЕсли;
					КонецЦикла;
					
					// если результат обработки отрицательный, то выводим соответствующее сообщение
					Если ПоследнийРезультатОбработки <> Неопределено И ПоследнийРезультатОбработки.ПротоколСОшибкой Тогда
						
						СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
						СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
						СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
						СтрокаЭтапа.Дата						= Дата(1,1,1);
						СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
						СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Уведомление об отказе в проставлении пометки'");
						СтрокаЭтапа.Протокол					= ПоследнийРезультатОбработки.Ссылка;
						СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
						СтрокаЭтапа.ЭтапПройден					= Истина;
						
					Иначе
						
						СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
						СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
						СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
						СтрокаЭтапа.Дата						= Дата(1,1,1);
						СтрокаЭтапа.КомментарийКСостоянию		= "";
						СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Квитанция о приеме'");
						СтрокаЭтапа.Протокол					= ?(СтрРезультатыОбработкиЗаявлениеНО.Количество() > 0, СтрРезультатыОбработкиЗаявлениеНО[0].Ссылка, "");
						СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
						СтрокаЭтапа.ЭтапПройден					= СтрРезультатыОбработкиЗаявлениеТСНО.Количество() = 0 И СтрСообщенияОбОтзывеЗаявлениеРФНО.Количество() = 0
							И СтрРезультатыОбработкиЗаявлениеРФНО.Количество() > 0 ;
							
					КонецЕсли;
						
				КонецЕсли;
					
			КонецЕсли;
			
		КонецЕсли;

	ИначеЕсли ПоследнийЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Форма2НДФЛ Тогда
		
		// выделяем основные типы сообщений
		СтрФормы2НДФЛНП							= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП));
		СтрПодтвержденияФорма2НДФЛНО			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО));
		СтрИзвещенияПодтверждениеНП 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП));
		СтрИзвещенияФорма2НДФЛНО 				= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО));
		СтрРезультатыПриемаФорма2НДФЛНО			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО));
		СтрИзвещенияРезультатПриемаНП 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП));
		
		СтрКритическиеОшибки 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС));
		
		Если СтрФормы2НДФЛНП.Количество() > 0 И СтрФормы2НДФЛНП[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
			Возврат ТаблицаЭтаповОтправки;
		КонецЕсли;
		
		Если НеПолучатьДаты Тогда
			ДатаОтправкиПервичного 			= Дата(1,1,1);
			ДатаИзПодтвержденияДатыОтправки = Дата(1,1,1);
		Иначе
			ДатаОтправкиПервичного 			= ?(СтрФормы2НДФЛНП.Количество() > 0, СтрФормы2НДФЛНП[0].ДатаТранспорта, Дата(1,1,1));
			ДатаИзПодтвержденияДатыОтправки = ?(СтрПодтвержденияФорма2НДФЛНО.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияФорма2НДФЛНО[0].Ссылка), Дата(1,1,1));
		КонецЕсли;
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
		СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается подтверждение даты отправки'");
		СтрокаЭтапа.НаименованиеПротокола		= "";
		СтрокаЭтапа.Протокол					= ?(СтрФормы2НДФЛНП.Количество() > 0, СтрФормы2НДФЛНП[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
		СтрокаЭтапа.ЭтапПройден					= СтрФормы2НДФЛНП.Количество() > 0;

		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ФНС'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ФНС'");
		СтрокаЭтапа.Дата						= ДатаИзПодтвержденияДатыОтправки;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается прием отчета в обработку'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Подтверждение даты отправки'");
		СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияФорма2НДФЛНО.Количество() > 0, СтрПодтвержденияФорма2НДФЛНО[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
		СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияФорма2НДФЛНО.Количество() > 0;
		
		// определяем наиболее свежее сообщение с результатом приема
		ПоследнийРезультатПриема = Неопределено;
		Для Каждого СтрРезультатПриемаФорма2НДФЛНО Из СтрРезультатыПриемаФорма2НДФЛНО Цикл
			Если ПоследнийРезультатПриема = Неопределено ИЛИ СтрРезультатПриемаФорма2НДФЛНО.Дата > ПоследнийРезультатПриема.Дата Тогда
				ПоследнийРезультатПриема = СтрРезультатПриемаФорма2НДФЛНО;
			КонецЕсли;
		КонецЦикла;
		
		// если результат приема отрицательный, то выводим соответствующее сообщение
		Если ПоследнийРезультатПриема <> Неопределено И ПоследнийРезультатПриема.ПротоколСОшибкой Тогда
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
			СтрокаЭтапа.НаименованиеПротокола		= "Протокол ошибок";
			СтрокаЭтапа.Протокол					= ПоследнийРезультатПриема.Ссылка;
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= Истина;
			
		Иначе
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= "";
			СтрокаЭтапа.НаименованиеПротокола		= "Протокол приема";
			СтрокаЭтапа.Протокол					= ?(СтрРезультатыПриемаФорма2НДФЛНО.Количество() > 0, СтрРезультатыПриемаФорма2НДФЛНО[0].Ссылка, "");
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаФорма2НДФЛНО.Количество() > 0;
			
		КонецЕсли;
		
	ИначеЕсли ПоследнийЦиклОбмена.Тип = Перечисления.ТипыЦикловОбмена.Представление Тогда
		
		// выделяем основные типы сообщений
		СтрПредставленияНП					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП));
		СтрПодтвержденияПредставлениеНО		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО));
		СтрИзвещенияПодтверждениеНП			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП));
		СтрИзвещенияПредставлениеНО			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО));
		СтрРезультатыПриемаПредставлениеНО	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО));
		СтрИзвещенияРезультатПриемаНП		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП));
		
		СтрКритическиеОшибки = СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС));
		
		// Если статус первичного - не отправлено, тогда выходим 
		Если СтрПредставленияНП.Количество() > 0 И СтрПредставленияНП[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
			Возврат ТаблицаЭтаповОтправки;
		КонецЕсли;
		
		// получаем свойства для анализа
		Если НеПолучатьДаты Тогда
			ДатаОтправкиПервичного 			= Дата(1,1,1);
			ДатаИзПодтвержденияДатыОтправки = Дата(1,1,1);
		Иначе
			ДатаОтправкиПервичного 			= ?(СтрПредставленияНП.Количество() > 0, СтрПредставленияНП[0].ДатаТранспорта, Дата(1,1,1));
			ДатаИзПодтвержденияДатыОтправки = ?(СтрПодтвержденияПредставлениеНО.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияПредставлениеНО[0].Ссылка), Дата(1,1,1));
		КонецЕсли;
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
		СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается подтверждение даты отправки'");
		СтрокаЭтапа.НаименованиеПротокола		= "";
		СтрокаЭтапа.Протокол					= ?(СтрПредставленияНП.Количество() > 0, СтрПредставленияНП[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
		СтрокаЭтапа.ЭтапПройден					= СтрПредставленияНП.Количество() > 0;

		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ФНС'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ФНС'");
		СтрокаЭтапа.Дата						= ДатаИзПодтвержденияДатыОтправки;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается прием уведомления в обработку'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Подтверждение даты отправки'");
		СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияПредставлениеНО.Количество() > 0, СтрПодтвержденияПредставлениеНО[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
		СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияПредставлениеНО.Количество() > 0;
		
		// определяем наиболее свежее сообщение с результатом приема
		ПоследнийРезультатПриема = Неопределено;
		Для Каждого СтрРезультатПриемаПредставлениеНО Из СтрРезультатыПриемаПредставлениеНО Цикл
			Если ПоследнийРезультатПриема = Неопределено ИЛИ СтрРезультатПриемаПредставлениеНО.Дата > ПоследнийРезультатПриема.Дата Тогда
				ПоследнийРезультатПриема = СтрРезультатПриемаПредставлениеНО;
			КонецЕсли;
		КонецЦикла;
		
		// если результат приема отрицательный, то выводим соответствующее сообщение
		Если ПоследнийРезультатПриема <> Неопределено И ПоследнийРезультатПриема.ПротоколСОшибкой Тогда
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте уведомление еще раз'");
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол ошибок'");
			СтрокаЭтапа.Протокол					= ПоследнийРезультатПриема.Ссылка;
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= Истина;
			
		Иначе
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= "";
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол приема'");
			СтрокаЭтапа.Протокол					= ?(СтрРезультатыПриемаПредставлениеНО.Количество() > 0, СтрРезультатыПриемаПредставлениеНО[0].Ссылка, "");
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаПредставлениеНО.Количество() > 0;
			
		КонецЕсли;

		
	Иначе
		
		// выделяем основные типы сообщений
		СтрДекларацииНП 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ДекларацияНП));// Отправлено оператору
		СтрПодтвержденияДекларацияНО 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО));// Отправлено в ФНС
		СтрИзвещенияПодтверждениеНП 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП));
		СтрИзвещенияДекларацияНО 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО));// Доставлено
		СтрРезультатыПриемаДекларацияНО 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО));// Не принято в обработку ИЛИ Принято в обработку
		СтрИзвещенияРезультатПриемаНП 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП));
		СтрРезультатыОбработкиДекларацияНО 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО));// Сдано, требует уточнения ИЛИ Сдано
		СтрИзвещенияРезультатОбработкиНП	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП));
		СтрКритическиеОшибки 				= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС));
		
		// Если статус первичного - не отправлено, тогда выходим 
		Если СтрДекларацииНП.Количество() > 0 И СтрДекларацииНП[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
			Возврат ТаблицаЭтаповОтправки;
		КонецЕсли;
		
		Если НеПолучатьДаты Тогда
			ДатаИзПодтвержденияДатыОтправки = Дата(1,1,1);
			ДатаИзКвитанцииОПриеме 			= Дата(1,1,1);
		Иначе
			ДатаИзПодтвержденияДатыОтправки = ?(СтрПодтвержденияДекларацияНО.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияДекларацияНО[0].Ссылка), Дата(1,1,1));
			ДатаИзКвитанцииОПриеме 			=  ?(СтрРезультатыПриемаДекларацияНО.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрРезультатыПриемаДекларацияНО[0].Ссылка), Дата(1,1,1));
		КонецЕсли;
		
		// Отправлено оператору
		ДатаОтправкиОператору = Дата(1,1,1);
		Если СтрДекларацииНП.Количество() > 0 Тогда
			ДатаОтправкиОператору = СтрДекларацииНП[0].ДатаТранспорта;
		КонецЕсли;
		
		Если ДатаИзПодтвержденияДатыОтправки <> Дата(1,1,1) И ДатаОтправкиОператору < ДатаИзПодтвержденияДатыОтправки Тогда
			ДатаОтправкиОператору = ДатаИзПодтвержденияДатыОтправки;
		КонецЕсли;

		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
		СтрокаЭтапа.Дата						= ДатаОтправкиОператору;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается подтверждение даты отправки'");
		СтрокаЭтапа.НаименованиеПротокола		= "";
		СтрокаЭтапа.Протокол					= "";
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
		СтрокаЭтапа.ЭтапПройден					= СтрДекларацииНП.Количество() > 0;
		
		// Отправлено в ФНС
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ФНС'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ФНС'");
		СтрокаЭтапа.Дата						= ДатаИзПодтвержденияДатыОтправки;
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается прием отчета в обработку'");
		СтрокаЭтапа.НаименованиеПротокола		= "Подтверждение даты отправки";
		СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияДекларацияНО.Количество() > 0, СтрПодтвержденияДекларацияНО[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
		СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияДекларацияНО.Количество() > 0;
			
		// определяем наиболее свежее сообщение с результатом приема
		ПоследнийРезультатПриема = Неопределено;
		Для Каждого СтрРезультатПриемаДекларацияНО Из СтрРезультатыПриемаДекларацияНО Цикл
			Если ПоследнийРезультатПриема = Неопределено ИЛИ СтрРезультатПриемаДекларацияНО.Дата > ПоследнийРезультатПриема.Дата Тогда
				ПоследнийРезультатПриема = СтрРезультатПриемаДекларацияНО;
			КонецЕсли;
		КонецЦикла;
		
		// если результат приема отрицательный, то выводим соответствующее сообщение
		Если ПоследнийРезультатПриема <> Неопределено И ПоследнийРезультатПриема.ПротоколСОшибкой Тогда
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не принято в обработку'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не принято в обработку'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Уведомление об отказе'");
			СтрокаЭтапа.Протокол					= ПоследнийРезультатПриема.Ссылка;
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаДекларацияНО.Количество() > 0;
			
		Иначе
			
			// Принято в обработку
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Принято в обработку'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Принято в обработку'");
			СтрокаЭтапа.Дата						= ДатаИзКвитанцииОПриеме;
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки отчета'");
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Квитанция о приеме'");
			СтрокаЭтапа.Протокол					= ?(СтрРезультатыПриемаДекларацияНО.Количество() > 0, СтрРезультатыПриемаДекларацияНО[0].Ссылка, "");
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
			СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаДекларацияНО.Количество() > 0;
			
			// определяем наиболее свежее сообщение с результатом обработки
			ПоследнийРезультатОбработки = Неопределено;
			Для Каждого СтрРезультатОбработки Из СтрРезультатыОбработкиДекларацияНО Цикл
				Если ПоследнийРезультатОбработки = Неопределено ИЛИ СтрРезультатОбработки.Дата > ПоследнийРезультатОбработки.Дата Тогда
					ПоследнийРезультатОбработки = СтрРезультатОбработки;
				КонецЕсли;
			КонецЦикла;
			
			// если результат обработки отрицательный, то выводим соответствующее сообщение
			Если ПоследнийРезультатОбработки <> Неопределено И ПоследнийРезультатОбработки.ПротоколСОшибкой Тогда
				
				// Сдано, требует уточнения
				СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
				СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано, требует уточнения'");
				СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано, требует уточнения'");
				СтрокаЭтапа.Дата						= Дата(1,1,1);
				СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Подготовьте и отправьте корректирующий отчет'");
				СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Уведомление об уточнении'");
				СтрокаЭтапа.Протокол					= ПоследнийРезультатОбработки.Ссылка;
				СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
				СтрокаЭтапа.ЭтапПройден					= СтрРезультатыОбработкиДекларацияНО.Количество() > 0;
				
			Иначе
				
				// Сдано
				СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
				СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
				СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
				СтрокаЭтапа.Дата						= Дата(1,1,1);
				СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = ''");
				СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Извещение о вводе'");
				СтрокаЭтапа.Протокол					= ?(СтрРезультатыОбработкиДекларацияНО.Количество() > 0, СтрРезультатыОбработкиДекларацияНО[0].Ссылка, "");
				СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
				СтрокаЭтапа.ЭтапПройден					= СтрРезультатыОбработкиДекларацияНО.Количество() > 0;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
			
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиПФР(СсылкаНаОтчет, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	// определяем последний цикл обмена по отчету
	Если ЗначениеЗаполнено(СсылкаНаОтчет) Тогда
		ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(СсылкаНаОтчет);
	Иначе
		ПоследнийЦиклОбмена = Справочники.ЦиклыОбмена.ПустаяСсылка();
	КонецЕсли;
	
	// Не отправлено
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
	СтрокаЭтапа.Дата						= Дата(1,1,1);
	СтрокаЭтапа.КомментарийКСостоянию		= "";
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
	СтрокаЭтапа.ЭтапПройден					= Истина;
	
	// если у пользователя недостаточно прав для получения сведений об отправке, то скроем панель
	Если НЕ ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	// получаем список всех не помеченных на удаление сообщений последнего цикла
	СообщенияЦикла = ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
	
	// выделяем основные типы сообщений
	СтрПервичныеСообщения 						= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР));
	СтрКвитанцииОПриеме 						= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР));
	СтрПротоколыВходногоКонтроля 				= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПротоколПФР));
	СтрПереподписанныеПротоколыВходногоКонтроля = СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР));
	СтрКритическиеОшибки			 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка));
	
	// Если статус первичного - не отправлено, тогда выходим 
	Если СтрПервичныеСообщения.Количество() > 0 И СтрПервичныеСообщения[0].Статус <> Перечисления.СтатусыПисем.Отправленное Тогда
		Возврат ТаблицаЭтаповОтправки;
	КонецЕсли;
	
	Если НеПолучатьДаты Тогда
		ДатаОтправки			= Дата(1,1,1);
		ДатаИзКвитанцииОПриеме 	= Дата(1,1,1);
	Иначе
		ДатаОтправки = ?(СтрПервичныеСообщения.Количество() > 0, СтрПервичныеСообщения[0].ДатаТранспорта, Дата(1,1,1));
		ДатаИзКвитанцииОПриеме = ?(СтрКвитанцииОПриеме.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрКвитанцииОПриеме[0].Ссылка), Дата(1,1,1)); 
	КонецЕсли;
		
	// Отправлено в ПФР
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ПФР'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ПФР'");
	СтрокаЭтапа.Дата						= ДатаОтправки;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки отчета'");
	СтрокаЭтапа.НаименованиеПротокола		= "";
	СтрокаЭтапа.Протокол					= "";
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрПервичныеСообщения.Количество() > 0;
	
	// Принято в обработку
	СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
	СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Принято в обработку'");
	СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Принято в обработку'");
	СтрокаЭтапа.Дата						= ДатаИзКвитанцииОПриеме;
	СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается результат обработки отчета'");
	СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Квитанция о доставке'");
	СтрокаЭтапа.Протокол					= ?(СтрКвитанцииОПриеме.Количество() > 0, СтрКвитанцииОПриеме[0].Ссылка, "");
	СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
	СтрокаЭтапа.ЭтапПройден					= СтрКвитанцииОПриеме.Количество() > 0;
	
	
	ПоследнийПротокол = Неопределено;
	Для Каждого СтрПротокол Из СтрПротоколыВходногоКонтроля Цикл
		Если ПоследнийПротокол = Неопределено ИЛИ СтрПротокол.Дата > ПоследнийПротокол.Дата Тогда
			ПоследнийПротокол = СтрПротокол;
		КонецЕсли;
	КонецЦикла;
	
	Если ПоследнийПротокол <> Неопределено И ПоследнийПротокол.ПротоколСОшибкой Тогда

		// Не сдано
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не сдано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Исправьте ошибки и отправьте отчет еще раз'");
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол ошибок'");
		СтрокаЭтапа.Протокол					= ПоследнийПротокол.Ссылка;
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= Истина;
		
	Иначе
		
		// сдано
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Сдано'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Протокол о сдаче'");
		СтрокаЭтапа.Протокол					= ?(СтрПротоколыВходногоКонтроля.Количество() > 0, СтрПротоколыВходногоКонтроля[0].Ссылка, "");
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
		СтрокаЭтапа.ЭтапПройден					= СтрПротоколыВходногоКонтроля.Количество() > 0;
		
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ТаблицаЭтаповОтправкиПерепискиСКонтролирующимиОрганами(Объект, НеПолучатьДаты)
	
	ТаблицаЭтаповОтправки = ЗаготовкаТаблицыЭтаповОтправки();
	
	// если сообщение входящее, то выводим дату получения
	Если Объект.Статус = Перечисления.СтатусыПисем.Полученное Тогда
		
		ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(Объект.Ссылка);
		СообщенияЦикла 		= ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено'");
		СтрокаЭтапа.Дата						= Объект.ДатаОтправки;
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= "";
		СтрокаЭтапа.Протокол					= "";
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтправленоИзКонтролирующегоОргана;
		СтрокаЭтапа.ЭтапПройден					= Истина;
		
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Получено'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Получено'");
		СтрокаЭтапа.Дата						= Объект.ДатаСообщения;
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= "";
		СтрокаЭтапа.Протокол					= "";
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПриемПодтвержден;
		СтрокаЭтапа.ЭтапПройден					= Истина;

	Иначе
		
		// Не отправлено
		СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
		СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не отправлено'");
		СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не отправлено'");
		СтрокаЭтапа.Дата						= Дата(1,1,1);
		СтрокаЭтапа.КомментарийКСостоянию		= "";
		СтрокаЭтапа.НаименованиеПротокола		= "";
		СтрокаЭтапа.Протокол					= "";
		СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНеНачат;
		СтрокаЭтапа.ЭтапПройден					= Истина;
	
		// получаем список сообщений
		ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(Объект.Ссылка);
		
		Если НЕ ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
			Возврат ТаблицаЭтаповОтправки;
		КонецЕсли;
		
		СообщенияЦикла = ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
		
		Если Объект.Тип = Перечисления.ТипыПерепискиСКонтролирующимиОрганами.ПерепискаСПФР Тогда
			
			// выделяем основные типы сообщений
			СтрПервичныеСообщения 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР));
			СтрКвитанции 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР));
			
			Если СтрПервичныеСообщения.Количество() > 0 И СтрПервичныеСообщения[0].Статус = Перечисления.СтатусыПисем.Исходящее Тогда
				Возврат ТаблицаЭтаповОтправки;
			КонецЕсли;
			
			Если НеПолучатьДаты Тогда
				ДатаОтправки 			= Дата(1,1,1);
				ДатаПолученияКвитанции 	= Дата(1,1,1);
			Иначе
				ДатаОтправки 			= ?(ЗначениеЗаполнено(Объект.ДатаСообщения) , " " + Формат(Объект.ДатаСообщения, "ДЛФ=DT"), Дата(1,1,1));
				ДатаПолученияКвитанции 	= ?(СтрКвитанции.Количество() > 0, СтрКвитанции[0].ДатаТранспорта, Дата(1,1,1));
			КонецЕсли;
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ПФР'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ПФР'");
			СтрокаЭтапа.Дата						= ДатаОтправки;
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается доставка письма в ПФР'");
			СтрокаЭтапа.НаименованиеПротокола		= "";
			СтрокаЭтапа.Протокол					= "";
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
			СтрокаЭтапа.ЭтапПройден					= СтрПервичныеСообщения.Количество() > 0;

			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Доставлено в ПФР'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Доставлено'");
			СтрокаЭтапа.Дата						= ДатаПолученияКвитанции;
			СтрокаЭтапа.КомментарийКСостоянию		= "";
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Квитанция о получении'");
			СтрокаЭтапа.Протокол					= ?(СтрКвитанции.Количество() > 0, СтрКвитанции[0].Ссылка, "");
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= СтрКвитанции.Количество() > 0;
			
		// переписка с Росстатом
		ИначеЕсли Объект.Тип = Перечисления.ТипыПерепискиСКонтролирующимиОрганами.ПерепискаСФСГС Тогда
			
			// выделяем основные типы сообщений
			СтрПервичныеСообщения 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС));
			СтрПодтвержденияДатыОтправки 			= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС));
			СтрИзвещенияПодтвержденияДатыОтправки 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС));
			СтрКвитанции 							= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС));
			
			Если СтрПервичныеСообщения.Количество() > 0 И СтрПервичныеСообщения[0].Статус = Перечисления.СтатусыПисем.Исходящее Тогда
				Возврат ТаблицаЭтаповОтправки;
			КонецЕсли;
			
			Если НеПолучатьДаты Тогда
				ДатаОтправкиПервичного 			= Дата(1,1,1);
				ДатаИзПодтвержденияДатыОтправки = Дата(1,1,1);
				ДатаПолученияКвитанции 			= Дата(1,1,1);
			Иначе
				ДатаОтправкиПервичного 			= ?(СтрПервичныеСообщения.Количество() > 0, СтрПервичныеСообщения[0].Дата, Дата(1,1,1));
				ДатаИзПодтвержденияДатыОтправки = ?(СтрПодтвержденияДатыОтправки.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияДатыОтправки[0].Ссылка), Дата(1,1,1));
				ДатаПолученияКвитанции 			= ?(СтрКвитанции.Количество() > 0, СтрКвитанции[0].ДатаТранспорта, Дата(1,1,1));
			КонецЕсли;
			
			Если ДатаИзПодтвержденияДатыОтправки <> Дата(1,1,1) И ДатаОтправкиПервичного > ДатаИзПодтвержденияДатыОтправки Тогда
				ДатаОтправкиПервичного = ДатаИзПодтвержденияДатыОтправки;
			КонецЕсли;
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
			СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается подтверждение даты отправки'");
			СтрокаЭтапа.НаименованиеПротокола		= "";
			СтрокаЭтапа.Протокол					= "";
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
			СтрокаЭтапа.ЭтапПройден					= СтрПервичныеСообщения.Количество() > 0;
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в Росстат'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в Росстат'");
			СтрокаЭтапа.Дата						= ДатаИзПодтвержденияДатыОтправки;
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается доставка письма в Росстат'");
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Подтверждение даты отправки'");
			СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияДатыОтправки.Количество() > 0, СтрПодтвержденияДатыОтправки[0].Ссылка, "");
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
			СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияДатыОтправки.Количество() > 0;
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Доставлено в Росстат'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Доставлено'");
			СтрокаЭтапа.Дата						= Дата(1,1,1);
			СтрокаЭтапа.КомментарийКСостоянию		= "";
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Извещение о получении'");
			СтрокаЭтапа.Протокол					= ?(СтрКвитанции.Количество() > 0, СтрКвитанции[0].Ссылка, "");
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
			СтрокаЭтапа.ЭтапПройден					= СтрКвитанции.Количество() > 0;
			
		Иначе // если переписка с ФНС
			
			// выделяем основные типы сообщений
			СтрОбращенияНП 					= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ОбращениеНП));
			СтрПодтвержденияОбращениеНО 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО));
			СтрИзвещенияПодтверждениеНП 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП));
			СтрИзвещенияОбращениеНО 		= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО));
			// эти статусы есть только в случае ошибки
			СтрРезультатыПриемаОбращениеНО 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО));
			СтрИзвещенияРезультатПриемаНП 	= СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП));
			
			Если СтрОбращенияНП.Количество() > 0 И СтрОбращенияНП[0].Статус = Перечисления.СтатусыПисем.Исходящее Тогда
				Возврат ТаблицаЭтаповОтправки;
			КонецЕсли;

			Если НеПолучатьДаты Тогда
				ДатаОтправкиПервичного 	= Дата(1,1,1);
				ДатаИзПодтверждения 	= Дата(1,1,1);
			Иначе
				ДатаОтправкиПервичного 	= ?(СтрОбращенияНП.Количество() > 0, СтрОбращенияНП[0].ДатаТранспорта, Дата(1,1,1));
				ДатаИзПодтверждения 	= ?(СтрПодтвержденияОбращениеНО.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрПодтвержденияОбращениеНО[0].Ссылка), Дата(1,1,1));
			КонецЕсли;
			
			Если ДатаИзПодтверждения <> Дата(1,1,1) И ДатаОтправкиПервичного > ДатаИзПодтверждения Тогда
				ДатаОтправкиПервичного = ДатаИзПодтверждения;
			КонецЕсли;
			
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено оператору'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено оператору'");
			СтрокаЭтапа.Дата						= ДатаОтправкиПервичного;
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается подтверждение даты отправки'");
			СтрокаЭтапа.НаименованиеПротокола		= "";
			СтрокаЭтапа.Протокол					= "";
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
			СтрокаЭтапа.ЭтапПройден					= СтрОбращенияНП.Количество() > 0;
					
			СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
			СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Отправлено в ФНС'");
			СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Отправлено в ФНС'");
			СтрокаЭтапа.Дата						= ДатаИзПодтверждения;
			СтрокаЭтапа.КомментарийКСостоянию		= НСтр("ru = 'Ожидается доставка письма в ФНС'");
			СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Подтверждение даты отправки'");
			СтрокаЭтапа.Протокол					= ?(СтрПодтвержденияОбращениеНО.Количество() > 0, СтрПодтвержденияОбращениеНО[0].Ссылка, Дата(1,1,1));
			СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ДокументооборотНачат;
			СтрокаЭтапа.ЭтапПройден					= СтрПодтвержденияОбращениеНО.Количество() > 0;
			
			Если СтрРезультатыПриемаОбращениеНО.Количество() <> 0 Тогда
				
				СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
				СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Не принято'");
				СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Не принято'");
				СтрокаЭтапа.Дата						= Дата(1,1,1);
				СтрокаЭтапа.КомментарийКСостоянию		= "";
				СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Уведомление об отказе'");
				СтрокаЭтапа.Протокол					= ?(СтрРезультатыПриемаОбращениеНО.Количество() > 0, СтрРезультатыПриемаОбращениеНО[0].Ссылка, Дата(1,1,1));
				СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ОтрицательныйРезультатДокументооборота;
				СтрокаЭтапа.ЭтапПройден					= СтрРезультатыПриемаОбращениеНО.Количество() > 0;

			Иначе
				
				СтрокаЭтапа = ТаблицаЭтаповОтправки.Добавить();
				СтрокаЭтапа.ТекстНадписи				= НСтр("ru = 'Доставлено в ФНС'");
				СтрокаЭтапа.ТекстСтатуса				= НСтр("ru = 'Доставлено'");
				СтрокаЭтапа.Дата						= Дата(1,1,1);
				СтрокаЭтапа.КомментарийКСостоянию		= "";
				СтрокаЭтапа.НаименованиеПротокола		= НСтр("ru = 'Извещение о получении'");
				СтрокаЭтапа.Протокол					= ?(СтрИзвещенияОбращениеНО.Количество() > 0, СтрИзвещенияОбращениеНО[0].Ссылка, Дата(1,1,1));
				СтрокаЭтапа.СостояниеСдачиОтчетности	= Перечисления.СостояниеСдачиОтчетности.ПоложительныйРезультатДокументооборота;
				СтрокаЭтапа.ЭтапПройден					= СтрИзвещенияОбращениеНО.Количество() > 0;
				
			КонецЕсли;
				
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ПолучениеДатПротоколов

Функция ДатаИзПодтвержденияДатыОтправки(Сообщение)
	
	ДатаИзПодтверждения = Дата(1,1,1);
	
	// извлекаем файл подтверждения даты отправки из содержимого сообщения
	ТипыДИВ = Новый Массив;
	ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыОтправки);
	ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыОтправкиПредставление);
	ИмяФайлаПодтверждения = "";
	СтрПодтверждения = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина, ТипыДИВ);

	Если СтрПодтверждения.Количество() = 0 Тогда
		//Подтверждение даты отправки не обнаружено среди содержимого сообщения
		Возврат ДатаИзПодтверждения;
	КонецЕсли;
	СтрПодтверждение = СтрПодтверждения[0];
	
	// записываем вложение во временный файл
	ФайлПодтверждения = ПолучитьИмяВременногоФайла("xml");
	Попытка
		СтрПодтверждение.Данные.Получить().Записать(ФайлПодтверждения);
	Исключение
		// Ошибка выгрузки подтверждения даты отправки во временный файл
		Возврат ДатаИзПодтверждения;
	КонецПопытки;
	
	// считываем подтверждение из файла в дерево XML
	ОписаниеОшибки = "";
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ФайлПодтверждения, , ОписаниеОшибки);
	УдалитьВременныйФайл(ФайлПодтверждения);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		// Ошибка чтения XML из файла подтверждения даты отправки
		Возврат ДатаИзПодтверждения;
	КонецЕсли;
	
	УзелФайл = ДеревоXML.Строки.Найти("Файл", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелФайл) Тогда
		// Некорректная структура XML подтверждения: не обнаружен узел ""Файл""
		Возврат ДатаИзПодтверждения;
	КонецЕсли;
	
	УзелДокумент = УзелФайл.Строки.Найти("Документ", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелДокумент) Тогда
		// Некорректная структура XML подтверждения: не обнаружен узел ""Документ""
		Возврат ДатаИзПодтверждения;
	КонецЕсли;
	
	// получаем сведения подтверждения
	УзелСведПодтв = УзелДокумент.Строки.Найти("СведПодтв", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелСведПодтв) Тогда
		// Некорректная структура XML подтверждения: отсутствуют сведения подтверждения
		Возврат ДатаИзПодтверждения;
	КонецЕсли;
		
	// получаем сведения о дате и времени поступившего файла
	УзелДатаОтпр = УзелСведПодтв.Строки.Найти("ДатаОтпр", "Имя");
	УзелВремяОтпр = УзелСведПодтв.Строки.Найти("ВремяОтпр", "Имя");
	
	Если ЗначениеЗаполнено(УзелДатаОтпр) Тогда
		ДатаИзПодтверждения = СокрЛП(УзелДатаОтпр.Значение);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(УзелВремяОтпр) Тогда
		ДатаИзПодтверждения = СокрЛП(ДатаИзПодтверждения + " " + СокрЛП(УзелВремяОтпр.Значение));
	КонецЕсли;
	
	Возврат ДатаИзСтрокиРазныхФорматов(ДатаИзПодтверждения);
	
КонецФункции

Функция ДатаИзИзвещенияОПолучении(Сообщение)

	ДатаВремяПолучения = Дата(1,1,1); 
	
	// извлекаем файл извещения из содержимого сообщения
	СтрИзвещения = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ИзвещениеОПолучении);
	Если СтрИзвещения.Количество() = 0 Тогда
		//Извещение о получении не обнаружено среди содержимого сообщения
		Возврат ДатаВремяПолучения;
	КонецЕсли;
	СтрИзвещение = СтрИзвещения[0];
	
	// записываем вложение во временный файл
	ФайлИзвещения = ПолучитьИмяВременногоФайла("xml");
	Попытка
		СтрИзвещение.Данные.Получить().Записать(ФайлИзвещения);
	Исключение
		// Ошибка выгрузки извещения о получении во временный файл
		Возврат ДатаВремяПолучения;
	КонецПопытки;
	
	// считываем извещение из файла в дерево XML
	ОписаниеОшибки = "";
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ФайлИзвещения, , ОписаниеОшибки);
	УдалитьВременныйФайл(ФайлИзвещения);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		// Ошибка чтения XML из файла извещения о получении
		Возврат ДатаВремяПолучения;
	КонецЕсли;
	
	// анализируем XML
	УзелФайл = ДеревоXML.Строки.Найти("Файл", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелФайл) Тогда
		// Некорректная структура XML извещения: не обнаружен узел ""Файл""
		Возврат ДатаВремяПолучения;
	КонецЕсли;
	
	УзелДокумент = УзелФайл.Строки.Найти("Документ", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелДокумент) Тогда
		// Некорректная структура XML извещения: не обнаружен узел ""Документ""
		Возврат ДатаВремяПолучения;
	КонецЕсли;
	
	УзелСвИзвещП = УзелДокумент.Строки.Найти("СвИзвещП", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелСвИзвещП) Тогда
		// Некорректная структура XML извещения: не обнаружен узел ""СвИзвещП""
		Возврат ДатаВремяПолучения;
	КонецЕсли;
	
	// получаем сведения о дате и времени поступившего файла
	УзелДатаПол = УзелСвИзвещП.Строки.Найти("ДатаПол", "Имя");
	УзелВремяПол = УзелСвИзвещП.Строки.Найти("ВремяПол", "Имя");
	Если ЗначениеЗаполнено(УзелДатаПол) Тогда
		ДатаВремяПолучения = СокрЛП(УзелДатаПол.Значение);
	КонецЕсли;
	Если ЗначениеЗаполнено(УзелВремяПол) Тогда
		ДатаВремяПолучения = СокрЛП(ДатаВремяПолучения + " " + СокрЛП(УзелВремяПол.Значение));
	КонецЕсли;
	
	Возврат ДатаИзСтрокиРазныхФорматов(ДатаВремяПолучения);

КонецФункции

Функция ДатаИзКвитанцииОПриеме(Сообщение)
	
	ДатаВремяПредст = Дата(1,1,1);

	// извлекаем файл квитанции из содержимого сообщения
	ИмяФайлаКвитанции = "";
	СтрКвитанции = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриеме, ИмяФайлаКвитанции);
	Если СтрКвитанции.Количество() = 0 Тогда
		// Квитанция о приеме не обнаружена среди содержимого сообщения
		Возврат ДатаВремяПредст;
	КонецЕсли;
	СтрКвитанция = СтрКвитанции[0];
	
	// записываем вложение во временный файл
	ФайлКвитанции = ПолучитьИмяВременногоФайла("xml");
	Попытка
		СтрКвитанция.Данные.Получить().Записать(ФайлКвитанции);
	Исключение
		// Ошибка выгрузки квитанции о приеме во временный файл
		Возврат ДатаВремяПредст;
	КонецПопытки;
	
	// считываем квитанцию из файла в дерево XML
	ОписаниеОшибки = "";
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ФайлКвитанции, , ОписаниеОшибки);
	УдалитьВременныйФайл(ФайлКвитанции);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		// Ошибка чтения XML из файла квитанции о приеме
		// Возврат ДатаВремяПредст;
	КонецЕсли;
	
	// анализируем XML
	УзелФайл = ДеревоXML.Строки.Найти("Файл", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелФайл) Тогда
		// Некорректная структура XML квитанции: не обнаружен узел ""Файл""
		Возврат ДатаВремяПредст;
	КонецЕсли;
	
	УзелДокумент = УзелФайл.Строки.Найти("Документ", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелДокумент) Тогда
		// Некорректная структура XML квитанции: не обнаружен узел ""Документ""
		Возврат ДатаВремяПредст;
	КонецЕсли;
	
	УзелСвКвит = УзелДокумент.Строки.Найти("СвКвит", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелСвКвит) Тогда
		// Некорректная структура XML квитанции: не обнаружен узел ""СвКвит""
		Возврат ДатаВремяПредст;
	КонецЕсли;
	
	// разбираем узел с общими сведениями
	ОбщиеСведения = Новый Структура;
	Для Каждого УзелОбщСвед Из УзелСвКвит.Строки Цикл
		ОбщиеСведения.Вставить(УзелОбщСвед.Имя, СокрЛП(УзелОбщСвед.Значение));
	КонецЦикла;
	
	Если ОбщиеСведения.Свойство("ДатаПредст") Тогда
		ДатаПрин = ОбщиеСведения.ДатаПрин;
	КонецЕсли;
	
	Возврат ДатаИзСтрокиРазныхФорматов(ДатаПрин);
	
КонецФункции

Функция ДатаИзКвитанцииОПриемеДокумента(Сообщение)
	
	ДатаИзКвитанции = Дата(1,1,1);
	
	// извлекаем файл документа из содержимого сообщения
	СтрДокументы = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриемеДокумент);
	Если СтрДокументы.Количество() = 0 Тогда
		// Квитанция о приеме не обнаружена среди содержимого сообщения
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	СтрДокумент = СтрДокументы[0];
	
	// записываем вложение во временный файл
	ФайлДокумента = ПолучитьИмяВременногоФайла("xml");
	Попытка
		СтрДокумент.Данные.Получить().Записать(ФайлДокумента);
	Исключение
		// Ошибка выгрузки квитанции о приеме во временный файл
		Возврат ДатаИзКвитанции;
	КонецПопытки;
	
	// считываем документ из файла в дерево XML
	ОписаниеОшибки = "";
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ФайлДокумента, , ОписаниеОшибки);
	УдалитьВременныйФайл(ФайлДокумента);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		// Ошибка чтения XML из файла
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	// анализируем XML
	УзелФайл = ДеревоXML.Строки.Найти("Файл", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелФайл) Тогда
		// Некорректная структура XML файла: не обнаружен узел ""Файл""
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	// начинаем заполнять общие сведения
	ОбщиеСведения = Новый Структура;
	Для Каждого УзелСведений Из УзелФайл.Строки Цикл
		Если Найти(УзелСведений.Имя, ":") = 0 Тогда
			ОбщиеСведения.Вставить(УзелСведений.Имя, СокрЛП(УзелСведений.Значение));
		КонецЕсли;
	КонецЦикла;
	
	УзелДокумент = УзелФайл.Строки.Найти("Документ", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелДокумент) Тогда
		// Некорректная структура XML файла: не обнаружен узел ""Документ""
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	УзелСвКвит = УзелДокумент.Строки.Найти("СвКвит", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелСвКвит) Тогда
		// Некорректная структура XML файла: не обнаружен узел ""СвКвит""
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	// продолжаем заполнять общие сведения
	Для Каждого УзелОбщСвед Из УзелСвКвит.Строки Цикл
		Если УзелОбщСвед.Имя = "ИмяПринятФайла" Тогда
		Иначе
			ОбщиеСведения.Вставить(УзелОбщСвед.Имя, СокрЛП(УзелОбщСвед.Значение));
		КонецЕсли;
	КонецЦикла;
	
	Если ОбщиеСведения.Свойство("ДатаПрин") Тогда
		ДатаПрин = ОбщиеСведения.ДатаПрин;
	КонецЕсли;

	ДатаИзКвитанции = ДатаИзСтрокиРазныхФорматов(ДатаПрин);
	Возврат ДатаИзКвитанции;

КонецФункции

Функция ДатаИзКвитанцияОПриемеЗапрос(Сообщение)

	ДатаИзКвитанции = Дата(1,1,1);
	
	// извлекаем файл квитанции из содержимого сообщения
	СтрКвитанции = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриеме);
	Если СтрКвитанции.Количество() = 0 Тогда
		// Квитанция о приеме не обнаружена среди содержимого сообщения
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	СтрКвитанция = СтрКвитанции[0];
	
	// записываем вложение во временный файл
	ФайлКвитанции = ПолучитьИмяВременногоФайла("xml");
	Попытка
		СтрКвитанция.Данные.Получить().Записать(ФайлКвитанции);
	Исключение
		// Ошибка выгрузки квитанции о приеме во временный файл
		Возврат ДатаИзКвитанции;
	КонецПопытки;
	
	// считываем квитанцию из файла в дерево XML
	ОписаниеОшибки = "";
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ФайлКвитанции, , ОписаниеОшибки);
	УдалитьВременныйФайл(ФайлКвитанции);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		// Ошибка чтения XML из файла квитанции о приеме
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	// анализируем XML
	УзелФайл = ДеревоXML.Строки.Найти("Файл", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелФайл) Тогда
		// Некорректная структура XML квитанции: не обнаружен узел ""Файл""
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	УзелДокумент = УзелФайл.Строки.Найти("Документ", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелДокумент) Тогда
		// Некорректная структура XML квитанции: не обнаружен узел ""Документ""
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	УзелСвКвит = УзелДокумент.Строки.Найти("СвКвит", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелСвКвит) Тогда
		// Некорректная структура XML квитанции: не обнаружен узел ""СвКвит""
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	// разбираем узел с общими сведениями
	ОбщиеСведения = Новый Структура;
	Для Каждого УзелОбщСвед Из УзелСвКвит.Строки Цикл
		ОбщиеСведения.Вставить(УзелОбщСвед.Имя, СокрЛП(УзелОбщСвед.Значение));
	КонецЦикла;
	
	Если ОбщиеСведения.Свойство("ДатаПрин") Тогда
		ДатаПрин = ОбщиеСведения.ДатаПрин;
	КонецЕсли;
	
	ДатаИзКвитанции = ДатаИзСтрокиРазныхФорматов(ДатаПрин);
	Возврат ДатаИзКвитанции;
	
КонецФункции

Функция ДатаИзКвитанцииОПриемеЗаявления(Сообщение)
	
	ДатаИзКвитанции = Дата(1,1,1);

	// извлекаем файл документа из содержимого сообщения
	СтрДокументы = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина, Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриемеЗаявления);
	Если СтрДокументы.Количество() = 0 Тогда
		// Квитанция о приеме не обнаружена среди содержимого сообщения
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	СтрДокумент = СтрДокументы[0];
	
	// записываем вложение во временный файл
	ФайлДокумента = ПолучитьИмяВременногоФайла("xml");
	Попытка
		СтрДокумент.Данные.Получить().Записать(ФайлДокумента);
	Исключение
		// Ошибка выгрузки квитанции о приеме во временный файл
		Возврат ДатаИзКвитанции;
	КонецПопытки;
	
	// считываем документ из файла в дерево XML
	ОписаниеОшибки = "";
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ФайлДокумента, , ОписаниеОшибки);
	УдалитьВременныйФайл(ФайлДокумента);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		// Ошибка чтения XML из файла
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	
	// анализируем XML
	УзелФайл = ДеревоXML.Строки.Найти("Файл", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелФайл) Тогда
		// Некорректная структура XML файла: не обнаружен узел ""Файл""
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	// начинаем заполнять общие сведения
	ОбщиеСведения = Новый Структура;
	Для Каждого УзелСведений Из УзелФайл.Строки Цикл
		ИмяУзла = УзелСведений.Имя;
		Если ИмяУзла = "ИдФайл" ИЛИ ИмяУзла = "ВерсПрог" ИЛИ ИмяУзла = "ВерсФорм" Тогда
			ОбщиеСведения.Вставить(УзелСведений.Имя, СокрЛП(УзелСведений.Значение));
		КонецЕсли;
	КонецЦикла;
	
	УзелДокумент = УзелФайл.Строки.Найти("Документ", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелДокумент) Тогда
		// Некорректная структура XML файла: не обнаружен узел ""Документ""
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	УзелСвКвит = УзелДокумент.Строки.Найти("СвКвит", "Имя");
	Если НЕ ЗначениеЗаполнено(УзелСвКвит) Тогда
		// Некорректная структура XML файла: не обнаружен узел ""СвКвит""
		Возврат ДатаИзКвитанции;
	КонецЕсли;
	
	// продолжаем заполнять общие сведения
	Для Каждого УзелОбщСвед Из УзелСвКвит.Строки Цикл
		Если УзелОбщСвед.Имя = "ИмяПринятФайла" Тогда
		Иначе
			ОбщиеСведения.Вставить(УзелОбщСвед.Имя, СокрЛП(УзелОбщСвед.Значение));
		КонецЕсли;
	КонецЦикла;
	
	Если ОбщиеСведения.Свойство("ДатаРег") Тогда
		ДатаРег = ОбщиеСведения.ДатаРег;
	КонецЕсли;
	
	ДатаИзКвитанции = ДатаИзСтрокиРазныхФорматов(ДатаРег);
	Возврат ДатаИзКвитанции;
	
КонецФункции

Функция ДатаИзПодтвержденияПолученияПФР(Сообщение)
	
	ДатаИзОтвета = Дата(1,1,1);
	
	ВложенияТранспортногоСообщения = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина);
	ВложениеСообщения = ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеПолученияОтчетностиПФР, "Тип");
	
	ГУИД = Новый УникальныйИдентификатор;
	ПодтверждениеПолучения = ПоместитьВоВременноеХранилище(ВложениеСообщения.Данные.Получить(), ГУИД);
		
	// считываем текст из файла уведомления
	Попытка
		ПутьКФайлу = ПолучитьИмяВременногоФайла();
		ПолучитьИзВременногоХранилища(ПодтверждениеПолучения).Записать(ПутьКФайлу);
		ЧтениеТекста = Новый ЧтениеТекста;
		ЧтениеТекста.Открыть(ПутьКФайлу);
		СтрокаXML = ЧтениеТекста.Прочитать();
		ЧтениеТекста.Закрыть();
	Исключение
		//Ошибка чтения содержимого подтверждения из файла
		Возврат ДатаИзОтвета;
	КонецПопытки;
	
	// загружаем XML из строки в дерево
	ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(СтрокаXML);
	Если ДеревоXML = Неопределено Тогда
		Возврат ДатаИзОтвета;
	КонецЕсли;
	
	// определяем дату-время получения
	УзлыДатаВремяПолучения = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "датаВремяПолучения", "Э"), Истина);
	Если УзлыДатаВремяПолучения.Количество() <> 0 Тогда
		ДатаИзОтвета = ДатаВремяИзСтрокиXML(УзлыДатаВремяПолучения[0].Значение);
	КонецЕсли;
	
	Возврат ДатаИзОтвета;
	
КонецФункции

Функция ДатаИзПодтвержденияДатыПолучения(Сообщение)
	
	ДатаИзОтвета = Дата(1,1,1);
	
	// извлекаем файл подтверждения даты получения из содержимого сообщения
	ТипыДИВ = Новый Массив;
	ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыПолучения);
	ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеОператораФСГС);
	СтрПодтверждения = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина, ТипыДИВ);
	Если СтрПодтверждения.Количество() = 0 Тогда
		// Подтверждение даты получения не обнаружено среди содержимого сообщения
		Возврат ДатаИзОтвета;
	КонецЕсли;
	СтрПодтверждение = СтрПодтверждения[0];
	
	// записываем вложение во временный файл
	ФайлПодтверждения = ПолучитьИмяВременногоФайла("xml");
	Попытка
		СтрПодтверждение.Данные.Получить().Записать(ФайлПодтверждения);
	Исключение
		//Ошибка выгрузки подтверждения даты получения во временный файл
		Возврат ДатаИзОтвета;
	КонецПопытки;
	
	// считываем подтверждение из файла в дерево XML
	ОписаниеОшибки = "";
	ДеревоXML = ЗагрузитьXMLВДеревоЗначений(ФайлПодтверждения, , ОписаниеОшибки);
	УдалитьВременныйФайл(ФайлПодтверждения);
	Если НЕ ЗначениеЗаполнено(ДеревоXML) Тогда
		//Ошибка чтения XML из файла подтверждения даты получения
		Возврат ДатаИзОтвета;
	КонецЕсли;
	
	Если СтрПодтверждение.Тип = Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеОператораФСГС Тогда
		
		УзелПодтверждениеОператора = ДеревоXML.Строки.Найти("подтверждениеОператора", "Имя");
		Если НЕ ЗначениеЗаполнено(УзелПодтверждениеОператора) Тогда
			// Некорректная структура XML подтверждения: не обнаружен узел ""ПодтверждениеОператора""
			Возврат ДатаИзОтвета;
		КонецЕсли;
		
		УзелПосылка = УзелПодтверждениеОператора.Строки.Найти("посылка", "Имя");
		Если НЕ ЗначениеЗаполнено(УзелПосылка) Тогда
			// Некорректная структура XML подтверждения: не обнаружен узел ""Посылка""
			Возврат ДатаИзОтвета;
		КонецЕсли;
		
		УзелОтправитель = УзелПосылка.Строки.Найти("отправитель", "Имя");
		Если НЕ ЗначениеЗаполнено(УзелОтправитель) Тогда
			// Некорректная структура XML подтверждения: не обнаружен узел ""Отправитель""
			Возврат ДатаИзОтвета;
		КонецЕсли;
		
		УзелДокументы = УзелПосылка.Строки.Найти("документы", "Имя");
		Если НЕ ЗначениеЗаполнено(УзелДокументы) Тогда
			// Некорректная структура XML подтверждения: не обнаружен узел ""Документы""
			Возврат ДатаИзОтвета;
		КонецЕсли;
		
		// получаем идентификаторы поступивших файлов
		ИдентификаторыДокументов = "";
		Для каждого УзелДокумент Из УзелДокументы.Строки Цикл
			ИдентификаторДокумента = УзелДокумент.Строки.Найти("идентификаторДокумента", "Имя");
			Если ЗначениеЗаполнено(ИдентификаторДокумента) Тогда
				ИдентификаторыДокументов = ИдентификаторыДокументов + ?(ПустаяСтрока(ИдентификаторыДокументов), "", ",") + СокрЛП(ИдентификаторДокумента.Значение);
			КонецЕсли;
		КонецЦикла;
		
		// извлекаем имена поступивших файлов из сообщений цикла обмена по идентификаторам
		ИмяПоступившегоФайла = "";
		Если НЕ ПустаяСтрока(ИдентификаторыДокументов) Тогда
			
			СообщенияЦиклаОбмена = ПолучитьСообщенияЦиклаОбмена(Сообщение.ЦиклОбмена).ВыгрузитьКолонку("Ссылка");
			ТипыДИВ = Новый Массив;
			ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПисьмоФСГС);
			ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПриложениеПисьмаФСГС);
			ТипыДИВ.Добавить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ФайлОтчетностиФСГС);
			ДокументыЦиклаОбмена = ПолучитьВложенияТранспортногоСообщения(СообщенияЦиклаОбмена,, ТипыДИВ);
			
			Для каждого СтрДокументЦиклаОбмена Из ДокументыЦиклаОбмена Цикл
				Если Найти(ИдентификаторыДокументов, СокрЛП(СтрДокументЦиклаОбмена.Идентификатор)) > 0 Тогда
					ИмяПоступившегоФайла = ИмяПоступившегоФайла + ?(ПустаяСтрока(ИмяПоступившегоФайла), "", ", ") + СокрЛП(СтрДокументЦиклаОбмена.ИмяФайла);
				КонецЕсли;
			КонецЦикла;
			
		КонецЕсли;
		
		// получаем сведения о дате и времени поступившего файла
		УзелДатаВремяОтправки = УзелПодтверждениеОператора.Строки.Найти("датаВремяОтправки", "Имя");
		Если ЗначениеЗаполнено(УзелДатаВремяОтправки) Тогда
			ДатаВремяОтправки = СокрЛП(XMLЗначение(Тип("Дата"), УзелДатаВремяОтправки.Значение));
			ДатаОтправки = Сокрлп(ДатаВремяОтправки);
		КонецЕсли;
		
		ДатаИзОтвета = ДатаИзСтрокиРазныхФорматов(ДатаОтправки);
	
	Иначе
		
		УзелФайл = ДеревоXML.Строки.Найти("Файл", "Имя");
		Если НЕ ЗначениеЗаполнено(УзелФайл) Тогда
			// Некорректная структура XML подтверждения: не обнаружен узел ""Файл""
			Возврат ДатаИзОтвета;
		КонецЕсли;
		
		УзелДокумент = УзелФайл.Строки.Найти("Документ", "Имя");
		Если НЕ ЗначениеЗаполнено(УзелДокумент) Тогда
			// Некорректная структура XML подтверждения: не обнаружен узел ""Документ""
			Возврат ДатаИзОтвета;
		КонецЕсли;
		
		УзелСвОтпр = УзелДокумент.Строки.Найти("СвОтпр", "Имя");
		Если НЕ ЗначениеЗаполнено(УзелСвОтпр) Тогда
			// Некорректная структура XML подтверждения: отсутствуют сведения о налоговом органе - отправителе подтверждения.
			Возврат ДатаИзОтвета;
		КонецЕсли;
		
		УзелКодНО = УзелСвОтпр.Строки.Найти("КодНО", "Имя");
		Если УзелКодНО = Неопределено Тогда
			// Некорректная структура XML подтверждения: отсутствуют сведения о налоговом органе - отправителе подтверждения
			Возврат ДатаИзОтвета;
		КонецЕсли;
		
		// получаем сведения подтверждения
		УзелСведПодтв = УзелДокумент.Строки.Найти("СведПодтв", "Имя");
		Если НЕ ЗначениеЗаполнено(УзелСведПодтв) Тогда
			// Некорректная структура XML подтверждения: отсутствуют сведения подтверждения
			Возврат ДатаИзОтвета;
		КонецЕсли;
		
		// получаем сведения об имени поступившего файла
		УзелИдФайлПол = УзелСведПодтв.Строки.Найти("ИдФайлПол", "Имя", Истина);
		Если ЗначениеЗаполнено(УзелИдФайлПол) Тогда
			ИмяПоступившегоФайла = СокрЛП(УзелИдФайлПол.Значение);
		КонецЕсли;
		
		// получаем сведения о дате и времени поступившего файла
		УзелДатаОтпр = УзелСведПодтв.Строки.Найти("ДатаОтпр", "Имя");
		УзелВремяОтпр = УзелСведПодтв.Строки.Найти("ВремяОтпр", "Имя");
		Если ЗначениеЗаполнено(УзелДатаОтпр) Тогда
			ДатаОтправки = СокрЛП(УзелДатаОтпр.Значение);
		КонецЕсли;
		Если ЗначениеЗаполнено(УзелВремяОтпр) Тогда
			ДатаОтправки = СокрЛП(ДатаОтправки + " " + СокрЛП(УзелВремяОтпр.Значение));
		КонецЕсли;
		
		ДатаИзОтвета = ДатаИзСтрокиРазныхФорматов(ДатаОтправки);
		
	КонецЕсли;
	
	Возврат ДатаИзОтвета;

КонецФункции

Функция ДатаИзПодтвержденияПолученияФСГС(Сообщение)
	
	ДатаИзОтвета = Дата(1,1,1);
	Возврат ДатаИзОтвета;
	
КонецФункции

Функция ДатаИзПодтвержденияПолученияЗапросаПФР(Сообщение)
	
	ДатаИзОтвета = Дата(1,1,1);
	
	ВложенияТранспортногоСообщения = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина);
	ВложениеСообщения = ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеПолученияЗапросПФР, "Тип");
	
	ГУИД = Новый УникальныйИдентификатор;
	ПодтверждениеПолучения = ПоместитьВоВременноеХранилище(ВложениеСообщения.Данные.Получить(), ГУИД);
		
	// считываем текст из файла уведомления
	Попытка
		ПутьКФайлу = ПолучитьИмяВременногоФайла();
		ПолучитьИзВременногоХранилища(ПодтверждениеПолучения).Записать(ПутьКФайлу);
		ЧтениеТекста = Новый ЧтениеТекста;
		ЧтениеТекста.Открыть(ПутьКФайлу);
		СтрокаXML = ЧтениеТекста.Прочитать();
		ЧтениеТекста.Закрыть();
	Исключение
		//Ошибка чтения содержимого подтверждения из файла
		Возврат ДатаИзОтвета;
	КонецПопытки;
	
	// загружаем XML из строки в дерево
	ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(СтрокаXML);
	Если ДеревоXML = Неопределено Тогда
		Возврат ДатаИзОтвета;
	КонецЕсли;
	
	// определяем дату-время получения
	УзлыДатаВремяПолучения = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "датаВремяПолучения", "Э"), Истина);
	Если УзлыДатаВремяПолучения.Количество() <> 0 Тогда
		ДатаИзОтвета = ДатаВремяИзСтрокиXML(УзлыДатаВремяПолучения[0].Значение);
	КонецЕсли;
	
	Возврат ДатаИзОтвета;
	
КонецФункции

Функция ДатаРезультатОбработкиЗапросаЕГРЮЛ_ЕГРИП(Сообщение)
	
	ДатаИзОтвета = Дата(1,1,1);
	
	ВложенияТранспортногоСообщения = ПолучитьВложенияТранспортногоСообщения(Сообщение, Истина);
	ВложениеСообщения = ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.РезультатОбработкиЗапросаНаВыпискуЕГРЮЛ_ЕГРИП, "Тип");
	
	ГУИД = Новый УникальныйИдентификатор;
	ПодтверждениеПолучения = ПоместитьВоВременноеХранилище(ВложениеСообщения.Данные.Получить(), ГУИД);
		
	// считываем текст из файла уведомления
	Попытка
		ПутьКФайлу = ПолучитьИмяВременногоФайла();
		ПолучитьИзВременногоХранилища(ПодтверждениеПолучения).Записать(ПутьКФайлу);
		ЧтениеТекста = Новый ЧтениеТекста;
		ЧтениеТекста.Открыть(ПутьКФайлу);
		СтрокаXML = ЧтениеТекста.Прочитать();
		ЧтениеТекста.Закрыть();
	Исключение
		//Ошибка чтения содержимого подтверждения из файла
		Возврат ДатаИзОтвета;
	КонецПопытки;
	
	// загружаем XML из строки в дерево
	ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(СтрокаXML);
	Если ДеревоXML = Неопределено Тогда
		Возврат ДатаИзОтвета;
	КонецЕсли;
	
	// определяем дату-время получения
	УзлыДатаВремяПолучения = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "ДатаВремяФормирования", "А"), Истина);
	Если УзлыДатаВремяПолучения.Количество() <> 0 Тогда
		ДатаИзОтвета = ДатаВремяИзСтрокиXML(УзлыДатаВремяПолучения[0].Значение);
	КонецЕсли;
	
	Возврат ДатаИзОтвета;
	
КонецФункции

Функция ДатаОтправкиОтветаИзПФР(ТранспортноеСообщение)
	
	ДатаИзОтвета = Дата(1,1,1);
	
	ВложенияТранспортногоСообщения = ПолучитьВложенияТранспортногоСообщения(ТранспортноеСообщение, Истина);
	ВложениеСообщения = ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ОтветНаЗапросПФР, "Тип");
	
	ГУИД = Новый УникальныйИдентификатор;
	ДанныеФайла = ПоместитьВоВременноеХранилище(ВложениеСообщения.Данные.Получить(), ГУИД);

	// считываем текст из файла уведомления
	Попытка
		ПутьКФайлу = ПолучитьИмяВременногоФайла();
		ПолучитьИзВременногоХранилища(ДанныеФайла).Записать(ПутьКФайлу);
		ЧтениеТекста = Новый ЧтениеТекста;
		ЧтениеТекста.Открыть(ПутьКФайлу);
		СтрокаXML = ЧтениеТекста.Прочитать();
		ЧтениеТекста.Закрыть();
	Исключение
		Возврат ДатаИзОтвета;
	КонецПопытки;
	
	// загружаем XML из строки в дерево
	ДеревоXML = ЗагрузитьСтрокуXMLВДеревоЗначений(СтрокаXML);
	Если ДеревоXML = Неопределено Тогда
		Возврат ДатаИзОтвета;
	КонецЕсли;
	
	// определяем дату-время получения
	УзлыДатаВремяОтправки = ДеревоXML.Строки.НайтиСтроки(Новый Структура("Имя, Тип", "датаВремяОтправки", "Э"), Истина);
	Если УзлыДатаВремяОтправки.Количество() > 0 Тогда
		ДатаИзОтвета = ДатаВремяИзСтрокиXML(УзлыДатаВремяОтправки[0].Значение);
	КонецЕсли;
	
	
	
	Возврат ДатаИзОтвета;
	
КонецФункции

Функция ДатаИзОтветовКонтролирующихОрганов(ТранспортноеСообщение)
	
	ДатаИзОтвета = Дата(1,1,1);
	
	ВложенияТранспортногоСообщения = ПолучитьВложенияТранспортногоСообщения(ТранспортноеСообщение);
	Если ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеПолученияОтчетностиПФР, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзПодтвержденияПолученияПФР(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПротоколПФР, "Тип") <> Неопределено Тогда
		//ПоказатьПротоколПФР(Элемент.ТекущиеДанные, Истина);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеПолученияПисьма, "Тип") <> Неопределено Тогда
		//ПоказатьПодтверждениеПолученияПисьмаПФР(Элемент.ТекущиеДанные);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеПолученияЗапросПФР, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзПодтвержденияПолученияЗапросаПФР(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыОтправки, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзПодтвержденияДатыОтправки(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриеме, "Тип") <> Неопределено Тогда
		Если ТранспортноеСообщение.Тип = Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО Тогда
			ДатаИзОтвета = ДатаИзКвитанцияОПриемеЗапрос(ТранспортноеСообщение);
		Иначе
			ДатаИзОтвета = ДатаИзКвитанцииОПриеме(ТранспортноеСообщение);
		КонецЕсли;
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ИзвещениеОВводе, "Тип") <> Неопределено Тогда
		//ПоказатьИзвещениеОВводе(ВыбраннаяСтрока, Истина);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ИзвещениеОПолучении, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзИзвещенияОПолучении(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриемеЗаявления, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзКвитанцииОПриемеЗаявления(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОПростОтметки, "Тип") <> Неопределено Тогда
		//ПоказатьСообщениеОПроставленииОтметки(ВыбраннаяСтрока, Истина);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОПроверке, "Тип") <> Неопределено Тогда
		//ПоказатьСообщениеОПроверке(ВыбраннаяСтрока, Истина);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриемеДокумент, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзКвитанцииОПриемеДокумента(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыПолучения, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзПодтвержденияДатыПолучения(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыОтправкиПредставление, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзПодтвержденияДатыОтправки(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ИзвещениеОПолученииДокументаФСГС, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзПодтвержденияПолученияФСГС(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеОператораФСГС, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаИзПодтвержденияДатыПолучения(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.РезультатОбработкиЗапросаНаВыпискуЕГРЮЛ_ЕГРИП, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаРезультатОбработкиЗапросаЕГРЮЛ_ЕГРИП(ТранспортноеСообщение);
	ИначеЕсли ВложенияТранспортногоСообщения.Найти(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ОтветНаЗапросПФР, "Тип") <> Неопределено Тогда
		ДатаИзОтвета = ДатаОтправкиОтветаИзПФР(ТранспортноеСообщение);
	КонецЕсли;
	
	Возврат ДатаИзОтвета;

КонецФункции

Функция ДатаВремяИзСтрокиXML(ЗначениеСтр)
	
	Попытка
		Возврат XMLЗначение(Тип("Дата"), ЗначениеСтр);
	Исключение
		Возврат '00010101';
	КонецПопытки;
	
КонецФункции

Функция ПолучитьРасширениеФайлаФССПоТипуОтправляемогоДокумента(ТипОтправляемогоДокумента) Экспорт
	
	Если ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.Отчет4ФСС  Тогда
		
		Возврат "ef4";
		
	ИначеЕсли ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС Тогда
		
		Возврат "esl";
		
	ИначеЕсли ТипОтправляемогоДокумента = Перечисления.ТипыОтправляемыхДокументов.Отчет4аФСС Тогда
		
		Возврат "e4a";
		
	Иначе
		
		Возврат Неопределено;
		
	КонецЕсли;

КонецФункции

Функция СведенияПоОтправляемымОбъектам(Ссылка) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Ссылка");
	Результат.Вставить("ВидКонтролирующегоОргана");
	Результат.Вставить("КодКонтролирующегоОргана");
	Результат.Вставить("ПредставлениеКонтролирующегоОргана");
	Результат.Вставить("Организация");
	Результат.Вставить("Наименование");
	Результат.Вставить("ПредставлениеПериода");
	Результат.Вставить("Дата");
	Результат.Вставить("ВариантОтчета");
	Результат.Вставить("СтраницаЖурнала");
	
	Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗаявлениеАбонентаСпецоператораСвязи") Тогда
		
		Результат.Ссылка 								= Ссылка;
		Результат.ВидКонтролирующегоОргана 				= Неопределено;
		Результат.КодКонтролирующегоОргана 				= "";
		Результат.ПредставлениеКонтролирующегоОргана	= "";
		Результат.Организация							= Ссылка.Организация;
		Результат.Наименование 							= ?(Ссылка.ТипЗаявления = Перечисления.ТипыЗаявленияАбонентаСпецоператораСвязи.Изменение,
			НСтр("ru = 'Заявление на изменение подключения к 1С-Отчетности'"), НСтр("ru = 'Заявление на подключение'"));
		Результат.ПредставлениеПериода					= "";
		Результат.Дата									= Ссылка.Дата;
		Результат.ВариантОтчета							= "-";
		Результат.СтраницаЖурнала						= Неопределено;

	Иначе
		
		Свойства = СвойстваОбъектовФормы1СОтчетность(Ссылка);
		
		// Если свойства получить не удалось, то возвращаем пустую структура
		Если Свойства = Неопределено Тогда
			Возврат Результат;
		КонецЕсли;
		
		// Ссылка
		Если Свойства.Свойство("ДокСсылка") Тогда
			Результат.Ссылка = Свойства.ДокСсылка;
		ИначеЕсли Свойства.Свойство("Ссылка") Тогда
			Результат.Ссылка = Свойства.Ссылка;
		КонецЕсли;
		
		// ВидКонтролирующегоОргана
		Если Свойства.Свойство("ВидКонтролирующегоОргана") Тогда
			Результат.ВидКонтролирующегоОргана = Свойства.ВидКонтролирующегоОргана;
		КонецЕсли;
		
		// КодКонтролирующегоОргана
		Если Свойства.Свойство("КодКонтролирующегоОргана") Тогда
			Результат.КодКонтролирующегоОргана = Свойства.КодКонтролирующегоОргана;
		КонецЕсли;
		
		// ПредставлениеКонтролирующегоОргана
		Если Свойства.Свойство("ВидКонтролирующегоОргана") И Свойства.Свойство("КодКонтролирующегоОргана") Тогда
			Результат.ПредставлениеКонтролирующегоОргана = РегламентированнаяОтчетностьВызовСервера.ПредставлениеКонтролирующегоОргана(Свойства);
		КонецЕсли;
		
		// Организация
		Если Свойства.Свойство("Организация") Тогда
			Результат.Организация = Свойства.Организация;
		КонецЕсли;
		
		// Наименование
		Если Свойства.Свойство("НаименованиеОтчета") Тогда
			Результат.Наименование = Свойства.НаименованиеОтчета;
		ИначеЕсли Свойства.Свойство("Наименование") Тогда
			Результат.Наименование = Свойства.Наименование;
		КонецЕсли;

		// ПредставлениеПериода
		Если Свойства.Свойство("ПредставлениеПериода") Тогда
			Результат.ПредставлениеПериода = Свойства.ПредставлениеПериода;
		ИначеЕсли Свойства.Свойство("ДатаНачалаОП") И Свойства.Свойство("ДатаОкончанияОП") Тогда
			Результат.ПредставлениеПериода = РегламентированнаяОтчетностьВызовСервера.ПредставлениеФинансовогоПериода(Свойства.ДатаНачалаОП, Свойства.ДатаОкончанияОП);
		КонецЕсли;
		
		// Дата
		Если Свойства.Свойство("ДатаСоздания") Тогда
			Результат.Дата = Свойства.ДатаСоздания;
		Иначе
			Результат.Дата = Дата(1,1,1);
		КонецЕсли;
		
		// ВариантОтчета
		Если Свойства.Свойство("ПредставлениеВида") Тогда
			Результат.ВариантОтчета = Свойства.ПредставлениеВида;
		Иначе
			Результат.ВариантОтчета = "";
		КонецЕсли;
		
		// СтраницаЖурнала
		Если Свойства.Свойство("СтраницаЖурнала") Тогда
			Результат.СтраницаЖурнала = Свойства.СтраницаЖурнала;
		Иначе
			Результат.СтраницаЖурнала = Перечисления.СтраницыЖурналаОтчетность.Отчеты;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ЗаписьОбъектовВРегистр

Процедура ЗаполнитьРегистрЖурналОтправокВКонтролирующиеОрганы() Экспорт
	
	ВыборкаДетальныеЗаписи = ВыборкаОбъектовНеЗаписанныхВРегистрЖурналОтправокВКонтролирующиеОрганы();
		
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Предмет = ВыборкаДетальныеЗаписи.Объект;
		Отказ 	= Ложь;
		
		Попытка
			
			// Запись в регистр
			ЭлектронныйДокументооборотСКонтролирующимиОрганами.ЗаписьОбъектовРегламентированнойОтчетности(Предмет, Отказ);
			
		Исключение
		
			ИнформацияОбОшибке = ИнформацияОбОшибке();
			
			ЗаписьЖурналаРегистрации(
				"Ошибка при заполнении регистра ЖурналОтправокВКонтролирующиеОрганы", 
				УровеньЖурналаРегистрации.Ошибка,, Предмет,
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
		КонецПопытки;

	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаписатьЗапросНаИнформационноеОбслуживаниеВРегистрЖурналОтправокВКонтролирующиеОрганы(Объект) Экспорт
	
	Свойства = СвойстваЗапросаНаИнформационноеОбслуживание(Объект);
	ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы(Свойства);
	
КонецПроцедуры

Процедура ЗаписатьЗапросНаВыпискуИзЕГРЮЛ_ЕГРИПВРегистрЖурналОтправокВКонтролирующиеОрганы(Объект) Экспорт
	
	Свойства = СвойстваЗапросаНаВыпискуИзЕГРЮЛ_ЕГРИП(Объект);
	ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы(Свойства);
	
КонецПроцедуры
	
Процедура ЗаписатьПерепискаСКонтролирующимиОрганамиВРегистрЖурналОтправокВКонтролирующиеОрганы(Объект) Экспорт

	Свойства = СвойстваПерепискиСКонтролирующими(Объект);
	ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы(Свойства);
	
КонецПроцедуры

Процедура ЗаписатьОписиИсходящихДокументовВНалоговыеОрганыВРегистрЖурналОтправокВКонтролирующиеОрганы(Объект) Экспорт

	Свойства = СвойстваОписиИсходящихДокументовВНалоговыеОрганы(Объект);
	ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы(Свойства);
	
КонецПроцедуры

Процедура ЗаписатьДокументыРеализацииПолномочийНалоговыхОргановВРегистрЖурналОтправокВКонтролирующиеОрганы(Объект) Экспорт

	Свойства = СвойстваДокументаРеализацииПолномочий(Объект);
	ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы(Свойства);
	
КонецПроцедуры

Процедура ЗаписатьОписиВходящихДокументовИзНалоговыхОргановВРегистрЖурналОтправокВКонтролирующиеОрганы(Объект) Экспорт

	Ссылка = Объект.Ссылка;
	Для каждого Строка Из Ссылка.ВходящиеДокументы Цикл
		ДокументРеализацииПолномочий = Строка.СсылкаНаОбъект;
		ЗаписатьДокументыРеализацииПолномочийНалоговыхОргановВРегистрЖурналОтправокВКонтролирующиеОрганы(ДокументРеализацииПолномочий);
	КонецЦикла; 
	
КонецПроцедуры

Процедура ЗаписатьЭлектронныеПредставленияРегламентированныхОтчетовВРегистрЖурналОтчетовСтатусы(Объект) Экспорт

	Ссылка = Объект.Ссылка;
	Свойства = СвойстваЭлектронногоПредставления(Ссылка);
	
	ЭтоЗакладкаУведомления = ЭтоЭлектронноеПредставлениеОтображаетсяВРазеделеУведомления(Ссылка);
	Если ЭтоЗакладкаУведомления Тогда
		
		ЭлектронныйДокументооборотСКонтролирующимиОрганами.СоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы(Свойства);
		
		// Удаление записи из регистра ЖурналОтчетовСтатусы
		Если СсылкаПрисутствуетВРегистреЖурналОтчетовСтатусы(Ссылка) Тогда
			НаборЗаписей = РегистрыСведений.ЖурналОтчетовСтатусы.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Ссылка.Установить(Ссылка);
			НаборЗаписей.Очистить();
			НаборЗаписей.Записать();
		КонецЕсли;
		
	Иначе
		
		РегламентированнаяОтчетностьВызовСервера.ОтразитьВЖурналеОтчетов(Свойства);
		
		// Удаление записи из регистра ЖурналОтправокВКонтролирующиеОрганы
		Если СсылкаПрисутствуетВРегистреЖурналОтправокВКонтролирующиеОрганы(Ссылка) Тогда
			НаборЗаписей = РегистрыСведений.ЖурналОтправокВКонтролирующиеОрганы.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Ссылка.Установить(Ссылка);
			НаборЗаписей.Очистить();
			НаборЗаписей.Записать();
		КонецЕсли;

	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ВспомогательныеПроцедурыИФункции

#Область СвойстваОбъектов

Функция СвойстваОбъектовФормы1СОтчетность(Источник) Экспорт
	
	Если НЕ ЗначениеЗаполнено(Источник)
		ИЛИ (НЕ Справочники.ТипВсеСсылки().СодержитТип(ТипЗнч(Источник))
			И НЕ Документы.ТипВсеСсылки().СодержитТип(ТипЗнч(Источник))) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Ссылка = Источник.Ссылка;
	Свойства = Неопределено;
	
	// Обработка объектов типов, входящих в БРО
	Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.РегламентированныйОтчет") Тогда
		Свойства = РегламентированнаяОтчетность.СвойстваРегламентированногоОтчета(Ссылка);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("СправочникСсылка.ЭлектронныеПредставленияРегламентированныхОтчетов") Тогда
		Свойства = СвойстваЭлектронногоПредставления(Ссылка);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаИнформационноеОбслуживаниеНалогоплательщика") 
		ИЛИ ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаИнформационноеОбслуживаниеСтрахователя") Тогда
		Свойства = СвойстваЗапросаНаИнформационноеОбслуживание(Ссылка);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаВыпискуИзЕГРЮЛ_ЕГРИП") Тогда
		Свойства = СвойстваЗапросаНаВыпискуИзЕГРЮЛ_ЕГРИП(Ссылка);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("СправочникСсылка.ПерепискаСКонтролирующимиОрганами") Тогда
		Свойства = СвойстваПерепискиСКонтролирующими(Ссылка);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("СправочникСсылка.ОписиИсходящихДокументовВНалоговыеОрганы") Тогда
		Свойства = СвойстваОписиИсходящихДокументовВНалоговыеОрганы(Ссылка);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("ДокументСсылка.УведомлениеОСпецрежимахНалогообложения") Тогда
		Свойства = ЭлектронныйДокументооборотСКонтролирующимиОрганами.СвойстваУведомленияОСпецрежимахНалогообложения(Ссылка);
	ИначеЕсли ТипЗнч(Ссылка) = Тип("СправочникСсылка.ДокументыРеализацииПолномочийНалоговыхОрганов") Тогда 
		Свойства = СвойстваДокументаРеализацииПолномочий(Ссылка);
	Иначе
		// Определяем, является ли этот объект объектом, не входящим в БРО
		ТаблицаОписанияОбъектовНеВходящихВБРО = РегламентированнаяОтчетность.ТаблицаОписанияОбъектовРегламентированнойОтчетности();
		СтрокаТаблицыОписания = ТаблицаОписанияОбъектовНеВходящихВБРО.Найти(ТипЗнч(Ссылка), "ТипОбъекта");
		Если СтрокаТаблицыОписания <> Неопределено Тогда
			
			РазделФормы1СОтчетность = СтрокаТаблицыОписания.ВидДокумента;
			Если РазделФормы1СОтчетность = Перечисления.СтраницыЖурналаОтчетность.Уведомления Тогда
				// Это объект закладки Уведомления
				Свойства = ЭлектронныйДокументооборотСКонтролирующимиОрганами.СвойстваПрочихУведомлений(Ссылка);
			ИначеЕсли РазделФормы1СОтчетность = Перечисления.СтраницыЖурналаОтчетность.Отчеты Тогда
				// Это объект закладки Отчеты
				Свойства = РегламентированнаяОтчетность.СвойстваПрочихОтчетов(Ссылка);
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Свойства;
	
КонецФункции

Функция СвойстваЗапросаНаИнформационноеОбслуживание(Объект) Экспорт
	
	Ссылка = Объект.Ссылка;
	
	// Наименование
	Наименование = Строка(Объект.ВидУслуги);
	
	// Вид и код контролирующего органа
	Ответы = Неопределено;
	ЭтоЗапросИОН = ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаИнформационноеОбслуживаниеНалогоплательщика");
	Если ЭтоЗапросИОН Тогда
		ВидКонтролирующегоОргана = Перечисления.ТипыКонтролирующихОрганов.ФНС;
		ПредставлениеПериода = ПредставлениеФинансовогоПериода(Объект.ДатаНачалаПериода, Объект.ДатаОкончанияПериода);
		
		Ответы = ПолучитьОтветыНаЗапросИОН(Объект.Ссылка);

	Иначе
		ВидКонтролирующегоОргана = Перечисления.ТипыКонтролирующихОрганов.ПФР;
		
		Ответы = ПолучитьОтветыНаЗапросИОС(Объект.Ссылка);
		
		ПредставлениеПериода = "";
		
		НаДату = Дата(1,1,1);
		Если Объект.ВидУслуги  = Перечисления.ВидыУслугПриИОС.СправкаОСостоянииРасчетов Тогда
			НаДату = Объект.НаДату;
		Иначе
			ПоследнийЦиклОбмена = ПолучитьПоследнийЦиклОбмена(Ссылка);
			Если ЗначениеЗаполнено(ПоследнийЦиклОбмена) Тогда
				СообщенияЦикла = ПолучитьСообщенияЦиклаОбмена(ПоследнийЦиклОбмена,,,Истина);
				СтрОтветыНаЗапросПФР = СообщенияЦикла.НайтиСтроки(Новый Структура("Тип", Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР));
				// Получаем дату отправки ответа из ПФР
				НаДату = ?(СтрОтветыНаЗапросПФР.Количество() > 0, ДатаИзОтветовКонтролирующихОрганов(СтрОтветыНаЗапросПФР[0].Ссылка), Дата(1,1,1));
			КонецЕсли;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(НаДату) Тогда
			ПредставлениеПериода = "На " + Формат(НаДату, "ДЛФ=D");
		Иначе
			ПредставлениеПериода = "";
		КонецЕсли;
		
	КонецЕсли;
	
	ЕстьОтвет = Ложь;
	Если Ответы.Количество() > 0 Тогда
		ЕстьОтвет = Истина;
	КонецЕсли;
	
	КодКонтролирующегоОргана = "";
	Получатель = Объект.Получатель;
	Если ЗначениеЗаполнено(Получатель) Тогда
		КодКонтролирующегоОргана = Получатель.Код;
	КонецЕсли;
	
	Организация = Объект.Организация;
	
	// Запись в регистр
	ЗначенияЗаполнения = ЭлектронныйДокументооборотСКонтролирующимиОрганами.ПараметрыПроцедурыСоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы();
	ЗначенияЗаполнения.Ссылка 					= Ссылка;
	ЗначенияЗаполнения.ДатаСоздания				= Ссылка.Дата;
	ЗначенияЗаполнения.Наименование 			= Наименование;
	ЗначенияЗаполнения.ПредставлениеПериода 	= ПредставлениеПериода;
	ЗначенияЗаполнения.ВидКонтролирующегоОргана = ВидКонтролирующегоОргана;
	ЗначенияЗаполнения.КодКонтролирующегоОргана = КодКонтролирующегоОргана;
	ЗначенияЗаполнения.Организация 				= Организация;
	ЗначенияЗаполнения.ЕстьОтвет 				= ЕстьОтвет;
	ЗначенияЗаполнения.СтраницаЖурнала			= Перечисления.СтраницыЖурналаОтчетность.Сверки;
	
	Возврат ЗначенияЗаполнения; 
	
КонецФункции

Функция СвойстваЭлектронногоПредставления(Объект)
	
	Ссылка = Объект.Ссылка;
	
	// Наименование
	Наименование = Строка(Ссылка.ВидОтчета);
	
	// Вид и код контролирующего органа
	ВидКонтролирующегоОргана	= Ссылка.ТипПолучателя;
	КодКонтролирующегоОргана	= "";
	
	Получатель = Ссылка.Получатель;
	Если ЗначениеЗаполнено(Получатель) Тогда
		Если ТипЗнч(Получатель) = Тип("Строка") Тогда
			КодКонтролирующегоОргана = Получатель;
		Иначе
			КодКонтролирующегоОргана = Получатель.Код;
		КонецЕсли;
	КонецЕсли;
	
	ВидОтчета = Ссылка.ВидОтчета; 
	Если ТипЗнч(ВидОтчета) = Тип("СправочникСсылка.ВидыОтправляемыхДокументов") Тогда
		ТипДокумента = ВидОтчета.ТипДокумента;
	Иначе
		ТипДокумента = Неопределено;
	КонецЕсли;
	
	// Даты
	ДатаНачала		= Дата(1,1,1);
	ДатаОкончания	= Дата(1,1,1);
	Если ТипДокумента <> Перечисления.ТипыОтправляемыхДокументов.ИсходящееУведомлениеФНС
		И ТипДокумента <> Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС Тогда
		
		ДатаНачала		= Ссылка.ДатаНачала;
		ДатаОкончания	= Ссылка.ДатаОкончания;
		
	КонецЕсли;
	
	// ПредставлениеВерсии
	ПредставлениеВерсии = Ссылка.ПредставлениеВерсии;
	Если ТипДокумента = Перечисления.ТипыОтправляемыхДокументов.ЗаявлениеОВвозеТоваров
		ИЛИ ТипДокумента = Перечисления.ТипыОтправляемыхДокументов.ПрочаяОтчетностьПФР
		ИЛИ ТипДокумента = Перечисления.ТипыОтправляемыхДокументов.КомплектОтчетностиПФР
		ИЛИ ТипДокумента = Перечисления.ТипыОтправляемыхДокументов.РеестрСведенийФСС
		ИЛИ ТипДокумента = Перечисления.ТипыОтправляемыхДокументов.ОтчетФСГС
		ИЛИ ТипДокумента = Перечисления.ТипыОтправляемыхДокументов.ИсходящееУведомлениеФНС Тогда
		ПредставлениеВерсии = "";
	КонецЕсли;
	
	ЭтоЗакладкаУведомления = ЭтоЭлектронноеПредставлениеОтображаетсяВРазеделеУведомления(Ссылка);
	Если ЭтоЗакладкаУведомления Тогда
		
		// Добавление записи в регистр ЖурналОтправокВКонтролирующиеОрганы
		ПараметрыУведомления = ЭлектронныйДокументооборотСКонтролирующимиОрганами.ПараметрыПроцедурыСоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы();
		ПараметрыУведомления.Ссылка 					= Ссылка;
		ПараметрыУведомления.Наименование 				= Наименование;
		ПараметрыУведомления.ДатаСоздания				= Ссылка.ДатаИмпорта;
		ПараметрыУведомления.ВидКонтролирующегоОргана 	= ВидКонтролирующегоОргана;
		ПараметрыУведомления.КодКонтролирующегоОргана 	= КодКонтролирующегоОргана;
		ПараметрыУведомления.Организация 				= Ссылка.Организация;
		ПараметрыУведомления.СтраницаЖурнала			= Перечисления.СтраницыЖурналаОтчетность.Уведомления;
		
		Возврат ПараметрыУведомления;

	Иначе
		
		// Добавление записи в регистр ЖурналОтчетовСтатусы
		ПараметрыОтчета = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПараметрыОтображенияВЖурналеОтчетов();
			
		ПараметрыОтчета.ДокСсылка 					= Ссылка;
		ПараметрыОтчета.НаименованиеОтчета 			= Наименование;
		ПараметрыОтчета.ДатаСоздания				= Ссылка.ДатаИмпорта;
		ПараметрыОтчета.ВидКонтролирующегоОргана 	= ВидКонтролирующегоОргана;
		ПараметрыОтчета.КодКонтролирующегоОргана 	= КодКонтролирующегоОргана;
		ПараметрыОтчета.Организация 				= Ссылка.Организация;
		ПараметрыОтчета.ДатаНачалаОП 				= ДатаНачала;
		ПараметрыОтчета.ДатаОкончанияОП 			= ДатаОкончания;
		ПараметрыОтчета.ПредставлениеВида 			= ПредставлениеВерсии;
		ПараметрыОтчета.Комментарий 				= Ссылка.Комментарий;
		
		Возврат ПараметрыОтчета;

	КонецЕсли;
	
КонецФункции

Функция СвойстваЗапросаНаВыпискуИзЕГРЮЛ_ЕГРИП(Объект) Экспорт
	
	Ссылка = Объект.Ссылка;
	
	// Наименование вида "Выписка по ИНН 980000000000, Иванов Иван"
	Наименование =НСтр("ru = 'Выписка по %1 %2%3%4'");
	Если Ссылка.ВидПараметраЗапроса = Перечисления.ВидыПараметровЗапросаНаВыпискуИзЕГРЮЛ_ЕГРИП.ИНН Тогда
		Наименование = СтрЗаменить(Наименование, "%1", "ИНН");
	ИначеЕсли Ссылка.ВидПараметраЗапроса = Перечисления.ВидыПараметровЗапросаНаВыпискуИзЕГРЮЛ_ЕГРИП.ОГРН Тогда
		Наименование = СтрЗаменить(Наименование, "%1", "ОГРН");
	Иначе
		Наименование = НСтр("ru = 'Выписка из ЕГРЮЛ/ЕГРИП'");
	КонецЕсли;
	Наименование = СтрЗаменить(Наименование, "%2", Строка(Ссылка.ПараметрЗапроса));
	
	Если ЗначениеЗаполнено(Ссылка.Контрагент) Тогда
		Наименование = СтрЗаменить(Наименование, "%3", ", ");
		Наименование = СтрЗаменить(Наименование, "%4", Ссылка.Контрагент.Наименование);
	Иначе
		Наименование = СтрЗаменить(Наименование, "%3", "");
		Наименование = СтрЗаменить(Наименование, "%4", "");
	КонецЕсли;
	
	// Вид и код контролирующего органа
	ВидКонтролирующегоОргана	= Неопределено;
	КодКонтролирующегоОргана	= Неопределено;

	// Ответы
	ЕстьОтвет = ЕстьОтветНаЗапросыВыпискиИзЕГРЮЛ_ЕГРИП(Ссылка);

	Организация = Ссылка.Организация;
	
	// Запись в регистр
	ЗначенияЗаполнения = ЭлектронныйДокументооборотСКонтролирующимиОрганами.ПараметрыПроцедурыСоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы();
	ЗначенияЗаполнения.Ссылка 					= Ссылка;
	ЗначенияЗаполнения.ДатаСоздания				= Ссылка.Дата;
	ЗначенияЗаполнения.Наименование 			= Наименование;
	ЗначенияЗаполнения.ВидКонтролирующегоОргана = ВидКонтролирующегоОргана;
	ЗначенияЗаполнения.КодКонтролирующегоОргана = КодКонтролирующегоОргана;
	ЗначенияЗаполнения.Организация 				= Организация;
	ЗначенияЗаполнения.ЕстьОтвет 				= ЕстьОтвет;
	ЗначенияЗаполнения.СтраницаЖурнала			= Перечисления.СтраницыЖурналаОтчетность.ЕГРЮЛ;
	
	Возврат ЗначенияЗаполнения;
	
КонецФункции

Функция СвойстваПерепискиСКонтролирующими(Объект) Экспорт

	Ссылка = Объект.Ссылка;
	
	// Наименование
	Наименование = Объект.Наименование;
	
	// Вид и код контролирующего органа
	ЭтоИсходящаяПереписка =	Объект.Статус <> Перечисления.СтатусыПисем.Полученное;
	
	ДанныеКонтролирующегоОргана = ВидИКодКонтролирующегоОрганаДляПерепискиСКонтролирующимиОрганами(Ссылка);
	
	ВидКонтролирующегоОргана	= ДанныеКонтролирующегоОргана.Вид;
	КодКонтролирующегоОргана	= ДанныеКонтролирующегоОргана.Код;
	
	Организация = Объект.Организация;
	
	// Запись в регистр
	ЗначенияЗаполнения = ЭлектронныйДокументооборотСКонтролирующимиОрганами.ПараметрыПроцедурыСоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы();
	ЗначенияЗаполнения.Ссылка 					= Объект;
	ЗначенияЗаполнения.Наименование 			= Наименование;
	ЗначенияЗаполнения.ВидКонтролирующегоОргана = ВидКонтролирующегоОргана;
	ЗначенияЗаполнения.КодКонтролирующегоОргана = КодКонтролирующегоОргана;
	ЗначенияЗаполнения.Организация 				= Организация;
	Если ЭтоИсходящаяПереписка Тогда
		ЗначенияЗаполнения.СтраницаЖурнала			= Перечисления.СтраницыЖурналаОтчетность.Письма;
		ЗначенияЗаполнения.ДатаСоздания				= Объект.ДатаСообщения;
	Иначе
		ЗначенияЗаполнения.СтраницаЖурнала			= Перечисления.СтраницыЖурналаОтчетность.Входящие;
		ЗначенияЗаполнения.ДатаСоздания				= Объект.ДатаОтправки;
	КонецЕсли;
	
	Возврат ЗначенияЗаполнения;
	
КонецФункции

Функция СвойстваОписиИсходящихДокументовВНалоговыеОрганы(Объект) Экспорт

	Ссылка = Объект.Ссылка;
	
	// Наименование
	Требование = Объект.Требование;
	Наименование = НСтр("ru = 'Ответ на требование'");
	Если ЗначениеЗаполнено(Требование) Тогда
		Наименование = Наименование + " " + Строка(Требование.НомерДокумента) + " от " + Формат(Требование.ДатаДокумента, "ДЛФ=D");
	КонецЕсли;
	
	// Вид и код контролирующего органа
	ВидКонтролирующегоОргана	= Перечисления.ТипыКонтролирующихОрганов.ФНС;
	Если ЗначениеЗаполнено(Объект.НалоговыйОрган) Тогда
		КодКонтролирующегоОргана	= Объект.НалоговыйОрган.Код;
	Иначе
		КодКонтролирующегоОргана	= "";
	КонецЕсли;
	
	Организация = Объект.Организация;
	
	// Запись в регистр
	ЗначенияЗаполнения = ЭлектронныйДокументооборотСКонтролирующимиОрганами.ПараметрыПроцедурыСоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы();
	ЗначенияЗаполнения.Ссылка 					= Ссылка;
	ЗначенияЗаполнения.ДатаСоздания				= Ссылка.ДатаСоздания;
	ЗначенияЗаполнения.Наименование 			= Наименование;
	ЗначенияЗаполнения.ВидКонтролирующегоОргана = ВидКонтролирующегоОргана;
	ЗначенияЗаполнения.КодКонтролирующегоОргана = КодКонтролирующегоОргана;
	ЗначенияЗаполнения.Организация 				= Организация;
	ЗначенияЗаполнения.СтраницаЖурнала			= Перечисления.СтраницыЖурналаОтчетность.Письма;
	
	Возврат ЗначенияЗаполнения;
	
КонецФункции

Функция СвойстваДокументаРеализацииПолномочий(Объект) Экспорт

	Ссылка = Объект.Ссылка;
	
	// Наименование
	Наименование = Строка(Ссылка.ВидДокумента);
	
	// Вид и код контролирующего органа
	ВидКонтролирующегоОргана	= Перечисления.ТипыКонтролирующихОрганов.ФНС;
	Если ЗначениеЗаполнено(Объект.НалоговыйОрган) Тогда
		КодКонтролирующегоОргана	= Объект.НалоговыйОрган.Код;
	Иначе
		КодКонтролирующегоОргана	= "";
	КонецЕсли;
	
	Организация = Объект.Организация;
	
	// Ответы
	Результат 			= ПолучитьКоличествоОтветовНаТребования(Ссылка);
	КоличествоОтветов 	= Результат.Получить(Ссылка);
	
	// Запись в регистр
	ЗначенияЗаполнения = ЭлектронныйДокументооборотСКонтролирующимиОрганами.ПараметрыПроцедурыСоздатьЗаписьВРегистреЖурналОтправокВКонтролирующиеОрганы();
	ЗначенияЗаполнения.Ссылка 					= Ссылка;
	ЗначенияЗаполнения.ДатаСоздания				= Ссылка.ДатаДокумента;
	ЗначенияЗаполнения.Наименование 			= Наименование;
	ЗначенияЗаполнения.ВидКонтролирующегоОргана = ВидКонтролирующегоОргана;
	ЗначенияЗаполнения.КодКонтролирующегоОргана = КодКонтролирующегоОргана;
	ЗначенияЗаполнения.Организация 				= Организация;
	ЗначенияЗаполнения.СтраницаЖурнала			= Перечисления.СтраницыЖурналаОтчетность.Входящие;
	ЗначенияЗаполнения.ЕстьОтвет				= КоличествоОтветов;
	
	Возврат ЗначенияЗаполнения;
	
КонецФункции

#КонецОбласти

Функция ЭтоЭлектронноеПредставлениеОтображаетсяВРазеделеУведомления(Ссылка)
	
	ВидОтчета 				= Ссылка.ВидОтчета;
	ЭтоЗакладкаУведомления 	= Ложь;
	
	ВидыОтчетовРазделаУведомления = ЭлектронныйДокументооборотСКонтролирующимиОрганами.ВидыЭлектронныхПредставленийВРазделеУведомления();
	
	Если ВидыОтчетовРазделаУведомления.Найти(ВидОтчета) <> Неопределено Тогда
		ЭтоЗакладкаУведомления = Истина;
	КонецЕсли;
	
	Возврат ЭтоЗакладкаУведомления;
	
КонецФункции

Функция ПредставлениеФинансовогоПериода(Знач ДатаНачалаОП, Знач ДатаОкончанияОП) Экспорт
	
	ДатаНачала 		= НачалоДня(Мин(ДатаНачалаОП, ДатаОкончанияОП)); 
	ДатаОкончания 	= КонецДня(Макс(ДатаНачалаОП, ДатаОкончанияОП)); 

	ПредставлениеФинПериода = ПредставлениеПериода(ДатаНачала, ДатаОкончания, "Л=ru_RU; ФП=Истина");
	
	Если НачалоДня(ДатаНачала) = НачалоМесяца(ДатаНачала)
		И КонецДня(ДатаОкончания) = КонецМесяца(ДатаОкончания) Тогда
		
		Если ЗначениеЗаполнено(ДатаОкончания) Тогда
			ПредставлениеФинПериодаГод = ПредставлениеПериода(НачалоГода(ДатаОкончания), КонецГода(ДатаОкончания), "ФП=Истина");
			ПредставлениеФинПериода = СтрЗаменить(СтрЗаменить(ПредставлениеФинПериода, ПредставлениеФинПериодаГод, ""), "  ", " ")
				+ ПредставлениеФинПериодаГод;
		КонецЕсли;
			
	КонецЕсли;
		
	Возврат ПредставлениеФинПериода;
	
КонецФункции

Функция ТипКонтролирующегоОргана(Знач КонтролирующийОрган = "ФНС") Экспорт
	
	Результат = КонтролирующийОрган;
	
	// Определяем контролирующий орган
	Если ТипЗнч(КонтролирующийОрган) = Тип("Строка") Тогда
		// Получаем из перечисления
		Результат = Перечисления.ТипыКонтролирующихОрганов[КонтролирующийОрган];
	КонецЕсли;
	
	Возврат Результат;
		
КонецФункции

Функция ЕстьОтветНаЗапросыВыпискиИзЕГРЮЛ_ЕГРИП(Ссылка) Экспорт
	
	КонтекстЭДОСервер = ДокументооборотСКОВызовСервера.ПолучитьОбработкуЭДО();
	
	ЕстьОтвет = Ложь;
	
	Если КонтекстЭДОСервер <> Неопределено Тогда
		Ответы = КонтекстЭДОСервер.ПолучитьОтветыНаЗапросыВыпискиИзЕГРЮЛ_ЕГРИП(Ссылка);
		Если Ответы.Количество() > 0 Тогда
			
			ОбщийРазмер = 0;
			Для каждого Ответ Из Ответы Цикл
				ОбщийРазмер = ОбщийРазмер + Ответ.Размер;
			КонецЦикла; 
			
			Если ОбщийРазмер <> 0 Тогда 
				ЕстьОтвет = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ЕстьОтвет;
	
КонецФункции

Функция ВидИКодКонтролирующегоОрганаДляПерепискиСКонтролирующимиОрганами(Ссылка)
	
	// Вид и код контролирующего органа
	ЭтоИсходящаяПереписка =	Ссылка.Статус <> Перечисления.СтатусыПисем.Полученное;
	
	Если ЭтоИсходящаяПереписка Тогда
		КонтролирующийОрган = Ссылка.Получатель;
	Иначе
		КонтролирующийОрган = Ссылка.Отправитель;
	КонецЕсли;

	Результат = Новый Структура("Вид, Код");
	
	Если ЗначениеЗаполнено(КонтролирующийОрган) Тогда
		
		// Код
		Результат.Код = КонтролирующийОрган.Код;
		
		// Вид
		Если Ссылка.Тип = Перечисления.ТипыПерепискиСКонтролирующимиОрганами.ПерепискаСФНС Тогда
			Результат.Вид = Перечисления.ТипыКонтролирующихОрганов.ФНС;
		ИначеЕсли Ссылка.Тип = Перечисления.ТипыПерепискиСКонтролирующимиОрганами.ПерепискаСПФР Тогда
			Результат.Вид = Перечисления.ТипыКонтролирующихОрганов.ПФР;
		ИначеЕсли Ссылка.Тип = Перечисления.ТипыПерепискиСКонтролирующимиОрганами.ПерепискаСФСГС Тогда
			Результат.Вид = Перечисления.ТипыКонтролирующихОрганов.ФСГС;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ПротоколыДляПечати(ПечатаемыеЦиклыОбмена = Неопределено, ПечатаемыеТранспортныеСообщения = Неопределено) Экспорт
	
	Если ТипЗнч(ПечатаемыеЦиклыОбмена) <> Тип("Массив") Тогда
		ЦиклыОбмена = Новый Массив;
		ЦиклыОбмена.Добавить(ПечатаемыеЦиклыОбмена);
	Иначе
		ЦиклыОбмена = ПечатаемыеЦиклыОбмена;
	КонецЕсли;
	
	Если ЦиклыОбмена.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если ТипЗнч(ПечатаемыеТранспортныеСообщения) <> Тип("Массив") И ПечатаемыеТранспортныеСообщения <> Неопределено Тогда
		ТранспортныеСообщения = Новый Массив;
		ТранспортныеСообщения.Добавить(ПечатаемыеТранспортныеСообщения);
	Иначе
		ТранспортныеСообщения = ПечатаемыеТранспортныеСообщения;
	КонецЕсли;
	
	РезультатНастройки = Неопределено;
	
	Если ЦиклыОбмена[0].ФорматДокументооборота = Перечисления.ФорматыДокументооборотаСФНС.Приказ534 Тогда
		
		РезультатНастройки = Новый Структура("ПечататьДокумент, ПечататьПодтверждениеДатыОтправки, ПечататьРезультатПриема, ПечататьРезультатОбработки, ПечататьСообщениеОбОтзыве, ПечататьСообщениеОНесоответствиях",
			Ложь, Ложь, Ложь, Ложь, Ложь, Ложь);
							 
		СоответствиеТиповСодержимогоПротоколам = Новый Соответствие;
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ФайлОтчетности, 				"ПечататьДокумент");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Заявление, 						"ПечататьДокумент");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Форма2НДФЛ, 					"ПечататьДокумент");
		
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыОтправки, 				"ПечататьПодтверждениеДатыОтправки");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеДатыОтправкиПредставление, "ПечататьПодтверждениеДатыОтправки");
		
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриеме, 				"ПечататьРезультатПриема");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.КвитанцияОПриемеЗаявления, 		"ПечататьРезультатПриема");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбОтказеДокумент, 	"ПечататьРезультатПриема");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбОтказе, 			"ПечататьРезультатПриема");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Реестр2НДФЛ, 					"ПечататьРезультатПриема");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Протокол2НДФЛ, 					"ПечататьРезультатПриема");
		
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ИзвещениеОВводе, 				"ПечататьРезультатОбработки");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбУточнении, 		"ПечататьРезультатОбработки");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОПростОтметки,			"ПечататьРезультатОбработки");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбОтказеОтметки,		"ПечататьРезультатОбработки");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОПроверке, 			"ПечататьРезультатОбработки");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОПростОтметки, 		"ПечататьРезультатОбработки");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбОтказеОтметки, 	"ПечататьРезультатОбработки");
		
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОбОтзывеЗаявления, 	"ПечататьСообщениеОбОтзыве");

		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.СообщениеОНесоответствиях, 		"ПечататьСообщениеОНесоответствиях");
		
		Запрос = Новый Запрос();
		
		Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		                      |	КОЛИЧЕСТВО(ИСТИНА) КАК ЧислоДокументовТипа,
		                      |	СодержимоеТранспортныхКонтейнеров.Тип
		                      |ИЗ
		                      |	РегистрСведений.СодержимоеТранспортныхКонтейнеров КАК СодержимоеТранспортныхКонтейнеров
		                      |ГДЕ ";
		Если ЦиклыОбмена <> Неопределено Тогда 
			Запрос.Текст = Запрос.Текст + 
							  "СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.ЦиклОбмена В(&ЦиклОбмена) И ";
			Запрос.УстановитьПараметр("ЦиклОбмена", ЦиклыОбмена);
		КонецЕсли;
							  
		Если ТранспортныеСообщения <> Неопределено Тогда 
			Запрос.Текст = Запрос.Текст + 
							  "СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение В(&ТраснпортныеСообщения) И ";
			Запрос.УстановитьПараметр("ТраснпортныеСообщения", ТранспортныеСообщения);
		КонецЕсли;
		
		Запрос.Текст = Запрос.Текст + 
							  "	СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.Тип В(&Тип)
		                      |
		                      |СГРУППИРОВАТЬ ПО
		                      |	СодержимоеТранспортныхКонтейнеров.Тип";
		
		ВозможныеТипыСообщений = Новый Массив;
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ДекларацияНП);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО);
		
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО);
		
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО);
		
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО);
		
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО);
		
		Запрос.УстановитьПараметр("Тип", ВозможныеТипыСообщений);
		
		
	Иначе
		
		РезультатНастройки = Новый Структура("ПечататьДокумент,	ПечататьПодтверждениеОтправки,	ПечататьИзвещениеОбОтказеПФР,	ПечататьПротокол,	ПечататьУведомлениеОбУточнении,	ПечататьПротоколПриема2НДФЛ,	ПечататьРеестрСведений2НДФЛ",
						Ложь, Ложь,	Ложь, Ложь, Ложь, Ложь, Ложь);

		СоответствиеТиповСодержимогоПротоколам = Новый Соответствие;
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ФайлОтчетности, 		 				"ПечататьДокумент");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ФайлОтчетностиПФР, 						"ПечататьДокумент");
		
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеОбОтправке, 				"ПечататьПодтверждениеОтправки");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеПолученияОтчетностиПФР, 	"ПечататьИзвещениеОбОтказеПФР");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПротоколВходногоКонтроля, 				"ПечататьПротокол");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПротоколПФР, 							"ПечататьПротокол");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.Реестр2НДФЛ, 							"ПечататьРеестрСведений2НДФЛ");
		
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ФайлОтчетностиФСГС, 					"ПечататьДокумент");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.ПодтверждениеОператораФСГС, 			"ПечататьПодтверждениеОтправки");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОПриемеВОбработкуОтчетаФСГС, "ПечататьПротокол");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОНесоответствииФорматуОтчетаФСГС, "ПечататьПротокол");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбУточненииОтчетаФСГС, 		"ПечататьПротокол");
		СоответствиеТиповСодержимогоПротоколам.Вставить(Перечисления.ТипыСодержимогоТранспортногоКонтейнера.УведомлениеОбОтказеОтчетаФСГС, 			"ПечататьПротокол");
		
		Запрос = Новый Запрос();
		
		Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		                      |	КОЛИЧЕСТВО(ИСТИНА) КАК ЧислоДокументовТипа,
		                      |	СодержимоеТранспортныхКонтейнеров.Тип
		                      |ИЗ
		                      |	РегистрСведений.СодержимоеТранспортныхКонтейнеров КАК СодержимоеТранспортныхКонтейнеров
		                      |ГДЕ ";
		Если ЦиклыОбмена <> Неопределено Тогда 
			Запрос.Текст = Запрос.Текст + 
							  "СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.ЦиклОбмена В(&ЦиклОбмена) И ";
			Запрос.УстановитьПараметр("ЦиклОбмена", ЦиклыОбмена);
		КонецЕсли;
							  
		Если ТранспортныеСообщения <> Неопределено Тогда 
			Запрос.Текст = Запрос.Текст + 
							  "СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение В(&ТраснпортныеСообщения) И ";
			Запрос.УстановитьПараметр("ТраснпортныеСообщения", ТранспортныеСообщения);
		КонецЕсли;
		
		Запрос.Текст = Запрос.Текст + 
							  "	СодержимоеТранспортныхКонтейнеров.ТранспортноеСообщение.Тип В(&Тип)
		                      |
		                      |СГРУППИРОВАТЬ ПО
		                      |	СодержимоеТранспортныхКонтейнеров.Тип";
									  
		ВозможныеТипыСообщений = Новый Массив;
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПротоколПФР);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС);
		ВозможныеТипыСообщений.Добавить(Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС);
		Запрос.УстановитьПараметр("Тип", ВозможныеТипыСообщений);
		Запрос.УстановитьПараметр("ЦиклОбмена", ЦиклыОбмена);
		
	КонецЕсли;
	
	// Не печатаем сам документ
	Если РезультатНастройки <> Неопределено Тогда 
		
		// Определяем, какие протоколы возможно напечатать
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			
			ВыбранныйПротокол = СоответствиеТиповСодержимогоПротоколам[Выборка.Тип];
			Если ВыбранныйПротокол = Неопределено Тогда
				Продолжить;
			Иначе
				РезультатНастройки[ВыбранныйПротокол] = Истина;
			КонецЕсли;
			
		КонецЦикла;

		РезультатНастройки.ПечататьДокумент = Ложь;
	КонецЕсли;
	
	Возврат РезультатНастройки;
	
КонецФункции

Функция ЗаготовкаТаблицыЭтаповОтправки()
	
	ТаблицаЭтаповОтправки = Новый ТаблицаЗначений;
	ТаблицаЭтаповОтправки.Колонки.Добавить("ТекстНадписи", 				Новый ОписаниеТипов("Строка"));
	ТаблицаЭтаповОтправки.Колонки.Добавить("ТекстСтатуса", 				Новый ОписаниеТипов("Строка"));
	ТаблицаЭтаповОтправки.Колонки.Добавить("Дата" 						);
	ТаблицаЭтаповОтправки.Колонки.Добавить("КомментарийКСостоянию", 	Новый ОписаниеТипов("Строка"));
	ТаблицаЭтаповОтправки.Колонки.Добавить("НаименованиеПротокола", 	Новый ОписаниеТипов("Строка"));
	ТаблицаЭтаповОтправки.Колонки.Добавить("Протокол");
	ТаблицаЭтаповОтправки.Колонки.Добавить("СостояниеСдачиОтчетности", 	Новый ОписаниеТипов("ПеречислениеСсылка.СостояниеСдачиОтчетности"));
	ТаблицаЭтаповОтправки.Колонки.Добавить("ЭтапПройден", 				Новый ОписаниеТипов("Булево"));
	
	Возврат ТаблицаЭтаповОтправки;
	
КонецФункции

Функция ВыборкаОбъектовНеЗаписанныхВРегистрЖурналОтправокВКонтролирующиеОрганы()
	
	МассивТипов = Новый Массив;
	МассивТипов.Добавить(Тип("СправочникСсылка.ДокументыРеализацииПолномочийНалоговыхОрганов"));
	МассивТипов.Добавить(Тип("ДокументСсылка.ЗапросНаИнформационноеОбслуживаниеСтрахователя"));
	МассивТипов.Добавить(Тип("ДокументСсылка.ЗапросНаВыпискуИзЕГРЮЛ_ЕГРИП"));
	МассивТипов.Добавить(Тип("СправочникСсылка.ОписиИсходящихДокументовВНалоговыеОрганы"));
	МассивТипов.Добавить(Тип("СправочникСсылка.ПерепискаСКонтролирующимиОрганами"));
	МассивТипов.Добавить(Тип("ДокументСсылка.ЗапросНаИнформационноеОбслуживаниеНалогоплательщика"));
	МассивТипов.Добавить(Тип("ДокументСсылка.УведомлениеОСпецрежимахНалогообложения"));
	МассивТипов.Добавить(Тип("СправочникСсылка.ЭлектронныеПредставленияРегламентированныхОтчетов"));
	
	// Дополняем таблицу типов объектами, не входящими в БРО
	ТаблицаОписанияОбъектовНеВходящихВБРО 	= РегламентированнаяОтчетность.ТаблицаОписанияОбъектовРегламентированнойОтчетности();
	ОписанияОбъектовНеВходящихВБРО = ТаблицаОписанияОбъектовНеВходящихВБРО.НайтиСтроки(
		Новый Структура("ВидДокумента", Перечисления.СтраницыЖурналаОтчетность.Уведомления));
	
	Для каждого Описание Из ОписанияОбъектовНеВходящихВБРО Цикл
		МассивТипов.Добавить(Описание.ТипОбъекта);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "";
	
	// Составляем запрос
	КоличествоТипов = МассивТипов.Количество();
	ИндексЭлемента = 0;
	Для каждого ТипОбъекта Из МассивТипов Цикл
		
		ОбъектМетаданных 	= Метаданные.НайтиПоТипу(ТипОбъекта);
		
		Если ОбъектМетаданных <> Неопределено Тогда
		
			ПолноеИмяТипа 		= ОбъектМетаданных.ПолноеИмя();
			ИмяТипа 			= ОбъектМетаданных.Имя;
			
			// Формируем основную часть запроса
			Запрос.Текст = Запрос.Текст + "ВЫБРАТЬ
				|	%1.Ссылка КАК Объект
				|ИЗ
				|	%2 КАК %1
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЖурналОтправокВКонтролирующиеОрганы КАК ЖурналОтправокВКонтролирующиеОрганы
				|		ПО (ЖурналОтправокВКонтролирующиеОрганы.Ссылка = %1.Ссылка)
				|ГДЕ
				|	ЖурналОтправокВКонтролирующиеОрганы.Ссылка Есть NULL";
				
			// Берем не все электронные представление, а только относящиеся к уведомлениям
			Если ТипОбъекта = Тип("СправочникСсылка.ЭлектронныеПредставленияРегламентированныхОтчетов") Тогда
				Запрос.Текст = Запрос.Текст + "
					|И (%1.ВидОтчета В (&ВидыОтчетовРазделаУведомления))";
					
				ВидыОтчетовРазделаУведомления = ЭлектронныйДокументооборотСКонтролирующимиОрганами.ВидыЭлектронныхПредставленийВРазделеУведомления();
				Запрос.УстановитьПараметр("ВидыОтчетовРазделаУведомления", ВидыОтчетовРазделаУведомления);
			КонецЕсли;
				
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "%1", ИмяТипа);
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "%2", ПолноеИмяТипа);
				
			// Добавляем объединение между запросами
			Если ИндексЭлемента <> КоличествоТипов - 1 Тогда
				  Запрос.Текст = Запрос.Текст + "
				  |
				  |ОБЪЕДИНИТЬ ВСЕ
				  |
				  |";
				  
			КонецЕсли;
			
		КонецЕсли;
		
		ИндексЭлемента = ИндексЭлемента + 1;
		
	КонецЦикла;
	
	// Выполнение полученного запроса
	РезультатЗапроса = Запрос.Выполнить().Выбрать();
	Возврат РезультатЗапроса;
	
КонецФункции

Функция КоличествоОбъектовНеЗаписанныхВРегистрЖурналОтправокВКонтролирующиеОрганы() Экспорт
	
	ВыборкаОбъектовНеЗаписанныхВРегистр	= ВыборкаОбъектовНеЗаписанныхВРегистрЖурналОтправокВКонтролирующиеОрганы();
	КоличествоОбъектов					= ВыборкаОбъектовНеЗаписанныхВРегистр.Количество();
	
	Возврат  КоличествоОбъектов;
	
КонецФункции

Функция СкрыватьПанельОтправки(Ссылка, Организация, КонтролирующийОрган) Экспорт 

	СкрыватьПанель = Ложь;
	
	Если ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаВыпискуИзЕГРЮЛ_ЕГРИП")
		ИЛИ ТипЗнч(Ссылка) = Тип("СправочникСсылка.ДокументыРеализацииПолномочийНалоговыхОрганов")
		ИЛИ ТипЗнч(Ссылка) = Тип("СправочникСсылка.ПерепискаСКонтролирующимиОрганами")
		ИЛИ ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаИнформационноеОбслуживаниеНалогоплательщика")
		ИЛИ ТипЗнч(Ссылка) = Тип("СправочникСсылка.ОписиВходящихДокументовИзНалоговыхОрганов")
		ИЛИ ТипЗнч(Ссылка) = Тип("СправочникСсылка.ОписиИсходящихДокументовВНалоговыеОрганы")
		ИЛИ ТипЗнч(Ссылка) = Тип("ДокументСсылка.ЗапросНаИнформационноеОбслуживаниеСтрахователя")
		ИЛИ ТипЗнч(Ссылка) = Тип("СправочникСсылка.ЭлектронныеПредставленияРегламентированныхОтчетов") Тогда
		СкрыватьПанель = Ложь;
	Иначе

		Попытка
		
			Если Организация <> Неопределено И ТипЗнч(Организация) = Тип("СправочникСсылка.Организации") Тогда
			
				КонтекстЭДОСервер = ДокументооборотСКОВызовСервера.ПолучитьОбработкуЭДО();
				
				Если КонтролирующийОрган = "ФСС" Тогда
					СкрыватьПанель = НЕ КонтекстЭДОСервер.ОрганизацияИспользуетОбменСФСС(Организация);
				ИначеЕсли КонтролирующийОрган = "ФСРАР" Тогда
					СкрыватьПанель = НЕ КонтекстЭДОСервер.НастройкиФСРАР(Организация).ИспользоватьОбмен;
				ИначеЕсли КонтролирующийОрган = "РПН" Тогда
					СкрыватьПанель = Ложь;
				Иначе
					
					УчетнаяЗаписьПредназначенаДляДокументооборотаСКО = Ложь;
					СвойстваОрганизации = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Организация,	"ВидОбменаСКонтролирующимиОрганами, УчетнаяЗаписьОбмена");
					
					УчетнаяЗаписьДокументооборота = СвойстваОрганизации.УчетнаяЗаписьОбмена;
					Если СвойстваОрганизации.ВидОбменаСКонтролирующимиОрганами = ПредопределенноеЗначение("Перечисление.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате")
					И ЗначениеЗаполнено(УчетнаяЗаписьДокументооборота) Тогда
						НастроенОбменВУниверсальномФормате = Истина;
						Если КонтролирующийОрган = "ФНС" Тогда
							УчетнаяЗаписьПредназначенаДляДокументооборотаСКО = 
								ДокументооборотСКОВызовСервера.УчетнаяЗаписьПредназначенаДляДокументооборотаСФНС(УчетнаяЗаписьДокументооборота);
						ИначеЕсли КонтролирующийОрган = "ПФР" Тогда
							УчетнаяЗаписьПредназначенаДляДокументооборотаСКО = 
								ДокументооборотСКОВызовСервера.УчетнаяЗаписьПредназначенаДляДокументооборотаСПФР(УчетнаяЗаписьДокументооборота);
						ИначеЕсли КонтролирующийОрган = "ФСГС" Тогда
							УчетнаяЗаписьПредназначенаДляДокументооборотаСКО = 
								ДокументооборотСКОВызовСервера.УчетнаяЗаписьПредназначенаДляДокументооборотаСФСГС(УчетнаяЗаписьДокументооборота);
						КонецЕсли;
					КонецЕсли;
					
					СкрыватьПанель = УчетнаяЗаписьПредназначенаДляДокументооборотаСКО = Ложь;
					
				КонецЕсли;
			КонецЕсли;
		
		Исключение
			СкрыватьПанель = Истина;
		КонецПопытки;
		
	КонецЕсли;
	
	Возврат СкрыватьПанель;
	
КонецФункции

Функция СсылкаПрисутствуетВРегистреЖурналОтчетовСтатусы(Ссылка) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	               |	Журнал.Ссылка
	               |ИЗ
	               |	РегистрСведений.ЖурналОтчетовСтатусы КАК Журнал
	               |ГДЕ
	               |	Журнал.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	Возврат Выборка.Количество() > 0;

КонецФункции

Функция СсылкаПрисутствуетВРегистреЖурналОтправокВКонтролирующиеОрганы(Ссылка) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	               |	Журнал.Ссылка
	               |ИЗ
	               |	РегистрСведений.ЖурналОтправокВКонтролирующиеОрганы КАК Журнал
	               |ГДЕ
	               |	Журнал.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	Возврат Выборка.Количество() > 0;

КонецФункции

Функция ХотяБыОднаОрганизацияИспользуетДокументооборот() Экспорт
	
	ОрганизацииСДокументооборотом = Новый Массив;
	
	// Есть учетные записи
	ЭлектронныйДокументооборотАктивен = ЭлектронныйДокументооборотИспользуется();
	Если ЭлектронныйДокументооборотАктивен Тогда
		Возврат Истина;
	КонецЕсли;
	
	// Настроен ЭДО с ФСС
	СписокДопустимыхОрганизацийВОбъектахОбменаФСС = СписокДопустимыхОрганизацийВОбъектахОбменаФСС();
	Для каждого Организация Из СписокДопустимыхОрганизацийВОбъектахОбменаФСС Цикл
		Если Организация.ПометкаУдаления = Ложь Тогда
			Возврат Истина;
		Конецесли;
	КонецЦикла; 
	
	// Настроен ЭДО с ФСРАР
	СписокДопустимыхОрганизацийВОбъектахОбменаФСРАР = СписокДопустимыхОрганизацийВОбъектахОбменаФСРАР();
	Для каждого Организация Из СписокДопустимыхОрганизацийВОбъектахОбменаФСРАР Цикл
		Если Организация.ПометкаУдаления = Ложь Тогда
			Возврат Истина;
		Конецесли;
	КонецЦикла; 
	
	// Настроен ЭДО с РПН
	СписокДопустимыхОрганизацийВОбъектахОбменаРПН = СписокДопустимыхОрганизацийВОбъектахОбменаРПН();
	Для каждого Организация Из СписокДопустимыхОрганизацийВОбъектахОбменаРПН Цикл
		Если Организация.ПометкаУдаления = Ложь Тогда
			Возврат Истина;
		Конецесли;
	КонецЦикла; 
	
	Возврат Ложь;
	
КонецФункции

Процедура ПометитьОбъектПрочтенным(Ссылка) Экспорт

	НачатьТранзакцию();
	
	Попытка
		
		СтруктураКлюча = Новый Структура("НепрочтенноеСообщение", Ссылка);
		Ключ = РегистрыСведений.НепрочтеннаяПерепискаСКонтролирующимиОрганами.СоздатьКлючЗаписи(СтруктураКлюча);
		ЗаблокироватьДанныеДляРедактирования(Ключ);

		// Удаляем объект из регистра сведений
		НаборЗаписей = РегистрыСведений.НепрочтеннаяПерепискаСКонтролирующимиОрганами.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.НепрочтенноеСообщение.Установить(Ссылка);
		
		НаборЗаписей.Записать();
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		
		ЗаписьЖурналаРегистрации(
			"Пометка письма прочтенным", 
			УровеньЖурналаРегистрации.Ошибка,,,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
			
		ВызватьИсключение;
	
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

Функция ТипСодержимогоПоСтроке(СтрТипСодержимого) Экспорт
	
	Если НРег(СтрТипСодержимого) = "plain866" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.Текст866;
	ИначеЕсли НРег(СтрТипСодержимого) = "текст1251" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.Текст1251;
	ИначеЕсли НРег(СтрТипСодержимого) = "plain1251" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.Текст1251;
	ИначеЕсли НРег(СтрТипСодержимого) = "xml" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.xml;
	ИначеЕсли НРег(СтрТипСодержимого) = "html" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.html;
	ИначеЕсли НРег(СтрТипСодержимого) = "pdf" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.pdf;
	ИначеЕсли НРег(СтрТипСодержимого) = "rtf" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.rtf;
	ИначеЕсли НРег(СтрТипСодержимого) = "tiff" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.tiff;
	ИначеЕсли НРег(СтрТипСодержимого) = "jpeg" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.jpeg;
	ИначеЕсли НРег(СтрТипСодержимого) = "doc" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.ms_word;
	ИначеЕсли НРег(СтрТипСодержимого) = "xls" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.ms_excel;
	ИначеЕсли НРег(СтрТипСодержимого) = "odt" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.odf_text;
	ИначеЕсли НРег(СтрТипСодержимого) = "ods" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.odf_spreadsheet;
	ИначеЕсли НРег(СтрТипСодержимого) = "docx" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.oxml_word;
	ИначеЕсли НРег(СтрТипСодержимого) = "xlsx" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.oxml_spreadsheet;
	ИначеЕсли НРег(СтрТипСодержимого) = "sgn" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.sgn;
	ИначеЕсли НРег(СтрТипСодержимого) = "unknown" Тогда
		Возврат Перечисления.ТипыСодержимогоФайлов.Неизвестный;
	Иначе
		Возврат Перечисления.ТипыСодержимогоФайлов.ПустаяСсылка();
	КонецЕсли;
	
КонецФункции

Функция ДвоичныеДанныеИзСтроки64НаСервере(Данные)
	
	Возврат Base64Значение(Данные);
	
КонецФункции

Функция ПолучитьСтруктуруРазмеровСканДокументов(СканДокументы) Экспорт
	
	
	Если ТипЗнч(СканДокументы) <> Тип("Массив")  Тогда
		МасивСканДокументов = Новый Массив;
		МасивСканДокументов.Добавить(СканДокументы);
	Иначе
		МасивСканДокументов = СканДокументы;
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЕстьNull(СУММА(СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы.Размер), 0) КАК Размер,
	|	ЕстьNull(СУММА(1), 0) КАК КолвоФайлов
	|ИЗ
	|	Справочник.СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы КАК СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы
	|ГДЕ
	|	СканированныеДокументыДляПередачиВЭлектронномВидеПрисоединенныеФайлы.ВладелецФайла В(&МасивСканДокументов)");
	
	Запрос.УстановитьПараметр("МасивСканДокументов", МасивСканДокументов);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	СтруктураРезультат = Новый Структура("Размер, КолвоФайлов", 0, 0);
	
	Если Выборка.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(СтруктураРезультат,Выборка); 
	КонецЕсли;
	
	Возврат СтруктураРезультат;

КонецФункции

Процедура УдалитьПрисоединенныеФайлыСканированныеДокументыДляПередачиВЭлектронномВиде(МассивФайлов) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Для каждого ПрисоединенныйФайлСсылка Из МассивФайлов Цикл
		ПрисоединенныйФайлОбъект = ПрисоединенныйФайлСсылка.ПолучитьОбъект();
		ПрисоединенныйФайлОбъект.Удалить()
	КонецЦикла;
	
КонецПроцедуры

#Область ПредупреждениеОНекорректныхСтатусахОтправки2НДФЛ

Функция ТребуетсяПредупредитьОбОшибкеВСтатусахОтправки2НДФЛ() Экспорт
	
	ТребуетсяПредупредить 	= Ложь;
	АдресОтчетов			= Неопределено;
	
	Если НеобходимоПоказатьПредупреждениеОНекорректныхСтатусахОтправки2НДФЛ() Тогда
		
		АдресОтчетов = АдресОтчетов2НДФЛСНекорректнымиСтатусами();
	
		Если АдресОтчетов = Неопределено Тогда
			НапомнитьПозжеОНекорректныхСтатусахОтправки2НДФЛ(Ложь);
		Иначе
			ТребуетсяПредупредить = Истина;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Новый Структура("ТребуетсяПредупредить, АдресОтчетов", ТребуетсяПредупредить, АдресОтчетов);
	
КонецФункции

Функция НеобходимоПоказатьПредупреждениеОНекорректныхСтатусахОтправки2НДФЛ() Экспорт
	
	ПоказатьПредупреждение = ХранилищеОбщихНастроек.Загрузить("КорректировкаСтатусовОтправки2НДФЛ_НапомнитьПозже");
	Возврат ПоказатьПредупреждение <> Ложь;
	
КонецФункции

Процедура НапомнитьПозжеОНекорректныхСтатусахОтправки2НДФЛ(Ответ) Экспорт
	
	ХранилищеОбщихНастроек.Сохранить("КорректировкаСтатусовОтправки2НДФЛ_НапомнитьПозже", , Ответ);
	
КонецПроцедуры

Функция АдресОтчетов2НДФЛСНекорректнымиСтатусами()
	
	Адрес = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ТранспортноеСообщение.ЦиклОбмена.Предмет КАК Отчет,
		|	МАКСИМУМ(ТранспортноеСообщение.Ссылка) КАК ТранспортноеСообщение,
		|	МАКСИМУМ(ТранспортноеСообщение.ЦиклОбмена) КАК ЦиклОбмена
		|ПОМЕСТИТЬ ПоследниеОтправки
		|ИЗ
		|	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЖурналОтчетовСтатусы КАК ЖурналОтчетовСтатусы
		|		ПО ТранспортноеСообщение.ЦиклОбмена.Предмет = ЖурналОтчетовСтатусы.Ссылка
		|ГДЕ
		|	ТранспортноеСообщение.Тип = &РезультатПриемаФорма2НДФЛНО
		|	И ЖурналОтчетовСтатусы.ДатаНачала >= &ДатаНачала
		|	И ЖурналОтчетовСтатусы.ДатаОкончания < &ДатаОкончания
		|	И ТранспортноеСообщение.ПометкаУдаления = ЛОЖЬ
		|	И ТранспортноеСообщение.ЦиклОбмена.ПометкаУдаления = ЛОЖЬ
		|
		|СГРУППИРОВАТЬ ПО
		|	ТранспортноеСообщение.ЦиклОбмена.Предмет
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ТранспортныеСообщения.Ссылка.ДатаТранспорта КАК ДатаОтправки,
		|	ТранспортныеСообщения.ЦиклОбмена КАК ЦиклОбмена
		|ПОМЕСТИТЬ ДатыОтправки
		|ИЗ
		|	Документ.ТранспортноеСообщение КАК ТранспортныеСообщения
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПоследниеОтправки КАК ПоследниеОтправки
		|		ПО (ПоследниеОтправки.ЦиклОбмена = ПоследниеОтправки.ТранспортноеСообщение.ЦиклОбмена)
		|ГДЕ
		|	ТранспортныеСообщения.Ссылка.Тип = &Форма2НДФЛНП
		|	И ТранспортныеСообщения.ПометкаУдаления = ЛОЖЬ
		|	И ТранспортныеСообщения.ЦиклОбмена.ПометкаУдаления = ЛОЖЬ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЖурналОтчетовСтатусы.Организация,
		|	ЖурналОтчетовСтатусы.НаименованиеОтчета КАК Представление,
		|	ПоследниеОтправки.Отчет,
		|	ЖурналОтчетовСтатусы.Статус КАК Состояние,
		|	ЖурналОтчетовСтатусы.СостояниеСдачиОтчетности КАК СостояниеСдачиОтчетности,
		|	ДатыОтправки.ДатаОтправки КАК ДатаОтправки,
		|	ПоследниеОтправки.ТранспортноеСообщение КАК Протокол,
		|	ПоследниеОтправки.ЦиклОбмена КАК ЦиклОбмена,
		|	""Протокол ошибок"" КАК НаименованиеПротокола
		|ИЗ
		|	ПоследниеОтправки КАК ПоследниеОтправки
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЖурналОтчетовСтатусы КАК ЖурналОтчетовСтатусы
		|		ПО ПоследниеОтправки.Отчет = ЖурналОтчетовСтатусы.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДатыОтправки КАК ДатыОтправки
		|		ПО (ДатыОтправки.ЦиклОбмена = ПоследниеОтправки.ЦиклОбмена)
		|ГДЕ
		|	ПоследниеОтправки.ТранспортноеСообщение.ПротоколСОшибкой = ИСТИНА
		|	И ПоследниеОтправки.ТранспортноеСообщение.Тип = &РезультатПриемаФорма2НДФЛНО";
		
	Запрос.УстановитьПараметр("ДатаНачала", 					Дата(2014,1,1));
	Запрос.УстановитьПараметр("ДатаОкончания", 					Дата(2016,1,1));
	Запрос.УстановитьПараметр("РезультатПриемаФорма2НДФЛНО", 	Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО);
	Запрос.УстановитьПараметр("Форма2НДФЛНП", 					Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП);
	
	ОтчетыСОшибками = Запрос.Выполнить().Выгрузить();
	
	Если ОтчетыСОшибками.Количество() > 0 Тогда
		Адрес = ПоместитьВоВременноеХранилище(ОтчетыСОшибками, Новый УникальныйИдентификатор);
	КонецЕсли;
	
	Возврат Адрес; 
	
КонецФункции

Процедура ИсправитьНекорректныеСостоянияОтправок2НДФЛ() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ТранспортноеСообщение.Ссылка КАК ТранспортноеСообщение,
		|	ТранспортноеСообщение.ЦиклОбмена.Предмет КАК Отчет,
		|	ТранспортноеСообщение.ЦиклОбмена.Организация КАК Организация,
		|	ЛОЖЬ КАК ТребуетсяКорректировкаСтатуса
		|ИЗ
		|	Документ.ТранспортноеСообщение КАК ТранспортноеСообщение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЖурналОтчетовСтатусы КАК ЖурналОтчетовСтатусы
		|		ПО ТранспортноеСообщение.ЦиклОбмена.Предмет = ЖурналОтчетовСтатусы.Ссылка
		|ГДЕ
		|	ТранспортноеСообщение.ПротоколСОшибкой = ЛОЖЬ
		|	И ТранспортноеСообщение.Тип = &Тип
		|	И ЖурналОтчетовСтатусы.ДатаНачала >= &ДатаНачала
		|	И ЖурналОтчетовСтатусы.ДатаОкончания < &ДатаОкончания";
	
	Запрос.УстановитьПараметр("ДатаНачала", 	Дата(2014,1,1));
	Запрос.УстановитьПараметр("ДатаОкончания", 	Дата(2016,1,1));
	Запрос.УстановитьПараметр("Тип", 			Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО);
	
	РезультатПроверкиСостоянийОтчетов = Запрос.Выполнить();
	Сообщения = РезультатПроверкиСостоянийОтчетов.Выгрузить();
	
	Для каждого Строка Из Сообщения Цикл
	    УстановитьКорректноеЗначениеОшибкиПротокола2НДФЛ(Строка);
	КонецЦикла;
	
	// Статусы отчета корректируем отдельно от записи транспортного сообщения, так как на один отчет может быть 
	// несколько транспортных сообщений одного вида.
	Для каждого Строка Из Сообщения Цикл
		Если Строка.ТребуетсяКорректировкаСтатуса Тогда
			УстановитьКорректныеСтатусыОтчетов2НДФЛ(Строка.Отчет, Строка.Организация);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьКорректныеСтатусыОтчетов2НДФЛ(Отчет, Организация)
	
	НачатьТранзакцию();
	
	Попытка
		
		ВидКонтролирующегоОргана 	= Перечисления.ТипыКонтролирующихОрганов.ФНС;
		СтатусОтправки 				= Неопределено;
		СостояниеСдачиОтчетности 	= Неопределено;
		
		ЭлектронныйДокументооборотСКонтролирующимиОрганами.ОпределитьСтатусИСостояниеСдачиОтчетности(
			Отчет, Организация, ВидКонтролирующегоОргана, СостояниеСдачиОтчетности, СтатусОтправки);
		
		СтруктураКлюча = Новый Структура("Ссылка", Отчет);
		Ключ = РегистрыСведений.ЖурналОтчетовСтатусы.СоздатьКлючЗаписи(СтруктураКлюча);
		ЗаблокироватьДанныеДляРедактирования(Ключ);
		
		Блокировка = Новый БлокировкаДанных;
		ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ЖурналОтчетовСтатусы");
		ЭлементБлокировки.УстановитьЗначение("Ссылка", Отчет);
		Блокировка.Заблокировать();
		
		НаборЗаписей = РегистрыСведений.ЖурналОтчетовСтатусы.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Ссылка.Установить(Отчет);
		НаборЗаписей.Прочитать();
		
		Для каждого Запись из НаборЗаписей Цикл
			Запись.СостояниеСдачиОтчетности = СостояниеСдачиОтчетности;
			Запись.Статус 					= СтатусОтправки;
		КонецЦикла;
		
		НаборЗаписей.Записать();
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'Корректировка состояния отправки 2-НДФЛ'"), 
			УровеньЖурналаРегистрации.Ошибка,,,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
			
	КонецПопытки;
	
КонецПроцедуры

Процедура УстановитьКорректноеЗначениеОшибкиПротокола2НДФЛ(Строка)
	
	ТранспортноеСообщение = Строка.ТранспортноеСообщение;
	
	НовоеЗначениеПротоколСОшибкой = ЯвляетсяОтрицательнымПротоколом(ТранспортноеСообщение);
	Если НовоеЗначениеПротоколСОшибкой <> Ложь Тогда

		ТранспортноеСообщениеОбъект = ТранспортноеСообщение.ПолучитьОбъект();
		ТранспортноеСообщениеОбъект.ПротоколСОшибкой = Истина;
		ТранспортноеСообщениеОбъект.Записать();
		
		Строка.ТребуетсяКорректировкаСтатуса = Истина;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ЛичныеКабинеты

Процедура ЗаполнитьПараметрыСпецоператора(Знач Спецоператор, ПараметрыСтруктура) Экспорт
	
	Если ТипЗнч(Спецоператор) = Тип("ПеречислениеСсылка.СпецоператорыСвязи") Тогда
		Имя = ЭлектронныйДокументооборотСКонтролирующимиОрганамиВызовСервера.ПолучитьИмяЗначенияПеречисленияСпецоператорыСвязиПоСинониму(Спецоператор);
	Иначе
		Имя = Спецоператор.Имя;
	КонецЕсли;
	
	Макет = ПолучитьМакетОбработки("ПараметрыСпецоператоровСвязи");
	
	Для Каждого Параметр Из ПараметрыСтруктура Цикл
		
		НомерКолонки = Макет.Область(Параметр.Ключ).Лево;
		
		Для НомерСтроки = 2 По Макет.ВысотаТаблицы Цикл
			ТекРегион = Макет.Область(НомерСтроки, 1).Текст;
			
			Если нРег(ТекРегион) = нРег(Имя) Тогда
				ПараметрыСтруктура.Вставить(Параметр.Ключ,Макет.Область(НомерСтроки, НомерКолонки).Текст);
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьМассивИспользуемыхСпецоператоров() Экспорт
	
	МассивРезультат = Новый Массив;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	                      |	УчетныеЗаписиДокументооборота.СпецоператорСвязи
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УчетныеЗаписиДокументооборота КАК УчетныеЗаписиДокументооборота
	                      |		ПО Организации.УчетнаяЗаписьОбмена = УчетныеЗаписиДокументооборота.Ссылка
	                      |ГДЕ
	                      |	Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами
	                      |	И УчетныеЗаписиДокументооборота.СпецоператорСвязи <> ЗНАЧЕНИЕ(Перечисление.СпецоператорыСвязи.ПустаяСсылка)
						  |	И НЕ Организации.ПометкаУдаления
	                      |	И НЕ УчетныеЗаписиДокументооборота.ПометкаУдаления");
						  
	Запрос.УстановитьПараметр("ВидОбменаСКонтролирующимиОрганами", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		МассивРезультат.Добавить(Выборка.СпецоператорСвязи);
	КонецЦикла; 
	
	Возврат МассивРезультат;
	
КонецФункции

Функция ПолучитьТаблицуИспользуемыхСпецоператоровУчетныхЗаписейОрганизаций() Экспорт
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	                      |	Организации.Ссылка КАК Организация,
	                      |	УчетныеЗаписиДокументооборота.Ссылка КАК УчетнаяЗапись,
	                      |	УчетныеЗаписиДокументооборота.СпецоператорСвязи КАК Спецоператор,
	                      |	РегистрацииВНалоговомОргане.Код КАК КодНО
	                      |ИЗ
	                      |	Справочник.Организации КАК Организации
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.УчетныеЗаписиДокументооборота КАК УчетныеЗаписиДокументооборота
	                      |		ПО Организации.УчетнаяЗаписьОбмена = УчетныеЗаписиДокументооборота.Ссылка
	                      |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.РегистрацииВНалоговомОргане КАК РегистрацииВНалоговомОргане
	                      |		ПО Организации.РегистрацияВНалоговомОргане = РегистрацииВНалоговомОргане.Ссылка
	                      |ГДЕ
	                      |	Организации.ВидОбменаСКонтролирующимиОрганами = &ВидОбменаСКонтролирующимиОрганами
	                      |	И УчетныеЗаписиДокументооборота.СпецоператорСвязи <> ЗНАЧЕНИЕ(Перечисление.СпецоператорыСвязи.ПустаяСсылка)
						  |	И НЕ Организации.ПометкаУдаления
	                      |	И НЕ УчетныеЗаписиДокументооборота.ПометкаУдаления");
						  
	Запрос.УстановитьПараметр("ВидОбменаСКонтролирующимиОрганами", Перечисления.ВидыОбменаСКонтролирующимиОрганами.ОбменВУниверсальномФормате);
	
	Результат = Запрос.Выполнить();
	
	Возврат Результат.Выгрузить();
	
КонецФункции

#КонецОбласти

#Область ОсновнойРаздел
СоответствиеТипаСообщенияКраткомуПредставлению = Новый Соответствие;
// ФНС 534
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ДекларацияНП, "Отчет");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДекларацияНО, "Подтверждение даты отправки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеНП, "Извещение на подтверждение даты отправки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеДекларацияНО, "Извещение о получении отчета");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДекларацияНО, "Результат приема");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНП, "Извещение о получении результата приема");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиДекларацияНО, "Результат обработки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиНП, "Извещение о получении результата обработки");

//ФНС Документ
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ДокументНО, "Документ");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеДокументНП, "Извещение о получении документа");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаДокументНП,"Результат приема документа");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатПриемаНО, "Извещение о получении результата приема документа");

//ФНС Заявление
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ЗаявлениеНП,						"Отчет");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗаявлениеНО,		"Подтверждение даты отправки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗаявлениеНО,			"Извещение о получении отчета");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗаявлениеНО,		"Результат приема");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеНО, 	"Результат обработки заявления");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеРФНО, "Результат обработки в РФ");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиРФНП,	"Извещение о получении результата обработки в РФ");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.СообщениеОбОтзывеЗаявлениеРФНО,	"Сообщение об отзыве заявления в РФ");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбОтзывеЗаявлениеРФНП,	"Извещение о получении сообщения об отзыве заявления в РФ");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗаявлениеТСНО,	"Результат обработки заявления в ТС");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРезультатОбработкиТСНП,	"Извещение о получении результата обработки заявления в ТС");

// ФНС 534 2-НДФЛ
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.Форма2НДФЛНП, "Форма 2-НДФЛ");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеФорма2НДФЛНО, "Подтверждение даты отправки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеФорма2НДФЛНО, "Извещение о получении формы 2-НДФЛ");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаФорма2НДФЛНО, "Результат приема");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФНС, "Уведомление об ошибке");

// ФНС 534 НФД
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ОбращениеНП, "Письмо");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеОбращениеНО, "Подтверждение даты отправки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОбращениеНО, "Извещение о получении письма");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаОбращениеНО, "Результат приема");

// ФНС Представление
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПредставлениеНП, "Представление");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПредставлениеНО, "Подтверждение даты отправки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПредставлениеНО, "Извещение о получении представления");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаПредставлениеНО, "Результат приема");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоНО, "Письмо");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоНП, "Извещение о получении письма");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РассылкаНО, "Рассылка");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеРассылкаНП, "Извещение о получении рассылки");

// ФНС 534 ИОН
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ЗапросНП, "Запрос");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеЗапросНО, "Подтверждение даты отправки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеЗапросНО, "Извещение о получении запроса");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатПриемаЗапросНО, "Результат приема");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.РезультатОбработкиЗапросНО, "Результат обработки");

// ПФР
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьПФР, "Отчет");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияОтчетностиПФР, "Подтверждение получения");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколПФР, "Протокол");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколКвитанцияПФР, "Квитанция на протокол");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееПФР, "Исходящее письмо");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееКвитанцияПФР, "Квитанция на исходящее письмо");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееПФР, "Входящее письмо");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееКвитанцияПФР, "Квитанция на входящее письмо");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееЗапросПФР, "Запрос");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеПолученияЗапросаПФР, "Подтверждение получения");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросПФР, "Ответ на запрос");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ОтветНаЗапросКвитанцияПФР, "Квитанция на ответ на запрос");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеПФР, "Уведомление об ошибке");

// Росстат
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПервичноеСообщениеСодержащееОтчетностьФСГС, "Отчет");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПодтверждениеДатыОтправкиФСГС, "Подтверждение даты отправки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПодтверждениеДатыОтправкиФСГС, "Извещение о получении подтверждения даты отправки");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеОПолученииОтчетностиФСГС, "Извещение о получении отчетности");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПротоколВходногоКонтроляОтчетностиФСГС, "Протокол");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПротоколВходногоКонтроляОтчетностиФСГС, "Извещение о получении протокола");

СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоИсходящееФСГС, "Исходящее письмо");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоИсходящееФСГС, "Извещение о получении письма его получателем");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПисьмоВходящееФСГС, "Входящее письмо");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ИзвещениеПисьмоВходящееФСГС, "Извещение о получении письма его получателем");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.УведомлениеОбОшибкеФСГС, "Уведомление об ошибке");
//
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.КритическаяОшибка, "Критическая ошибка");
СоответствиеТипаСообщенияКраткомуПредставлению.Вставить(Перечисления.ТипыТранспортныхСообщений.ПустаяСсылка(), "Неизвестный тип");
#КонецОбласти

#КонецЕсли