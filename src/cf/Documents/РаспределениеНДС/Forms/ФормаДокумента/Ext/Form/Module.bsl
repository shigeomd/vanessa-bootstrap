&НаКлиенте
Перем ПараметрыОбработчикаОжидания;

&НаКлиенте
Перем ФормаДлительнойОперации;

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// СтандартныеПодсистемы.Печать
	УправлениеПечатью.ПриСозданииНаСервере(ЭтаФорма);
	// Конец СтандартныеПодсистемы.Печать
	
	// ДополнительныеОтчетыИОбработки
	ДополнительныеОтчетыИОбработки.ПриСозданииНаСервере(ЭтаФорма);
	// Конец ДополнительныеОтчетыИОбработки
	
	// СтандартныеПодсистемы.ВерсионированиеОбъектов
	ВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов
	
	Если Параметры.Ключ.Пустая() Тогда
		ПодготовитьФормуНаСервере();
		ЗаполнитьРеквизитыИзПараметровФормы(ЭтаФорма);
	КонецЕсли;
	
	УстановитьУсловноеОформление();
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	// СтандартныеПодсистемы.ДатыЗапретаИзменения
	ДатыЗапретаИзменения.ОбъектПриЧтенииНаСервере(ЭтаФорма, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.ДатыЗапретаИзменения
	
	ПодготовитьФормуНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Если ПараметрыЗаписи.РежимЗаписи = ПредопределенноеЗначение("РежимЗаписиДокумента.Проведение") Тогда
		КлючеваяОперация = "ПроведениеРаспределениеНДС";
		ОценкаПроизводительностиКлиентСервер.НачатьЗамерВремени(КлючеваяОперация);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	ОбщегоНазначенияБПКлиент.ОбработкаОповещенияФормыДокумента(ЭтаФорма, Объект.Ссылка, ИмяСобытия, Параметр, Источник);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	Оповестить("СостояниеРегламентнойОперации", 
		?(Объект.Проведен, ПредопределенноеЗначение("Перечисление.ВидыСостоянийРегламентныхОпераций.Выполнено"), 
						   ПредопределенноеЗначение("Перечисление.ВидыСостоянийРегламентныхОпераций.НеВыполнено")));
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	ЗаполнитьДобавленныеКолонкиТаблиц();
	
	УстановитьСостояниеДокумента();
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ШАПКИ ФОРМЫ

&НаКлиенте
Процедура ПолеПереключателяСписанияНДСиспользоватьСчетИАналитикуУчетаЗатратПриИзменении(Элемент)
	
	Объект.ДляСписанияНДСиспользоватьСчетИАналитикуУчетаЗатрат = 
		РеквизитПереключателяСписанияНДСиспользоватьСчетИАналитикуУчетаЗатрат = 1;
		
	Если Объект.ДляСписанияНДСиспользоватьСчетИАналитикуУчетаЗатрат Тогда 
		Объект.СчетСписанияНДС = ПредопределенноеЗначение("ПланСчетов.Хозрасчетный.ПустаяСсылка");
		ПриИзмененииСчетСписанияНДС();
	КонецЕсли;
	
	УправлениеФормой(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура СчетСписанияНДСПриИзменении(Элемент)
	
	ПриИзмененииСчетСписанияНДС();
		
КонецПроцедуры

&НаКлиенте
Процедура ПриИзмененииСчетСписанияНДС()
	
	УстановитьЗаголовкиИДоступностьСубконто(ЭтаФорма, Объект.СчетСписанияНДС);
	
	ПоляОбъекта = Новый Структура("Субконто1, Субконто2, Субконто3, Подразделение, Организация, ПодразделениеПоУмолчанию", 
	                              "СубконтоСписанияНДС1", "СубконтоСписанияНДС2", "СубконтоСписанияНДС3", 
								  "ПодразделениеЗатрат", Объект.Организация, Неопределено);
	ЗначенияСубконто = Новый Соответствие;
	ЗначенияСубконто.Вставить(ПредопределенноеЗначение("ПланВидовХарактеристик.ВидыСубконтоХозрасчетные.НоменклатурныеГруппы"), 
		БухгалтерскийУчетВызовСервераПовтИсп.ОсновнаяНоменклатурнаяГруппа());

	БухгалтерскийУчетКлиентСервер.ПриИзмененииСчета(Объект.СчетСписанияНДС, Объект, ПоляОбъекта,, ЗначенияСубконто);
	
КонецПроцедуры


&НаКлиенте
Процедура СчетаУчетаРасходовСчетЗатратПриИзменении(Элемент)
	
	СтрокаТЧ = Элементы.СчетаУчетаРасходов.ТекущиеДанные;
	
	УстановитьДоступностьСубконто(ЭтаФорма, СтрокаТЧ.СчетЗатрат, Истина);
	
	ПоляОбъекта = Новый Структура("Субконто1, Субконто2, Субконто3", 
								  "Субконто1", "Субконто2", "Субконто3");
	ПоляОбъекта.Вставить("Подразделение", "ПодразделениеЗатрат");
	ПоляОбъекта.Вставить("Организация"  , Объект.Организация);
	ЗначенияСубконто = Новый Соответствие;
	ЗначенияСубконто.Вставить(ПредопределенноеЗначение("ПланВидовХарактеристик.ВидыСубконтоХозрасчетные.НоменклатурныеГруппы"), 
		БухгалтерскийУчетВызовСервераПовтИсп.ОсновнаяНоменклатурнаяГруппа());

	БухгалтерскийУчетКлиентСервер.ПриИзмененииСчета(СтрокаТЧ.СчетЗатрат, СтрокаТЧ, ПоляОбъекта, Истина, ЗначенияСубконто);
		
КонецПроцедуры

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	
	Если РаздельныйУчетНДСНаСчете19 Тогда
		Если КонецМесяца(Объект.Дата) <> КонецКвартала(Объект.Дата) Тогда
			Объект.НачалоПериода = НачалоМесяца(Объект.Дата);
		Иначе
			Объект.НачалоПериода = НачалоКвартала(Объект.Дата);
		КонецЕсли;
	Иначе
		Объект.НачалоПериода = НачалоКвартала(Объект.Дата);
	КонецЕСли;
	
	ПодготовитьФормуНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)
	
	ПодготовитьФормуНаСервере();	
	
КонецПроцедуры

&НаКлиенте
Процедура ВыручкаБезНДСПриИзменении(Элемент)
	
	ЕстьВыручкаБезНДС = Объект.ВыручкаБезНДС <> 0 
		ИЛИ Объект.СоставКосвенныхРасходов.Итог("БезНДС") <> 0;
	
КонецПроцедуры

&НаКлиенте
Процедура ВыручкаЕНВДПриИзменении(Элемент)
	
	ЕстьВыручкаЕНВД = Объект.ВыручкаЕНВД <> 0
		ИЛИ Объект.СоставКосвенныхРасходов.Итог("ЕНВДНДС") <> 0;
	
КонецПроцедуры

&НаКлиенте
Процедура СтраницыПриСменеСтраницы(Элемент, ТекущаяСтраница)

	Если Элемент.ТекущаяСтраница.Имя = "ГруппаКосвенныеРасходы" Тогда
		ОтобразитьНаправленияСписания();
		
	ИначеЕсли Элемент.ТекущаяСтраница.Имя = "ГруппаРеализация" Тогда
		УправлениеФормой(ЭтаФорма);
	КонецЕсли;

	ОбновитьУсловноеОформление(ЭтотОбъект);

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЦЫ ФОРМЫ РаспределяемыйНДС

&НаКлиенте
Процедура РаспределяемыйНДСВидЦенностиПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.РаспределяемыйНДС.ТекущиеДанные;
	Если ТекущиеДанные.Количество <> 0 
		И ВидыЦенностиБезКоличества().НайтиПоЗначению(ТекущиеДанные.ВидЦенности) <> Неопределено Тогда
		ТекущиеДанные.Количество = 0;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЦЫ ФОРМЫ СоставКосвенныхРасходов

&НаКлиенте
Процедура СоставКосвенныхРасходовПриИзменении(Элемент)
	
	ЕстьВыручкаБезНДС = Объект.ВыручкаБезНДС <> 0 
		ИЛИ Объект.СоставКосвенныхРасходов.Итог("БезНДС") <> 0;
	ЕстьВыручкаЕНВД = Объект.ВыручкаЕНВД <> 0
		ИЛИ Объект.СоставКосвенныхРасходов.Итог("ЕНВДНДС") <> 0;
	
КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовСтавкаНДСПриИзменении(Элемент)
	
	// Рассчитать реквизиты табличной части.
	ТекущиеДанные = Элементы.СоставКосвенныхРасходов.ТекущиеДанные;
	ТекущиеДанные.НДСВсего = УчетНДСКлиентСервер.РассчитатьСуммуНДС(
		ТекущиеДанные.СуммаВсего, Ложь, УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(ТекущиеДанные.СтавкаНДС));
    
КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовСуммаВсегоПриИзменении(Элемент)
			
	ТекущиеДанные = Элементы.СоставКосвенныхРасходов.ТекущиеДанные;
	
	ТекущиеДанные.НДСВсего = УчетНДСКлиентСервер.РассчитатьСуммуНДС(
		ТекущиеДанные.СуммаВсего, Ложь, УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(ТекущиеДанные.СтавкаНДС));

КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовНДССуммаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.СоставКосвенныхРасходов.ТекущиеДанные;
	ТекущиеДанные.НДС = УчетНДСКлиентСервер.РассчитатьСуммуНДС(
		ТекущиеДанные.НДССумма, Ложь, УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(ТекущиеДанные.СтавкаНДС));

КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовБезНДССуммаПриИзменении(Элемент)
				
	ТекущиеДанные = Элементы.СоставКосвенныхРасходов.ТекущиеДанные;
	ТекущиеДанные.БезНДС = УчетНДСКлиентСервер.РассчитатьСуммуНДС(
		ТекущиеДанные.БезНДССумма, Ложь, УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(ТекущиеДанные.СтавкаНДС));
	
КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовЕНВДСуммаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.СоставКосвенныхРасходов.ТекущиеДанные;
	ТекущиеДанные.ЕНВДНДС = УчетНДСКлиентСервер.РассчитатьСуммуНДС(
		ТекущиеДанные.ЕНВДСумма, Ложь, УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(ТекущиеДанные.СтавкаНДС));

КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовНДС0СуммаПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.СоставКосвенныхРасходов.ТекущиеДанные;
	ТекущиеДанные.НДС0 = УчетНДСКлиентСервер.РассчитатьСуммуНДС(
		ТекущиеДанные.НДС0Сумма, Ложь, УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(ТекущиеДанные.СтавкаНДС));
	
КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовПриАктивизацииСтроки(Элемент)
	
	Если ЭтаФорма.АктивизацияСтрокиТЧ Тогда 
		ЭтаФорма.АктивизацияСтрокиТЧ = Ложь;
	Иначе 
		ОтобразитьНаправленияСписания();
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовПослеУдаления(Элемент)
	
	ОтобразитьНаправленияСписания();
	
КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда

		Кандидат = ПоискПоТабличнойЧасти();
		
		Элементы.СоставКосвенныхРасходов.ТекущиеДанные.КлючСтроки = Кандидат;
		
		ОтобразитьНаправленияСписания();

	КонецЕсли;
   
КонецПроцедуры

&НаКлиенте
Процедура СоставКосвенныхРасходовПередУдалением(Элемент, Отказ)
	
	// Необходимо очистить таблицу СчетаУчетаРасходов
	КлючПоиска = Новый Структура("КлючСтроки" , Элементы.СчетаУчетаРасходов.ОтборСтрок.КлючСтроки);
	
	НайденныеСтроки = Объект.СчетаУчетаРасходов.НайтиСтроки(КлючПоиска);
	
	Для Каждого Строка Из НайденныеСтроки Цикл
		Объект.СчетаУчетаРасходов.Удалить(Строка);
	КонецЦикла;

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЦЫ ФОРМЫ СчетаУчетаРасходов

&НаКлиенте
Процедура СчетаУчетаРасходовПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	ТекущиеДанные = Элементы.СчетаУчетаРасходов.ТекущиеДанные;

	УстановитьДоступностьСубконто(ЭтаФорма, ТекущиеДанные.СчетЗатрат, Истина);
	
	Если НоваяСтрока Тогда
		ТекущиеДанные.КлючСтроки = Элементы.СчетаУчетаРасходов.ОтборСтрок.КлючСтроки;
	КонецЕсли; 

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

// Процедура вызывается по кнопке "Рассчитать" из формы диалога документа.
// Выполняется расчет объемов реализации в текущем периоде по данным
// регистра НДСПродажи в разрезе различных ставок НДС.
//
&НаКлиенте
Процедура Рассчитать(Команда)
	
	СтруктураПараметров = Новый Структура("НачалоПериода, Организация, Дата",
		Объект.НачалоПериода, Объект.Организация, Объект.Дата);
	ДанныеДляЗаполнения = РассчитатьВыручкуСервер(СтруктураПараметров);
	ЗаполнитьЗначенияСвойств(Объект, ДанныеДляЗаполнения);
	УправлениеФормой(ЭтаФорма);

КонецПроцедуры // КоманднаяПанельВыручкиРассчитать()

// Процедура вызывается по кнопке "Заполнить" в форме диалога документа.
// В процедуре реализуется алгоритм автоматического заполнения строк табличной части документа.
//
&НаКлиенте
Процедура КоманднаяПанельЗаполнитьТабличнуюЧасть(Команда)
	
	ЗаполнитьДокументНаКлиенте();
	
КонецПроцедуры

// Процедура вызывается по кнопке "Распределить" в форме диалога документа.
// В процедуре реализуется алгоритм распределения косвенных расходов в табличной
// части "СоставКосвенныхРасходов" на различные виды реализации в текущем периоде.
//
&НаКлиенте
Процедура КоманднаяПанельРаспределить(Команда)

	БазаРаспределенияСЕНВД = Объект.ВыручкаНДС + Объект.ВыручкаБезНДС + Объект.ВыручкаЕНВД + Объект.ВыручкаНДС0;
	
	Если БазаРаспределенияСЕНВД = 0 Тогда
		ТекстСообщения = НСтр("ru='На закладке ""Выручка от реализации"" не указаны параметры реализации!'");
		Сообщить(ТекстСообщения, СтатусСообщения.Внимание);
		Возврат;
	КонецЕсли;
	
	РаспределитьРасходыСервер();
	УправлениеФормой(ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьДокумент(Команда)
	
	ЗаполнитьДокументНаКлиенте(Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура АнализРаспределенияНДС(Команда)
	
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("Организация", Объект.Организация);
	СтруктураПараметров.Вставить("Период", Объект.Дата);
	СтруктураПараметров.Вставить("Документ", Объект.Ссылка);
	ОткрытьФорму("Отчет.АнализРаспределенияНДС.Форма", СтруктураПараметров);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ БСП

// СтандартныеПодсистемы.ДополнительныеОтчетыИОбработки

&НаСервере
Процедура ДополнительныеОтчетыИОбработкиВыполнитьНазначаемуюКомандуНаСервере(ИмяЭлемента, РезультатВыполнения)
	
	ДополнительныеОтчетыИОбработки.ВыполнитьНазначаемуюКомандуНаСервере(ЭтаФорма, ИмяЭлемента, РезультатВыполнения);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ВыполнитьНазначаемуюКоманду(Команда)
	
	Если НЕ ДополнительныеОтчетыИОбработкиКлиент.ВыполнитьНазначаемуюКомандуНаКлиенте(ЭтаФорма, Команда.Имя) Тогда
		РезультатВыполнения = Неопределено;
		ДополнительныеОтчетыИОбработкиВыполнитьНазначаемуюКомандуНаСервере(Команда.Имя, РезультатВыполнения);
		ДополнительныеОтчетыИОбработкиКлиент.ПоказатьРезультатВыполненияКоманды(ЭтаФорма, РезультатВыполнения);
	КонецЕсли;
	
КонецПроцедуры

// Конец СтандартныеПодсистемы.ДополнительныеОтчетыИОбработки

// СтандартныеПодсистемы.Печать
&НаКлиенте
Процедура Подключаемый_ВыполнитьКомандуПечати(Команда)
	
	УправлениеПечатьюКлиент.ВыполнитьПодключаемуюКомандуПечати(Команда, ЭтаФорма, Объект);
	
КонецПроцедуры

// Конец СтандартныеПодсистемы.Печать

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаСервере
Процедура УстановитьУсловноеОформление()

	НастройкиУсловногоОформления = Новый Структура();

	УсловноеОформление.Элементы.Очистить();

	// Условное оформление, связанное с видимостью, устанавливаем сразу для всех колонок.
	УстановитьУсловноеОформлениеШапкаИВидимость();

	// Условное оформление для полей, расположенных на страницах

	ОбновитьУсловноеОформление(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ОбновитьУсловноеОформление(Форма)

	Элементы = Форма.Элементы;

	Если НЕ Форма.НастройкиУсловногоОформления.Свойство("НДСКРаспределениюПроинициализировано")
		И Элементы.Страницы.ТекущаяСтраница = Элементы.ГруппаНДСКРаспределению Тогда

		Форма.УстановитьУсловноеОформлениеНДСКРаспределению();

	ИначеЕсли НЕ Форма.НастройкиУсловногоОформления.Свойство("КосвенныеРасходыПроинициализировано")
		И Элементы.Страницы.ТекущаяСтраница = Элементы.ГруппаКосвенныеРасходы Тогда

		Форма.УстановитьУсловноеОформлениеКосвенныеРасходы();

	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура УстановитьУсловноеОформлениеШапкаИВидимость()

	// СтатьяЗатратНДС

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "СтатьяЗатратНДС");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"ЕстьВыручкаБезНДС", ВидСравненияКомпоновкиДанных.Равно, Ложь);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("ОтметкаНезаполненного", Ложь);


	// СтатьяЗатратНДСприЕНВД

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "СтатьяЗатратНДСприЕНВД");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"ЕстьВыручкаЕНВД", ВидСравненияКомпоновкиДанных.Равно, Ложь);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("ОтметкаНезаполненного", Ложь);


	// РаспределяемыйНДССуммаБезНДСПринимаетсяКВычету, РаспределяемыйНДСНДСПринимаетсяКВычету

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДССуммаБезНДСПринимаетсяКВычету");
	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДСНДСПринимаетсяКВычету");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"Объект.ВыручкаНДС", ВидСравненияКомпоновкиДанных.НеЗаполнено);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);


	// РаспределяемыйНДССуммаБезНДСУчитываетсяВCтоимости, РаспределяемыйНДСНДСУчитываетсяВCтоимости

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДССуммаБезНДСУчитываетсяВCтоимости");
	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДСНДСУчитываетсяВCтоимости");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"Объект.ВыручкаБезНДС", ВидСравненияКомпоновкиДанных.НеЗаполнено);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);


	// РаспределяемыйНДССуммаБезНДСУчитываетсяВCтоимостиЕНВД, РаспределяемыйНДСНДСУчитываетсяВCтоимостиЕНВД

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДССуммаБезНДСУчитываетсяВCтоимостиЕНВД");
	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДСНДСУчитываетсяВCтоимостиЕНВД");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"Объект.ВыручкаЕНВД", ВидСравненияКомпоновкиДанных.НеЗаполнено);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);


	// РаспределяемыйНДССуммаБезНДСДляОперацийПо0, РаспределяемыйНДСНДСДляОперацийПо0

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДССуммаБезНДСДляОперацийПо0");
	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДСНДСДляОперацийПо0");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"Объект.ВыручкаНДС0", ВидСравненияКомпоновкиДанных.НеЗаполнено);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);

КонецПроцедуры

&НаСервере
Процедура УстановитьУсловноеОформлениеНДСКРаспределению() Экспорт

	НастройкиУсловногоОформления.Вставить("НДСКРаспределениюПроинициализировано", Истина);


	// РаспределяемыйНДСНадписьСуммаБезНДС

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДСНадписьСуммаБезНДС");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"РаздельныйУчетНДСНаСчете19", ВидСравненияКомпоновкиДанных.Равно, Истина);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = 'сумма без НДС:'"));


	// РаспределяемыйНДСНадписьСуммаНДС

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДСНадписьСуммаНДС");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"РаздельныйУчетНДСНаСчете19", ВидСравненияКомпоновкиДанных.Равно, Истина);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = 'НДС:'"));


	// РаспределяемыйНДСМодернизация

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДСМодернизация");
	СписокЗначений = Новый СписокЗначений;
	СписокЗначений.Добавить(ПланыСчетов.Хозрасчетный.ОСвОрганизации);
	СписокЗначений.Добавить(ПланыСчетов.Хозрасчетный.ОСБезГосРегистрации);
	СписокЗначений.Добавить(ПланыСчетов.Хозрасчетный.ВыбытиеОС);
	СписокЗначений.Добавить(ПланыСчетов.Хозрасчетный.МЦвОрганизации);
	СписокЗначений.Добавить(ПланыСчетов.Хозрасчетный.МЦ_ПредоставленныеВоВременноеВладение);
	СписокЗначений.Добавить(ПланыСчетов.Хозрасчетный.МЦ_ПредоставленныеВоВременноеПользование);
	СписокЗначений.Добавить(ПланыСчетов.Хозрасчетный.ПрочиеДоходныеВложения);
	СписокЗначений.Добавить(ПланыСчетов.Хозрасчетный.ВыбытиеМЦ);

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"Объект.РаспределяемыйНДС.СчетЗатрат", ВидСравненияКомпоновкиДанных.НеВСписке, СписокЗначений);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);

	// РаспределяемыйНДСКоличество

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "РаспределяемыйНДСКоличество");
	
	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"Объект.РаспределяемыйНДС.ВидЦенности", ВидСравненияКомпоновкиДанных.ВСписке, ВидыЦенностиБезКоличества());

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);

КонецПроцедуры

&НаСервере
Процедура УстановитьУсловноеОформлениеКосвенныеРасходы() Экспорт

	НастройкиУсловногоОформления.Вставить("КосвенныеРасходыПроинициализировано", Истина);


	// СоставКосвенныхРасходовНДСВсего

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "СоставКосвенныхРасходовНДСВсего");

	ГруппаОтбора1 = КомпоновкаДанныхКлиентСервер.ДобавитьГруппуОтбора(ЭлементУО.Отбор.Элементы, ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИли);

		ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ГруппаОтбора1,
			"Объект.СоставКосвенныхРасходов.СтавкаНДС", ВидСравненияКомпоновкиДанных.Равно, Перечисления.СтавкиНДС.НДС0);

		ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ГруппаОтбора1,
			"Объект.СоставКосвенныхРасходов.СтавкаНДС", ВидСравненияКомпоновкиДанных.Равно, Перечисления.СтавкиНДС.БезНДС);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);


	// СоставКосвенныхРасходовНадписьСуммаБезНДС

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "СоставКосвенныхРасходовНадписьСуммаБезНДС");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"РаздельныйУчетНДСНаСчете19", ВидСравненияКомпоновкиДанных.Равно, Ложь);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = 'сумма без НДС:'"));


	// СоставКосвенныхРасходовНадписьСуммаНДС

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "СоставКосвенныхРасходовНадписьСуммаНДС");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"РаздельныйУчетНДСНаСчете19", ВидСравненияКомпоновкиДанных.Равно, Ложь);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = 'НДС:'"));


	// СчетаУчетаРасходовСубконто
	Для Сч = 1 По 3 Цикл

		ЭлементУО = УсловноеОформление.Элементы.Добавить();

		КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "СчетаУчетаРасходовСубконто" + Сч);

		ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
			"Объект.СчетаУчетаРасходов.Субконто" + Сч + "Доступность", ВидСравненияКомпоновкиДанных.Равно, Ложь);

		ЭлементУО.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
		
	КонецЦикла;


	// СчетаУчетаРасходовПодразделениеЗатрат

	ЭлементУО = УсловноеОформление.Элементы.Добавить();

	КомпоновкаДанныхКлиентСервер.ДобавитьОформляемоеПоле(ЭлементУО.Поля, "СчетаУчетаРасходовПодразделениеЗатрат");

	ОбщегоНазначенияКлиентСервер.ДобавитьЭлементКомпоновки(ЭлементУО.Отбор,
		"Объект.СчетаУчетаРасходов.ПодразделениеЗатратДоступность", ВидСравненияКомпоновкиДанных.Равно, Ложь);

	ЭлементУО.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);

КонецПроцедуры

&НаСервере
Процедура УстановитьФункциональныеОпцииФормы()

	ОбщегоНазначенияБПКлиентСервер.УстановитьПараметрыФункциональныхОпцийФормыДокумента(ЭтаФорма);
	
	РаздельныйУчетНДСНаСчете19 = УчетнаяПолитика.РаздельныйУчетНДСНаСчете19(Объект.Организация, Объект.Дата);
	
КонецПроцедуры

&НаСервере
Процедура ПодготовитьФормуНаСервере()

	УстановитьФункциональныеОпцииФормы();
	
	УстановитьСостояниеДокумента();
	
	Если Объект.ДляСписанияНДСИспользоватьСчетИАналитикуУчетаЗатрат Тогда 
		РеквизитПереключателяСписанияНДСиспользоватьСчетИАналитикуУчетаЗатрат = 1;
	Иначе 
		РеквизитПереключателяСписанияНДСиспользоватьСчетИАналитикуУчетаЗатрат = 2;
	КонецЕсли;
	
	ЕстьВыручкаБезНДС = Объект.ВыручкаБезНДС <> 0 
		ИЛИ Объект.СоставКосвенныхРасходов.Итог("БезНДС") <> 0;
	ЕстьВыручкаЕНВД = Объект.ВыручкаЕНВД <> 0
		ИЛИ Объект.СоставКосвенныхРасходов.Итог("ЕНВДНДС") <> 0;
		
	ЗаполнитьДобавленныеКолонкиТаблиц();
	
	УправлениеФормой(ЭтаФорма);

КонецПроцедуры

&НаСервере
Процедура УстановитьСостояниеДокумента()
	
	СостояниеДокумента = ОбщегоНазначенияБП.СостояниеДокумента(Объект);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УправлениеФормой(Форма)

	Объект   = Форма.Объект;
	Элементы = Форма.Элементы;
	
	Если Элементы.ГруппаСчетСписанияНДС.Видимость 
		И НЕ Объект.ДляСписанияНДСИспользоватьСчетИАналитикуУчетаЗатрат Тогда 
		 Элементы.ГруппаСчетСубконто.Доступность = Истина;
	Иначе
		 Элементы.ГруппаСчетСубконто.Доступность = Ложь;
		 Объект.СчетСписанияНДС = ПредопределенноеЗначение("ПланСчетов.Хозрасчетный.ПустаяСсылка");
	КонецЕсли;
	 
	Если Форма.РаздельныйУчетНДСНаСчете19 Тогда
		Если КонецМесяца(Объект.Дата) <> КонецКвартала(Объект.Дата) Тогда
			Элементы.НалоговыйПериод.Формат = "ДФ='ММММ гггг  ''г. (только ОС и НМА)'''";
		Иначе
			Элементы.НалоговыйПериод.Формат = "ДФ='к ''Квартал'' гггг  ''г.'''";
		КонецЕсли;
	Иначе
		Элементы.НалоговыйПериод.Формат = "ДФ='к ''Квартал'' гггг  ''г.'''";	
	КонецЕСли;
		
КонецПроцедуры

&НаСервереБезКонтекста
Функция ЗаданиеВыполнено(ИдентификаторЗадания)
	
	Возврат ДлительныеОперации.ЗаданиеВыполнено(ИдентификаторЗадания);
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьЗаголовкиИДоступностьСубконто(Форма, Счет)

	ПоляФормы = Новый Структура("Субконто1, Субконто2, Субконто3, Подразделение",
	                            "СубконтоСписанияНДС1", "СубконтоСписанияНДС2", "СубконтоСписанияНДС3", 
								"ПодразделениеЗатрат");
	
	ЗаголовкиПолей = Новый Структура("Субконто1, Субконто2, Субконто3, Подразделение",
	                                 "ЗаголовокСубконто1", "ЗаголовокСубконто2", 
									 "ЗаголовокСубконто3", "ЗаголовокПодразделение"); 
	
	БухгалтерскийУчетКлиентСервер.ПриВыбореСчета(Счет, Форма, ПоляФормы, ЗаголовкиПолей);
	
КонецПроцедуры

// Процедура вызывается по кнопке при изменении активной строки в таблице косвенных 
// расходов, а также при переходе на закладку "Косвенные расходы".
&НаКлиенте
Процедура ОтобразитьНаправленияСписания()
	
	СтрокаТаблицы =  Элементы.СоставКосвенныхРасходов.ТекущиеДанные;
	
	Если СтрокаТаблицы <> Неопределено Тогда
		// Включаем отбор по ключу из текущей строки табличной части "СоставКосвенныхРасходов"
		ОтборСтрок = Новый ФиксированнаяСтруктура("КлючСтроки", СтрокаТаблицы.КлючСтроки); 
			
		Элементы.СчетаУчетаРасходов.ТолькоПросмотр = Ложь;
		Элементы.СчетаУчетаРасходов.ОтборСтрок 	   = ОтборСтрок;
						
	Иначе
		// Текущая строка в таблице косвенных расходов не установлена
		Элементы.СчетаУчетаРасходов.ТолькоПросмотр = Истина;
		Если Объект.СоставКосвенныхРасходов.Количество() = 0 Тогда
			Объект.СчетаУчетаРасходов.Очистить();
		КонецЕсли;

	КонецЕсли;

КонецПроцедуры 

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьДоступностьСубконто(Форма, Счет, ЭтоТаблица = Ложь)

	ПоляФормы = Новый Структура("Субконто1, Субконто2, Субконто3, Подразделение",
	                            "СчетаУчетаРасходовСубконто1", "СчетаУчетаРасходовСубконто2", "СчетаУчетаРасходовСубконто3", 
								"СчетаУчетаРасходовПодразделение");
	
	БухгалтерскийУчетКлиентСервер.ПриВыбореСчета(Счет, Форма, ПоляФормы, Неопределено, ЭтоТаблица);

КонецПроцедуры

&НаСервере
Функция ПоискПоТабличнойЧасти()
	
		// Инициализируем значение "КлючСтроки" для установки связи данной таблицы с таблицей "СчетаУчетаРасходов"
		// Значение должно быть уникальным в пределах таблицы СоставКосвенныхРасходов
		НеУстановлено = Истина;
		Кандидат = Объект.СоставКосвенныхРасходов.Количество();

		Пока НеУстановлено Цикл
			
			ПараметрыОтбора = Новый Структура;
			ПараметрыОтбора.Вставить("КлючСтроки", Кандидат);
			
			Если НЕ ЗначениеЗаполнено(Объект.СоставКосвенныхРасходов.НайтиСтроки(ПараметрыОтбора)) Тогда
			
				НеУстановлено = Ложь;

				Возврат Кандидат
			Иначе
				// Такое значение ключа уже использовано
				Кандидат = Кандидат + 1;

			КонецЕсли;

		КонецЦикла;

КонецФункции

&НаКлиенте
Процедура Подключаемый_ПроверитьВыполнениеЗадания()
	
	Попытка
		Если ФормаДлительнойОперации.Открыта() 
			И ФормаДлительнойОперации.ИдентификаторЗадания = ИдентификаторЗадания Тогда
			Если ЗаданиеВыполнено(ИдентификаторЗадания) Тогда 
				ЗагрузитьПодготовленныеДанные();
				УправлениеФормой(ЭтаФорма);
				ДлительныеОперацииКлиент.ЗакрытьФормуДлительнойОперации(ФормаДлительнойОперации);
			Иначе
				ДлительныеОперацииКлиент.ОбновитьПараметрыОбработчикаОжидания(ПараметрыОбработчикаОжидания);
				ПодключитьОбработчикОжидания("Подключаемый_ПроверитьВыполнениеЗадания", 
					ПараметрыОбработчикаОжидания.ТекущийИнтервал, Истина);
			КонецЕсли;
		КонецЕсли;	
	Исключение
		ДлительныеОперацииКлиент.ЗакрытьФормуДлительнойОперации(ФормаДлительнойОперации);
		ВызватьИсключение;
	КонецПопытки;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьПодготовленныеДанные()
	
	СтруктураДанных = ПолучитьИзВременногоХранилища(АдресХранилища);
	Если ТипЗнч(СтруктураДанных) <> Тип("Структура") Тогда
		Возврат;
	КонецЕсли;
	
	Если СтруктураДанных.Свойство("ОшибкаЗаполнения") И Не РаздельныйУчетНДСНаСчете19 Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(СтруктураДанных.ОшибкаЗаполнения);
		Возврат;
	КонецЕсли;
	
	Если СтруктураДанных.Свойство("РеквизитыДокумента") Тогда
		ЗаполнитьЗначенияСвойств(Объект, СтруктураДанных.РеквизитыДокумента);
	КонецЕсли;
	
	Если СтруктураДанных.Свойство("СоставКосвенныхРасходов") Тогда
		
		Объект.СоставКосвенныхРасходов.Загрузить(СтруктураДанных.СоставКосвенныхРасходов);
		
		ЕстьВыручкаБезНДС = Объект.ВыручкаБезНДС <> 0 
			ИЛИ Объект.СоставКосвенныхРасходов.Итог("БезНДС") <> 0;
		ЕстьВыручкаЕНВД = Объект.ВыручкаЕНВД <> 0
			ИЛИ Объект.СоставКосвенныхРасходов.Итог("ЕНВДНДС") <> 0;
		
	КонецЕсли;
	
	Если СтруктураДанных.Свойство("СчетаУчетаРасходов") Тогда
		Объект.СчетаУчетаРасходов.Загрузить(СтруктураДанных.СчетаУчетаРасходов);
	КонецЕсли;
	
	Если СтруктураДанных.Свойство("РаспределяемыйНДС") Тогда
		Объект.РаспределяемыйНДС.Загрузить(СтруктураДанных.РаспределяемыйНДС);
		
		ЕстьВыручкаБезНДС = Объект.РаспределяемыйНДС.Итог("СуммаБезНДСУчитываетсяВCтоимостиЕНВД") <> 0;
		ЕстьВыручкаЕНВД = Объект.РаспределяемыйНДС.Итог("НДСУчитываетсяВCтоимостиЕНВД") <> 0;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция РассчитатьВыручкуСервер(СтруктураПараметров)
	
	ДанныеДляЗаполнения = Новый Структура("ВыручкаЕНВД, ВыручкаБезНДС, ВыручкаНДС0, ВыручкаНДС");
	Документы.РаспределениеНДС.РассчитатьВыручку(СтруктураПараметров, ДанныеДляЗаполнения);
	Возврат(ДанныеДляЗаполнения);
	
КонецФункции

&НаСервере
Функция ЗаполнитьТабличнуюЧастьСервер()
	
	Объект.СоставКосвенныхРасходов.Очистить();
	Объект.СчетаУчетаРасходов.Очистить();
	
	Если Объект.Проведен Тогда
		Записать(Новый Структура("РежимЗаписи", РежимЗаписиДокумента.ОтменаПроведения));
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура("НачалоПериода, Дата, Организация");
	ЗаполнитьЗначенияСвойств(СтруктураПараметров, Объект);
	
	Если ОбщегоНазначения.ИнформационнаяБазаФайловая() Тогда
		АдресХранилища = ПоместитьВоВременноеХранилище(Неопределено, УникальныйИдентификатор);
		Документы.РаспределениеНДС.ПодготовитьДанныеДляЗаполненияТабличныхЧастей(СтруктураПараметров, АдресХранилища);
		Результат = Новый Структура("ЗаданиеВыполнено", Истина);		
	Иначе
		НаименованиеЗадания = НСтр("ru = 'Заполнение табличной части документа ""Распределение НДС косвенных расходов""'");
		
		Результат = ДлительныеОперации.ЗапуститьВыполнениеВФоне(
			УникальныйИдентификатор, 
			"Документы.РаспределениеНДС.ПодготовитьДанныеДляЗаполненияТабличныхЧастей", 
			СтруктураПараметров, 
			НаименованиеЗадания);
			
		АдресХранилища = Результат.АдресХранилища;
	КонецЕсли;
	
	Если Результат.ЗаданиеВыполнено Тогда
		ЗагрузитьПодготовленныеДанные();
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Процедура РаспределитьРасходыСервер()
	
	РеквизитыДокумента = Новый Структура("ВыручкаЕНВД, ВыручкаБезНДС, ВыручкаНДС0, ВыручкаНДС", 
		Объект.ВыручкаЕНВД, Объект.ВыручкаБезНДС, Объект.ВыручкаНДС0, Объект.ВыручкаНДС);
		
	Если РаздельныйУчетНДСНаСчете19 Тогда
		
		Документы.РаспределениеНДС.РаспределитьПоВыручкеРаспределяемыйНДС(РеквизитыДокумента, Объект.РаспределяемыйНДС);
		
		ЕстьВыручкаБезНДС = Объект.РаспределяемыйНДС.Итог("СуммаБезНДСУчитываетсяВCтоимостиЕНВД") <> 0;
		ЕстьВыручкаЕНВД = Объект.РаспределяемыйНДС.Итог("НДСУчитываетсяВCтоимостиЕНВД") <> 0;
		
	Иначе
		
		Документы.РаспределениеНДС.РаспределитьПоВыручке(РеквизитыДокумента, Объект.СоставКосвенныхРасходов);
		
		ЕстьВыручкаБезНДС = Объект.ВыручкаБезНДС <> 0 
			ИЛИ Объект.СоставКосвенныхРасходов.Итог("БезНДС") <> 0;
		ЕстьВыручкаЕНВД = Объект.ВыручкаЕНВД <> 0
			ИЛИ Объект.СоставКосвенныхРасходов.Итог("ЕНВДНДС") <> 0;
			
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьДокументНаКлиенте(ПараметрЗаполненияДокумента = Ложь)

	Если Объект.Проведен Тогда
		ТекстВопроса = НСтр("ru = 'Проведенный документ не может быть заполнен автоматически. 
			|Отменить проведение документа для заполнения?'");
		Оповещение = Новый ОписаниеОповещения("ВопросОтменитьПроведениеДокументаДляЗаполненияЗавершение", ЭтотОбъект, ПараметрЗаполненияДокумента);
		ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет, 60, КодВозвратаДиалога.Нет);
	Иначе
		ОчиститьТабличныеЧастиИЗаполнитьДокумент(ПараметрЗаполненияДокумента);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьТабличныеЧастиИЗаполнитьДокумент(ПараметрЗаполненияДокумента)

	Если НЕ ЗначениеЗаполнено(Объект.НачалоПериода)Тогда
		ТекстСообщения = НСтр("ru='Не установлен период заполнения документа!'");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , "Объект.НачалоПериода");
		Возврат;
	КонецЕсли;

	Если РаздельныйУчетНДСНаСчете19 Тогда
		Если Объект.РаспределяемыйНДС.Количество() > 0 Тогда
			ТекстВопроса = НСтр("ru='Табличное поле будет очищено. Продолжить?'");
			Оповещение = Новый ОписаниеОповещения("ВопросТабличноеПолеБудетОчищеноЗавершение", ЭтотОбъект, ПараметрЗаполненияДокумента);
			ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		Иначе
			НачатьЗаполнениеДокумента(ПараметрЗаполненияДокумента);
		КонецЕсли;
	Иначе	
		Если Объект.СоставКосвенныхРасходов.Количество() > 0 Тогда
			ТекстВопроса = НСтр("ru='Табличное поле будет очищено. Продолжить?'");
			Оповещение = Новый ОписаниеОповещения("ВопросТабличноеПолеБудетОчищеноЗавершение", ЭтотОбъект, ПараметрЗаполненияДокумента);
			ПоказатьВопрос(Оповещение, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
		Иначе
			НачатьЗаполнениеДокумента(ПараметрЗаполненияДокумента);
		КонецЕсли;
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура НачатьЗаполнениеДокумента(ПараметрЗаполненияДокумента)
	
	Если ПараметрЗаполненияДокумента Тогда
		Результат = ЗаполнитьДокументНаСервере();
	Иначе
		Результат = ЗаполнитьТабличнуюЧастьСервер();
	КонецЕсли;
	
	Если НЕ Результат.ЗаданиеВыполнено Тогда
		ИдентификаторЗадания = Результат.ИдентификаторЗадания;
		АдресХранилища       = Результат.АдресХранилища;
		
		ДлительныеОперацииКлиент.ИнициализироватьПараметрыОбработчикаОжидания(ПараметрыОбработчикаОжидания);
		ПодключитьОбработчикОжидания("Подключаемый_ПроверитьВыполнениеЗадания", 1, Истина);
		ФормаДлительнойОперации = ДлительныеОперацииКлиент.ОткрытьФормуДлительнойОперации(ЭтаФорма, ИдентификаторЗадания);		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВопросОтменитьПроведениеДокументаДляЗаполненияЗавершение(Результат, ПараметрЗаполненияДокумента) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		ОчиститьТабличныеЧастиИЗаполнитьДокумент(ПараметрЗаполненияДокумента);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ВопросТабличноеПолеБудетОчищеноЗавершение(Результат, ПараметрЗаполненияДокумента) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		НачатьЗаполнениеДокумента(ПараметрЗаполненияДокумента);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ЗаполнитьДокументНаСервере()
	
	Объект.СоставКосвенныхРасходов.Очистить();
	Объект.РаспределяемыйНДС.Очистить();
	
	Если Объект.Проведен Тогда
		Записать(Новый Структура("РежимЗаписи", РежимЗаписиДокумента.ОтменаПроведения));
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура("НачалоПериода, Дата, Организация");
	ЗаполнитьЗначенияСвойств(СтруктураПараметров, Объект);
	
	Если ОбщегоНазначения.ИнформационнаяБазаФайловая() Тогда
		АдресХранилища = ПоместитьВоВременноеХранилище(Неопределено, УникальныйИдентификатор);
		Документы.РаспределениеНДС.ПодготовитьДанныеДляЗаполнения(СтруктураПараметров, АдресХранилища);
		Результат = Новый Структура("ЗаданиеВыполнено", Истина);		
	Иначе
		НаименованиеЗадания = НСтр("ru = 'Заполнение документа ""Распределение НДС косвенных расходов""'");
		Результат = ДлительныеОперации.ЗапуститьВыполнениеВФоне(
			УникальныйИдентификатор, 
			"Документы.РаспределениеНДС.ПодготовитьДанныеДляЗаполнения", 
			СтруктураПараметров, 
			НаименованиеЗадания);
			
		АдресХранилища = Результат.АдресХранилища;
	КонецЕсли;
	
	Если Результат.ЗаданиеВыполнено Тогда
		ЗагрузитьПодготовленныеДанные();
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

&НаСервере
Процедура ЗаполнитьДобавленныеКолонкиТаблиц()

	Для каждого СтрокаТаблицы Из Объект.СчетаУчетаРасходов Цикл
		КоличествоСубконто = СтрокаТаблицы.СчетЗатрат.ВидыСубконто.Количество();
		Для Индекс = 1 По 3 Цикл
			СтрокаТаблицы["Субконто" + Индекс + "Доступность"] = (Индекс <= КоличествоСубконто);
		КонецЦикла;
		СтрокаТаблицы.ПодразделениеЗатратДоступность = СтрокаТаблицы.СчетЗатрат.УчетПоПодразделениям;
	КонецЦикла;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ЗаполнитьРеквизитыИзПараметровФормы(Форма)
	
	ПараметрыЗаполненияФормы = Неопределено;
	
	Если Форма.Параметры.Свойство("ПараметрыЗаполненияФормы",ПараметрыЗаполненияФормы) Тогда
	
		ЗаполнитьЗначенияСвойств(Форма.Объект,ПараметрыЗаполненияФормы);
		Форма.Объект.НачалоПериода	= НачалоКвартала(Форма.Объект.НачалоПериода);
	
	КонецЕсли;

КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ВидыЦенностиБезКоличества()

	Результат = Новый СписокЗначений;
	Результат.Добавить(ПредопределенноеЗначение("Перечисление.ВидыЦенностей.ОС"));
	Результат.Добавить(ПредопределенноеЗначение("Перечисление.ВидыЦенностей.НМА"));
	Результат.Добавить(ПредопределенноеЗначение("Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги"));
	Возврат Результат;

КонецФункции

