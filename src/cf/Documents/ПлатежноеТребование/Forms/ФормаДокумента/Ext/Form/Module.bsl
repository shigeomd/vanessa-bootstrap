////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// СтандартныеПодсистемы.Печать
	УправлениеПечатью.ПриСозданииНаСервере(ЭтотОбъект, Элементы.ГруппаПечать);
	// Конец СтандартныеПодсистемы.Печать
	
	// ДополнительныеОтчетыИОбработки
	ДополнительныеОтчетыИОбработки.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец ДополнительныеОтчетыИОбработки
	
	// СтандартныеПодсистемы.ВерсионированиеОбъектов
	ВерсионированиеОбъектов.ПриСозданииНаСервере(ЭтотОбъект);
	// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов
	
	ЗаполнитьСписокОчередностьПлатежа();
	
	Если Параметры.Ключ.Пустая() Тогда
		СформироватьНазначениеПлатежа(ЭтотОбъект, Истина);
		ПодготовитьФормуНаСервере();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	// СтандартныеПодсистемы.ДатыЗапретаИзменения
	ДатыЗапретаИзменения.ОбъектПриЧтенииНаСервере(ЭтотОбъект, ТекущийОбъект);
	// Конец СтандартныеПодсистемы.ДатыЗапретаИзменения
	
	ЗаполнитьСписокОчередностьПлатежа();
	
	ПодготовитьФормуНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	ХранилищеОбщихНастроек.Сохранить("ПлатежноеТребование_ВидПлатежа",, Объект.ВидПлатежа);
	
	УстановитьСостояниеДокумента();
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	САкцептом = Объект.САкцептом;
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Если ПараметрыЗаписи.РежимЗаписи = ПредопределенноеЗначение("РежимЗаписиДокумента.Проведение") Тогда
		КлючеваяОперация = "ПроведениеПлатежноеТребование";
		ОценкаПроизводительностиКлиентСервер.НачатьЗамерВремени(КлючеваяОперация);
	КонецЕсли;
	
	
	Объект.САкцептом = САкцептом;
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	Если ТипЗнч(ВладелецФормы) = Тип("УправляемаяФорма") Тогда
		Оповестить("ОбновитьФорму", ВладелецФормы, Объект);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "ИзменениеНастроекПлатежныхПорученийИТребований" Тогда
		
		ЗаполнитьЗначенияСвойств(
			ЭтотОбъект,
			СформироватьРасшифровки(Объект.Организация, Объект.СчетОрганизации, Объект.Контрагент, Объект.СчетКонтрагента));
		
		СформироватьНазначениеПлатежа(ЭтотОбъект);
		
		Модифицированность = Истина;
	ИначеЕсли ИмяСобытия = "ИзмененБанковскийСчет" И Параметр.Владелец = Объект.Организация Тогда
		Если НЕ ЗначениеЗаполнено(Объект.СчетОрганизации) Тогда
			ОрганизацияПриИзмененииНаСервере();
		Иначе
			УстановитьФункциональныеОпцииФормы(ЭтотОбъект);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ШАПКИ ФОРМЫ

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	
	Если Объект.ОчередностьПлатежа = 6 И Объект.Дата >= УчетДенежныхСредствКлиентСервер.НачалоДействияНовыхПравилОчередностиПлатежа() Тогда
		Объект.ОчередностьПлатежа = 5;
	КонецЕсли;
	
	ЗаполнитьСписокВыбора(Элементы.ОчередностьПлатежа, УчетДенежныхСредствКлиентСервер.ПолучитьСписокОчередностьПлатежа(Объект.Дата));
	ОбновитьПодсказкуОчередностьПлатежа(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура САкцептомПриИзменении(Элемент)
	
	Объект.САкцептом = САкцептом;
	Если САкцептом Тогда
		Объект.ОснованиеДляБезакцептногоСписания = "";
	Иначе
		Объект.СрокДляАкцепта = 0;
	КонецЕсли;
	
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ВидАкцептаПредставлениеПриИзменении(Элемент)
	
	Объект.ВидАкцепта  = ?(ВидАкцептаПредставление = "С акцептом", 0, Число(ВидАкцептаПредставление));
	Модифицированность = Истина;
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацияПриИзменении(Элемент)
	
	Если ЗначениеЗаполнено(Объект.Организация) Тогда
		ОрганизацияПриИзмененииНаСервере();
	Иначе
		УправлениеФормой(ЭтотОбъект);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура СчетОрганизацииПриИзменении(Элемент)
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект,
		СформироватьРасшифровки(Объект.Организация, Объект.СчетОрганизации, Объект.Контрагент, Объект.СчетКонтрагента));
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
	
	КонтрагентПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура СчетКонтрагентаПриИзменении(Элемент)
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект,
		СформироватьРасшифровки(Объект.Организация, Объект.СчетОрганизации, Объект.Контрагент, Объект.СчетКонтрагента));
	
	СформироватьНазначениеПлатежа(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура СуммаДокументаПриИзменении(Элемент)
	
	Объект.СуммаНДС = ПересчитатьСуммуНДС(Объект.СуммаДокумента, Объект.СтавкаНДС);
	СформироватьНазначениеПлатежа(ЭтотОбъект, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура СтавкаНДСПриИзменении(Элемент)
	
	Объект.СуммаНДС = ПересчитатьСуммуНДС(Объект.СуммаДокумента, Объект.СтавкаНДС);
	СформироватьНазначениеПлатежа(ЭтотОбъект, Истина);
	
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура СуммаНДСПриИзменении(Элемент)
	
	СформироватьНазначениеПлатежа(ЭтотОбъект, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура ОчередностьПлатежаНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

&НаКлиенте
Процедура ОчередностьПлатежаПриИзменении(Элемент)
	
	Модифицированность = Истина;
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

&НаКлиенте
Процедура НастройкаПлатежногоТребования(Команда)
	
	Отказ = Ложь;
	
	Если НЕ ЗначениеЗаполнено(Объект.СчетОрганизации) Тогда
		ТекстСообщения	= ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Поле", "Заполнение", НСтр("ru = 'Банковский счет'"));
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,, "Объект.СчетОрганизации",, Отказ);
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(Объект.СчетКонтрагента) Тогда
		ТекстСообщения	= ОбщегоНазначенияКлиентСервер.ТекстОшибкиЗаполнения("Поле", "Заполнение", НСтр("ru = 'Счет получателя'"));
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,, "Объект.СчетКонтрагента",, Отказ);
	КонецЕсли;
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	АвтоТекстНазначения = НСтр("ru = 'Оплата по договору'");
	
	ПараметрыФормы = Новый Структура(
		"БанковскийСчетОрганизации, БанковскийСчетКонтрагента, АвтоТекстНазначения",
		Объект.СчетОрганизации, Объект.СчетКонтрагента, АвтоТекстНазначения);
		
	ОткрытьФорму("ОбщаяФорма.НастройкиПлатежныхПорученийТребований", ПараметрыФормы, ЭтотОбъект);
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаСервере
Процедура ПодготовитьФормуНаСервере()
	
	УстановитьФункциональныеОпцииФормы(ЭтотОбъект);
	
	ВалютаРегламентированногоУчета = ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета();
	
	ЗаполнитьЗначенияСвойств(
		ЭтотОбъект,
		СформироватьРасшифровки(Объект.Организация, Объект.СчетОрганизации, Объект.Контрагент, Объект.СчетКонтрагента));
	
	Если НЕ ЗначениеЗаполнено(Объект.ВидПлатежа) Тогда
		СохраненныйВид = ХранилищеОбщихНастроек.Загрузить("ПлатежноеТребование_ВидПлатежа");
		Если СохраненныйВид <> "" Тогда
			Объект.ВидПлатежа = СохраненныйВид;
		Иначе
			Объект.ВидПлатежа = ""; // Вид платежа по умолчанию не заполняется
		КонецЕсли;
	КонецЕсли;
	
	ВидАкцептаПредставление = ?(Объект.ВидАкцепта = 0, "С акцептом", Строка(Объект.ВидАкцепта));
	
	УстановитьСостояниеДокумента();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьСостояниеДокумента()
	
	СостояниеДокумента = ОбщегоНазначенияБП.СостояниеДокумента(Объект);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УправлениеФормой(Форма)
	
	Объект   = Форма.Объект;
	Элементы = Форма.Элементы;
	
	Элементы.СчетОрганизации.Доступность = ЗначениеЗаполнено(Объект.Организация);
	Элементы.СчетКонтрагента.Доступность = ЗначениеЗаполнено(Объект.Контрагент);
	
	Элементы.СуммаНДС.Доступность         = НЕ Объект.СтавкаНДС = ПредопределенноеЗначение("Перечисление.СтавкиНДС.БезНДС")
		И НЕ Объект.СтавкаНДС = ПредопределенноеЗначение("Перечисление.СтавкиНДС.НДС0");
	
	Элементы.ОснованиеДляБезакцептногоСписания.Доступность = НЕ Форма.САкцептом;
	Элементы.СрокДляАкцепта.Доступность                    = Форма.САкцептом;
	Элементы.ДатаОтсылкиДокументов.Доступность             = Форма.САкцептом;
	
	РасшифровкаВидАкцепта = "";
	Если Форма.САкцептом Тогда
		Элементы.ГруппаВидимостьВидАкцепта.ТекущаяСтраница = Элементы.ГруппаВидАкцепта;
		Если Объект.ВидАкцепта = 1 Тогда
			Форма.РасшифровкаВидАкцепта = НСтр("ru = 'Заранее данный акцепт плательщика'");
		ИначеЕсли Объект.ВидАкцепта = 2 Тогда
			Форма.РасшифровкаВидАкцепта = НСтр("ru = 'Требует получения акцепта'");
		Иначе
			Форма.РасшифровкаВидАкцепта = "";
		КонецЕсли;
	Иначе
		Элементы.ГруппаВидимостьВидАкцепта.ТекущаяСтраница = Элементы.ГруппаПустая;
		Форма.РасшифровкаВидАкцепта     = "";
	КонецЕсли;
	
	Элементы.РасшифровкаВидАкцепта.Доступность   = Форма.САкцептом;
	Элементы.ВидАкцептаПредставление.Доступность = Форма.САкцептом;
	
	ОбновитьПодсказкуОчередностьПлатежа(Форма);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьФункциональныеОпцииФормы(Форма)
	
	ОбщегоНазначенияБПКлиентСервер.УстановитьПараметрыФункциональныхОпцийФормыДокумента(Форма);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ОбновитьПодсказкуОчередностьПлатежа(Форма)
	
	Элементы = Форма.Элементы;
	Объект   = Форма.Объект;
	
	Если Объект.ОчередностьПлатежа > 0 Тогда
		Если Объект.ОчередностьПлатежа > Элементы.ОчередностьПлатежа.СписокВыбора.Количество() Тогда
			// Если ОчередностьПлатежа = 6 будут выбирать после вступления в действие 345-Ф, не будем у такого значения отображать подсказку
			Форма.РасшифровкаОчередностиПлатежа = "";
		Иначе
			Форма.РасшифровкаОчередностиПлатежа = Сред(Элементы.ОчередностьПлатежа.СписокВыбора[
				Объект.ОчередностьПлатежа - 1].Представление, 5);
		КонецЕсли;
	Иначе
		Форма.РасшифровкаОчередностиПлатежа = "";
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСписокОчередностьПлатежа()
	
	ЗаполнитьСписокВыбора(Элементы.ОчередностьПлатежа, УчетДенежныхСредствКлиентСервер.ПолучитьСписокОчередностьПлатежа(Объект.Дата));
	
КонецПроцедуры

&НаСервере
Процедура ОрганизацияПриИзмененииНаСервере()
	
	УстановитьФункциональныеОпцииФормы(ЭтотОбъект);
	
	УчетДенежныхСредствБП.УстановитьБанковскийСчет(Объект.СчетОрганизации, Объект.Организация, ВалютаРегламентированногоУчета);
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект,
		СформироватьРасшифровки(Объект.Организация, Объект.СчетОрганизации, Объект.Контрагент, Объект.СчетКонтрагента));
	
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

&НаСервере
Процедура КонтрагентПриИзмененииНаСервере()
	
	УчетДенежныхСредствБП.УстановитьБанковскийСчет(Объект.СчетКонтрагента, Объект.Контрагент, ВалютаРегламентированногоУчета);
		
	ЗаполнитьЗначенияСвойств(ЭтотОбъект,
		СформироватьРасшифровки(Объект.Организация, Объект.СчетОрганизации, Объект.Контрагент, Объект.СчетКонтрагента));
		
	Если ЗначениеЗаполнено(Объект.СчетКонтрагента) Тогда
		СформироватьНазначениеПлатежа(ЭтотОбъект);
	КонецЕсли;
	
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ЗаполнитьСписокВыбора(Элемент, СписокДанных)
	
	Элемент.СписокВыбора.Очистить();
	Для каждого ЭлементДанных Из СписокДанных Цикл
		Элемент.СписокВыбора.Добавить(ЭлементДанных.Значение, ЭлементДанных.Представление);
	КонецЦикла;
	
КонецПроцедуры

// Процедура выполняет необходимые действия формирования текста назначения платежа
//
&НаКлиентеНаСервереБезКонтекста
Процедура СформироватьНазначениеПлатежа(Форма, ТолькоСумму = Ложь)
	
	Объект = Форма.Объект;
	
	ПозицияНДС = Найти(Объект.НазначениеПлатежа, НСтр("ru = 'В т.ч. НДС'"));
	Если ПозицияНДС = 0 Тогда
		ПозицияНДС = Найти(Объект.НазначениеПлатежа, НСтр("ru = 'Без налога (НДС)'"));
	КонецЕсли;
	
	Если ТолькоСумму Тогда
		
		ТекстНазначение = ?(ПозицияНДС = 0, Объект.НазначениеПлатежа, Лев(Объект.НазначениеПлатежа, ПозицияНДС - 1));
		Если Прав(ТекстНазначение, 1) = Символы.ПС Тогда
			ТекстНазначение = Лев(ТекстНазначение, СтрДлина(ТекстНазначение) - 1);
		КонецЕсли;
		
	Иначе
		
		Если ЗначениеЗаполнено(Форма.АвтоЗначенияРеквизитов.ТекстНазначенияПлатежа) Тогда
			ТекстНазначение = Форма.АвтоЗначенияРеквизитов.ТекстНазначенияПлатежа;
		Иначе
			ТекстНазначение = НСтр("ru = 'Оплата по договору '");
		КонецЕсли;
		
	КонецЕсли;
	
	Если Объект.СтавкаНДС = ПредопределенноеЗначение("Перечисление.СтавкиНДС.БезНДС") Тогда
		ТекстНДС = НСтр("ru = 'Без налога (НДС)'");
	ИначеЕсли Объект.СуммаНДС > 0 Тогда
		ТекстНДС = НСтр("ru = 'В т.ч. НДС '")
			+ ?(ЗначениеЗаполнено(Объект.СтавкаНДС), " (" + Объект.СтавкаНДС + ") ", "")
			+ Формат(Объект.СуммаНДС, "ЧЦ=15; ЧДЦ=2; ЧРД=-; ЧН=0-00; ЧГ=");
	Иначе
		ТекстНДС = "";
	КонецЕсли;
	
	Объект.НазначениеПлатежа = ТекстНазначение+ ?(ПустаяСтрока(ТекстНДС),   "", Символы.ПС + ТекстНДС);
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Функция ПересчитатьСуммуНДС(СуммаДокумента, СтавкаНДС)
	
	ПроцентНДС = УчетНДСВызовСервераПовтИсп.ПолучитьСтавкуНДС(СтавкаНДС);
	СуммаНДС   = Окр(СуммаДокумента * ПроцентНДС / (100 + ПроцентНДС), 2);
	
	Возврат СуммаНДС;
	
КонецФункции

&НаСервереБезКонтекста
Функция СформироватьРасшифровки(Знач Организация, Знач СчетОрганизации, Знач Контрагент, Знач СчетКонтрагента)
	
	ЗначенияРеквизитов = Новый Структура;
	
	ЗначенияРеквизитов.Вставить("АвтоЗначенияРеквизитов", УчетДенежныхСредствБП.СформироватьАвтоЗначенияРеквизитовПлательщикаПолучателя(
		Организация,
		СчетОрганизации,
		Контрагент,
		СчетКонтрагента,
		Ложь));
	
	// Плательщик - контрагент
	ЗначенияРеквизитов.Вставить("РасшифровкаКонтрагент", 
		"ИНН " + ЗначенияРеквизитов.АвтоЗначенияРеквизитов.ИННПолучателя 
		+ ", " + ЗначенияРеквизитов.АвтоЗначенияРеквизитов.ТекстПолучателя);
	// Получатель - наша организация
	ЗначенияРеквизитов.Вставить("РасшифровкаОрганизация", 
		"ИНН " + ЗначенияРеквизитов.АвтоЗначенияРеквизитов.ИННПлательщика
		+ ", " + ЗначенияРеквизитов.АвтоЗначенияРеквизитов.ТекстПлательщика);
		
	Возврат ЗначенияРеквизитов;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ БСП

// СтандартныеПодсистемы.ДополнительныеОтчетыИОбработки

&НаСервере
Процедура ДополнительныеОтчетыИОбработкиВыполнитьНазначаемуюКомандуНаСервере(ИмяЭлемента, РезультатВыполнения)
	
	ДополнительныеОтчетыИОбработки.ВыполнитьНазначаемуюКомандуНаСервере(ЭтотОбъект, ИмяЭлемента, РезультатВыполнения);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ВыполнитьНазначаемуюКоманду(Команда)
	
	Если НЕ ДополнительныеОтчетыИОбработкиКлиент.ВыполнитьНазначаемуюКомандуНаКлиенте(ЭтотОбъект, Команда.Имя) Тогда
		РезультатВыполнения = Неопределено;
		ДополнительныеОтчетыИОбработкиВыполнитьНазначаемуюКомандуНаСервере(Команда.Имя, РезультатВыполнения);
		ДополнительныеОтчетыИОбработкиКлиент.ПоказатьРезультатВыполненияКоманды(ЭтотОбъект, РезультатВыполнения);
	КонецЕсли;
	
КонецПроцедуры

// Конец СтандартныеПодсистемы.ДополнительныеОтчетыИОбработки

// СтандартныеПодсистемы.Печать
&НаКлиенте
Процедура Подключаемый_ВыполнитьКомандуПечати(Команда)
	
	УправлениеПечатьюКлиент.ВыполнитьПодключаемуюКомандуПечати(Команда, ЭтотОбъект, Объект);
	
КонецПроцедуры
// Конец СтандартныеПодсистемы.Печать
